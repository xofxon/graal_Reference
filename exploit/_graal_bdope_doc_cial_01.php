<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_numerotation.php");
include("_graal_fonctions_mousto.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
include("_graal_fonctions_echeances.php");
include_once("_graal_fonctions_documents_ciaux.php");
define('EOL', "\r\n");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_actions_02";
$t_origines_ok[1]="_graal_fen_act_interlo_02";
$t_origines_ok[2]="_graal_fen_acteurs_01";
$t_origines_ok[3]="_graal_fen_actions_01";
$t_origines_ok[4]="_graal_fen_actions_livcli_01";
$t_origines_ok[5]="_graal_fen_actions_recfou_01";
$t_origines_ok[6]="_graal_fen_actions_cdefou_01";
fa_acces_script();
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_genreaction=fa_recup_param('genreaction','generique');
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_nouvelle_date_liv=fa_recup_param("vl_nouvelle_date_liv","19610123");
$vl_nouvelle_heur_liv=fa_recup_param('vl_nouvelle_heur_liv','000000');
$vl_nouvelle_date_exp=fa_recup_param("vl_nouvelle_date_exp","19610123");
$vl_nouvelle_heur_exp=fa_recup_param('vl_nouvelle_heur_exp','000000');
$vl_nouvelle_date_fac=fa_recup_param("vl_nouvelle_date_fac","19610123");
$vl_nouvelle_heur_fac=fa_recup_param('vl_nouvelle_heur_fac','000000');
$maintenant = date("Y-m-d")." ".date("H:i:s");
$aujourdhui = date("Y-m-d");
$param_generaux_graal_176=intval(fa_recup_session('vs_param_generaux_graal_176','2'));
$param_generaux_graal_177=intval(fa_recup_session('vs_param_generaux_graal_177','-15'));	//	Dépot par défaut
$vs_enval=fa_recup_session("vs_enval",true);	// Obligation compte comptable acteur pour élaboration de documents commerciaux (temporaire au 5/5/2010)
switch ($param_generaux_graal_176){
	case 1:
	case 2:
		break;
	default:
		$param_generaux_graal_176=2;
		break;
}
//die($param_generaux_graal_176."-".$maintenant);
switch ($param_generaux_graal_176){
	case 1://	date du document = date du jour de création (sauf si date forcée
		$col_dateheuredebut="'$maintenant'";
    	$col_dateheurefin="'$maintenant'";
    	$col_dateheurelivraison="'$maintenant'";
      	$col_dateheureexpedition="'$maintenant'";
      	$col_dateheureexpedition="'$maintenant'";
		$col_dateheurelivraison="'$maintenant'";
		$col_date_fact="'$aujourdhui'";
		break;
	case 2://	Date du document = date du document père
		//$vl_mousto_date_mvt='fa_nn($row['dateheure_confirm']);';
		switch (TRUE) {
			case $vf_c_action=="cdecli->offcli":  //  Transformation d'une commande client en offre client
			case $vf_c_action=="cdecli->cdecli":  //  Duplication d'une commande client
			case $vf_c_action=="cdecli->livcli":  //  Transformation d'une commande client en livraison
			case $vf_c_action=="cdecli->livcli_partielle":  //  Transformation partielle d'une commande client en livraison
			case $vf_c_action=="cdecli->faccli":  //  Transformation d'une commande client en facture
			case $vf_c_action=="offcli->offcli":  //  Duplication d'une offre client
			case $vf_c_action=="offcli->cdecli":  //  Transformation d'une offre en une commande client
			case $vf_c_action=="livcli->faccli":  //  Transformation d'une livraison client en facture
			case $vf_c_action=="faccli->avocli":  //  Transformation d'une facture client en avoir sur stock client
			case $vf_c_action=="faccli->avofin":  //  Transformation d'une facture client en avoir financier client
			case $vf_c_action=="demfou->demfou":  //  Duplication d'une demande fournisseur	
			case $vf_c_action=="demfou->cdefou":  //  Transformation d'une demande en une commande fournisseur	
			case $vf_c_action=="cdefou->demfou":  //  Transformation d'une commande fournisseur en demande
			case $vf_c_action=="cdefou->cdefou":  //  duplication d'une commande fournisseur
			case $vf_c_action=="cdecli->profor":	//	Transformation d'une commande client en facture pro-forma
			case $vf_c_action=="livcli->profor":	//	Transformation d'une livraison client en facture pro-forma	
			case $vf_c_action=="profor->faccli":  //  Transformation d'une facture client pro-forma en facture client "classique" (les mouvements de stocks ont été fait lors de l'établissement de la pro-forma)
			case $vf_c_action=="cdefou->recfou":  //  Transformation d'une commande fournisseur en réception
			case $vf_c_action=="cdefou->recfou_partielle":  //  Transformation partielle d'une commande fournisseur en réception
			case $vf_c_action=="recfou->facfou":  //  Transformation d'une réception fournisseur en facture
			case $vf_c_action=="retfou->avofou":  //  Transformation d'un retour fournisseur en avoir
			case $vf_c_action=="livcli_multi->faccli":  //  Transformation de plusieurs livraisons client en une seule facture
			case $vf_c_action=="recfou_multi->facfou":  //  Transformation de plusieurs livraisons client en une seule facture
			case $vf_c_action=="retfou_multi->avofou":  //  Transformation de plusieurs livraisons client en une seule facture
			case $vf_c_action=="cdefou->relfou":  //  Transformation de plusieurs lignes de commandes fournisseurs en (éventuellement) n relances fournisseurs
				$col_dateheuredebut="dateheuredebut";
    			$col_dateheurefin="dateheurefin";
    			break;
		}
		switch (TRUE) {
			case $vf_c_action=="cdecli->offcli":
	        case $vf_c_action=="cdecli->cdecli":
	        case $vf_c_action=="cdecli->livcli":
	        case $vf_c_action=="cdecli->livcli_partielle":
	        case $vf_c_action=="offcli->offcli":
	        case $vf_c_action=="offcli->cdecli":
			case $vf_c_action=="demfou->demfou":
			case $vf_c_action=="demfou->cdefou":
			case $vf_c_action=="cdefou->demfou":
			case $vf_c_action=="cdefou->cdefou":
			case $vf_c_action=="cdefou->recfou":
			case $vf_c_action=="cdefou->recfou_partielle":
			case $vf_c_action=="cdefou->relfou":
				$col_dateheurelivraison="dateheurelivraison";
      			$col_dateheureexpedition="dateheureexpedition";
				break;
		}
		switch (TRUE) {
			case $vf_c_action=="cdecli->faccli":
	        case $vf_c_action=="livcli->faccli":
	        case $vf_c_action=="cdecli->profor":
	        case $vf_c_action=="livcli->profor":
			case $vf_c_action=="profor->faccli":
			case $vf_c_action=="recfou->facfou":
			case $vf_c_action=="retfou->avofou":
			case $vf_c_action=="livcli_multi->faccli":
			case $vf_c_action=="recfou_multi->facfou":
			case $vf_c_action=="retfou_multi->avofou":
				$col_dateheureexpedition="dateheureexpedition";
				$col_dateheurelivraison="dateheurelivraison";
				$col_date_fact="date(dateheureexpedition)";
	          break;
		}
		break;
		
}
switch (TRUE) {
	case $vf_c_action=="verif_dispo_frla":
		$vl_commercial_cleunik_sourc=intval(fa_recup_param('vl_commercial_cleunik','0'));
		$req_action="select f2.commercial_cleunik,f1.dateheure_demande,f2.art_cleunik,COALESCE(COALESCE(f1.qte,0) - COALESCE(f1.qte_deja,0),0) as RAL ";
		$req_action.=" from _cdecli_lignes_qte f1 left join _cdecli_lignes f2 using(commercial_ligne_cleunik) left join _article f3 on f3.art_cleunik=f2.art_cleunik where f2.commercial_cleunik=$vl_commercial_cleunik_sourc";
		$req_action.=" and f2.art_cleunik <> 0 and f3.types_gestion &4;";
		$result = _graal_requete_bd($req_action);
    	$retour="";
    	while ($row = mysql_fetch_assoc($result)){
    		$vl_dateheure_demande=$row['dateheure_demande'];
      		$vl_art_cleunik=$row['art_cleunik'];
    		$vl_ral_commande=$row['RAL'];
    		$req_action_01="select COALESCE(sum( COALESCE(f1.qte,0) - COALESCE(f1.qte_deja,0) ),0) as RAL from _cdecli_lignes_qte f1 left join _cdecli_lignes f2 ";
    		$req_action_01.=" using(commercial_ligne_cleunik) where f2.commercial_cleunik<>$vl_commercial_cleunik_sourc and f1.dateheure_demande < '$vl_dateheure_demande' ";
    		$req_action_01.=" and (f1.statut=-38 or f1.statut is null) and f2.art_cleunik=$vl_art_cleunik order by f1.dateheure_demande desc";
    		
    		//$retour.="$req_action_01".EOL;
    		$result_01 = _graal_requete_bd($req_action_01);
    		while ($row_01 = mysql_fetch_assoc($result_01)){
    			$ral=$row_01['RAL'];
    			$req_action_02="select sum(f1.qte_stock) as stock,f2.code,f2.description from _art_dep_emp f1 left join _article f2 using(art_cleunik) ";
	    		$req_action_02.=" where f1.art_cleunik=$vl_art_cleunik and f1.choix_depot=$param_generaux_graal_177 group by f1.choix_depot,f1.art_cleunik";
	    		//$retour.="$req_action_02".EOL;
	    		$result_02 = _graal_requete_bd($req_action_02);
	    		while ($row_02 = mysql_fetch_assoc($result_02)){
	    			$stock=$row_02['stock'];
	    			$description=$row_02['description'];
	    			$code=$row_02['code'];
	    			if (($stock-$ral)<$vl_ral_commande){
	    				$retour.="A priori, le stock du dépot principal est déjà affecté à d'autres commandes antérieures ($code-$description)".EOL;
	    			} else {
	    				//$retour.="A priori ok, stock $stock ral $ral ral commande $vl_ral_commande ($code-$description)".EOL;
	    			}
	    		}
    			$req_action_02="select COALESCE(a1.qte_stock,0) as qte_stock,COALESCE((select a2.qte_pos from _mouvements_stock a2 where a2.art_cleunik=a1.art_cleunik order by dateheuremvt desc limit 1)";
	    		$req_action_02.=",0) as qte_stock_mvt,a3.code,a3.description from _art_stock a1 left join _article a3 using(art_cleunik)where art_cleunik=$vl_art_cleunik;";
	    		$result_02 = _graal_requete_bd($req_action_02);
	    		while ($row_02 = mysql_fetch_assoc($result_02)){
	    			$qte_stock=$row_02['qte_stock'];
	    			$qte_stock_mvt=$row_02['qte_stock_mvt'];
	    			$description=$row_02['description'];
	    			$code=$row_02['code'];
	    			if (($qte_stock)<>$qte_stock_mvt){
	    				$retour.="Attention, attention, potentiel problème de stock informatique ($code-$description)[$qte_stock vs $qte_stock_mvt]".EOL;
	    			}
	    		}
    		}
    	}
      		
    	_graal_libere_requete_bd($result);
    	echo $retour;
    	exit();
    	break;
}		
		
		

/*
 * cas de transformation gérés : 
 * case $vf_c_action=="cdecli->offcli":  //  Transformation d'une commande client en offre client
case $vf_c_action=="cdecli->cdecli":  //  Duplication d'une commande client
case $vf_c_action=="offcli->offcli":  //  Duplication d'une offre client
case $vf_c_action=="offcli->cdecli":  //  Transformation d'une offre en une commande client
case $vf_c_action=="cdecli->livcli":  //  Transformation d'une commande client en livraison
case $vf_c_action=="cdecli->livcli_partielle":  //  Transformation partielle d'une commande client en livraison
case $vf_c_action=="cdecli->faccli":  //  Transformation d'une commande client en facture
case $vf_c_action=="cdecli->profor":	//	Transformation d'une commande client en facture pro-forma
case $vf_c_action=="livcli->faccli":  //  Transformation d'une livraison client en facture
case $vf_c_action=="livcli->profor":	//	Transformation d'une livraison client en facture pro-forma
case $vf_c_action=="faccli->avocli":  //  Transformation d'une facture client en avoir sur stock client
case $vf_c_action=="faccli->avofin":  //  Transformation d'une facture client en avoir financier client
case $vf_c_action=="profor->faccli":  //  Transformation d'une facture client pro-forma en facture client "classique" (les mouvements de stocks ont été fait lors de l'établissement de la pro-forma)
case $vf_c_action=="demfou->demfou":  //  Duplication d'une demande fournisseur
case $vf_c_action=="demfou->cdefou":  //  Transformation d'une demande en une commande fournisseur
case $vf_c_action=="cdefou->cdefou":  //  duplication d'une commande fournisseur
case $vf_c_action=="cdefou->demfou":  //  Transformation d'une commande fournisseur en demande
case $vf_c_action=="cdefou->recfou":  //  Transformation d'une commande fournisseur en réception
case $vf_c_action=="cdefou->recfou_partielle":  //  Transformation partielle d'une commande fournisseur en réception
case $vf_c_action=="retcli->avofin":  //  Transformation d'un retour client en avoir financier client
case $vf_c_action=="livcli_multi->faccli":  //  Transformation de plusieurs livraisons client en une seule facture
case $vf_c_action=="recfou_multi->facfou":  //  Transformation de plusieurs réceptions fournisseurs en une seule facture
case $vf_c_action=="retfou_multi->avofou":  //  Transformation de plusieurs bons de retour fournisseur en un seul avoir
 */

if (($vf_c_action=="cdecli->livcli")&&($vl_nouvelle_date_liv!="19610123")){}
if (($vf_c_action=="cdecli->livcli")&&($vl_nouvelle_date_exp!="19610123")){}
if (($vf_c_action=="livcli->faccli")&&($vl_nouvelle_date_fac!="19610123")){}
if (($vf_c_action=="recfou->facfou")&&($vl_nouvelle_date_fac!="19610123")){}
if (($vf_c_action=="cdecli->faccli")&&($vl_nouvelle_date_fac!="19610123")){}




$param_generaux_graal_011=intval(fa_recup_session('vs_param_generaux_graal_011','0'));
$param_generaux_graal_012=intval(fa_recup_session('vs_param_generaux_graal_012','0'));
$param_generaux_graal_013=intval(fa_recup_session('vs_param_generaux_graal_013','0'));
$param_generaux_graal_014=intval(fa_recup_session('vs_param_generaux_graal_014','0'));
$param_generaux_graal_015=intval(fa_recup_session('vs_param_generaux_graal_015','0'));
$param_generaux_graal_016=intval(fa_recup_session('vs_param_generaux_graal_016','0'));
$param_generaux_graal_017=intval(fa_recup_session('vs_param_generaux_graal_017','0'));
$param_generaux_graal_018=intval(fa_recup_session('vs_param_generaux_graal_018','0'));
$param_generaux_graal_024=intval(fa_recup_session('vs_param_generaux_graal_024','0'));
$param_generaux_graal_036=intval(fa_recup_session('vs_param_generaux_graal_036','0'));
$param_generaux_graal_037=intval(fa_recup_session('vs_param_generaux_graal_037','0'));
$param_generaux_graal_040=intval(fa_recup_session('vs_param_generaux_graal_040','0'));
$param_generaux_graal_041=intval(fa_recup_session('vs_param_generaux_graal_041','0'));

$param_generaux_graal_045=intval(fa_recup_session('vs_param_generaux_graal_045','0'));	//	Type de gestion des offres clients
$param_generaux_graal_046=intval(fa_recup_session('vs_param_generaux_graal_046','0'));
$param_generaux_graal_047=intval(fa_recup_session('vs_param_generaux_graal_047','0'));
$param_generaux_graal_048=intval(fa_recup_session('vs_param_generaux_graal_048','0'));
$param_generaux_graal_049=intval(fa_recup_session('vs_param_generaux_graal_049','0'));
$param_generaux_graal_050=intval(fa_recup_session('vs_param_generaux_graal_050','0'));

$vf_c_retour="0";
switch (TRUE) {
  case $vf_c_action=="cdecli->offcli":  //  Transformation d'une commande client en offre client
    $id_fen_doc_cial="Fen_00671";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdecli_entetes";
    $table_adress_sourc="_cdecli_adresses";
    $table_repres_sourc="_cdecli_representants";
    $table_transp_sourc="_cdecli_transporteurs";
    $table_consig_sourc="_cdecli_consignes";
    $table_lignes_sourc="_cdecli_lignes";
    $table_ligqte_sourc="_cdecli_lignes_qte";
    $table_entete_cible="_offcli_entetes";
    $table_adress_cible="_offcli_adresses";
    $table_repres_cible="_offcli_representants";
    $table_transp_cible="_offcli_transporteurs";
    $table_consig_cible="_offcli_consignes";
    $table_lignes_cible="_offcli_lignes";
    $table_ligqte_cible="_offcli_lignes_qte";
    $indice_numerotation=1;//  Numérotation automatique 1 -> clé offres clients
    $vf_e_choix_cleunik_doc=-110114;
		$choix_cleunik_gauche=-115;	//	Commande client d'origine
		$choix_cleunik_droite=-114;	//	Offre client destination
    break;
  case $vf_c_action=="cdecli->cdecli":  //  Duplication d'une commande client
    $id_fen_doc_cial="Fen_00477";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdecli_entetes";
    $table_adress_sourc="_cdecli_adresses";
    $table_repres_sourc="_cdecli_representants";
    $table_transp_sourc="_cdecli_transporteurs";
    $table_consig_sourc="_cdecli_consignes";
    $table_lignes_sourc="_cdecli_lignes";
    $table_ligqte_sourc="_cdecli_lignes_qte";
    $table_entete_cible="_cdecli_entetes";
    $table_adress_cible="_cdecli_adresses";
    $table_repres_cible="_cdecli_representants";
    $table_transp_cible="_cdecli_transporteurs";
    $table_consig_cible="_cdecli_consignes";
    $table_lignes_cible="_cdecli_lignes";
    $table_ligqte_cible="_cdecli_lignes_qte";
    $indice_numerotation=2;//  Numérotation automatique 1 -> clé commandes clients
    $vf_e_choix_cleunik_doc=-110108;
		$choix_cleunik_gauche=-115;	//	Commande client d'origine
		$choix_cleunik_droite=-116;	//	Commande client destination
    break;
  case $vf_c_action=="offcli->offcli":  //  Duplication d'une offre client
    $id_fen_doc_cial="Fen_00671";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_offcli_entetes";
    $table_adress_sourc="_offcli_adresses";
    $table_repres_sourc="_offcli_representants";
    $table_transp_sourc="_offcli_transporteurs";
    $table_consig_sourc="_offcli_consignes";
    $table_lignes_sourc="_offcli_lignes";
    $table_ligqte_sourc="_offcli_lignes_qte";
    $table_entete_cible="_offcli_entetes";
    $table_adress_cible="_offcli_adresses";
    $table_repres_cible="_offcli_representants";
    $table_transp_cible="_offcli_transporteurs";
    $table_consig_cible="_offcli_consignes";
    $table_lignes_cible="_offcli_lignes";
    $table_ligqte_cible="_offcli_lignes_qte";
    $indice_numerotation=1;//  Numérotation automatique 1 -> clé offres clients
    $vf_e_choix_cleunik_doc=-110114;
		$choix_cleunik_gauche=-113;	//	Offre client d'origine
		$choix_cleunik_droite=-114;	//	Offre client destination
    break;
  case $vf_c_action=="offcli->cdecli":  //  Transformation d'une offre en une commande client
    $id_fen_doc_cial="Fen_00477";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_offcli_entetes";
    $table_adress_sourc="_offcli_adresses";
    $table_repres_sourc="_offcli_representants";
    $table_transp_sourc="_offcli_transporteurs";
    $table_consig_sourc="_offcli_consignes";
    $table_lignes_sourc="_offcli_lignes";
    $table_ligqte_sourc="_offcli_lignes_qte";
    $table_entete_cible="_cdecli_entetes";
    $table_adress_cible="_cdecli_adresses";
    $table_repres_cible="_cdecli_representants";
    $table_transp_cible="_cdecli_transporteurs";
    $table_consig_cible="_cdecli_consignes";
    $table_lignes_cible="_cdecli_lignes";
    $table_ligqte_cible="_cdecli_lignes_qte";
    $indice_numerotation=2;//  Numérotation automatique 2 -> clé commandes clients
    $vf_e_choix_cleunik_doc=-110108;
		$choix_cleunik_gauche=-113;	//	Offre client d'origine
		$choix_cleunik_droite=-116;	//	Commande client destination
    break;
  case $vf_c_action=="cdecli->livcli":  //  Transformation d'une commande client en livraison
  case $vf_c_action=="cdecli->livcli_partielle":  //  Transformation partielle d'une commande client en livraison
    $id_fen_doc_cial="Fen_00672";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdecli_entetes";
    $table_adress_sourc="_cdecli_adresses";
    $table_repres_sourc="_cdecli_representants";
    $table_transp_sourc="_cdecli_transporteurs";
    $table_consig_sourc="_cdecli_consignes";
    $table_lignes_sourc="_cdecli_lignes";
    $table_ligqte_sourc="_cdecli_lignes_qte";
    $table_entete_cible="_livcli_entetes";
    $table_adress_cible="_livcli_adresses";
    $table_repres_cible="_livcli_representants";
    $table_transp_cible="_livcli_transporteurs";
    $table_consig_cible="_livcli_consignes";
    $table_lignes_cible="_livcli_lignes";
    $table_ligqte_cible="_livcli_lignes_qte";
    $indice_numerotation=3;//  Numérotation automatique 3 -> clé livraisons clients
    $vf_e_choix_cleunik_doc=-110110;
		$choix_cleunik_gauche=-115;	//	Commande client d'origine
		$choix_cleunik_droite=-118;	//	Livraison client destination
    break;
  case $vf_c_action=="cdecli->faccli":  //  Transformation d'une commande client en facture
  case $vf_c_action=="cdecli->profor":	//	Transformation d'une commande client en facture pro-forma
    $id_fen_doc_cial="Fen_00673";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdecli_entetes";
    $table_adress_sourc="_cdecli_adresses";
    $table_repres_sourc="_cdecli_representants";
    $table_transp_sourc="_cdecli_transporteurs";
    $table_consig_sourc="_cdecli_consignes";
    $table_lignes_sourc="_cdecli_lignes";
    $table_ligqte_sourc="_cdecli_lignes_qte";
    $table_entete_cible="_faccli_entetes";
    $table_adress_cible="_faccli_adresses";
    $table_repres_cible="_faccli_representants";
    $table_transp_cible="_faccli_transporteurs";
    $table_consig_cible="_faccli_consignes";
    $table_lignes_cible="_faccli_lignes";
    $table_ligqte_cible="_faccli_lignes_qte";
    $indice_numerotation=4;//  Numérotation automatique 4 -> clé factures clients
    $vf_e_choix_cleunik_doc=-110112;
		$choix_cleunik_gauche=-115;	//	Commande client d'origine
		$choix_cleunik_droite=-120;	//	Facture client destination
		switch ($vf_c_action) {
			case "cdecli->faccli":
				$fact_type=1;
				$fact_genr=1;
				$compta_etat=1;//	à comptabiliser
				break;
		  case "cdecli->profor":
				$fact_type=1;
				$fact_genr=2;
				$compta_etat=4;//	à ne pas comptabiliser
				break;
		}
    break;
  case $vf_c_action=="livcli->faccli":  //  Transformation d'une livraison client en facture
  case $vf_c_action=="livcli_multi->faccli":  //  Transformation de plusieurs livraisons client en une seule facture
  case $vf_c_action=="livcli->profor":	//	Transformation d'une livraison client en facture pro-forma
    $id_fen_doc_cial="Fen_00673";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_livcli_entetes";
    $table_adress_sourc="_livcli_adresses";
    $table_repres_sourc="_livcli_representants";
    $table_transp_sourc="_livcli_transporteurs";
    $table_consig_sourc="_livcli_consignes";
    $table_lignes_sourc="_livcli_lignes";
    $table_ligqte_sourc="_livcli_lignes_qte";
    $table_entete_cible="_faccli_entetes";
    $table_adress_cible="_faccli_adresses";
    $table_repres_cible="_faccli_representants";
    $table_transp_cible="_faccli_transporteurs";
    $table_consig_cible="_faccli_consignes";
    $table_lignes_cible="_faccli_lignes";
    $table_ligqte_cible="_faccli_lignes_qte";
    $indice_numerotation=4;//  Numérotation automatique 4 -> clé factures clients
    $vf_e_choix_cleunik_doc=-110112;
		$choix_cleunik_gauche=-117;	//	Commande client d'origine
		$choix_cleunik_droite=-120;	//	Facture client destination
		switch ($vf_c_action) {
			case "livcli->faccli":
			case "livcli_multi->faccli":  //  Transformation de plusieurs livraisons client en une seule facture
				$fact_type=1;
				$fact_genr=1;
				$compta_etat=1;//	à comptabiliser
				break;
		  case "livcli->profor":
				$fact_type=1;
				$fact_genr=2;
				$compta_etat=4;//	à ne pas comptabiliser
				break;
		}
    break;
  case $vf_c_action=="faccli->avocli":  //  Transformation d'une facture client en avoir sur stock client
	case $vf_c_action=="faccli->avofin":  //  Transformation d'une facture client en avoir financier client
    $id_fen_doc_cial="Fen_00674";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_faccli_entetes";
    $table_adress_sourc="_faccli_adresses";
    $table_repres_sourc="_faccli_representants";
    $table_transp_sourc="_faccli_transporteurs";
    $table_consig_sourc="_faccli_consignes";
    $table_lignes_sourc="_faccli_lignes";
    $table_ligqte_sourc="_faccli_lignes_qte";
    $table_entete_cible="_avocli_entetes";
    $table_adress_cible="_avocli_adresses";
    $table_repres_cible="_avocli_representants";
    $table_transp_cible="_avocli_transporteurs";
    $table_consig_cible="_avocli_consignes";
    $table_lignes_cible="_avocli_lignes";
    $table_ligqte_cible="_avocli_lignes_qte";
    $indice_numerotation=4;//  Numérotation automatique 4 -> clé factures clients
		$choix_cleunik_gauche=-119;	//	Facture client d'origine
		switch (TRUE) {
		  case $vf_c_action=="faccli->avocli":
				$vf_e_choix_cleunik_doc=-110116;
				$choix_cleunik_droite=-122;	//	Avoir sur stock client destination
				$type_avoir=2;
				break;
			case $vf_c_action=="faccli->avofin":
				$vf_e_choix_cleunik_doc=-110117;
				$choix_cleunik_droite=-124;	//	Avoir financier client destination
				$type_avoir=1;
				break;
		}
    break;
  case $vf_c_action=="retcli->avofin":  //  Transformation d'un retour client en avoir financier client
    $id_fen_doc_cial="Fen_00674";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_retcli_entetes";
    $table_adress_sourc="_retcli_adresses";
    $table_repres_sourc="_retcli_representants";
    $table_transp_sourc="_retcli_transporteurs";
    $table_consig_sourc="_retcli_consignes";
    $table_lignes_sourc="_retcli_lignes";
    $table_ligqte_sourc="_retcli_lignes_qte";
    $table_entete_cible="_avocli_entetes";
    $table_adress_cible="_avocli_adresses";
    $table_repres_cible="_avocli_representants";
    $table_transp_cible="_avocli_transporteurs";
    $table_consig_cible="_avocli_consignes";
    $table_lignes_cible="_avocli_lignes";
    $table_ligqte_cible="_avocli_lignes_qte";
    $indice_numerotation=4;//  Numérotation automatique 4 -> clé factures clients
	$choix_cleunik_gauche=-161;	//	Retour client d'origine
	$vf_e_choix_cleunik_doc=-110117;
	$choix_cleunik_droite=-124;	//	Avoir financier client destination
	$type_avoir=1;
    break;
  case $vf_c_action=="profor->faccli":  //  Transformation d'une facture client pro-forma en facture client "classique" (les mouvements de stocks ont été fait lors de l'établissement de la pro-forma)
    $id_fen_doc_cial="Fen_00674";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_faccli_entetes";
    $table_adress_sourc="_faccli_adresses";
    $table_repres_sourc="_faccli_representants";
    $table_transp_sourc="_faccli_transporteurs";
    $table_consig_sourc="_faccli_consignes";
    $table_lignes_sourc="_faccli_lignes";
    $table_ligqte_sourc="_faccli_lignes_qte";
    $table_entete_cible="_faccli_entetes";
    $table_adress_cible="_faccli_adresses";
    $table_repres_cible="_faccli_representants";
    $table_transp_cible="_faccli_transporteurs";
    $table_consig_cible="_faccli_consignes";
    $table_lignes_cible="_faccli_lignes";
    $table_ligqte_cible="_faccli_lignes_qte";
    $indice_numerotation=4;//  Numérotation automatique 4 -> clé factures clients
		$choix_cleunik_gauche=-120;	//	Facture client pr-forma d'origine
		$choix_cleunik_droite=-120;	//	Facture client destination
    $vf_e_choix_cleunik_doc=-110112;
		$fact_type=2;	// sans mouvement de stocks (dèjà fait dans la pro-forma)
		$fact_genr=1;	//	facture "classique" 
		$compta_etat=1;//	à comptabiliser
    break;
  case $vf_c_action=="demfou->demfou":  //  Duplication d'une demande fournisseur
    $id_fen_doc_cial="Fen_00675";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_demfou_entetes";
    $table_adress_sourc="_demfou_adresses";
    $table_lignes_sourc="_demfou_lignes";
    $table_ligqte_sourc="_demfou_lignes_qte";
    $table_entete_cible="_demfou_entetes";
    $table_adress_cible="_demfou_adresses";
    $table_lignes_cible="_demfou_lignes";
    $table_ligqte_cible="_demfou_lignes_qte";
    $indice_numerotation=5;//  Numérotation automatique 5 -> clé demandes fournisseurs
    $vf_e_choix_cleunik_doc=-110115;
		$choix_cleunik_gauche=-125;	//	Demande fournisseur d'origine
		$choix_cleunik_droite=-126;	//	Demande fournisseur destination
    break;
  case $vf_c_action=="demfou->cdefou":  //  Transformation d'une demande en une commande fournisseur
    $id_fen_doc_cial="Fen_00676";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_demfou_entetes";
    $table_adress_sourc="_demfou_adresses";
    $table_lignes_sourc="_demfou_lignes";
    $table_ligqte_sourc="_demfou_lignes_qte";
    $table_entete_cible="_cdefou_entetes";
    $table_adress_cible="_cdefou_adresses";
    $table_lignes_cible="_cdefou_lignes";
    $table_ligqte_cible="_cdefou_lignes_qte";
    $indice_numerotation=6;//  Numérotation automatique 6 -> clé commandes fournisseurs
    $vf_e_choix_cleunik_doc=-110109;
		$choix_cleunik_gauche=-125;	//	Demande d'origine
		$choix_cleunik_droite=-128;	//	Commande fournisseur destination
    break;
  case $vf_c_action=="cdefou->cdefou":  //  duplication d'une commande fournisseur
    $id_fen_doc_cial="Fen_00676";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdefou_entetes";
    $table_adress_sourc="_cdefou_adresses";
    $table_lignes_sourc="_cdefou_lignes";
    $table_ligqte_sourc="_cdefou_lignes_qte";
    $table_entete_cible="_cdefou_entetes";
    $table_adress_cible="_cdefou_adresses";
    $table_lignes_cible="_cdefou_lignes";
    $table_ligqte_cible="_cdefou_lignes_qte";
    $indice_numerotation=6;//  Numérotation automatique 6 -> clé commandes fournisseurs
    $vf_e_choix_cleunik_doc=-110109;
		$choix_cleunik_gauche=-127;	//	Commande d'origine
		$choix_cleunik_droite=-128;	//	Commande fournisseur destination
    break;
  case $vf_c_action=="cdefou->demfou":  //  Transformation d'une commande fournisseur en demande
    $id_fen_doc_cial="Fen_00675";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdefou_entetes";
    $table_adress_sourc="_cdefou_adresses";
    $table_lignes_sourc="_cdefou_lignes";
    $table_ligqte_sourc="_cdefou_lignes_qte";
    $table_entete_cible="_demfou_entetes";
    $table_adress_cible="_demfou_adresses";
    $table_lignes_cible="_demfou_lignes";
    $table_ligqte_cible="_demfou_lignes_qte";
    $indice_numerotation=5;//  Numérotation automatique 5 -> clé demandes fournisseurs
    $vf_e_choix_cleunik_doc=-110115;
	$choix_cleunik_gauche=-127;	//	Commande d'origine
	$choix_cleunik_droite=-126;	//	Commande fournisseur destination
    break;
  case $vf_c_action=="cdefou->relfou":  //  Transformation de lignes de commandes fournisseurs en (éventuellement) n relances fournisseurs
    $id_fen_doc_cial="Fen_01134";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdefou_entetes";
    $table_adress_sourc="_cdefou_adresses";
    $table_lignes_sourc="_cdefou_lignes";
    $table_ligqte_sourc="_cdefou_lignes_qte";
    $table_entete_cible="_relfou_entetes";
    $table_adress_cible="_relfou_adresses";
    $table_lignes_cible="_relfou_lignes";
    $table_ligqte_cible="_relfou_lignes_qte";
    $indice_numerotation=20;//  Numérotation automatique 20 -> clé relance fournisseurs
    $vf_e_choix_cleunik_doc=-110135;
	$choix_cleunik_gauche=-127;	//	Commande fournisseur d'origine
	$choix_cleunik_droite=-162;	//	Relance fournisseur destination
    break;
  case $vf_c_action=="cdefou->recfou":  //  Transformation d'une commande fournisseur en réception
  case $vf_c_action=="cdefou->recfou_partielle":  //  Transformation partielle d'une commande fournisseur en réception
    $id_fen_doc_cial="Fen_00677";
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    $table_entete_sourc="_cdefou_entetes";
    $table_adress_sourc="_cdefou_adresses";
    $table_lignes_sourc="_cdefou_lignes";
    $table_ligqte_sourc="_cdefou_lignes_qte";
    $table_entete_cible="_recfou_entetes";
    $table_adress_cible="_recfou_adresses";
    $table_lignes_cible="_recfou_lignes";
    $table_ligqte_cible="_recfou_lignes_qte";
    $indice_numerotation=7;//  Numérotation automatique 7 -> clé réceptions fournisseurs
    $vf_e_choix_cleunik_doc=-110111;
		$choix_cleunik_gauche=-127;	//	Commande fournisseur d'origine
		$choix_cleunik_droite=-130;	//	Réception fournisseur destination
    break;
    case $vf_c_action=="recfou->facfou":  //  Transformation d'une réception fournisseur en facture
	    $id_fen_doc_cial="Fen_00678";
	    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
	    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
	    $table_entete_sourc="_recfou_entetes";
	    $table_adress_sourc="_recfou_adresses";
	    $table_lignes_sourc="_recfou_lignes";
	    $table_ligqte_sourc="_recfou_lignes_qte";
	    $table_entete_cible="_facfou_entetes";
	    $table_adress_cible="_facfou_adresses";
	    $table_lignes_cible="_facfou_lignes";
	    $table_ligqte_cible="_facfou_lignes_qte";
	    $indice_numerotation=8;//  Numérotation automatique 8 -> clé factures fournisseurs
	    $vf_e_choix_cleunik_doc=-110113;
		$choix_cleunik_gauche=-157;	//	Réception fournisseur d'origine
		$choix_cleunik_droite=-158;	//	Facture fournisseur destination
		$fact_type=1;
		$fact_genr=1;
		$compta_etat=1;//	à comptabiliser
	    break;
	case $vf_c_action=="recfou_multi->facfou":   //  Transformation de plusieurs réceptions fournisseurs en une seule facture
	    $id_fen_doc_cial="Fen_00678";
	    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
	    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
	    $table_entete_sourc="_recfou_entetes";
	    $table_adress_sourc="_recfou_adresses";
	    $table_lignes_sourc="_recfou_lignes";
	    $table_ligqte_sourc="_recfou_lignes_qte";
	    $table_entete_cible="_facfou_entetes";
	    $table_adress_cible="_facfou_adresses";
	    $table_lignes_cible="_facfou_lignes";
	    $table_ligqte_cible="_facfou_lignes_qte";
	    $indice_numerotation=8;//  Numérotation automatique 8 -> clé factures fournisseurs
	    $vf_e_choix_cleunik_doc=-110113;
		$choix_cleunik_gauche=-157;	//	Réception fournisseur d'origine
		$choix_cleunik_droite=-158;	//	Facture fournisseur destination
		$fact_type=1;
		$fact_genr=1;
		$compta_etat=1;//	à comptabiliser
	    break;
	 case $vf_c_action=="retfou_multi->avofou":   //  Transformation de plusieurs bons de retours fournisseurs en un seul avoir
	    $id_fen_doc_cial="Fen_01139";
	    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
	    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
	    $table_entete_sourc="_retfou_entetes";
	    $table_adress_sourc="_retfou_adresses";
	    $table_lignes_sourc="_retfou_lignes";
	    $table_ligqte_sourc="_retfou_lignes_qte";
	    $table_entete_cible="_avofou_entetes";
	    $table_adress_cible="_avofou_adresses";
	    $table_lignes_cible="_avofou_lignes";
	    $table_ligqte_cible="_avofou_lignes_qte";
	    $indice_numerotation=8;//  Numérotation automatique 8 -> clé factures fournisseurs
	    $vf_e_choix_cleunik_doc=-110138;
		$choix_cleunik_gauche=-160;	//	Réception fournisseur d'origine
		$choix_cleunik_droite=-165;	//	Facture fournisseur destination
		$type_avoir=1;
		$compta_etat=1;//	à comptabiliser
	    break;
	 case $vf_c_action=="retfou->avofou":  //  Transformation d'un retour fournisseur en avoir
	    $id_fen_doc_cial="Fen_01139";
	    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
	    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
	    $table_entete_sourc="_retfou_entetes";
	    $table_adress_sourc="_retfou_adresses";
	    $table_lignes_sourc="_retfou_lignes";
	    $table_ligqte_sourc="_retfou_lignes_qte";
	    $table_entete_cible="_avofou_entetes";
	    $table_adress_cible="_avofou_adresses";
	    $table_lignes_cible="_avofou_lignes";
	    $table_ligqte_cible="_avofou_lignes_qte";
	    $indice_numerotation=8;//  Numérotation automatique 8 -> clé factures fournisseurs
	    $vf_e_choix_cleunik_doc=-110138;//	Avoir financier
		$choix_cleunik_gauche=-160;	//	Retour fournisseur d'origine
		$choix_cleunik_droite=-165;	//	Avoir fournisseur destination
		$compta_etat=1;//	à comptabiliser
		$type_avoir=1;
	    break;
	    
	    
}
switch (TRUE) {
	case $vf_c_action=="cdefou->relfou":
		$vl_t_listecles=fa_recup_param('vl_t_listecles','');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$vl_action_cleunik="";
		$vl_e_i=-1;
		foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_action_cleunik.=$vl_t_listecles[$vl_e_i].',';
          $vl_action_cleunik_sourc=$vl_t_listecles[$vl_e_i];
        }
		if ($vl_action_cleunik!="") {
          $vl_action_cleunik=substr($vl_action_cleunik, 0, -1);
        }  else {
          $vl_action_cleunik="-99999999";
        }
        $vl_act_cleunik_rupture="";
		$req_action="select f1.commercial_cleunik,f1.act_cleunik,f1.action_cleunik,f2.*,f3.* from $table_entete_sourc f1 left join $table_lignes_sourc f2 using(commercial_cleunik) left join $table_ligqte_sourc f3 using(commercial_ligne_cleunik)";
		$req_action.=" where f3.commercial_ligne_cleunik in($vl_action_cleunik) order by f1.act_cleunik,f1.commercial_cleunik,f3.ligne_cleunik,f3.ligne_qte_cleunik";
    	//echo $req_action.EOL;
		$result_action = _graal_requete_bd($req_action);
    	while ($row = mysql_fetch_assoc($result_action)){
    		if ($vl_act_cleunik_rupture!=$row['act_cleunik']){
    			$ligne_cleunik=0;
    			$ligne_cleunik_qte=0;
				$vl_act_cleunik_rupture=$row['act_cleunik'];
	    		$vl_action_cleunik_sourc=$row['action_cleunik'];
				$vl_commercial_cleunik_sourc_prems=$row['commercial_cleunik'];
    			//  Début de la transaction
	    		$deb_trans=_graal_requete_bd("START TRANSACTION;");
	   
			    $vl_action_cleunik_cible=_graal_requete_max("action_cleunik","_actions");
			    $vl_commercial_cleunik_cible=_graal_requete_max("commercial_cleunik","$table_entete_cible");
			    $vl_uuid=_graal_requete_uuid();
			    $code=_graal_numerote($indice_numerotation);
			    $vf_c_retour="";
				if ($vl_nouvelle_date_fac!="19610123"){
					$col_dateheuredebut="'$vl_nouvelle_date_liv $vl_nouvelle_heur_liv'";
			    	$col_dateheurefin="'$vl_nouvelle_date_liv $vl_nouvelle_heur_liv'";
				}
			    $req_action="INSERT INTO _actions select $vl_action_cleunik_cible, $vf_e_choix_cleunik_doc, $col_dateheuredebut, $col_dateheurefin, now(), now(), blocnote_brut, blocnote_riche, position, description, '$vl_uuid', action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, '$code', reference,gestion_duree from _actions where action_cleunik=$vl_action_cleunik_sourc;";
			    $vf_c_echo=_graal_exec_requete($req_action);
			    
    		if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
			    $req_graal_sourc="SELECT `act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal` FROM _graal where action_cleunik in($vl_action_cleunik_sourc);";
		      	$result = _graal_requete_bd($req_graal_sourc);
		      	while ($row = mysql_fetch_assoc($result)){
			        $act_cleunik=fa_nn($row['act_cleunik']);
			        $int_cleunik=fa_nn($row['int_cleunik']);
			        $blocnotebrut=fa_nt($row['blocnotebrut']);
			        $blocnotertf=fa_nt($row['blocnotertf']);
			        $portee=fa_nn($row['portee']);
			        $principal=fa_nn($row['principal']);
			        $choix_cleunik=fa_nn($row['choix_cleunik']);
			        if ($choix_cleunik==-110413) {$choix_cleunik=-110444;} //  De fournisseur emetteur de la réception on passe à fournisseur emetteur de la facture
			        $req_graal_cible = "INSERT INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal`) VALUES ($act_cleunik,$int_cleunik,$vl_action_cleunik_cible,$choix_cleunik,$blocnotebrut,$blocnotertf,$portee,$principal);";
			        $vf_c_echo=_graal_exec_requete($req_graal_cible);
			        //if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}	On ne teste pas l'erreur qui peut-être normale dans ce cas
			    }
		      	_graal_libere_requete_bd($result);
		   		$req_choix="INSERT into _actions_choix_fixes select $vl_action_cleunik_cible, `choix_cleunik`, `critere_cleunik`, `uti_cleunik` from _actions_choix_fixes where action_cleunik=$vl_action_cleunik_sourc;";
		      $vf_c_echo=_graal_exec_requete($req_choix);
		      if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
				$req_action="select action_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik_sourc);";
				//die($req_action);
		    	$result = _graal_requete_bd($req_action);
		    	while ($row = mysql_fetch_assoc($result)){
		    		$req_graal_act=" INSERT INTO _graal_act (action_cleunik_gauche,action_cleunik_droite,choix_cleunik_droite,choix_cleunik_gauche) values (".$row['action_cleunik'].", $vl_action_cleunik_cible, $choix_cleunik_droite,$choix_cleunik_gauche)";
		    		$vf_c_echo=_graal_exec_requete($req_graal_act);
		    	}
		      	_graal_libere_requete_bd($result);
			  	if ($vl_nouvelle_date_fac!="19610123"){
					$col_date_fact="'$vl_nouvelle_date_fac'";
				}  
				$req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, null, ";
				$req_entete.=" reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik,";
				$req_entete.="  reg_cleunik, null, rendezvous, modliv, typpor, $col_dateheureexpedition, $col_dateheurelivraison, frais_type, 0, port_type, 0,";
				$req_entete.="  acompte_type, 0,modliv_bis,assujetti_tpf ";
				$req_entete.=" from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
			    $vf_c_echo=_graal_exec_requete($req_entete);
    		    if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
			    if($vf_c_echo=='ok') {
		
			      	$req_adresse_sourc="SELECT `adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, `dateheuremodif`, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`, `adr_type` FROM $table_adress_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
			        $result = _graal_requete_bd($req_adresse_sourc);
			        while ($row = mysql_fetch_assoc($result)){
			          $vl_adr_cleunik_cible=_graal_requete_max("adr_cleunik","$table_adress_cible");
			          $adr_cod=fa_nt($row['adr_cod']);
			          $adr_nom=fa_nt($row['adr_nom']);
			          $adr_complementnom=fa_nt($row['adr_complementnom']);
			          $adr_ligne1=fa_nt($row['adr_ligne1']);
			          $adr_ligne2=fa_nt($row['adr_ligne2']);
			          $adr_ligne3=fa_nt($row['adr_ligne3']);
			          $adr_cp=fa_nt($row['adr_cp']);
			          $adr_ville=fa_nt($row['adr_ville']);
			          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
			          $adr_latitude=fa_nn($row['adr_latitude']);
			          $adr_longitude=fa_nn($row['adr_longitude']);
			          $adr_typecoordonnees=fa_nn($row['adr_typecoordonnees']);
					  $adr_type=fa_nn($row['adr_type']);
			          $req_adresse_cible = "INSERT INTO $table_adress_cible (`adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, dateheuremodif, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`,`adr_type`) VALUES ($vl_adr_cleunik_cible, $adr_cod, $vl_commercial_cleunik_cible, $adr_nom, $adr_complementnom, $adr_ligne1, $adr_ligne2, $adr_ligne3, $adr_cp, $adr_ville, $vl_pays_cleunik, now(), $adr_latitude, $adr_longitude, $adr_typecoordonnees,$adr_type);";
			          $vf_c_echo=_graal_exec_requete($req_adresse_cible);
			          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
			        }
	        		_graal_libere_requete_bd($result);
    			/*
    			 * On lit les lignes
    			 */
	        		$req_lignes="select f1.commercial_cleunik,f1.act_cleunik,f1.action_cleunik,  f2.`art_cleunik`, f2.`code_interne`, f2.`indice_interne`, f2.`mnemotechnique_interne`,";
	        		$req_lignes.=" f2.`description_interne`, f2.`code_acteur`, f2.`mnemotechnique_acteur`, f2.`description_acteur`, f2.`typeligne`, f2.`pu`, f2.`pu_portee`, f2.`pu_type`,";
	        		$req_lignes.=" f2.`nbdec_pu`, f2.`tarif_cleunik`, f2.`remise_taux`, f2.`remise_type`, f2.`remise_genr`, f2.`poidsbrut`, f2.`tare`, f2.`poidsnet`, f2.`devise_taux`,";
	        		$req_lignes.=" f2.`pr`, f2.`blocnotebrut`, f2.`blocnoteriche`, f2.`devise`, f2.`catcompta_cleunik`, f2.`pc_cleunik`, f2.`remise_natu`, f2.`coef_facture`,";
	        		$req_lignes.=" f2.`taxes_cleunik`, f2.`longueur`, f2.`largeur`, f2.`epaisseur`, f2.`unite_longueur`, f2.`tpf_cleunik`,f2.tpf_cleunik_01,f3.`ligne_cleunik`, f3.`ligne_qte_cleunik`,";
	        		$req_lignes.=" f3.`qte`, f3.`qte_unite`, f3.`qte_nbdec`, f3.`dateheure_demande`, f3.`dateheure_confirm`, f3.`statut`, f3.`unite_condi`, f3.`qte_condi`,";
	        		$req_lignes.=" f3.`nb_stock_in_condi`, f3.`choix_depot`, f3.`choix_empla`,f3.`qte_deja`";
	        		$req_lignes.=" from $table_entete_sourc f1 left join $table_lignes_sourc f2 using(commercial_cleunik) left join $table_ligqte_sourc f3 using(commercial_ligne_cleunik)";
	        		$req_lignes.=" where f3.commercial_ligne_cleunik in($vl_action_cleunik) and act_cleunik = $vl_act_cleunik_rupture order by f1.act_cleunik,f1.commercial_cleunik,f3.ligne_cleunik,f3.ligne_qte_cleunik";
			        //echo $req_lignes.EOL;
					$result_lignes = _graal_requete_bd($req_lignes);
					
			        while ($row = mysql_fetch_assoc($result_lignes)){
			        	$vl_commercial_ligne_cleunik_source=fa_nn($row['commercial_ligne_cleunik']);
				          $ligne_cleunik++;
				          $vf_e_ligne_cleunik=fa_nn($row['ligne_cleunik']);
				          $art_cleunik=fa_nn($row['art_cleunik']);
				          $code_interne=fa_nt($row['code_interne']);
				          $indice_interne=fa_nt($row['indice_interne']);
				          $mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
				          $description_interne=fa_nt($row['description_interne']);
				          $code_acteur=fa_nt($row['code_acteur']);
				          $mnemotechnique_acteur=fa_nt($row['mnemotechnique_acteur']);
				          $description_acteur=fa_nt($row['description_acteur']);
				          $typeligne=fa_nt($row['typeligne']);
				          $pu=fa_nn($row['pu']);
				          $pu_portee=fa_nn($row['pu_portee']);
				          $pu_type=fa_nn($row['pu_type']);
				          $nbdec_pu=fa_nn($row['nbdec_pu']);
				          $tarif_cleunik=fa_nn($row['tarif_cleunik']);
				          $remise_taux=fa_nn($row['remise_taux']);
				          $remise_type=fa_nn($row['remise_type']);
				          $remise_genr=fa_nn($row['remise_genr']);
				          $poidsbrut=fa_nn($row['poidsbrut']);
				          $tare=fa_nn($row['tare']);
				          $poidsnet=fa_nn($row['poidsnet']);
				          $devise_taux=fa_nn($row['devise_taux']);
				          $pr=fa_nn($row['pr']);
				          $blocnotebrut=fa_nt($row['blocnotebrut']);
				          $blocnoteriche=fa_nt($row['blocnoteriche']);
				          $devise=fa_nn($row['devise']);
				          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
				          $pc_cleunik=fa_nn($row['pc_cleunik']);
				          $remise_natu=fa_nn($row['remise_natu']);
				          $coef_facture=fa_nn($row['coef_facture']);
				          $taxes_cleunik=fa_nn($row['taxes_cleunik']);
				          $vl_e_types_gestion=fa_nn($row['types_gestion']);
				          $vl_e_gestion_dep_emp=fa_nn($row['gestion_dep_emp']);
				          $longueur=fa_nn($row['longueur']);
				          $largeur=fa_nn($row['largeur']);
				          $epaisseur=fa_nn($row['epaisseur']);
				          $unite_longueur=fa_nn($row['unite_longueur']);
				          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
				          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
				          $vl_commercial_ligne_cleunik_cible=_graal_requete_max("commercial_ligne_cleunik","$table_lignes_cible");
				          $req_lignes_cible = "INSERT INTO $table_lignes_cible (`commercial_ligne_cleunik`, `commercial_cleunik`, `ligne_cleunik`, `art_cleunik`, `code_interne`, `indice_interne`,";
				          $req_lignes_cible.=" `mnemotechnique_interne`, `description_interne`, `code_acteur`, `mnemotechnique_acteur`, `description_acteur`, `typeligne`, `pu`, `pu_portee`, `pu_type`,";
				          $req_lignes_cible.=" `nbdec_pu`, `tarif_cleunik`, `remise_taux`, `remise_type`, `remise_genr`, `poidsbrut`, `tare`, `poidsnet`, `devise_taux`, `pr`, `blocnotebrut`,";
				          $req_lignes_cible.=" `blocnoteriche`, `devise`, `catcompta_cleunik`, `pc_cleunik`, `remise_natu`, `coef_facture`, `taxes_cleunik`, `longueur`, `largeur`, `epaisseur`,";
				          $req_lignes_cible.=" `unite_longueur`, `tpf_cleunik`,tpf_cleunik_01)";
				          $req_lignes_cible.=" VALUES ($vl_commercial_ligne_cleunik_cible,$vl_commercial_cleunik_cible,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,";
				          $req_lignes_cible.=" $description_interne,$code_acteur,$mnemotechnique_acteur,$description_acteur,$typeligne,$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,";
				          $req_lignes_cible.=" $remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,$blocnotebrut,$blocnoteriche,$devise,$catcompta_cleunik,$pc_cleunik,$remise_natu,";
				          $req_lignes_cible.=" $coef_facture,$taxes_cleunik,$longueur,$largeur,$epaisseur,$unite_longueur,$tpf_cleunik,$tpf_cleunik_01);";
				          //$_SESSION['req_02']=$req_lignes_cible;
				          //echo $req_lignes_cible.EOL;
				          $vf_c_echo=_graal_exec_requete($req_lignes_cible);
			              if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
				          $commercial_ligne_cleunik_recfou=fa_nn($row['commercial_ligne_cleunik']);
		            	  $cdefou_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
			              $ligne_cleunik_qte++;
			              $qte=fa_nn($row['qte']);
			              $qte_unite=fa_nn($row['qte_unite']);
			              $qte_nbdec=fa_nn($row['qte_nbdec']);
			              $dateheure_demande=fa_nt($row['dateheure_demande']);
			              switch ($param_generaux_graal_176){
							case 1://	date du document = date du jour de création (sauf si date forcée)
					            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
								break;
							case 2:
					            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
			              		break;
			              }
			              $statut=fa_nn($row['statut']);
			              $statut=-38;
			              $unite_condi=fa_nn($row['unite_condi']);
			              $qte_condi=fa_nn($row['qte_condi']);
			              $nb_stock_in_condi=fa_nn($row['nb_stock_in_condi']);
			              $choix_depot=fa_nn($row['choix_depot']);
			              $choix_empla=fa_nn($row['choix_empla']);
			              $qte_deja=0;
			              $vl_ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$table_ligqte_cible");
		            	  $vl_mousto_mvt_cleunik="NULL";
		                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`,";
		                  $req_ligqte_cible.= " `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdefou_ligne_qte_cleunik`,";
		                  $req_ligqte_cible.= " `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible";
		                  $req_ligqte_cible.= " ,$ligne_cleunik_qte,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi";
		                  $req_ligqte_cible.= " ,$qte_condi,$nb_stock_in_condi,$cdefou_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla,$qte_deja);";
			        	  $vf_c_echo=_graal_exec_requete($req_ligqte_cible);
			        	  //echo $req_ligqte_cible.EOL;
			        	  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
			        }
	        		_graal_libere_requete_bd($result_lignes);
    			}
    			}
    		}
    		
    	_graal_libere_requete_bd($result_action);
    	if ($vf_c_retour=="") {
	      	$vf_c_retour="ok"."|";
      		_graal_requete_bd("COMMIT;");
	    } else {
	      //$vf_c_retour=-1;
	      _graal_requete_bd("ROLLBACK;");
	    }
    	echo $vf_c_retour;
		
		break;
	case $vf_c_action=="recfou_multi->facfou":   //  Transformation de plusieurs réceptions fournisseurs en une seule facture
		$vl_t_listecles=fa_recup_param('vl_t_listecles','');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$vl_action_cleunik="";
		$vl_e_i=-1;
		foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_action_cleunik.=$vl_t_listecles[$vl_e_i].',';
          $vl_action_cleunik_sourc=$vl_t_listecles[$vl_e_i];
        }
		if ($vl_action_cleunik!="") {
          $vl_action_cleunik=substr($vl_action_cleunik, 0, -1);
        }  else {
          $vl_action_cleunik="-99999999";
        }
		$req_action="select commercial_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
		//die($req_action);
    	$result = _graal_requete_bd($req_action);
    	$vl_commercial_cleunik_sourc="";
    	while ($row = mysql_fetch_assoc($result)){
      		$vl_commercial_cleunik_sourc.=$row['commercial_cleunik'].",";
      		$vl_commercial_cleunik_sourc_prems=$row['commercial_cleunik'];
    	}
    	_graal_libere_requete_bd($result);
		if ($vl_commercial_cleunik_sourc!="") {
          $vl_commercial_cleunik_sourc=substr($vl_commercial_cleunik_sourc, 0, -1);
        }  else {
          $vl_commercial_cleunik_sourc="-99999999";
        }
        /*
         * vérification qu'il n'y a qu'un seul acteur
         */
        $nb_acteurs_differents=0;
        $req_action="select count(distinct act_cleunik) as nb_acteurs_differents from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$nb_acteurs_differents=$row['nb_acteurs_differents'];
        _graal_libere_requete_bd($result);
        if ($nb_acteurs_differents!=1){
        	die("-1|");
        }
        /*
         * somme des ports des bons de réception
         */
        $total_port=0;
        $req_action="select sum(port_taux) as total_port from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_port=fa_nt($row['total_port']);
        _graal_libere_requete_bd($result);
        /*
         * somme des frais des bons de réception
         */
        $total_frais=0;
        $req_action="select sum(frais_taux) as total_frais from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_frais=fa_nt($row['total_frais']);
        _graal_libere_requete_bd($result);
        /*
         * somme des acomptes des bons de réception
         */
        $total_acompte=0;
        $req_action="select sum(acompte_taux) as total_acompte from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_acompte=fa_nt($row['total_acompte']);
        _graal_libere_requete_bd($result);
	    //  Début de la transaction
	    $deb_trans=_graal_requete_bd("START TRANSACTION;");
	   
	    $vl_action_cleunik_cible=_graal_requete_max("action_cleunik","_actions");
	    $vl_commercial_cleunik_cible=_graal_requete_max("commercial_cleunik","$table_entete_cible");
	    $vl_uuid=_graal_requete_uuid();
	    $code=_graal_numerote($indice_numerotation);
	    $vf_c_retour="";
		if ($vl_nouvelle_date_fac!="19610123"){
			$col_dateheuredebut="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
	    	$col_dateheurefin="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
		}
	    $req_action="INSERT INTO _actions select $vl_action_cleunik_cible, $vf_e_choix_cleunik_doc, $col_dateheuredebut, $col_dateheurefin, now(), now(), blocnote_brut, blocnote_riche, position, description, '$vl_uuid', action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, '$code', reference,gestion_duree from _actions where action_cleunik=$vl_action_cleunik_sourc;";
	    $vf_c_echo=_graal_exec_requete($req_action);
	    $req_graal_sourc="SELECT `act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal` FROM _graal where action_cleunik in($vl_action_cleunik);";
      $result = _graal_requete_bd($req_graal_sourc);
      while ($row = mysql_fetch_assoc($result)){
        $act_cleunik=fa_nn($row['act_cleunik']);
        $int_cleunik=fa_nn($row['int_cleunik']);
        $blocnotebrut=fa_nt($row['blocnotebrut']);
        $blocnotertf=fa_nt($row['blocnotertf']);
        $portee=fa_nn($row['portee']);
        $principal=fa_nn($row['principal']);
        $choix_cleunik=fa_nn($row['choix_cleunik']);
        if ($choix_cleunik==-110414) {$choix_cleunik=-110415;} //  De fournisseur emetteur de la réception on passe à fournisseur emetteur de la facture
        $req_graal_cible = "INSERT INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal`) VALUES ($act_cleunik,$int_cleunik,$vl_action_cleunik_cible,$choix_cleunik,$blocnotebrut,$blocnotertf,$portee,$principal);";
        $vf_c_echo=_graal_exec_requete($req_graal_cible);
        //if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}	On ne teste pas l'erreur qui peut-être normale dans ce cas
      }
      _graal_libere_requete_bd($result);
   		$req_choix="INSERT into _actions_choix_fixes select $vl_action_cleunik_cible, `choix_cleunik`, `critere_cleunik`, `uti_cleunik` from _actions_choix_fixes where action_cleunik=$vl_action_cleunik_sourc;";
      $vf_c_echo=_graal_exec_requete($req_choix);
      if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
      
		$req_action="select action_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
		//die($req_action);
    	$result = _graal_requete_bd($req_action);
    	while ($row = mysql_fetch_assoc($result)){
    		$req_graal_act=" INSERT INTO _graal_act (action_cleunik_gauche,action_cleunik_droite,choix_cleunik_droite,choix_cleunik_gauche) values (".$row['action_cleunik'].", $vl_action_cleunik_cible, $choix_cleunik_droite,$choix_cleunik_gauche)";
    		$vf_c_echo=_graal_exec_requete($req_graal_act);
    	}
      	_graal_libere_requete_bd($result);
	  	if ($vl_nouvelle_date_fac!="19610123"){
			$col_date_fact="'$vl_nouvelle_date_fac'";
		}  
		$req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, null, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, null, rendezvous, modliv, typpor, $col_dateheureexpedition, $col_dateheurelivraison, frais_type, $total_frais, port_type, $total_port, acompte_type, $total_acompte,$col_date_fact,$fact_type,$fact_genr,$compta_etat,modliv_bis,assujetti_tpf from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
	    $vf_c_echo=_graal_exec_requete($req_entete);
      	if($vf_c_echo=='ok') {

      	$req_adresse_sourc="SELECT `adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, `dateheuremodif`, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`, `adr_type` FROM $table_adress_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
        $result = _graal_requete_bd($req_adresse_sourc);
        while ($row = mysql_fetch_assoc($result)){
          $vl_adr_cleunik_cible=_graal_requete_max("adr_cleunik","$table_adress_cible");
          $adr_cod=fa_nt($row['adr_cod']);
          $adr_nom=fa_nt($row['adr_nom']);
          $adr_complementnom=fa_nt($row['adr_complementnom']);
          $adr_ligne1=fa_nt($row['adr_ligne1']);
          $adr_ligne2=fa_nt($row['adr_ligne2']);
          $adr_ligne3=fa_nt($row['adr_ligne3']);
          $adr_cp=fa_nt($row['adr_cp']);
          $adr_ville=fa_nt($row['adr_ville']);
          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
          $adr_latitude=fa_nn($row['adr_latitude']);
          $adr_longitude=fa_nn($row['adr_longitude']);
          $adr_typecoordonnees=fa_nn($row['adr_typecoordonnees']);
		  $adr_type=fa_nn($row['adr_type']);
          $req_adresse_cible = "INSERT INTO $table_adress_cible (`adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, dateheuremodif, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`,`adr_type`) VALUES ($vl_adr_cleunik_cible, $adr_cod, $vl_commercial_cleunik_cible, $adr_nom, $adr_complementnom, $adr_ligne1, $adr_ligne2, $adr_ligne3, $adr_cp, $adr_ville, $vl_pays_cleunik, now(), $adr_latitude, $adr_longitude, $adr_typecoordonnees,$adr_type);";
          $vf_c_echo=_graal_exec_requete($req_adresse_cible);
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);
				

        $req_lignes_sourc="SELECT f1.commercial_ligne_cleunik, f1.commercial_cleunik,f1.ligne_cleunik,f1.art_cleunik,f1.code_interne,f1.indice_interne,f1.mnemotechnique_interne,f1.description_interne,f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f1.typeligne,f1.pu,f1.pu_portee,f1.pu_type,f1.nbdec_pu,f1.tarif_cleunik,f1.remise_taux,f1.remise_type,f1.remise_genr,f1.poidsbrut,f1.tare, f1.poidsnet,f1.devise_taux,f1.pr,f1.blocnotebrut,f1.blocnoteriche,f1.devise,f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu,f1.coef_facture,f1.taxes_cleunik,f2.types_gestion,f3.gestion as gestion_dep_emp,f1.longueur,f1.largeur,f1.epaisseur,f1.unite_longueur,f1.tpf_cleunik,f1.tpf_cleunik_01 from $table_lignes_sourc f1  left join _article f2 using(art_cleunik) left join _art_stock f3 using(art_cleunik) where commercial_cleunik in($vl_commercial_cleunik_sourc);";
        $result = _graal_requete_bd($req_lignes_sourc);
        $ligne_cleunik=0;
        while ($row = mysql_fetch_assoc($result)){
          $vl_commercial_ligne_cleunik_source=fa_nn($row['commercial_ligne_cleunik']);
          $ligne_cleunik++;
          $vf_e_ligne_cleunik=$ligne_cleunik;
          $art_cleunik=fa_nn($row['art_cleunik']);
          $code_interne=fa_nt($row['code_interne']);
          $indice_interne=fa_nt($row['indice_interne']);
          $mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
          $description_interne=fa_nt($row['description_interne']);
          $code_acteur=fa_nt($row['code_acteur']);
          $mnemotechnique_acteur=fa_nt($row['mnemotechnique_acteur']);
          $description_acteur=fa_nt($row['description_acteur']);
          $typeligne=fa_nt($row['typeligne']);
          $pu=fa_nn($row['pu']);
          $pu_portee=fa_nn($row['pu_portee']);
          $pu_type=fa_nn($row['pu_type']);
          $nbdec_pu=fa_nn($row['nbdec_pu']);
          $tarif_cleunik=fa_nn($row['tarif_cleunik']);
          $remise_taux=fa_nn($row['remise_taux']);
          $remise_type=fa_nn($row['remise_type']);
          $remise_genr=fa_nn($row['remise_genr']);
          $poidsbrut=fa_nn($row['poidsbrut']);
          $tare=fa_nn($row['tare']);
          $poidsnet=fa_nn($row['poidsnet']);
          $devise_taux=fa_nn($row['devise_taux']);
          $pr=fa_nn($row['pr']);
          $blocnotebrut=fa_nt($row['blocnotebrut']);
          $blocnoteriche=fa_nt($row['blocnoteriche']);
          $devise=fa_nn($row['devise']);
          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
          $pc_cleunik=fa_nn($row['pc_cleunik']);
          $remise_natu=fa_nn($row['remise_natu']);
          $coef_facture=fa_nn($row['coef_facture']);
          $taxes_cleunik=fa_nn($row['taxes_cleunik']);
          $vl_e_types_gestion=fa_nn($row['types_gestion']);
          $vl_e_gestion_dep_emp=fa_nn($row['gestion_dep_emp']);
          $longueur=fa_nn($row['longueur']);
          $largeur=fa_nn($row['largeur']);
          $epaisseur=fa_nn($row['epaisseur']);
          $unite_longueur=fa_nn($row['unite_longueur']);
          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
          $vl_commercial_ligne_cleunik_cible=_graal_requete_max("commercial_ligne_cleunik","$table_lignes_cible");
          $req_lignes_cible = "INSERT INTO $table_lignes_cible (`commercial_ligne_cleunik`, `commercial_cleunik`, `ligne_cleunik`, `art_cleunik`, `code_interne`, `indice_interne`,";
          $req_lignes_cible.=" `mnemotechnique_interne`, `description_interne`, `code_acteur`, `mnemotechnique_acteur`, `description_acteur`, `typeligne`, `pu`, `pu_portee`, `pu_type`,";
          $req_lignes_cible.=" `nbdec_pu`, `tarif_cleunik`, `remise_taux`, `remise_type`, `remise_genr`, `poidsbrut`, `tare`, `poidsnet`, `devise_taux`, `pr`, `blocnotebrut`,";
          $req_lignes_cible.=" `blocnoteriche`, `devise`, `catcompta_cleunik`, `pc_cleunik`, `remise_natu`, `coef_facture`, `taxes_cleunik`, `longueur`, `largeur`, `epaisseur`,";
          $req_lignes_cible.=" `unite_longueur`, `tpf_cleunik`,tpf_cleunik_01)";
          $req_lignes_cible.=" VALUES ($vl_commercial_ligne_cleunik_cible,$vl_commercial_cleunik_cible,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,";
          $req_lignes_cible.=" $description_interne,$code_acteur,$mnemotechnique_acteur,$description_acteur,$typeligne,$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,";
          $req_lignes_cible.=" $remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,$blocnotebrut,$blocnoteriche,$devise,$catcompta_cleunik,$pc_cleunik,$remise_natu,";
          $req_lignes_cible.=" $coef_facture,$taxes_cleunik,$longueur,$largeur,$epaisseur,$unite_longueur,$tpf_cleunik,$tpf_cleunik_01);";
          //$_SESSION['req_02']=$req_lignes_cible;
          $vf_c_echo=_graal_exec_requete($req_lignes_cible);
          if($vf_c_echo!='ok') {
            $vf_c_retour=$vf_c_echo;
          } else {
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,cdefou_ligne_qte_cleunik,mvt_cleunik from $table_ligqte_sourc where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                $result_qte = _graal_requete_bd($req_ligqte_sourc);
            	while ($row = mysql_fetch_assoc($result_qte)){
					$commercial_ligne_cleunik_recfou=fa_nn($row['commercial_ligne_cleunik']);
            	  $cdefou_ligne_qte_cleunik=fa_nn($row['cdefou_ligne_qte_cleunik']);
                  $recfou_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
	              $ligne_cleunik_qte=fa_nn($row['ligne_cleunik']);
	              $qte=fa_nn($row['qte']);
	              $qte_unite=fa_nn($row['qte_unite']);
	              $qte_nbdec=fa_nn($row['qte_nbdec']);
	              $dateheure_demande=fa_nt($row['dateheure_demande']);
	              switch ($param_generaux_graal_176){
					case 1://	date du document = date du jour de création (sauf si date forcée)
			            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
						break;
					case 2:
			            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
	              		break;
	              }
	              $statut=fa_nn($row['statut']);
	              $statut=-39;
	              $unite_condi=fa_nn($row['unite_condi']);
	              $qte_condi=fa_nn($row['qte_condi']);
	              $nb_stock_in_condi=fa_nn($row['nb_stock_in_condi']);
	              $choix_depot=fa_nn($row['choix_depot']);
	              $choix_empla=fa_nn($row['choix_empla']);
	              $qte_deja=fa_nn($row['qte']);
	              $vl_ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$table_ligqte_cible");
            	  $vl_mousto_mvt_cleunik=fa_nn($row['mvt_cleunik']);
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdefou_ligne_qte_cleunik`,`recfou_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik_qte,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdefou_ligne_qte_cleunik,$recfou_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla,0);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 ,qte_deja=qte where commercial_ligne_cleunik=$commercial_ligne_cleunik_recfou;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
            	  $vf_c_echo=_graal_exec_requete($req_ligqte_cible);
            	}
          }
        }
        
        
	    
      	} else {
      		
      	}
      	if ($vf_c_retour=="") {
	      	$req="UPDATE _actions set statut=-40 where action_cleunik in($vl_action_cleunik);";
          	$vf_c_echo=_graal_exec_requete($req);
	      	$vf_c_retour=$vl_action_cleunik_cible."|";
      		_graal_requete_bd("COMMIT;");
			fa_calcule_echeance_kilometres("facfou");
	    } else {
	      //$vf_c_retour=-1;
	      _graal_requete_bd("ROLLBACK;");
	    }
    	echo $vf_c_retour;
	    
	    
	    
	    
	    
		break;
	case $vf_c_action=="retfou_multi->avofou":   //  Transformation de plusieurs réceptions fournisseurs en une seule facture
		$vl_t_listecles=fa_recup_param('vl_t_listecles','');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$vl_action_cleunik="";
		$vl_e_i=-1;
		foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_action_cleunik.=$vl_t_listecles[$vl_e_i].',';
          $vl_action_cleunik_sourc=$vl_t_listecles[$vl_e_i];
        }
		if ($vl_action_cleunik!="") {
          $vl_action_cleunik=substr($vl_action_cleunik, 0, -1);
        }  else {
          $vl_action_cleunik="-99999999";
        }
		$req_action="select commercial_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
		//die($req_action);
    	$result = _graal_requete_bd($req_action);
    	$vl_commercial_cleunik_sourc="";
    	while ($row = mysql_fetch_assoc($result)){
      		$vl_commercial_cleunik_sourc.=$row['commercial_cleunik'].",";
      		$vl_commercial_cleunik_sourc_prems=$row['commercial_cleunik'];
    	}
    	_graal_libere_requete_bd($result);
		if ($vl_commercial_cleunik_sourc!="") {
          $vl_commercial_cleunik_sourc=substr($vl_commercial_cleunik_sourc, 0, -1);
        }  else {
          $vl_commercial_cleunik_sourc="-99999999";
        }
        /*
         * vérification qu'il n'y a qu'un seul acteur
         */
        $nb_acteurs_differents=0;
        $req_action="select count(distinct act_cleunik) as nb_acteurs_differents from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$nb_acteurs_differents=$row['nb_acteurs_differents'];
        _graal_libere_requete_bd($result);
        if ($nb_acteurs_differents!=1){
        	die("-1|");
        }
        /*
         * somme des ports des bons de réception
         */
        $total_port=0;
        $req_action="select sum(port_taux) as total_port from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_port=fa_nt($row['total_port']);
        _graal_libere_requete_bd($result);
        /*
         * somme des frais des bons de réception
         */
        $total_frais=0;
        $req_action="select sum(frais_taux) as total_frais from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_frais=fa_nt($row['total_frais']);
        _graal_libere_requete_bd($result);
        /*
         * somme des acomptes des bons de réception
         */
        $total_acompte=0;
        $req_action="select sum(acompte_taux) as total_acompte from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_acompte=fa_nt($row['total_acompte']);
        _graal_libere_requete_bd($result);
	    //  Début de la transaction
	    $deb_trans=_graal_requete_bd("START TRANSACTION;");
	   
	    $vl_action_cleunik_cible=_graal_requete_max("action_cleunik","_actions");
	    $vl_commercial_cleunik_cible=_graal_requete_max("commercial_cleunik","$table_entete_cible");
	    $vl_uuid=_graal_requete_uuid();
	    $code=_graal_numerote($indice_numerotation);
	    $vf_c_retour="";
		if ($vl_nouvelle_date_fac!="19610123"){
			$col_dateheuredebut="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
	    	$col_dateheurefin="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
		}
	    $req_action="INSERT INTO _actions select $vl_action_cleunik_cible, $vf_e_choix_cleunik_doc, $col_dateheuredebut, $col_dateheurefin, now(), now(), blocnote_brut, blocnote_riche, position, description, '$vl_uuid', action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, '$code', reference,gestion_duree from _actions where action_cleunik=$vl_action_cleunik_sourc;";
	    $vf_c_echo=_graal_exec_requete($req_action);
	    $req_graal_sourc="SELECT `act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal` FROM _graal where action_cleunik in($vl_action_cleunik);";
      $result = _graal_requete_bd($req_graal_sourc);
      while ($row = mysql_fetch_assoc($result)){
        $act_cleunik=fa_nn($row['act_cleunik']);
        $int_cleunik=fa_nn($row['int_cleunik']);
        $blocnotebrut=fa_nt($row['blocnotebrut']);
        $blocnotertf=fa_nt($row['blocnotertf']);
        $portee=fa_nn($row['portee']);
        $principal=fa_nn($row['principal']);
        $choix_cleunik=fa_nn($row['choix_cleunik']);
        if ($choix_cleunik==-110414) {$choix_cleunik=-110415;} //  De fournisseur emetteur de la réception on passe à fournisseur emetteur de la facture
        $req_graal_cible = "INSERT INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal`) VALUES ($act_cleunik,$int_cleunik,$vl_action_cleunik_cible,$choix_cleunik,$blocnotebrut,$blocnotertf,$portee,$principal);";
        $vf_c_echo=_graal_exec_requete($req_graal_cible);
        //if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}	On ne teste pas l'erreur qui peut-être normale dans ce cas
      }
      _graal_libere_requete_bd($result);
   		$req_choix="INSERT into _actions_choix_fixes select $vl_action_cleunik_cible, `choix_cleunik`, `critere_cleunik`, `uti_cleunik` from _actions_choix_fixes where action_cleunik=$vl_action_cleunik_sourc;";
      $vf_c_echo=_graal_exec_requete($req_choix);
      if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
      
		$req_action="select action_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
		//die($req_action);
    	$result = _graal_requete_bd($req_action);
    	while ($row = mysql_fetch_assoc($result)){
    		$req_graal_act=" INSERT INTO _graal_act (action_cleunik_gauche,action_cleunik_droite,choix_cleunik_droite,choix_cleunik_gauche) values (".$row['action_cleunik'].", $vl_action_cleunik_cible, $choix_cleunik_droite,$choix_cleunik_gauche)";
    		$vf_c_echo=_graal_exec_requete($req_graal_act);
    	}
      	_graal_libere_requete_bd($result);
	  	if ($vl_nouvelle_date_fac!="19610123"){
			$col_date_fact="'$vl_nouvelle_date_fac'";
		}  
	    $req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, null, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, null, rendezvous, modliv, typpor, dateheureexpedition, dateheurelivraison, frais_type, frais_taux, port_type, port_taux, acompte_type, acompte_taux,$type_avoir,now(),1,modliv_bis,assujetti_tpf from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
		$vf_c_echo=_graal_exec_requete($req_entete);
      	if($vf_c_echo=='ok') {

      	$req_adresse_sourc="SELECT `adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, `dateheuremodif`, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`, `adr_type` FROM $table_adress_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
        $result = _graal_requete_bd($req_adresse_sourc);
        while ($row = mysql_fetch_assoc($result)){
          $vl_adr_cleunik_cible=_graal_requete_max("adr_cleunik","$table_adress_cible");
          $adr_cod=fa_nt($row['adr_cod']);
          $adr_nom=fa_nt($row['adr_nom']);
          $adr_complementnom=fa_nt($row['adr_complementnom']);
          $adr_ligne1=fa_nt($row['adr_ligne1']);
          $adr_ligne2=fa_nt($row['adr_ligne2']);
          $adr_ligne3=fa_nt($row['adr_ligne3']);
          $adr_cp=fa_nt($row['adr_cp']);
          $adr_ville=fa_nt($row['adr_ville']);
          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
          $adr_latitude=fa_nn($row['adr_latitude']);
          $adr_longitude=fa_nn($row['adr_longitude']);
          $adr_typecoordonnees=fa_nn($row['adr_typecoordonnees']);
		  $adr_type=fa_nn($row['adr_type']);
          $req_adresse_cible = "INSERT INTO $table_adress_cible (`adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, dateheuremodif, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`,`adr_type`) VALUES ($vl_adr_cleunik_cible, $adr_cod, $vl_commercial_cleunik_cible, $adr_nom, $adr_complementnom, $adr_ligne1, $adr_ligne2, $adr_ligne3, $adr_cp, $adr_ville, $vl_pays_cleunik, now(), $adr_latitude, $adr_longitude, $adr_typecoordonnees,$adr_type);";
          $vf_c_echo=_graal_exec_requete($req_adresse_cible);
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);
				

        $req_lignes_sourc="SELECT f1.commercial_ligne_cleunik, f1.commercial_cleunik,f1.ligne_cleunik,f1.art_cleunik,f1.code_interne,f1.indice_interne,f1.mnemotechnique_interne,f1.description_interne,f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f1.typeligne,f1.pu,f1.pu_portee,f1.pu_type,f1.nbdec_pu,f1.tarif_cleunik,f1.remise_taux,f1.remise_type,f1.remise_genr,f1.poidsbrut,f1.tare, f1.poidsnet,f1.devise_taux,f1.pr,f1.blocnotebrut,f1.blocnoteriche,f1.devise,f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu,f1.coef_facture,f1.taxes_cleunik,f2.types_gestion,f3.gestion as gestion_dep_emp,f1.longueur,f1.largeur,f1.epaisseur,f1.unite_longueur,f1.tpf_cleunik,f1.tpf_cleunik_01 from $table_lignes_sourc f1  left join _article f2 using(art_cleunik) left join _art_stock f3 using(art_cleunik) where commercial_cleunik in($vl_commercial_cleunik_sourc);";
        $result = _graal_requete_bd($req_lignes_sourc);
        $ligne_cleunik=0;
        while ($row = mysql_fetch_assoc($result)){
          $vl_commercial_ligne_cleunik_source=fa_nn($row['commercial_ligne_cleunik']);
          $ligne_cleunik++;
          $vf_e_ligne_cleunik=$ligne_cleunik;
          $art_cleunik=fa_nn($row['art_cleunik']);
          $code_interne=fa_nt($row['code_interne']);
          $indice_interne=fa_nt($row['indice_interne']);
          $mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
          $description_interne=fa_nt($row['description_interne']);
          $code_acteur=fa_nt($row['code_acteur']);
          $mnemotechnique_acteur=fa_nt($row['mnemotechnique_acteur']);
          $description_acteur=fa_nt($row['description_acteur']);
          $typeligne=fa_nt($row['typeligne']);
          $pu=fa_nn($row['pu']);
          $pu_portee=fa_nn($row['pu_portee']);
          $pu_type=fa_nn($row['pu_type']);
          $nbdec_pu=fa_nn($row['nbdec_pu']);
          $tarif_cleunik=fa_nn($row['tarif_cleunik']);
          $remise_taux=fa_nn($row['remise_taux']);
          $remise_type=fa_nn($row['remise_type']);
          $remise_genr=fa_nn($row['remise_genr']);
          $poidsbrut=fa_nn($row['poidsbrut']);
          $tare=fa_nn($row['tare']);
          $poidsnet=fa_nn($row['poidsnet']);
          $devise_taux=fa_nn($row['devise_taux']);
          $pr=fa_nn($row['pr']);
          $blocnotebrut=fa_nt($row['blocnotebrut']);
          $blocnoteriche=fa_nt($row['blocnoteriche']);
          $devise=fa_nn($row['devise']);
          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
          $pc_cleunik=fa_nn($row['pc_cleunik']);
          $remise_natu=fa_nn($row['remise_natu']);
          $coef_facture=fa_nn($row['coef_facture']);
          $taxes_cleunik=fa_nn($row['taxes_cleunik']);
          $vl_e_types_gestion=fa_nn($row['types_gestion']);
          $vl_e_gestion_dep_emp=fa_nn($row['gestion_dep_emp']);
          $longueur=fa_nn($row['longueur']);
          $largeur=fa_nn($row['largeur']);
          $epaisseur=fa_nn($row['epaisseur']);
          $unite_longueur=fa_nn($row['unite_longueur']);
          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
          $vl_commercial_ligne_cleunik_cible=_graal_requete_max("commercial_ligne_cleunik","$table_lignes_cible");
          $req_lignes_cible = "INSERT INTO $table_lignes_cible (`commercial_ligne_cleunik`, `commercial_cleunik`, `ligne_cleunik`, `art_cleunik`, `code_interne`, `indice_interne`,";
          $req_lignes_cible.=" `mnemotechnique_interne`, `description_interne`, `code_acteur`, `mnemotechnique_acteur`, `description_acteur`, `typeligne`, `pu`, `pu_portee`, `pu_type`,";
          $req_lignes_cible.=" `nbdec_pu`, `tarif_cleunik`, `remise_taux`, `remise_type`, `remise_genr`, `poidsbrut`, `tare`, `poidsnet`, `devise_taux`, `pr`, `blocnotebrut`,";
          $req_lignes_cible.=" `blocnoteriche`, `devise`, `catcompta_cleunik`, `pc_cleunik`, `remise_natu`, `coef_facture`, `taxes_cleunik`, `longueur`, `largeur`, `epaisseur`,";
          $req_lignes_cible.=" `unite_longueur`, `tpf_cleunik`,tpf_cleunik_01)";
          $req_lignes_cible.=" VALUES ($vl_commercial_ligne_cleunik_cible,$vl_commercial_cleunik_cible,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,";
          $req_lignes_cible.=" $description_interne,$code_acteur,$mnemotechnique_acteur,$description_acteur,$typeligne,$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,";
          $req_lignes_cible.=" $remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,$blocnotebrut,$blocnoteriche,$devise,$catcompta_cleunik,$pc_cleunik,$remise_natu,";
          $req_lignes_cible.=" $coef_facture,$taxes_cleunik,$longueur,$largeur,$epaisseur,$unite_longueur,$tpf_cleunik,tpf_cleunik_01);";
          //$_SESSION['req_02']=$req_lignes_cible;
          $vf_c_echo=_graal_exec_requete($req_lignes_cible);
          if($vf_c_echo!='ok') {
            $vf_c_retour.=$vf_c_echo;
          } else {
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,cdefou_ligne_qte_cleunik,mvt_cleunik from $table_ligqte_sourc where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                $result_qte = _graal_requete_bd($req_ligqte_sourc);
            	while ($row = mysql_fetch_assoc($result_qte)){
					$commercial_ligne_cleunik_retfou=fa_nn($row['commercial_ligne_cleunik']);
            	  $cdefou_ligne_qte_cleunik=fa_nn($row['cdefou_ligne_qte_cleunik']);
                  $retfou_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
	              $ligne_cleunik_qte=fa_nn($row['ligne_cleunik']);
	              $qte=fa_nn($row['qte']);
	              $qte_unite=fa_nn($row['qte_unite']);
	              $qte_nbdec=fa_nn($row['qte_nbdec']);
	              $dateheure_demande=fa_nt($row['dateheure_demande']);
	              switch ($param_generaux_graal_176){
					case 1://	date du document = date du jour de création (sauf si date forcée)
			            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
						break;
					case 2:
			            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
	              		break;
	              }
	              $statut=fa_nn($row['statut']);
	              $statut=-39;
	              $unite_condi=fa_nn($row['unite_condi']);
	              $qte_condi=fa_nn($row['qte_condi']);
	              $nb_stock_in_condi=fa_nn($row['nb_stock_in_condi']);
	              $choix_depot=fa_nn($row['choix_depot']);
	              $choix_empla=fa_nn($row['choix_empla']);
	              $qte_deja=fa_nn($row['qte']);
	              $vl_ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$table_ligqte_cible");
            	  $vl_mousto_mvt_cleunik=fa_nn($row['mvt_cleunik']);
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdefou_ligne_qte_cleunik`,`recfou_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik_qte,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdefou_ligne_qte_cleunik,$retfou_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla,0);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 ,qte_deja=qte where commercial_ligne_cleunik=$commercial_ligne_cleunik_retfou;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
            	  $vf_c_echo=_graal_exec_requete($req_ligqte_cible);
            	}
          }
        }
        
        
	    
      	} else {
      		
      	}
      	if ($vf_c_retour=="") {
	      	$req="UPDATE _actions set statut=-40 where action_cleunik in($vl_action_cleunik);";
          	$vf_c_echo=_graal_exec_requete($req);
	      	$vf_c_retour=$vl_action_cleunik_cible."|";
      		_graal_requete_bd("COMMIT;");
			fa_calcule_echeance_kilometres("avofou");
	    } else {
	      //$vf_c_retour=-1;
	      _graal_requete_bd("ROLLBACK;");
	    }
    	echo $vf_c_retour;
		break;
	case $vf_c_action=="livcli_multi->faccli":  //  Transformation de plusieurs livraisons client en une seule facture
		$vl_t_listecles=fa_recup_param('vl_t_listecles','');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$vl_action_cleunik="";
		$vl_e_i=-1;
		foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_action_cleunik.=$vl_t_listecles[$vl_e_i].',';
          $vl_action_cleunik_sourc=$vl_t_listecles[$vl_e_i];
        }
		if ($vl_action_cleunik!="") {
          $vl_action_cleunik=substr($vl_action_cleunik, 0, -1);
        }  else {
          $vl_action_cleunik="-99999999";
        }
		$req_action="select commercial_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
		//die($req_action);
    	$result = _graal_requete_bd($req_action);
    	$vl_commercial_cleunik_sourc="";
    	while ($row = mysql_fetch_assoc($result)){
      		$vl_commercial_cleunik_sourc.=$row['commercial_cleunik'].",";
      		$vl_commercial_cleunik_sourc_prems=$row['commercial_cleunik'];
    	}
    	_graal_libere_requete_bd($result);
		if ($vl_commercial_cleunik_sourc!="") {
          $vl_commercial_cleunik_sourc=substr($vl_commercial_cleunik_sourc, 0, -1);
        }  else {
          $vl_commercial_cleunik_sourc="-99999999";
        }
        /*
         * vérification qu'il n'y a qu'un seul acteur
         */
        $nb_acteurs_differents=0;
        $req_action="select count(distinct act_cleunik) as nb_acteurs_differents from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$nb_acteurs_differents=$row['nb_acteurs_differents'];
        _graal_libere_requete_bd($result);
        if ($nb_acteurs_differents!=1){
        	die("-1|");
        }
        /*
         * somme des ports des bl
         */
        $total_port=0;
        $req_action="select sum(port_taux) as total_port from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_port=fa_nt($row['total_port']);
        _graal_libere_requete_bd($result);
        /*
         * somme des frais des bl
         */
        $total_frais=0;
        $req_action="select sum(frais_taux) as total_frais from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_frais=fa_nt($row['total_frais']);
        _graal_libere_requete_bd($result);
        /*
         * somme des acomptes des bl
         */
        $total_acompte=0;
        $req_action="select sum(acompte_taux) as total_acompte from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
    	$result = _graal_requete_bd($req_action);
    	$row = mysql_fetch_assoc($result);
    	$total_acompte=fa_nt($row['total_acompte']);
        _graal_libere_requete_bd($result);
	    //  Début de la transaction
	    $deb_trans=_graal_requete_bd("START TRANSACTION;");
	   
	    
	    $vl_action_cleunik_cible=_graal_requete_max("action_cleunik","_actions");
	    $vl_commercial_cleunik_cible=_graal_requete_max("commercial_cleunik","$table_entete_cible");
	    $vl_uuid=_graal_requete_uuid();
	    $code=_graal_numerote($indice_numerotation);
	    $vf_c_retour="";
		if ($vl_nouvelle_date_fac!="19610123"){
			$col_dateheuredebut="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
	    	$col_dateheurefin="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
		}
	    $req_action="INSERT INTO _actions select $vl_action_cleunik_cible, $vf_e_choix_cleunik_doc, $col_dateheuredebut, $col_dateheurefin, now(), now(), blocnote_brut, blocnote_riche, position, description, '$vl_uuid', action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, '$code', reference,gestion_duree from _actions where action_cleunik=$vl_action_cleunik_sourc;";
	    $vf_c_echo=_graal_exec_requete($req_action);
	    $req_graal_sourc="SELECT `act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal` FROM _graal where action_cleunik in($vl_action_cleunik);";
      $result = _graal_requete_bd($req_graal_sourc);
      while ($row = mysql_fetch_assoc($result)){
        $act_cleunik=fa_nn($row['act_cleunik']);
        $int_cleunik=fa_nn($row['int_cleunik']);
        $blocnotebrut=fa_nt($row['blocnotebrut']);
        $blocnotertf=fa_nt($row['blocnotertf']);
        $portee=fa_nn($row['portee']);
        $principal=fa_nn($row['principal']);
        $choix_cleunik=fa_nn($row['choix_cleunik']);
        if ($choix_cleunik==-110410) {$choix_cleunik=-110411;} //  De client destinataire de la livraison on passe à client destinataire de la facture
        $req_graal_cible = "INSERT INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal`) VALUES ($act_cleunik,$int_cleunik,$vl_action_cleunik_cible,$choix_cleunik,$blocnotebrut,$blocnotertf,$portee,$principal);";
        $vf_c_echo=_graal_exec_requete($req_graal_cible);
        //if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}	On ne teste pas l'erreur qui peut-être normale dans ce cas
      }
      _graal_libere_requete_bd($result);
   		$req_choix="INSERT into _actions_choix_fixes select $vl_action_cleunik_cible, `choix_cleunik`, `critere_cleunik`, `uti_cleunik` from _actions_choix_fixes where action_cleunik=$vl_action_cleunik_sourc;";
      $vf_c_echo=_graal_exec_requete($req_choix);
      if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
      
		$req_action="select action_cleunik from $table_entete_sourc where action_cleunik in($vl_action_cleunik);";
		//die($req_action);
    	$result = _graal_requete_bd($req_action);
    	while ($row = mysql_fetch_assoc($result)){
    		$req_graal_act=" INSERT INTO _graal_act (action_cleunik_gauche,action_cleunik_droite,choix_cleunik_droite,choix_cleunik_gauche) values (".$row['action_cleunik'].", $vl_action_cleunik_cible, $choix_cleunik_droite,$choix_cleunik_gauche)";
    		$vf_c_echo=_graal_exec_requete($req_graal_act);
    	}
      	_graal_libere_requete_bd($result);
	  	if ($vl_nouvelle_date_fac!="19610123"){
			$col_date_fact="'$vl_nouvelle_date_fac'";
		}  
		$req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, null, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, null, rendezvous, modliv, typpor, $col_dateheureexpedition, $col_dateheurelivraison, frais_type, $total_frais, port_type, $total_port, acompte_type, $total_acompte,$col_date_fact,$fact_type,$fact_genr,$compta_etat,modliv_bis,assujetti_tpf from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
	    $vf_c_echo=_graal_exec_requete($req_entete);
      	if($vf_c_echo=='ok') {

      	$req_adresse_sourc="SELECT `adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, `dateheuremodif`, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`, `adr_type` FROM $table_adress_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc_prems;";
        $result = _graal_requete_bd($req_adresse_sourc);
        while ($row = mysql_fetch_assoc($result)){
          $vl_adr_cleunik_cible=_graal_requete_max("adr_cleunik","$table_adress_cible");
          $adr_cod=fa_nt($row['adr_cod']);
          $adr_nom=fa_nt($row['adr_nom']);
          $adr_complementnom=fa_nt($row['adr_complementnom']);
          $adr_ligne1=fa_nt($row['adr_ligne1']);
          $adr_ligne2=fa_nt($row['adr_ligne2']);
          $adr_ligne3=fa_nt($row['adr_ligne3']);
          $adr_cp=fa_nt($row['adr_cp']);
          $adr_ville=fa_nt($row['adr_ville']);
          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
          $adr_latitude=fa_nn($row['adr_latitude']);
          $adr_longitude=fa_nn($row['adr_longitude']);
          $adr_typecoordonnees=fa_nn($row['adr_typecoordonnees']);
		  $adr_type=fa_nn($row['adr_type']);
          $req_adresse_cible = "INSERT INTO $table_adress_cible (`adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, dateheuremodif, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`,`adr_type`) VALUES ($vl_adr_cleunik_cible, $adr_cod, $vl_commercial_cleunik_cible, $adr_nom, $adr_complementnom, $adr_ligne1, $adr_ligne2, $adr_ligne3, $adr_cp, $adr_ville, $vl_pays_cleunik, now(), $adr_latitude, $adr_longitude, $adr_typecoordonnees,$adr_type);";
          $vf_c_echo=_graal_exec_requete($req_adresse_cible);
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);
				
        $req_consig_source="SELECT `action_consi_cleunik`, `commercial_cleunik`, `act_cleunik`, `art_cleunik`, `qte`, `qte_nbdec`,`qte_colis` from $table_consig_sourc where commercial_cleunik in($vl_commercial_cleunik_sourc);";
        $result = _graal_requete_bd($req_consig_source);
        while ($row = mysql_fetch_assoc($result)){
          $act_cleunik=fa_nn($row['act_cleunik']);
          $art_cleunik=fa_nn($row['art_cleunik']);
          $qte=fa_nn($row['qte']);
          $qte_nbdec=fa_nn($row['qte_nbdec']);
		  $qte_colis=fa_nn($row['qte_colis']);
          $vl_action_consi_cleunik_cible=_graal_requete_max("action_consi_cleunik","$table_consig_cible");
          $req_consig_cible = "INSERT INTO $table_consig_cible (`action_consi_cleunik`, `commercial_cleunik`, `act_cleunik`, `art_cleunik`, `qte`, `qte_nbdec`,`qte_colis`) VALUES ($vl_action_consi_cleunik_cible,$vl_commercial_cleunik_cible,$act_cleunik,$art_cleunik,$qte,$qte_nbdec,$qte_colis);";
          $vf_c_echo=_graal_exec_requete($req_consig_cible);
					//$_SESSION['req_02']=$req_consig_cible;
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);
        $req_transp_source="SELECT `action_trans_cleunik`, `commercial_cleunik`, `action_trans_cleunik_reference`, `act_cleunik_trans`, `poids_net`, `poids_bru`, `volum_net`, `volum_bru`, `surfa_net`, `surfa_bru`, `nombre_colis` from $table_transp_sourc where commercial_cleunik in($vl_commercial_cleunik_sourc);";
        $result = _graal_requete_bd($req_transp_source);
        while ($row = mysql_fetch_assoc($result)){
          $action_trans_cleunik_reference=fa_nn($row['action_trans_cleunik_reference']);
          $act_cleunik_trans=fa_nn($row['act_cleunik_trans']);
          $poids_net=fa_nn($row['poids_net']);
          $poids_bru=fa_nn($row['poids_bru']);
          $volum_net=fa_nn($row['volum_net']);
          $volum_bru=fa_nn($row['volum_bru']);
          $surfa_net=fa_nn($row['surfa_net']);
          $surfa_bru=fa_nn($row['surfa_bru']);
          $nombre_colis=fa_nn($row['nombre_colis']);
          $vl_action_trans_cleunik_cible=_graal_requete_max("action_trans_cleunik","$table_transp_cible");
          $req_trans_cible = "INSERT INTO $table_transp_cible (`action_trans_cleunik`, `commercial_cleunik`, `action_trans_cleunik_reference`, `act_cleunik_trans`, `poids_net`, `poids_bru`, `volum_net`, `volum_bru`, `surfa_net`, `surfa_bru`, `nombre_colis`) VALUES ($vl_action_trans_cleunik_cible,$vl_commercial_cleunik_cible,$action_trans_cleunik_reference,$act_cleunik_trans,$poids_net,$poids_bru,$volum_net,$volum_bru,$surfa_net,$surfa_bru,$nombre_colis);";
          $vf_c_echo=_graal_exec_requete($req_trans_cible);
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);
        $req_repres_source="SELECT `action_rep_cleunik`, `commercial_cleunik`, `action_rep_cleunik_reference`, `act_cleunik_rep`, `commission_typ`, `commission_taux`, `commission_fixe`, `commission_regle` from $table_repres_sourc where commercial_cleunik in($vl_commercial_cleunik_sourc);";
        $result = _graal_requete_bd($req_repres_source);
        while ($row = mysql_fetch_assoc($result)){
          $action_rep_cleunik_reference=fa_nn($row['action_rep_cleunik_reference']);
          $act_cleunik_rep=fa_nn($row['act_cleunik_rep']);
          $commission_typ=fa_nn($row['commission_typ']);
          $commission_taux=fa_nn($row['commission_taux']);
          $commission_fixe=fa_nn($row['commission_fixe']);
          $commission_regle=fa_nn($row['commission_regle']);
          $vl_action_rep_cleunik_cible=_graal_requete_max("action_rep_cleunik","$table_repres_cible");
          $req_repres_cible = "INSERT INTO $table_repres_cible (`action_rep_cleunik`, `commercial_cleunik`, `action_rep_cleunik_reference`, `act_cleunik_rep`, `commission_typ`, `commission_taux`, `commission_fixe`, `commission_regle`) VALUES ($vl_action_rep_cleunik_cible,$vl_commercial_cleunik_cible,$action_rep_cleunik_reference,$act_cleunik_rep,$commission_typ,$commission_taux,$commission_fixe,$commission_regle);";
          $vf_c_echo=_graal_exec_requete($req_repres_cible);
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);

        $req_lignes_sourc="SELECT f1.commercial_ligne_cleunik, f1.commercial_cleunik,f1.ligne_cleunik,f1.art_cleunik,f1.code_interne,f1.indice_interne,f1.mnemotechnique_interne,";
        $req_lignes_sourc.=" f1.description_interne,f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f1.typeligne,f1.pu,f1.pu_portee,f1.pu_type,f1.nbdec_pu,";
        $req_lignes_sourc.=" f1.tarif_cleunik,f1.remise_taux,f1.remise_type,f1.remise_genr,f1.poidsbrut,f1.tare, f1.poidsnet,f1.devise_taux,f1.pr,f1.blocnotebrut,f1.blocnoteriche,";
        $req_lignes_sourc.=" f1.devise,f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu,f1.coef_facture,f1.taxes_cleunik,f2.types_gestion,f3.gestion as gestion_dep_emp,f1.longueur,";
        $req_lignes_sourc.=" f1.largeur,f1.epaisseur,f1.unite_longueur,f1.tpf_cleunik,f1.tpf_cleunik_01 from $table_lignes_sourc f1  left join _article f2 using(art_cleunik) left join _art_stock f3 ";
        $req_lignes_sourc.=" using(art_cleunik) where commercial_cleunik in($vl_commercial_cleunik_sourc);";
        $result = _graal_requete_bd($req_lignes_sourc);
        $ligne_cleunik=0;
        while ($row = mysql_fetch_assoc($result)){
          $vl_commercial_ligne_cleunik_source=fa_nn($row['commercial_ligne_cleunik']);
          $ligne_cleunik++;
          $vf_e_ligne_cleunik=$ligne_cleunik;
          $art_cleunik=fa_nn($row['art_cleunik']);
          $code_interne=fa_nt($row['code_interne']);
          $indice_interne=fa_nt($row['indice_interne']);
          $mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
          $description_interne=fa_nt($row['description_interne']);
          $code_acteur=fa_nt($row['code_acteur']);
          $mnemotechnique_acteur=fa_nt($row['mnemotechnique_acteur']);
          $description_acteur=fa_nt($row['description_acteur']);
          $typeligne=fa_nt($row['typeligne']);
          $pu=fa_nn($row['pu']);
          $pu_portee=fa_nn($row['pu_portee']);
          $pu_type=fa_nn($row['pu_type']);
          $nbdec_pu=fa_nn($row['nbdec_pu']);
          $tarif_cleunik=fa_nn($row['tarif_cleunik']);
          $remise_taux=fa_nn($row['remise_taux']);
          $remise_type=fa_nn($row['remise_type']);
          $remise_genr=fa_nn($row['remise_genr']);
          $poidsbrut=fa_nn($row['poidsbrut']);
          $tare=fa_nn($row['tare']);
          $poidsnet=fa_nn($row['poidsnet']);
          $devise_taux=fa_nn($row['devise_taux']);
          $pr=fa_nn($row['pr']);
          $blocnotebrut=fa_nt($row['blocnotebrut']);
          $blocnoteriche=fa_nt($row['blocnoteriche']);
          $devise=fa_nn($row['devise']);
          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
          $pc_cleunik=fa_nn($row['pc_cleunik']);
          $remise_natu=fa_nn($row['remise_natu']);
          $coef_facture=fa_nn($row['coef_facture']);
          $taxes_cleunik=fa_nn($row['taxes_cleunik']);
          $vl_e_types_gestion=fa_nn($row['types_gestion']);
          $vl_e_gestion_dep_emp=fa_nn($row['gestion_dep_emp']);
          $longueur=fa_nn($row['longueur']);
          $largeur=fa_nn($row['largeur']);
          $epaisseur=fa_nn($row['epaisseur']);
          $unite_longueur=fa_nn($row['unite_longueur']);
          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
          $vl_commercial_ligne_cleunik_cible=_graal_requete_max("commercial_ligne_cleunik","$table_lignes_cible");
          $req_lignes_cible = "INSERT INTO $table_lignes_cible (`commercial_ligne_cleunik`, `commercial_cleunik`, `ligne_cleunik`, `art_cleunik`, `code_interne`, `indice_interne`,";
          $req_lignes_cible.=" `mnemotechnique_interne`, `description_interne`, `code_acteur`, `mnemotechnique_acteur`, `description_acteur`, `typeligne`, `pu`, `pu_portee`, `pu_type`,";
          $req_lignes_cible.=" `nbdec_pu`, `tarif_cleunik`, `remise_taux`, `remise_type`, `remise_genr`, `poidsbrut`, `tare`, `poidsnet`, `devise_taux`, `pr`, `blocnotebrut`,";
          $req_lignes_cible.=" `blocnoteriche`, `devise`, `catcompta_cleunik`, `pc_cleunik`, `remise_natu`, `coef_facture`, `taxes_cleunik`, `longueur`, `largeur`, `epaisseur`,";
          $req_lignes_cible.=" `unite_longueur`, `tpf_cleunik`,tpf_cleunik_01)";
          $req_lignes_cible.=" VALUES ($vl_commercial_ligne_cleunik_cible,$vl_commercial_cleunik_cible,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,";
          $req_lignes_cible.=" $description_interne,$code_acteur,$mnemotechnique_acteur,$description_acteur,$typeligne,$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,";
          $req_lignes_cible.=" $remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,$blocnotebrut,$blocnoteriche,$devise,$catcompta_cleunik,$pc_cleunik,$remise_natu,";
          $req_lignes_cible.=" $coef_facture,$taxes_cleunik,$longueur,$largeur,$epaisseur,$unite_longueur,$tpf_cleunik,$tpf_cleunik_01);";
          //$_SESSION['req_02']=$req_lignes_cible;
          $vf_c_echo=_graal_exec_requete($req_lignes_cible);
          if($vf_c_echo!='ok') {
            $vf_c_retour=$vf_c_echo;
          } else {
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`,";
                $req_ligqte_sourc.="  `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,cdecli_ligne_qte_cleunik,mvt_cleunik from $table_ligqte_sourc ";
                $req_ligqte_sourc.="  where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                $result_qte = _graal_requete_bd($req_ligqte_sourc);
            	while ($row = mysql_fetch_assoc($result_qte)){
					$commercial_ligne_cleunik_livcli=fa_nn($row['commercial_ligne_cleunik']);
            	  $cdecli_ligne_qte_cleunik=fa_nn($row['cdecli_ligne_qte_cleunik']);
                  $livcli_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
	              $ligne_cleunik_qte=fa_nn($row['ligne_cleunik']);
	              $qte=fa_nn($row['qte']);
	              $qte_unite=fa_nn($row['qte_unite']);
	              $qte_nbdec=fa_nn($row['qte_nbdec']);
	              $dateheure_demande=fa_nt($row['dateheure_demande']);
	              switch ($param_generaux_graal_176){
					case 1://	date du document = date du jour de création (sauf si date forcée)
			            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
						break;
					case 2:
			            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
	              		break;
	              }
	              $statut=fa_nn($row['statut']);
	              $unite_condi=fa_nn($row['unite_condi']);
	              $qte_condi=fa_nn($row['qte_condi']);
	              $nb_stock_in_condi=fa_nn($row['nb_stock_in_condi']);
	              $choix_depot=fa_nn($row['choix_depot']);
	              $choix_empla=fa_nn($row['choix_empla']);
	              $qte_deja=fa_nn($row['qte']);
	              $vl_ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$table_ligqte_cible");
            	  $vl_mousto_mvt_cleunik=fa_nn($row['mvt_cleunik']);
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`,";
                  $req_ligqte_cible.= " `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdecli_ligne_qte_cleunik`,";
                  $req_ligqte_cible.= " `livcli_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`)";
                  $req_ligqte_cible.= "  VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik_qte,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,";
                  $req_ligqte_cible.= " $dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdecli_ligne_qte_cleunik,$livcli_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,";
                  $req_ligqte_cible.= " $choix_depot,$choix_empla,0);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 ,qte_deja=qte where commercial_ligne_cleunik=$commercial_ligne_cleunik_livcli;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
            	  $vf_c_echo=_graal_exec_requete($req_ligqte_cible);
            	}
          }
        }
        
        
	    
      	} else {
      		
      	}
      	if ($vf_c_retour=="") {
	      	$req="UPDATE _actions set statut=-40 where action_cleunik in($vl_action_cleunik);";
          	$vf_c_echo=_graal_exec_requete($req);
	      	$vf_c_retour=$vl_action_cleunik_cible."|";
      		_graal_requete_bd("COMMIT;");
			fa_calcule_echeance_kilometres("faccli");
	    } else {
	      //$vf_c_retour=-1;
	      _graal_requete_bd("ROLLBACK;");
	    }
    	echo $vf_c_retour;
		break;
	
  case $vf_c_action=="cdecli->offcli":
  case $vf_c_action=="cdecli->cdecli":
  case $vf_c_action=="cdecli->livcli":
  case $vf_c_action=="cdecli->livcli_partielle":
  case $vf_c_action=="cdecli->faccli":
  case $vf_c_action=="offcli->offcli":
  case $vf_c_action=="offcli->cdecli":
  case $vf_c_action=="livcli->faccli":
	case $vf_c_action=="faccli->avocli":
	case $vf_c_action=="faccli->avofin":
	case $vf_c_action=="demfou->demfou":
	case $vf_c_action=="demfou->cdefou":
	case $vf_c_action=="cdefou->demfou":
	case $vf_c_action=="cdefou->cdefou":
  case $vf_c_action=="cdecli->profor":
  case $vf_c_action=="livcli->profor":
	case $vf_c_action=="profor->faccli":
	case $vf_c_action=="cdefou->recfou":
	case $vf_c_action=="cdefou->recfou_partielle":
	case $vf_c_action=="recfou->facfou":
	case $vf_c_action=="retcli->avofin":
	case $vf_c_action=="retfou->avofou":
    $vl_commercial_cleunik_sourc=intval(fa_recup_param('vl_commercial_cleunik','0'));
		if ($vl_commercial_cleunik_sourc==-2){
			$vl_action_cleunik_sourc=intval(fa_recup_param('vl_action_cleunik','0'));
			$req_action="select commercial_cleunik from $table_entete_sourc where action_cleunik=$vl_action_cleunik_sourc;";
    		$result = _graal_requete_bd($req_action);
    		while ($row = mysql_fetch_assoc($result)){
      			$vl_commercial_cleunik_sourc=fa_nt($row['commercial_cleunik']);
    		} 
		}
    //  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    $req_action="select action_cleunik from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
    $result = _graal_requete_bd($req_action);
    while ($row = mysql_fetch_assoc($result)){
      $vl_action_cleunik_sourc=fa_nt($row['action_cleunik']);
    }      
    _graal_libere_requete_bd($result);
    $vl_action_cleunik_cible=_graal_requete_max("action_cleunik","_actions");
    $vl_commercial_cleunik_cible=_graal_requete_max("commercial_cleunik","$table_entete_cible");
    $vl_uuid=_graal_requete_uuid();
    $code=_graal_numerote($indice_numerotation);
    $vf_c_retour="";
	if (($vf_c_action=="cdecli->livcli")&&($vl_nouvelle_date_exp!="19610123")){
		$col_dateheuredebut="'$vl_nouvelle_date_exp $vl_nouvelle_heur_exp'";
    	$col_dateheurefin="'$vl_nouvelle_date_exp $vl_nouvelle_heur_exp'";
	}
	if (($vf_c_action=="livcli->faccli")&&($vl_nouvelle_date_fac!="19610123")){
		$col_dateheuredebut="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
    	$col_dateheurefin="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
	}
	if (($vf_c_action=="recfou->facfou")&&($vl_nouvelle_date_fac!="19610123")){
		$col_dateheuredebut="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
    	$col_dateheurefin="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
	}
	if (($vf_c_action=="cdecli->faccli")&&($vl_nouvelle_date_fac!="19610123")){
		$col_dateheuredebut="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
    	$col_dateheurefin="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
	}
    $req_action="INSERT INTO _actions select $vl_action_cleunik_cible, $vf_e_choix_cleunik_doc, $col_dateheuredebut, $col_dateheurefin, now(), now(), blocnote_brut, blocnote_riche, position, description, '$vl_uuid', action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, '$code', reference,gestion_duree from _actions where action_cleunik=$vl_action_cleunik_sourc;";
	//die($req_action);
    $vf_c_echo=_graal_exec_requete($req_action);
	//echo $req_action;
    if($vf_c_echo=='ok') {
      $req_graal_sourc="SELECT `act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal` FROM _graal where action_cleunik=$vl_action_cleunik_sourc;";
      $result = _graal_requete_bd($req_graal_sourc);
      while ($row = mysql_fetch_assoc($result)){
        $act_cleunik=fa_nn($row['act_cleunik']);
        $int_cleunik=fa_nn($row['int_cleunik']);
        $blocnotebrut=fa_nt($row['blocnotebrut']);
        $blocnotertf=fa_nt($row['blocnotertf']);
        $portee=fa_nn($row['portee']);
        $principal=fa_nn($row['principal']);
        $choix_cleunik=fa_nn($row['choix_cleunik']);
        switch (TRUE) {
          case $vf_c_action=="cdecli->offcli":
            if ($choix_cleunik==-110409) {$choix_cleunik=-110408;} //  De client destinataire de la commande on passe à destinataire de l'offre
            break;
          case $vf_c_action=="offcli->cdecli":
            if ($choix_cleunik==-110408) {$choix_cleunik=-110409;} //  De client destinataire de l'offre on passe à client destinataire de la commande
            break;
          case $vf_c_action=="cdecli->livcli":
          case $vf_c_action=="cdecli->livcli_partielle":
            if ($choix_cleunik==-110409) {$choix_cleunik=-110410;} //  De client destinataire de la commande on passe à client destinataire de la livraison
            break;
          case $vf_c_action=="cdecli->faccli":
	        case $vf_c_action=="cdecli->profor":
            if ($choix_cleunik==-110409) {$choix_cleunik=-110411;} //  De client destinataire de la commande on passe à client destinataire de la facture
            break;
          case $vf_c_action=="livcli->faccli":
		      case $vf_c_action=="livcli->profor":
            if ($choix_cleunik==-110410) {$choix_cleunik=-110411;} //  De client destinataire de la livraison on passe à client destinataire de la facture
            break;
          case $vf_c_action=="faccli->avocli":
		  case $vf_c_action=="faccli->avofin":
            if ($choix_cleunik==-110411) {$choix_cleunik=-110430;} //  De client destinataire de la facture on passe à client destinataire de l'avoir
            break;
			case $vf_c_action=="demfou->cdefou":
				if ($choix_cleunik==-110412) {$choix_cleunik=-110413;} //  De destinataire de la demande on passe à fournisseur destinataire de la commande
				break;
			case $vf_c_action=="cdefou->demfou":
				if ($choix_cleunik==-110413) {$choix_cleunik=-110412;} //  De destinataire de la commande on passe à destinataire de la demande
				break;
			case $vf_c_action=="cdefou->recfou":
			case $vf_c_action=="cdefou->recfou_partielle":
				if ($choix_cleunik==-110413) {$choix_cleunik=-110414;} //  De destinataire de la commande on passe à fournisseur emetteur de la réception
				break;						
			case $vf_c_action=="profor->faccli":	//	de pro-forma à facture classique, rien ne change
				break;
			case $vf_c_action=="recfou->facfou":
            if ($choix_cleunik==-110414) {$choix_cleunik=-110415;} //  De fournisseur emetteur de la réception on passe à fournisseur emetteur de la facture
            break;
            case $vf_c_action=="retcli->avofin":
            	if ($choix_cleunik==-110438) {$choix_cleunik=-110430;} //  De client retour on passe à client destinataire de l'avoir
            	break;
            case $vf_c_action=="retfou->avofou":
            	if ($choix_cleunik==-110439) {$choix_cleunik=-110445;} //  De fournisseur retour on passe à fournisseur destinataire de l'avoir
            	break;
        }
        $req_graal_cible = "INSERT INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `blocnotebrut`, `blocnotertf`, `portee`, `principal`) VALUES ($act_cleunik,$int_cleunik,$vl_action_cleunik_cible,$choix_cleunik,$blocnotebrut,$blocnotertf,$portee,$principal);";
        $vf_c_echo=_graal_exec_requete($req_graal_cible);
        if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
      }
      _graal_libere_requete_bd($result);
      $req_choix="INSERT into _actions_choix_fixes select $vl_action_cleunik_cible, `choix_cleunik`, `critere_cleunik`, `uti_cleunik` from _actions_choix_fixes where action_cleunik=$vl_action_cleunik_sourc;";
      $vf_c_echo=_graal_exec_requete($req_choix);
      if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
      $req_graal_act=" INSERT INTO _graal_act (`action_cleunik_gauche`, `action_cleunik_droite`, `choix_cleunik_droite`, `choix_cleunik_gauche`) VALUES ($vl_action_cleunik_sourc,$vl_action_cleunik_cible,$choix_cleunik_droite,$choix_cleunik_gauche);";
      $vf_c_echo=_graal_exec_requete($req_graal_act);
			if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
			// on ne reprend pas les bloc note entêtes et pied en cas de transformation en facture ou en avoir
			//	depuis le 1° juillet 2010, on reprend, en cas de transformation en facture ou en avoir, le modèle idoine
      
    switch (TRUE) {
        case $vf_c_action=="recfou->facfou":
        	$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_153);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_154);
			break;		
		case $vf_c_action=="cdefou->recfou":
		case $vf_c_action=="cdefou->recfou_partielle":
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_151);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_152);
			break;
		case $vf_c_action=="demfou->cdefou":
		case $vf_c_action=="cdefou->cdefou":
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_040);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_041);
			break;
		case $vf_c_action=="demfou->demfou":
		case $vf_c_action=="cdefou->demfou":
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_036);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_037);
			break;
		case $vf_c_action=="cdecli->livcli":
        case $vf_c_action=="cdecli->livcli_partielle":
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_015);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_016);
			break;
        case $vf_c_action=="cdecli->cdecli":
        case $vf_c_action=="offcli->cdecli":
	        $blocnotebrut_entete=modele_pied_entete($param_generaux_graal_013);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_014);
			break;
		case $vf_c_action=="offcli->offcli":
		case $vf_c_action=="cdecli->offcli":
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_011);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_012);
			break;
		case $vf_c_action=="cdecli->faccli":
        case $vf_c_action=="livcli->faccli":
        case $vf_c_action=="cdecli->profor":
        case $vf_c_action=="livcli->profor":
		case $vf_c_action=="profor->faccli":
		case $vf_c_action=="faccli->avocli":
		case $vf_c_action=="faccli->avofin":
		case $vf_c_action=="retcli->avofin":
		case $vf_c_action=="retfou->avofou":
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_017);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_018);
          break;
      }
			
			
	switch (TRUE) {
        case $vf_c_action=="cdecli->offcli":
        case $vf_c_action=="cdecli->livcli":
        case $vf_c_action=="cdecli->livcli_partielle":
        case $vf_c_action=="offcli->offcli":
		case $vf_c_action=="demfou->demfou":
		case $vf_c_action=="demfou->cdefou":
		case $vf_c_action=="cdefou->demfou":
		case $vf_c_action=="cdefou->cdefou":
		case $vf_c_action=="cdefou->recfou":
		case $vf_c_action=="cdefou->recfou_partielle":
			if (($vf_c_action=="cdecli->livcli")&&($vl_nouvelle_date_liv!="19610123")){
				$col_dateheurelivraison="'$vl_nouvelle_date_liv $vl_nouvelle_heur_liv'";
			}
			if (($vf_c_action=="cdecli->livcli")&&($vl_nouvelle_date_exp!="19610123")){
				$col_dateheureexpedition="'$vl_nouvelle_date_exp $vl_nouvelle_heur_exp'";
			}
      		$req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, blocnotebrut_entete, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, blocnotebrut_pied, rendezvous, modliv, typpor, $col_dateheureexpedition, $col_dateheurelivraison, frais_type, frais_taux, port_type, port_taux, acompte_type, acompte_taux,modliv_bis,assujetti_tpf from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
			break;
        case $vf_c_action=="cdecli->cdecli":
        case $vf_c_action=="offcli->cdecli":
      		$req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, blocnotebrut_entete, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, blocnotebrut_pied, rendezvous, modliv, typpor, $col_dateheureexpedition, $col_dateheurelivraison, frais_type, frais_taux, port_type, port_taux, acompte_type, acompte_taux,modliv_bis,assujetti_tpf,1 from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
			break;
        case $vf_c_action=="cdecli->faccli":
        case $vf_c_action=="livcli->faccli":
        case $vf_c_action=="cdecli->profor":
        case $vf_c_action=="livcli->profor":
		case $vf_c_action=="profor->faccli":
		case $vf_c_action=="recfou->facfou":
      		if (($vf_c_action=="livcli->faccli")&&($vl_nouvelle_date_fac!="19610123")){
				$col_date_fact="'$vl_nouvelle_date_fac'";
			}
      		if (($vf_c_action=="cdecli->faccli")&&($vl_nouvelle_date_fac!="19610123")){
				$col_date_fact="'$vl_nouvelle_date_fac'";
			}
      		if (($vf_c_action=="recfou->facfou")&&($vl_nouvelle_date_fac!="19610123")){
				$col_date_fact="'$vl_nouvelle_date_fac'";
			}
		      $req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, $blocnotebrut_entete, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, $blocnotebrut_pied, rendezvous, modliv, typpor, $col_dateheureexpedition, $col_dateheurelivraison, frais_type, frais_taux, port_type, port_taux, acompte_type, acompte_taux,$col_date_fact,$fact_type,$fact_genr,$compta_etat,modliv_bis,assujetti_tpf from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
          break;
		case $vf_c_action=="faccli->avocli":
		case $vf_c_action=="faccli->avofin":
		case $vf_c_action=="retcli->avofin":
		case $vf_c_action=="retfou->avofou":
		      $req_entete="INSERT INTO $table_entete_cible select $vl_action_cleunik_cible, $vl_commercial_cleunik_cible, '$code', now(), now(), act_cleunik, $blocnotebrut_entete, reference_acteur, devise, tarif_cleunik, remise_taux, remise_type, remise_genr, escompte_taux, escompte_type, remise_natu, catcompta_cleunik, reg_cleunik, $blocnotebrut_pied, rendezvous, modliv, typpor, dateheureexpedition, dateheurelivraison, frais_type, frais_taux, port_type, port_taux, acompte_type, acompte_taux,$type_avoir,now(),1,modliv_bis,assujetti_tpf from $table_entete_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
          break;
      }
      
    
      
      $vf_c_echo=_graal_exec_requete($req_entete);
      if($vf_c_echo=='ok') {
        $req_adresse_sourc="SELECT `adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, `dateheuremodif`, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`, `adr_type` FROM $table_adress_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
        $result = _graal_requete_bd($req_adresse_sourc);
        while ($row = mysql_fetch_assoc($result)){
          $vl_adr_cleunik_cible=_graal_requete_max("adr_cleunik","$table_adress_cible");
          $adr_cod=fa_nt($row['adr_cod']);
          $adr_nom=fa_nt($row['adr_nom']);
          $adr_complementnom=fa_nt($row['adr_complementnom']);
          $adr_ligne1=fa_nt($row['adr_ligne1']);
          $adr_ligne2=fa_nt($row['adr_ligne2']);
          $adr_ligne3=fa_nt($row['adr_ligne3']);
          $adr_cp=fa_nt($row['adr_cp']);
          $adr_ville=fa_nt($row['adr_ville']);
          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
          $adr_latitude=fa_nn($row['adr_latitude']);
          $adr_longitude=fa_nn($row['adr_longitude']);
          $adr_typecoordonnees=fa_nn($row['adr_typecoordonnees']);
		  $adr_type=fa_nn($row['adr_type']);
          $req_adresse_cible = "INSERT INTO $table_adress_cible (`adr_cleunik`, `adr_cod`, `commercial_cleunik`, `adr_nom`, `adr_complementnom`, `adr_ligne1`, `adr_ligne2`, `adr_ligne3`, `adr_cp`, `adr_ville`, `choix_cleunik`, dateheuremodif, `adr_latitude`, `adr_longitude`, `adr_typecoordonnees`,`adr_type`) VALUES ($vl_adr_cleunik_cible, $adr_cod, $vl_commercial_cleunik_cible, $adr_nom, $adr_complementnom, $adr_ligne1, $adr_ligne2, $adr_ligne3, $adr_cp, $adr_ville, $vl_pays_cleunik, now(), $adr_latitude, $adr_longitude, $adr_typecoordonnees,$adr_type);";
          $vf_c_echo=_graal_exec_requete($req_adresse_cible);
          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
        }
        _graal_libere_requete_bd($result);
				switch (TRUE) {
	        case $vf_c_action=="cdecli->offcli":
	        case $vf_c_action=="cdecli->cdecli":
	        case $vf_c_action=="cdecli->livcli":
	        case $vf_c_action=="cdecli->livcli_partielle":
	        case $vf_c_action=="offcli->offcli":
	        case $vf_c_action=="offcli->cdecli":
	        case $vf_c_action=="cdecli->faccli":
	        case $vf_c_action=="livcli->faccli":
			case $vf_c_action=="faccli->avocli":
			case $vf_c_action=="faccli->avofin":
			case $vf_c_action=="retcli->avofin":
			case $vf_c_action=="retfou->avofou":
		        $req_consig_source="SELECT `action_consi_cleunik`, `commercial_cleunik`, `act_cleunik`, `art_cleunik`, `qte`, `qte_nbdec`,`qte_colis` from $table_consig_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
		        $result = _graal_requete_bd($req_consig_source);
		        while ($row = mysql_fetch_assoc($result)){
		          $act_cleunik=fa_nn($row['act_cleunik']);
		          $art_cleunik=fa_nn($row['art_cleunik']);
		          $qte=fa_nn($row['qte']);
		          $qte_nbdec=fa_nn($row['qte_nbdec']);
				  $qte_colis=fa_nn($row['qte_colis']);
		          $vl_action_consi_cleunik_cible=_graal_requete_max("action_consi_cleunik","$table_consig_cible");
		          $req_consig_cible = "INSERT INTO $table_consig_cible (`action_consi_cleunik`, `commercial_cleunik`, `act_cleunik`, `art_cleunik`, `qte`, `qte_nbdec`,`qte_colis`) VALUES ($vl_action_consi_cleunik_cible,$vl_commercial_cleunik_cible,$act_cleunik,$art_cleunik,$qte,$qte_nbdec,$qte_colis);";
		          $vf_c_echo=_graal_exec_requete($req_consig_cible);
							//$_SESSION['req_02']=$req_consig_cible;
		          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
		        }
		        _graal_libere_requete_bd($result);
		        $req_compta_cible = "INSERT INTO _docciaux_montants SELECT $vl_action_cleunik_cible,$vl_commercial_cleunik_cible, `catcompta_cleunik`, `taxes_cleunik`, `pc_cleunik`, `type`, `montant`,ordre, $vf_e_choix_cleunik_doc from _docciaux_montants where action_cleunik=$vl_action_cleunik_sourc;";
				$vf_c_echo=_graal_exec_requete($req_compta_cible);
		        if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
		        $req_transp_source="SELECT `action_trans_cleunik`, `commercial_cleunik`, `action_trans_cleunik_reference`, `act_cleunik_trans`, `poids_net`, `poids_bru`, `volum_net`, `volum_bru`, `surfa_net`, `surfa_bru`, `nombre_colis` from $table_transp_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
		        $result = _graal_requete_bd($req_transp_source);
		        while ($row = mysql_fetch_assoc($result)){
		          $action_trans_cleunik_reference=fa_nn($row['action_trans_cleunik_reference']);
		          $act_cleunik_trans=fa_nn($row['act_cleunik_trans']);
		          $poids_net=fa_nn($row['poids_net']);
		          $poids_bru=fa_nn($row['poids_bru']);
		          $volum_net=fa_nn($row['volum_net']);
		          $volum_bru=fa_nn($row['volum_bru']);
		          $surfa_net=fa_nn($row['surfa_net']);
		          $surfa_bru=fa_nn($row['surfa_bru']);
		          $nombre_colis=fa_nn($row['nombre_colis']);
		          $vl_action_trans_cleunik_cible=_graal_requete_max("action_trans_cleunik","$table_transp_cible");
		          $req_trans_cible = "INSERT INTO $table_transp_cible (`action_trans_cleunik`, `commercial_cleunik`, `action_trans_cleunik_reference`, `act_cleunik_trans`, `poids_net`, `poids_bru`, `volum_net`, `volum_bru`, `surfa_net`, `surfa_bru`, `nombre_colis`) VALUES ($vl_action_trans_cleunik_cible,$vl_commercial_cleunik_cible,$action_trans_cleunik_reference,$act_cleunik_trans,$poids_net,$poids_bru,$volum_net,$volum_bru,$surfa_net,$surfa_bru,$nombre_colis);";
		          $vf_c_echo=_graal_exec_requete($req_trans_cible);
		          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
		        }
		        _graal_libere_requete_bd($result);
		        $req_repres_source="SELECT `action_rep_cleunik`, `commercial_cleunik`, `action_rep_cleunik_reference`, `act_cleunik_rep`, `commission_typ`, `commission_taux`, `commission_fixe`, `commission_regle` from $table_repres_sourc where commercial_cleunik=$vl_commercial_cleunik_sourc;";
		        $result = _graal_requete_bd($req_repres_source);
		        while ($row = mysql_fetch_assoc($result)){
		          $action_rep_cleunik_reference=fa_nn($row['action_rep_cleunik_reference']);
		          $act_cleunik_rep=fa_nn($row['act_cleunik_rep']);
		          $commission_typ=fa_nn($row['commission_typ']);
		          $commission_taux=fa_nn($row['commission_taux']);
		          $commission_fixe=fa_nn($row['commission_fixe']);
		          $commission_regle=fa_nn($row['commission_regle']);
		          $vl_action_rep_cleunik_cible=_graal_requete_max("action_rep_cleunik","$table_repres_cible");
		          $req_repres_cible = "INSERT INTO $table_repres_cible (`action_rep_cleunik`, `commercial_cleunik`, `action_rep_cleunik_reference`, `act_cleunik_rep`, `commission_typ`, `commission_taux`, `commission_fixe`, `commission_regle`) VALUES ($vl_action_rep_cleunik_cible,$vl_commercial_cleunik_cible,$action_rep_cleunik_reference,$act_cleunik_rep,$commission_typ,$commission_taux,$commission_fixe,$commission_regle);";
		          $vf_c_echo=_graal_exec_requete($req_repres_cible);
		          if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
		        }
		        _graal_libere_requete_bd($result);
					break;
        }
        switch (TRUE) {
        	case $vf_c_action=="cdecli->livcli_partielle":
        	case $vf_c_action=="cdefou->recfou_partielle":
        		// pas d'insertion des lignes
        		break;
        	default:
        {
		$req_lignes_sourc="SELECT f1.commercial_ligne_cleunik, f1.commercial_cleunik,f1.ligne_cleunik,f1.art_cleunik,f1.code_interne,f1.indice_interne,f1.mnemotechnique_interne,f1.description_interne,f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f1.typeligne,f1.pu,f1.pu_portee,f1.pu_type,f1.nbdec_pu,f1.tarif_cleunik,f1.remise_taux,f1.remise_type,f1.remise_genr,f1.poidsbrut,f1.tare, f1.poidsnet,f1.devise_taux,f1.pr,f1.blocnotebrut,f1.blocnoteriche,f1.devise,f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu,f1.coef_facture,f1.taxes_cleunik,f2.types_gestion,f3.gestion as gestion_dep_emp,f1.longueur,f1.largeur,f1.epaisseur,f1.unite_longueur,f1.tpf_cleunik,tpf_cleunik_01 from $table_lignes_sourc f1  left join _article f2 using(art_cleunik) left join _art_stock f3 using(art_cleunik) where commercial_cleunik=$vl_commercial_cleunik_sourc;";
        $result = _graal_requete_bd($req_lignes_sourc);
        while ($row = mysql_fetch_assoc($result)){
          $vl_commercial_ligne_cleunik_source=fa_nn($row['commercial_ligne_cleunik']);
          $ligne_cleunik=fa_nn($row['ligne_cleunik']);
          $vf_e_ligne_cleunik=fa_nn($row['ligne_cleunik']);
          $art_cleunik=fa_nn($row['art_cleunik']);
          $code_interne=fa_nt($row['code_interne']);
          $indice_interne=fa_nt($row['indice_interne']);
          $mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
          $description_interne=fa_nt($row['description_interne']);
          $code_acteur=fa_nt($row['code_acteur']);
          $mnemotechnique_acteur=fa_nt($row['mnemotechnique_acteur']);
          $description_acteur=fa_nt($row['description_acteur']);
          $typeligne=fa_nt($row['typeligne']);
          $pu=fa_nn($row['pu']);
          $pu_portee=fa_nn($row['pu_portee']);
          $pu_type=fa_nn($row['pu_type']);
          $nbdec_pu=fa_nn($row['nbdec_pu']);
          $tarif_cleunik=fa_nn($row['tarif_cleunik']);
          $remise_taux=fa_nn($row['remise_taux']);
          $remise_type=fa_nn($row['remise_type']);
          $remise_genr=fa_nn($row['remise_genr']);
          $poidsbrut=fa_nn($row['poidsbrut']);
          $tare=fa_nn($row['tare']);
          $poidsnet=fa_nn($row['poidsnet']);
          $devise_taux=fa_nn($row['devise_taux']);
          $pr=fa_nn($row['pr']);
          $blocnotebrut=fa_nt($row['blocnotebrut']);
          $blocnoteriche=fa_nt($row['blocnoteriche']);
          $devise=fa_nn($row['devise']);
          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
          $pc_cleunik=fa_nn($row['pc_cleunik']);
          $remise_natu=fa_nn($row['remise_natu']);
          $coef_facture=fa_nn($row['coef_facture']);
          $taxes_cleunik=fa_nn($row['taxes_cleunik']);
          $vl_e_types_gestion=fa_nn($row['types_gestion']);
          $vl_e_gestion_dep_emp=fa_nn($row['gestion_dep_emp']);
          $longueur=fa_nn($row['longueur']);
          $largeur=fa_nn($row['largeur']);
          $epaisseur=fa_nn($row['epaisseur']);
          $unite_longueur=fa_nn($row['unite_longueur']);
          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
          $vl_commercial_ligne_cleunik_cible=_graal_requete_max("commercial_ligne_cleunik","$table_lignes_cible");
          $req_lignes_cible = "INSERT INTO $table_lignes_cible (`commercial_ligne_cleunik`, `commercial_cleunik`, `ligne_cleunik`, `art_cleunik`, `code_interne`, `indice_interne`, `mnemotechnique_interne`, `description_interne`, `code_acteur`, `mnemotechnique_acteur`, `description_acteur`, `typeligne`, `pu`, `pu_portee`, `pu_type`, `nbdec_pu`, `tarif_cleunik`, `remise_taux`, `remise_type`, `remise_genr`, `poidsbrut`, `tare`, `poidsnet`, `devise_taux`, `pr`, `blocnotebrut`, `blocnoteriche`, `devise`, `catcompta_cleunik`, `pc_cleunik`, `remise_natu`, `coef_facture`, `taxes_cleunik`, `longueur`, `largeur`, `epaisseur`, `unite_longueur`, `tpf_cleunik`,tpf_cleunik_01) VALUES ($vl_commercial_ligne_cleunik_cible,$vl_commercial_cleunik_cible,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,$description_interne,$code_acteur,$mnemotechnique_acteur,$description_acteur,$typeligne,$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,$blocnotebrut,$blocnoteriche,$devise,$catcompta_cleunik,$pc_cleunik,$remise_natu,$coef_facture,$taxes_cleunik,$longueur,$largeur,$epaisseur,$unite_longueur,$tpf_cleunik,$tpf_cleunik_01);";
          //$_SESSION['req_02']=$req_lignes_cible;
          $vf_c_echo=_graal_exec_requete($req_lignes_cible);
          if($vf_c_echo!='ok') {
            $vf_c_retour=$vf_c_echo;
          } else {
            switch (TRUE) {
              case $vf_c_action=="cdecli->offcli":
              case $vf_c_action=="cdecli->cdecli":
              case $vf_c_action=="cdecli->livcli":
              case $vf_c_action=="offcli->offcli":
              case $vf_c_action=="offcli->cdecli":
              case $vf_c_action=="cdecli->faccli":
              case $vf_c_action=="cdecli->profor":
			case $vf_c_action=="demfou->demfou":
			case $vf_c_action=="demfou->cdefou":
			case $vf_c_action=="cdefou->demfou":
			case $vf_c_action=="cdefou->cdefou":
			case $vf_c_action=="cdefou->recfou":
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla` from $table_ligqte_sourc where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                break;
              case $vf_c_action=="livcli->faccli":
              case $vf_c_action=="livcli->profor":
              case $vf_c_action=="retcli->avofin":
              
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,cdecli_ligne_qte_cleunik from $table_ligqte_sourc where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                break;
			case $vf_c_action=="faccli->avocli":
			case $vf_c_action=="faccli->avofin":
              case $vf_c_action=="profor->faccli":
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,cdecli_ligne_qte_cleunik,livcli_ligne_qte_cleunik from $table_ligqte_sourc where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                break;
			case $vf_c_action=="recfou->facfou":
			case $vf_c_action=="retfou->avofou":
                $req_ligqte_sourc="SELECT `commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,cdefou_ligne_qte_cleunik from $table_ligqte_sourc where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                break;
            }
            $result_qte = _graal_requete_bd($req_ligqte_sourc);
            //$_SESSION['req_03']=$req_ligqte_sourc;
            while ($row = mysql_fetch_assoc($result_qte)){
              switch (TRUE) {
                case $vf_c_action=="cdecli->offcli":
                case $vf_c_action=="cdecli->cdecli":
                case $vf_c_action=="cdecli->livcli":
                case $vf_c_action=="offcli->offcli":
                case $vf_c_action=="offcli->cdecli":
				case $vf_c_action=="demfou->demfou":
				case $vf_c_action=="demfou->cdefou":
				case $vf_c_action=="cdefou->demfou":
				case $vf_c_action=="cdefou->cdefou":
				case $vf_c_action=="cdefou->recfou":
				case $vf_c_action=="retcli->avofin"://	on aurait du concevoir le fichier retour client comme le fichier livraisons client : voir à l'usage si cela  des conséquences néfastes
                  $cdecli_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
                  break;
                case $vf_c_action=="livcli->faccli":
	            case $vf_c_action=="cdecli->profor":
                  $cdecli_ligne_qte_cleunik=fa_nn($row['cdecli_ligne_qte_cleunik']);
                  $livcli_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
				  break;
				 case $vf_c_action=="recfou->facfou":
                  $cdecli_ligne_qte_cleunik=fa_nn($row['cdefou_ligne_qte_cleunik']);
                  $livcli_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
				  break;
                case $vf_c_action=="cdecli->faccli":
	              case $vf_c_action=="cdecli->profor":
                  $cdecli_ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
                  $livcli_ligne_qte_cleunik="null";
				  break;
				case $vf_c_action=="faccli->avocli":
				case $vf_c_action=="faccli->avofin":
	            case $vf_c_action=="profor->faccli":
                  $cdecli_ligne_qte_cleunik=fa_nn($row['cdecli_ligne_qte_cleunik']);
                  $livcli_ligne_qte_cleunik=fa_nn($row['livcli_ligne_qte_cleunik']);
				  break;
				case $vf_c_action=="retfou->avofou":
					$cdecli_ligne_qte_cleunik=fa_nn($row['cdefou_ligne_qte_cleunik']);
                    //$livcli_ligne_qte_cleunik=fa_nn($row['livcli_ligne_qte_cleunik']);
				    break;
              }
              $ligne_cleunik=fa_nn($row['ligne_cleunik']);
              $qte=fa_nn($row['qte']);
              $qte_unite=fa_nn($row['qte_unite']);
              $qte_nbdec=fa_nn($row['qte_nbdec']);
              $dateheure_demande=fa_nt($row['dateheure_demande']);
              switch ($param_generaux_graal_176){
				case 1://	date du document = date du jour de création (sauf si date forcée)
					$vl_mousto_date_mvt=$maintenant;
		            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
					break;
				case 2:
		            $dateheure_confirm=fa_nt($row['dateheure_confirm']);
		            $vl_mousto_date_mvt=fa_nn($row['dateheure_confirm']);
              		break;
              }
			if (($vf_c_action=="cdecli->livcli")&&($vl_nouvelle_date_exp!="19610123")){
				$dateheure_confirm="'$vl_nouvelle_date_exp $vl_nouvelle_heur_exp'";
				$vl_mousto_date_mvt="$vl_nouvelle_date_exp $vl_nouvelle_heur_exp";
			}
            if (($vf_c_action=="cdecli->faccli")&&($vl_nouvelle_date_fac!="19610123")){
            	$dateheure_confirm="'$vl_nouvelle_date_fac $vl_nouvelle_heur_fac'";
				$vl_mousto_date_mvt="$vl_nouvelle_date_fac $vl_nouvelle_heur_fac";
			} 
              $statut=fa_nn($row['statut']);
              $unite_condi=fa_nn($row['unite_condi']);
              $qte_condi=fa_nn($row['qte_condi']);
              $nb_stock_in_condi=fa_nn($row['nb_stock_in_condi']);
              $choix_depot=fa_nn($row['choix_depot']);
              $choix_empla=fa_nn($row['choix_empla']);
              switch (TRUE) {
                case $vf_c_action=="cdecli->offcli":
                case $vf_c_action=="cdecli->cdecli":
                case $vf_c_action=="offcli->cdecli":
                case $vf_c_action=="offcli->offcli":
				case $vf_c_action=="demfou->demfou":
				case $vf_c_action=="demfou->cdefou":
				case $vf_c_action=="cdefou->cdefou":
					$qte_deja=0;
					break;
				default:
              		$qte_deja=fa_nn($row['qte']);
              		break;
              }
              $vl_ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$table_ligqte_cible");
              switch (TRUE) {
                case $vf_c_action=="cdecli->offcli":
                case $vf_c_action=="cdecli->cdecli":
                case $vf_c_action=="offcli->cdecli":
                case $vf_c_action=="offcli->offcli":
				case $vf_c_action=="faccli->avofin":
				case $vf_c_action=="profor->faccli":
				case $vf_c_action=="demfou->demfou":
				case $vf_c_action=="demfou->cdefou":
				case $vf_c_action=="cdefou->demfou":
				case $vf_c_action=="cdefou->cdefou":
				case $vf_c_action=="recfou->facfou":
				case $vf_c_action=="retcli->avofin":
				case $vf_c_action=="retfou->avofou":
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,-38,$unite_condi,$qte_condi,$nb_stock_in_condi,$choix_depot,$choix_empla,$qte_deja);";
                  break;
                case $vf_c_action=="cdecli->livcli":
                  if (($vl_e_types_gestion & 4)==4) {
                    if ($qte!=0) {
                      /*
                        L'article est géré en stock -> on va faire un mouvement                
                      */
                      /*
                        On calcule le montant remisé de la ligne
                      */
                      
                      $req_montantremise_sourc="SELECT $sql_htbrutremise from $table_lignes_sourc f1,$table_ligqte_sourc f4 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$cdecli_ligne_qte_cleunik;";
                      $resultat_montantremise_sourc = _graal_requete_bd($req_montantremise_sourc);
                      $row = mysql_fetch_assoc($resultat_montantremise_sourc);
                      
                      $vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
                      $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
                      $vl_mousto_art_cleunik=$art_cleunik;
                      $vl_mousto_blocnotebrut="Expédition $code Ligne $vf_e_ligne_cleunik";
                      //$vl_mousto_date_mvt;  renseigné plus haut
                      $vl_mousto_choix_depot=$choix_depot;
                      $vl_mousto_choix_empla=$choix_empla;
                      $vl_mousto_qte_mvt=$qte;
                      $vl_mousto_pu_mvt=$row['htbrutremise']/$qte;
                      $vl_mousto_genre_mvt=-43;// Livraison client
                      $vl_mousto_type_mvt=2;//  Sortie de stock
                      $vl_mousto_mvt_cleunik=fa_mousto_ajout();
                      if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour.="pasbon";}
                      _graal_libere_requete_bd($resultat_montantremise_sourc);
                    } else {
                      $vl_mousto_mvt_cleunik="null";
                    }                
                  } else {
                    $vl_mousto_mvt_cleunik="null";
                  }             
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdecli_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdecli_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla,0);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 ,qte_deja=qte where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
                  //$_SESSION['req_01']=$req;
                  break;
					case $vf_c_action=="cdefou->recfou":
					case $vf_c_action=="recfou->facfou":
                  if (($vl_e_types_gestion & 4)==4) {
                    if ($qte!=0) {
                      /*
                        L'article est géré en stock -> on va faire un mouvement                
                      */
                      /*
                        On calcule le montant remisé de la ligne
                      */
                      
                      $req_montantremise_sourc="SELECT $sql_htbrutremise from $table_lignes_sourc f1,$table_ligqte_sourc f4 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$cdecli_ligne_qte_cleunik;";
                      $resultat_montantremise_sourc = _graal_requete_bd($req_montantremise_sourc);
                      $row = mysql_fetch_assoc($resultat_montantremise_sourc);
                      
                      $vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
                      $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
                      $vl_mousto_art_cleunik=$art_cleunik;
                      $vl_mousto_blocnotebrut="Réception $code Ligne $vf_e_ligne_cleunik";
                      //$vl_mousto_date_mvt;  renseigné plus haut
                      $vl_mousto_choix_depot=$choix_depot;
                      $vl_mousto_choix_empla=$choix_empla;
                      $vl_mousto_qte_mvt=$qte;
                      $vl_mousto_pu_mvt=$row['htbrutremise']/$qte;
                      $vl_mousto_genre_mvt=-42;// Réception fournisseur
                      $vl_mousto_type_mvt=1;//  Entrée en stock
                    switch (TRUE) {
						/*
						 * On a déjà fait le mouvement de stock
						 */
						case $vf_c_action=="recfou->facfou":
							$vl_mousto_mvt_cleunik="null";
							break;
						default:
							$vl_mousto_mvt_cleunik=fa_mousto_ajout();
                      		if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="pasbon";}
                      		_graal_libere_requete_bd($resultat_montantremise_sourc);
							break;
						}
                    } else {
                      $vl_mousto_mvt_cleunik="null";
                    }                
                  } else {
                    $vl_mousto_mvt_cleunik="null";
                  }             
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdefou_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdecli_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla,0);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 ,qte_deja=qte where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
                  //$_SESSION['req_01']=$req;
                  break;
                case $vf_c_action=="cdecli->faccli":
				case $vf_c_action=="cdecli->profor":
                case $vf_c_action=="livcli->faccli":
				case $vf_c_action=="livcli->profor":
				
                  if (($vl_e_types_gestion & 4)==4) {
                    if ($qte!=0) {
                      /*
                        L'article est géré en stock -> on va faire un mouvement                
                      */
                      /*
                        On calcule le montant remisé de la ligne
                      */
                      
                      $req_montantremise_sourc="SELECT $sql_htbrutremise from $table_lignes_sourc f1,$table_ligqte_sourc f4 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$cdecli_ligne_qte_cleunik;";
                      $resultat_montantremise_sourc = _graal_requete_bd($req_montantremise_sourc);
                      $row = mysql_fetch_assoc($resultat_montantremise_sourc);
                      
                      $vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
                      $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
                      $vl_mousto_art_cleunik=$art_cleunik;
                      $vl_mousto_blocnotebrut="Facture $code Ligne $vf_e_ligne_cleunik";
                      //$vl_mousto_date_mvt;  renseigné plus haut
                      $vl_mousto_choix_depot=$choix_depot;
                      $vl_mousto_choix_empla=$choix_empla;
                      $vl_mousto_qte_mvt=$qte;
                      $vl_mousto_pu_mvt=$row['htbrutremise']/$qte;
                      $vl_mousto_genre_mvt=-44;// Facture client
                      $vl_mousto_type_mvt=2;//  Sortie de stock
                      switch (TRUE) {
						/*
						 * On a déjà fait le mouvement de stock
						 */
						case $vf_c_action=="livcli->faccli":
						case $vf_c_action=="livcli->profor":
							$vl_mousto_mvt_cleunik="null";
							break;
						default:
							$vl_mousto_mvt_cleunik=fa_mousto_ajout();
                      		if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="pasbon";}
                      		_graal_libere_requete_bd($resultat_montantremise_sourc);
							break;
						}
                    } else {
                      $vl_mousto_mvt_cleunik="null";
                    }                
                  } else {
                    $vl_mousto_mvt_cleunik="null";
                  }             
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdecli_ligne_qte_cleunik`,`livcli_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`,`qte_deja`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdecli_ligne_qte_cleunik,$livcli_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla,0);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 ,qte_deja=qte where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
                  //$_SESSION['req_01']=$req;
                  break;
                case $vf_c_action=="faccli->avocli":
                  if (($vl_e_types_gestion & 4)==4) {
                    if ($qte!=0) {
                      /*
                        L'article est géré en stock -> on va faire un mouvement                
                      */
                      /*
                        On calcule le montant remisé de la ligne
                      */
                      
                      $req_montantremise_sourc="SELECT $sql_htbrutremise from $table_lignes_sourc f1,$table_ligqte_sourc f4 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$cdecli_ligne_qte_cleunik;";
                      $resultat_montantremise_sourc = _graal_requete_bd($req_montantremise_sourc);
                      $row = mysql_fetch_assoc($resultat_montantremise_sourc);
                      
                      $vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
                      $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
                      $vl_mousto_art_cleunik=$art_cleunik;
                      $vl_mousto_blocnotebrut="Avoir $code Ligne $vf_e_ligne_cleunik";
                      //$vl_mousto_date_mvt;  renseigné plus haut
                      $vl_mousto_choix_depot=$choix_depot;
                      $vl_mousto_choix_empla=$choix_empla;
                      $vl_mousto_qte_mvt=-$qte;
                      $vl_mousto_pu_mvt=$row['htbrutremise']/(-$qte);
                      $vl_mousto_genre_mvt=-129;// Avoir
                      $vl_mousto_type_mvt=2;//  Sortie de stock
                      $vl_mousto_mvt_cleunik=fa_mousto_ajout();
                      if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="pasbon";}
                      _graal_libere_requete_bd($resultat_montantremise_sourc);
                    } else {
                      $vl_mousto_mvt_cleunik="null";
                    }                
                  } else {
                    $vl_mousto_mvt_cleunik="null";
                  }             
                  $req_ligqte_cible = "INSERT INTO $table_ligqte_cible (`commercial_ligne_cleunik`, `ligne_cleunik`, `ligne_qte_cleunik`, `qte`, `qte_unite`, `qte_nbdec`, `dateheure_demande`, `dateheure_confirm`, `statut`, `unite_condi`, `qte_condi`, `nb_stock_in_condi`,`cdecli_ligne_qte_cleunik`, `mvt_cleunik`, `choix_depot`, `choix_empla`) VALUES ($vl_commercial_ligne_cleunik_cible,$ligne_cleunik,$vl_ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$cdecli_ligne_qte_cleunik,$vl_mousto_mvt_cleunik,$choix_depot,$choix_empla);";
                  $req="UPDATE $table_ligqte_sourc set `statut`=-39 where commercial_ligne_cleunik=$vl_commercial_ligne_cleunik_source;";
                  $vf_c_echo=_graal_exec_requete($req);
                  if($vf_c_echo!='ok') {$vf_c_retour.=$vf_c_echo;}
                  //$_SESSION['req_01']=$req;
                  break;

              }
              $vf_c_echo=_graal_exec_requete($req_ligqte_cible);
              //$_SESSION['req_04']=$req_ligqte_cible;
              if($vf_c_echo!='ok') {
                $vf_c_retour.=$vf_c_echo;
              }   
            }
            _graal_libere_requete_bd($result_qte);
          }
        }
        _graal_libere_requete_bd($result);
        }
        break;
        }
      } else {
        $vf_c_retour.=$vf_c_echo;
      }
    } else {
      $vf_c_retour.=$vf_c_echo;
    }
    if ($vf_c_retour=="") {
      switch (TRUE) {
        case $vf_c_action=="cdecli->offcli":
        case $vf_c_action=="cdecli->cdecli":
        case $vf_c_action=="offcli->cdecli":
        case $vf_c_action=="offcli->offcli":
		case $vf_c_action=="demfou->demfou":
		case $vf_c_action=="demfou->cdefou":
		case $vf_c_action=="cdefou->demfou":
		case $vf_c_action=="cdefou->cdefou":
          $req="UPDATE _actions set statut=-23 where action_cleunik=$vl_action_cleunik_cible;";
          $vf_c_echo=_graal_exec_requete($req);
          break;
        case $vf_c_action=="cdecli->livcli":
        case $vf_c_action=="cdecli->faccli":
        case $vf_c_action=="livcli->faccli":
		case $vf_c_action=="profor->faccli":
		case $vf_c_action=="cdefou->recfou":
		case $vf_c_action=="recfou->facfou":
		case $vf_c_action=="retcli->avofin":
		case $vf_c_action=="retfou->avofou":
			$req="UPDATE _actions set statut=-40 where action_cleunik=$vl_action_cleunik_sourc;";
          	$vf_c_echo=_graal_exec_requete($req);
          	break;
		case $vf_c_action=="faccli->avocli":
		case $vf_c_action=="faccli->avofin":
		case $vf_c_action=="cdecli->profor":
		case $vf_c_action=="livcli->profor":
		
				/*
				 * Pas de statut particulier
				 */
					break;
      }
      $vf_c_retour=$vl_action_cleunik_cible;
      _graal_requete_bd("COMMIT;");
			switch (TRUE) {
		case $vf_c_action=="cdecli->cdecli":
        case $vf_c_action=="offcli->cdecli":
        	fa_calcule_echeance_kilometres("cdecli");
        	fa_maj_prepa_compta("cdecli","montants",-2,$vl_action_cleunik_cible,"",1);
        	break;
        case $vf_c_action=="cdecli->faccli":
        case $vf_c_action=="livcli->faccli":
		case $vf_c_action=="profor->faccli":
		case $vf_c_action=="cdecli->profor":
		case $vf_c_action=="livcli->profor":
			fa_calcule_echeance_kilometres("faccli");
					break;
		case $vf_c_action=="faccli->avocli":
		case $vf_c_action=="faccli->avofin":
		case $vf_c_action=="retcli->avofin":
			fa_calcule_echeance_kilometres("avocli");
			break;
		case $vf_c_action=="recfou->facfou":
			fa_calcule_echeance_kilometres("facfou");
			break;
		case $vf_c_action=="retfou->avofou":
			fa_calcule_echeance_kilometres("avofou");
			break;
      }
    } else {
      //$vf_c_retour=-1;
      _graal_requete_bd("ROLLBACK;");
    }
    echo $vf_c_retour;
    break;
	case $vf_c_action=="modifier_doc_compta":
		$catcompta_cleunik=intval(fa_recup_param('catcompta_cleunik','-1'));
		$assujetti_tpf=intval(fa_recup_param('assujetti_tpf','1'));
		$vl_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','0'));
		switch ($vl_c_genreaction){
      case "offcli":
        $table_entete="_offcli_entetes";
        $table_adress="_offcli_adresses";
        $table_transp="_offcli_transporteurs";
		$table_lignes="_offcli_lignes";
		$type_gestion_doc=$param_generaux_graal_045;
		switch ($type_gestion_doc){
			case 1:
				break;
			case 2:
			case 3:
				break;
		}
        break;
      case "cdecli":
        $table_entete="_cdecli_entetes";
        $table_adress="_cdecli_adresses";
        $table_transp="_cdecli_transporteurs";
		$table_lignes="_cdecli_lignes";
		$type_gestion_doc=$param_generaux_graal_046;
		break;
      case "livcli":
        $table_entete="_livcli_entetes";
        $table_adress="_livcli_adresses";
        $table_transp="_livcli_transporteurs";
		$table_lignes="_livcli_lignes";
		$type_gestion_doc=$param_generaux_graal_047;	//	Pas de bons de livraisons en type 1 Services/Prestations
        break;
      case "retcli":
        $table_entete="_retcli_entetes";
        $table_adress="_retcli_adresses";
        $table_transp="_retcli_transporteurs";
		$table_lignes="_retcli_lignes";
		$type_gestion_doc=$param_generaux_graal_103;	//	Pas de bons de livraisons en type 1 Services/Prestations
        break;
      case "faccli":
        $table_entete="_faccli_entetes";
        $table_adress="_faccli_adresses";
        $table_transp="_faccli_transporteurs";
		$table_lignes="_faccli_lignes";
		$type_gestion_doc=$param_generaux_graal_048;
        break;
      case "avocli":
      case "avofin":
        $table_entete="_avocli_entetes";
        $table_adress="_avocli_adresses";
        $table_transp="_avocli_transporteurs";
		$table_lignes="_avocli_lignes";
		$type_gestion_doc=$param_generaux_graal_048;
        break;
      case "avofou":
      case "avofif":
        $table_entete="_avofou_entetes";
        $table_adress="_avofou_adresses";
        $table_transp="_avofou_transporteurs";
		$table_lignes="_avofou_lignes";
		$type_gestion_doc=$param_generaux_graal_048;
        break;
      case "demfou":
        $table_entete="_demfou_entetes";
        $table_adress="_demfou_adresses";
		$table_lignes="_demfou_lignes";
		$type_gestion_doc=$param_generaux_graal_049;				
        break;
      case "cdefou":
        $table_entete="_cdefou_entetes";
        $table_adress="_cdefou_adresses";
		$table_lignes="_cdefou_lignes";
		$type_gestion_doc=$param_generaux_graal_050;				
        break;
      case "recfou":
        $table_entete="_recfou_entetes";
        $table_adress="_recfou_adresses";
		$table_lignes="_recfou_lignes";
		$type_gestion_doc=$param_generaux_graal_125;				
        break;
      case "retfou":
        $table_entete="_retfou_entetes";
        $table_adress="_retfou_adresses";
		$table_lignes="_retfou_lignes";
		$type_gestion_doc=$param_generaux_graal_114;				
        break;
      case "facfou":
        $table_entete="_facfou_entetes";
        $table_adress="_facfou_adresses";
		$table_lignes="_facfou_lignes";
		$type_gestion_doc=$param_generaux_graal_136;				
        break;
    }
	    $deb_trans=_graal_requete_bd("START TRANSACTION;");
        $vf_c_retour="";
		$req_entete="UPDATE $table_entete SET catcompta_cleunik=$catcompta_cleunik,assujetti_tpf=$assujetti_tpf where commercial_cleunik=$vl_commercial_cleunik;";
		$vf_c_echo=_graal_exec_requete($req_entete);
        if($vf_c_echo=='ok') {
	        switch ($vl_c_genreaction){
			  case "offcli":
			  case "cdecli":
			  case "livcli":
			  case "faccli":
			  case "avocli":
			  case "avofin":
			  case "retcli":
			    $pc_cleunik="pc_cleunik_vente";
			    break;
			  case "demfou":
			  case "cdefou":
			  case "recfou":
			  case "facfou":
			  case "retfou":
			  case "avofou":
			  case "avofif":
			    $pc_cleunik="pc_cleunik_achat";
			    break;
			}
		    $sql_req="SELECT a1.code as code_interne,a1.description as description_interne,a1.mnemotechnique as mnemotechnique_interne,a1.indice as indice_interne,";
		    $sql_req.=" a1.pr_generique as pr,a2.catcompta_cleunik as catcompta_cleunik,a2.$pc_cleunik as pc_cleunik,a2.taxes_cleunik,a3.poids_brut as poids_brut,a3.poids_net as poids_net,";
		    $sql_req.=" a1.types_gestion,a2.tpf_cleunik,a2.tpf_cleunik_01,a3.longueur,a3.largeur,a3.epaisseur,a3.unite_longueur,a4.commercial_ligne_cleunik";
		    $sql_req.="  FROM _article a1 left join _art_compta a2 using (art_cleunik) ";
		    $sql_req.=" left join _art_dimensions a3 using(art_cleunik) left join $table_lignes a4 on a4.art_cleunik=a1.art_cleunik";
		    $sql_req.=" where a2.catcompta_cleunik=$catcompta_cleunik and a4.commercial_cleunik=$vl_commercial_cleunik;";
            $result = _graal_requete_bd($sql_req);
		    while ($row = mysql_fetch_assoc($result)) {
              $commercial_ligne_cleunik=$row['commercial_ligne_cleunik'];
              $catcompta_cleunik=$row['catcompta_cleunik'];
              $pc_cleunik=$row['pc_cleunik'];
              $taxes_cleunik=$row['taxes_cleunik'];
              $tpf_cleunik=$row['tpf_cleunik'];
              $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
              $req_ligne="Update $table_lignes set catcompta_cleunik=$catcompta_cleunik,pc_cleunik=$pc_cleunik,taxes_cleunik=$taxes_cleunik,tpf_cleunik=$tpf_cleunik,tpf_cleunik_01=$tpf_cleunik_01 ";
              $req_ligne.=" where commercial_ligne_cleunik=$commercial_ligne_cleunik;";
              if(_graal_exec_requete($req_ligne)!="ok")  {$vf_c_retour=-7;}
            }
            _graal_libere_requete_bd($result); 	
        } else {
        	$vf_c_retour="-4|$req_entete|$type_gestion_doc";
        }
        if ($vf_c_retour=="") {
          $vf_c_retour=$vl_action_cleunik;
          _graal_requete_bd("COMMIT;");
        } else {
          _graal_requete_bd("ROLLBACK;");
        }
        $vf_c_retour.="|";
        echo $vf_c_retour;
		break;
  case $vf_c_action=="modifier_doc":
    $vl_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','0'));
    $vl_action_cleunik=intval(fa_recup_param('vl_action_cleunik','0'));
    $devise=intval(fa_recup_param('devise','0'));  
    $code=fa_recup_param('code','');
    $tarif_cleunik=intval(fa_recup_param('tarif_cleunik','0'));
    $remise_taux=fa_floatval(fa_recup_param("remise_taux",4));
    $remise_type=intval(fa_recup_param('remise_type','0'));
    $remise_genr=intval(fa_recup_param('remise_genr','0'));
    $remise_natu=intval(fa_recup_param('remise_natu','0'));
    $escompte_taux=fa_floatval(fa_recup_param("escompte_taux",4));
    $escompte_type=intval(fa_recup_param('escompte_type','0'));
    $catcompta_cleunik=intval(fa_recup_param('catcompta_cleunik','-1'));
    $reg_cleunik=intval(fa_recup_param('reg_cleunik','0'));
    $blocnotebrut_entete=fa_recup_param('blocnotebrut_entete','');
    $blocnotebrut_pied=fa_recup_param('blocnotebrut_pied','');
    $reference_acteur=fa_recup_param('reference_acteur','');
    $rendezvous=fa_recup_param('rendezvous','');
    $modliv=intval(fa_recup_param('modliv','0'));
	$modliv_bis=intval(fa_recup_param('modliv_bis','0'));
    $typpor=intval(fa_recup_param('typpor','0'));
    $dateheureexpedition=fa_recup_param('dateheureexpedition','');
    $dateheurelivraison=fa_recup_param('dateheurelivraison','');
    $frais_type=intval(fa_recup_param('frais_type','0'));
    $port_type=intval(fa_recup_param('port_type','0'));
    $acompte_type=intval(fa_recup_param('acompte_type','0'));
    $frais_taux=fa_floatval(fa_recup_param("frais_taux",4));
    $port_taux=fa_floatval(fa_recup_param("port_taux",4));
    $acompte_taux=fa_floatval(fa_recup_param("acompte_taux",4));
    $poids_net=fa_floatval(fa_recup_param("poids_net",4));
    $poids_bru=fa_floatval(fa_recup_param("poids_bru",4));
    $volum_net=fa_floatval(fa_recup_param("volum_net",4));
    $volum_bru=fa_floatval(fa_recup_param("volum_bru",4));
    $surfa_net=fa_floatval(fa_recup_param("surfa_net",4));
    $surfa_bru=fa_floatval(fa_recup_param("surfa_bru",4));
    $nombre_colis=fa_floatval(fa_recup_param("nombre_colis",4));
    $action_trans_cleunik=intval(fa_recup_param('action_trans_cleunik','0'));
    $act_cleunik_trans=intval(fa_recup_param('act_cleunik_trans','0'));
	$datedoc=fa_recup_param('datedoc','');
	$dateecheance=fa_recup_param('dateecheance','');
	$assujetti_tpf=intval(fa_recup_param('assujetti_tpf','1'));
	$complement_req_entete_01="";
    switch ($vl_c_genreaction){
      case "offcli":
        $table_entete="_offcli_entetes";
        $table_adress="_offcli_adresses";
        $table_transp="_offcli_transporteurs";
		$table_lignes="_offcli_lignes";
		$type_gestion_doc=$param_generaux_graal_045;
		switch ($type_gestion_doc){
			case 1:
				break;
			case 2:
			case 3:
				break;
		}
        break;
      case "cdecli":
        $table_entete="_cdecli_entetes";
        $table_adress="_cdecli_adresses";
        $table_transp="_cdecli_transporteurs";
		$table_lignes="_cdecli_lignes";
		$type_gestion_doc=$param_generaux_graal_046;
		break;
      case "livcli":
        $table_entete="_livcli_entetes";
        $table_adress="_livcli_adresses";
        $table_transp="_livcli_transporteurs";
		$table_lignes="_livcli_lignes";
		$type_gestion_doc=$param_generaux_graal_047;	//	Pas de bons de livraisons en type 1 Services/Prestations
        break;
      case "retcli":
        $table_entete="_retcli_entetes";
        $table_adress="_retcli_adresses";
        $table_transp="_retcli_transporteurs";
		$table_lignes="_retcli_lignes";
		$type_gestion_doc=$param_generaux_graal_103;	//	Pas de bons de livraisons en type 1 Services/Prestations
        break;
      case "faccli":
        $table_entete="_faccli_entetes";
        $table_adress="_faccli_adresses";
        $table_transp="_faccli_transporteurs";
		$table_lignes="_faccli_lignes";
		$type_gestion_doc=$param_generaux_graal_048;
		$complement_req_entete_01=",date_fact='$datedoc'";
        break;
      case "avocli":
      case "avofin":
        $table_entete="_avocli_entetes";
        $table_adress="_avocli_adresses";
        $table_transp="_avocli_transporteurs";
		$table_lignes="_avocli_lignes";
		$type_gestion_doc=$param_generaux_graal_048;
		$complement_req_entete_01=",date_avoi='$datedoc'";
        break;
      case "avofou":
      case "avofif":
        $table_entete="_avofou_entetes";
        $table_adress="_avofou_adresses";
        $table_transp="_avofou_transporteurs";
		$table_lignes="_avofou_lignes";
		$type_gestion_doc=$param_generaux_graal_048;
		$complement_req_entete_01=",date_avoi='$datedoc'";
        break;
      case "demfou":
        $table_entete="_demfou_entetes";
        $table_adress="_demfou_adresses";
		$table_lignes="_demfou_lignes";
		$type_gestion_doc=$param_generaux_graal_049;				
        break;
      case "cdefou":
        $table_entete="_cdefou_entetes";
        $table_adress="_cdefou_adresses";
		$table_lignes="_cdefou_lignes";
		$type_gestion_doc=$param_generaux_graal_050;				
        break;
      case "recfou":
        $table_entete="_recfou_entetes";
        $table_adress="_recfou_adresses";
		$table_lignes="_recfou_lignes";
		$type_gestion_doc=$param_generaux_graal_125;				
        break;
      case "retfou":
        $table_entete="_retfou_entetes";
        $table_adress="_retfou_adresses";
		$table_lignes="_retfou_lignes";
		$type_gestion_doc=$param_generaux_graal_114;				
        break;
      case "facfou":
        $table_entete="_facfou_entetes";
        $table_adress="_facfou_adresses";
		$table_lignes="_facfou_lignes";
		$complement_req_entete_01=",date_fact='$datedoc'";
		$type_gestion_doc=$param_generaux_graal_136;				
        break;
      case "relfou":
        $table_entete="_relfou_entetes";
        $table_adress="_relfou_adresses";
		$table_lignes="_relfou_lignes";
		$type_gestion_doc=$param_generaux_graal_183;				
        break;
    }
    if ($type_gestion_doc==""){$type_gestion_doc=3;}
    switch ($vl_c_genreaction){
      case "cdecli":
      case "offcli":
      case "livcli":
      case "faccli":
      case "avocli":
      case "avofin":
      case "demfou":
      case "cdefou":
      case "retcli":
      case "retfou":
      case "recfou":
      case "facfou":
      case "relfou":
      case "avofou":
      case "avofif":
			//  Début de la transaction
        $deb_trans=_graal_requete_bd("START TRANSACTION;");
        $vf_c_retour="";
        switch ($type_gestion_doc){
			case 1:
				$req_entete="UPDATE $table_entete SET code='$code',dateheuremodif=now(),devise=$devise,tarif_cleunik=$tarif_cleunik,remise_taux=$remise_taux,remise_type=$remise_type,
				remise_genr=$remise_genr,escompte_taux=$escompte_taux,escompte_type=$escompte_type,remise_natu=$remise_natu,catcompta_cleunik=$catcompta_cleunik,reg_cleunik=$reg_cleunik,
				blocnotebrut_entete='$blocnotebrut_entete',blocnotebrut_pied='$blocnotebrut_pied',reference_acteur='$reference_acteur',dateheurelivraison='$dateheurelivraison',
				frais_type=$frais_type,frais_taux=$frais_taux,port_type=$port_type,acompte_type=$acompte_type,acompte_taux=$acompte_taux $complement_req_entete_01,assujetti_tpf=$assujetti_tpf where commercial_cleunik=$vl_commercial_cleunik;";
				break;
			case 2:
			case 3:
				$req_entete="UPDATE $table_entete SET code='$code',dateheuremodif=now(),devise=$devise,tarif_cleunik=$tarif_cleunik,remise_taux=$remise_taux,remise_type=$remise_type,
				remise_genr=$remise_genr,escompte_taux=$escompte_taux,escompte_type=$escompte_type,remise_natu=$remise_natu,catcompta_cleunik=$catcompta_cleunik,reg_cleunik=$reg_cleunik,
				blocnotebrut_entete='$blocnotebrut_entete',blocnotebrut_pied='$blocnotebrut_pied',reference_acteur='$reference_acteur',rendezvous='$rendezvous',modliv=$modliv,typpor=$typpor,
				dateheureexpedition='$dateheureexpedition',dateheurelivraison='$dateheurelivraison',frais_type=$frais_type,frais_taux=$frais_taux,port_type=$port_type,
				port_taux=$port_taux,acompte_type=$acompte_type,acompte_taux=$acompte_taux $complement_req_entete_01,modliv_bis=$modliv_bis,assujetti_tpf=$assujetti_tpf where commercial_cleunik=$vl_commercial_cleunik;";
				break;
		}
        $vf_c_echo=_graal_exec_requete($req_entete);
        if($vf_c_echo=='ok') {
        	//	Mise à jour des code taxes et catégories comptables des lignes, au cas ou l'information ait changé sur l'entête
					// désactivé le 8 favrier 2009 car mauvaise requête qui fiche le bousin
//					$req_lignes="update $table_lignes a1,_art_compta a2,$table_entete a3 set a1.taxes_cleunik=a2.taxes_cleunik,a1.catcompta_cleunik=a3.catcompta_cleunik where a1.art_cleunik=a2.art_cleunik and a2.catcompta_cleunik=a3.catcompta_cleunik and a1.commercial_cleunik=$vl_commercial_cleunik;";
//					$req_lignes="update $table_lignes a1 left join _art_compta a2 using (art_cleunik) left join $table_entete a3 using (commercial_cleunik) set a1.taxes_cleunik=a2.taxes_cleunik,a1.catcompta_cleunik=a3.catcompta_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik;";
        //  Mise à jour adresse de livraison
              $vl_adr_cleunik=intval(fa_recup_param('liv_adr_cleunik','0'));
              $liv_pays_cleunik=intval(fa_recup_param('liv_pays_cleunik','0'));
              $adr_nom=fa_recup_param('liv_adr_nom','');
              $adr_complementnom=fa_recup_param('liv_adr_complementnom','');
              $adr_ligne1=fa_recup_param('liv_adr_ligne1','');
              $adr_ligne2=fa_recup_param('liv_adr_ligne2','');
              $adr_ligne3=fa_recup_param('liv_adr_ligne3','');
              $adr_cp=fa_recup_param('liv_adr_cp','');
              $adr_ville=fa_recup_param('liv_adr_ville','');
              $adr_latitude=fa_floatval(fa_recup_param("liv_adr_latitude",0));
              $adr_longitude=fa_floatval(fa_recup_param("liv_adr_longitude",0));
		  $adr_type=fa_nn(fa_recup_param("liv_adr_type",1));
		if ($vl_adr_cleunik!=0) {
                $req_adresse_liv="UPDATE $table_adress SET adr_nom='$adr_nom',adr_complementnom='$adr_complementnom',adr_ligne1='$adr_ligne1',adr_ligne2='$adr_ligne2',adr_ligne3='$adr_ligne3',adr_cp='$adr_cp',adr_ville='$adr_ville',choix_cleunik=$liv_pays_cleunik,adr_latitude=$adr_latitude,adr_longitude=$adr_longitude,adr_type=$adr_type where adr_cleunik=$vl_adr_cleunik;";
              if(_graal_exec_requete($req_adresse_liv)!="ok") {$vf_c_retour=-1;}											
              } else {
              	if ($adr_nom!='null') {
	              	if (trim($adr_nom.$adr_complementnom.$adr_ligne1.$adr_ligne2.$adr_ligne3)!=""){
		                $vl_adr_cleunik=_graal_requete_max("adr_cleunik","$table_adress");
		                $adr_typecoordonnees=1;
						$adr_type=1;
		                $req_adresse_liv="INSERT INTO $table_adress (adr_cleunik,commercial_cleunik,adr_nom,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,adr_latitude,adr_longitude,adr_typecoordonnees,adr_type) VALUES ";
		                $req_adresse_liv.="($vl_adr_cleunik,$vl_commercial_cleunik,'$adr_nom','$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_ligne3','$adr_cp','$adr_ville',$liv_pays_cleunik,$adr_latitude,$adr_longitude,$adr_typecoordonnees,$adr_type)";
			              if(_graal_exec_requete($req_adresse_liv)!="ok") {$vf_c_retour="-5|$req_adresse_liv";}
			        }
				  }
              }
          
          //  Mise à jour adresse de facturation
          $vl_adr_cleunik=intval(fa_recup_param('fac_adr_cleunik','0'));
          $fac_pays_cleunik=intval(fa_recup_param('fac_pays_cleunik','0'));
          $adr_nom=fa_recup_param('fac_adr_nom','');
          $adr_complementnom=fa_recup_param('fac_adr_complementnom','');
          $adr_ligne1=fa_recup_param('fac_adr_ligne1','');
          $adr_ligne2=fa_recup_param('fac_adr_ligne2','');
          $adr_ligne3=fa_recup_param('fac_adr_ligne3','');
          $adr_cp=fa_recup_param('fac_adr_cp','');
          $adr_ville=fa_recup_param('fac_adr_ville','');
          $adr_latitude=fa_floatval(fa_recup_param("fac_adr_latitude",0));
          $adr_longitude=fa_floatval(fa_recup_param("fac_adr_longitude",0));
		  $adr_type=fa_nn(fa_recup_param("fac_adr_type",1));
          if ($vl_adr_cleunik!=0) {
            $req_adresse_fac="UPDATE $table_adress SET adr_nom='$adr_nom',adr_complementnom='$adr_complementnom',adr_ligne1='$adr_ligne1',adr_ligne2='$adr_ligne2',adr_ligne3='$adr_ligne3',adr_cp='$adr_cp',adr_ville='$adr_ville',choix_cleunik=$fac_pays_cleunik,adr_latitude=$adr_latitude,adr_longitude=$adr_longitude,adr_type=$adr_type where adr_cleunik=$vl_adr_cleunik;";
			if(_graal_exec_requete($req_adresse_fac)!="ok") {$vf_c_retour=-2;}
          } else {
          	if (trim($adr_nom.$adr_complementnom.$adr_ligne1.$adr_ligne2.$adr_ligne3)!=""){
	            $vl_adr_cleunik=_graal_requete_max("adr_cleunik","$table_adress");
	            $adr_typecoordonnees=2;
				$adr_type=1;
	            $req_adresse_fac="INSERT INTO $table_adress (adr_cleunik,commercial_cleunik,adr_nom,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,adr_latitude,adr_longitude,adr_typecoordonnees,adr_type) VALUES ";
	            $req_adresse_fac.="($vl_adr_cleunik,$vl_commercial_cleunik,'$adr_nom','$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_ligne3','$adr_cp','$adr_ville',$fac_pays_cleunik,$adr_latitude,$adr_longitude,$adr_typecoordonnees,$adr_type)";
				if(_graal_exec_requete($req_adresse_fac)!="ok") {$vf_c_retour=-6;}
						}
          }
          
          switch ($vl_c_genreaction){
            case "cdecli":
            case "offcli":
            case "livcli":
            case "retcli":
			case "faccli":
		      case "avocli":
		      case "avofin":
					switch ($type_gestion_doc){
								case 1:
									break;
								case 2:
								case 3:
				          if ($action_trans_cleunik!=0) {
				            $req_trans=" UPDATE $table_transp SET act_cleunik_trans=$act_cleunik_trans,poids_net=$poids_net,poids_bru=$poids_bru,volum_net=$volum_net,volum_bru=$volum_bru,surfa_net=$surfa_net,surfa_bru=$surfa_bru,nombre_colis=$nombre_colis where action_trans_cleunik=$action_trans_cleunik";
				          } else {
				            $action_trans_cleunik=_graal_requete_max("action_trans_cleunik","$table_transp");
				            $req_trans="INSERT INTO $table_transp (action_trans_cleunik,commercial_cleunik,act_cleunik_trans,poids_net,poids_bru,volum_net,volum_bru,surfa_net,surfa_bru) VALUES ($action_trans_cleunik,$vl_commercial_cleunik,$act_cleunik_trans,$poids_net,$poids_bru,$volum_net,$volum_bru,$surfa_net,$surfa_bru)";
				          }        
				          if(_graal_exec_requete($req_trans)!="ok") {$vf_c_retour=-3;}
									break;
							}
							break;
					}
        switch ($vl_c_genreaction){
        	case "cdecli":
        	case "faccli":
		      case "avocli":
		      case "avofin":
		      case "facfou":
		      case "avofou":
		      case "avofif":
        		fa_calcule_echeance_kilometres("$vl_c_genreaction");
		      	$req_echeance=" UPDATE _echeancier SET date_echeance='$dateecheance' where action_cleunik=$vl_action_cleunik";
		        if(_graal_exec_requete($req_echeance)!="ok") {$vf_c_retour=-12;}
			}
        switch ($vl_c_genreaction){
        	case "cdecli":
		      	fa_maj_prepa_compta($vl_c_genreaction,"montants",-2,$vl_action_cleunik,"",1);
			}
        switch ($vl_c_genreaction){
        	case "cdecli":
		      case "offcli":
		      case "demfou":
		      case "cdefou":
		        break;
		      case "retcli":
		      case "retfou":
		      case "relfou":
		      case "livcli":
		      case "recfou":
		        $req_date=" UPDATE _actions f1 left join $table_entete f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.dateheurelivraison,f1.dateheurefin=f2.dateheurelivraison where f2.action_cleunik=$vl_action_cleunik";
		        if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		        //echo $req_date;
		        break;		
		      case "faccli":
		      case "facfou":
		      	$req_date=" UPDATE _actions f1 left join $table_entete f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.date_fact,f1.dateheurefin=f2.date_fact where f2.action_cleunik=$vl_action_cleunik";
		        if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		        //echo $req_date;
		        break;		
		      case "avofou":
		      case "avofif":
		      case "avocli":
		      case "avofin":
        		$req_date=" UPDATE _actions f1 left join $table_entete f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.date_avoi,f1.dateheurefin=f2.date_avoi where f2.action_cleunik=$vl_action_cleunik";
		        if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		        //echo $req_date;
		        break;
			}	
        } else {
          //echo $vf_c_echo;
          $vf_c_retour="-4|$req_entete|$type_gestion_doc";
          //$vf_c_retour="-4";
        }
        if ($vf_c_retour=="") {
          $vf_c_retour=$vl_action_cleunik;
          _graal_requete_bd("COMMIT;");
        } else {
          _graal_requete_bd("ROLLBACK;");
        }
        $vf_c_retour.="|";
        echo $vf_c_retour;
        break;
    }
    break;
  case $vf_c_action=="ajouter_doc":
  	$avertissement="";
  	$vl_e_act_cleunik=intval(fa_recup_param('act_cleunik','0'));
    switch ($vl_c_genreaction){
      case "offcli":$id_fen_doc_cial="Fen_00671";$type_gestion_doc=$param_generaux_graal_045;break;
      case "cdecli":$id_fen_doc_cial="Fen_00477";$type_gestion_doc=$param_generaux_graal_046;break;
      case "livcli":$id_fen_doc_cial="Fen_00672";$type_gestion_doc=$param_generaux_graal_047;break;
      case "faccli":$id_fen_doc_cial="Fen_00673";$type_gestion_doc=$param_generaux_graal_048;break;
      case "avocli":$id_fen_doc_cial="Fen_00674";$type_gestion_doc=$param_generaux_graal_048;break;
      case "avofin":$id_fen_doc_cial="Fen_00674";$type_gestion_doc=$param_generaux_graal_048;break;
      case "demfou":$id_fen_doc_cial="Fen_00675";$type_gestion_doc=$param_generaux_graal_049;break;
      case "cdefou":$id_fen_doc_cial="Fen_00676";$type_gestion_doc=$param_generaux_graal_050;break;
      case "recfou":$id_fen_doc_cial="Fen_00677";$type_gestion_doc=$param_generaux_graal_125;break;
      case "facfou":$id_fen_doc_cial="Fen_00678";$type_gestion_doc=$param_generaux_graal_136;break;
      case "profor":$id_fen_doc_cial="Fen_00742";$type_gestion_doc=$param_generaux_graal_048;break;
      case "retcli":$id_fen_doc_cial="Fen_01091";$type_gestion_doc=$param_generaux_graal_103;break;
      case "retfou":$id_fen_doc_cial="Fen_01092";$type_gestion_doc=$param_generaux_graal_114;break;
      case "avofou":$id_fen_doc_cial="Fen_01139";$type_gestion_doc=$param_generaux_graal_136;break;
      case "avofif":$id_fen_doc_cial="Fen_01139";$type_gestion_doc=$param_generaux_graal_136;break;
      default:echo $vf_c_retour;exit;break;
    }
    $vl_tb_droits=_graal_requete_droits_fenetre($id_fen_doc_cial,$vl_e_uti_cleunik);
    if($vl_tb_droits[1]==false) {echo $vf_c_retour;exit;}
    switch ($vl_c_genreaction){
      case "cdecli":
      case "livcli":
      case "faccli":
      case "avocli":
      case "avofin":
      case "cdefou":
      case "recfou":
      case "facfou":
      case "retcli":
      case "retfou":
	  case "profor":
	  case "avofou":
      case "avofif":
        $sql_req = "SELECT f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu FROM _act_compta f1 left join _acteurs f2 using (act_cleunik) where f1.act_cleunik=$vl_e_act_cleunik";//  Recherche compte comptable
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        if (mysql_num_rows($result)==0) {
          $vf_c_retour=-10;
          _graal_libere_requete_bd($result);
          echo $vf_c_retour;
          exit;
        } else {
          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
          $pc_cleunik=fa_nn($row['pc_cleunik']);
          $remise_natu=fa_nn($row['remise_natu']);
          _graal_libere_requete_bd($result);
          if (($catcompta_cleunik==-1)||(is_null($row['catcompta_cleunik']))) {echo -11;exit;}
          if ((($pc_cleunik==-1)||(is_null($row['pc_cleunik'])))&&($vs_enval==true)) {echo -12;exit;}
          if (($remise_natu==0)||(is_null($row['remise_natu']))||($remise_natu=="")) {echo -13;exit;}
        }
        break;
      case "offcli":
      case "demfou":
    	$sql_req = "SELECT f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu FROM _act_compta f1 left join _acteurs f2 using (act_cleunik) where f1.act_cleunik=$vl_e_act_cleunik";//  Recherche compte comptable
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        if (mysql_num_rows($result)==0) {
          $avertissement="Informations comptables non renseignées. Création hasardeuse";
        } else {
          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
          $pc_cleunik=fa_nn($row['pc_cleunik']);
          $remise_natu=fa_nn($row['remise_natu']);
          if (($catcompta_cleunik==-1)||(is_null($row['catcompta_cleunik']))) {$avertissement="Catégorie fiscale non renseignée. Création hasardeuse";}
          if ((($pc_cleunik==-1)||(is_null($row['pc_cleunik'])))&&($vs_enval==true)) {$avertissement="Compte imputation comptable non renseigné. Création hasardeuse (si transformation)";}
        if (($remise_natu==0)||(is_null($row['remise_natu']))||($remise_natu=="")) {$avertissement="Eléments de gestion incomplets. Création hasardeuse (si transformation)";}
        }
      	_graal_libere_requete_bd($result);
        break;
    }
    $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.codealphanum15 as codealphanum15,_acteurs.raisonsoc as raisonsoc,_acteurs.nomcommercial as nomcommercial,_acteurs.siret as siret,_acteurs.blocnotebrut as blocnotebrut,_acteurs.blocnotertf as blocnotertf,_acteurs.dateheuremodif as dateheuremodif,_acteurs.dateheurevalidite as dateheurevalidite,_acteurs.dateheurecreation as dateheurecreation,_acteurs.typeacteur as typeacteur, _acteurs.c_uuid as uuid,_acteurs.mnemotechnique as mnemotechnique,_acteurs.modegestion as modegestion,_act_compta.tvaintracommunautaire as tvaintracommunautaire,_act_compta.encours_autorise as encours_autorise,_act_compta.catcompta_cleunik,_act_compta.tarif_cleunik as tarif_cleunik,_act_compta.remise_taux as remise_taux,_act_compta.remise_type as remise_type,_act_compta.remise_genr as remise_genr,escompte_taux as escompte_taux,escompte_type as escompte_type,_act_compta.remise_natu as remise_natu,_act_compta.reg_cleunik as reg_cleunik,pc_cleunik as pc_cleunik,_acteurs.actif as actif,_acteurs.devise as devise,_param_pc.code as nature_comptable,_param_pc.intitule,_act_compta.assujetti_tpf FROM _acteurs left join _act_compta using(act_cleunik) left join _param_pc using(pc_cleunik) where _acteurs.act_cleunik=$vl_e_act_cleunik";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    $typeacteur=fa_nn($row['typeacteur']);
    $nature_comptable=fa_nn($row['nature_comptable']);
    $devise=fa_nn($row['devise']);
    $tarif_cleunik=fa_nn($row['tarif_cleunik']);
    $remise_taux=fa_nn($row['remise_taux']);
    $remise_type=fa_nn($row['remise_type']);
    $remise_genr=fa_nn($row['remise_genr']);
    $escompte_taux=fa_nn($row['escompte_taux']);
    $escompte_type=fa_nn($row['escompte_type']);
    $remise_natu=fa_nn($row['remise_natu']);
    $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
    $reg_cleunik=fa_nn($row['reg_cleunik']);
    $assujetti_tpf=fa_nn($row['assujetti_tpf']);
    $frais_type=2;
    $port_type=2;
    $acompte_type=2;
    $adr_nom=fa_nt($row['nomcommercial']);
    if ($adr_nom=="''"){
    	$adr_nom=fa_nt($row['raisonsoc']);
    }
    _graal_libere_requete_bd($result);
		$typpor=-93;
		if ($param_generaux_graal_024==-1) {$typpor=-93;} else {$typpor=$param_generaux_graal_024;}
    switch ($vl_c_genreaction){
      case "offcli":
      	if($typeacteur=="110001"||$typeacteur=="110003") {
        	$vf_e_choix_cleunik_doc=-110114;$vf_e_choix_cleunik_graal=-110408;$num_cleunik=1;
          $table_entete="_offcli_entetes";
          $table_adress="_offcli_adresses";
          $table_repres="_offcli_representants";
          $table_transp="_offcli_transporteurs";
		$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_011);
		$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_012);
      } else {
        echo $vf_c_retour;
        exit;
      }
      break;
      case "cdecli":
        if($typeacteur=="110003"&&$nature_comptable!="") {
          $vf_e_choix_cleunik_doc=-110108;$vf_e_choix_cleunik_graal=-110409;$num_cleunik=2;
          $table_entete="_cdecli_entetes";
          $table_adress="_cdecli_adresses";
          $table_repres="_cdecli_representants";
          $table_transp="_cdecli_transporteurs";
	  	$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_013);
		$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_014);
        } else {
          echo $vf_c_retour;
          exit;
        }
        break;
      case "livcli":
        if($typeacteur=="110003"&&$nature_comptable!="") {
          $vf_e_choix_cleunik_doc=-110110;$vf_e_choix_cleunik_graal=-110410;$num_cleunik=3;
          $table_entete="_livcli_entetes";
          $table_adress="_livcli_adresses";
          $table_repres="_livcli_representants";
          $table_transp="_livcli_transporteurs";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_015);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_016);
        } else {
          echo $vf_c_retour;
          exit;
        }
        break;
      case "faccli":
	  case "profor":
        if($typeacteur=="110003"&&$nature_comptable!="") {
          $vf_e_choix_cleunik_doc=-110112;$vf_e_choix_cleunik_graal=-110411;$num_cleunik=4;
          $table_entete="_faccli_entetes";
          $table_adress="_faccli_adresses";
          $table_repres="_faccli_representants";
          $table_transp="_faccli_transporteurs";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_017);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_018);
			$fact_type="1";
			$compta_etat="1";
			switch ($vl_c_genreaction) {
				case "faccli":$fact_genr="1";break;
				case "profor":$fact_genr="2";break;
			}
        } else {
          echo $vf_c_retour;
          exit;
        }
        break;
      case "avocli":
				if($typeacteur=="110003"&&$nature_comptable!="") {
					$vf_e_choix_cleunik_doc=-110116;$vf_e_choix_cleunik_graal=-110411;$num_cleunik=4;
			          $table_entete="_avocli_entetes";
			          $table_adress="_avocli_adresses";
			          $table_repres="_avocli_representants";
			          $table_transp="_avocli_transporteurs";
					$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_017);
					$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_018);
					$compta_etat="1";
					$type_avoir=2;
				} else {
					echo $vf_c_retour;
					exit;
				}
				break;
      case "avofin":
				if($typeacteur=="110003"&&$nature_comptable!="") {
					$vf_e_choix_cleunik_doc=-110117;$vf_e_choix_cleunik_graal=-110411;$num_cleunik=4;
			          $table_entete="_avocli_entetes";
			          $table_adress="_avocli_adresses";
			          $table_repres="_avocli_representants";
			          $table_transp="_avocli_transporteurs";
					$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_017);
					$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_018);
					$compta_etat="1";
					$type_avoir=1;
				} else {
					echo $vf_c_retour;
					exit;
				}
				break;
      case "demfou":
				if($typeacteur=="110002"||$typeacteur=="110004") {
					$vf_e_choix_cleunik_doc=-110115;$vf_e_choix_cleunik_graal=-110412;$num_cleunik=5;
		          $table_entete="_demfou_entetes";
		          $table_adress="_demfou_adresses";
					$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_036);
					$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_037);
				} else {
					echo $vf_c_retour;
					exit;
				}
				break;
      case "cdefou":
        if($typeacteur=="110004"&&$nature_comptable!="") {
	          $vf_e_choix_cleunik_doc=-110109;$vf_e_choix_cleunik_graal=-110413;$num_cleunik=6;
	          $table_entete="_cdefou_entetes";
	          $table_adress="_cdefou_adresses";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_040);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_041);
        } else {
          echo $vf_c_retour;
          exit;
        }
        break;
      case "retfou":
        if($typeacteur=="110004"&&$nature_comptable!="") {
	          $vf_e_choix_cleunik_doc=-110134;$vf_e_choix_cleunik_graal=-110439;$num_cleunik=16;
	          $table_entete="_retfou_entetes";
	          $table_adress="_retfou_adresses";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_149);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_150);
        } else {
          echo $vf_c_retour;
          exit;
        }
        break;
      case "retcli":
        if($typeacteur=="110003"&&$nature_comptable!="") {
          $vf_e_choix_cleunik_doc=-110133;$vf_e_choix_cleunik_graal=-110438;$num_cleunik=15;
          $table_entete="_retcli_entetes";
          $table_adress="_retcli_adresses";
          $table_repres="_retcli_representants";
          $table_transp="_retcli_transporteurs";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_147);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_148);
        } else {
          echo $vf_c_retour;
          exit;
        }
        break;
      case "recfou":if($typeacteur=="110004"&&$nature_comptable!="") {
      	$vf_e_choix_cleunik_doc=-110111;$vf_e_choix_cleunik_graal=-110414;$num_cleunik=7;
      	$table_entete="_recfou_entetes";
	    $table_adress="_recfou_adresses";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_151);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_152);
      } else {
      	echo $vf_c_retour;
      	exit;
      }
      break;
      case "facfou":
      	if($typeacteur=="110004"&&$nature_comptable!="") {
      		$vf_e_choix_cleunik_doc=-110113;$vf_e_choix_cleunik_graal=-110415;$num_cleunik=8;
      		$table_entete="_facfou_entetes";
	    	$table_adress="_facfou_adresses";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_153);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_154);
      	} else {
      		echo $vf_c_retour;
      		exit;
      	}
      	break;
      case "avofou":
		if($typeacteur=="110004"&&$nature_comptable!="") {
			$vf_e_choix_cleunik_doc=-110137;$vf_e_choix_cleunik_graal=-110445;$num_cleunik=8;
	          $table_entete="_avofou_entetes";
	          $table_adress="_avofou_adresses";
	          $table_repres="_avofou_representants";
	          $table_transp="_avofou_transporteurs";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_017);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_018);
			$compta_etat="1";
			$type_avoir=2;
		} else {
			echo $vf_c_retour;
			exit;
		}
		break;
      case "avofif":
		if($typeacteur=="110004"&&$nature_comptable!="") {
			$vf_e_choix_cleunik_doc=-110138;$vf_e_choix_cleunik_graal=-110445;$num_cleunik=8;
	          $table_entete="_avofou_entetes";
	          $table_adress="_avofou_adresses";
	          $table_repres="_avofou_representants";
	          $table_transp="_avofou_transporteurs";
			$blocnotebrut_entete=modele_pied_entete($param_generaux_graal_017);
			$blocnotebrut_pied=modele_pied_entete($param_generaux_graal_018);
			$compta_etat="1";
			$type_avoir=1;
		} else {
			echo $vf_c_retour;
			exit;
		}
		break;
      	
      	
    }
    switch ($vl_c_genreaction){
      case "offcli":
      case "cdecli":
      case "livcli":
      case "demfou":
      case "cdefou":
      case "recfou":
      case "facfou":
      case "retcli":
      case "retfou":
				$req_entete="INSERT INTO $table_entete (action_cleunik,commercial_cleunik,code,dateheurecreation,dateheuremodif,act_cleunik,devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,reg_cleunik,frais_type,port_type,acompte_type,blocnotebrut_entete,blocnotebrut_pied,typpor,assujetti_tpf) VALUES ";
				break;
      case "avocli":
      case "avofin":
      case "avofou":
      case "avofif":
				$req_entete="INSERT INTO $table_entete (action_cleunik,commercial_cleunik,code,dateheurecreation,dateheuremodif,act_cleunik,devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,reg_cleunik,frais_type,port_type,acompte_type,blocnotebrut_entete,blocnotebrut_pied,typpor,type_avoir,date_avoi,compta_etat,assujetti_tpf) VALUES ";
				break;
			case "faccli":
			case "profor":
				$req_entete="INSERT INTO $table_entete (action_cleunik,commercial_cleunik,code,dateheurecreation,dateheuremodif,act_cleunik,devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,reg_cleunik,frais_type,port_type,acompte_type,blocnotebrut_entete,blocnotebrut_pied,typpor,date_fact,fact_type,fact_genr,compta_etat,assujetti_tpf) VALUES ";
				break;
    }
    $req_action="INSERT INTO _actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurecreation,sujet,c_uuid,reference,statut) VALUES ";
    $req_graal="INSERT INTO _graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ";
    $req_adresse="INSERT INTO $table_adress (adr_cleunik,commercial_cleunik,adr_nom,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,adr_latitude,adr_longitude,adr_typecoordonnees,adr_type) VALUES ";
    $req_rep="INSERT INTO $table_repres (action_rep_cleunik,commercial_cleunik,action_rep_cleunik_reference,act_cleunik_rep,commission_typ,commission_taux,commission_fixe,commission_regle) VALUES ";
    $req_transporteur="INSERT INTO $table_transp (action_trans_cleunik,commercial_cleunik,act_cleunik_trans) VALUES ";
    
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $vl_uuid=_graal_requete_uuid();
    $statut=-23;  //  En cours
    $code=_graal_numerote($num_cleunik);//  Numérotation automatique
    $vf_c_retour="";
    //  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    //  Ajout action
    $req_action.="($vl_action_cleunik,$vf_e_choix_cleunik_doc,now(),now(),'$code','$vl_uuid','$code',$statut)";
    $vf_c_echo=_graal_exec_requete($req_action);
    if($vf_c_echo=='ok') {
      //  Ajout entête
      $vl_commercial_cleunik=_graal_requete_max("commercial_cleunik","$table_entete");
	    switch ($vl_c_genreaction){
	      case "offcli":
	      case "cdecli":
	      case "livcli":
	      case "demfou":
	      case "cdefou":
	      case "recfou":
	      case "facfou":
	      case "retcli":
      	  case "retfou":
					$req_entete.="($vl_action_cleunik,$vl_commercial_cleunik,'$code',now(),now(),$vl_e_act_cleunik,$devise,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$escompte_taux,$escompte_type,$remise_natu,$catcompta_cleunik,$reg_cleunik,$frais_type,$port_type,$acompte_type,$blocnotebrut_entete,$blocnotebrut_pied,$typpor,$assujetti_tpf)";
					break;
	      case "avocli":
	      case "avofin":
	      case "avofou":
	      case "avofif":
					$req_entete.="($vl_action_cleunik,$vl_commercial_cleunik,'$code',now(),now(),$vl_e_act_cleunik,$devise,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$escompte_taux,$escompte_type,$remise_natu,$catcompta_cleunik,$reg_cleunik,$frais_type,$port_type,$acompte_type,$blocnotebrut_entete,$blocnotebrut_pied,$typpor,$type_avoir,now(),$compta_etat,$assujetti_tpf)";
					break;
	      case "faccli":
		  case "profor":
					$req_entete.="($vl_action_cleunik,$vl_commercial_cleunik,'$code',now(),now(),$vl_e_act_cleunik,$devise,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$escompte_taux,$escompte_type,$remise_natu,$catcompta_cleunik,$reg_cleunik,$frais_type,$port_type,$acompte_type,$blocnotebrut_entete,$blocnotebrut_pied,$typpor,now(),$fact_type,$fact_genr,$compta_etat,$assujetti_tpf)";
					break;

	    }
      $vf_c_echo=_graal_exec_requete($req_entete);
      if($vf_c_echo=='ok') {
        //  Ajout relation acteur principal
        $cond_graal="($vl_e_act_cleunik,0,$vl_action_cleunik,$vf_e_choix_cleunik_graal,8192,2)";
        if(_graal_exec_requete($req_graal.$cond_graal)!="ok")  {$vf_c_retour=-3;}
		    
		//  Recherche de l'adresse de livraison : on prend la première que l'on trouve même s'il y en a plusieurs
        $sql_req="Select * from _act_adresses where act_cleunik=$vl_e_act_cleunik and adr_typecoordonnees&2";
        $result = _graal_requete_bd($sql_req);
        if (mysql_num_rows($result)!=0) {
          $row = mysql_fetch_assoc($result);
          $vl_adr_cleunik=_graal_requete_max("adr_cleunik","$table_adress");
          $adr_complementnom=fa_nt($row['adr_complementnom']);
          $adr_ligne1=fa_nt($row['adr_ligne1']);
          $adr_ligne2=fa_nt($row['adr_ligne2']);
          $adr_ligne3=fa_nt($row['adr_ligne3']);
          $adr_cp=fa_nt($row['adr_cp']);
          $adr_ville=fa_nt($row['adr_ville']);
          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
          $adr_latitude=fa_nn($row['adr_latitude']);
          $adr_longitude=fa_nn($row['adr_longitude']);
		  $adr_type=fa_nn($row['adr_type']);
          $adr_typecoordonnees=1;
          $cond_adresse="($vl_adr_cleunik,$vl_commercial_cleunik,$adr_nom,$adr_complementnom,$adr_ligne1,$adr_ligne2,$adr_ligne3,$adr_cp,$adr_ville,$vl_pays_cleunik,$adr_latitude,$adr_longitude,$adr_typecoordonnees,$adr_type)";
          if(_graal_exec_requete($req_adresse.$cond_adresse)!="ok") {$vf_c_retour=-5;}
        }
        _graal_libere_requete_bd($result);
		    
        //  Recherche de l'adresse de facturation  : on prend la première que l'on trouve même s'il y en a plusieurs
        $sql_req="Select * from _act_adresses where act_cleunik=$vl_e_act_cleunik and adr_typecoordonnees&1";
        $result = _graal_requete_bd($sql_req);
        if (mysql_num_rows($result)!=0) {
          $row = mysql_fetch_assoc($result);
          $vl_adr_cleunik=_graal_requete_max("adr_cleunik","$table_adress");
          $adr_complementnom=fa_nt($row['adr_complementnom']);
          $adr_ligne1=fa_nt($row['adr_ligne1']);
          $adr_ligne2=fa_nt($row['adr_ligne2']);
          $adr_ligne3=fa_nt($row['adr_ligne3']);
          $adr_cp=fa_nt($row['adr_cp']);
          $adr_ville=fa_nt($row['adr_ville']);
          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
          $adr_latitude=fa_nn($row['adr_latitude']);
          $adr_longitude=fa_nn($row['adr_longitude']);
		  $adr_type=fa_nn($row['adr_type']);
          $adr_typecoordonnees=2;
          $cond_adresse="($vl_adr_cleunik,$vl_commercial_cleunik,$adr_nom,$adr_complementnom,$adr_ligne1,$adr_ligne2,$adr_ligne3,$adr_cp,$adr_ville,$vl_pays_cleunik,$adr_latitude,$adr_longitude,$adr_typecoordonnees,$adr_type)";
          if (_graal_exec_requete($req_adresse.$cond_adresse)!="ok") {$vf_c_retour=-6;}
        }
        _graal_libere_requete_bd($result);
        switch ($vl_c_genreaction){
          case "offcli":
          case "cdecli":
          case "livcli":
          case "faccli":
          case "avocli":
          case "avofin":
          case "avofou":
	      case "avofif":
			case "profor":
			case "retcli":
            //  Recherche des représentants
            $sql_req="select act_cleunik_gauche as act_cleunik,ifnull(commission_typ,1) as commission_typ,ifnull(commission_taux,0) as commission_taux,ifnull(commission_fixe,0) as commission_fixe,commission_regle from _acteurs_representants where act_cleunik_droite=$vl_e_act_cleunik union select act_cleunik_droite as act_cleunik,ifnull(commission_typ,1) as commission_typ,ifnull(commission_taux,0) as commission_taux,ifnull(commission_fixe,0) as commission_fixe,commission_regle from _acteurs_representants where act_cleunik_gauche=$vl_e_act_cleunik;";
            $result = _graal_requete_bd($sql_req);
            while ($row = mysql_fetch_assoc($result)) {
              $vl_action_rep_cleunik=_graal_requete_max("action_rep_cleunik","$table_repres");
              $act_cleunik_rep=$row['act_cleunik'];
              $commission_typ=$row['commission_typ'];
              $commission_taux=$row['commission_taux'];
              $commission_fixe=$row['commission_fixe'];
              $commission_regle=$row['commission_regle'];
              $cond_rep="($vl_action_rep_cleunik,$vl_commercial_cleunik,$vl_action_rep_cleunik,$act_cleunik_rep,$commission_typ,$commission_taux,$commission_fixe,$commission_regle)";
              if(_graal_exec_requete($req_rep.$cond_rep)!="ok")  {$vf_c_retour=-13;}
              $cond_graal="($act_cleunik_rep,0,$vl_action_cleunik,-110427,8192,1)";
              if(_graal_exec_requete($req_graal.$cond_graal)!="ok")  {$vf_c_retour=-7;}
            }
            _graal_libere_requete_bd($result);
						switch ($type_gestion_doc){
							case 1:
								break;
							case 2:
							case 3:
		            //  Recherche des transporteurs ( pour l'instant, on n'en gère qu'un seul)
		            $sql_req="select act_cleunik_gauche as act_cleunik from _acteurs_relations where act_cleunik_droite=$vl_e_act_cleunik  and act_cleunik_gauche in (select act_cleunik from _act_choix_fixes where choix_cleunik=-25) union select act_cleunik_droite as act_cleunik from _acteurs_relations where act_cleunik_gauche=$vl_e_act_cleunik and act_cleunik_droite in (select act_cleunik from _act_choix_fixes where choix_cleunik=-25) union SELECT act_cleunik as act_cleunik from _act_choix_fixes where _act_choix_fixes.choix_cleunik=-25 and act_cleunik=0 limit 1;";
		            $result = _graal_requete_bd($sql_req);
		            if (mysql_num_rows($result)!=0) {
		              $row = mysql_fetch_assoc($result);
		              $vl_action_trans_cleunik=_graal_requete_max("action_trans_cleunik","$table_transp");
		              $act_cleunik_trans=$row['act_cleunik'];
		              $cond_transporteur="($vl_action_trans_cleunik,$vl_commercial_cleunik,$act_cleunik_trans)";
		              $vf_c_echo=_graal_exec_requete($req_transporteur.$cond_transporteur);
		              $cond_graal="($act_cleunik_trans,0,$vl_action_cleunik,-110428,8192,1)";
		              if(_graal_exec_requete($req_graal.$cond_graal)!="ok") {$vf_c_retour=-8;}
		            }
		            _graal_libere_requete_bd($result);
								break;
						}
            break;
          case "demfou":
          case "cdefou":
          case "recfou":
          case "facfou":
          case "retfou":
            break;
        }
      } else {
        $vf_c_retour=-9;
      }
    } else {
      $vf_c_retour=-2;
    }
    //  Fin de la transaction
    if ($vf_c_retour=="") {
     	$vf_c_retour=$vl_action_cleunik;
     	if ($avertissement!=""){
     		$vf_c_retour.="|".$avertissement."|";
     	}
      _graal_requete_bd("COMMIT;");
		switch ($vl_c_genreaction){
			case "cdecli":
					fa_calcule_echeance_kilometres("cdecli");
					fa_maj_prepa_compta($vl_c_genreaction,"montants",-2,$vl_action_cleunik,"",1);
					break;
        	case "faccli":
					fa_calcule_echeance_kilometres("faccli");
					break;
			case "facfou":
					fa_calcule_echeance_kilometres("facfou");
					break;
			case "avocli":
			case "avofin":
					fa_calcule_echeance_kilometres("avocli");
					break;
			case "avofou":
	        case "avofif":
					fa_calcule_echeance_kilometres("avofou");
					break;
			}
	/*
	 * On recherche les message d'avertissements liés aux acteurs
	 */		
    switch ($vl_c_genreaction){
	      case "offcli":$critere_cleunik=149;break;
	      case "cdecli":$critere_cleunik=150;break;
	      case "livcli":$critere_cleunik=151;break;
	      case "demfou":$critere_cleunik=155;break;
	      case "cdefou":$critere_cleunik=156;break;
	      case "recfou":$critere_cleunik=157;break;
	      case "facfou":$critere_cleunik=159;break;
	      case "avocli":$critere_cleunik=154;break;
	      case "avofin":$critere_cleunik=154;break;
	      case "faccli":$critere_cleunik=153;break;
		  case "profor":$critere_cleunik=153;break;
		  case "retfou":$critere_cleunik=158;break;
	      case "retcli":$critere_cleunik=152;break;
	      case "avofou":$critere_cleunik=160;break;
	      case "avofif":$critere_cleunik=160;break;
	    }	
		$sql_req="Select f1.choix_valeur_texte_01 as avertissement from _choix f1 left join _act_choix_fixes f2 using(choix_cleunik) where f2.act_cleunik=$vl_e_act_cleunik and f2.critere_cleunik=$critere_cleunik;";
        $result = _graal_requete_bd($sql_req);
        if (mysql_num_rows($result)!=0) {
          $row = mysql_fetch_assoc($result);
          $avertissement=$row['avertissement'];
        }
        _graal_libere_requete_bd($result);
        $vf_c_retour.="|".$avertissement."|";
    } else {
      //$vf_c_retour.=$vf_c_echo;
			$vf_c_echo=_graal_exec_requete("delete from _actions_texte where action_cleunik=$vl_action_cleunik;");
      _graal_requete_bd("ROLLBACK;");
    }
    $vf_c_retour.="|";
    echo $vf_c_retour;
  break;
	
	case $vf_c_action=="avofou->suppri":
		switch (TRUE) {
			case $vf_c_action=="avofou->suppri":
				$fic_01="_avofou_entetes";
				$fic_02="_avofou_lignes_qte";
				$fic_03="_avofou_lignes";
				$choix_cleunik=-163;
				break;				
		}
    $vl_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','0'));
		$req_action="select action_cleunik from $fic_01 where commercial_cleunik=$vl_commercial_cleunik;";
    $result = _graal_requete_bd($req_action);
    while ($row = mysql_fetch_assoc($result)){
      $vl_action_cleunik=fa_nt($row['action_cleunik']);
    }      
    _graal_libere_requete_bd($result);
		$req_supprimer=" SELECT f1.mvt_cleunik FROM $fic_02 f1 LEFT JOIN $fic_03 f2 USING (commercial_ligne_cleunik) LEFT JOIN $fic_01 f3 USING (commercial_cleunik) WHERE f3.commercial_cleunik=$vl_commercial_cleunik and f1.mvt_cleunik is not NULL;";
		$result_supprimer = _graal_requete_bd($req_supprimer);
    while ($row_supprimer = mysql_fetch_assoc($result_supprimer)){
			$vl_mousto_mvt_cleunik=fa_mousto_supprime_document(fa_nn($row_supprimer['mvt_cleunik']),$choix_cleunik);
		}
		_graal_libere_requete_bd($result_supprimer);
		$req_supprimer="SELECT f1.recfou_ligne_qte_cleunik FROM $fic_02 f1 LEFT JOIN $fic_03 f2 USING (commercial_ligne_cleunik) LEFT JOIN $fic_01 f3 USING (commercial_cleunik) WHERE f3.commercial_cleunik=$vl_commercial_cleunik and f1.livcli_ligne_qte_cleunik is not NULL;";
		$result_supprimer = _graal_requete_bd($req_supprimer);
    while ($row_supprimer = mysql_fetch_assoc($result_supprimer)){
    	$livcli_ligne_qte_cleunik=$row_supprimer['livcli_ligne_qte_cleunik'];
	    $vf_c_echo=_graal_exec_requete("update _recfou_lignes_qte f1 set f1.statut=-38 where f1.statut=-39 and f1.ligne_qte_cleunik=$livcli_ligne_qte_cleunik;");
			$req_maj="SELECT f4.action_cleunik FROM _recfou_lignes_qte f1 LEFT JOIN _livcli_lignes f2 USING (commercial_ligne_cleunik) LEFT JOIN _livcli_entetes f3 USING (commercial_cleunik) left join _actions f4 using(action_cleunik) WHERE f1.ligne_qte_cleunik=$livcli_ligne_qte_cleunik;";
			$result_maj = _graal_requete_bd($req_maj);
	    while ($row_maj = mysql_fetch_assoc($result_maj)){
    		$vl_action_cleunik_livcli=$row_maj['action_cleunik'];
	    	$req="UPDATE _actions set statut=-23 where action_cleunik=$vl_action_cleunik_livcli and statut=-40;";
		    $vf_c_echo=_graal_exec_requete($req);
			}
		}
		_graal_libere_requete_bd($result_supprimer);
		$vf_c_echo=_graal_exec_requete("delete from $fic_01 where commercial_cleunik=$vl_commercial_cleunik;");
		$vf_c_echo=_graal_exec_requete("delete from _actions where action_cleunik=$vl_action_cleunik;");
		$vf_c_echo=_graal_exec_requete("delete from _actions_texte where action_cleunik=$vl_action_cleunik;");
		//echo $vl_mousto_mvt_cleunik;
		switch (TRUE) {
			case $vf_c_action=="avofou->suppri":
				echo "Avoir supprimé";
				break;				
		}
	break;
	
	case $vf_c_action=="faccli->suppri":
	case $vf_c_action=="avocli->suppri":
		switch (TRUE) {
			case $vf_c_action=="faccli->suppri":
				$fic_01="_faccli_entetes";
				$fic_02="_faccli_lignes_qte";
				$fic_03="_faccli_lignes";
				$choix_cleunik=-134;
				break;
			case $vf_c_action=="avocli->suppri":
				$fic_01="_avocli_entetes";
				$fic_02="_avocli_lignes_qte";
				$fic_03="_avocli_lignes";
				$choix_cleunik=-133;
				break;
		}
    $vl_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','0'));
		$req_action="select action_cleunik from $fic_01 where commercial_cleunik=$vl_commercial_cleunik;";
    $result = _graal_requete_bd($req_action);
    while ($row = mysql_fetch_assoc($result)){
      $vl_action_cleunik=fa_nt($row['action_cleunik']);
    }      
    _graal_libere_requete_bd($result);
		$req_supprimer=" SELECT f1.mvt_cleunik FROM $fic_02 f1 LEFT JOIN $fic_03 f2 USING (commercial_ligne_cleunik) LEFT JOIN $fic_01 f3 USING (commercial_cleunik) WHERE f3.commercial_cleunik=$vl_commercial_cleunik and f1.mvt_cleunik is not NULL;";
		$result_supprimer = _graal_requete_bd($req_supprimer);
    while ($row_supprimer = mysql_fetch_assoc($result_supprimer)){
			$vl_mousto_mvt_cleunik=fa_mousto_supprime_document(fa_nn($row_supprimer['mvt_cleunik']),$choix_cleunik);
		}
		_graal_libere_requete_bd($result_supprimer);
		$req_supprimer="SELECT f1.livcli_ligne_qte_cleunik FROM $fic_02 f1 LEFT JOIN $fic_03 f2 USING (commercial_ligne_cleunik) LEFT JOIN $fic_01 f3 USING (commercial_cleunik) WHERE f3.commercial_cleunik=$vl_commercial_cleunik and f1.livcli_ligne_qte_cleunik is not NULL;";
		$result_supprimer = _graal_requete_bd($req_supprimer);
    while ($row_supprimer = mysql_fetch_assoc($result_supprimer)){
    	$livcli_ligne_qte_cleunik=$row_supprimer['livcli_ligne_qte_cleunik'];
	    $vf_c_echo=_graal_exec_requete("update _livcli_lignes_qte f1 set f1.statut=-38 where f1.statut=-39 and f1.ligne_qte_cleunik=$livcli_ligne_qte_cleunik;");
			$req_maj="SELECT f4.action_cleunik FROM _livcli_lignes_qte f1 LEFT JOIN _livcli_lignes f2 USING (commercial_ligne_cleunik) LEFT JOIN _livcli_entetes f3 USING (commercial_cleunik) left join _actions f4 using(action_cleunik) WHERE f1.ligne_qte_cleunik=$livcli_ligne_qte_cleunik;";
			$result_maj = _graal_requete_bd($req_maj);
	    while ($row_maj = mysql_fetch_assoc($result_maj)){
    		$vl_action_cleunik_livcli=$row_maj['action_cleunik'];
	    	$req="UPDATE _actions set statut=-23 where action_cleunik=$vl_action_cleunik_livcli and statut=-40;";
		    $vf_c_echo=_graal_exec_requete($req);
			}
		}
		_graal_libere_requete_bd($result_supprimer);
		$vf_c_echo=_graal_exec_requete("delete from $fic_01 where commercial_cleunik=$vl_commercial_cleunik;");
		$vf_c_echo=_graal_exec_requete("delete from _actions where action_cleunik=$vl_action_cleunik;");
		$vf_c_echo=_graal_exec_requete("delete from _actions_texte where action_cleunik=$vl_action_cleunik;");
		//echo $vl_mousto_mvt_cleunik;
		switch (TRUE) {
			case $vf_c_action=="faccli->suppri":
				echo "Facture supprimée";
				break;
			case $vf_c_action=="avocli->suppri":
				echo "Avoir supprimé";
				break;				
		}
	break;
	
	
	
	
	case $vf_c_action=="changer_numero":
    $vl_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','0'));
    $code=fa_recup_param('code','');
		switch ($vl_c_genreaction){
      case "offcli":
        $table_entete="_offcli_entetes";
        break;
      case "cdecli":
        $table_entete="_cdecli_entetes";
				break;
      case "livcli":
        $table_entete="_livcli_entetes";
        break;
      case "faccli":
        $table_entete="_faccli_entetes";
        break;
      case "avocli":
      case "avofin":
        $table_entete="_avocli_entetes";
        break;
      case "demfou":
        $table_entete="_demfou_entetes";
        break;
      case "cdefou":
        $table_entete="_cdefou_entetes";
        break;
      case "retcli":
        $table_entete="_retcli_entetes";
        break;
      case "retfou":
        $table_entete="_retfou_entetes";
        break;
       case "recfou":
        $table_entete="_recfou_entetes";
        break;
      case "facfou":
        $table_entete="_facfou_entetes";
        break;
      case "relfou":
        $table_entete="_relfou_entetes";
        break;
      case "avofou":
      case "avofif":
        $table_entete="_avocli_entetes";
        break;
    }
		$req_entete="UPDATE $table_entete SET code='$code',dateheuremodif=now() where commercial_cleunik=$vl_commercial_cleunik;";
    $vf_c_echo=_graal_exec_requete($req_entete);
    echo $vf_c_echo;
		break;
	case $vf_c_action=="correction_date_faccli":	
		$req_date=" UPDATE _actions f1 left join _faccli_entetes f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.date_fact,f1.dateheurefin=f2.date_fact where f1.dateheuredebut<>f2.date_fact";
		if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		break;
	case $vf_c_action=="correction_date_avocli":	
		$req_date=" UPDATE _actions f1 left join _avocli_entetes f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.date_avoi,f1.dateheurefin=f2.date_avoi where f1.dateheuredebut<>f2.date_avoi";
		if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		break;
	case $vf_c_action=="correction_date_facfou":	
		$req_date=" UPDATE _actions f1 left join _facfou_entetes f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.date_fact,f1.dateheurefin=f2.date_fact where f1.dateheuredebut<>f2.date_fact";
		if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		break;
	case $vf_c_action=="correction_date_avofou":	
		$req_date=" UPDATE _actions f1 left join _avofou_entetes f2 on f1.action_cleunik=f2.action_cleunik SET f1.dateheuredebut=f2.date_avoi,f1.dateheurefin=f2.date_avoi where f1.dateheuredebut<>f2.date_avoi";
		if(_graal_exec_requete($req_date)!="ok") {$vf_c_retour=-13;}
		break;	
		
		
}
//echo $vf_c_action;
/*
//  Faute de mieux parce qu'il n'est pas possible de l'intégrer dans un trigger
DROP TRIGGER `TGRBI_actions`;
DELIMITER //
CREATE TRIGGER `TGRBI_actions` BEFORE INSERT ON `_actions`
 FOR EACH ROW BEGIN
	delete from _actions_texte where action_cleunik not in(select action_cleunik from _actions);
END
La requête a échoué. -> Can't update table '_actions' in stored function/trigger because it is already used by statement which invoked this stored function/trigger.
*/ 
$sql_req = "delete from _actions_texte where action_cleunik not in(select action_cleunik from _actions);";
_graal_exec_requete($sql_req);
_graal_ferme_connexion();
function modele_pied_entete($vl_e_doc_cleunik) {
	if ($vl_e_doc_cleunik==-1) {return "null";}
	$var_rc='\r\n';
	$sql_req = "SELECT _documents.blocnote_riche AS blocnote_riche FROM _documents WHERE _documents.doc_cleunik =$vl_e_doc_cleunik"; 
	$result = _graal_requete_bd($sql_req);
	fa_xcree_entete_xml();
	$row = mysql_fetch_assoc($result);
	$blocnote_riche=fa_nt($row['blocnote_riche']);
	$blocnote_riche=str_replace("<br>",$var_rc,$blocnote_riche);
	_graal_libere_requete_bd($result);
	return $blocnote_riche;
}
?>
