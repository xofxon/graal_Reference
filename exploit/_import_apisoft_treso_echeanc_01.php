<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
include("_import_apisoft_sp_array_pc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_finan');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_genre=fa_recup_param('vl_c_genre','???');
switch ($vl_c_genre) {
	case "cli":
		$fic_entete_doccial="_faccli_entetes";
		$fic_echeances="_faccli_echeance";
		$condition= " where TypeTiers='C'";
		break;
	case "fou":
		$fic_entete_doccial="_facfou_entetes";
		$fic_echeances="_facfou_echeance";
		$condition= " where TypeTiers='F'";
		break;
}
include("_import_apisoft_sp_array_docciaux.php");
$vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
$o_modepaiement=new _graal_import();
$o_echeance=new _graal_import();
$o_modepaiement->req="INSERT INTO $vl_c_base_destination._choix (critere_cleunik,choix_cleunik,choix_code,choix_valeur_texte_01,choix_actif) VALUES ";
//  Recherche pour modes de paiement
$sql_req = "SELECT distinct(ModeP) FROM $vl_c_base_origine.remise where ModeP not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=137)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik++;
  $i++;
  $choix_code=addslashes($row['ModeP']);
  $choix_valeur_texte_01=addslashes($row['ModeP']);
  $o_modepaiement->dat.="(137,$vf_e_choix_cleunik,'$choix_code','$choix_valeur_texte_01',1),";
}
_graal_libere_requete_bd($result);
$o_modepaiement->execute();
include("_import_apisoft_sp_array_modepaiement.php");//  On recherche les modes de paiement
$i=0;$j=0;$b=500;
$o_echeance->req="INSERT INTO $vl_c_base_destination.$fic_echeances (echeance_cleunik,commercial_cleunik,pc_cleunik,noligne,date_paiement,date_echeance,libelle,montant_du,Montant_paye,devise_du,devise_paye,taux_de_change,mode_paiement,blocnotebrut,dateheurecreation,dateheuremodif,etat) VALUES ";
//  Lecture de la table des échéances
$sql_req = "SELECT `TypeTiers`,`NumGest`,`NumEcr`,`Numero`,`NumEch`,`ProvApp`,`ProvFic`,`Code`,`Compte`,`DateP`,`DateE`,`RefDoc`,`Libelle`,`MontantDev`,`MontantInteret`,`MontantRglDev`,`CodeDevise`,`ModeP`,`FlLien`,`DateTraite`,`NumRela`,`Note`,`dateDerModif`,`flRg`,`Journal` FROM $vl_c_base_origine.echeance $condition;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
	$echeance_cleunik=	$row['NumEch']	;
	$vl_e_trouve_doc=array_search($row['NumGest'], $doc_cod);if ($vl_e_trouve_doc===false) {$doc_cleunik=0;echo "Facture ? ".$row['NumGest'].EOL;} else {$doc_cleunik=$doc_cle[$vl_e_trouve_doc];}
	$commercial_cleunik=$doc_cleunik;
	$vl_e_trouve_pc=array_search($row['Compte'], $pc_cod);if ($vl_e_trouve_pc===false) {$pc_cleunik=0;echo "Compte ? ".$row['Compte']." sur Facture ? ".$row['NumGest'].EOL;} else {$pc_cleunik=$pc_cle[$vl_e_trouve_pc];}
	$noligne=$row['Numero'];
	$date_paiement=fa_nt($row['DateP']);
	$date_echeance=fa_nt($row['DateE']);
	$libelle=fa_nt($row['Libelle']);
	$montant_du=$row['MontantDev'];
	$Montant_paye=$row['MontantRglDev'];
	switch ($row['CodeDevise']){
		case "E":$devise_du=122047;break;
		case "F":$devise_du=122176;break;
		default :$devise_du=122047;break;
	}
	$devise_paye=$devise_du;
	$taux_de_change=1;
	$vl_e_trouve_mod=array_search($row['ModeP'], $mod_cod);if ($vl_e_trouve_mod===false) {$mode_paiement=-91;} else {$mode_paiement=$mod_cle[$vl_e_trouve_mod];}
	$blocnotebrut=fa_nt($row['Note']);
	$dateheurecreation=fa_nt($row['dateDerModif']);
	$dateheuremodif=fa_nt($row['dateDerModif']);
	$etat=4;
	if ($commercial_cleunik==0) {
		$l++;
	}
	if ($pc_cleunik==0) {
		$m++;
	}
	
	if ($commercial_cleunik==0 || $pc_cleunik==0) {
		$j++;
	} else {
	  $o_echeance->dat.="($echeance_cleunik,$commercial_cleunik,$pc_cleunik,$noligne,$date_paiement,$date_echeance,$libelle,$montant_du,$Montant_paye,$devise_du,$devise_paye,$taux_de_change,$mode_paiement,$blocnotebrut,$dateheurecreation,$dateheuremodif,$etat),";
		$i++;
	}	
	if ($i % $b==0){
    $o_echeance->execute();
  }
}
_graal_libere_requete_bd($result);
/*
echo $o_modepaiement->req.$o_modepaiement->dat;
echo EOL;
echo $o_action->req.$o_action->dat;
*/
$o_echeance->execute();
$sql_req="update $vl_c_base_destination.$fic_echeances a1 set etat=3 where (montant_du=montant_paye) and montant_du <>0;";
_graal_exec_requete($sql_req);
$sql_req="update $vl_c_base_destination.$fic_echeances a1 set etat=1 where montant_paye=0 and montant_du <>0;";
_graal_exec_requete($sql_req);
$sql_req="update $vl_c_base_destination.$fic_echeances a1 set etat=2 where montant_paye<>0 and montant_du<>montant_paye;";
_graal_exec_requete($sql_req);

echo("$i échéances importées, $j échéances ignorées ($l factures introuvables $m comptes comptables introuvables !!");
?>
