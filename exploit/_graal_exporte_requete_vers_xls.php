<?php
$vl_e_langue=120131;  //  français par défaut
set_time_limit(300);
//  à régler, un problème d'utf8 ????
//  Très important !!
require_once "sources_excel/class.writeexcel_workbook.inc.php";
require_once "sources_excel/class.writeexcel_worksheet.inc.php";

require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");

$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');

$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
$workbook =new writeexcel_workbook($fname);
$worksheet =& $workbook->addworksheet( utf8_decode('Export Requête XsOFtware'));

$query=fa_recup_param('vl_c_requete','select now()');
$vl_c_no_requete=fa_recup_param('vl_c_no_requete','0-0');
switch ($vl_c_no_requete){
	case "0-0":
		$query=base64_decode($query);
		break;
	case "001":	//	Liste des fenêtres de l'application
		$query = "SELECT _objets.titre AS titre,_objets_libelle.descriptif AS descriptif FROM _objets,_objets_libelle ";
		$query.= " WHERE _objets.type_objet=1 and _objets_libelle.langue=$vl_e_langue and _objets_libelle.fen_cleunik=_objets.fen_cleunik ORDER BY titre;";
		break;
	case "002":	//	Liste des traitements de l'application
		$query = "SELECT _objets.titre AS titre,_objets_libelle.descriptif AS descriptif FROM _objets,_objets_libelle ";
		$query.= " WHERE _objets.type_objet=2 and _objets_libelle.langue=$vl_e_langue and _objets_libelle.fen_cleunik=_objets.fen_cleunik ORDER BY titre;";
		break;
}

//if ($query=='') die('Error: SQL command must be provided');
if ($query==''){
	fa_redirige("acces_interdit");
}

$command = strtolower(substr($query,0,strpos($query,' ')));
//if (strpos('select,show,describe',$command)===false) die('Error: Only SELECT/SHOW/DESCRIBE is allowed');
if (strpos('delete,insert,delete,truncate,drop',$command)===true) die('Error: Only SELECT/SHOW/DESCRIBE is allowed');
$connection = mysql_connect($sql_serveur,$sql_user,$sql_passwd) or die('Error: Could not connect to server - ' . mysql_error());
$result = mysql_query("SET CHARACTER SET 'utf8';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$result = mysql_query("SET collation_connection = 'utf8_general_ci';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$result = mysql_query($query,$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$nfields = mysql_num_fields($result);
$vl_e_noligne=0;
//  Lecture des colonnes
for ($i=0; $i<$nfields; $i++)
{
    $fieldname = mysql_field_name($result, $i);
    $worksheet->write($vl_e_noligne, $i, "$fieldname");
}
//  Lecture des résultats de la requête

while ($line = mysql_fetch_array($result, MYSQL_ASSOC))
{
  $j = 0;
  $vl_e_noligne++;
  foreach ($line as $field)
  {
      $worksheet->write($vl_e_noligne, $j, utf8_decode($field));
      $j++;
  }
}
mysql_free_result($result);
mysql_close($connection);
$workbook->close();

header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
$fh=fopen($fname, "rb");
fpassthru($fh);
//unlink($fname);

?>
