<?php
include("_graal_header_xml.inc.php");
include_once("_graal_var_portee.php");
$vf_c_quelspaniers=fa_recup_param('vl_c_quelspaniers','');
$vl_e_uti_cleunik=fa_recup_session('vs_uti_cleunik','0');
$vl_e_portee=intval(fa_recup_param('vl_e_portee','0'));
$vl_e_maportee=intval(fa_recup_param('vl_e_maportee','-1'));
$vl_e_type=fa_recup_param('vl_e_type','-1');
$vl_c_actif=fa_recup_param('vl_c_actif','1,2');
$vl_c_operateur_portee=fa_recup_param('vl_c_operateur_portee','&');
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_special=fa_recup_param('vl_special','0');
$prop_obsolete="css_0001";
if ($vl_e_maportee!=-1) {
  $vl_e_portee=$vl_e_maportee;
  $vf_c_quelspaniers="melistes";
}
$sql_req = "SELECT _panier.panier_cleunik AS panier_cleunik,_panier.actif AS actif,_panier.panier_titre AS panier_titre,";
$sql_req.= " "._graalsql_datetime('_panier.dateheurecreation')." AS dateheurecreation,_panier.uti_cleunik AS uti_cleunik,_utilisateur.prenom AS prenom,";
$sql_req.= " _utilisateur.patronyme AS patronyme,panier_type as panier_type,panier_portee as panier_portee FROM _utilisateur, _panier ";
$sql_req.= " left join _droits_panier f3 on f3.panier_cleunik=_panier.panier_cleunik ";
$sql_req.= " WHERE _utilisateur.uti_cleunik = _panier.uti_cleunik";
if ($vl_e_type!="-1") {$sql_req.=" AND panier_type in($vl_e_type)";}
if ($vl_e_portee>0) {
	switch ($vl_special){
		case '0':
			$sql_req.=" AND panier_portee $vl_c_operateur_portee $vl_e_portee";
			break;
		case '1':	//	requêtes et panier des acteurs et requêtes des interlocuteurs
			$sql_req.=" AND ((panier_portee & 4096+$vl_e_portee and panier_type in(2)) or (panier_portee & $vl_e_portee and panier_portee & 8192+4096 and panier_type in(1)))";
			break;
	}
}
switch ($vf_c_quelspaniers) {
  case "medoc"    : $sql_req .= " AND _panier.panier_cleunik>0 AND f3.uti_cleunik=$vl_e_uti_cleunik";break;
  case "melistes" : $sql_req .= " AND ((_panier.panier_cleunik>0 AND f3.uti_cleunik IN ($vl_e_uti_cleunik,0)) OR (f3.panier_cleunik<0))";break;
  //case "melistes" : $sql_req .= " AND _panier.panier_cleunik>0 AND _panier.uti_cleunik IN ($vl_e_uti_cleunik,0)";break;
  case "nosdocs"  : $sql_req .= " AND _panier.panier_cleunik>0 ";break;
  case "leurdocs" : $sql_req .= " AND _panier.panier_cleunik>0 AND f3.uti_cleunik<>$vl_e_uti_cleunik";break;
  case "standard" : $sql_req .= " AND _panier.panier_cleunik<0";break;
  default         : $sql_req .= " AND _panier.panier_cleunik>0 AND _panier.uti_cleunik=-9999";break;
}
$sql_req .= " AND _panier.actif IN($vl_c_actif);";
//die($sql_req);
switch ($vl_c_sortie) {
  case "das":
	$result = _graal_requete_bd($sql_req);
	echo('<donnees>');
	//echo('<donnees sql="'.fa_ent_xml($sql_req).'">');
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
	  echo(' panier_cleunik="'.fa_ent_xml($row['panier_cleunik']).'"');
	  echo(' uti_cleunik="'.fa_ent_xml($row['uti_cleunik']).'"');
	  echo(' panier_titre="'.fa_ent_xml($row['panier_titre']).'"');
	  echo(' prenom="'.fa_ent_xml($row['prenom']).'"');
	  echo(' patronyme="'.fa_ent_xml($row['patronyme']).'"');
	  echo(' dateheurecreation="'.fa_ent_xml($row['dateheurecreation']).'"');
	  $panier_portee=$row['panier_portee'];
	  $prop="";
		switch ($row['panier_type']) {
	    case 1: //  Paniers
			if ($panier_portee & $vl_e_acteur){
				if ($panier_portee & $vl_e_procli){$prop="bg04";}
				if ($panier_portee & $vl_e_client){$prop="bg03";}
				if ($panier_portee & $vl_e_profou){$prop="bg06";}
				if ($panier_portee & $vl_e_fourni){$prop="bg05";}
				if ($panier_portee & $vl_e_autrac){$prop="bg07";}
				if ($panier_portee & $vl_e_actind){$prop="bg08";}
			}
			if ($panier_portee & $vl_e_interl){
				if ($panier_portee & $vl_e_procli){$prop="bh08";}
				if ($panier_portee & $vl_e_client){$prop="bh07";}
				if ($panier_portee & $vl_e_profou){$prop="bh09";}
				if ($panier_portee & $vl_e_fourni){$prop="bi01";}
				if ($panier_portee & $vl_e_autrac){$prop="bi02";}
				if ($panier_portee & $vl_e_actind){$prop="bi03";}
			}


			if ($row['panier_portee']&$vl_e_articl){$prop="bj04";}
			if ($row['panier_portee']&$vl_e_gedged){$prop="ah03";}
			if ($row['panier_portee']&$vl_e_action){$prop="af08";}
			if ($row['panier_portee']&$vl_e_refweb){$prop="ag18";}
/*
	    	switch ($row['panier_portee']) {
	        case 8192 :$prop="bg02";break;  //  Tous les acteurs
	        case 8194 :$prop="bg04";break;  //  prospects clients
	        case 8196 :$prop="bg03";break;  //  clients
	        case 8200 :$prop="bg06";break;  //  Prospects fournisseurs
	        case 8208 :$prop="bg05";break;  //  Fournisseurs
	        case 8224 :$prop="bg07";break;  //  Autres acteurs
	        case 8256 :$prop="bg08";break;  //  Acteurs indéterminés
	        case 1024 :$prop="bj04";break;  //  articles
	        case 16384 :$prop="ah03";break;  //  ged
	        case 2048 :$prop="af08";break;  //  actions
	        case 524288:$prop="ag18";break;  //  courriels
	      }
*/
	      break;
	    case 2: //  Requêtes personnelles
			if ($panier_portee & $vl_e_acteur){
				if ($panier_portee & $vl_e_procli){$prop="bh02";}
				if ($panier_portee & $vl_e_client){$prop="bh01";}
				if ($panier_portee & $vl_e_profou){$prop="bh04";}
				if ($panier_portee & $vl_e_fourni){$prop="bh03";}
				if ($panier_portee & $vl_e_autrac){$prop="bh05";}
				if ($panier_portee & $vl_e_actind){$prop="bh06";}
			}
			if ($panier_portee & $vl_e_interl){
				if ($panier_portee & $vl_e_procli){$prop="bi06";}
				if ($panier_portee & $vl_e_client){$prop="bi05";}
				if ($panier_portee & $vl_e_profou){$prop="bi07";}
				if ($panier_portee & $vl_e_fourni){$prop="bi08";}
				if ($panier_portee & $vl_e_autrac){$prop="bi09";}
				if ($panier_portee & $vl_e_actind){$prop="bj01";}
			}

			if ($row['panier_portee']&$vl_e_articl){$prop="bj03";}
			if ($row['panier_portee']&$vl_e_gedged){$prop="ah03";}
			if ($row['panier_portee']&$vl_e_action){$prop="af08";}
			if ($row['panier_portee']&$vl_e_refweb){$prop="ag18";}

			//$prop=($row['panier_portee'] & $vl_e_procli)."-".$row['panier_portee']."-".$vl_e_procli;
/*
			switch ($row['panier_portee']) {
	        case 8192 :$prop="bg09";break;  //  Tous les acteurs
	        case 8194 :$prop="bh02";break;  //  prospects clients
	        case 8196 :$prop="bh01";break;  //  clients
	        case 8200 :$prop="bh04";break;  //  Prospects fournisseurs
	        case 8208 :$prop="bh03";break;  //  Fournisseurs
	        case 8224 :$prop="bh05";break;  //  Autres acteurs
	        case 8256 :$prop="bh06";break;  //  Acteurs indéterminés
	        case 1024 :$prop="bj03";break;  //  articles
	        case 16384 :$prop="ah03";break;  //  ged
	        case 2048 :$prop="af08";break;  //  actions
	        case 524288:$prop="ag18";break;  //  courriels
	      }
*/
	      break;
	  }
	  echo(' prop="'.$prop.'"');
	  if ($row['actif']==2){
	  	echo(' prop_actif="'.$prop_obsolete.'"');
	  } else {
	  	echo(' prop_actif=""');
	  }
	  echo(' panier_type="'.fa_ent_xml($row['panier_type']).'"');
	  echo(' panier_portee="'.fa_ent_xml($row['panier_portee']).'"');
	  echo('/>');
	}
	echo('</donnees>');
	_graal_libere_requete_bd($result);
	_graal_ferme_connexion();
	break;
case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
