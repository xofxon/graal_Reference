<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
set_time_limit(6000);
$vl_type=fa_recup_param('type','1');
$vl_act_cleunik=fa_recup_param('act_cleunik','1');
$vl_int_cleunik=fa_recup_param('int_cleunik','1');
$vl_typeacteur=fa_recup_param('typeacteur','1');
$vl_t_listecles=fa_recup_param("vs_tempo_panier_lig_cleunik",'');
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close(); 
$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
$o_interlo=new _graal_import();
$o_web=new _graal_import();
$o_fonction=new _graal_import();
$o_interlo->req="INSERT INTO _act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik,prenom) VALUES ";
$o_web->req="INSERT INTO _act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_fonction->req="INSERT INTO _act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$vl_e_i=-1;
foreach($vl_t_listecles as $vl_raf) {
  $vl_e_i++;
  $vl_liste.=$vl_t_listecles[$vl_e_i].',';
}
if ($vl_liste!="") {
  $vl_liste=substr($vl_liste, 0, -1);
}

$vl_e_civilite_defaut=-6;
$vl_e_mail_defaut=-11;
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
$i=0;$i1=500;
$sql_req = "select `imp_cleunik`,`lig_cleunik`,`refweb`,`nom`,`prenom`,`valide`,`emailing` FROM _w_import_courriel_ligne WHERE lig_cleunik IN($vl_liste)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $i++;
  $patronyme=fa_nt($row['nom']);
  $prenom=fa_nt($row['prenom']);
  $refweb=fa_nt(str_replace(' ', '', $row['refweb']));
  $valide=$row['valide'];
  $veuxpasdemail=$row['emailing'];
  $uuid=_graal_requete_uuid();
  switch ($vl_type) {
    case "1": //  création d'interlocuteurs
      $vf_e_int_cleunik++;
      $o_interlo->dat.="($vf_e_int_cleunik,'Lui01',$vl_act_cleunik,$patronyme,2,$vl_e_civilite_defaut,$prenom),";
      $vf_e_intweb_cleunik++;
      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,$refweb,$veuxpasdemail,1,1,$vl_act_cleunik,$vl_e_mail_defaut,$valide,'$uuid'),";
      $o_fonction->dat.="($vl_act_cleunik,$vf_e_int_cleunik,-7,92,$vl_typeacteur,0),";
      break;
    case "2": //  Création d'adresses de courriel
      $vf_e_intweb_cleunik++;
      $o_web->dat.="($vf_e_intweb_cleunik,$vl_int_cleunik,$refweb,$veuxpasdemail,1,1,$vl_act_cleunik,$vl_e_mail_defaut,$valide,'$uuid'),";
      break;
  }
  if ($i % $i1==0){
    $o_interlo->execute();
    $o_web->execute();
    $o_fonction->execute();
  }
}
$o_interlo->execute();
$o_web->execute();
$o_fonction->execute();
_graal_libere_requete_bd($result);
switch ($vl_type) {
  case "1": echo("$i interlocuteurs et adresses courriels créés.");break;
  case "2": echo("$i adresses courriels créées.");break;
}
?>
