<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','fournisseur');
$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_fax_defaut=intval(fa_recup_param('vl_e_fax_defaut','-10'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_fax_defaut=intval(fa_recup_param('vl_e_indicatif_fax_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vl_e_genre_acteur_defaut=intval(fa_recup_param('vl_e_genre_acteur_defaut','-5'));
$vl_e_critere_cleunik_famille=intval(fa_recup_param('vl_e_critere_cleunik_famille','0'));
$vl_e_critere_cleunik_site=intval(fa_recup_param('vl_e_critere_cleunik_site','0'));
include("_import_apisoft_sp_array_pays.php");
include("_import_apisoft_sp_array_devises.php");
include("_import_apisoft_sp_array_compta.php");
include("_import_apisoft_sp_array_fam.php");
switch ($vl_c_fic_tiers){
  case "fournisseur":
    $vf_e_typeacteur=110004;
    break;
  case "prospect_fournisseur":
    break;
}
include("_import_class_data_km.php");
$sql_req = "SELECT Code as 'Code',Nom as 'Nom',Civilite as 'Civilite',Adresse as 'Adresse',SuiteAdresse as 'SuiteAdresse',CP as 'CP',Ville as 'Ville',Pays as 'Pays',Devise as 'Devise',Telephone as 'Telephone',Fax as 'Fax',Portable as 'Portable',EMail as 'EMail',Correspondant as 'Correspondant',Compte as 'Compte',CategorieAchat as 'CategorieAchat',PRemise as 'PRemise',PEscompte as 'PEscompte',ModeReg as 'ModeReg',FamilleFou as 'FamilleFou',Franco as 'Franco',MinCde as 'MinCde',DateCreation as 'DateCreation',DateModification as 'DateModification',Note as 'Note',MontantEnCours as 'MontantEnCours',DelaiLivr as 'DelaiLivr',MontantPort as 'MontantPort',SeuilFranco as 'SeuilFranco',MontantMin as 'MontantMin',Reference as 'Reference',CompteBloque as 'CompteBloque',AssujettiTPF as 'AssujettiTPF',NParamDevis as 'NParamDevis',NParamCde as 'NParamCde',NParamBR as 'NParamBR',NParamRenvois as 'NParamRenvois',NParamFacture as 'NParamFacture',NExDevis as 'NExDevis',NExCde as 'NExCde',NExBR as 'NExBR',NExRenvois as 'NExRenvois',NExFacture as 'NExFacture',Domiciliation as 'Domiciliation',Etablissement as 'Etablissement',Guichet as 'Guichet',CompteBanque as 'CompteBanque',CleRib as 'CleRib',CA as 'CA',FraisFacturation as 'FraisFacturation',SiteInternet as 'SiteInternet',BIC as 'BIC',IBAN as 'IBAN'  FROM $vl_c_base_origine.$vl_c_fic_tiers where Code not in (select codealphanum15 from $vl_c_base_destination._acteurs where typeacteur=$vf_e_typeacteur) order by Code";
$o_acteur=new _graal_import();
$o_compta=new _graal_import();
$o_choix=new _graal_import();
$o_adresses=new _graal_import();
$o_interlo=new _graal_import();
$o_web=new _graal_import();
$o_fax=new _graal_import();
$o_tel=new _graal_import();
$o_rib=new _graal_import();
$o_fonction=new _graal_import();
$o_sit=new _graal_import();
$o_acteur->req="INSERT INTO $vl_c_base_destination._acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,blocnotebrut,blocnotertf,dateheuremodif,dateheurecreation,typeacteur,c_uuid,mnemotechnique,devise) VALUES ";
//  Attention, mode de règlement traité plus bas
$o_compta->req="INSERT INTO $vl_c_base_destination._act_compta (act_cleunik,compte,catcompta_cleunik,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,assujetti_tpf,montant_port,seuil_franco,commande_mini) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_adresses (adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik) VALUES ";
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_fax->req="INSERT INTO $vl_c_base_destination._act_interlo_fax (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik,portable,sms) VALUES ";
$o_rib->req="INSERT INTO $vl_c_base_destination._act_rib (rib_cleunik,Domiciliation,Etablissement,Guichet,Compte,Cle,act_cleunik,Principal) VALUES ";
$o_fonction->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$o_sit->req="INSERT INTO $vl_c_base_destination._act_sites(site_cleunik,refweb,act_cleunik,choix_cleunik) VALUES ";
$vf_e_act_cleunik=_graal_requete_max("act_cleunik","$vl_c_base_destination._acteurs");
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_adresses");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_fax_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_fax");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$vf_e_sit_cleunik=_graal_requete_max("site_cleunik","$vl_c_base_destination._act_sites");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
session_write_close();
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
//  Ajout dans la table des acteurs
  $vf_e_act_cleunik++;
  $i++;
  $codealphanum15=$row['Code'];
  $raisonsoc=addslashes($row['Nom']);
  $nomcommercial=addslashes($row['Nom']);
  $blocnotebrut=addslashes($row['Note']);
  $blocnotertf=addslashes($row['Note']);
  $dateheuremodif=$row['DateModification'];
  $dateheurecreation=$row['DateCreation'];
  $typeacteur=$vf_e_typeacteur;
  $uuid=_graal_requete_uuid();
  $mnemotechnique=addslashes($row['Codealpha']);
  $vl_e_trouve_devise=array_search($row['Devise'], $devise_cod);if ($vl_e_trouve_devise===false) {$devise=122047;} else {$devise=$devise_cle[$vl_e_trouve_devise];}
  $o_acteur->dat.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial','$blocnotebrut','$blocnotertf','$dateheuremodif','$dateheurecreation',$typeacteur,'$uuid','$mnemotechnique',$devise),";
  $vl_e_trouve_compta=array_search($row['CategorieAchat'], $compta_cod);if ($vl_e_trouve_compta===false) {$vl_e_catcompta_cleunik=-1;} else {$vl_e_catcompta_cleunik=$compta_cle[$vl_e_trouve_compta];}
  $vl_e_tarif_cleunik=-33;
  $remise_taux=$row['PRemise'];$escompte_taux=$row['PEscompte'];$compte=$row['Compte'];
  $assujetti_tpf=$row['AssujettiTPF'];
  if ($assujetti_tpf==-1){$assujetti_tpf=1;} else {$assujetti_tpf=2;}
  $montant_port=$row['MontantPort'];
  $seuil_franco=$row['SeuilFranco'];
  $commande_mini=$row['MontantMin'];
  $o_compta->dat.="($vf_e_act_cleunik,'$compte',$vl_e_catcompta_cleunik,$vl_e_tarif_cleunik,$remise_taux,1,2,$escompte_taux,1,1,$assujetti_tpf,$montant_port,$seuil_franco,$commande_mini),";
  if ($vl_e_critere_cleunik_famille!=0){
    $vl_e_trouve_fam=array_search($row['FamilleFou'], $fam_cod);if ($vl_e_trouve_fam===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$fam_cle[$vl_e_trouve_fam];}
    if ($vl_e_choix_cleunik!=0) {
      //  Alimentation des familles fournisseurs
      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik_famille,$vf_e_typeacteur),";
    }
  }
  //  Alimentation Genre d'acteur
  $o_choix->dat.="($vf_e_act_cleunik,$vl_e_genre_acteur_defaut,80,$vf_e_typeacteur),";
/*
//  Ajout dans la table des _acteurs_soundex_fr pour la recherche phonétique française
//  Ne fonctionne pas !!!! à fouiller
      $sql_req_ins = "INSERT INTO _acteurs_soundex_fr set act_cleunik=$vf_e_act_cleunik,raisonsoc='".soundex2($row['raisonsoc']) ."',nomcommercial='".soundex2($row['nomcommercial'])."'";
      $result_ins = _graal_requete_bd($sql_req_ins);
      if($result_ins === false)
      {
          $vf_c_echo=mysql_error($cnx) . $sql_req_ins;
      }
        else
          $vf_c_echo='ok';
*/
//  Ajout dans la table des _act_adresses (adresses au format français) des adresses          
//  Ajout dans la table des _act_adresses (adresses au format français) des adresses de facturation          
  $vl_c_chaine=trim($row['Adresse'].$row['SuiteAdresse'].$row['Cp'].$row['Ville']);
  //  On ajoute uniquement si l'adresse est un minimum renseignée
  if ($vl_c_chaine!="") {
    $vl_e_cleunik_pays=60000;
    $vf_e_adr_cleunik++;
    $adr_complementnom=addslashes($row['Nom']);
    $adr_ligne1=addslashes($row['Adresse']);
    $adr_ligne2=addslashes($row['SuiteAdresse']);
    $adr_cp=addslashes($row['CP']);
    $adr_ville=addslashes($row['Ville']);
    $o_adresses->dat.="($vf_e_adr_cleunik,'Adr01',$vf_e_act_cleunik,'$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_cp','$adr_ville',$vl_e_cleunik_pays,1),";
  }
  //  Ajout dans la table des _act_rib (Relevés d'identité bancaire des acteurs)
  $vl_c_chaine=trim($row['Domiciliation'].$row['Etablissement'].$row['Guichet'].$row['CompteBanque'].$row['CleRib']);
  //  On ajoute uniquement si lE rib est un minimum renseigné on ne vérifie pas la viabilité du RIB
  if ($vl_c_chaine!="") {
    $vf_e_rib_cleunik++;
    $Domiciliation=addslashes($row['Domiciliation']);
    $Etablissement=addslashes($row['Etablissement']);
    $Guichet=addslashes($row['Guichet']);
    $Compte=addslashes($row['Compte']);
    $Cle=addslashes($row['Cle']);
    $o_rib->dat.="($vf_e_rib_cleunik,'$Domiciliation','$Etablissement','$Guichet','$Compte','$Cle',$vf_e_act_cleunik,1),";
  }
  
	$vl_c_chaine=trim($row['SiteInternet']);
    //  On ajoute uniquement si le site de facturation est renseigné
    if ($vl_c_chaine!=""){
      $vf_e_sit_cleunik++;
      $refweb=addslashes($row['SiteInternet']);
      $o_sit->dat.="($vf_e_sit_cleunik,'$refweb',$vf_e_act_cleunik,$vl_e_critere_cleunik_site),";
    }
    $vl_c_chaine=trim($row['Telephone'].$row['Fax'].$row['Portable'].$row['EMail'].$row['Correspondant']);
  $vl_c_liv=$vl_c_chaine;
  //  On ajoute uniquement si le correspondant est un minimum renseigné
  if ($vl_c_chaine!=""){
    $vf_e_int_cleunik++;
    $patronyme=addslashes($row['Correspondant']);
    $o_interlo->dat.="($vf_e_int_cleunik,'Lui01',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
    $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,-7,92,$vf_e_typeacteur,0),";
    $vl_c_chaine=trim($row['EMail']);
    //  On ajoute uniquement si le mail de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vf_e_intweb_cleunik++;
      $refweb=addslashes($row['EMail']);
      $uuid=_graal_requete_uuid();
      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
    }
    $vl_c_chaine=trim($row['Fax']);
    //  On ajoute uniquement si le fax de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine); 
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_fax_cleunik++;
      $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
    }
    $vl_c_chaine=trim($row['Telephone']);
    //  On ajoute uniquement si le téléphone de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_tel_cleunik++;
      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
    }
    $vl_c_chaine=trim($row['Portable']);
    //  On ajoute uniquement si le téléphone portable de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_tel_cleunik++;
      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut,2,2),";
    }
  }
  if ($i % $i1==0){
    $o_acteur->execute();
    echo $o_compta->req.$o_compta->dat.EOL;
    $o_compta->execute();
    $o_choix->execute();
    $o_adresses->execute();
    $o_rib->execute();
    $o_interlo->execute();
    $o_web->execute();
    $o_fax->execute();
    $o_tel->execute();
    $o_fonction->execute();
    $o_sit->execute();
  }
}
echo $o_compta->req.$o_compta->dat.EOL;
$o_acteur->execute();
$o_compta->execute();
$o_choix->execute();
$o_adresses->execute();
$o_rib->execute();
$o_interlo->execute();
$o_web->execute();
$o_fax->execute();
$o_tel->execute();
$o_fonction->execute();
$o_sit->execute();
_graal_libere_requete_bd($result);
$sql_req="update $vl_c_base_destination._act_compta c0,$vl_c_base_destination._modereg c1,$vl_c_base_origine.fournisseur c2,$vl_c_base_destination._acteurs c3 set c0.reg_cleunik=c1.reg_cleunik where c1.codealphanum15=c2.ModeReg and c3.codealphanum15=c2.Code and c0.act_cleunik=c3.act_cleunik and c3.typeacteur=$vf_e_typeacteur;"; // maj mode de règlement des fournisseurs
$result = _graal_requete_bd($sql_req);
//  Mise à jour des comptes comptables
$sql_req="select compte,raisonsoc,_act_compta.act_cleunik from _act_compta,_acteurs where _act_compta.act_cleunik=_acteurs.act_cleunik and compte is not null and compte <>'' and compte not in (select distinct code from _param_pc)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","_param_pc");
  $code=addslashes($row['compte']);
  $intitule=addslashes($row['raisonsoc']);
  $act_cleunik=$row['act_cleunik'];
  $sql_req_02 = "insert into _param_pc (pc_cleunik,code,intitule,actif) VALUES ($vf_e_pc_cleunik,'$code','$intitule',1);";
  _graal_exec_requete($sql_req_02);
  $sql_req_03 = "update _act_compta set pc_cleunik=$vf_e_pc_cleunik where act_cleunik=$act_cleunik;";
  _graal_exec_requete($sql_req_03);
}
_graal_libere_requete_bd($result);
$sql_req="update _act_compta f1 left join _param_pc f3 on f1.compte=f3.code set f1.pc_cleunik=f3.pc_cleunik;";
_graal_exec_requete($sql_req);
echo("$i fournisseurs importés.");
?>
