<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_numerotation.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_actions_bordereau_expedition_01";
fa_acces_script();
$vf_c_action=fa_recup_param("vf_c_action","??????");
//	Variables pour création
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_transp_cleunik=intval(fa_recup_param('vl_e_transp_cleunik','0'));
$vl_c_liste_cle=fa_recup_param("vl_c_liste_cle","");
switch (TRUE) {
	case $vf_c_action=="ajouter":
		$vl_c_liste_cle=unserialize(stripslashes($vl_c_liste_cle));
		$req_action="INSERT INTO _actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurecreation,sujet,c_uuid,reference,statut) VALUES ";
		$req_fa_ent="INSERT INTO _bordereau_transporteurs(action_cleunik,bordereau_cleunik,act_cleunik_trans,code) VALUES ";
		$req_fa_lig="INSERT INTO _bordereau_transporteurs_lignes(bordereau_ligne_cleunik,bordereau_cleunik,ligne_cleunik,commercial_cleunik,action_cleunik) VALUES ";
		$vf_e_choix_cleunik_doc=-110131;
		$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $vl_uuid=_graal_requete_uuid();
    $statut=-23;  //  En cours
    $code=_graal_numerote(13);//  Numérotation automatique
    $vf_c_retour="";
    //  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
		$vl_c_chaine=addslashes("Bordereau d'expédition ".$code);
    //  Ajout action
    $req_action.="($vl_action_cleunik,$vf_e_choix_cleunik_doc,now(),now(),'$vl_c_chaine','$vl_uuid','$code',$statut)";
    $vf_c_echo=_graal_exec_requete($req_action);
    if($vf_c_echo=='ok') {
      //  Ajout entête
			$vl_bordereau_cleunik=_graal_requete_max("bordereau_cleunik","_bordereau_transporteurs");
			$req_graal = "INSERT INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `portee`, `principal`) VALUES ($vl_e_transp_cleunik,0,$vl_action_cleunik,-110428,8192,2);";
	        $vf_c_echo=_graal_exec_requete($req_graal);
	        if($vf_c_echo!='ok') {$vf_c_retour=-0;}

			$req_fa_ent.="($vl_action_cleunik,$vl_bordereau_cleunik,$vl_e_transp_cleunik,'$code');";
			if(_graal_exec_requete($req_fa_ent)!="ok")  {$vf_c_retour=-2;}
			$vl_bordereau_ligne_cleunik=_graal_requete_max("bordereau_ligne_cleunik","_bordereau_transporteurs_lignes");
			$vl_e_i=-1;
			foreach($vl_c_liste_cle as $vl_raf) {
				$vl_e_i++;
				$sql_req_01 = "SELECT commercial_cleunik,act_cleunik FROM _livcli_entetes where action_cleunik=$vl_c_liste_cle[$vl_e_i];";
				$result_01 = _graal_requete_bd($sql_req_01);
				$row_01 = mysql_fetch_assoc($result_01);
				$commercial_cleunik=fa_nn($row_01['commercial_cleunik']);
				$act_cleunik=fa_nn($row_01['act_cleunik']);
				_graal_libere_requete_bd($result_01);
				$noligne=$vl_bordereau_ligne_cleunik+$vl_e_i;
				if ($vl_e_i==0) {$req_fa_lig.="";} else {$req_fa_lig.= ",";}
				$req_fa_lig.="($noligne,$vl_bordereau_cleunik,1,$commercial_cleunik,$vl_c_liste_cle[$vl_e_i])";
				$req_graal = "INSERT IGNORE INTO _graal (`act_cleunik`, `int_cleunik`, `action_cleunik`, `choix_cleunik`, `portee`, `principal`) VALUES ($act_cleunik,0,$vl_action_cleunik,-110410,8192,2);";
	        	if(_graal_exec_requete($req_graal)!="ok")  {$vf_c_retour=-0;}
				$req_graal_act=" INSERT INTO _graal_act (`action_cleunik_gauche`, `action_cleunik_droite`, `choix_cleunik_droite`, `choix_cleunik_gauche`) VALUES ($vl_c_liste_cle[$vl_e_i],$vl_action_cleunik,-117,-143);";
      			if(_graal_exec_requete($req_graal_act)!="ok")  {$vf_c_retour=-4;}

			}
			if(_graal_exec_requete($req_fa_lig)!="ok")  {$vf_c_retour="-3 $req_fa_lig";}
		} else {
			$vf_c_retour="-1";
		}
		//  Fin de la transaction
	    if ($vf_c_retour=="") {
	     	$vf_c_retour=$vl_action_cleunik;
	      _graal_requete_bd("COMMIT;");
	    } else {
	      //$vf_c_retour.=$vf_c_echo;
			$vf_c_echo=_graal_exec_requete("delete from _actions_texte where action_cleunik=$vl_action_cleunik;");
	      _graal_requete_bd("ROLLBACK;");
	    }
		echo $vf_c_retour;
		break;
	default:
		echo $vf_c_action;
		break;
}
?>