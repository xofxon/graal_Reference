<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
//  Pour le même nombre d'enregristrements (9260), test fait le 2 février 2007 
//  _import_apisoft_tarifs_articles_02.php : 6''' (6 secondes)
//  _import_apisoft_tarifs_articles_01.php : 4' 20''' (4 minutes 20 secondes) (code en fin de celui-ci) 
define('EOL', "\r\n");
set_time_limit(6000);
echo(date("D M j G:i:s T Y").EOL);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_fla_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_frla');
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik',''));
$art_cod=array();$art_cle=array();$tar_cod=array();$tar_cle=array();
$sql_req="select choix_cleunik,choix_code from _choix where critere_cleunik=$vl_e_critere_cleunik;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($tar_cod, $row['choix_code']);
  array_push ($tar_cle, $row['choix_cleunik']);
}
_graal_libere_requete_bd($result);  
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeArticle) from $vl_c_base_origine.tarif)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);
$o_tarif=new _graal_import();
$o_tarif->req="INSERT INTO $vl_c_base_destination._art_tarifs (tar_cleunik,art_cleunik,act_cleunik,tarif_cleunik,pu_reference,actif,type,quantite_haute,unite_quantite) VALUES ";
$tar_cleunik=_graal_requete_max("tar_cleunik","$vl_c_base_destination._art_tarifs");
/*
 * 1° passage : les tarifs de type PU, sans référence à une grille
 */
$sql_req = "SELECT CodeArticle as `CodeArticle`,CodeTarif as `CodeTarif`,Mode as `Mode`,ValeurArrondi as `ValeurArrondi`,ModeArrondi as `ModeArrondi`,Coefficient as `Coefficient`,Prix as `Prix`,CodeGrille as `CodeGrille` FROM $vl_c_base_origine.tarif where CodeGrille=0 and CodeArticle in (select f1.code from $vl_c_base_destination._article f1 where f1.art_cleunik not in (select f2.art_cleunik from $vl_c_base_destination._art_tarifs f2)) order by CodeArticle;";
$result=_graal_requete_bd($sql_req);
$i=0;$b=500;
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_trouve=array_search($row['CodeArticle'], $art_cod);if ($vl_e_trouve===false) {$art_cleunik=0;} else {$art_cleunik=$art_cle[$vl_e_trouve];}
  if ($art_cleunik!=0) {
    $vl_e_trouve=array_search($row['CodeTarif'], $tar_cod);if ($vl_e_trouve===false) {$tarif_cleunik=0;} else {$tarif_cleunik=$tar_cle[$vl_e_trouve];}
    if ($tarif_cleunik!=0) {
      $i++;
      
      //	Attention au type de tarif achat ou ventes !!! Ca a foutu le bouzin chez france lampes : tous les tarifs étaient considérés comme ventes !! aucun comme achat !!
      
      $o_tarif->dat.="($tar_cleunik,$art_cleunik,0,$tarif_cleunik,".$row['Prix'].",1,1,0,1),";
    }
  }
  if ($i % $b==0){
    $o_tarif->execute();
  }
  $tar_cleunik++;
}
$o_tarif->execute();
$i1=$i;
/*
 * 2° passage : les tarifs de type sur quantité, avec référence à une grille
 */
$sql_req = "SELECT f1.CodeArticle as `CodeArticle`,f1.CodeTarif as `CodeTarif`,f1.Mode as `Mode`,f1.ValeurArrondi as `ValeurArrondi`,f1.ModeArrondi as `ModeArrondi`,f1.Coefficient as `Coefficient`,f1.Prix as `Prix`,f1.CodeGrille as `CodeGrille`, f2.`Code` as `Code`,f2.`Borne` as `Borne`,f2.`Valeur` as `Valeur` FROM $vl_c_base_origine.tarif f1 left join $vl_c_base_origine.grilletarif f2 on f1.CodeGrille=f2.`Code` where CodeGrille<>0 and CodeArticle in (select f1.code from $vl_c_base_destination._article f1 where f1.art_cleunik not in (select f2.art_cleunik from $vl_c_base_destination._art_tarifs f2)) order by CodeArticle;";
$result=_graal_requete_bd($sql_req);
$i=0;$b=500;
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_trouve=array_search($row['CodeArticle'], $art_cod);if ($vl_e_trouve===false) {$art_cleunik=0;} else {$art_cleunik=$art_cle[$vl_e_trouve];}
  if ($art_cleunik!=0) {
    $vl_e_trouve=array_search($row['CodeTarif'], $tar_cod);if ($vl_e_trouve===false) {$tarif_cleunik=0;} else {$tarif_cleunik=$tar_cle[$vl_e_trouve];}
    if ($tarif_cleunik!=0) {
      $i++;
      $o_tarif->dat.="($tar_cleunik,$art_cleunik,0,$tarif_cleunik,".$row['Valeur'].",1,1,".$row['Borne'].",-1),";
    }
  }
  if ($i % $b==0){
    $o_tarif->execute();
  }
  $tar_cleunik++;
}
//echo $o_tarif->req.$o_tarif->dat.EOL;
$o_tarif->execute();

_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($i+$i1.' tarifs ajoutés.'.EOL);
echo(date("D M j G:i:s T Y").EOL);
?>
