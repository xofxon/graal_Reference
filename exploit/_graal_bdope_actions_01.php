<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
$vf_c_action=fa_recup_param('vf_c_action','??????');
$vl_action_cleunik=intval(fa_recup_param('vl_action_cleunik','-1'));
$vl_blocnotebrut=fa_recup_param('vl_blocnotebrut','');
$vl_description=fa_recup_param('vl_description','');
$vl_dat_deb=fa_recup_param('vl_dat_deb','');
$vl_dat_fin=fa_recup_param('vl_dat_fin','');
$vl_lieu=fa_recup_param('vl_lieu','');
$vl_genre=intval(fa_recup_param('vl_genre',''));
$vl_statut=intval(fa_recup_param('vl_statut',''));
$vl_confidentialite=intval(fa_recup_param('vl_confidentialite',''));
$vl_priorite=intval(fa_recup_param('vl_priorite',''));
$vl_sujet=fa_recup_param('vl_sujet','');
$vl_reference=fa_recup_param('vl_reference','');
$vl_action_type=1;
$vl_int_cleunik=intval(fa_recup_param('vl_int_cleunik','-1'));
$vl_act_cleunik=intval(fa_recup_param('vl_act_cleunik','-1'));
$vl_action_cleunik_liee=intval(fa_recup_param('vl_action_cleunik_liee','-1'));
$vl_gestion_duree=intval(fa_recup_param('vl_gestion_duree','2'));
$vf_c_delai_alerte=fa_recup_param('vf_c_delai_alerte','1');
$vl_tb_reg_00010=_graal_requete_regle("Reg_00010"); //  Relier automatiquement l'utilisateur créateur de l'action
$vf_c_echo='';
switch (TRUE) {


	case $vf_c_action=='dupliquer':
		$vl_action_cleunik_alerte=_graal_requete_max("action_cleunik","_actions");
    	$sql_req = "INSERT INTO _actions select $vl_action_cleunik_alerte, choix_cleunik, '$vl_dat_deb','$vl_dat_fin', now(), now(), blocnote_brut, blocnote_riche,";
    	$sql_req.= " position, description, c_uuid, action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, sujet, reference, gestion_duree ";
    	$sql_req.= " from _actions where action_cleunik=$vl_action_cleunik ";
	    $vf_c_echo=_graal_exec_requete($sql_req);
	    if($vf_c_echo=='ok') {
			$sql_req = "INSERT INTO _graal select act_cleunik,int_cleunik,$vl_action_cleunik_alerte,choix_cleunik,blocnotebrut,blocnotertf,portee,principal from _graal where action_cleunik=$vl_action_cleunik;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			$sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_alerte,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
			_graal_exec_requete($sql_req);
			$vf_c_echo="Action dupliquée ...";
		} else {
			$vf_c_echo="-1".$sql_req;
		}
		break;



	case $vf_c_action=='modifier':
    $sql_req = "UPDATE _actions set choix_cleunik=$vl_genre,dateheuremodif=now(),blocnote_brut='$vl_blocnote_brut',description='$vl_description',lieu='$vl_lieu',confidentialite=$vl_confidentialite,priorite=$vl_priorite,statut=$vl_statut,sujet='$vl_sujet',reference='$vl_reference',gestion_duree=$vl_gestion_duree";
    if ($vl_dat_deb!='') {$sql_req.=",dateheuredebut='$vl_dat_deb'";}
    if ($vl_dat_fin!='') {$sql_req.=",dateheurefin='$vl_dat_fin'";}
    $sql_req.=" where action_cleunik=$vl_action_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_action_cleunik;} else {$vf_c_echo=-1;}
		break;
  case $vf_c_action=='ajouter':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_genre,dateheurecreation=now(),blocnote_brut='$vl_blocnote_brut',description='$vl_description',c_uuid=(select uuid()),action_type=$vl_action_type,lieu='$vl_lieu',confidentialite=$vl_confidentialite,priorite=$vl_priorite,statut=$vl_statut,sujet='$vl_sujet',reference='$vl_reference',gestion_duree=$vl_gestion_duree";
    if ($vl_dat_deb!='') {$sql_req.=",dateheuredebut='$vl_dat_deb'";}
    if ($vl_dat_fin!='') {$sql_req.=",dateheurefin='$vl_dat_fin'";}
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
    	$vf_c_echo=$vl_action_cleunik;
		pf_ajoute_auteur();
	} else {
		$vf_c_echo=-1;
	}
    break;
    case $vf_c_action=='alerter':
		$vl_action_cleunik_alerte=_graal_requete_max("action_cleunik","_actions");
		switch ($vf_c_delai_alerte){
			case 1:
				$expression_date=" adddate(dateheuredebut,-1),adddate(dateheuredebut,-1)";
				break;
			default:
				$expression_date=" dateheuredebut,dateheurefin";
				break;
		}
    	$sql_req = "INSERT INTO _actions select $vl_action_cleunik_alerte, -110139, $expression_date, now(), now(), blocnote_brut, blocnote_riche,";
    	$sql_req.= " position, description, c_uuid, action_type, lieu, confidentialite, priorite, statut, dateheureprevue, realisation, sujet, reference, gestion_duree ";
    	$sql_req.= " from _actions where action_cleunik=$vl_action_cleunik ";
	    $vf_c_echo=_graal_exec_requete($sql_req);
	    if($vf_c_echo=='ok') {
			$sql_req = "INSERT INTO _graal select act_cleunik,int_cleunik,$vl_action_cleunik_alerte,choix_cleunik,blocnotebrut,blocnotertf,portee,principal from _graal where action_cleunik=$vl_action_cleunik;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			$sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_alerte,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
			_graal_exec_requete($sql_req);
			$vf_c_echo=$vl_action_cleunik_alerte;
		} else {
			$vf_c_echo="-1".$sql_req;
		}
		break;
	case $vf_c_action=='ajouter_post_it':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110130,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1,description='$vl_description',sujet='$vl_sujet';";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_action_cleunik;
		if ($vl_int_cleunik!=-1){
	      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110437,portee=$vl_e_interl,principal=2;";
	      _graal_exec_requete($sql_req);
			}
      $vl_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  $vl_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110436,portee=$vl_e_interl,principal=1;";
      _graal_exec_requete($sql_req);
      if ($vl_action_cleunik_liee!=0) {
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_liee,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
        _graal_exec_requete($sql_req);
      }
    } else {
      $vf_c_echo=-1;
    }
    break;
  case $vf_c_action=='ajouteremitel':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110107,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_action_cleunik;
			if ($vl_int_cleunik!=-1){
	      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110405,portee=$vl_e_interl,principal=2;";
	      _graal_exec_requete($sql_req);
			}
      $vl_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  $vl_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110406,portee=$vl_e_interl,principal=1;";
      _graal_exec_requete($sql_req);
      if ($vl_action_cleunik_liee!=0) {
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_liee,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
        _graal_exec_requete($sql_req);
      }
    } else {
      $vf_c_echo=-1;
    }
    break;
  case $vf_c_action=='lielambda':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110100,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_action_cleunik;
	  pf_ajoute_auteur();
      if ($vl_action_cleunik_liee!=0) {
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_liee,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
        _graal_exec_requete($sql_req);
      }
    } else {
      $vf_c_echo=-1;
    }
    break;
  case $vf_c_action=='ajouterrectel':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110106,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1,gestion_duree=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_action_cleunik;
	  $vl_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  $vl_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110407,portee=$vl_e_interl,principal=1;";
      _graal_exec_requete($sql_req);
    } else {
      $vf_c_echo=-1;
    }
    break;
  case $vf_c_action=='ajouterchat':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $blocnote_riche='Texte de la conversation';
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110118,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1,blocnote_riche='$blocnote_riche',gestion_duree=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      //  On attache éventuellement l'interlocuteur, si on en a spécifié un. C'est alors l'interlocuteur principal
      if ($vl_int_cleunik!=-1) {
        $sql_req="SELECT act_cleunik as act_cleunik FROM _act_interlo where int_cleunik=$vl_int_cleunik";
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        $vl_act_cleunik=fa_ent_xml($row['act_cleunik']);
        _graal_libere_requete_bd($result);
        $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110416,portee=$vl_e_interl,principal=2;";
        _graal_exec_requete($sql_req);
      }
      $vl_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  $vl_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110416,portee=$vl_e_interl;";
      _graal_exec_requete($sql_req);
			if ($vl_action_cleunik_liee!=0) {
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_liee,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
        _graal_exec_requete($sql_req);
      }

      $vf_c_echo=$vl_action_cleunik;
    } else {
      $vf_c_echo=-1;
    }
    break;

  case $vf_c_action=='ajouteracteur':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110100,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_action_cleunik;
	  pf_ajoute_auteur();
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=0,act_cleunik=$vl_act_cleunik,choix_cleunik=-110402,portee=$vl_e_acteur,principal=2;";
      _graal_exec_requete($sql_req);
    } else {
      $vf_c_echo=-1;
    }
    break;
  case $vf_c_action=='ajouterinterl':
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110100,dateheurecreation=now(),dateheuredebut=now(),c_uuid=(select uuid()),action_type=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_action_cleunik;
	  pf_ajoute_auteur();
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110402,portee=$vl_e_interl,principal=2;";
      _graal_exec_requete($sql_req);
    } else {
      $vf_c_echo=-1;
    }
    break;
	case $vf_c_action=="bascule_recmail_retour_erreur":
		$sql_req = "UPDATE _actions set choix_cleunik=-110104 WHERE action_cleunik = $vl_action_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
		if($vf_c_echo=='ok') {$vf_c_echo=$vl_action_cleunik;} else {$vf_c_echo=-1;}
		break;
	case $vf_c_action=='supprimer':
    if ($vl_action_cleunik==0) {exit;}
    $sql_req = "DELETE FROM _actions WHERE action_cleunik = $vl_action_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='??????':
    exit;
    break;
}
/*
//  Faute de mieux parce qu'il n'est pas possible de l'intégrer dans un trigger
DROP TRIGGER `TGRBI_actions`;
DELIMITER //
CREATE TRIGGER `TGRBI_actions` BEFORE INSERT ON `_actions`
 FOR EACH ROW BEGIN
	delete from _actions_texte where action_cleunik not in(select action_cleunik from _actions);
END
La requête a échoué. -> Can't update table '_actions' in stored function/trigger because it is already used by statement which invoked this stored function/trigger.
*/
/*
 * $sql_req = "delete from _actions_texte where action_cleunik not in(select action_cleunik from _actions);";
 * Requête remplacée le 8 janvier 2009
 * http://www.developpez.net/forums/d662438/bases-donnees/mysql/requetes/optimisation-delete/
*/
$sql_req="DELETE f1
FROM _actions_texte f1
INNER JOIN _actions f2 ON f1.action_cleunik = f2.action_cleunik
WHERE f2.action_cleunik is null;";
/*
 * il semblerait que la première requête ne soit pas opérationnelle ... constaté sur base EPAC le 16 mai 2010
 */
$sql_req="DELETE f1 FROM _actions_texte f1 where description is null or description=''";
_graal_exec_requete($sql_req);
_graal_ferme_connexion();
echo $vf_c_echo;
function pf_ajoute_auteur(){
	global $vl_tb_reg_00010;
	global $vl_e_interl;
	global $vl_action_cleunik;
	if ($vl_tb_reg_00010[0]==1) {
		//	On ajoute l'utilisateur comme auteur de l'action (soumis à règle reg_00010)
      $vl_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  $vl_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110435,portee=$vl_e_interl,principal=1;";
      _graal_exec_requete($sql_req);
	}
}
?>
