<?php
set_time_limit(300);
require_once ('calc/classes/OpenOfficeSpreadsheet.class.php');
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
$vl_c_nom_fichier_ods=fa_recup_param('vl_c_nom_fichier_ods','excellenttableur.ods');
$query=fa_recup_telquel('vl_c_requete','select now(),1');
//$query=fa_recup_param('vl_c_requete','select now(),2');
$calc = new OpenOfficeSpreadsheet($vl_c_nom_fichier_ods);
////$calc = new OpenOfficeSpreadsheet('essai.ods');
$sheet = $calc->addSheet('Exportation');

if ($query=='') die('Error: SQL command must be provided');

//die($query);

$command = strtolower(substr($query,0,strpos($query,' ')));
//if (strpos('select,show,describe',$command)===false) die('Error: Only SELECT/SHOW/DESCRIBE is allowed');
if (strpos('delete,insert,delete,truncate,drop',$command)===true) die('Error: Only SELECT/SHOW/DESCRIBE is allowed');
$connection = mysql_connect($sql_serveur,$sql_user,$sql_passwd) or die('Error: Could not connect to server - ' . mysql_error());
$result = mysql_query("SET CHARACTER SET 'utf8';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$result = mysql_query("SET collation_connection = 'utf8_general_ci';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$result = mysql_query($query,$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$nfields = mysql_num_fields($result);
$vl_e_noligne=1;
//  Lecture des colonnes
for ($i=0; $i<$nfields; $i++){    
  $fieldname = mysql_field_name($result, $i);
  $cell = $sheet->getCell( $i,$vl_e_noligne);
  $cell->setContent($fieldname);
}
//  Lecture des résultats de la requête
while ($line = mysql_fetch_array($result, MYSQL_ASSOC)){
  $j = 1;
  $vl_e_noligne++;
  foreach ($line as $field) {
    $cell = $sheet->getCell( $j,$vl_e_noligne);
    $cell->setContent($field);
    $j++;
  }
}
mysql_free_result($result);
mysql_close($connection);
$calc->output();
?>
