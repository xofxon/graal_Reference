<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_documents.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_doc_07";
$t_origines_ok[1]="_graal_fen_actions_02";
fa_acces_script();
define('EOL', "\r\n");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vf_e_doc_cleunik=intval(fa_recup_param('vf_e_doc_cleunik','0'));
$vf_c_action=fa_recup_param('vf_c_action','0');
$vf_c_emplacement=fa_recup_param('vf_c_emplacement','');
$vf_c_titre=fa_recup_param('vf_c_titre','');
$vf_c_descriptif_sommaire=fa_recup_param('vf_c_descriptif_sommaire','');
$vf_c_hash=fa_recup_param('vf_c_hash','');
$vf_c_origine=fa_recup_param('vf_c_origine','');
$vf_c_genre=fa_recup_param('genre','utilis');
$vl_e_portee_cleunik=fa_recup_param('portee_cleunik','0');
$vl_e_actif=fa_recup_param('vf_c_actif','1');
$vf_c_echo='';
$typedoc=3;
/*
le 29 septembre 2010
  typedoc    1 -> Liens,
             2 -> Notes,
             3 -> Documents,
             4 -> Dossier,
             5 -> courriels envoyés,
             6 -> modèles de courriels texte,
             7 -> Flux RSS,
             8 -> requêtes personnelles,
             9 -> images des articles, logos de l'entreprise
            10 -> modèles de courriels HTML,
            11 -> modèles de notes,
            12 -> modèles de notification de lecture,
            13 -> pièces jointes,
            14 -> menus arbres personalisés
            15 -> menus pages personalisés
           101 -> modèles textes entêtes offres clients,
           102 -> modèles textes pied offres clients,
           111 -> modèles textes entêtes commandes clients,
           112 -> modèles textes pied commandes clients,
           121 -> modèles textes entêtes livraison clients,
           122 -> modèles textes pied livraison clients,
           131 -> modèles textes entêtes facture clients,
           132 -> modèles textes pied facture clients,
           141 -> modèles textes entêtes demandes fournisseur,
           142 -> modèles textes pied demandes fournisseur,
           151 -> modèles textes entêtes commandes fournisseur,
           152 -> modèles textes pied commandes fournisseur,
           153 -> modèles formulaires de fiches palettes,
           154 -> fichiers pdf de filigranne de documents,
           900 -> Conditions générales de vente
           901 -> Bloc de désinscription pour emailing html
           902 -> Bloc de désinscription pour emailing texte
           903 -> Bloc de sondage pour emailing html
           904 -> Bloc de sondage pour emailing texte
*/
switch (TRUE) {
  case $vf_c_action=='verifier_droits_acces': //  Vérification que l'utilisateur a bien accès au document
    //  Pour l'instant 4 avril 2007, on ne vérifie pas les droits des documents autres que ceux des utilisateurs
    switch ($vf_c_genre) {
      case 'action' : $vf_c_echo=15;break;
      case 'acteur' : $vf_c_echo=15;break;
      case 'articl' : $vf_c_echo=15;break;
      case 'interl' : $vf_c_echo=15;break;
      case 'entrep' : $vf_c_echo=15;break;
      case 'utilis' :
        $sql_req = "select droits_proprio from _droits_doc where doc_cleunik=$vf_e_doc_cleunik AND uti_cleunik=$vl_e_uti_cleunik";
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        $vf_c_echo=$row['droits_proprio'];
        break;
    }
    break;
  case $vf_c_action=='verifier_hash':
  	$vf_c_echo=fa_verifie_hash($vf_c_hash);
    break;
  case $vf_c_action=='supprimer': //  Suppression d'un document
    $sql_req = "DELETE FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik";
    $res = _graal_requete_bd($sql_req);
    $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik";
    $res = _graal_requete_bd($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    break;
  case $vf_c_action=='supprimer_doc_cial': //  Suppression d'un document pdf commercial
    $sql_req = "DELETE FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik";
    $res = _graal_requete_bd($sql_req);
    $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik";
    $res = _graal_requete_bd($sql_req);
    $sql_req = "DELETE FROM _docciaux WHERE doc_cleunik=$vf_e_doc_cleunik";
    $res = _graal_requete_bd($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    break;
  case $vf_c_action=='attacher': //  Attacher un document
    switch ($vf_c_genre) {
      case 'action' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_action;";break;
      case 'acteur' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_acteur;";break;
      case 'articl' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_articl;";break;
      case 'interl' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_interl;";break;
      case 'entrep' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=0,portee=$vl_e_entrep;";break;
      case 'utilis' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";break;
    }
    _graal_exec_requete($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    break;
  case $vf_c_action=='detacher': //  Détacher un document
    switch ($vf_c_genre) {
      case 'action' : $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik AND rat_cleunik=$vl_e_portee_cleunik AND portee=$vl_e_action;";break;
      case 'acteur' : $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik AND rat_cleunik=$vl_e_portee_cleunik AND portee=$vl_e_acteur;";break;
      case 'articl' : $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik AND rat_cleunik=$vl_e_portee_cleunik AND portee=$vl_e_articl;";break;
      case 'interl' : $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik AND rat_cleunik=$vl_e_portee_cleunik AND portee=$vl_e_interl;";break;
      case 'entrep' : $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik AND rat_cleunik=0 AND portee=$vl_e_entrep;";break;
      case 'utilis' : $sql_req = "DELETE FROM _documents_rattachement WHERE doc_cleunik=$vf_e_doc_cleunik AND rat_cleunik=$vl_e_uti_cleunik AND portee=$vl_e_utilis;";break;
    }
    _graal_exec_requete($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    break;

  case $vf_c_action=='modifier':  //  Modification d'un document
    $sql_req = "update _documents set titre = '$vf_c_titre',descriptif_sommaire='$vf_c_descriptif_sommaire',dateheuremodif = now(),hash='$vf_c_hash',origine='$vf_c_origine',actif=$vl_e_actif where doc_cleunik=$vf_e_doc_cleunik";
    $res = _graal_requete_bd($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
