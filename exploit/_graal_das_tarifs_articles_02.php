<?php
include("_graal_header_xml.inc.php");
$vl_e_art_cleunik=intval(fa_recup_param("vl_e_art_cleunik",'-1'));
$vl_e_act_cleunik=intval(fa_recup_param("vl_e_act_cleunik",'-1'));
$vl_e_tarif_cleunik=intval(fa_recup_param("vl_e_tarif_cleunik",'-1'));
$vl_e_type_tarifs=intval(fa_recup_param("vl_e_type_tarifs",'-1'));
$vl_e_critere_cleunik=intval(fa_recup_param("vl_e_critere_cleunik",'0'));
$vl_e_nouvelle_ligne=intval(fa_recup_param("vl_e_nouvelleligne",'0'));
$vl_e_pas_tarif=intval(fa_recup_param("vl_e_pas_tarif",'0'));
$vl_c_nom_ml=fa_recup_param("vl_c_nom_ml","");
$vl_ligne_qte=fa_floatval(fa_recup_param("ligne_qte",4));
$sql_req="select count(*) as nombre from _art_tarifs a2 where a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.type=$vl_e_type_tarifs and quantite_haute<>0;";
$sql_result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($sql_result);
$vl_e_nombre_quantites=$row['nombre'];
_graal_libere_requete_bd($sql_result);
//echo $sql_req;
$sql_req = "SELECT count(*) FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.type=$vl_e_type_tarifs);";
$sql_result = _graal_requete_bd($sql_req);
$vl_e_nombre_types=mysql_num_rows($sql_result);
_graal_libere_requete_bd($sql_result);
$sql_req = "SELECT ifnull(round(a2.quantite_basse,0),0) as quantite_basse,ifnull(round(a2.quantite_haute,0),0) as quantite_haute,a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=$vl_e_act_cleunik and a2.type=$vl_e_type_tarifs)";
if ($vl_e_tarif_cleunik!=-1) {
  $sql_req.="UNION SELECT ifnull(round(a2.quantite_basse,0),0) as quantite_basse,ifnull(round(a2.quantite_haute,0),0) as quantite_haute,a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=$vl_e_act_cleunik and a2.type=$vl_e_type_tarifs and a2.tarif_cleunik=$vl_e_tarif_cleunik)";
}
$toto=$sql_req;
$sql_result = _graal_requete_bd($sql_req);
$i=0;$vl_c_pu=-1;
$ta_01=array();$ta_02=array();$ta_03=array();$ta_04=array();$ta_05=array();$ta_06=array();$ta_07=array();$ta_08=array();$ta_09=array();
echo('<donnees>');
while ($row = mysql_fetch_assoc($sql_result)){
  $vl_c_lib=fa_remplace_quotes(fa_ent_xml($row['intitule_tarif'])."                 (".fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).")");
  if ($vl_e_nombre_quantites<>0){
  	$vl_c_lib.=fa_ent_xml(" >".$row['quantite_basse']." et "." <=".$row['quantite_haute']);
  }
$selected="";$class="";$disabled="false";
  if ($vl_e_nouvelle_ligne==0) {
    $selected="true";
    $tarif_deja_selectionne=true;
    $vl_e_tarif_cleunik_selectionne=$row['choix_cleunik'];
  } else {
    if ($vl_e_tarif_cleunik==$row['choix_cleunik']) {
      $selected="true";
      $tarif_deja_selectionne=true;
      $vl_e_tarif_cleunik_selectionne=$row['choix_cleunik'];
    }
  }
  if ($row['actif']==2) {
  	$class="obsolete";
	$disabled="true";
	}
array_push ($ta_01, $row['choix_cleunik']);
array_push ($ta_02, $vl_c_lib);
array_push ($ta_03, $row['pu_reference']);
array_push ($ta_04, $row['nb_dec']);
array_push ($ta_05, $selected);
array_push ($ta_06, $class);
array_push ($ta_07, $disabled);
array_push ($ta_08, $row['quantite_basse']);
array_push ($ta_09, $row['quantite_haute']);
  
	if ($i==0) {$vl_c_pu=fa_ent_xml($row['pu_reference']);}
  $i++;
}
_graal_libere_requete_bd($sql_result);
if ($i!=0) {$vl_c_ove.=('<menuseparator/>');}
$sql_req = "SELECT ifnull(round(a2.quantite_basse,0),0) as quantite_basse,ifnull(round(a2.quantite_haute,0),0) as quantite_haute,a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=0 and a2.type=$vl_e_type_tarifs)";
$sql_req.=" UNION SELECT 0 as quantite_basse,0 as quantite_haute,a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,0,a1.choix_actif,2 FROM _choix a1 WHERE a1.critere_cleunik=$vl_e_critere_cleunik and a1.choix_cleunik=$vl_e_pas_tarif ";
if ($vl_e_tarif_cleunik!=-1) {
  $sql_req.=" UNION SELECT ifnull(round(a2.quantite_basse,0),0) as quantite_basse,ifnull(round(a2.quantite_haute,0),0) as quantite_haute,a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=0 and a2.type=$vl_e_type_tarifs and a2.tarif_cleunik=$vl_e_tarif_cleunik)";
}
$titi=$sql_req;
//echo $titi;
$sql_result = _graal_requete_bd($sql_req);
$vl_e_nombre_types=mysql_num_rows($sql_result);
while ($row = mysql_fetch_assoc($sql_result)){
  $vl_c_lib=fa_remplace_quotes(fa_ent_xml($row['intitule_tarif'])."                 (".fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).")");
if ($vl_e_nombre_quantites<>0){
  	$vl_c_lib.=fa_ent_xml(" >".$row['quantite_basse']." et "." <=".$row['quantite_haute']);
  }
  $selected="";$class="";$disabled="";
  if ($tarif_deja_selectionne==false) {
    if ($vl_e_tarif_cleunik==$row['choix_cleunik']) {
      $selected="true";
		$tarif_deja_selectionne=true;
		$vl_e_tarif_cleunik_selectionne=$row['choix_cleunik'];
    }
    if ($vl_e_pas_tarif==$row['choix_cleunik']) {
      			$selected="true";
				$tarif_deja_selectionne=true;
				$vl_e_tarif_cleunik_selectionne=$row['choix_cleunik'];
	} 
  }
	
	  if ($row['actif']==2) {
	  	$class="obsolete";
		$disabled="true";
		}
	array_push ($ta_01, $row['choix_cleunik']);
	array_push ($ta_02, $vl_c_lib);
	array_push ($ta_03, $row['pu_reference']);
	/*
	if ($vl_e_pas_tarif==$row['choix_cleunik']) {
		array_push ($ta_04, 2);
	} else {
		array_push ($ta_04, $row['nb_dec']);
	}
	*/
	array_push ($ta_04, $row['nb_dec']);
	array_push ($ta_05, $selected);
	array_push ($ta_06, $class);
	array_push ($ta_07, $disabled);
	array_push ($ta_08, $row['quantite_basse']);
	array_push ($ta_09, $row['quantite_haute']);
  
}

$i=-1;
foreach ($ta_01 as $toto) {
	$i++;
    echo('<quoi ');
  echo(' _graal_cleunik="'.fa_ent_xml($ta_01[$i]).'"');
  echo(' label="'.$ta_02[$i].'"');
  echo(' _graal_tarif="'.fa_reel(fa_ent_xml($ta_03[$i]),$ta_04[$i]).'"');
  echo(' _graal_nb_dec="'.fa_ent_xml($ta_04[$i]).'"');
  echo(' selected="'.$ta_05[$i].'"');
  echo(' class="'.$ta_06[$i].'"');
  echo(' disabled="'.$ta_07[$i].'"');
  echo(' selection="'.$vl_e_tarif_cleunik_selectionne.'"');
  echo(' quantite_basse="'.$ta_08[$i].'"');
  echo(' quantite_haute="'.$ta_09[$i].'"');
  echo('/>');
}





_graal_libere_requete_bd($sql_result);
echo('</donnees>');
?>
