<?php
include("_graal_header_xml.inc.php");
$recherche=fa_recup_param('recherche','ch');
$limit=intval(fa_recup_param('limit','50'));
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_sortie=fa_recup_param('sortie','das');
$sql_req="select f1.act_cleunik,f1.intweb_cleunik,f1.int_cleunik,f1.refweb ,concat_ws(_utf8' ',f2.prenom,f2.patronyme) AS prenom_nom,";
$sql_req.=" concat_ws(_utf8'',f2.prenom,_utf8' ',f2.patronyme,_utf8' (',f1.refweb,_utf8')') AS recherche,f3.nomcommercial,f4.choix_valeur_texte_01 AS type_acteur_clair ";
$sql_req.=" from _act_interlo_mail f1 left join _act_interlo f2  on f1.int_cleunik = f2.int_cleunik left join _acteurs f3 on f2.act_cleunik = f3.act_cleunik ";
$sql_req.=" left join _choix f4 on f4.choix_cleunik = f3.typeacteur ";
$sql_req.=" where ((f1.valide <> 2) and (f2.actif = 1) and (f3.actif = 1)) and concat_ws(_utf8'',f2.prenom,_utf8' ',f2.patronyme,_utf8' (',f1.refweb,_utf8')') like '%$recherche%'";
/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */
$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
switch ($vs_gesacteurs_ml_zone){
	case '1':	//	Accès libre
		$req_liste_noire="";
		$req_liste_blanc="";
		break;
	case '3':	//	Accès sur liste noire
		$req_liste_noire=" and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=f3.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		$req_liste_blanc="";
		break;
	case '4':	//	Accès sur liste blanche
		$req_liste_blanc=" and (select count(*) from _acteurs_blanc where _acteurs_blanc.act_cleunik=f3.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) <> 0 ";
		$req_liste_noire="";
		break;
}
$sql_req.= $req_liste_blanc . $req_liste_noire;
$sql_req.= "limit $limit;";
switch ($vl_c_sortie) {
  	case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
	    break;
	case "das":
		$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		$vl_e_nombre_enr=mysql_num_rows($result);
		while ($row = mysql_fetch_assoc($result)){
			echo('<quoi label="'.fa_ent_xml($row['recherche']).'['.fa_ent_xml($row['nomcommercial']).'    '.fa_ent_xml($row['type_acteur_clair']).']" issuggest="'.fa_ent_xml($row['intweb_cleunik']).'" prop="" nb="'.$vl_e_nombre_enr.'"/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		break;
}
?>
