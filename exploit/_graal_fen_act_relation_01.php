<?php
include("_graal_header_xul.inc.php");
$vl_e_uti_cleunik =intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_c_genreacteur=fa_recup_param('genreacteur','0');
$vl_e_act_cleunik_gauche=intval(fa_recup_param("vl_e_act_cleunik_gauche","-1"));
$vl_c_qui_acteurs_recherche=fa_recup_param("qui_acteurs_recherche",'09');
switch ($vl_c_genreacteur){
  case "110001": $vl_c_id_fenetre="Fen_00210";$vl_e_choix_portee="02";$vl_c_id_inc_acteurs_relations="Div_00199";break;  //  Relations des prospects clients
  case "110002": $vl_c_id_fenetre="Fen_00211";$vl_e_choix_portee="08";$vl_c_id_inc_acteurs_relations="Div_00200";break;  //  Relations des prospects fournisseurs
  case "110003": $vl_c_id_fenetre="Fen_00212";$vl_e_choix_portee="04";$vl_c_id_inc_acteurs_relations="Div_00201";break;  //  Relations des clients
  case "110004": $vl_c_id_fenetre="Fen_00213";$vl_e_choix_portee="16";$vl_c_id_inc_acteurs_relations="Div_00202";break;  //  Relations des fournisseurs
  case "110005": $vl_c_id_fenetre="Fen_00214";$vl_e_choix_portee="32";$vl_c_id_inc_acteurs_relations="Div_00203";break;  //  Relations des autres acteurs
  case "110006": $vl_c_id_fenetre="Fen_00215";$vl_e_choix_portee="64";$vl_c_id_inc_acteurs_relations="Div_00204";break;  //  Relations des acteurs indéterminés
  default:
    fa_redirige("acces_interdit");  
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_b_acces=$vl_tb_droits[0];if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bbl_100=fa_recup_dico("bbl_100");
$vl_c_bbl_101=fa_recup_dico("bbl_101");
$vl_c_bbl_102=fa_recup_dico("bbl_102");
$vl_c_dico_00002=fa_recup_dico('dico_00002');
$vl_c_dico_00004=fa_recup_dico('dico_00004');
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_dico_00010=fa_recup_dico('dico_00010');
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
//  On recherche les informations sur l'acteur 
if ($vl_e_act_cleunik_gauche!=-1){$vl_c_qui=_graal_requete_acteur($vl_e_act_cleunik_gauche);}
switch ($vl_c_qui_acteurs_recherche) {
  case "09":$vl_c_inactif_acteurs_recherche='false';$vl_complement_rel_01="";$vl_complement_rel_02="";break;//tous
  case "12":$vl_c_inactif_acteurs_recherche='true';$vl_complement_rel_01=" and choix_cleunik in(-30)";$vl_complement_rel_02=" and choix_cleunik in(-29)";break;// transporteurs
}
//  On recherche Tous les intitulés de relations        
//  la condition "choix_portee & 16" permet d'utiliser le et binaire
$sql_req_genre_rel = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur' FROM _choix WHERE _choix.choix_actif=1 and _choix.critere_cleunik IN (114) and  choix_portee & $vl_e_choix_portee and choix_cleunik not in(-27,-28) $vl_complement_rel_01 ORDER BY _choix.choix_valeur_texte_01;";
$sql_result_genre_rel = _graal_requete_bd($sql_req_genre_rel);
$vl_e_nombre_valeurs_genres=mysql_num_rows($sql_result_genre_rel);
$vl_c_bt_ajout="<button flex='1' id='bt_ajouter' label='$vl_c_dico_00002' crop='end' dir='normal' oncommand='pf_validation(\"enregistrer\")' />";
if ($vl_e_nombre_valeurs_genres==0){$vl_tb_droits[1]=0;$vl_tb_droits[2]=0;$vl_tb_droits[3]=0;$vl_c_bt_ajout="";}
$vl_c_id_inc_acteurs_recherche="Div_00205";

include("_graal_header_winxul.inc.php"); 
echo <<<END
<window context="graal_cp00" _graal_act_cleunik_gauche="$vl_e_act_cleunik_gauche" title="$vl_c_bbl_100" id="_win_fen_act_relation" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_act_relation_01.js.php");
include("_graal_inc_acteurs_recherche_01.php");
echo <<<END
  <splitter/>
  <groupbox >
  <textbox id="tb_qui_gauche" value="$vl_c_qui" disabled="true" />
  <hbox>
  <label control="la_prefixe_choix_cleunik" value="$vl_c_bbl_101"/>
  <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex="1" id="ml_rel_gauche" _graal_nombre="$vl_e_nombre_valeurs_genres">
  <menupopup>
END;
if ($vl_e_nombre_valeurs_genres == 0) 
{
	$vl_tb_droits[1]=0;
	$vl_c_bt_ajout="";
echo("<menuitem value='0' id='0' _graal_cleunik='0' label='$vl_c_dico_00010' selected='true'/>");
}
else
{
while ($row = mysql_fetch_assoc($sql_result_genre_rel))
  {
  echo("<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' selected='true'/>");
  }
_graal_libere_requete_bd($sql_result_genre_rel);
}
echo <<<END
      </menupopup>
    </menulist>
  </hbox>
    <textbox id="tb_qui_droite" value="" _graal_act_cleunik="0" disabled="true" />
  <hbox>
  <label control="la_prefixe_choix_cleunik" value="$vl_c_bbl_101"/>
  <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex="1" id="ml_rel_droite" _graal_nombre="$vl_e_nombre_valeurs_genres">
  <menupopup>
END;
$sql_req_genre_rel = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur' FROM _choix WHERE _choix.choix_actif=1 and _choix.critere_cleunik IN (114) and  choix_portee & $vl_e_choix_portee and choix_cleunik not in(-27,-28) $vl_complement_rel_02 ORDER BY _choix.choix_valeur_texte_01;";
$sql_result_genre_rel = _graal_requete_bd($sql_req_genre_rel);
while ($row = mysql_fetch_assoc($sql_result_genre_rel))
  {
  echo("<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' selected='true'/>");
  }
_graal_libere_requete_bd($sql_result_genre_rel);
echo <<<END
      </menupopup>
    </menulist>
END;

echo <<<END
  </hbox>
  <textbox id="tb_qui_gauche_bis" value="$vl_c_qui" disabled="true" />
  <hbox>
        <label control="la_blocnotebrut" value="$vl_c_bbl_102"/>
        <textbox flex="1" id="tb_blocnotebrut"   multiline="true"/>
  </hbox>
  </groupbox>
  
  <hbox> 
    $vl_c_bt_ajout
    <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
<splitter/>
END;
$vl_c_barre_presente_acteurs_relations="pasok";
include("_graal_inc_acteurs_relations_01.php");
echo <<<END
<button width="40" id="bt_supprimer" label="$vl_c_dico_00004" crop="end" dir="normal" oncommand="pf_validation('supprimer')" />
</window>
END;
?>
