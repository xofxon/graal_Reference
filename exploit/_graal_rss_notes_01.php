<?php
/*
*******************************************************************************
**  ATTENTION ATTENTION Exceptionnellement, pour que le remplacement des 
**  caractères accentués fonctionne, cette page doît être éditée en ISO 8859-2 ou autre mais pas en utf-8 comme 
**  c'est la règle pour toutes les autres !!!! 
**   Flux XML des pseudos documents : les 10 derniers créés                  **
*******************************************************************************
*/
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_modeles_courriels_01";
$t_origines_ok[1]="_graal_fen_modeles_notes_01";
$t_origines_ok[2]="_graal_fen_note_01";
fa_acces_script();
define('EOL', "\r\n");
$vf_c_argfen00=fa_recup_param('vf_c_quelsdocs','');
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$sql_req_uti="SELECT uti_cleunik AS uti_cleunik,prenom as prenom,patronyme as patronyme,c_uuid as c_uuid from _utilisateur";
$res_uti=_graal_requete_bd($sql_req_uti);
while ($row_uti = mysql_fetch_assoc($res_uti))
{
  $vl_e_uti_cleunik=$row_uti['uti_cleunik'];
  $vl_c_prenom=utf8_decode($row_uti['prenom']);
  $vl_c_prenom=strtr($vl_c_prenom,'ÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÒÓÔÕÖÙÚÛÜÝàáâãäåçèéêëìíîïðòóôõöùúûüýÿ','AAAAAACEEEEIIIIOOOOOUUUUYaaaaaaceeeeiiiioooooouuuuyy');
  $vl_c_prenom=preg_replace('/([^.a-z0-9]+)/i', '_', $vl_c_prenom);
  $vl_c_patronyme=utf8_decode($row_uti['patronyme']);
  $vl_c_patronyme=strtr($vl_c_patronyme,'ÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÒÓÔÕÖÙÚÛÜÝàáâãäåçèéêëìíîïðòóôõöùúûüýÿ','AAAAAACEEEEIIIIOOOOOUUUUYaaaaaaceeeeiiiioooooouuuuyy');
  $vl_c_patronyme=preg_replace('/([^.a-z0-9]+)/i', '_',$vl_c_patronyme);
  $c_uuid=$row_uti['c_uuid'];
  $sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.emplacement AS emplacement,_documents.titre AS titre,_documents.dateheurecreation AS dateheurecreation,_documents.dateheuremodif AS dateheuremodif,_documents.choix_cleunik AS choix_cleunik,_documents.descriptif_sommaire AS descriptif_sommaire,_droits_doc.uti_cleunik AS uti_cleunik,_droits_doc.droits_proprio AS droits_proprio,_utilisateur.prenom AS prenom,_utilisateur.patronyme AS patronyme	FROM _utilisateur, _droits_doc, _documents WHERE _utilisateur.uti_cleunik = _droits_doc.uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc = 2";
  switch (TRUE)
   {
   case $vf_c_argfen00 == "menot": 
    $sql_req .= " AND _droits_doc.uti_cleunik=$vl_e_uti_cleunik";
    $vl_c_intitule="Les dernieres notes de $vl_c_prenom $vl_c_patronyme";
    $filename='10dernieresnotesde-'.$c_uuid.'.xml';
    break;
   case $vf_c_argfen00 == "leurnot": 
    $sql_req .= " AND _droits_doc.uti_cleunik<>$vl_e_uti_cleunik";
    $vl_c_intitule="Les dernieres notes sauf celles de $vl_c_prenom $vl_c_patronyme";
    $filename='10dernieresnotespasde-'.$c_uuid.'.xml';
    break;
   default :
   echo 	('booom ->'.$vf_c_argfen00);
  exit;
   }
    $vl_c_description="<description>$vl_c_intitule</description>";
    $vl_c_titre="<title>$vl_c_intitule</title>";
    $sql_req .= " ORDER BY dateheurecreation DESC LIMIT 10"; 
    $result = _graal_requete_bd($sql_req);
  
  $xml = fa_xcree_entete_rss();
  $vl_c_prenom=$row_uti['prenom'];
  $vl_c_patronyme=$row_uti['patronyme'];

  $xml .=$vl_c_description;
  $xml .=$vl_c_titre;
  $vl_e_nombre=0;
  while ($row = mysql_fetch_assoc($result))
    {
      $vl_e_nombre=1;
      $id = $row['doc_cleunik'];
      $titre = fa_ent_xml($row['titre']);
      $news = fa_ent_xml(stripslashes(trim($row['descriptif_sommaire'])));
      $date_mysql=$row['dateheurecreation'];
      if (($timestamp = strtotime($date_mysql)) === false) 
        {
          $dateheure=$date_mysql.' GMT';
        } 
      else
        {
        $dateheure=date('D, d M Y H:i:s ', $timestamp). "GMT";
        }
      $xml .='<item>';
      $xml .='<author>'.$row['prenom'].' '.$row['patronyme'].'</author>';
      $xml .='<title>'.$titre.'</title>';
      $xml .='<link>http://christophe-charron.org/exploit/_graal_bdope_note_03.php?doc_cleunik='.$row['doc_cleunik'].'</link>';
      $xml .='<pubDate>'.$dateheure.'</pubDate>';
      $xml .='<guid>http://christophe-charron.org/exploit/_graal_bdope_note_03.php?doc_cleunik='.$row['doc_cleunik'].'</guid>';
      $xml .='<comments>http://christophe-charron.org/exploit/_graal_bdope_note_03.php?doc_cleunik='.$row['doc_cleunik'].'</comments>';
      $xml .='<description>';
      $xml .= $news;
      $xml .='</description>';
      $xml .='</item>';
    }
  $xml .='</channel></rss>';
  _graal_libere_requete_bd($result);
  
  if ($vl_e_nombre!=0)  //  On ne crèe les fichiers que si on a des pseudos-documents (liens)
  {
    $vl_c_chemincomplet="http://test03.christophe-charron.org/public/rss/$filename";
    include("_graal_bdope_rss_02.php");
    switch ($_SERVER['HTTP_HOST'])
      {
      case "localhost":
      case "famchar":
      case "poste01": 
        $fichier_ori=$_SERVER["DOCUMENT_ROOT"].'/exploit/rss/'.$filename;
        $fichier_des=$_SERVER["DOCUMENT_ROOT"].'/exploit/xml/'.$filename;
        $fichier_ori="C:/wamp/moi/graal/exploit/rss/$filename";
        $fichier_des="C:/wamp/moi/graal/exploit/xml/$filename";
        break;
      case "christophe-charron.org":
        $fichier_ori='/var/www/vhosts/christophe-charron.org/httpdocs/exploit/rss/'.$filename;
        $fichier_des='/var/www/vhosts/christophe-charron.org/subdomains/test03/httpdocs/public/rss/'.$filename;
        break;
      }
    if (file_exists($fichier_ori)) 
      {
       if (unlink($fichier_ori)=== FALSE)
        {
              echo "Impossible d'effectuer la suppression initiale du fichier ($fichier_ori)";
        }
      }
    if (!$handle = fopen($fichier_ori, 'x+')) 
    {
      echo "Impossible d'ouvrir le fichier ($fichier_ori)";
      exit;
    }
    if (fwrite($handle, $xml) === FALSE) 
    {
      echo "Impossible d'écrire dans le fichier ($fichier_ori)";
      exit;
    }
    echo "L'écriture dans le fichier ($fichier_ori) a réussi";
    fclose($handle);
    copy($fichier_ori,$fichier_des);
  }
}
_graal_libere_requete_bd($res_uti);
_graal_ferme_connexion();
?>

