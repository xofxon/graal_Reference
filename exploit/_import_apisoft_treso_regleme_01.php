<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
include("_import_apisoft_sp_array_pc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_finan');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_genre=fa_recup_param('vl_c_genre','???');
switch ($vl_c_genre) {
	case "cli":
		$fic_entete_doccial="_faccli_entetes";
		$fic_echeance="_faccli_echeance";
		$fic_reglement="_treso_reglement_cli";
		$fic_remise="_treso_reglement_cli_remise";
		$fic_reglement_det="_treso_reglement_cli_detail";
		$condition= " where TypeTiers='C'";
		break;
	case "fou":
		$fic_entete_doccial="_facfou_entetes";
		$fic_echeance="_facfou_echeance";		
		$fic_reglement="_treso_reglement_fou";
		$fic_remise="_treso_reglement_fou_remise";
		$fic_reglement_det="_treso_reglement_cli_detail";
		$condition= " where TypeTiers='F'";
		break;
}
$o_modepaiement=new _graal_import();
$vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
$o_modepaiement->req="INSERT INTO $vl_c_base_destination._choix (critere_cleunik,choix_cleunik,choix_code,choix_valeur_texte_01,choix_actif) VALUES ";
//  Recherche pour modes de paiement
$sql_req = "SELECT distinct(ModeP) FROM $vl_c_base_origine.reglement where ModeP not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=137)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik++;
  $choix_code=addslashes($row['ModeP']);
  $choix_valeur_texte_01=addslashes($row['ModeP']);
  $o_modepaiement->dat.="(137,$vf_e_choix_cleunik,'$choix_code','$choix_valeur_texte_01',1),";
}
_graal_libere_requete_bd($result);
$o_modepaiement->execute();
//  Recherche pour Types d'écart
$sql_req = "SELECT distinct(TypeEcart) FROM $vl_c_base_origine.reglement where TypeEcart not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=146)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik++;
  $choix_code=addslashes($row['TypeEcart']);
  $choix_valeur_texte_01=addslashes($row['TypeEcart']);
  $o_modepaiement->dat.="(146,$vf_e_choix_cleunik,'$choix_code','$choix_valeur_texte_01',1),";
}
_graal_libere_requete_bd($result);
$o_modepaiement->execute();
$eca_cod=array();$eca_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=146"; //  On recherche les Types d'écarts de réglements
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($eca_cod, $row['code']);
  array_push ($eca_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
include("_import_apisoft_sp_array_journaux.php");//  On recherche les journaux
include("_import_apisoft_sp_array_modepaiement.php");//  On recherche les modes de paiement
include("_import_apisoft_sp_array_optipaiement.php");//  On recherche les options de paiement
$o_reglement=new _graal_import();
$o_remise=new _graal_import();
$i=0;$j=0;$b=500;
$o_reglement->req="INSERT INTO $vl_c_base_destination.$fic_reglement (reglement_cleunik,journal_cleunik,pc_cleunik,mode_paiement,piece,ref_piece,dateheurecreation,dateheuremodif,dateheurereglemen,montant_paye,montant_pointe,devise_paye,coef,acompte,transfert,impaye,remboursement,option_remise,accepte,banque,domiciliation,etablissement,guichet,compte,cle,type_ecart,blocnotebrut) VALUES ";
$o_remise->req="INSERT INTO $vl_c_base_destination.$fic_remise (reglement_cleunik,remise_cleunik) VALUES ";
//  Lecture de la table des réglements
$sql_req = "SELECT `NumRgl`,`NumGest`,`NumEcr`,`ProvApp`,`ProvFic`,`Journal`,`TypeTiers`,`Code`,`Compte`,`ModeP`,`Cheque`,`RefDoc`,`Libelle`,`DateA`,`DateR`,`DateE`,`MontantDev`,`MontantPointe`,`CodeDevise`,`NumRemise`,`FlAvoir`,`FlAcompte`,`FlTransfert`,`FlImpaye`,`FlLien`,`FlRembourse`,`RefBancaire`,`HSPlace`,`Accept`,`Domi`,`Rib1`,`Rib2`,`Rib3`,`Rib4`,`TypeEcart`,`Note`,`DateDerModif`,`TypeRemise`,`FlTransfertAnnexe`,`FlTransEdition`,`flProvCaisse`,`flRg`,`FlPurge` FROM $vl_c_base_origine.reglement $condition;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
	$reglement_cleunik=$row['NumRgl'];
	$vl_e_trouve_journa=array_search($row['Journal'], $journa_cod);if ($vl_e_trouve_journa===false) {$journal_cleunik=-1;} else {$journal_cleunik=$journa_cle[$vl_e_trouve_journa];}
	$vl_e_trouve_pc=array_search($row['Compte'], $pc_cod);if ($vl_e_trouve_pc===false) {$pc_cleunik=0;echo "Compte ? ".$row['Compte']." sur Réglement ? ".$row['NumRgl']." facture ".$row['NumGest'].EOL;} else {$pc_cleunik=$pc_cle[$vl_e_trouve_pc];}
	$vl_e_trouve_mod=array_search($row['ModeP'], $mod_cod);if ($vl_e_trouve_mod===false) {$mode_paiement=-91;} else {$mode_paiement=$mod_cle[$vl_e_trouve_mod];}
	$piece=fa_nt($row['Cheque']);
	$ref_piece=fa_nt($row['Libelle']);
	$dateheurecreation=fa_nt($row['DateR']);
	$dateheuremodif=fa_nt($row['DateDerModif']);
	$dateheurereglemen=fa_nt($row['DateR']);
	$montant_paye=fa_nn($row['MontantDev']);
	$montant_pointe=fa_nn($row['MontantPointe']);
	switch ($row['CodeDevise']){
		case "E":$devise_paye=122047;break;
		case "F":$devise_paye=122176;break;
		default :$devise_paye=122047;break;
	}
	if ($row['FlAvoir']==-1){
		$coef=-1;
	} else {
		$coef=1;
	}
	$acompte=fa_nn($row['FlAcompte']);
	$transfert=fa_nn($row['FlTransfert']);
	$impaye=fa_nn($row['FlImpaye']);
	$remboursement=fa_nn($row['FlRembourse']);
	$vl_e_trouve_opt=array_search($row['TypeRemise'], $opt_cod);if ($vl_e_trouve_opt===false) {$option_remise=-131;} else {$option_remise=$opt_cle[$vl_e_trouve_opt];}
	if ($row['Accept']=='O'){
		$accepte=1;
	} else {
		$accepte=2;
	}
	$banque=fa_nt($row['RefBancaire']);
	$domiciliation=fa_nt($row['Domi']);
	$etablissement=fa_nt($row['Rib1']);
	$guichet=fa_nt($row['Rib2']);
	$compte=fa_nt($row['Rib3']);
	$cle=fa_nt($row['Rib4']);
	$vl_e_trouve_eca=array_search($row['TypeEcart'], $eca_cod);if ($vl_e_trouve_eca===false) {$type_ecart=-132;} else {$type_ecart=$eca_cle[$vl_e_trouve_eca];}
	$blocnotebrut=fa_nt($row['Note']);
	if ($pc_cleunik==0) {
		$m++;
	}
	if ($pc_cleunik==0) {
		$j++;
	} else {
		$numremise=fa_nn($row['NumRemise']);
		if ($numremise<>0){
			$o_remise->dat.="($reglement_cleunik,$numremise),";
		}
	  $o_reglement->dat.="($reglement_cleunik,$journal_cleunik,$pc_cleunik,$mode_paiement,$piece,$ref_piece,$dateheurecreation,$dateheuremodif,$dateheurereglemen,$montant_paye,$montant_pointe,$devise_paye,$coef,$acompte,$transfert,$impaye,$remboursement,$option_remise,$accepte,$banque,$domiciliation,$etablissement,$guichet,$compte,$cle,$type_ecart,$blocnotebrut),";
		$i++;
	}	
	if ($i % $b==0){
		//echo $o_reglement->req.$o_reglement->dat;
		$o_reglement->execute();
		$o_remise->execute();
		//echo EOL;
		//die();
  }
}
_graal_libere_requete_bd($result);
/*
echo $o_modepaiement->req.$o_modepaiement->dat;
echo EOL;
echo $o_action->req.$o_action->dat;
*/
$o_reglement->execute();
$o_remise->execute();
$i=0;$j=0;$b=500;
$o_reglement->req="INSERT INTO $vl_c_base_destination.$fic_reglement_det (reglement_cleunik,echeance_cleunik,pourcentage_paye,montant_paye,montant_pointe,devise_paye,coef) VALUES ";
//  Lecture de la table des réglements
$sql_req = "select NumEch,NumRgl,MontantRgl,MontantEch,FlAvoir FROM $vl_c_base_origine.lien left join $vl_c_base_origine.reglement using(NumRgl);";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
	$reglement_cleunik=fa_nn($row['NumRgl']);
	$echeance_cleunik=fa_nn($row['NumEch']);
	$pourcentage_paye=100;
	$montant_paye=fa_nn($row['MontantRgl']);
	$montant_pointe=fa_nn($row['MontantEch']);
	$devise_paye=122047;
	if ($row['FlAvoir']==-1){
		$coef=-1;
	} else {
		$coef=1;
	}
	$o_reglement->dat.="($reglement_cleunik,$echeance_cleunik,$pourcentage_paye,$montant_paye,$montant_pointe,$devise_paye,$coef),";
	if ($i % $b==0){
		$o_reglement->execute();
  }
}
$o_reglement->execute();
$sql_req="update $vl_c_base_destination.$fic_echeance a1,$vl_c_base_destination.$fic_reglement_det a2 set a2.devise_paye=a1.devise_paye where a1.echeance_cleunik=a2.echeance_cleunik;";
_graal_exec_requete($sql_req);
echo("$i réglement importés, $j réglement ignorés ($m comptes comptables introuvables !!");
?>
