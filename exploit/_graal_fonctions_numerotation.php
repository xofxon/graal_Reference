<?php
function _graal_numerotation_formate($vv_nombre,$vv_chaine_init) {
global $n ;
$n = $vv_nombre ;
$t=$vv_chaine_init;
//$t = "Ref : {#AAAA#}-{#MM#}/ND-{#nnnnnn#}" ;
$t2 = preg_replace_callback('!\{#(n+)#\}!', '_graal_numerotation_varpad' , $t) ;
$t2=str_replace("{#JJ#}",date("d"),$t2);
$t2=str_replace("{#MM#}",date("m"),$t2);
$t2=str_replace("{#AAAA#}",date("Y"),$t2);
$t2=str_replace("{#AA#}",date("y"),$t2);
$t2=str_replace("{#HH#}",date("H"),$t2);
$t2=str_replace("{#mm#}",date("i"),$t2);
$t2=str_replace("{#acteur#}",$vv_nombre,$t2);
return $t2 ;
}
function _graal_numerotation_varpad($ma) {
  global $n ;
  return str_pad($n, strlen($ma[1]), '0', STR_PAD_LEFT) ;
}
function _graal_numerote($num_cleunik) {
  //  Numérotation automatique
  $sql_req_01="select description,der_numero from _numerotations where num_cleunik=$num_cleunik;";
  $result_01=_graal_requete_bd($sql_req_01);
  $row_01=mysql_fetch_assoc($result_01);
  $vl_c_format=$row_01['description'];
  $vl_e_valeur=$row_01['der_numero'];
  _graal_libere_requete_bd($result_01);
	if(preg_match("/{#n/i",$vl_c_format)) {
		$vl_e_valeur++;
  		//  Mise à jour de la numérotation
  		$sql_req_01="UPDATE _numerotations set der_numero=$vl_e_valeur,dateheuremodif=now() where num_cleunik=$num_cleunik;";
  		if(_graal_exec_requete($sql_req_01)!="ok") {$vf_c_retour=-4;}
	}
  return addslashes(_graal_numerotation_formate($vl_e_valeur,$vl_c_format));
}
function _graal_numerotation_compta_apisoft_frla($num_cleunik,$vl_codealphanum15){
$sql_req="select description,der_numero from _numerotations where num_cleunik=$num_cleunik;";
$result=_graal_requete_bd($sql_req);
if (mysql_num_rows($result)!=0) {
  $row=mysql_fetch_assoc($result);
  $vl_c_format=$row['description'];
  $vl_e_valeur=$row['der_numero'];
  _graal_libere_requete_bd($result);
	if(preg_match("/{#n/i",$vl_c_format)) {
		$vl_e_valeur++;
  		//  Mise à jour de la numérotation
  		$sql_req_01="UPDATE _numerotations set der_numero=$vl_e_valeur,dateheuremodif=now() where num_cleunik=$num_cleunik;";
  		if(_graal_exec_requete($sql_req_01)!="ok") {$vf_c_retour=-4;}
	}
	if(preg_match("/{#acteur#}/i",$vl_c_format)) {
		$code=addslashes(_graal_numerotation_formate($vl_codealphanum15,$vl_c_format));
	} else {
		$code=addslashes(_graal_numerotation_formate($vl_e_valeur,$vl_c_format));
	}
	return $code;
} else {
  return "";
}
}
function _graal_numerotation_compta_orphelins(){
	/*
	 * On ne gère, au 14 janvier 2010, que les clients
	 */
	$sql_req ="select a1.act_cleunik,a1.raisonsoc,a1.codealphanum15,a2.pc_cleunik as pc_cleunik_acteur from _acteurs a1 left join _act_compta a2 on a1.act_cleunik=a2.act_cleunik";
	$sql_req.=" where (a2.pc_cleunik is null or a2.pc_cleunik=-1) and a1.typeacteur=110003;";
	$result_00 = _graal_requete_bd($sql_req);
	echo $sql_req.EOL;
	while ($row = mysql_fetch_assoc($result_00)) {
	  $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","_param_pc");
	  $vl_codealphanum15=addslashes($row['codealphanum15']);
	  $vl_comptecompta=_graal_numerotation_compta_apisoft_frla(9,$vl_codealphanum15);
	  $act_cleunik=$row['act_cleunik'];
	  echo $vl_codealphanum15.EOL;
	  flush();
	  if (trim($vl_codealphanum15!="")){
	  	$sql_req_04="select pc_cleunik from _param_pc where code='$vl_codealphanum15';";
	  	echo $sql_req_04.EOL;
		$result_04 = _graal_requete_bd($sql_req_04);
		if (mysql_num_rows($result_04) != 0) {
			$row_04 = mysql_fetch_assoc($result_04);
			$vf_e_pc_cleunik=$row_04["pc_cleunik"];
			echo "trouvé".EOL;
			$sql_req_03 = "update _act_compta set pc_cleunik=$vf_e_pc_cleunik where act_cleunik=$act_cleunik;";
		   _graal_exec_requete($sql_req_03);
		   echo $sql_req_03.EOL;
		} else {
			$intitule=addslashes($row['raisonsoc']);
		  $sql_req_02 = "insert into _param_pc (pc_cleunik,code,intitule,actif) VALUES ($vf_e_pc_cleunik,'$vl_comptecompta','$intitule',1);";
		  echo $sql_req_02.EOL;
		  _graal_exec_requete($sql_req_02);
		  $sql_req_03 = "update _act_compta set pc_cleunik=$vf_e_pc_cleunik where act_cleunik=$act_cleunik;";
		  _graal_exec_requete($sql_req_03);
		  echo $sql_req_03.EOL;
		}
    	_graal_libere_requete_bd($result_04);
	  }
	}
	_graal_libere_requete_bd($result_00);
	//$sql_req="update _act_compta f1 left join _param_pc f3 on f1.compte=f3.code set f1.pc_cleunik=f3.pc_cleunik;";
	//_graal_exec_requete($sql_req);
}
function _graal_numerotation_compta_orphelins_bis(){
	/*
	 * On ne gère, au 14 janvier 2010, que les clients
	 */
	$sql_req ="select a1.act_cleunik,a1.raisonsoc,a1.codealphanum15,a2.pc_cleunik as pc_cleunik_acteur from _acteurs a1 left join _act_compta a2 on a1.act_cleunik=a2.act_cleunik";
	$sql_req.=" where (a2.pc_cleunik is null or a2.pc_cleunik=-1) and a1.typeacteur=110003;";
	$result = _graal_requete_bd($sql_req);
	$vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","_param_pc");
	//echo $sql_req.EOL;
	while ($row = mysql_fetch_assoc($result)) {

	  $vl_codealphanum15=addslashes($row['codealphanum15']);
	  $vl_comptecompta=_graal_numerote(9);
	  $act_cleunik=$row['act_cleunik'];
	  echo $vl_comptecompta.EOL;
	  flush();
	  if (trim($vl_comptecompta!="")){
	  	$sql_req_04="select pc_cleunik from _param_pc where code='$vl_comptecompta';";
	  	//echo $sql_req_04.EOL;
		$result_04 = _graal_requete_bd($sql_req_04);
		if (mysql_num_rows($result_04) != 0) {
			$row_04 = mysql_fetch_assoc($result_04);
			$vl_e_pc_cleunik=$row_04["pc_cleunik"];
			//echo "trouvé".EOL;
			$sql_req_03 = "update _act_compta set pc_cleunik=$vl_e_pc_cleunik where act_cleunik=$act_cleunik;";
		   _graal_exec_requete($sql_req_03);
		   //echo $sql_req_03.EOL;
		} else {
			$intitule=addslashes($row['raisonsoc']);
			$vf_e_pc_cleunik++;
		  $sql_req_02 = "insert into _param_pc (pc_cleunik,code,intitule,actif) VALUES ($vf_e_pc_cleunik,'$vl_comptecompta','$intitule',1);";
		  //echo $sql_req_02.EOL;
		  _graal_exec_requete($sql_req_02);
		  $sql_req_03 = "update _act_compta set pc_cleunik=$vf_e_pc_cleunik where act_cleunik=$act_cleunik;";
		  _graal_exec_requete($sql_req_03);
		  //echo $sql_req_03.EOL;
		}
    	_graal_libere_requete_bd($result_04);
	  }
	}
	_graal_libere_requete_bd($result);
	//$sql_req="update _act_compta f1 left join _param_pc f3 on f1.compte=f3.code set f1.pc_cleunik=f3.pc_cleunik;";
	//_graal_exec_requete($sql_req);
}

?>
