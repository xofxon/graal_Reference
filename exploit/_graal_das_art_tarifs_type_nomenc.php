<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_c_dico_00018=fa_recup_dico('dico_00018');
$vl_c_dico_00083=fa_recup_dico('dico_00083');
$vl_c_dico_00084=fa_recup_dico('dico_00084');
$vl_c_dico_00085=fa_recup_dico('dico_00085');
$vl_c_dico_00150=fa_recup_dico('dico_00150');
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","10000113"));
$vl_actif=intval(fa_recup_param("actif",1));
$sql_req="SELECT n1.art_cleunik,n1.pr_generique,n1.nbdec_prix,n3.pr,n3.nbdec_pr,n4.der_pa,n4.pamp 
 FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) where n1.art_cleunik=$vl_e_art_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nbdec_pr=fa_ent_xml($row['nbdec_pr']);
$nbdec_prix=fa_ent_xml($row['nbdec_prix']);
$vl_derpa=fa_reel(fa_ent_xml($row['der_pa']),$nbdec_prix);
$vl_pamp=fa_reel(fa_ent_xml($row['pamp']),$nbdec_prix);
$vl_pr=fa_reel(fa_ent_xml($row['pr']),$nbdec_pr);
$vl_pr_generique=fa_reel(fa_ent_xml($row['pr_generique']),$nbdec_prix);
if ($vl_derpa==""){$vl_derpa=0;}
if ($vl_pamp==""){$vl_pamp=0;}
if ($vl_pr==""){$vl_pr=0;}
//$vl_pr=$vl_pr_generique;
_graal_libere_requete_bd($result);
$sql_req = "SELECT 'ah06' as prop,tar_cleunik,pu_reference,choix_code,choix_valeur_texte_01,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,_art_tarifs.pu_reference
 FROM _art_tarifs,_choix where choix_cleunik=tarif_cleunik and art_cleunik=$vl_e_art_cleunik and act_cleunik=0 and type=2 
 union 
 SELECT 'ai14' as prop,tar_cleunik,pu_reference,choix_code,choix_valeur_texte_01,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,_art_tarifs.pu_reference,_art_tarifs.nb_dec
  FROM _art_tarifs,_choix where choix_cleunik=tarif_cleunik and art_cleunik=$vl_e_art_cleunik and act_cleunik=0 and type=1";
switch ($vl_actif) {
  case 1 : $sql_req.= " and _art_tarifs.actif=1";break;
  case 2 : $sql_req.= " and _art_tarifs.actif=2";break;
  case 3 : break;
}
$sql_req.=" order by choix_valeur_texte_01;";
$result = _graal_requete_bd($sql_req);
$num_rows = mysql_num_rows($result);
$num_rows+=5;
echo('<donnees>');
	echo('<quoi ');
    echo(' tar_cleunik="-5"');
    echo(' tar_designation="'.$vl_c_dico_00150.'"');
    echo(' pu_reference="'.$vl_pr_generique.'"');
		echo(' nbdec="'.$nbdec_prix.'"');
    echo(' nombre="'.$num_rows.'"');
  echo('/>');
	echo('<quoi ');
    echo(' tar_cleunik="-4"');
    echo(' tar_designation="'.$vl_c_dico_00018.'"');
    echo(' pu_reference="0"');
		echo(' nbdec="'.$nbdec_prix.'"');
    echo(' nombre="'.$num_rows.'"');
  echo('/>');
	echo('<quoi ');
    echo(' tar_cleunik="-1"');
    echo(' tar_designation="'.$vl_c_dico_00083.'"');
    echo(' pu_reference="'.$vl_derpa.'"');
		echo(' nbdec="'.$nbdec_prix.'"');
    echo(' nombre="'.$num_rows.'"');
  echo('/>');
	echo('<quoi ');
    echo(' tar_cleunik="-3"');
    echo(' tar_designation="'.$vl_c_dico_00085.'"');
    echo(' pu_reference="'.$vl_pamp.'"');
		echo(' nbdec="'.$nbdec_prix.'"');		
    echo(' nombre="'.$num_rows.'"');
  echo('/>');
	echo('<quoi ');
    echo(' tar_cleunik="-2"');
    echo(' tar_designation="'.$vl_c_dico_00084.'"');
    echo(' pu_reference="'.$vl_pr.'"');
		echo(' nbdec="'.$nbdec_pr.'"');		
    echo(' nombre="'.$num_rows.'"');
  echo('/>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
    echo(' tar_cleunik="'.fa_ent_xml($row['tar_cleunik']).'"');
    echo(' code_type_achat="'.fa_ent_xml($row['choix_code']).'"');
    echo(' tar_designation="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
    echo(' tarif_type_achat="'.fa_ent_xml($row['pu_reference']).'"');
    if ($row['actif']==1) {
      echo(' properties=""');
    } else {
      echo(' properties="css_0001"');
    }
    echo(' datevalidite="'.fa_ent_xml($row['datevalidite']).'"');
    echo(' pu_reference="'.fa_ent_xml($row['pu_reference']).'"');
		echo(' nbdec="'.fa_ent_xml($row['nb_dec']).'"');
    echo(' prop="'.fa_ent_xml($row['prop']).'"');
    echo(' nombre="'.$num_rows.'"');
    echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
