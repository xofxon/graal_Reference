<?php
include("_graal_header_txt.inc.php");
$vl_c_code_banque=fa_recup_param('vl_etablissement','00000');
$vl_c_code_guichet=fa_recup_param('vl_guichet','00000');
$vl_c_compte=fa_recup_param('vl_compte','00000000000');
$vl_c_cle=fa_recup_param('vl_cle','00');
$vl_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','0'));
$retour=verif_rib($vl_c_code_banque,$vl_c_code_guichet,$vl_c_compte,$vl_c_cle);
switch ($retour) {
  case 'ok':
    $iban=Calcul_Iban($vl_c_code_banque,$vl_c_code_guichet,$vl_c_compte,$vl_c_cle);
    $iban_papi=substr($iban,0,4).' '.substr($iban,4,4).' '.substr($iban,8,4).' '.substr($iban,12,4).' '.substr($iban,16,4).' '.substr($iban,20,4).' '.substr($iban,24,3);
    //  Représentation française 6 paquets de 4 caractères et un paquet de 3
    $vl_iban_cleunik=_graal_requete_max("iban_cleunik","_act_iban");
    $sql_req = "INSERT INTO _act_iban set iban_cleunik=$vl_iban_cleunik,act_cleunik=$vl_act_cleunik,iban_info='$iban',iban_papi='$iban_papi';";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo='Le compte IBAN est bien créé';}
    echo ($vf_c_echo);
    break;
  default :
    echo $retour;
}
function verif_rib($CodeBanque , $CodeGuichet , $NoCompte , $CleRib) {
  If (strlen($CodeBanque)!=5) {return 'Un code banque doit comporter 5 chiffres ou lettres';}
  Elseif (strlen($CodeGuichet)!=5) {return 'Un code guichet doit comporter 5 chiffres ou lettres';}
  Elseif (strlen($NoCompte)!=11) {return 'Un numéro de compte doit comporter 11 chiffres ou lettres';}
  Elseif (strlen($CleRib)!=2) {return 'Une clé RIB doit comporter 2 chiffres ou lettres';}
  else { return 'ok';}
}
function Calcul_Iban($CodeBanque , $CodeGuichet , $NoCompte , $CleRib) {
$Iban=$CodeBanque.$CodeGuichet.$NoCompte.$CleRib;
// La concaténation Code banque+Code guichet+N° de compte+Clé RIB est-elle une chaine alphanumérique
if(eregi('[a-z]',$Iban)) {
//Si c'est le cas on va calculer le montant de la clé IBAN
$Iban3=$Iban;
$Iban=$Iban.'FR00';
$Iban=str_replace("A","10", $Iban);
$Iban=str_replace("B","11", $Iban);
$Iban=str_replace("C","12", $Iban);
$Iban=str_replace("D","13", $Iban);
$Iban=str_replace("E","14", $Iban);
$Iban=str_replace("F","15", $Iban);
$Iban=str_replace("G","16", $Iban);
$Iban=str_replace("H","17", $Iban);
$Iban=str_replace("I","18", $Iban);
$Iban=str_replace("J","19", $Iban);
$Iban=str_replace("K","20", $Iban);
$Iban=str_replace("L","21", $Iban);
$Iban=str_replace("M","22", $Iban);
$Iban=str_replace("N","23", $Iban);
$Iban=str_replace("O","24", $Iban);
$Iban=str_replace("P","25", $Iban);
$Iban=str_replace("Q","26", $Iban);
$Iban=str_replace("R","27", $Iban);
$Iban=str_replace("S","28", $Iban);
$Iban=str_replace("T","29", $Iban);
$Iban=str_replace("U","30", $Iban);
$Iban=str_replace("V","31", $Iban);
$Iban=str_replace("W","32", $Iban);
$Iban=str_replace("X","33", $Iban);
$Iban=str_replace("Y","34", $Iban);
$Iban=str_replace("Z","35", $Iban);

//echo $Iban;

$B1=substr($Iban,0,9);
$B2=substr($Iban,9,7);
$B3=substr($Iban,16,7);
$B4=substr($Iban,23);


$Mod=fmod($B1,97);
$Mod=$Mod.$B2;


$Mod=fmod($Mod,97);
$Mod=$Mod.$B3;


$Mod=fmod($Mod,97);
$Mod=$Mod.$B4;

$Mod=fmod($Mod,97);
$Mod=98 - $Mod;

If($Mod<10) {$Mod3='0'.$Mod;}else{$Mod3=$Mod;}
return 'FR'.$Mod3.$Iban3;
}
else
// Sinon la clé IBAN correspond à l'indicatif du pays + 76 + concaténation Code banque+Code guichet+N° de compte+Clé RIB
{
return 'FR76'.$Iban;
}
}
?>
