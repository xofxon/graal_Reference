# Pour mettre à jour les codes postaux des adresses des fournisseurs (France Lampes)
update graal_frla._act_adresses f1 left join graal_frla._acteurs f2 using(act_cleunik) left join apisoft_fla_gc.fournisseur f3 on f2.codealphanum15="T"+f3.Code set f1.adr_cp=f3.CP where f2.typeacteur=110004
# mettre à jour les cleunik des deb à partir des infos d'une aure base
update graal_frla._article a1 left join graal_travail.articles_deb a2 on a1.code=a2.Code left join graal_frla.nc_2009_autosuffisant a3 on a2.`Code nomenclature DEB`=a3.code_sans_espace set a1.nc_2009_autosuffisant_cleunik=a3.cleunik;
# mettre à jour les nom sur les adresses des documents commerciaux
update graal_reference._offcli_adresses f1 left join graal_reference._offcli_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._cdecli_adresses f1 left join graal_reference._cdecli_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._livcli_adresses f1 left join graal_reference._livcli_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._faccli_adresses f1 left join graal_reference._faccli_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._retcli_adresses f1 left join graal_reference._retcli_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._avocli_adresses f1 left join graal_reference._avocli_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._demfou_adresses f1 left join graal_reference._demfou_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._cdefou_adresses f1 left join graal_reference._cdefou_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._recfou_adresses f1 left join graal_reference._recfou_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._retfou_adresses f1 left join graal_reference._retfou_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
update graal_reference._facfou_adresses f1 left join graal_reference._facfou_entetes f2 using(commercial_cleunik) left join _acteurs f3 using(act_cleunik) set f1.adr_nom=case f3.nomcommercial when '' then f3.raisonsoc else f3.nomcommercial END  where f1.adr_nom is null;
#récupérer le compte comptable des fournisseurs
update _act_compta f1 left join _acteurs f2 using(act_cleunik) set pc_cleunik=(select pc_cleunik from _param_pc where code=concat('401000',codealphanum15)) where f1.pc_cleunik=60000003 and f2.typeacteur=110004;
#récupérer le compte comptable des fournisseurs
update _act_compta f1 left join _acteurs f2 using(act_cleunik) set pc_cleunik=(select pc_cleunik from _param_pc where code=concat('401000',codealphanum15)) where f1.pc_cleunik=60000003 and f2.typeacteur=110004;
update _act_compta f1 left join _acteurs f2 using(act_cleunik) set pc_cleunik=(select pc_cleunik from _param_pc where code=concat('401',codealphanum15,'000')) where (f1.pc_cleunik=60000003 or f1.pc_cleunik is null) and f2.typeacteur=110004;
#mettre sur enregistrment compta le compte comptable du fournisseur
update _facfou_compta f1 left join _facfou_entetes f2 using(commercial_cleunik) left join _act_compta f3 on f3.act_cleunik=f2.act_cleunik set f1.pc_cleunik=f3.pc_cleunik where f1.ordre=0 and f1.pc_cleunik=60000003 and f3.pc_cleunik is not null;

https://baronnat.xsoftware.fr/19c08ea0-5497-1029-9c29-001109b5c1d9/graal/exploit/_graal_exporte_requete_vers_xls.php?vl_c_requete=select f3.code,f3.description,(SELECT pu FROM _recfou_lignes f1 left join _recfou_entetes f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code and year(dateheureexpedition)=2009 order by dateheureexpedition desc LIMIT 1) as pu from _article f3 where (SELECT pu FROM _recfou_lignes f1 left join _recfou_entetes f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code and year(dateheureexpedition)=2009 order by dateheureexpedition desc LIMIT 1) is not null&vl_c_nom_fichier_xls=essai.xls&vl_c_no_requete=toto

https://baronnat.xsoftware.fr/19c08ea0-5497-1029-9c29-001109b5c1d9/graal/exploit/_graal_exporte_requete_vers_xls.php?vl_c_requete=select f3.code,f3.description,(SELECT pu FROM _fab_lignes f1 left join _fab_entetes f2 on f1.fab_cleunik=f2.fab_cleunik where f1.art_cleunik=f3.art_cleunik and year(f1.dateheurecreation)=2009 order by f1.dateheurecreation desc LIMIT 1) as pu from _article f3 where (SELECT pu FROM _fab_lignes f1 left join _fab_entetes f2 on f1.fab_cleunik=f2.fab_cleunik where f1.art_cleunik=f3.art_cleunik and year(f1.dateheurecreation)=2009 order by f1.dateheurecreation desc LIMIT 1) is not null&vl_c_nom_fichier_xls=pu_fab.xls&vl_c_no_requete=toto

remplacer wanadoo.fr par orange.fr dans les adresses de courriel
update _act_interlo_mail set refweb =replace(lower(refweb),'wanadoo.fr','orange.fr');

#Remplacer la taxe parafiscale des commandes clients postérieures au 1° avril 2010
update _cdecli_lignes r1 left join _cdecli_entetes r2 on r1.commercial_cleunik=r2.commercial_cleunik left join _graal_act f1 on r2.action_cleunik =f1.action_cleunik_gauche left join _choix f2 on f1.choix_cleunik_droite = f2.choix_cleunik left join _choix f3 on f1.choix_cleunik_gauche=f3.choix_cleunik left join _graal_act f4 on f4.action_cleunik_gauche = f1.action_cleunik_droite left join _choix f5 on f4.choix_cleunik_droite=f5.choix_cleunik left join _actions on _actions.action_cleunik=f1.action_cleunik_gauche  left join _graal a2 on a2.action_cleunik=_actions.action_cleunik  set r1.tpf_cleunik=40000002 where r1.tpf_cleunik=10000001 and f1.choix_cleunik_gauche=-115 and (f1.choix_cleunik_droite=-118 or f1.choix_cleunik_droite=-120) and (f4.choix_cleunik_droite=-120 or f4.choix_cleunik_droite is null)  AND ((_actions.dateheuredebut between '20100401000000' and '20610123235959') or (_actions.dateheurefin between '20100401000000' and '20610123235959') or ( _actions.dateheuredebut < '20100401000000' and _actions.dateheurefin > '20610123235959'));

#Remplacer la taxe parafiscale des livraisons de commandes clients postérieures au 1° avril 2010
update _livcli_lignes r1 left join _livcli_entetes r2 on r1.commercial_cleunik=r2.commercial_cleunik left join _graal_act f1 on r2.action_cleunik =f1.action_cleunik_droite left join _choix f2 on f1.choix_cleunik_droite = f2.choix_cleunik left join _choix f3 on f1.choix_cleunik_gauche=f3.choix_cleunik left join _graal_act f4 on f4.action_cleunik_gauche = f1.action_cleunik_droite left join _choix f5 on f4.choix_cleunik_droite=f5.choix_cleunik left join _actions on _actions.action_cleunik=f1.action_cleunik_gauche  left join _graal a2 on a2.action_cleunik=_actions.action_cleunik  set r1.tpf_cleunik=40000002 where r1.tpf_cleunik=10000001 and f1.choix_cleunik_gauche=-115 and (f1.choix_cleunik_droite=-118 or f1.choix_cleunik_droite=-120) and (f4.choix_cleunik_droite=-120 or f4.choix_cleunik_droite is null)  AND ((_actions.dateheuredebut between '20100401000000' and '20610123235959') or (_actions.dateheurefin between '20100401000000' and '20610123235959') or ( _actions.dateheuredebut < '20100401000000' and _actions.dateheurefin > '20610123235959')) and (select count(*) from _actions_noire where _actions_noire.action_cleunik=_actions.action_cleunik and _actions_noire.uti_cleunik=1) = 0;

#Remplacer la taxe parafiscale des factures de commandes clients postérieures au 1° avril 2010
update _graal_act f1 left join _choix f2 on f1.choix_cleunik_droite = f2.choix_cleunik left join _choix f3 on f1.choix_cleunik_gauche=f3.choix_cleunik left join _graal_act f4 on f4.action_cleunik_gauche = f1.action_cleunik_droite left join _choix f5 on f4.choix_cleunik_droite=f5.choix_cleunik left join _actions on _actions.action_cleunik=f1.action_cleunik_gauche  left join _graal a2 on a2.action_cleunik=_actions.action_cleunik left join _faccli_entetes r2 on r2.action_cleunik=f4.action_cleunik_droite left join _faccli_lignes r1 on r1.commercial_cleunik=r2.commercial_cleunik  set r1.tpf_cleunik=40000002 where r1.tpf_cleunik=10000001 and f1.choix_cleunik_gauche=-115 and (f1.choix_cleunik_droite=-118 or f1.choix_cleunik_droite=-120) and (f4.choix_cleunik_droite=-120 or f4.choix_cleunik_droite is null)  AND ((_actions.dateheuredebut between '20100401000000' and '20610123235959') or (_actions.dateheurefin between '20100401000000' and '20610123235959') or ( _actions.dateheuredebut < '20100401000000' and _actions.dateheurefin > '20610123235959'));


select r1.* _cdecli_lignes r1 left join _cdecli_entetes r2 on r1.commercial_cleunik=r2.commercial_cleunik left join _graal_act f1 on r2.action_cleunik =f1.action_cleunik_gauche left join _choix f2 on f1.choix_cleunik_droite = f2.choix_cleunik left join _choix f3 on f1.choix_cleunik_gauche=f3.choix_cleunik left join _graal_act f4 on f4.action_cleunik_gauche = f1.action_cleunik_droite left join _choix f5 on f4.choix_cleunik_droite=f5.choix_cleunik left join _actions on _actions.action_cleunik=f1.action_cleunik_gauche  left join _graal a2 on a2.action_cleunik=_actions.action_cleunik  where r1.tpf_cleunik=10000001 and f1.choix_cleunik_gauche=-115 and (f1.choix_cleunik_droite=-118 or f1.choix_cleunik_droite=-120) and (f4.choix_cleunik_droite=-120 or f4.choix_cleunik_droite is null)  AND ((_actions.dateheuredebut between '20100401000000' and '20610123235959') or (_actions.dateheurefin between '20100401000000' and '20610123235959') or ( _actions.dateheuredebut < '20100401000000' and _actions.dateheurefin > '20610123235959'));


update _cdecli_lignes r1 left join _cdecli_entetes r2 on r1.commercial_cleunik=r2.commercial_cleunik left join _actions on _actions.action_cleunik=r2.action_cleunik set r1.tpf_cleunik=10000001 where r1.tpf_cleunik=40000002 and ( _actions.dateheuredebut < '20100401000000');


select * from _cdecli_lignes where commercial_cleunik=10008275
select _actions.dateheuredebut,f1.*,f2.* from _cdecli_lignes f1 left join _cdecli_entetes f2 on f1.commercial_cleunik=f2.commercial_cleunik left join _actions on _actions.action_cleunik=f2.action_cleunik where f1.tpf_cleunik=40000002# 12 centimes après 1° avril
select f1.*,f2.* from _cdecli_lignes f1 left join _cdecli_entetes f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.tpf_cleunik=10000001# 15 centimes avant 1° avril

update _cdecli_lignes r1 left join _cdecli_entetes r2 on r1.commercial_cleunik=r2.commercial_cleunik left join _actions on _actions.action_cleunik=r2.action_cleunik set r1.tpf_cleunik=10000001 where r1.tpf_cleunik=40000002 and ( _actions.dateheuredebut < '20100401000000');
update _cdecli_lignes r1 left join _cdecli_entetes r2 on r1.commercial_cleunik=r2.commercial_cleunik left join _actions on _actions.action_cleunik=r2.action_cleunik set r1.tpf_cleunik=40000002 where r1.tpf_cleunik<>-1 and ( _actions.dateheuredebut >= '20100401000000');




