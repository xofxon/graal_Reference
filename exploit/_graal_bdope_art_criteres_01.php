<?php
include("_graal_header_txt.inc.php");
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_critere_cleunik=intval(fa_recup_param("vl_critere_cleunik",""));
$vl_art_cleunik=intval(fa_recup_param("vl_art_cleunik",""));
$vl_choix_cleunik=intval(fa_recup_param("vl_choix_cleunik",""));
$vl_c_genrecritere=fa_recup_param('genrecritere','');
$vl_te_art_cleunik=fa_recup_param('vl_te_art_cleunik','');
$vl_te_choix_cleunik=fa_recup_param('vl_te_choix_cleunik','');
$vl_te_critere_cleunik=fa_recup_param('vl_te_critere_cleunik','');
switch ($vl_c_genrecritere) {
  case "entreprise": $vl_e_uti_cleunik=0;break;
  case "moi":$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));break;
}
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _art_choix_fixes WHERE critere_cleunik = $vl_critere_cleunik and art_cleunik=$vl_art_cleunik and choix_cleunik=$vl_choix_cleunik and uti_cleunik=$vl_e_uti_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
//    if($vf_c_echo=='ok') {$vf_c_echo='ok';} else {$vf_c_echo='-1 ->'.$sql_req;}
    break;
  case $vf_c_action=="enregistrer":
    $sql_req = "INSERT INTO _art_choix_fixes set critere_cleunik=$vl_critere_cleunik,art_cleunik=$vl_art_cleunik,choix_cleunik=$vl_choix_cleunik,uti_cleunik=$vl_e_uti_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
//    if($vf_c_echo=='ok') {$vf_c_echo='ok';} else {$vf_c_echo='-1 ->'.$sql_req;}
    break;
  case $vf_c_action=="enregistrer_kilometre":
    $vl_te_art_cleunik=unserialize(stripslashes($vl_te_art_cleunik));
    $vl_te_choix_cleunik=unserialize(stripslashes($vl_te_choix_cleunik));
    $vl_te_critere_cleunik=unserialize(stripslashes($vl_te_critere_cleunik));
    $sql_req="REPLACE INTO _art_choix_fixes (art_cleunik,choix_cleunik,critere_cleunik,uti_cleunik) VALUES ";$sql_req_02="";$i=0;$b=100;
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_te_art_cleunik as $vl_raf) {
      $vl_e_i++;
      if ($vl_e_i!=0) { // la première dimension du tableau est toujours non significative (évite de planter !!!!)
        $vl_art_cleunik=$vl_te_art_cleunik[$vl_e_i];
        $vl_e_j=-1;
        foreach($vl_te_critere_cleunik as $vl_raf_01) {
          $vl_e_j++;
          if ($vl_te_critere_cleunik[$vl_e_j]!=0) {
            $vl_critere_cleunik=$vl_te_critere_cleunik[$vl_e_j];
            $vl_choix_cleunik=$vl_te_choix_cleunik[$vl_e_j];
            $sql_req_02 .="($vl_art_cleunik,$vl_choix_cleunik,$vl_critere_cleunik,$vl_e_uti_cleunik),";
            if ($i % $b==0){
              $sql_req_02=substr($sql_req_02, 0, -1);
              $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
              //if($result_02 === false) {$vf_c_echo='Erreur 02 ->'.mysql_error($cnx) . $sql_req_02;} else {$vf_c_echo='ok';}
              if($result_02 === false) {$vf_c_echo='Erreur 02 ->';} else {$vf_c_echo='ok';}
              $sql_req_02="";
            }
          }
        }
      }
    }
    if ($sql_req_02!="") {
      $sql_req_02=substr($sql_req_02, 0, -1);
      $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
      //if($result_02 === false) {$vf_c_echo='Erreur 02 ->'.mysql_error($cnx) . $sql_req_02;} else {$vf_c_echo='ok';}
      if($result_02 === false) {$vf_c_echo='Erreur 02 ->';} else {$vf_c_echo='ok';}
    }
    break;
  case $vf_c_action=="enregistrer_kilometre_bis":
    $vl_te_art_cleunik=unserialize(stripslashes($vl_te_art_cleunik));
    $vl_te_choix_cleunik=unserialize(stripslashes($vl_te_choix_cleunik));
    $vl_te_critere_cleunik=unserialize(stripslashes($vl_te_critere_cleunik));
    $sql_req="REPLACE INTO _art_choix_fixes (art_cleunik,choix_cleunik,critere_cleunik,uti_cleunik) VALUES ";$sql_req_02="";
    $i=0;
    $b=500;
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
        $vl_e_j=-1;
        foreach($vl_te_critere_cleunik as $vl_raf_01) {
          $vl_e_j++;
          if ($vl_te_critere_cleunik[$vl_e_j]!=0) {
          $vl_art_cleunik=$vl_te_art_cleunik[$vl_e_j];
            $vl_critere_cleunik=$vl_te_critere_cleunik[$vl_e_j];
            $vl_choix_cleunik=$vl_te_choix_cleunik[$vl_e_j];
            $sql_req_02 .="($vl_art_cleunik,$vl_choix_cleunik,$vl_critere_cleunik,$vl_e_uti_cleunik),";
            $i++;
            if ($i % $b==0){
              $sql_req_02=substr($sql_req_02, 0, -1);
              $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
              if($result_02 === false) {$vf_c_echo='Erreur 02 ->';} else {$vf_c_echo='ok';}
              $sql_req_02="";
            }
          }
        }
    if ($sql_req_02!="") {
      $sql_req_02=substr($sql_req_02, 0, -1);
      $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
      if($result_02 === false) {$vf_c_echo='Erreur 02 ->';} else {$vf_c_echo='ok';}
    }
    break;
  case $vf_c_action=="supprimer_kilometre":
    $vl_te_art_cleunik=unserialize(stripslashes($vl_te_art_cleunik));
    $vl_te_choix_cleunik=unserialize(stripslashes($vl_te_choix_cleunik));
    $vl_te_critere_cleunik=unserialize(stripslashes($vl_te_critere_cleunik));
    $vl_e_i=-1;
    foreach($vl_te_art_cleunik as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_te_art_cleunik[$vl_e_i];
      $vl_critere_cleunik=$vl_te_critere_cleunik[$vl_e_i];
      $vl_choix_cleunik=$vl_te_choix_cleunik[$vl_e_i];
      $sql_req = "DELETE FROM _art_choix_fixes WHERE critere_cleunik = $vl_critere_cleunik and art_cleunik=$vl_art_cleunik and choix_cleunik=$vl_choix_cleunik and uti_cleunik=$vl_e_uti_cleunik;";
      $vf_c_echo=_graal_exec_requete($sql_req);
    }
    break;
    
  case $vf_c_action=="??????":
    echo ('bordel !!!');
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
