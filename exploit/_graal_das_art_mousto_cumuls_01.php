<?php
include("_graal_header_xml.inc.php");
$vl_c_dico_00086=fa_recup_dico("dico_00086");
$vl_c_dico_00087=fa_recup_dico("dico_00087");
$vl_c_dico_00088=fa_recup_dico("dico_00088");
define('EOL', "\r\n");
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","10000113"));
$vl_actif=intval(fa_recup_param("actif",3));
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));
$vl_e_qte_nulle=intval(fa_recup_param("vl_e_qte_nulle",'3'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_nature=fa_recup_param("nature",'0');
$vl_c_type=fa_recup_param("type","0");
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_type_dates=intval(fa_recup_param("selection_date","0"));
$vl_c_genre_mvt=fa_recup_param("vl_c_genre_mvt","-1");
switch ($vl_c_type_dates){
	case 1:$quelle_date="f1.dateheuremvt";break;
	case 2:$quelle_date="f1.dateheuresaisie";break;
}
switch ($vl_c_nature) {
  case 1: $sql_00="'' as nature";$sql_01.= " 1";$sql_02="";$sql_03="";break;// Quantités
  case 2: $sql_00="f3.capacite as nature";$sql_01.= " f3.capacite";$sql_02=" JOIN _art_dimensions f3 USING ( art_cleunik ) ";$sql_03=" and f3.capacite<>0 ";break;// Volumes
  case 3: $sql_00="f3.poids_net as nature";$sql_01.= " f3.poids_net";$sql_02=" JOIN _art_dimensions f3 USING ( art_cleunik ) ";$sql_03=" and f3.poids_net<>0 ";break;// Poids net
  case 0: break;// Tous
}
$sql_req = "SELECT f2.art_cleunik, f2.code, f2.mnemotechnique, f2.description, sum( f1.qte_mvt ) as cumul_brut, f1.type_mvt, (sum( f1.qte_mvt )*$sql_01) as volume,$sql_00 FROM _mouvements_stock f1 JOIN _article f2 USING ( art_cleunik ) $sql_02 WHERE 1";
$sql_req.= " AND f1.type_mvt in ($vl_c_type) and ( $quelle_date between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND f2.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND f2.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND f2.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND f2.types_gestion & 4";break;
  case 'fabrication': $sql_req.= " AND f2.types_gestion & 8";break;
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND f2.actif=1";break;// Actifs
  case 2: $sql_req.= " AND f2.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_zone) {
  case '1': $sql_req.=" and f2.description like '$vl_c_recherche%'";break;//  Description courte
  case '2': $sql_req.=" and f2.code like '$vl_c_recherche%'";break;//  Code
  case '3': $sql_req.=" and f2.mnemotechnique like '$vl_c_recherche%'";break;//  Mnémotechnique
}
switch ($vl_c_genre_mvt){
	case '-1':
		break;
	default: $sql_req.=" and f1.genre_mvt in($vl_c_genre_mvt)";
		break;
}
$sql_req.= " $sql_03 group by f2.art_cleunik,f1.type_mvt";
switch ($vl_c_zone) {
  case '1': $sql_req.=" ORDER BY `description` ASC";break;//  Description courte
  case '2': $sql_req.=" ORDER BY `code` ASC";break;//  Code
  case '3': $sql_req.=" ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
$sql_req.= " LIMIT 0, $vl_e_limit";
//echo $sql_req;
switch ($vl_c_sortie) {
  case "das":
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
	exit();
    break;
}
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
    echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
    echo(' code="'.fa_ent_xml($row['code']).'"');
  	echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
  	echo(' description="'.fa_ent_xml($row['description']).'"');
  	$volume=$row['volume'];
  	if ($row['volume']==0) {
    	$val_volume=0;
    	$volume="";
  	} else {
 		$volume=fa_reel(fa_ent_xml($row['volume']),3);
 		$val_volume=fa_ent_xml($row['volume'])*1000;
  	}
  	echo(' volume="'.$volume.'"');
  	printf(' val_volume="%011u"',$val_volume);
   echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
