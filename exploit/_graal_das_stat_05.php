<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_stats.php");
$date_deb=fa_recup_param('date_deb','20610123');
$date_fin=fa_recup_param('date_fin','19610123');
$ml_art_01=intval(fa_recup_param('ml_art_01',1));
$ml_art_02=intval(fa_recup_param('ml_art_02',2));
$ml_art_03=intval(fa_recup_param('ml_art_03',4));
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik',-1));
$nombre=intval(fa_recup_param('nombre',0));
stats_rectif_dates($ml_art_03);
switch ($ml_art_02) {
  case 1:
  case 2:
  case 3:
		switch ($ml_art_03) {
		  case  1: $fic_cial="offcli";$coeff="1";break;
		  case  2: $fic_cial="cdecli";$coeff="1";break;
		  case  3: $fic_cial="livcli";$coeff="1";break;
		  case  4: $fic_cial="faccli";$coeff="1";break;
		  case  5: $fic_cial="demfou";$coeff="1";break;
		  case  6: $fic_cial="cdefou";$coeff="1";break;
		  case  7: $fic_cial="recfou";$coeff="1";break;
		  case  8: $fic_cial="facfou";$coeff="1";break;
		  case  9: $fic_cial="faccli";$coeff="1";break;
		  case 10: $fic_cial="avocli";$coeff="-1";break;
		  case 11: $fic_cial="retcli";$coeff="1";break;
		  case 12: $fic_cial="retfou";$coeff="1";break;
		}
		$uuid=_graal_requete_uuid();
		switch ($ml_art_03) {
		  case  1:
		  case  2:
		  case  3:
		  case  5:
		  case  6:
		  case  7:
		  case  8:
		  case  9:
		  case 10:
		  case 11:
		  case 12:
				switch ($ml_art_02) {
				  case 1: $sql_req="insert into _temp_stat_01 select 1,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
				  case 2: $sql_req="insert into _temp_stat_01 select 1,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
				  case 3: $sql_req="insert into _temp_stat_01 select 1,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
				}
				$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and f3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03";
				break;
			case 4:
				switch ($ml_art_02) {
				  case 1: $sql_req="insert into _temp_stat_01 select 1,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
				  case 2: $sql_req="insert into _temp_stat_01 select 1,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
				  case 3: $sql_req="insert into _temp_stat_01 select 1,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
				}
				$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and f3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03";
				$sql_req.=" union all ";
				
				$fic_cial="avocli";$coeff="-1";
				
				switch ($ml_art_02) {
				  case 1: $sql_req.=" select 1,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
				  case 2: $sql_req.=" select 1,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
				  case 3: $sql_req.=" select 1,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
				}
				$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and f3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03";
		}
		break;
  case 4:
		switch ($ml_art_03) {
		  case  1: $fic_cial_01="_offcli_entetes";$fic_cial_02="_vue_offcli_ht_01";$fic_cial_03="_vue_offcli_ht_00_inter";break;
		  case  2: $fic_cial_01="_cdecli_entetes";$fic_cial_02="_vue_cdecli_ht_01";$fic_cial_03="_vue_cdecli_ht_00_inter";break;
		  case  3: $fic_cial_01="_livcli_entetes";$fic_cial_02="_vue_livcli_ht_01";$fic_cial_03="_vue_livcli_ht_00_inter";break;
		  case  4: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_01";$fic_cial_03="_vue_faccli_ht_00_inter";break; //  Factures et avoirs (-110116,-110117) regroupés
		  case  5: $fic_cial_01="_demfou_entetes";$fic_cial_02="_vue_demfou_ht_01";$fic_cial_03="_vue_demfou_ht_00_inter";break;
		  case  6: $fic_cial_01="_cdefou_entetes";$fic_cial_02="_vue_cdefou_ht_01";$fic_cial_03="_vue_cdefou_ht_00_inter";break;
		  case  7: $fic_cial_01="_recfou_entetes";$fic_cial_02="_vue_recfou_ht_01";$fic_cial_03="_vue_recfou_ht_00_inter";break;
		  case  8: $fic_cial_01="_facfou_entetes";$fic_cial_02="_vue_facfou_ht_01";$fic_cial_03="_vue_facfou_ht_00_inter";break;
		  case  9: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_01";$fic_cial_03="_vue_faccli_ht_00_inter";break;
		  case 10: $fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_01";$fic_cial_03="_vue_avocli_ht_00_inter";break;
		  case 11: $fic_cial_01="_retcli_entetes";$fic_cial_02="_vue_retcli_ht_01";$fic_cial_03="_vue_retcli_ht_00_inter";break;
		  case 12: $fic_cial_01="_retfou_entetes";$fic_cial_02="_vue_retfou_ht_01";$fic_cial_03="_vue_retfou_ht_00_inter";break;
		  
		}
		switch ($ml_art_03) {
		  case  1:
		  case  2:
		  case  3:
		  case  5:
		  case  6:
		  case  7:
		  case  8:
		  case  9:
		  case 10:
		  case 11:
		  case 12:
				$uuid=_graal_requete_uuid();
				$sql_req="insert into _temp_stat_01 select 1,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=2 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and a3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" group by z03";
				$sql_req.=" union all ";
				$sql_req.=" select 1,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and a3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" group by z03";
				break;
		}
		switch ($ml_art_03) {
		  case  4:
				$uuid=_graal_requete_uuid();
				$sql_req="insert into _temp_stat_01 select 1,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=2 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and a3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" group by z03";
				$sql_req.=" union all ";
				$sql_req.=" select 1,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and a3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" group by z03";
				$sql_req.=" union all ";
				
				$fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_01";$fic_cial_03="_vue_avocli_ht_00_inter";$coeff="1";
				
				$sql_req.=" select 1,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) AS z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=2 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and a3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" group by z03";
				$sql_req.=" union all ";
				$sql_req.=" select 1,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) as z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				if ($vl_e_act_cleunik!=-1) {$sql_req.=" and a3.act_cleunik=$vl_e_act_cleunik";}
				$sql_req.=" group by z03";
				break;

		}
		break;
}
$vf_c_echo=_graal_exec_requete($sql_req);
		
//echo $sql_req;
$sql_req="Select @rang:=@rang+1 AS z00,sum(a1.montant) AS z01";
switch ($ml_art_04) {
  case 1: $sql_req.=",DATE_FORMAT(a1.dateheure,GET_FORMAT(DATE,'EUR')) as z02,a1.dateheure as z03";break;
  case 2: $sql_req.=",concat(WEEK(a1.dateheure),'-',Year(a1.dateheure)) as z02,concat(year(a1.dateheure),'-',week(a1.dateheure)) as z03";break;
  case 3: $sql_req.=",DATE_FORMAT(a1.dateheure,'%m-%Y') as z02,DATE_FORMAT(a1.dateheure,'%Y-%m') as z03";break;
  case 4: $sql_req.=",concat(quarter(a1.dateheure),'-',Year(a1.dateheure)) as z02,concat(year(a1.dateheure),'-',quarter(a1.dateheure)) as z03";break;
  case 5: $sql_req.=",Year(a1.dateheure) as z02,Year(a1.dateheure) as z03";break;
}
$sql_req.=" from _temp_stat_01 a1";
$sql_req.=" where a1.c_uuid='$uuid'";
$sql_req.=" group by z03";
switch ($ml_art_01) {
  case 1: $sql_req.=" order by z01 desc";break;
  case 2: $sql_req.=" order by z01 asc";break;
}
if ($nombre!=0) {$sql_req.=" limit $nombre;";}

//echo $sql_req;

_graal_requete_bd("SET @rang=0;");
$result = _graal_requete_bd($sql_req);
$vl_e_nombre_types=mysql_num_rows($result);
echo('<donnees>');
if ($vl_e_nombre_types!=0) { 
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
    echo(' z00="'.fa_ent_xml($row['z00']).'"');
		$z01_trie=fa_ent_xml($row['z01'])*1000;
		printf(' z01_tri="%011u"',$z01_trie);
    echo(' z01="'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'"');
    echo(' periode="'.fa_ent_xml($row['z02']).'"');
    echo(' z03="'.fa_ent_xml($row['z03']).'"');
    echo('/>');
  }
} else {
    echo('<quoi ');
    echo(' z00="0"');
		$z01_trie=0;
		printf(' z01_tri="%011u"',$z01_trie);
    echo(' z01="'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'"');
    echo(' periode="y\'a pas!!!"');
    echo(' z03="y\'a pas!!!"');
     echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
$sql_req="delete from _temp_stat_01 where c_uuid='$uuid';";
$vf_c_echo=_graal_exec_requete($sql_req);
//echo $sql_req;
_graal_ferme_connexion();
?>
