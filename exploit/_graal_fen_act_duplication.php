<?php
include("_graal_header_xul.inc.php");
$vl_e_uti_cleunik =intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_e_act_cleunik=intval(fa_recup_param("vl_act_cleunik","-1"));
$vs_envag=intval(fa_recup_session("vs_envag","0"));
$vs_envah=fa_recup_session("vs_envah","");
$vs_envai=fa_recup_session("vs_envai","");
$vl_c_action=fa_recup_param('vf_c_action','');
switch ($vl_c_action) {
	case "dupliquer":
		$vl_c_id_fenetre="Fen_00759";
		$bloc_traitement=<<<EOT
		<groupbox>
    <caption><label value="$vl_c_bqf_110" /></caption>
    <radiogroup id='rdg_duplik_ged' flex="1" value="2">
      <hbox>
        <radio id='ra_duplik_ged_oui' label="$vl_c_dico_00013" value='1' />
        <spacer flex="1"/>
        <radio id='ra_duplik_ged_non' label="$vl_c_dico_00014" value='2' />
       </hbox>
     </radiogroup>
    </groupbox>
	<groupbox>
    <caption><label value="$vl_c_bqf_110" /></caption>
    <radiogroup id='rdg_duplik_actions' flex="1" value="2">
      <hbox>
        <radio id='ra_duplik_actions_oui' label="$vl_c_dico_00013" value='1' />
        <spacer flex="1"/>
        <radio id='ra_duplik_actions_non' label="$vl_c_dico_00014" value='2' />
       </hbox>
     </radiogroup>
    </groupbox>
EOT;
		$bloc_traitement="";
		break;
	case "changer_genre":
		$vl_c_id_fenetre="Fen_00758";
		$bloc_traitement="";
		break;
	default:
		fa_redirige("acces_interdit");
		break;
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bqf_100=fa_recup_dico("bqf_100");
$vl_c_bqf_101=fa_recup_dico("bqf_101");
$vl_c_bqf_102=fa_recup_dico("bqf_102");
$vl_c_bqf_103=fa_recup_dico("bqf_103");
$vl_c_bqf_104=fa_recup_dico("bqf_104");
$vl_c_bqf_105=fa_recup_dico("bqf_105");
$vl_c_bqf_106=fa_recup_dico("bqf_106");
$vl_c_bqf_107=fa_recup_dico("bqf_107");
$vl_c_bqf_108=fa_recup_dico("bqf_108");
$vl_c_bqf_109=fa_recup_dico("bqf_109");
$vl_c_bqf_110=fa_recup_dico("bqf_110");
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$tab_acteur=_graal_requete_acteur($vl_e_act_cleunik);
$vl_b_ajout=$vl_tb_droits[1];$vl_b_modif=$vl_tb_droits[2];$vl_b_suppr=$vl_tb_droits[3];$vl_b_impri=$vl_tb_droits[4];$vl_b_detai=$vl_tb_droits[5];
$vl_c_dico_00005=fa_recup_dico('dico_00005');
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_bout="";
$vl_c_bout.='<button tooltiptext ="'.$vl_c_dico_00005.' Ctrl+Shift+F5" keycode="k-enregistrer" width="40" flex="1" id="bt_enregistrer" label="'.$vl_c_dico_00005.'" crop="end" dir="normal" oncommand="pf_validation(\'enregistrer\')" />';
$vl_c_bout.='<button width="40" flex="1" id="bt_sortir" label="'.$vl_c_dico_00007.'" crop="end" dir="normal" oncommand="pf_etat_fen(\'sortir\')" />';
$ks_01="";
$ks_01.='<keyset id="_graal_ks_01">';
$ks_01.='<key id="k-enregistrer" modifiers="control shift" keycode="VK_F5" oncommand="if(fa_est_grise(\'bt_enregistrer\')==true){return};pf_validation(\'enregistrer\');"/>';
$ks_01.='<key id="k-sortir" modifiers="alt" keycode="VK_F4" oncommand="if(fa_est_grise(\'bt_sortir\')==true){return};pf_etat_fen(\'sortir\');"/>';
$ks_01.='</keyset>';
$sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
switch ($vl_c_action) {
	case "dupliquer":
		$sql_req.= " FROM _choix WHERE _choix.critere_cleunik IN (79) and choix_cleunik not in (110000) and choix_actif=1";
		break;
	case "changer_genre":
		$sql_req.= " FROM _choix WHERE _choix.critere_cleunik IN (79) and choix_cleunik not in (110000) and _choix.choix_cleunik not in (select typeacteur from _acteurs where act_cleunik=$vl_e_act_cleunik) and choix_actif=1";
		break;
}
$sql_result = _graal_requete_bd($sql_req);
$vl_e_nombre_types=mysql_num_rows($sql_result);
$vv_brik="";
$vv_brik.='<menulist sizetopopup="none" crop="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" class="normal" observes="broadcaster_01" flex="0" id="ml_typeacteurs" _graal_nombre="'.$vl_e_nombre_types.'">';
$vv_brik.='<menupopup>';
while ($row = mysql_fetch_assoc($sql_result)) {
  $vv_brik.="<menuitem $class crop='none' value='" .fa_remplace_quotes(fa_ent_xml($row['type_tiers'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['type_tiers']))."' />";
}
$vv_brik.='</menupopup>';
$vv_brik.='</menulist>';
_graal_libere_requete_bd($sql_result);
switch ($vl_c_action) {
	case "dupliquer":
		if ($vs_envag!=0){
			$argument1=explode("|",$vs_envah);
			$argument2=explode("|",$vs_envai);
			$nom_base_h=$argument1[0];
			$des_base_h=$argument2[0];
			$nom_base_i=$argument1[1];
			$des_base_i=$argument2[1];
			$vv_brik.='<menulist sizetopopup="none" value="' .fa_remplace_quotes(fa_ent_xml($nom_base_i)). '" _graal_cleunik="' .fa_remplace_quotes(fa_ent_xml($des_base_i)). '" crop="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" class="normal" observes="broadcaster_01" flex="0" id="ml_base_destination" _graal_nombre="2">';
			$vv_brik.='<menupopup>';
			$vv_brik.="<menuitem $class crop='none' value='" .fa_remplace_quotes(fa_ent_xml($nom_base_h)). "' label='".fa_remplace_quotes(fa_ent_xml($des_base_h))." ' _graal_cleunik='".fa_remplace_quotes(fa_ent_xml($des_base_h))."' />";
			$vv_brik.="<menuitem $class crop='none' value='" .fa_remplace_quotes(fa_ent_xml($nom_base_i)). "' label='".fa_remplace_quotes(fa_ent_xml($des_base_i))." ' _graal_cleunik='".fa_remplace_quotes(fa_ent_xml($des_base_i))."' />";
			$vv_brik.='</menupopup>';
			$vv_brik.='</menulist>';	
		}
	break;
}
include("_graal_header_winxul.inc.php"); 
echo <<<END
<window context="graal_cp00" title="$vl_c_bqf_100" id="_win_fen_art_duplication" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
$ks_01
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_act_duplication.js.php");
echo <<<END
	<caption><label value="$tab_acteur"/></caption>
  <groupbox>
    <caption><label value="$vl_c_bqf_101"/></caption>
    $vv_brik
  </groupbox>
  $bloc_traitement
	<spacer flex="2"/>
  <hbox id="boutons_standards" >
  $vl_c_bout
  </hbox>
</window>
END;
?>
