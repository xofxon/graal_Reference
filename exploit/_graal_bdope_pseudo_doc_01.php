<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_pseudodocs_01";
fa_acces_script();
/*
****************************************************************************************
**********  Fenêtre de gestion des pseudo-documents (liens internet ou autres)  ********
****************************************************************************************
*/
define('EOL', "\r\n");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vf_e_doc_cleunik=intval(fa_recup_param('vf_e_doc_cleunik','0'));
$vf_c_action=fa_recup_param('vf_c_action','0');
$vf_c_emplacement=fa_recup_param('vf_c_emplacement','');
$vf_c_titre=fa_recup_param('vf_c_titre','');
$vf_c_descriptif_sommaire=fa_recup_param('vf_c_descriptif_sommaire','');
$vf_c_genre=fa_recup_param('genre','utilis');
$vl_e_portee_cleunik=fa_recup_param('portee_cleunik','0');
$vf_c_origine=fa_recup_param('vf_c_origine','');
$vf_c_echo='';
$typedoc=1;
/*
le 29 septembre 2010
  typedoc    1 -> Liens,
             2 -> Notes,
             3 -> Documents,
             4 -> Dossier,
             5 -> courriels envoyés,
             6 -> modèles de courriels texte,
             7 -> Flux RSS,
             8 -> requêtes personnelles,
             9 -> images des articles, logos de l'entreprise
            10 -> modèles de courriels HTML,
            11 -> modèles de notes,
            12 -> modèles de notification de lecture,
            13 -> pièces jointes,
            14 -> menus arbres personalisés
            15 -> menus pages personalisés
           101 -> modèles textes entêtes offres clients,
           102 -> modèles textes pied offres clients,
           111 -> modèles textes entêtes commandes clients,
           112 -> modèles textes pied commandes clients,
           121 -> modèles textes entêtes livraison clients,
           122 -> modèles textes pied livraison clients,
           131 -> modèles textes entêtes facture clients,
           132 -> modèles textes pied facture clients,
           141 -> modèles textes entêtes demandes fournisseur,
           142 -> modèles textes pied demandes fournisseur,
           151 -> modèles textes entêtes commandes fournisseur,
           152 -> modèles textes pied commandes fournisseur,
           153 -> modèles formulaires de fiches palettes,
           154 -> fichiers pdf de filigranne de documents,
           900 -> Conditions générales de vente
           901 -> Bloc de désinscription pour emailing html
           902 -> Bloc de désinscription pour emailing texte
           903 -> Bloc de sondage pour emailing html
           904 -> Bloc de sondage pour emailing texte
*/
$droits_proprio=15;
$droits_groupe=0;
$droits_lambda=0;
switch (TRUE) {
  case $vf_c_action=='verifier_droits_acces': //  Vérification que l'utilisateur a bien accès au document
    $sql_req = "select droits_proprio from _droits_doc where doc_cleunik=$vf_e_doc_cleunik AND uti_cleunik=$vl_e_uti_cleunik";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    $vf_c_echo=$row['droits_proprio'];
    break;
  case $vf_c_action=='verifier_nom':  //  Vérification que le nom du document n'existe pas
    $sql_req = "select count(*) as nombre FROM _documents WHERE emplacement = '$vf_c_emplacement'";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    $vf_c_echo=$row['nombre'];
    break;
  case $vf_c_action=='supprimer': //  Suppression d'un document
    $sql_req = "DELETE FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='ajouter': //  Ajout d'un document
    $vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
    $sql_req = "INSERT INTO _documents set doc_cleunik=$vf_e_doc_cleunik,typedoc=$typedoc,emplacement= '$vf_c_emplacement',titre='$vf_c_titre',dateheurecreation = now(),descriptif_sommaire = '$vf_c_descriptif_sommaire',origine='$vf_c_origine';";
    _graal_exec_requete($sql_req);
    $sql_req="";
    switch ($vf_c_genre) {
      case 'action' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_action;";break;
      case 'acteur' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_acteur;";break;
      case 'articl' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_articl;";break;
      case 'interl' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_interl;";break;
      case 'entrep' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=0,portee=$vl_e_entrep;";break;
      case 'utilis' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";break;
    }
    _graal_exec_requete($sql_req);
    switch ($vf_c_genre) {
      case 'utilis' :  //  On ne gère les droits que pour les utilisateurs
        $sql_req = "INSERT INTO _droits_doc set doc_cleunik=$vf_e_doc_cleunik,uti_cleunik=$vl_e_uti_cleunik,droits_proprio=$droits_proprio,droits_groupe=$droits_groupe,droits_lambda=$droits_lambda";
        $vf_c_echo=_graal_exec_requete($sql_req);
        break;
    }
    $vf_c_echo=$vf_e_doc_cleunik;
    break;
  case $vf_c_action=='modifier':  //  Modification d'un document
    $sql_req = "update _documents set emplacement='$vf_c_emplacement',titre = '$vf_c_titre',descriptif_sommaire='$vf_c_descriptif_sommaire',dateheuremodif = now(),origine='$vf_c_origine' where doc_cleunik=$vf_e_doc_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
