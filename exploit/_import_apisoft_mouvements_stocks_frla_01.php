<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
define('EOL', "\r\n");
set_time_limit(6000);
echo(date("D M j G:i:s T Y").EOL);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
$art_cod=array();$art_cle=array();
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeArticle) from $vl_c_base_origine.mouvementstock)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);  
$mou_cod=array();$mou_cle=array();
$sql_req="select c_origine,genre_mvt from $vl_c_base_destination._w_transferts_apisoft_corres_orimou;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($mou_cod, $row['c_origine']);
  array_push ($mou_cle, $row['genre_mvt']);
}
_graal_libere_requete_bd($result);  
$sql_req = "SELECT `Compteur` as `Compteur`,`Type` as `Type`,`CodeArticle` as `CodeArticle`,`CodeDepot` as `CodeDepot`,`Date` as `Date`,`Quantite` as `Quantite`,`Valorisation` as `Valorisation`,`StockPermanent` as `StockPermanent`,`QteUtilisee` as `QteUtilisee`,`Soldee` as `Soldee`,`TypeIdentifiant` as `TypeIdentifiant`,`Identifiant` as `Identifiant`,`NumSerie` as `NumSerie`,`CodeFseur` as `CodeFseur`,`CompteurArticle` as `CompteurArticle`,`CodeDevise` as `CodeDevise` FROM $vl_c_base_origine.mouvementstock order by Compteur;";  
$result=_graal_requete_bd($sql_req);
$o_mou=new _graal_import();
$o_mou->req="INSERT INTO $vl_c_base_destination._mouvements_stock (mvt_cleunik,art_cleunik,uti_cleunik,int_cleunik,blocnotebrut,dateheuremvt,dateheuresaisie,choix_depot,choix_empla,qte_mvt,qte_pos,unite_mvt,genre_mvt,type_mvt,pu_mvt) VALUES ";
$sql_req_02="";
$i=0;$b=500;$j=0;
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_trouve=array_search($row['CodeArticle'], $art_cod);if ($vl_e_trouve===false) {$art_cleunik=0;} else {$art_cleunik=$art_cle[$vl_e_trouve];}
  if ($art_cleunik!=0) {
    $i++;
    //$mvt_cleunik=$row['Compteur'];
    $j+=10;
    $mvt_cleunik=$j;
    $uti_cleunik=0;
    $int_cleunik=0;
    $blocnotebrut=addslashes($row['Identifiant']);
    $dateheuremvt=$row['Date'];
    $dateheuresaisie=$row['Date'];
    $choix_depot=-15;
    $choix_empla=-16;
    $unite_mvt=-14;
    $vl_e_trouve=array_search($row['TypeIdentifiant'], $mou_cod);if ($vl_e_trouve===false) {$genre_mvt=-46;} else {$genre_mvt=$mou_cle[$vl_e_trouve];}
    if ($genre_mvt==-41) {
      //  inventaire
      $type_mvt=3;
      if ($row['Quantite']==0) {
        $pu_mvt=0;
      } else {
        $pu_mvt=$row['Valorisation']/$row['Quantite'];
      }
      $qte_mvt=$row['StockPermanent'];
      $qte_pos=$row['StockPermanent'];
    } else {
      $qte_mvt=$row['Quantite'];
      $qte_pos=$row['StockPermanent'];
      if ($row['Type']=="E") {$type_mvt=1;} else {$type_mvt=2;}
      if ($row['Quantite']==0) {
        $pu_mvt=0;
      } else {
        $pu_mvt=$row['Valorisation']/$row['Quantite'];
      }
    }
    $o_mou->dat.="($mvt_cleunik,$art_cleunik,$uti_cleunik,$int_cleunik,'$blocnotebrut','$dateheuremvt','$dateheuresaisie',$choix_depot,$choix_empla,$qte_mvt,$qte_pos,$unite_mvt,$genre_mvt,$type_mvt,$pu_mvt),";
  }
  if ($i % $b==0){$o_mou->execute();}
}
$o_mou->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($i.' mouvements de stocks ajoutés'.EOL);
echo(date("D M j G:i:s T Y").EOL);
?>
