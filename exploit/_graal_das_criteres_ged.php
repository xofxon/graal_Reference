<?php
require_once("_graal_fonctions_diverses.php");
include("_graal_var_portee.php");
$vl_c_etat=fa_recup_param('vl_c_etat','1');
$vl_c_position=fa_recup_param('vl_c_position','1');
$vl_c_sortie=fa_recup_param('sortie','xml');
$vl_c_filtre=fa_recup_param('filtre','tous');
$vl_c_operateur_01="=";
$vl_c_oui=fa_recup_dico("dico_00013");
$vl_c_non=fa_recup_dico("dico_00014");
$vl_c_actif=fa_recup_dico("dico_00046");
$vl_c_inactif=fa_recup_dico("dico_00047");
switch ($vl_c_filtre){
	case "applicatif":$sq_req_filtre=" critere_cleunik >9999 ";break;
	case "tous":$sq_req_filtre=" 1=1 ";break;
}
switch ($vl_c_etat){
  case "1": break;  //  Tous
  case "2": $vl_c_operateur_01=">";break; //  les utilisés
  case "3": $vl_c_operateur_01="=";break;//  pas utilisés
}
$sql_req = "select critere_cleunik,critere_code,critere_denomination,case critere_actif WHEN 1 THEN '$vl_c_actif' ELSE '$vl_c_inactif' END AS critere_actif";
$sql_req .= " from _criteres where $sq_req_filtre and critere_portee & $vl_e_gedged";
switch ($vl_c_position){
  case "1": break;  //  Actifs et inactifs
  case "2": $sql_req .= " AND critere_actif =1";break;//  les utilisés
  case "3": $sql_req .= " AND critere_actif =2";break;//  les pas utilisés
}
switch ($vl_c_etat){
  case "1": break;  //  Tous
  case "2": //  les utilisés
  case "3": //  les pas utilisés
   $sql_req .= " and (SELECT count(*) as nombre from _documents_choix_fixes where _documents_choix_fixes.critere_cleunik = _criteres.critere_cleunik) $vl_c_operateur_01 0";
}
$sql_req .= " ORDER BY critere_denomination";
switch ($vl_c_sortie) {
  case "xml":
  		include("_graal_header_xml.inc.php");
		$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		  echo(' critere_cleunik="'.fa_ent_xml($row['critere_cleunik']).'"');
		  echo(' critere_code="'.fa_ent_xml($row['critere_code']).'"');
		  echo(' critere_denomination="'.fa_ent_xml($row['critere_denomination']).'"');
		  echo(' critere_actif="'.fa_ent_xml($row['critere_actif']).'"');
		  echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
	    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
