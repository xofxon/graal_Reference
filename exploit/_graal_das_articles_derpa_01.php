<?php
include("_graal_header_xml.inc.php");
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_laquelle=fa_recup_param('vl_c_laquelle','?');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
session_write_close();
switch ($vl_c_laquelle){
	case "recfou":$fic_01="_recfou_lignes";$fic_02="_recfou_entetes";break;
	case "facfou":$fic_01="_facfou_lignes";$fic_02="_facfou_entetes";break;
}
// execution de la requète SQL
$sql_req="select f3.actif,f3.art_cleunik,f3.code,f3.description,f4.der_pa,"._graalsql_date('f4.dateheure_der_achat')." as date_der_achat_clair,f3.nbdec_prix,f4.dateheure_der_achat,";
$sql_req.="(SELECT f1.pu FROM $fic_01 f1 left join $fic_02 f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code order by f2.dateheureexpedition desc LIMIT 1) as pu,";
$sql_req.="(SELECT f2.dateheureexpedition FROM $fic_01 f1 left join $fic_02 f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code order by f2.dateheureexpedition desc LIMIT 1) as dateheure_reception,";
$sql_req.="(SELECT "._graalsql_date('f2.dateheureexpedition')." FROM $fic_01 f1 left join $fic_02 f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code order by f2.dateheureexpedition desc LIMIT 1) as dateheure_reception_clair,";
$sql_req.="(SELECT f1.commercial_ligne_cleunik FROM $fic_01 f1 left join $fic_02 f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code order by f2.dateheureexpedition desc LIMIT 1) as commercial_ligne_cleunik, ";
$sql_req.="(SELECT f1.commercial_cleunik FROM $fic_01 f1 left join $fic_02 f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code order by f2.dateheureexpedition desc LIMIT 1) as commercial_cleunik ";
$sql_req.=" from _article f3 left join _art_achats f4 on f3.art_cleunik=f4.art_cleunik where ";
$sql_req.="(SELECT pu FROM $fic_01 f1 left join $fic_02 f2 on f1.commercial_cleunik=f2.commercial_cleunik where f1.code_interne=f3.code order by dateheureexpedition desc LIMIT 1) is not null";

switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND f3.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND f3.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND f3.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND f3.types_gestion & 4";break;
  case 'fabrication': $sql_req.= " AND f3.types_gestion & 8";break;
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND f3.actif=1";break;// Actifs
  case 2: $sql_req.= " AND f3.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_validite) {
  case '': break;
  default: $sql_req.=" and (f3.dateheurevalidite >= '$vl_c_validite' or f3.dateheurevalidite is null)";break;
}
switch ($vl_c_zone) {
  case '1': $sql_req.=" and f3.description like '$vl_c_recherche%' ORDER BY `description` ASC";break;//  Description courte
  case '2': $sql_req.=" and f3.code like '$vl_c_recherche%' ORDER BY `code` ASC";break;//  Code
  case '3': $sql_req.=" and f3.mnemotechnique like '$vl_c_recherche%' ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
$sql_req.= " LIMIT 0, $vl_e_limit";
switch ($vl_c_sortie){
	case "das":
		$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		  $nb_dec=fa_ent_xml($row['nbdec_prix']);
		  if ($row['der_pa']==0) {
		    $der_pa=""; } else
		  {
		    $der_pa=fa_reel(fa_ent_xml($row['der_pa']),$nb_dec);
		  }
		  $val_der_pa=$row['der_pa']*1000;
		  if ($row['pu']==0) {
		    $pu=""; } else
		  {
		    $pu=fa_reel(fa_ent_xml($row['pu']),$nb_dec);
		  }
		  $val_pu=$row['pu']*1000;
		  echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		  echo(' code="'.fa_ent_xml($row['code']).'"');
		  echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
		  echo(' description="'.fa_ent_xml($row['description']).'"');
		  echo(' date_der_achat_clair="'.fa_ent_xml($row['date_der_achat_clair']).'"');
		  echo(' date_der_achat="'.fa_ent_xml($row['dateheure_der_achat']).'"');
		  echo(' dateheure_reception_clair="'.fa_ent_xml($row['dateheure_reception_clair']).'"');
		  echo(' dateheure_reception="'.fa_ent_xml($row['dateheure_reception']).'"');
		  echo(' commercial_ligne_cleunik="'.fa_ent_xml($row['commercial_ligne_cleunik']).'"');
		  echo(' commercial_cleunik="'.fa_ent_xml($row['commercial_cleunik']).'"');
			if ($row['actif']==1) {
			    echo(' properties=""');
			  } else {
			    echo(' properties="css_0001"');
			  }
		  echo(' der_pa="'.$der_pa.'"');
		  echo(' pu="'.$pu.'"');
		  printf(' val_pu="%011u"',$val_pu);
		  printf(' val_der_pa="%011u"',$val_der_pa);
		  //if (($val_pu==$val_der_pa) and ($row['date_der_achat_clair']==$row['dateheure_reception'])){
		  	if (($val_pu==$val_der_pa) ){
		  	echo(' difference=""');
		  } else {
			    echo(' difference="'.fa_ent_xml("<>").'"');
		  }
		  echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		break;
	case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;

    case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";
		switch ($vl_c_laquelle){
			case "recfou":$vl_c_id_fenetre="Fen_01159";break;
			case "facfou":$vl_c_id_fenetre="Fen_01160";break;
		}
		_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
		$vl_c_bvl_100=fa_recup_dico("bvl_100");
		$vl_c_bvl_101=fa_recup_dico("bvl_101");
		$vl_c_bvl_102=fa_recup_dico("bvl_102");
		$vl_c_bvl_103=fa_recup_dico("bvl_103");
		$vl_c_bvl_104=fa_recup_dico("bvl_104");
		$vl_c_bvl_105=fa_recup_dico("bvl_105");
		$vl_c_bvl_106=fa_recup_dico("bvl_106");
		$vl_c_bvl_107=fa_recup_dico("bvl_107");
		$vl_c_bvl_108=fa_recup_dico("bvl_108");
		$vl_c_bvl_109=fa_recup_dico("bvl_109");
		$vl_c_bvl_110=fa_recup_dico("bvl_110");
		$vl_c_bvl_111=fa_recup_dico("bvl_111");
		$vl_c_bvl_112=fa_recup_dico("bvl_112");
		$vl_c_bvl_113=fa_recup_dico("bvl_113");


		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_nom_fichier_xls"));
		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("$vl_c_bvl_101"));
		$worksheet->write(0, 1, utf8_decode("$vl_c_bvl_102"));
		$worksheet->write(0, 2, utf8_decode("$vl_c_bvl_103"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bvl_104"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bvl_105"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_bvl_106"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_bvl_107"));
		$vl_e_noligne=1;
		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			$nb_dec=fa_ent_xml($row['nbdec_prix']);
			  if ($row['der_pa']==0) {
			    $der_pa=""; } else {
			    $der_pa=fa_reel(fa_ent_xml($row['der_pa']),$nb_dec);
			  }
			  if ($row['pu']==0) {
			    $pu=""; } else {
			    $pu=fa_reel(fa_ent_xml($row['pu']),$nb_dec);
			  }
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['mnemotechnique']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, $der_pa);$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_der_achat_clair']));$j++;
		    $worksheet->write($vl_e_noligne, $j, $pu);$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_reception_clair']));$j++;
		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    break;





}


_graal_ferme_connexion();
?>
