<?php
include("_graal_header_xul.inc.php");
include("_graal_var_portee.php");
$vl_e_uti_cleunik=intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_c_dico_00002=fa_recup_dico('dico_00002');
$vl_c_dico_00003=fa_recup_dico('dico_00003');
$vl_c_dico_00004=fa_recup_dico('dico_00004');
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_dico_00019=fa_recup_dico('dico_00019');
$vl_c_dico_00020=fa_recup_dico('dico_00020');
$vl_c_dico_00021=fa_recup_dico('dico_00021');
$vl_c_dico_00022=fa_recup_dico('dico_00022');
$vl_c_dico_00023=fa_recup_dico('dico_00023');
$vl_c_dico_00024=fa_recup_dico('dico_00024');
$vl_c_dico_00025=fa_recup_dico('dico_00025');
$vl_c_dico_00045=fa_recup_dico('dico_00045');
$vl_c_dico_00106=fa_recup_dico('dico_00106');
$vl_c_id_fenetre="Fen_00587";$id_inc_actions_recherche="Div_00496";
$vl_c_genreaction="toutes_traitements";

$vl_c_type=fa_recup_param('type','1');  //  1 Normal,2 Choix,3 Critere,4 Normal+arbre critères
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_quoi=fa_recup_param('vl_c_quoi','');
$vl_c_enclair=fa_recup_param('vl_c_enclair','');
$vl_c_code_critere=fa_recup_param('vl_c_code_critere','');
$vl_c_code_choix=fa_recup_param('vl_c_code_choix','');
$vl_c_deno_critere=fa_recup_param('vl_c_deno_critere','');
$vl_c_deno_choix=fa_recup_param('vl_c_deno_choix','');
$vl_c_visu_action=fa_recup_param("visu","non");

switch ($vl_c_type) {
  case '4' : // Normal+critères
		$sql_req_criteres="select count(*) as nombre from _choix f1 left join _criteres f2 using (critere_cleunik) where critere_portee & $vl_e_action and f2.critere_cleunik<>0 order by f2.critere_cleunik,f1.choix_valeur_texte_01";
		$res_uti=_graal_requete_bd($sql_req_criteres);
		$row_uti = mysql_fetch_assoc($res_uti);
  		$vl_e_nb_criteres=fa_ent_xml($row_uti['nombre']);
  		_graal_libere_requete_bd($res_uti);
  		if ($vl_e_nb_criteres!=0){

  		} else {
  			$vl_c_type=1;
  		}
    break;
}
switch ($vl_c_type) {
  case '1' : // Normal
  case '4' : // Normal+critères
		$vl_c_id_inc_infos_critere_choix_01="";
		$vl_c_deck_ini="1";
    break;
  case '2' : // Choix
  case '3' : // Critère
		$vl_c_id_inc_infos_critere_choix_01="Div_00344";
		$vl_c_deck_ini="1";
    break;
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_c_id_fen_action="Fen_00425";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fen_action,$vl_e_uti_cleunik);
$vl_b_acces=$vl_tb_droits[0];$vl_b_modif=$vl_tb_droits[2];
$vl_tc_composants=array($id_inc_actions_recherche,$vl_c_id_inc_infos_critere_choix_01);
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$ml_statu_actions=fa_brik_menulist_choix('124',2,-1,-1,'','ml_statut_action',"broadcaster_01",0);
$ml_priorite_actions=fa_brik_menulist_choix('123',1,-1,-1,'','ml_priorite_action',"broadcaster_01",0);
$ml_confidentialite_actions=fa_brik_menulist_choix('122',1,-1,-1,'','ml_confidentialite_action',"broadcaster_01",0);
$vl_c_id_t01="Trait_00241";$vl_c_id_t02="Trait_00242";$vl_c_id_t03="Trait_00243";$vl_c_id_t04="Trait_00244";$vl_c_id_t05="Trait_00300";
$vl_c_id_t06="Trait_00307";
$vl_c_id_t07="Trait_00308";
$vl_c_id_t08="Trait_xxxxx";
$vl_c_id_t09="Trait_xxxxx";
$vl_c_id_t10="Trait_xxxxx";
_graal_requete_charge_libobj($vl_c_id_t01,$vl_e_uti_cleunik);$vl_c_t01=fa_recup_dico("$vl_c_id_t01");
_graal_requete_charge_libobj($vl_c_id_t02,$vl_e_uti_cleunik);$vl_c_t02=fa_recup_dico("$vl_c_id_t02");
_graal_requete_charge_libobj($vl_c_id_t03,$vl_e_uti_cleunik);$vl_c_t03=fa_recup_dico("$vl_c_id_t03");
_graal_requete_charge_libobj($vl_c_id_t04,$vl_e_uti_cleunik);$vl_c_t04=fa_recup_dico("$vl_c_id_t04");
_graal_requete_charge_libobj($vl_c_id_t05,$vl_e_uti_cleunik);$vl_c_t05=fa_recup_dico("$vl_c_id_t05");
_graal_requete_charge_libobj($vl_c_id_t09,$vl_e_uti_cleunik);$vl_c_t09=fa_recup_dico("$vl_c_id_t09");$vl_c_t09="Créer un panier";
_graal_requete_charge_libobj($vl_c_id_t10,$vl_e_uti_cleunik);$vl_c_t10=fa_recup_dico("$vl_c_id_t10");$vl_c_t10="Créer une requête";

$vl_c_boi_100=fa_recup_dico("boi_100");
$vl_c_boi_101=fa_recup_dico("boi_101");
$vl_c_boi_102=fa_recup_dico("boi_102");
$vl_c_boi_103=fa_recup_dico("boi_103");
$vl_c_boi_104=fa_recup_dico("boi_104");
$vl_c_boi_105=fa_recup_dico("boi_105");
$vl_c_boi_106=fa_recup_dico("boi_106");
$vl_c_boi_107=fa_recup_dico("boi_107");
$vl_c_boi_108=fa_recup_dico("boi_108");
$vl_c_boi_109=fa_recup_dico("boi_109");
$vl_c_boi_110=fa_recup_dico("boi_110");
$vl_c_boi_111=fa_recup_dico("boi_111");$vl_c_boi_111="Changer";
$vl_c_boi_112=fa_recup_dico("boi_112");$vl_c_boi_112="Nouvelle confidentialité";

$vl_c_pop_selections="";$vl_c_pop_panier="";
$vl_c_pop_selections.="<popupset><popup id='pop_selections'>";
$vl_c_pop_selections.='<menuitem class="menuitem-iconic ad09" label="'.$vl_c_dico_00106.'" oncommand="fa_infos_colonnes_arbre_recup(\''.$vl_c_id_fenetre.'\',\''."arbre_actions_01".'\');" />';
$vl_c_pop_selections.='<menuseparator/>';

switch ($vl_c_type) {
  case '4' : // Normal+critères
		$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t06,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$vl_c_pop_selections.='<menuitem label="'.$vl_c_boi_109.'" oncommand="pf_actions_choix(1,2);" />';}
		$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t07,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$vl_c_pop_selections.='<menuitem label="'.$vl_c_boi_110.'" oncommand="pf_actions_choix(1,1);" />';}
    break;
}



if ($vl_b_modif==true){$vl_c_pop_selections.="<menuitem class='menuitem-iconic af08' label='$vl_c_boi_101' oncommand='pf_action_ouvre(\"arbre_actions_01\");' />";}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t01,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$vl_c_pop_selections.='<menuitem class="menuitem-iconic ak11" label="'.$vl_c_boi_102.'" oncommand="pf_panier_ajoute();" />';}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t02,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$vl_c_pop_selections.='<menuitem class="menuitem-iconic ac03" label="'.$vl_c_t02.'" oncommand="pf_actions_supprime();" />';}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t03,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {
  $vl_c_pop_selections.="<hbox><label value='$vl_c_boi_105'/>".$ml_statu_actions;
  $vl_c_pop_selections.="<button flex='1' tooltiptext ='$vl_c_boi_106' id='bt_change_statut' label='$vl_c_boi_106' crop='end' dir='normal' oncommand='pf_action_change_statut();' />";
  $vl_c_pop_selections.="</hbox>";
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t04,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {
  $vl_c_pop_selections.="<hbox><label value='$vl_c_boi_107'/>".$ml_priorite_actions;
  $vl_c_pop_selections.="<button flex='1' tooltiptext ='$vl_c_boi_108' id='bt_change_priorite' label='$vl_c_boi_108' crop='end' dir='normal' oncommand='pf_action_change_priorite();' />";
  $vl_c_pop_selections.="</hbox>";
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t08,$vl_e_uti_cleunik);$vl_tb_droits[0]=true;if ($vl_tb_droits[0]==true) {
  $vl_c_pop_selections.="<hbox><label value='$vl_c_boi_112'/>".$ml_confidentialite_actions;
  $vl_c_pop_selections.="<button flex='1' tooltiptext ='$vl_c_boi_111' id='bt_change_confidentialite' label='$vl_c_boi_111' crop='end' dir='normal' oncommand='pf_action_change_confidentialite();' />";
  $vl_c_pop_selections.="</hbox>";
}


$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t05,$vl_e_uti_cleunik);$vl_tb_droits[0]=true;if ($vl_tb_droits[0]==true) {$vl_c_pop_selections.='<menuitem class="menuitem-iconic ad19" label="'.$vl_c_t05.'" oncommand="pf_actions_change_recus_en_erreur();" />';}
$vl_c_pop_selections.="<menuitem class='menuitem-iconic' tooltiptext ='$vl_c_boi_103' collapsed='true' id='bt_voir_panier' label='$vl_c_boi_103' oncommand='pf_voir_deck(2)' />";
$vl_c_pop_selections.="</popup></popupset>";


$vl_c_pop_panier.="<popupset><popup id='pop_panier'>";
if ($vl_b_modif==true){$vl_c_pop_panier.="<menuitem class='menuitem-iconic af08' label='$vl_c_boi_101' oncommand='pf_action_ouvre(\"arbre_actions_panier\");' />";}
$vl_c_pop_panier.="<menuitem class='menuitem-iconic' tooltiptext ='$vl_c_boi_104' label='$vl_c_boi_104' oncommand='pf_voir_deck(1)' />";
$vl_c_pop_panier.='<menuseparator/>';
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t09,$vl_e_uti_cleunik);$vl_tb_droits[0]=true;if ($vl_tb_droits[0]==true) {$vl_c_pop_panier.='<menuitem class="menuitem-iconic ak10" label="'.$vl_c_t09.'" oncommand="pf_valide_danspanier();" />';}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_t10,$vl_e_uti_cleunik);$vl_tb_droits[0]=false;if ($vl_tb_droits[0]==true) {$vl_c_pop_panier.='<menuitem class="menuitem-iconic ag10" label="'.$vl_c_t10.'" oncommand="pf_valide_requete();" />';}
$vl_c_pop_panier.="</popup></popupset>";


include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_boi_100" id="_win_fen_traitements_actions" onload="fa_aa(this);pf_aa_init_bem('21');pf_voir_deck($vl_c_deck_ini)" onunload="pf_onunload();" $c_xmlns>
$vl_c_graal_cp00
$vl_c_pop_selections
$vl_c_pop_panier
<broadcasterset><broadcaster id="broadcaster_01" /></broadcasterset>
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_04.js.php");
include("js/_graal_actions_traitements_01.js.php");
include_once("js/_graal_05_dates.js.php");
switch ($vl_c_type) {
  case '1' : // Normal
		$vl_b_bloc_action_recherche=true;$vl_c_arbre_action="arbre_actions_01";$cacher_bem_action_recherche_01=false;
		echo ("<deck id='deck_actions' flex='10'>");
		include ("_graal_inc_actions_recherche_01.php");
    break;
  case '2' : // Choix
  case '3' : // Critère
    $_graal_inc_infos_critere_choix_01="$vl_c_genreaction";
    include("_graal_inc_infos_critere_choix_01.php");
		$vl_b_bloc_action_recherche=true;$vl_c_arbre_action="arbre_actions_01";$cacher_bem_action_recherche_01=true;
		echo ("<deck id='deck_actions' flex='10'>");
		include ("_graal_inc_actions_recherche_01.php");
    break;
  case '4' : // Normal+critères
  		$vl_b_bloc_action_recherche=true;$vl_c_arbre_action="arbre_actions_01";$vl_c_bloc_arbre_criteres=true;$cacher_bem_action_recherche_01=false;
		echo ("<deck id='deck_actions' flex='10'>");
		include ("_graal_inc_actions_recherche_01.php");
    break;

}
$vl_b_bloc_action_recherche=false;$vl_c_arbre_action="arbre_des_actions_panier";
include ("_graal_inc_actions_recherche_01.php");
echo("</deck>");
echo('</window>');
END;
?>
