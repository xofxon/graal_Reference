<?php
include("_graal_header_pdf.inc.php");
include("_graal_var_portee.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_action_cleunik=intval(fa_recup_param(vl_e_action_cleunik,'-1'));
$vl_e_nomcomplet=fa_recup_session('vs_nomcomplet','tesquiconnard?');
$vl_e_inv_cleunik=intval(fa_recup_param('vl_e_inv_cleunik',-1));
$vl_e_etat=intval(fa_recup_param('vl_e_etat',0));
$vl_e_inactifs=intval(fa_recup_param('vl_e_inactifs',0));
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$sql_req="SELECT critere_cleunik,description,"._graalsql_date('dateheureinventaire')." as `dateinventaire`,"._graalsql_time('dateheureinventaire')." as `heureinventaire` FROM _inventaire where inv_cleunik=$vl_e_inv_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_description=$row['description'];
$vl_dateinventaire=$row['dateinventaire'];
$vl_heureinventaire=$row['heureinventaire'];
$vl_critere_cleunik=$row['critere_cleunik'];
_graal_libere_requete_bd($result);
if ($vl_critere_cleunik!=0) {
  $sql_req = "SELECT n7.choix_code as 'Code',n7.choix_valeur_texte_01 as 'Description',n9.capacite,n10.choix_valeur_texte_01 as unite_capacite,n1.code as 'Article',n1.description as 'Désignation',case round(n5.qte_inven,n2.nb_decimales_qte) WHEN 0 THEN '' ELSE round(n5.qte_inven,n2.nb_decimales_qte) END as 'Quantité',CASE round(n9.capacite*n5.qte_inven,3) WHEN 0 THEN '' ELSE round(n9.capacite*n5.qte_inven,3) END as 'Capacité inventoriée' FROM _article n1 left join _inventaire_lignes n5 using(art_cleunik) left join _art_stock n2 using(art_cleunik) left join _art_dimensions n9 using(art_cleunik) left join _choix n10 on n9.unite_capacite=n10.choix_cleunik left join _art_choix_fixes n6 using(art_cleunik) left join _choix n7 on n6.choix_cleunik=n7.choix_cleunik where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 and n7.critere_cleunik=$vl_critere_cleunik ";
} else {
  $sql_req = "SELECT CASE n9.capacite WHEN 0 THEN '' ELSE n9.capacite END as capacite,n10.choix_valeur_texte_01 as unite_capacite,n1.code as 'Article',n1.description as 'Désignation',case round(n5.qte_inven,n2.nb_decimales_qte) WHEN 0 THEN '' ELSE round(n5.qte_inven,n2.nb_decimales_qte) END as 'Quantité',CASE round(n9.capacite*n5.qte_inven,3) WHEN 0 THEN '' ELSE round(n9.capacite*n5.qte_inven,3) END as 'Capacité inventoriée' FROM _article n1 left join _inventaire_lignes n5 using(art_cleunik) left join _art_stock n2 using(art_cleunik) left join _art_dimensions n9 using(art_cleunik) left join _choix n10 on n9.unite_capacite=n10.choix_cleunik where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 ";
}
switch ($vl_e_etat) {
  case 1:break; //toutes les lignes
  case 2:$sql_req.= " AND n5.etat=0";break;//  Les lignes à inventorier
  case 3:$sql_req.= " AND n5.etat=1";break; //  Lignes déja inventoriées
  case 4:$sql_req.= " AND n5.etat=2";break; //  Lignes sauvegardées
}
switch ($vl_e_inactifs) {
  case 1:$sql_req.= " AND n1.actif=2";break;//  Articles inactifs
  case 2:$sql_req.= " AND n1.actif=1";break; //  Articles actifs
  case 3:break; //toutes les lignes
}
switch ($vl_c_zone)  {
  case '1':$sql_req.=" ORDER BY `description` ASC;";break; //  Description courte
  case '2':$sql_req.=" ORDER BY `code` ASC;";break; //  Code
  case '3':$sql_req.=" ORDER BY `mnemotechnique` ASC;";break; //  Mnémotechnique
  case '4':$sql_req.=" ORDER by choix_code,code;";break;  // critère
}
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $total+=fa_reel(fa_ent_xml($row['Valeur']),2);
}
_graal_libere_requete_bd($result);
$vl_tb_droits[4]=1;
$vl_b_impri=$vl_tb_droits[4];if ($vl_b_impri==false) {fa_redirige("acces_interdit");}
//create new PDF document (document units are set by default to millimeters)
$pdf = new _graal_TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
// set document information
$pdf->SetCreator(PDF_CREATOR);
$pdf->SetAuthor($vl_e_nomcomplet);
$pdf->SetSubject($vl_description." Edition par capacité");
//$pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

//Voici les deux tableaux des jours et des mois traduits en français
$nom_jour_fr = array("dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi");
$mois_fr = Array("", "janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", 
		"septembre", "octobre", "novembre", "décembre");
// on extrait la date du jour
list($nom_jour, $jour, $mois, $annee) = explode('/', date("w/d/n/Y"));

$data_entete="Edité le ".$nom_jour_fr[$nom_jour].' '.$jour.' '.$mois_fr[$mois].' '.$annee. " à " . date ("H") . " h " . $minute = date("i") . " par ".$vl_e_nomcomplet;

$pdf->SetHeaderData("", 0,"Inventaire $vl_description du $vl_dateinventaire à $vl_heureinventaire Edition par capacité", $data_entete);
$pdf->setPrintHeader(false);
//set margins
$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);

$pdf->SetMargins(5,15, 5);
//set auto page breaks
$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
$pdf->SetAutoPageBreak(TRUE, 10);
$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
//$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
$pdf->SetFooterMargin(5);
$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO); //set image scale factor
$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
$pdf->setLanguageArray($l); //set language items
$pdf->SetFont("FreeSerif", "", 12);
$_hl=6;// Hauteur ligne
$pdf->_gf();  //  Fond des cellule avec des bords grisé
$pdf->SetLineWidth(0.01);  //  Cadre invisible
//initialize document
$pdf->AliasNbPages();
$pdf->setPrintHeader(true);
$pdf->setPrintFooter(true);

$_b_page=false;
$vl_c_xxx_002="Description";
$vl_c_xxx_003="Article";
$vl_c_xxx_004="Désignation";
$vl_c_xxx_005="Inventaire";
$vl_c_xxx_006="Inv. cap.";
$vl_c_xxx_007="Capacité U";
$vl_c_xxx_009="U Cap.";
$vl_c_xxx_008="Code";
//_graal_requete_charge_varlib($id_inc_actions_graal,$vl_e_uti_cleunik);
if ($_b_page!=true) {$pdf->AddPage("L");$_b_page=true;}
$pdf->SetFont("FreeSerif", "BIU", 14);
$pdf->Cell(0,$_hl+$_hl,$vl_c_ben_103,'LTBR',0,"C",1);
$pdf->Ln($_hl);$pdf->Ln($_hl);$pdf->Ln($_hl);
$pdf->SetFont("FreeSerif", "", 12);
if ($vl_critere_cleunik!=0) {
  $pdf->AddCol('Article','10%',$vl_c_xxx_003,'L','N');
  $pdf->AddCol('Désignation','30%',$vl_xxx_004,'L','N');
  $pdf->AddCol('Code','10%',$vl_c_xxx_008,'L','N');
  $pdf->AddCol('Description','18%',$vl_xxx_002,'L','N');
  $pdf->AddCol('Quantité','8%',$vl_c_xxx_005,'R','N');
  $pdf->AddCol('capacite','8%',$vl_c_xxx_007,'R','N');
  $pdf->AddCol('unite_capacite','8%',$vl_c_xxx_007,'R','N');
  $pdf->AddCol('Capacité inventoriée','8%',$vl_c_xxx_006,'R','N');

} else {
  $pdf->AddCol('Article','20%',$vl_c_xxx_003,'L','N');
  $pdf->AddCol('Désignation','40%',$vl_xxx_004,'L','N');
  $pdf->AddCol('Quantité','10%',$vl_c_xxx_005,'R','N');
  $pdf->AddCol('capacite','10%',$vl_c_xxx_007,'R','N');
  $pdf->AddCol('unite_capacite','10%',$vl_c_xxx_007,'R','N');
  $pdf->AddCol('Capacité inventoriée','10%',$vl_c_xxx_006,'R','N');
}
$prop=array('HeaderColor'=>array(255,150,100),
          'color1'=>array(255,224,224), //  rose
          'color2'=>array(255,255,192), //  Jaune
          'padding'=>2);
$pdf->Table($sql_req,$prop);
$pdf->_gf();  //  Fond des cellule avec des bords grisé
$pdf->Ln($_hl);$pdf->Ln($_hl);
$pdf->Write($_hl,"Valeur Totale : $total");
$pdf->Ln($_hl);$pdf->Ln($_hl);

$pdf->Output();
?>
