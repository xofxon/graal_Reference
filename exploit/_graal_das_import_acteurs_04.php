<?php
/*
 * Modèle 3 importation acteur 11 colonnes France Prospect
 */
include("_graal_header_xml.inc.php");
include("_graal_fonctions_documents.php");
$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
$sep=";";	//tab
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
set_time_limit(6000);
session_write_close();
$erreur="";$data="";
$sql_req="select f2.document,f2.doc_cleunik,f2.hash from _w_import_acteurs f1,_documents f2  where f1.imp_cleunik=$vl_e_imp_cleunik and f2.doc_cleunik=f1.doc_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result); 
$doc_cleunik=$row['doc_cleunik'];
//echo $sql_req;
if (fa_verif_droit($doc_cleunik)==false) {$erreur="Pas le droit d'accès à ce fichier";}
$path="mail/".$row['hash'];
$handle_file=fopen($path, 'wb');
fwrite($handle_file, $row['document']);
fclose($handle_file);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();

if ($erreur==""){
	if (!$handle_file = fopen($path, "r")) {
	  $erreur="Impossible d'ouvrir le fichier ($path)";
	} else {
		$vf_c_echo="";
		$row=0;
    while (($datacsv = fgetcsv($handle_file, 0, $sep)) !== FALSE) {
    	/*
    	if ($sEncoding = mb_detect_encoding($datacsv, 'auto', true) != $sCharset)
        $datacsv = mb_convert_encoding($datacsv, $sCharset, $sEncoding);
    	*/
      $num = count($datacsv);
      $row++;
      if ($row==1) {
        if ($num>11) {
          $erreur="Le nombre de colonnes ($num) est incorrect (11 attendues, modèle 3 France Prospect).";
          break;
        }
      } else {
				$data.=('<quoi ');
				$data.=(' cola="'.fa_ent_xml(ff_decode($datacsv[ 0])).'"');
				$data.=(' colb="'.fa_ent_xml(ff_decode($datacsv[ 1])).'"');
				$data.=(' colc="'.fa_ent_xml(ff_decode($datacsv[ 2])).'"');
				$data.=(' cold="'.fa_ent_xml(ff_decode($datacsv[ 3])).'"');
				$data.=(' cole="'.fa_ent_xml(ff_decode($datacsv[ 4])).'"');
				$data.=(' colf="'.fa_ent_xml(ff_decode($datacsv[ 5])).'"');
				$data.=(' colg="'.fa_ent_xml(ff_decode($datacsv[ 6])).'"');
				$data.=(' colh="'.fa_ent_xml(ff_decode($datacsv[ 7])).'"');
				$data.=(' coli="'.fa_ent_xml(ff_decode($datacsv[ 8])).'"');
				$data.=(' colj="'.fa_ent_xml(ff_decode($datacsv[ 9])).'"');
				$data.=(' colk="'.fa_ent_xml(ff_decode($datacsv[10])).'"');
				$data.=('/>');
      }
    }
	  fclose($handle_file);
		unlink($path);
	}
}
if ($erreur!=""){
	echo('<donnees>');
	echo('<quoi ');
  echo(' cola="'.fa_ent_xml($erreur).'"');
  echo('/>');
	echo('</donnees>');
} else {
	echo('<donnees>');
  echo($data);
	echo('</donnees>');
}
function old_ff_decode($item){
	$sCharset = 'UTF-8';
    	if ($sEncoding = mb_detect_encoding($item, 'auto', true) != $sCharset)
        $item = mb_convert_encoding($item, $sCharset, $sEncoding);
        return $item;
}
function ff_decode($item){
	if ($item =="" ){return $item;}
	$sCharset = 'UTF-8';
	$item = mb_convert_encoding($item, $sCharset);
	/*
    	if ($sEncoding = mb_detect_encoding($item, 'auto', true) != $sCharset) {
    		if ($sEncoding == NULL) {
				return $item."-".$sEncoding;
    		} else {
    			$item = mb_convert_encoding($item, $sCharset, $sEncoding)."-".$sEncoding;
    		}
    	}
    	*/
        return $item;
}
?>
