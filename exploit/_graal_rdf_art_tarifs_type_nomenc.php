<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_c_dico_00018=fa_recup_dico('dico_00018');
$vl_c_dico_00083=fa_recup_dico('dico_00083');
$vl_c_dico_00084=fa_recup_dico('dico_00084');
$vl_c_dico_00085=fa_recup_dico('dico_00085');
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","10000113"));
$vl_actif=intval(fa_recup_param("actif",1));
$sql_req="SELECT n1.art_cleunik,n3.pr,n3.nbdec_pr,n4.der_pa,n4.pamp FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) where n1.art_cleunik=$vl_e_art_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_derpa=fa_ent_xml($row['der_pa']);
$vl_pamp=fa_ent_xml($row['pamp']);
$vl_pr=fa_reel(fa_ent_xml($row['pr']),$row['nbdec_pr']);
_graal_libere_requete_bd($result);
$sql_req = "SELECT 'ah06' as prop,tar_cleunik,pu_reference,choix_code,choix_valeur_texte_01,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,_art_tarifs.pu_reference FROM _art_tarifs,_choix where choix_cleunik=tarif_cleunik and art_cleunik=$vl_e_art_cleunik and act_cleunik=0 and type=2 union SELECT 'ai14' as prop,tar_cleunik,pu_reference,choix_code,choix_valeur_texte_01,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,_art_tarifs.pu_reference FROM _art_tarifs,_choix where choix_cleunik=tarif_cleunik and art_cleunik=$vl_e_art_cleunik and act_cleunik=0 and type=1";
switch ($vl_actif) {
  case 1 : $sql_req.= " and _art_tarifs.actif=1";break;
  case 2 : $sql_req.= " and _art_tarifs.actif=2";break;
  case 3 : break;
}
$sql_req.=" order by choix_valeur_texte_01;";
$result = _graal_requete_bd($sql_req);
$num_rows = mysql_num_rows($result);
echo(fa_xcree_entete_rdf());


  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
    echo('<row:tar_cleunik NC:parseType="Integer">-4</row:tar_cleunik>');
    echo('<row:tar_designation>'.$vl_c_dico_00018.'</row:tar_designation>');
    echo('<row:pu_reference>0</row:pu_reference>');
    echo('<row:nombre>'.$num_rows.'</row:nombre>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
    echo('<row:tar_cleunik NC:parseType="Integer">-1</row:tar_cleunik>');
    echo('<row:tar_designation>'.$vl_c_dico_00083.'</row:tar_designation>');
    echo('<row:pu_reference>'.$vl_derpa.'</row:pu_reference>');
    echo('<row:nombre>'.$num_rows.'</row:nombre>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
    echo('<row:tar_cleunik NC:parseType="Integer">-3</row:tar_cleunik>');
    echo('<row:tar_designation>'.$vl_c_dico_00085.'</row:tar_designation>');
    echo('<row:pu_reference>'.$vl_pamp.'</row:pu_reference>');
    echo('<row:nombre>'.$num_rows.'</row:nombre>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
    echo('<row:tar_cleunik NC:parseType="Integer">-2</row:tar_cleunik>');
    echo('<row:tar_designation>'.$vl_c_dico_00084.'</row:tar_designation>');
    echo('<row:pu_reference>'.$vl_pr.'</row:pu_reference>');
    echo('<row:nombre>'.$num_rows.'</row:nombre>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
while ($row = mysql_fetch_assoc($result)) {
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
    // parseType = indication pour le type des donn√©es, utile pour le tri sur la colonne
    echo('<row:tar_cleunik NC:parseType="Integer">'.fa_ent_xml($row['tar_cleunik']).'</row:tar_cleunik>');
    echo('<row:code_type_achat>'.fa_ent_xml($row['choix_code']).'</row:code_type_achat>');
    echo('<row:tar_designation>'.fa_ent_xml($row['choix_valeur_texte_01']).'</row:tar_designation>');
    echo('<row:tarif_type_achat>'.fa_ent_xml($row['pu_reference']).'</row:tarif_type_achat>');
    if ($row['actif']==1) {
      echo('<row:properties></row:properties>');
    } else {
      echo('<row:properties>css_0001</row:properties>');
    }
    echo('<row:datevalidite>'.fa_ent_xml($row['datevalidite']).'</row:datevalidite>');
    echo('<row:pu_reference>'.fa_ent_xml($row['pu_reference']).'</row:pu_reference>');
    echo('<row:prop>'.fa_ent_xml($row['prop']).'</row:prop>');
    echo('<row:nombre>'.$num_rows.'</row:nombre>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
