<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_articles_03";
fa_acces_script();
$vl_c_mess_00018=fa_recup_dico("mess_00018");
$vl_c_mess_00019=fa_recup_dico("mess_00019");
$vl_c_mess_00020=fa_recup_dico("mess_00020");
$vl_c_mess_00021=fa_recup_dico("mess_00021");
$vl_c_mess_00022=fa_recup_dico("mess_00022");
$vl_c_mess_00023=fa_recup_dico("mess_00023");
$vl_c_mess_00024=fa_recup_dico("mess_00024");
$vl_c_mess_00025=fa_recup_dico("mess_00025");
$vl_c_mess_00026=fa_recup_dico("mess_00026");
$vl_c_mess_00027=fa_recup_dico("mess_00027");
$vl_c_mess_00028=fa_recup_dico("mess_00028");
$vl_c_mess_00029=fa_recup_dico("mess_00029");
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_t_tarif=fa_recup_param("vl_t_tarif","");
$vl_t_tar_cleunik=fa_recup_param("vl_t_tar_cleunik","");
$vl_t_code=fa_recup_param("vl_t_code","");
$vl_t_code_avant=fa_recup_param("vl_t_code_avant","");
$vl_c_majcodes=fa_recup_param("vl_c_majcodes","");
$vl_t_tarif=unserialize(stripslashes($vl_t_tarif));
$vl_t_tar_cleunik=unserialize(stripslashes($vl_t_tar_cleunik));
$vl_t_code=unserialize(stripslashes($vl_t_code));
$vl_t_code_avant=unserialize(stripslashes($vl_t_code_avant));
session_write_close();
$vl_b_transaction_ok=true;
$vl_e_i=-1;
$liste_tar_cleunik="";
switch (TRUE){
  case $vf_c_action=="kilometres_majtarif";
	foreach($vl_t_tar_cleunik as $vl_raf) {
	  $vl_e_i++;
	  $vl_tar_cleunik=$vl_t_tar_cleunik[$vl_e_i];
	  $liste_tar_cleunik.="$vl_tar_cleunik,";
	  $pu_reference=fa_floatval($vl_t_tarif[$vl_e_i]);
	  $sql_req = "UPDATE _art_tarifs SET dateheure_dermaj=now(),_art_tarifs.pu_reference=$pu_reference where tar_cleunik=$vl_tar_cleunik;";
	  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
	}
	if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00026.$vl_c_mess_err;} else {echo $vl_c_mess_00027;}
	if ($vl_c_majcodes==1){
		if ($liste_tar_cleunik!="") {
          $liste_tar_cleunik=substr($liste_tar_cleunik, 0, -1);
        } else {
          $liste_tar_cleunik=-99999999999999999;
        }
		$tar_cle=array();$art_cle=array();$act_cle=array();
		$sql_req="select art_cleunik,act_cleunik,tar_cleunik from _art_tarifs where tar_cleunik in($liste_tar_cleunik);";
		$result = _graal_requete_bd($sql_req);
		while ($row = mysql_fetch_assoc($result)) {
		  array_push ($tar_cle, $row['tar_cleunik']);
		  array_push ($art_cle, $row['art_cleunik']);
		  array_push ($act_cle, $row['act_cleunik']);
		}
		_graal_libere_requete_bd($result);
		$vl_e_i=-1;
		foreach($vl_t_tar_cleunik as $vl_raf) {
		  $vl_e_i++;
		  $vl_tar_cleunik=$vl_t_tar_cleunik[$vl_e_i];
		  $code=$vl_t_code[$vl_e_i];
		  $code_avant=$vl_t_code_avant[$vl_e_i];
			$vl_e_trouve=array_search($vl_tar_cleunik, $tar_cle);
			if ($vl_e_trouve===false) {
				//$code_fournisseur="";
			} else {
				$vl_e_art_cleunik=$art_cle[$vl_e_trouve];
				$vl_e_act_cleunik=$act_cle[$vl_e_trouve];
				$sql_req = "UPDATE _art_acteur SET code='$code' where art_cleunik=$vl_e_art_cleunik and act_cleunik=$vl_e_act_cleunik and code='$code_avant';";
		  		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
			}
		}
		if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00026.$vl_c_mess_err;} else {echo $vl_c_mess_00027.$sql_req;}
	}	
	break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
?>
