<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
define('EOL', "\r\n");
set_time_limit(6000);
echo(date("D M j G:i:s T Y").EOL);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_fla_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_frla');
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
$choix_depot_defaut=-15;
$choix_empla_defaut=-16;
$art_cod=array();$art_cle=array();
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeArticle) from $vl_c_base_origine.stock)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);  
$dep_cod=array();$dep_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=116"; //  On recherche les dépots
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($dep_cod, $row['code']);
  array_push ($dep_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$emp_cod=array();$emp_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=117"; //  On recherche les emplacements
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($emp_cod, $row['code']);
  array_push ($emp_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);  


$sql_req = "SELECT CodeArticle,CodeDepot,StockPhy,RelCli,RelFour,SeuilSecu,StockMaxi,Emplacement FROM $vl_c_base_origine.stock;";  
$result=_graal_requete_bd($sql_req);
$o_mou=new _graal_import();
$o_mou->req="INSERT IGNORE INTO $vl_c_base_destination._art_dep_emp (art_depemp_cleunik,art_cleunik,qte_stock,choix_depot,choix_empla) VALUES ";
$vf_e_art_depemp_cleunik=_graal_requete_max("art_depemp_cleunik","$vl_c_base_destination._art_dep_emp");
$sql_req_02="";
$i=0;$b=500;$j=0;
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_trouve=array_search($row['CodeArticle'], $art_cod);if ($vl_e_trouve===false) {$art_cleunik=0;} else {$art_cleunik=$art_cle[$vl_e_trouve];}
  if ($art_cleunik!=0) {
    $vl_e_trouve_dep=array_search($row['CodeDepot']  , $dep_cod);if ($vl_e_trouve_dep===false) {$choix_depot=$choix_depot_defaut;} else {$choix_depot=$dep_cle[$vl_e_trouve_dep];}
    $vl_e_trouve_emp=array_search($row['Emplacement'], $emp_cod);if ($vl_e_trouve_emp===false) {$choix_empla=$choix_empla_defaut;} else {$choix_empla=$emp_cle[$vl_e_trouve_emp];}
    $i++;
    $qte_stock=fa_nn($row['StockPhy']);
    $o_mou->dat.="($vf_e_art_depemp_cleunik,$art_cleunik,$qte_stock,$choix_depot,$choix_empla),";
    $vf_e_art_depemp_cleunik++;
  }
  if ($i % $b==0){$o_mou->execute();}
}
$o_mou->execute();
_graal_libere_requete_bd($result);
$sql_req="update _art_stock f1 , _art_dep_emp f2 set f1.gestion=1 where f1.art_cleunik=f2.art_cleunik;";
_graal_exec_requete($sql_req);

_graal_ferme_connexion();
echo($i.' infos dépôts-emplacements ajoutés sur articles'.EOL);
echo(date("D M j G:i:s T Y").EOL);
?>
