<?php
include("_graal_header_xml.inc.php");
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));

//$vl_e_limit=25;
/*
header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
*/

$vl_e_qte_nulle=intval(fa_recup_param("vl_e_qte_nulle",'3'));
$vl_c_datemvt=fa_recup_param('vl_c_datemvt','');
$vl_c_sortie=fa_recup_param('sortie','das');
session_write_close();
$vl_c_dico_00086=fa_recup_dico("dico_00086");
$vl_c_dico_00087=fa_recup_dico("dico_00087");
$vl_c_dico_00088=fa_recup_dico("dico_00088");
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','inventaire.xls');
$sql_req="SELECT _art_stock.art_cleunik as `art_cleunik`,qte_stock as `qte_stock`,_choix.choix_valeur_texte_01 as 'unite',"._graalsql_date('_art_stock.dateheure_dermvt')." as `dateheure_dermvt` ,";
$sql_req.=" _art_stock.dateheure_dermvt as `dateheure_dermvt_tri`,nb_decimales_qte as `nb_decimales_qte`,_article.code as `code`,_article.mnemotechnique as `mnemotechnique`,";
$sql_req.=" _article.description as `description`,_article.actif as `actif`,"._graalsql_date('_art_stock.dateheure_invent')." as `dateheure_invent` ,";
$sql_req.=" _art_stock.dateheure_invent as `dateheure_invent_tri`,_art_achats.der_pa as derpa,_art_achats.dateheure_der_achat,"._graalsql_date('_art_achats.dateheure_der_achat')." as `date_achat_clair`";
$sql_req.=" FROM _art_stock left join _article on _art_stock.art_cleunik=_article.art_cleunik ";
$sql_req.=" left join _choix on choix_cleunik=unite_stock left join _art_achats on _art_stock.art_cleunik=_art_achats.art_cleunik where 1 ";

switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND _article.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND _article.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND _article.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND _article.types_gestion & 4";break;
  case 'fabrication': $sql_req.= " AND _article.types_gestion & 8";break;
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND _article.actif=1";break;// Actifs
  case 2: $sql_req.= " AND _article.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_validite) {
  case '': break;
  default: $sql_req.=" and (_article.dateheurevalidite >= '$vl_c_validite' or _article.dateheurevalidite is null)";break;
}
switch ($vl_e_qte_nulle) {
  case 1: $sql_req.= " AND qte_stock=0";break;// Nulle
  case 2: $sql_req.= " AND qte_stock<>0";break;// Non nulle
  case 3: break;// Tous
  case 4: $sql_req.= " AND qte_stock<0";break;// Négatives
}

switch ($vl_c_zone) {
  case '1': $sql_req.=" and _article.description like '$vl_c_recherche%' ORDER BY `description` ASC";break;//  Description courte
  case '2': $sql_req.=" and _article.code like '$vl_c_recherche%' ORDER BY `code` ASC";break;//  Code
  case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%' ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
$sql_req.= " LIMIT 0, $vl_e_limit";

switch ($vl_c_sortie) {
  case "das":
    $result = _graal_requete_bd($sql_req);
	echo('<donnees>');
	while ($row = mysql_fetch_assoc($result)) {
		$art_cleunik=$row['art_cleunik'];
		$sql_req_01=<<<XOF
		SELECT f1.mvt_cleunik,f1.art_cleunik,f1.uti_cleunik,f1.int_cleunik,f1.blocnotebrut,f1.dateheuremvt,f1.dateheuresaisie,f1.choix_depot,
		f1.choix_empla,f1.qte_mvt,f1.qte_pos,f1.unite_mvt,f1.genre_mvt,f1.type_mvt,f1.pu_mvt,f2.choix_valeur_texte_01 as 'depot',
		f3.choix_valeur_texte_01 as 'empla',f4.choix_valeur_texte_01 as 'genre' from _mouvements_stock f1,_choix f2,_choix f3,_choix f4
		where f2.choix_cleunik=f1.choix_depot and f3.choix_cleunik=f1.choix_empla and f4.choix_cleunik=f1.genre_mvt
		and f1.mvt_cleunik in(SELECT f1.mvt_cleunik from _mouvements_stock f1 where f1.art_cleunik =$art_cleunik  and ( f1.dateheuremvt < '$vl_c_datemvt')
		group by f1.choix_depot,choix_empla order by dateheuremvt desc, mvt_cleunik desc)
XOF;
		$result_01 = _graal_requete_bd($sql_req_01);
		//echo $sql_req_01;
		//die ($sql_req_01);
		while ($row_01 = mysql_fetch_assoc($result_01)) {
			echo('<quoi ');
			$nb_dec=fa_ent_xml($row['nb_decimales_qte']);
		  echo(' code="'.fa_ent_xml($row['code']).'"');
		  echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
		  echo(' description="'.fa_ent_xml($row['description']).'"');
		  echo(' unite="'.fa_ent_xml($row['unite']).'"');
		  echo(' date_achat_clair="'.fa_ent_xml($row['date_achat_clair']).'"');
		  echo(' dateheure_der_achat="'.fa_ent_xml($row['dateheure_der_achat']).'"');
		  $derpa=fa_reel(fa_ent_xml($row['derpa']),4);
		  echo(' derpa="'.$derpa.'"');
		  $val_derpa=$row['derpa']*1000;
		  printf(' val_derpa="%011u"',$val_derpa);
		  if ($row['actif']==1) {
		    echo(' properties=""');
		  } else {
		    echo(' properties="css_0001"');
		  }

		    echo(' mvt_cleunik="'.fa_ent_xml($row_01['mvt_cleunik']).'"');
		    echo(' art_cleunik="'.fa_ent_xml($row_01['art_cleunik']).'"');
		    echo(' uti_cleunik="'.fa_ent_xml($row_01['uti_cleunik']).'"');
		    echo(' int_cleunik="'.fa_ent_xml($row_01['int_cleunik']).'"');
		    echo(' dateheuremvt="'.fa_ent_xml($row_01['dateheuremvt']).'"');
		    echo(' dateheuresaisie="'.fa_ent_xml($row_01['dateheuresaisie']).'"');
		    echo(' choix_depot="'.fa_ent_xml($row_01['choix_depot']).'"');
		    echo(' choix_empla="'.fa_ent_xml($row_01['choix_empla']).'"');
		    $qte_stock=fa_reel(fa_ent_xml($row_01['qte_mvt']),$nb_dec);
		    echo(' qte_mvt="'.$qte_stock.'"');
		    $val_qte_stock=$row_01['qte_mvt']*1000;
		    printf(' val_qte_mvt="%011u"',$val_qte_stock);
		    if ($row_01['qte_pos']==0) {
		    	$vl_c_qte_pos="";
		    } else {
		    	$vl_c_qte_pos=fa_reel(fa_ent_xml($row_01['qte_pos']),$nb_dec);
		    }
		    $val_qte_pos=$row_01['qte_pos']*1000;
		    printf(' val_qte_pos="%011u"',$val_qte_pos);
		    echo(' qte_pos="'.$vl_c_qte_pos.'"');
		    echo(' unite_mvt="'.fa_ent_xml($row_01['unite_mvt']).'"');
		    echo(' genre_mvt="'.fa_ent_xml($row_01['genre_mvt']).'"');
		    switch ($row_01['type_mvt']) {
		      case 1 : $vl_c_type_mvt=$vl_c_dico_00086;break;
		      case 2 : $vl_c_type_mvt=$vl_c_dico_00087;break;
		      case 3 : $vl_c_type_mvt=$vl_c_dico_00088;break;
		    }
		    echo(' type_mvt="'.$vl_c_type_mvt.'"');
		    if ($row_01['pu_mvt']==0) {
		    	echo(' pu_mvt=""');
		    } else {
		    	echo(' pu_mvt="'.fa_ent_xml($row_01['pu_mvt']).'"');
		    }
		    $mt_mvt=$row_01['pu_mvt']*$row_01['qte_mvt'];
		    if ($mt_mvt==0){
		    	echo(' mt_mvt=""');
		    } else {
		    	echo(' mt_mvt="'.fa_ent_xml($mt_mvt).'"');
		    }
		    echo(' depot="'.fa_ent_xml($row_01['depot']).'"');
		    echo(' empla="'.fa_ent_xml($row_01['empla']).'"');
		    echo(' genre="'.fa_ent_xml($row_01['genre']).'"');
		    echo(' blocnotebrut="'.fa_ent_xml($row_01['blocnotebrut']).'"');





		  echo('/>');
		  flush();
	}
	_graal_libere_requete_bd($result_01);

	}
	echo('</donnees>');
	_graal_libere_requete_bd($result);

    break;
    case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

$vl_c_bca_100=fa_recup_dico("bca_100");
$vl_c_bca_101=fa_recup_dico("bca_101");
$vl_c_bca_102=fa_recup_dico("bca_102");
$vl_c_bca_103=fa_recup_dico("bca_103");
$vl_c_bca_104=fa_recup_dico("bca_104");
$vl_c_bca_105=fa_recup_dico("bca_105");
$vl_c_bca_106=fa_recup_dico("bca_106");
$vl_c_bca_107=fa_recup_dico("bca_107");
$vl_c_bca_108=fa_recup_dico("bca_108");
$vl_c_bca_109=fa_recup_dico("bca_109");
$vl_c_bca_110=fa_recup_dico("bca_110");
$vl_c_bca_111=fa_recup_dico("bca_111");
$vl_c_bca_112=fa_recup_dico("bca_112");
$vl_c_bca_113=fa_recup_dico("bca_113");$vl_c_bca_113="Date Dernier PA";
$vl_c_bca_114=fa_recup_dico("bca_114");
$vl_c_bca_115=fa_recup_dico("bca_115");
$vl_c_bca_116=fa_recup_dico("bca_116");
$vl_c_bca_117=fa_recup_dico("bca_117");
$vl_c_bca_118=fa_recup_dico("bca_118");$vl_c_bca_118="Dernier PA";
$vl_c_bca_119=fa_recup_dico("bca_119");$vl_c_bca_119="Date dernier mouvement";

$vl_c_bca_120=fa_recup_dico("bca_120");$vl_c_bca_120="Identifiant chrono du mouvement";
$vl_c_bca_121=fa_recup_dico("bca_121");$vl_c_bca_121="Date et heure du mouvement";
$vl_c_bca_122=fa_recup_dico("bca_122");$vl_c_bca_122="Date et heure de saisie";
$vl_c_bca_123=fa_recup_dico("bca_123");$vl_c_bca_123="Quantité mouvement";
$vl_c_bca_124=fa_recup_dico("bca_124");$vl_c_bca_124="Stock après mouvement";
$vl_c_bca_125=fa_recup_dico("bca_125");$vl_c_bca_125="Dépôt";
$vl_c_bca_126=fa_recup_dico("bca_126");$vl_c_bca_126="Emplacement";
$vl_c_bca_127=fa_recup_dico("bca_127");$vl_c_bca_127="Origine";
$vl_c_bca_128=fa_recup_dico("bca_128");$vl_c_bca_128="Référence";
$vl_c_bca_129=fa_recup_dico("bca_129");$vl_c_bca_129="Valeur mouvement";
$vl_c_bca_130=fa_recup_dico("bca_130");$vl_c_bca_130="Type de mouvement";
$vl_c_bca_131=fa_recup_dico("bca_131");$vl_c_bca_131="PU du mouvement";

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Stock à date dernier PA"));
		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("$vl_c_bca_101"));
		$worksheet->write(0, 1, utf8_decode("$vl_c_bca_102"));
		$worksheet->write(0, 2, utf8_decode("$vl_c_bca_103"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bca_104"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bca_106"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_bca_113"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_bca_118"));
		$worksheet->write(0, 7, utf8_decode("$vl_c_bca_120"));
		$worksheet->write(0, 8, utf8_decode("$vl_c_bca_121"));
		$worksheet->write(0, 9, utf8_decode("$vl_c_bca_122"));
		$worksheet->write(0,10, utf8_decode("$vl_c_bca_123"));
		$worksheet->write(0,11, utf8_decode("$vl_c_bca_124"));

		$worksheet->write(0,12, utf8_decode("$vl_c_bca_130"));
		$worksheet->write(0,13, utf8_decode("$vl_c_bca_131"));
		$worksheet->write(0,14, utf8_decode("$vl_c_bca_129"));
		$worksheet->write(0,15, utf8_decode("$vl_c_bca_125"));
		$worksheet->write(0,16, utf8_decode("$vl_c_bca_126"));
		$worksheet->write(0,17, utf8_decode("$vl_c_bca_127"));
		$worksheet->write(0,18, utf8_decode("$vl_c_bca_128"));





		$vl_e_noligne=1;

		while ($row = mysql_fetch_assoc($result)) {

			$art_cleunik=$row['art_cleunik'];
			$sql_req_01=<<<XOF
			SELECT f1.mvt_cleunik,f1.art_cleunik,f1.uti_cleunik,f1.int_cleunik,f1.blocnotebrut,f1.dateheuremvt,f1.dateheuresaisie,f1.choix_depot,
			f1.choix_empla,f1.qte_mvt,f1.qte_pos,f1.unite_mvt,f1.genre_mvt,f1.type_mvt,f1.pu_mvt,f2.choix_valeur_texte_01 as 'depot',
			f3.choix_valeur_texte_01 as 'empla',f4.choix_valeur_texte_01 as 'genre' from _mouvements_stock f1,_choix f2,_choix f3,_choix f4
			where f2.choix_cleunik=f1.choix_depot and f3.choix_cleunik=f1.choix_empla and f4.choix_cleunik=f1.genre_mvt
			and f1.mvt_cleunik in(SELECT f1.mvt_cleunik from _mouvements_stock f1 where f1.art_cleunik =$art_cleunik  and ( f1.dateheuremvt < '$vl_c_datemvt')
			group by f1.choix_depot,choix_empla order by dateheuremvt desc, mvt_cleunik desc)
XOF;
			$result_01 = _graal_requete_bd($sql_req_01);
			//echo $sql_req_01;
			//die ($sql_req_01);
			while ($row_01 = mysql_fetch_assoc($result_01)) {

				$nb_dec=fa_ent_xml($row['nb_decimales_qte']);
				  if ($row['qte_stock']==0) {
				    $qte_stock=""; } else
				  {
				    $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
				  }
				  $val_qte_stock=$row['qte_stock']*1000;
					if ($row_01['qte_pos']==0) {
				    	$vl_c_qte_pos="";
				    } else {
				    	$vl_c_qte_pos=fa_reel(fa_ent_xml($row_01['qte_pos']),$nb_dec);
				    }
			switch ($row_01['type_mvt']) {
		      case 1 : $vl_c_type_mvt=$vl_c_dico_00086;break;
		      case 2 : $vl_c_type_mvt=$vl_c_dico_00087;break;
		      case 3 : $vl_c_type_mvt=$vl_c_dico_00088;break;
		    }
				$mt_mvt=$row_01['pu_mvt']*$row_01['qte_mvt'];
				$j=0;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['mnemotechnique']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($qte_stock));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['unite']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_achat_clair']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['derpa']));$j++;

			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['mvt_cleunik']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['dateheuremvt']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['dateheuresaisie']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['qte_mvt']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_qte_pos));$j++;

			    $worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_type_mvt));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['pu_mvt']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($mt_mvt));$j++;

			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['depot']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['empla']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['genre']));$j++;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode($row_01['blocnotebrut']));$j++;

			    $vl_e_noligne++;

			}

		}

		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    	break;

  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
_graal_ferme_connexion();
?>
