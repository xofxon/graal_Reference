<?php
include("_graal_header_pdf_02.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_numerotation.php");
include("_graal_fonctions_documents.php");
include("_graal_fonctions_documents_ciaux.php");
require_once('_graal_pdf_bloc_001.php');
class toto extends _graal_TCPDF {
// private variables
var $contenu_code;
var $contenu_nom_commercial;
var $contenu_dateexp;
var $contenu_transporteur;
var $contenu_code_bondepreparation;
var $police_du_document;
function Header() {
  global $vl_c_bpn_101;
  global $y;
  global $cols,$format;
  switch ($this->getPage()) {
    case 1:
    default:
        //  Impression titre filigranne
      $this->SetFont( $this->police_du_document, "B", 50);
    	$this->SetTextColor(203,203,203);
    	$this->Rotate(55,10,290);
    	$this->Text(10,290,"            ".$vl_c_bpn_101);
    	$this->Rotate(0);
    	$this->SetTextColor(0,0,0);
      //impression du titre
      $this->SetFont($this->header_font[0], $this->header_font[1], $this->header_font[2]);
			$this->SetY(3);
      $this->SetX(10);
      $this->MultiCell(250, 5, $this->header_string, 0, '', 0, 1, 0, 0, true, 0);
      //impression Bloc du haut
      $this->SetFont( $this->police_du_document, "B", 12);
      $this->_graal_pdf_cadre_01($this->contenu_code,$legende="Bon de commande",$colonne=10,$ligne=10,$largeur=50,$hauteur=10,"0011");
      $this->_graal_pdf_cadre_01($this->contenu_nom_commercial,$legende="Client",$colonne=65,$ligne=10,$largeur=90,$hauteur=10,'0000');
      $this->_graal_pdf_cadre_01($this->contenu_dateexp,$legende="Date de départ",$colonne=10,$ligne=25,$largeur=50,$hauteur=10,'0011');
      $this->_graal_pdf_cadre_01($this->contenu_transporteur,$legende="Transporteur",$colonne=65,$ligne=25,$largeur=90,$hauteur=10,'0000');
      $this->SetFont( $this->police_du_document, "B", 14);
      $this->_graal_pdf_cadre_01($this->contenu_code_bondepreparation,$legende="N° de bon",$colonne=160,$ligne=10,$largeur=45,$hauteur=20,'1100');
      $this->SetFont( $this->police_du_document, "",9);
      $this->addCols_00( $cols,$xyz=array("10","40","30"));
      $this->addLineFormat_00($format,$cols);
      $this->setY(50);
      $y=50;
      break;
  }
}
}

$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik","0"));
$vl_e_action_cleunik=intval(fa_recup_param("vl_e_action_cleunik","0"));
if ($commercial_cleunik==0) {fa_redirige("acces_interdit");}
$param_generaux_graal_002=intval(fa_recup_param("param_generaux_graal_002","2")); //  1->mémoriser le pdf dans le fichier, 2->ne pas le mémoriser dans le fichier
$param_generaux_graal_087=intval(fa_recup_param("param_generaux_graal_087","-1")); //  Modèle de fiche palette
$genre=fa_recup_param("genre","");
$vl_c_fic_ligne="_cdecli_lignes";
$vl_c_fic_qte="_cdecli_lignes_qte";
$vl_c_fic_entete="_cdecli_entetes";
$vl_c_id_fenetre="Edi_00005";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_b_acces=$vl_tb_droits[0];
if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_bpn_101=fa_recup_dico("bpn_101");
$vl_c_dico_00058=fa_recup_dico("dico_00058");
$police_du_document="FreeSerif";	// Il faut intégrer la police : 819.5 Ko
$police_du_document="Courier";		//	Police non intégrée : 3.6 Ko
$police_du_document="times";		//	Police non intégrée : 3.5 Ko	Pas de différence visuelle avec FreeSerif
switch ($genre) {
  case "solde":
    $sql_statut="and f4.statut<>-39";
    break;
  case "complet":
    $sql_statut="";
    break;
}
$sql_req="SELECT f1.code_interne,f1.description_interne,f4.qte_nbdec,case f4.qte when 0 then '' else round(f4.qte,f4.qte_nbdec) end as qte,f2.choix_valeur_texte_01 as lib_unite_cde,case f3.choix_cleunik when -112 then '' else f3.choix_valeur_texte_01 end as lib_unite_condi,case f4.qte_condi when 0 then '' else round(f4.qte_condi,0) END as qte_condi,f1.art_cleunik as art_cleunik 
from _cdecli_lignes f1  
left join _cdecli_lignes_qte f4 using (commercial_ligne_cleunik)  
left join _choix f2 on (f2.choix_cleunik=f4.qte_unite) 
left join _choix f3 on (f3.choix_cleunik=f4.unite_condi) 
WHERE commercial_cleunik=$commercial_cleunik $sql_statut order by f1.ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
if (mysql_num_rows($result)==0) {
  //  Rien à éditer
  $pdf = new _graal_TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pdf->_graal_pf_rai(); 
} else {
  $code_bondepreparation=_graal_numerote(11);//  Numérotation automatique des bons de préparation
  //  Recherche informations entête
  $sql_req_00="SELECT code as code,"._graalsql_date('a1.dateheureexpedition')." as dateexp,a2.nomcommercial as nom_commercial from _cdecli_entetes a1 left join _acteurs a2 using(act_cleunik) where commercial_cleunik=$commercial_cleunik";
  $aa=$sql_req_00;
  $result_00=_graal_requete_bd($sql_req_00);
  $row_00 = mysql_fetch_assoc($result_00);
  $nom_commercial=$row_00['nom_commercial'];
  $code=$row_00['code'];
  $dateexp=$row_00['dateexp'];
  _graal_libere_requete_bd($result_00);

  //  Recherche informations transporteur      
  $sql_req_00="SELECT IFNULL(round(poids_bru,2),-1) as poidsbrut_memo,nomcommercial as transporteur,round(nombre_colis,0) as nbcolis_memo FROM _cdecli_transporteurs left join _acteurs on (_cdecli_transporteurs.act_cleunik_trans=_acteurs.act_cleunik) where commercial_cleunik=$commercial_cleunik";
  $result_00=_graal_requete_bd($sql_req_00);
  if (mysql_num_rows($result_00)==0) {
    $transporteur="";
    $nbcolis_memo=-1;
    $poidsbrut_memo=-1;
  } else {
    $row_00 = mysql_fetch_assoc($result_00);
    $transporteur=$row_00['transporteur'];
    $nbcolis_memo=$row_00['nbcolis_memo'];
    $poidsbrut_memo=$row_00['poidsbrut_memo'];
  }
  _graal_libere_requete_bd($result_00);
  //  REcherche informations calculées
  $sql_req_00="select IFNULL(round(sum(a3.qte * a1.poidsbrut),2),-1) AS poidsbrut_calcule,round(sum(a3.qte_condi),0) AS nbcolis_calcule from _cdecli_lignes a1 left join _cdecli_lignes_qte a3 using (commercial_ligne_cleunik) where a1.commercial_cleunik=$commercial_cleunik group by a1.commercial_cleunik;";
  $result_00=_graal_requete_bd($sql_req_00);
  $row_00 = mysql_fetch_assoc($result_00);
  $nbcolis_calcule=$row_00['nbcolis_calcule'];
  $poidsbrut_calcule=$row_00['poidsbrut_calcule'];
  _graal_libere_requete_bd($result_00);
  if (($poidsbrut_memo==-1)||($poidsbrut_memo==0)) {$poidsbrut=$poidsbrut_calcule;} else {if ($poidsbrut_memo==-2) {$poidsbrut=0;} else {$poidsbrut=$poidsbrut_memo;}}
  if (($nbcolis_memo==-1)||($nbcolis_memo==0)) {$nbcolis=$nbcolis_calcule;} else {if ($nbcolis_memo==-1) {$nbcolis=0;} else {$nbcolis=$nbcolis_memo;}}
  $pseudo_pdf = new toto(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pseudo_pdf->Open();
  $pseudo_pdf->SetFont( $police_du_document, "", 9);  //  Police utilisée pour les lignes
  $pdf = new toto(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
  // set document information
  $pdf->SetCreator(PDF_CREATOR);
  //$pdf->SetProtection(array('print'));  //  On protège le document : seule l'impression est autorisée. 
  /*
   * le 27 août 2009 -> ne plus utiliser la protection, sinon on ne peut rien faire avec le document via le programme pdftk
   */
  $pdf->SetHeaderData("", 0,"", $data_entete);
  //$pdf->setPrintHeader(false);
  //$pdf->setPrintFooter(false);
  $pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
  //set auto page breaks
  //$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
  $pdf->SetAutoPageBreak(TRUE, 10);
  $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
  //$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
  $pdf->SetFooterMargin(5);
  $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO); //set image scale factor
  $pdf->setHeaderFont(Array($police_du_document, '', PDF_FONT_SIZE_MAIN));
  $pdf->setFooterFont(Array($police_du_document, '', PDF_FONT_SIZE_DATA));
  $pdf->SetFont($police_du_document, "", 12);
  $pdf->SetLineWidth(0.01);  //  Cadre invisible
  $pdf->AliasNbPages();
  $pdf->contenu_code=$code;
  $pdf->contenu_nom_commercial=$nom_commercial;
  $pdf->contenu_dateexp=$dateexp;
  $pdf->contenu_transporteur=$transporteur;
  $pdf->contenu_code_bondepreparation=$code_bondepreparation;
  $cols=array( "Colis"          => 12,
               "Conditionnement"=>46,
               "Quantité"       =>14,
               "Désignation"    =>118);
  $format=array("Colis"        =>"C",
               "Conditionnement"=>"L",
               "Quantité"       =>"C",
               "Désignation"    =>"L");
  $pdf->AddPage();
  //  Impression Cadre tableau
  $fonts=array( "Colis"          =>array($police_du_document,"","12"),
               "Conditionnement"=>array($police_du_document,"","12"),
               "Quantité"       =>array($police_du_document,"B","12"),
               "Désignation"    =>array($police_du_document,"","12"));
  $type=array( "Colis"          =>"Texte",
               "Conditionnement"=>"Texte",
               "Quantité"       =>"Texte",
               "Désignation"    =>"Texte");
  while ($row = mysql_fetch_assoc($result)) {
    $art_cleunik=$row['art_cleunik'];
    $Colis=$row['qte_condi'];
    $Conditionnement=$row['lib_unite_condi'];
    $Quantité=$row['qte'];
    //  L'arrondi ne fonctionne pas dans la requête (8/7/2008)
    $Quantité=round($row['qte'],$row['qte_nbdec']);
    $Code=$row['code_interne'];
    $Désignation=$row['description_interne'];
    $line = array("Colis"        =>$Colis,
                 "Conditionnement"=>$Conditionnement,
                 "Quantité"       =>$Quantité,
                 "Désignation"    =>$Désignation);
    $pdf->_graal_pf_imprime_ligne($line,$y,$cols,$format,$fonts,$type,270);
  }
  $pdf->SetFont( $police_du_document, "B",14);
  $pdf->_graal_pdf_cadre_00($contenu="Nombre de colis : ".$nbcolis,$colonne=10,$ligne=270,$largeur=50,$hauteur=10,"1111","DF");
  //  Recherche des palettes    
  $sql_req="select round(qte,0) as qte,f2.description from _cdecli_consignes left join _article f2 using(art_cleunik) where commercial_cleunik=$commercial_cleunik";
  $result = _graal_requete_bd($sql_req);
  $y    = 285;
  while ($row = mysql_fetch_assoc($result)){
    $texte_consignes=$row['qte']." ".$row['description'];
    $pdf->Text(10,$y,$texte_consignes);
    $y+=10;
  }
  _graal_libere_requete_bd($result);
  fa_fin_creation_bp($param_generaux_graal_087);
}
?>