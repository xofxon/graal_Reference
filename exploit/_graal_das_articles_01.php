<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_c_qui=fa_recup_param('vl_c_qui','favoris');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_inactif=intval(fa_recup_param('vl_e_inactif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));

$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));

$vl_e_art_choix=intval(fa_recup_param('vl_e_art_choix',0));
$vl_e_art_choix_cleunik=fa_recup_param('vl_e_art_choix_cleunik','0');
$vl_e_art_critere_cleunik=fa_recup_param('vl_e_art_critere_cleunik','0');

if (isset($vl_c_xml->vl_modele_recherche_articles)){$vl_modele_recherche_articles=$vl_c_xml->vl_modele_recherche_articles->attributes();}else{$vl_modele_recherche_articles='1';}
switch ($vl_modele_recherche_articles){
	case 2:	//	Modèle "Disponibilité"
$sql_req_cdecli=" (select sum(COALESCE(f5.qte,0)-COALESCE(f5.qte_deja,0)) from _cdecli_lignes f4 left join _cdecli_lignes_qte f5 using(commercial_ligne_cleunik) where (f5.statut=-38 or f5.statut is null) and f4.art_cleunik=_article.art_cleunik ) as encommande_cli ";
$sql_req_cdefou=" (select sum(COALESCE(f6.qte,0)-COALESCE(f6.qte_deja,0)) from _cdefou_lignes f7 left join _cdefou_lignes_qte f6 using(commercial_ligne_cleunik) where (f6.statut=-38 or f6.statut is null) and f7.art_cleunik=_article.art_cleunik ) as encommande_fou";
$sql_req_sto_00=" COALESCE(_art_stock.qte_stock,0) as qte_stock";
$sql_req_sto_01="  left join _art_stock using(art_cleunik)";
		break;
	case 1:
	default:
		$sql_req_cdecli="0 as encommande_cli";
		$sql_req_cdefou="0 as encommande_fou";
		$sql_req_sto_00="0 as qte_stock";
		$sql_req_sto_01="";
		break;
}
switch ($vl_e_art_choix){
	case 0:break;
	case 3:break;
	case 1://	avec critère
		$join_01=" left join _art_choix_fixes a3 on _article.art_cleunik=a3.art_cleunik ";
		if ($vl_e_art_choix_cleunik!=0){
			$cond_01=" and a3.choix_cleunik in($vl_e_art_choix_cleunik) ";
		} else {
			$cond_01=" and a3.critere_cleunik in($vl_e_art_critere_cleunik) ";
		}
}
switch ($vl_e_actif) {
  case '3': // Panier ou requête
    include("_graal_req_panier_articles.php");
    $sql_req = "SELECT $sql_req_sto_00 ,$sql_req_cdecli,$sql_req_cdefou,_article.nbdec_qte as nbcde_qte,_article.art_cleunik as art_cleunik,_article.code as code,_article.description as description,_article.mnemotechnique as mnemotechnique,_article.types_gestion as types_gestion,_article.actif as actif FROM `_article` $sql_req_sto_01 where art_cleunik IN($vl_art_cleunik)";
    break;
  case '1': 
  case '2': 
  case '0':
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_article');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        unset($_SESSION["$vl_c_var"]);
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_art_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_art_cleunik!="") {
          $vl_art_cleunik=substr($vl_art_cleunik, 0, -1);
        }  else {
          $vl_art_cleunik="-99999999";
        }
        $sql_req = "SELECT $sql_req_sto_00 ,$sql_req_cdecli,$sql_req_cdefou,_article.nbdec_qte as nbcde_qte,_article.art_cleunik as art_cleunik,_article.code as code,_article.description as description,_article.mnemotechnique as mnemotechnique,_article.types_gestion as types_gestion,_article.actif as actif FROM `_article` $sql_req_sto_01 where art_cleunik IN($vl_art_cleunik)";
        break;
      case '1': //  recherche orthographique 
        $sql_req = "SELECT $sql_req_sto_00 ,$sql_req_cdecli,$sql_req_cdefou,_article.nbdec_qte as nbcde_qte,_article.art_cleunik as art_cleunik,_article.code as code,_article.description as description,_article.mnemotechnique as mnemotechnique,_article.types_gestion as types_gestion,_article.actif as actif FROM `_article` $sql_req_sto_01 $join_01 where 1";
        switch ($vl_c_qui) {
          case 'tous': break;//tous
          case 'favoris': $sql_req.= " AND _article.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
          case 'achats' : $sql_req.= " AND _article.types_gestion & 1";break;
          case 'ventes' : $sql_req.= " AND _article.types_gestion & 2";break;
          case 'stocks' : $sql_req.= " AND _article.types_gestion & 4";break;        
          case 'fabrication': $sql_req.= " AND _article.types_gestion & 8";break;        
        }
        switch ($vl_c_validite) {
          case '': break;
          default: $sql_req.=" and (_article.dateheurevalidite >= '$vl_c_validite' or _article.dateheurevalidite is null)";break;  
          }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" and _article.description like '$vl_c_recherche%'";break;//  Description courte
          case '2': $sql_req.=" and _article.code like '$vl_c_recherche%'";break;//  Code
          case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%'";break;//  Mnémotechnique
        }
	    switch ($vl_e_art_choix){
			case 0:break;
			case 3:break;
			case 1://	avec critère
				$sql_req.=$cond_01;
		        break;
		    case 2:	
				if ($vl_e_art_choix_cleunik!=0){
					//	sans le choix
					$sous_condition="_art_choix_fixes.choix_cleunik in($vl_e_art_choix_cleunik)";
					} else {
						//	sans le critère
					$sous_condition="_art_choix_fixes.critere_cleunik in($vl_e_art_critere_cleunik)";
				}
				$sql_req.=" AND _article.art_cleunik IN (select a3.art_cleunik as art_cleunik from _article a3 where (select count(*) from _art_choix_fixes where _art_choix_fixes.art_cleunik=a3.art_cleunik and $sous_condition)=0 )";
				break;
	    }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            switch ($vl_e_actif) {
              case 1: $sql_req.= " AND _article.actif=1";break;// Actifs
              case 2: $sql_req.= " AND _article.actif=2";break;// Inactifs
              case 0: break;// Tous
            }
            break;
          default:
            switch ($vl_e_choix_cleunik) {
              case '0': //  on recherche sur le critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _article.art_cleunik in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where critere_cleunik=$vl_e_critere_cleunik)";break;
                  case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where critere_cleunik=$vl_e_critere_cleunik)";break;
                }
                break;
              default:
                //  on recherche sur le choix du critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _article.art_cleunik in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik in($vl_e_choix_cleunik))";break;
                  case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik in ($vl_e_choix_cleunik) and critere_cleunik=$vl_e_critere_cleunik)";break;
                  //case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik not in($vl_e_choix_cleunik))";break;
                }
              break;
            }
            $sql_req.= " AND _article.actif in($vl_e_actif,$vl_e_inactif)";
        }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" ORDER BY `description` ASC";break;//  Description courte
          case '2': $sql_req.=" ORDER BY `code` ASC";break;//  Code
          case '3': $sql_req.=" ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            $sql_req.= " LIMIT 0, $vl_e_limit";
            break;
          default:
        }
    }
}

switch ($vl_c_sortie) {
  case "das":
    $result = _graal_requete_bd($sql_req);
    echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		    echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		    echo(' description="'.fa_ent_xml($row['description']).'"');
		    echo(' code="'.fa_ent_xml($row['code']).'"');
		    echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
		    echo(' types_gestion="'.fa_ent_xml($row['types_gestion']).'"');
		    if ($row['actif']==1) {
		    	echo(' properties=""');
		    } else {
		        echo(' properties="css_0001"');
		    }
		    $nb_dec=fa_ent_xml($row['nb_decimales_qte']);
			if ($row['qte_stock']==0) {
			  $qte_stock=""; } else 
			{
			  $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
			}
			$val_qte_stock=$row['qte_stock']*1000;
			if ($row['encommande_cli']==0) {
			  $encommande_cli=""; } else 
			{
			  $encommande_cli=fa_reel(fa_ent_xml($row['encommande_cli']),$nb_dec);
			}
			$val_encommande_cli=$row['encommande_cli']*1000;
			if ($row['encommande_fou']==0) {
			  $encommande_fou=""; } else 
			{
			  $encommande_fou=fa_reel(fa_ent_xml($row['encommande_fou']),$nb_dec);
			}
			$val_encommande_fou=$row['encommande_fou']*1000;
			//echo ($row['qte_stock']);
			//echo ($row['encommande_cli']);
			//echo ($row['encommande_fou']);
			$dispo=fa_reel(($row['qte_stock']-$row['encommande_cli']+$row['encommande_fou']),$nb_dec);
			$val_dispo=($row['qte_stock']-$row['encommande_cli']+$row['encommande_fou'])*1000;
			if ($dispo==0){$dispo="";}
			echo(' qte_stock="'.$qte_stock.'"');
		  	printf(' val_qte_stock="%011u"',$val_qte_stock);
		  	echo(' encommande_cli="'.$encommande_cli.'"');
			  printf(' val_encommande_cli="%011u"',$val_encommande_cli);
			  echo(' encommande_fou="'.$encommande_fou.'"');
			  printf(' val_encommande_fou="%011u"',$val_encommande_fou);
			  echo(' dispo="'.$dispo.'"');
			  printf(' val_dispo="%011u"',$val_dispo);
			echo('/>');
		}
		echo('</donnees>');
    _graal_libere_requete_bd($result);
    _graal_ferme_connexion();
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
