<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_mail.php");
define('EOL', "\r\n");
$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
$vl_e_verification_syntaxe=intval(fa_recup_param('vl_e_verification_syntaxe','1'));
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
$sql_req="select _w_import_courriel_ligne.imp_cleunik as z01,_w_import_courriel_ligne.lig_cleunik as z02,_w_import_courriel_ligne.refweb as z03,_w_import_courriel_ligne.prenom as z04,";
$sql_req.=" _w_import_courriel_ligne.nom as z05,(select count(*) from _act_interlo_mail where _act_interlo_mail.refweb=_w_import_courriel_ligne.refweb) as z06,";
$sql_req.=" _w_import_courriel_ligne.valide as z07,(select count(*) from _w_import_courriel_ligne f2 where f2.refweb=_w_import_courriel_ligne.refweb and f2.imp_cleunik=$vl_e_imp_cleunik) as z08";
$sql_req.=" ,_w_import_courriel_ligne.emailing as z09 ";
$sql_req.=" from _w_import_courriel_ligne ";
$sql_req.=" where _w_import_courriel_ligne.imp_cleunik=$vl_e_imp_cleunik;";
//die($sql_req);
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' imp_cleunik="'.fa_ent_xml($row['z01']).'"');
  echo(' lig_cleunik="'.fa_ent_xml($row['z02']).'"');
  if ($row['z06']!=0) {
    echo(' nombre_deja="'.fa_ent_xml($row['z06']).'"');
    echo(' val_nombre_deja="'.fa_ent_xml($row['z06']).'"');
  } else {
    echo(' nombre_deja=""');
    echo(' val_nombre_deja="0"');
  }
  echo(' refweb="'.fa_ent_xml($row['z03']).'"');
  echo(' prenom="'.fa_ent_xml($row['z04']).'"');
  echo(' nom="'.fa_ent_xml($row['z05']).'"');
  echo(' valide="'.fa_ent_xml($row['z07']).'"');
  switch ($row['z07']) {
    case 1:$vl_c_prop_valide='am01';break;
    case 2:$vl_c_prop_valide='am02';break;
    case 3:$vl_c_prop_valide='am03';break;
  }

  echo(' prop_valide="'.$vl_c_prop_valide.'"');
  echo(' emailing="'.fa_ent_xml($row['z09']).'"');
  switch ($row['z09']) {
    case 1:$vl_c_prop_emailing='am01';break;
    case 2:$vl_c_prop_emailing='am02';break;
    case 3:$vl_c_prop_emailing='am03';break;
  }
  echo(' prop_emailing="'.$vl_c_prop_emailing.'"');

  if ($row['z08']!=1) {
    echo(' nombre_doublon="'.fa_ent_xml($row['z08']).'"');
    echo(' nombre_doublon_bis="'.fa_ent_xml($row['z08'])."-".fa_ent_xml($row['z03']).'"');
  } else {
    echo(' nombre_doublon=""');
    echo(' nombre_doublon_bis="0"');
  }
  if ($vl_e_verification_syntaxe==1) {
    //$vl_c_mailacontroler=$row['z03'];
    $vl_c_mailacontroler=str_replace(' ', '', $row['z03']);
    if(!ff_verifie($vl_c_mailacontroler)){
      $vl_c_syntaxe_courriel="Attention, syntaxiquement, '$vl_c_mailacontroler' n'est pas une adresse e-mail valide.";
    } else {
      $vl_c_syntaxe_courriel="Syntaxiquement, '$vl_c_mailacontroler' est une adresse e-mail valide.";
      $vl_c_syntaxe_courriel="Ok";
    }
    echo(' controle_01="'.fa_ent_xml($vl_c_syntaxe_courriel).'"');
  }
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
