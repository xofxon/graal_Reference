<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
$t_origines_ok=array();
$t_origines_ok[ 0]="_admin_fen_bd_sqlmanager";
$t_origines_ok[ 1]="_graal_fen_modeles_courriels_01";
$t_origines_ok[ 2]="_graal_fen_modeles_notes_01";
$t_origines_ok[ 3]="_graal_fen_note_01";
$t_origines_ok[ 4]="_graal_fen_utilisateurs_menu_01";
$t_origines_ok[ 5]="_graal_fen_modeles_docciaux_01";
$t_origines_ok[ 6]="_graal_fen_modeles_courriels_02";
$t_origines_ok[ 7]="_graal_fen_dossier_01";
$t_origines_ok[ 8]="_graal_fen_act_interlo_02";
$t_origines_ok[ 9]="_graal_fen_acteurs_01";
$t_origines_ok[10]="_graal_fen_actions_02";
$t_origines_ok[11]="_graal_fen_articles_01";
$t_origines_ok[12]="_graal_fen_articles_02";
$t_origines_ok[13]="_graal_fen_doc_07";
$t_origines_ok[14]="_graal_fen_pseudodocs_01";
$t_origines_ok[15]="_graal_fen_utilisateurs_menu_02";
fa_acces_script();
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vf_c_action=fa_recup_param('vf_c_action','??????');
$vf_e_doc_cleunik=intval(fa_recup_param('vf_e_doc_cleunik','0'));
$vf_c_titre =  fa_recup_param('titre','');
$vf_c_blocnote_riche=fa_recup_param('blocnote_riche','');
$vf_c_blocnote_riche=fa_vire_script($vf_c_blocnote_riche);
$vf_c_descriptif_sommaire=fa_recup_param('descriptif_sommaire','');
$vf_c_emplacement=fa_recup_param('emplacement','');
$vf_c_origine=fa_recup_param('origine','');
$vf_c_genre=fa_recup_param('genre','utilis');
$vl_c_qui=fa_recup_param('qui','?????');
$vl_e_portee_cleunik=fa_recup_param('portee_cleunik','0');
$vf_c_blocnotebrut=strip_tags($vf_c_blocnote_riche);
$vf_c_hash=hash('sha1', $vf_c_blocnote_riche,false);
if ($vl_c_qui=="lui"){
	$vl_e_uti_cleunik =intval(fa_recup_param('utilisateur_menu','0'));
}
$vf_c_type_insertion_dossier=fa_recup_param('type_insertion_dossier','');
$vf_c_label_insertion_dossier=fa_recup_param('label_insertion_dossier','');
$vf_c_cleunik_insertion_dossier=fa_recup_param('cleunik_insertion_dossier','');
/*
le 29 septembre 2010
  typedoc    1 -> Liens,
             2 -> Notes,
             3 -> Documents,
             4 -> Dossier,
             5 -> courriels envoyés,
             6 -> modèles de courriels texte,
             7 -> Flux RSS,
             8 -> requêtes personnelles,
             9 -> images des articles, logos de l'entreprise
            10 -> modèles de courriels HTML,
            11 -> modèles de notes,
            12 -> modèles de notification de lecture,
            13 -> pièces jointes,
            14 -> menus arbres personalisés
            15 -> menus pages personalisés
           101 -> modèles textes entêtes offres clients,
           102 -> modèles textes pied offres clients,
           111 -> modèles textes entêtes commandes clients,
           112 -> modèles textes pied commandes clients,
           121 -> modèles textes entêtes livraison clients,
           122 -> modèles textes pied livraison clients,
           131 -> modèles textes entêtes facture clients,
           132 -> modèles textes pied facture clients,
           141 -> modèles textes entêtes demandes fournisseur,
           142 -> modèles textes pied demandes fournisseur,
           151 -> modèles textes entêtes commandes fournisseur,
           152 -> modèles textes pied commandes fournisseur,
           153 -> modèles formulaires de fiches palettes,
           154 -> fichiers pdf de filigranne de documents,
           900 -> Conditions générales de vente
           901 -> Bloc de désinscription pour emailing html
           902 -> Bloc de désinscription pour emailing texte
           903 -> Bloc de sondage pour emailing html
           904 -> Bloc de sondage pour emailing texte
*/
$vf_e_typedoc=fa_recup_param('vf_e_typedoc','0');
$droits_proprio=1+2+4+8;/*  1 -> Propriétaire, 2 -> Lecture, 4 -> Modification -> 8 -> Suppression */
$droits_groupe=0;
$droits_lambda=0;
$vf_c_echo='???????';
switch (TRUE) {
  case $vf_c_action=='??????':
    exit;
    break;
  case $vf_c_action=='verifier_droits_acces':   //  Vérification que l'utilisateur a bien accès à la note
    //  Pour l'instant 4 avril 2007, on ne vérifie pas les droits des documents autres que ceux des utilisateurs
    switch ($vf_c_genre) {
      case 'action' : $vf_c_echo=15;break;
      case 'acteur' : $vf_c_echo=15;break;
      case 'entrep' : $vf_c_echo=15;break;
      case 'articl' : $vf_c_echo=15;break;
      case 'interl' : $vf_c_echo=15;break;
      case 'utilis' :
        $sql_req = "select droits_proprio from _droits_doc where doc_cleunik=$vf_e_doc_cleunik AND uti_cleunik=$vl_e_uti_cleunik";
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        $vf_c_echo=$row['droits_proprio'];
        break;
    }
    break;
  case $vf_c_action=='verifier_nom':  //  Vérification que le titre de la note n'existe pas ( avec le type 2 -> note)
   $sql_req = "select count(*) FROM _documents WHERE typedoc=$vf_e_typedoc and titre ='$vf_c_titre'";
  if ($res = _graal_requete_bd($sql_req)){
    if($ligne = mysql_fetch_row($res)){
        $nombre_doc=$ligne[0];
        if (is_null($nombre_doc)){
          $vf_c_echo= '0';
        }
        else
          $vf_c_echo=$nombre_doc;
    }
    else
      $vf_c_echo=$nombre_doc;
   }
    else
      $vf_c_echo=mysql_error($cnx) . $sql_req;
    exit($vf_c_echo);
    break;
  case $vf_c_action=='supprimer': //  Suppression d'un document
    if ($vf_e_doc_cleunik==-1) {exit (-1);}
    $sql_req = "DELETE FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik";
    $res=_graal_requete_bd($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    switch ($vf_e_typedoc) {
      case "2": //  Uniquement les notes, pas les requêtes Il n'y a pas de cascade car la table "_documents_texte" est MyIsam
        $sql_req = "DELETE FROM _documents_texte WHERE doc_cleunik = $vf_e_doc_cleunik";
        $vf_c_echo=_graal_exec_requete($sql_req);
      break;
    }
    break;
  case $vf_c_action=='ajouter': //  Ajout d'un document
    $vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
    $sql_req = "INSERT INTO _documents set emplacement='$vf_c_emplacement',doc_cleunik=$vf_e_doc_cleunik,typedoc=$vf_e_typedoc,titre = '$vf_c_titre',dateheurecreation = now(),descriptif_sommaire='$vf_c_descriptif_sommaire',blocnote_riche ='$vf_c_blocnote_riche',blocnote_brut = '$vf_c_blocnotebrut',hash_blocnote_riche='$vf_c_hash',origine='$vf_c_origine'";
    _graal_exec_requete($sql_req);
    $sql_req="";
    switch ($vf_c_genre) {
      case 'action' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_action;";break;
      case 'acteur' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_acteur;";break;
      case 'articl' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_articl;";break;
      case 'interl' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_interl;";break;
      case 'entrep' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=0,portee=$vl_e_entrep;";break;
      case 'utilis' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";break;
    }
    $res=_graal_exec_requete($sql_req);
    switch ($vf_c_genre) {
      case 'utilis' :  //  On ne gère les droits que pour les utilisateurs
        $sql_req = "INSERT INTO _droits_doc set doc_cleunik=$vf_e_doc_cleunik,uti_cleunik=$vl_e_uti_cleunik,droits_proprio=$droits_proprio,droits_groupe=$droits_groupe,droits_lambda=$droits_lambda";
        $res=_graal_exec_requete($sql_req);
        break;
    }
    switch ($vf_e_typedoc){
      case "2": //  Uniquement les notes, pas les requêtes
        $sql_req = "INSERT INTO _documents_texte set doc_cleunik=$vf_e_doc_cleunik,titre='$vf_c_titre',descriptif_sommaire='$vf_c_descriptif_sommaire',doc_brut='$vf_c_blocnotebrut'";
        $res=_graal_exec_requete($sql_req);
      break;
    }
    $vf_c_echo=$vf_e_doc_cleunik;
    break;
	case $vf_c_action=='attacher': //  Attacher un document
	    switch ($vf_c_genre) {
	      case 'action' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_action;";break;
	      case 'acteur' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_acteur;";break;
	      case 'articl' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_articl;";break;
	      case 'interl' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_interl;";break;
	      case 'entrep' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=0,portee=$vl_e_entrep;";break;
	      case 'utilis' : $sql_req = "REPLACE INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";break;
	    }
	    _graal_exec_requete($sql_req);
	    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
	    break;
  case $vf_c_action=='modifier':  //  Modification d'un document
    $sql_req = "update _documents set emplacement='$vf_c_emplacement',titre='$vf_c_titre',descriptif_sommaire='$vf_c_descriptif_sommaire',blocnote_riche='$vf_c_blocnote_riche',blocnote_brut ='$vf_c_blocnotebrut',dateheuremodif = now(),hash_blocnote_riche='$vf_c_hash',origine='$vf_c_origine' where doc_cleunik=$vf_e_doc_cleunik";
    $res=_graal_requete_bd($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    switch ($vf_e_typedoc){
      case "2": //  Uniquement les notes, pas les requêtes
        $sql_req = "update _documents_texte set titre='$vf_c_titre',descriptif_sommaire='$vf_c_descriptif_sommaire',doc_brut='$vf_c_blocnotebrut' where doc_cleunik=$vf_e_doc_cleunik";
        _graal_exec_requete($sql_req);
      break;
    }
    break;
  case $vf_c_action=='insere_dans_dossier':  // insertion d'une action dans la branche "A classer"
  	$sql_req = "SELECT blocnote_riche AS blocnote_riche FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
  	$doc = new DomDocument;
	$doc->validateOnParse = true;// Nous devons valider notre document avant de nous référer à l'ID
	$doc->LoadXML($row['blocnote_riche']);
	_graal_libere_requete_bd($result);
	$params = $doc->getElementsByTagName('item'); // On recherche les items
	$k=0;
	switch ($vf_c_type_insertion_dossier) {
		case "interlo":
			$link="Interlocuteurs";
			$properties="ai18";
			$value="4";
			break;
		case "acteur":
			$link="Acteurs";
			$properties="ai15";
			$value="3";
			break;
		case "action":
			$link="Action";
			$properties="af08";
			$value="6";
			break;
		case "article":
			$link="Article";
			$properties="ai07";
			$value="7";
			break;
		case "doc":
			$link="Document";
			$properties="ai03";
			$value="8";
			break;
		case "note":
			$link="Note";
			$properties="ai02";
			$value="2";
			break;
		case "pseudo_doc":
			$link="Pseudo-document";
			$properties="ah05";
			$value="1";
			break;
		default:
			die("Pas ok");
	}
	foreach ($params as $param) {
		if ($params->item($k)->getAttribute('id')=="branche_a_classer"){
			$element = createElement($doc, 'item', '', array('label'=>"$vf_c_label_insertion_dossier",
			'link'=>"$link",
			'properties'=>"$properties",
			'url'=>"$vf_c_cleunik_insertion_dossier",
			'id'=>'id',
			'hidden'=>'false',
			'value'=>"$value",
			)
			);
			$params->item($k)->appendChild($element);
		}
		$k++;
	}
  	$vf_c_blocnote_riche=$doc->saveXML();
  	$vf_c_hash=hash('sha1', $vf_c_blocnote_riche,false);
    $sql_req = "update _documents set blocnote_riche='$vf_c_blocnote_riche',hash_blocnote_riche='$vf_c_hash' where doc_cleunik=$vf_e_doc_cleunik";
    $res=_graal_requete_bd($sql_req);
    if($res === false) {echo 'Erreur';} else {$vf_c_echo='Inséré dans dossier.';}
    break;
 // On continue les traitements particuliers
}
_graal_ferme_connexion();
echo $vf_c_echo;
function createElement($domObj, $tag_name, $value = NULL, $attributes = NULL){
    $element = ($value != NULL ) ? $domObj->createElement($tag_name, $value) : $domObj->createElement($tag_name);
    if( $attributes != NULL ){
        foreach ($attributes as $attr=>$val) {
            $element->setAttribute($attr, $val);
        }
    }
    return $element;
}
?>
