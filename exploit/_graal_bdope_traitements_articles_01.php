<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_articles_01";
$t_origines_ok[1]="_graal_traitements_articles_06";
$t_origines_ok[2]="_graal_traitements_articles_05";
$t_origines_ok[3]="_graal_fen_articles_derpa_01";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));

$vl_e_compta_cleunik=intval(fa_recup_param('vl_e_compta_cleunik','0'));
$vl_e_tpf_cleunik=intval(fa_recup_param('vl_e_tpf_cleunik','0'));
$vl_e_tpf_cleunik_new=intval(fa_recup_param('vl_e_tpf_cleunik_new','0'));

$vl_e_tva_cleunik=intval(fa_recup_param('vl_e_tva_cleunik','0'));
$vl_e_tva_cleunik_new=intval(fa_recup_param('vl_e_tva_cleunik_new','0'));

//IMPORTANT IMPORTANT IMPORTANT IMPORTANT Bien penser à utiliser intval pour convertir les données numériques
$vl_t_article=fa_recup_param("vl_t_article","");
$vl_t_article=unserialize(stripslashes($vl_t_article));
$vl_t_derpa=fa_recup_param("vl_t_derpa","");
$vl_t_derpa=unserialize(stripslashes($vl_t_derpa));
$vl_t_date=fa_recup_param("vl_t_date","");
$vl_t_date=unserialize(stripslashes($vl_t_date));

session_write_close();

switch (TRUE){
  case $vf_c_action=="kilometres_activer";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
	$sql_req = "UPDATE _article SET actif=1 WHERE art_cleunik in($sql_condition);";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'L\'activation des articles a échoué.'.$vl_c_mess_err;} else {echo 'L\'activation des articles a été correctement effectuée.';}
    break;
  case $vf_c_action=="kilometres_remplace_tpf";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
	$sql_req = "UPDATE _art_compta SET tpf_cleunik=$vl_e_tpf_cleunik_new WHERE art_cleunik in($sql_condition) and tpf_cleunik=$vl_e_tpf_cleunik and catcompta_cleunik=$vl_e_compta_cleunik;";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La modification des tpf articles a échoué.'.$vl_c_mess_err;} else {echo 'La modification des tpf a été correctement réalisée.';}
    break;
  case $vf_c_action=="kilometres_remplace_tpf_01";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
	$sql_req = "UPDATE _art_compta SET tpf_cleunik_01=$vl_e_tpf_cleunik_new WHERE art_cleunik in($sql_condition) and tpf_cleunik_01=$vl_e_tpf_cleunik and catcompta_cleunik=$vl_e_compta_cleunik;";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La modification des 2° tpf articles a échoué.'.$vl_c_mess_err;} else {echo 'La modification des 2° tpf a été correctement réalisée.';}
    break;
  case $vf_c_action=="kilometres_remplace_tva";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
	$sql_req = "UPDATE _art_compta SET taxes_cleunik=$vl_e_tva_cleunik_new WHERE art_cleunik in($sql_condition) and taxes_cleunik=$vl_e_tva_cleunik and catcompta_cleunik=$vl_e_compta_cleunik;";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La modification des taxes articles a échoué.'.$vl_c_mess_err;} else {echo 'La modification des taxes a été correctement réalisée.';}
    break;
  case $vf_c_action=="kilometres_desactiver";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
    $sql_req = "UPDATE _article SET actif=2 WHERE art_cleunik in($sql_condition);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La désactivation des articles a échoué.'.$vl_c_mess_err;} else {echo 'La désactivation des articles a été correctement effectuée.';}
    break;
    
  case $vf_c_action=="dupliquer_compta_reference";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      $vl_e_art_cleunik_origine=0;
  	  $sql_req = "INSERT IGNORE INTO _art_compta SELECT $vl_art_cleunik,catcompta_cleunik,pc_cleunik_vente,pc_cleunik_achat,taxes_cleunik,tpf_cleunik,tpf_cleunik_01 FROM _art_compta where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    }
    if ($vl_b_transaction_ok==false) {echo 'La MAJ des infos comptables des articles a échoué.'.$vl_c_mess_err;} else {echo 'La MAJ des infos comptables des articles a été correctement effectuée.';}
    break;
    
  case $vf_c_action=="choix_ajo";
    $i1=500;
    $o_choix=new _graal_import();
    $o_choix->req="INSERT INTO _art_choix_fixes (art_cleunik,choix_cleunik,critere_cleunik) VALUES ";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      $o_choix->dat.="($vl_art_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik),";
      if ($i % $i1==0){$o_choix->execute();}
    }
    $o_choix->execute();
    echo ("$i choix ajoutés");
    break;
  case $vf_c_action=="choix_sup";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
    $sql_req = "DELETE FROM _art_choix_fixes WHERE art_cleunik in($sql_condition) and choix_cleunik=$vl_e_choix_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des choix a échoué.'.$vl_c_mess_err;} else {echo 'La supression des choix a été correctement effectuée.';}
    break;
  case $vf_c_action=="critere_sup";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
    $sql_req = "DELETE FROM _art_choix_fixes WHERE art_cleunik in($sql_condition) and critere_cleunik=$vl_e_critere_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des critères a échoué.'.$vl_c_mess_err;} else {echo 'La supression des critères a été correctement effectuée.';}
    break;
 case $vf_c_action=="kilometres_maj_derpa";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_t_article as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_article[$vl_e_i];
      $vl_derpa=$vl_t_derpa[$vl_e_i];
      $vl_date=$vl_t_date[$vl_e_i];
	  $sql_req = "UPDATE _art_achats SET der_pa=$vl_derpa,dateheure_der_achat='$vl_date' WHERE art_cleunik =$vl_art_cleunik;";
	  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    }
    if ($vl_b_transaction_ok==false) {echo 'La MAJ des derniers PA a échoué.'.$vl_c_mess_err;} else {echo 'La MAJ des dernier PA a été correctement effectuée.';}
    //echo $sql_req;
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
?>
