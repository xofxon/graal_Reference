<?php
include("_graal_header_xul.inc.php");
$vl_c_id_fenetre=fa_recup_param('vl_c_id_fenetre','');
$vl_e_obj_cleunik=intval(fa_recup_param('vl_e_obj_cleunik',''));
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_langue=intval(fa_recup_session('langue_appli','120131'));  //  français par défaut
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_aax_101=fa_recup_dico("aax_101");
$vl_c_aax_102=fa_recup_dico("aax_102");
$vl_c_aax_103=fa_recup_dico("aax_103");
$vl_c_aax_104=fa_recup_dico("aax_104");
$vl_c_sortir=fa_recup_dico("dico_00007");
$vl_c_dupliquer=fa_recup_dico("dico_00016");
//  On recherche l'objet d'origine        
$sql_req = "SELECT _objets.titre AS titre,_objets_libelle.descriptif AS descriptif,_objets.prefixe as prefixe,_objets.type_objet as type_objet FROM _objets,_objets_libelle WHERE _objets.fen_cleunik=$vl_e_obj_cleunik and _objets.fen_cleunik=_objets_libelle.fen_cleunik and _objets_libelle.langue=$vl_e_langue";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $champ_00=('<label flex="1" value="'.$vl_c_aax_102.'" />');
} else {
  while ($row = mysql_fetch_assoc($sql_result)) {
    $vl_c_prefixe=$row['prefixe'];
    $vl_c_type_objet=$row['type_objet'];
    $champ_00=("<label id='la_obj_origine' value='" .$row['titre']."(".fa_remplace_quotes(fa_ent_xml($row['descriptif'])).")"."' _graal_cleunik='".$vl_e_obj_cleunik."' label='" .$row['titre']."(".fa_remplace_quotes(fa_ent_xml($row['descriptif'])).")"."'/>");
  }
}
_graal_libere_requete_bd($sql_result);
//  On recherche tous les autres objets avec le même préfixe et le même type, sauf celui d'origine  
$sql_req = "SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif,_objets.prefixe as prefixe FROM _objets,_objets_libelle WHERE _objets.fen_cleunik<>$vl_e_obj_cleunik and _objets.fen_cleunik=_objets_libelle.fen_cleunik and _objets_libelle.langue=$vl_e_langue and _objets.prefixe='$vl_c_prefixe' and _objets.type_objet=$vl_c_type_objet";      
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $champ_01="<label value='$vl_c_aax_103' />";
} else {
  $champ_01="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='15' id='ml_objets'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)) {
    $champ_01.=("<menuitem value='" .$row['titre']."(".fa_remplace_quotes(fa_ent_xml($row['descriptif'])).")"."' _graal_cleunik='".$row['fen_cleunik']."' label='" .$row['titre']."(".fa_remplace_quotes(fa_ent_xml($row['descriptif'])).")"."'/>");
  }
  $champ_01.="</menupopup></menulist>";
}
_graal_libere_requete_bd($sql_result);
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_aax_101" id="win_duplique_elements" onload="fa_aa(this);" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_duplique_elements_01.js.php");
echo <<<END
<vbox flex="10" id="vb_tableau">
$champ_00
$champ_01
</vbox>
<vbox flex="1" id="boutons_standards">
    <hbox>
      <button flex="1" id="bt_enregistrer" label="$vl_c_dupliquer" crop="end" dir="normal" oncommand="pf_validation('enregistrer')" />
      <button flex="1" id="bt_enregistrer_tous" label="$vl_c_aax_104" crop="end" dir="normal" oncommand="pf_validation('enregistrer_tous')" />
    </hbox>
    <button flex="1" id="bt_sortir" label="$vl_c_sortir" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </vbox>
 </window>
END;
?>
