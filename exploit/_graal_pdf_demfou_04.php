<?php
include("_graal_header_pdf_02.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_numerotation.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
include("_graal_fonctions_documents.php");
include("_graal_fonctions_documents_ciaux.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik","0"));
$vl_e_action_cleunik=intval(fa_recup_param("vl_e_action_cleunik","0"));
$genre_adresse=intval(fa_recup_param("vl_genre_adresse","1"));  // 1-> adresse de livraison, 2 adresse de facturation 
if ($vl_commercial_cleunik==0) {fa_redirige("acces_interdit");}
$param_generaux_graal_035=intval(fa_recup_session('vs_param_generaux_graal_035',2)); //  1->mémoriser le pdf dans le fichier, 2->ne pas le mémoriser dans le fichier
$param_generaux_graal_059=intval(fa_recup_session('vs_param_generaux_graal_059',-1)); //  Logo sur la première page d'édition
$param_generaux_graal_060=intval(fa_recup_session('vs_param_generaux_graal_060',-1)); //  Logo sur les autres pages d'adition
$param_generaux_graal_079=intval(fa_recup_session('vs_param_generaux_graal_079',0)); //  Largeur logo première page
$param_generaux_graal_080=intval(fa_recup_session('vs_param_generaux_graal_080',0)); //  Hauteur logo première page
$param_generaux_graal_081=intval(fa_recup_session('vs_param_generaux_graal_081',0)); //  Largeur logo autres pages
$param_generaux_graal_082=intval(fa_recup_session('vs_param_generaux_graal_082',0)); //  Hauteur logo autres pages

$vl_c_fic_ligne="_demfou_lignes";
$vl_c_fic_qte="_demfou_lignes_qte";
$vl_c_fic_entete="_demfou_entetes";
$vl_e_fic_adresses="_demfou_adresses";
$vl_c_id_fenetre="Edi_00017";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_b_acces=$vl_tb_droits[0];
if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_dico_00058=fa_recup_dico("dico_00058");
$genreaction="demfou";
$genreregroupement="initial";
include("_graal_req_docial_recap_montants.inc.php");
require_once('_graal_pdf_bloc_001.php');
define('EOL', "\r\n");
class pseudo extends _graal_TCPDF {
function Header() {}
}
class toto extends _graal_TCPDF {
// private variables
var $contenu_code;
var $contenu_nom_commercial;
var $contenu_dateexp;
var $contenu_code_bondepreparation;
var $impression_cgv;
function Header() {
  global $vl_commercial_cleunik;
  global $genre_adresse;
  global $action_cleunik;
  global $datecre;
  global $dateliv;
  global $codealphanum15;
  global $description_reg;
  global $vosreferences;
  global $blocnotebrut_entete;
  global $y;
  global $cols;
  global $format;
  global $nbligne_montant_pied;
  global $hauteur_blocnote_pied;
	global $raisonsoc;
	global $vl_e_fic_adresses;
	global $param_generaux_graal_059;
	global $param_generaux_graal_060;
	global $param_generaux_graal_079;
	global $param_generaux_graal_080;
	global $param_generaux_graal_081;
	global $param_generaux_graal_082;
		
  switch ($this->getPage()) {
    case 1:
/*
			$toto="{nombredepages}";
			$titi=intval($toto);
			$titi=$titi-1;
*/
			$this->_graal_logo($param_generaux_graal_059,10,6,$param_generaux_graal_079,$param_generaux_graal_080);
      $this->SetFont( "FreeSerif", "B",12);
      $this->_graal_pdf_cadre_00($contenu="Demande ".$this->contenu_code,$colonne=120,$ligne=10,$largeur=80,$hauteur=10,"1111","DF");
      $this->_graal_pdf_cadre_00("Page ".$this->getPage()."/{nombredepages}",$colonne=120,$ligne=20,$largeur=20,$hauteur=10,'0000');
      $this->_graal_pdf_cadre_00("Le $datecre",$colonne=140,$ligne=20,$largeur=27,$hauteur=10,'0000');
      $this->_graal_pdf_cadre_00("$codealphanum15",$colonne=167,$ligne=20,$largeur=33,$hauteur=10,'0000');
      $this->SetFont( "FreeSerif", "",10);
      $this->_graal_pdf_cadre_01($description_reg,$legende="Mode de règlement",$colonne=10,$ligne=80,$largeur=60,$hauteur=10,'0000');
      $this->_graal_pdf_cadre_01($dateliv,$legende="Livraison au plus tard",$colonne=70,$ligne=80,$largeur=35,$hauteur=10,'0011');
			//$this->_graal_pdf_cadre_01($this->contenu_dateexp,$legende="Date de départ",$colonne=105,$ligne=80,$largeur=25,$hauteur=10,'0011');
      if (trim($vosreferences)!="") {
        $this->_graal_pdf_cadre_01($vosreferences,$legende="Nos références",$colonne=130,$ligne=80,$largeur=70,$hauteur=10,'0011');
      }
			$interlo_privilegie=-110419;
			//  Recherche interlocuteur privilégié d'offre, de commande, de livraison, de raception, de facture ... selon le document
			// Recherche adresse de livraison ou de facturation, selon $genre_adresse
			//  Impression du bloc note entête
			//  Entête du tableau
			include("_graal_bloc_code_docciaux_04.php");
      break;
    default:
			if ($this->impression_cgv=="false") {
				$this->_graal_logo($param_generaux_graal_060,10,6,$param_generaux_graal_081,$param_generaux_graal_082);
	      $this->SetFont( "FreeSerif", "B",12);
	      $this->_graal_pdf_cadre_00($contenu="Demande ".$this->contenu_code,$colonne=120,$ligne=10,$largeur=80,$hauteur=10,"1111","DF");
	      $this->_graal_pdf_cadre_00("Page ".$this->getPage()."/{nombredepages}",$colonne=120,$ligne=20,$largeur=20,$hauteur=10,'0000');
	      $this->_graal_pdf_cadre_00("Le $datecre",$colonne=140,$ligne=20,$largeur=27,$hauteur=10,'0000');
	      $this->_graal_pdf_cadre_00("$codealphanum15",$colonne=167,$ligne=20,$largeur=33,$hauteur=10,'0000');
	      //  Entête du tableau
	      $this->SetFont( "FreeSerif", "",9);
	      $y=$this->getY()+10;
	      $y=80;
	      if ($nbligne_montant_pied>2) {
	        $this->addCols_00( $cols,$xyz=array("10",$y,(30+(($nbligne_montant_pied-2)*5)+$hauteur_blocnote_pied)));
	      } else {
	        $this->addCols_00( $cols,$xyz=array("10",$y,30+$hauteur_blocnote_pied));
	      }
	      $this->addLineFormat_00($format,$cols);
	      $this->setY($y+10);
	      $y=$this->getY();
			} else {
				//	On imprime les conditions générales de vente
			}
      break;
  }
}
}
$sql_req="SELECT f1.code_acteur,f1.description_acteur,f1.blocnotebrut,f1.code_interne,f1.mnemotechnique_interne as z06,f1.description_interne,f4.qte,f4.qte_nbdec,f4.qte_unite as z10,f1.pu as pu,f1.pu_type as z12,f1.nbdec_pu,f1.remise_taux,f2.choix_valeur_texte_01 as z17,f3.choix_valeur_texte_01 as z18,f1.typeligne as z19,f1.coef_facture as coef_facture,f1.remise_genr,f1.remise_natu,f1.remise_type,$sql_htbrutremise,f5.code from _demfou_lignes f1,_choix f2,_choix f3,_demfou_lignes_qte f4,_param_taxes f5 WHERE commercial_cleunik=$vl_commercial_cleunik and f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f2.choix_cleunik = qte_unite and f3.choix_cleunik=statut and f5.taxes_cleunik=f1.taxes_cleunik order by f1.ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
if (mysql_num_rows($result)==0) {
  //  Rien à éditer
  $pdf = new _graal_TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pdf->_graal_pf_rai(); 
} else {
  //  Recherche informations entête
  //  Recherche du nombre de remises de lignes pour déterminer l'affichage ou non de la colonne  
  //  Recherche du nombre de taux de taxes différents pour déterminer l'affichage ou non de la colonne  
	include("_graal_bloc_code_docciaux_03.php");
  //  Calcul du nombre de lignes de montants dans le pied
	include("_graal_bloc_code_docciaux_montants_pied_doc.php");
  $pseudo_pdf = new pseudo(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pseudo_pdf->Open();
  $pseudo_pdf->SetFont( "FreeSerif", "", 9);  //  Police utilisée pour les lignes
  if (trim($blocnotebrut_pied)!="") {
    $hauteur_blocnote_pied=round($pseudo_pdf->_graal_hauteur_00( $y=0, $blocnotebrut_pied,$x=10,$pos=2,array( "FreeSerif", "", 9)),0);
  } else {
    $hauteur_blocnote_pied=0;
  }
  //  S'il y a 2 lignes de montants, le pied peut commencer à 270
  $position_pied=270;
  if ($nbligne_montant_pied>2) {
    $position_pied=$position_pied-(($nbligne_montant_pied-2)*5);
  }
  $position_pied-=$hauteur_blocnote_pied;
  $pdf = new toto(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
  // set document information
  $pdf->SetCreator(PDF_CREATOR);
  $pdf->SetProtection(array('print'));  //  On protège le document : seule l'impression est autorisée.
  //$pdf->setPrintHeader(false);
  $pdf->setPrintFooter(false);  //  Définir ce que l'on mettra dans le pied
  $pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
  //set auto page breaks
  //$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
  $pdf->SetAutoPageBreak(TRUE, 10);
  $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
  //$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
  $pdf->SetFooterMargin(5);
//  $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
//  $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
  $pdf->SetLineWidth(0.01);  //  Cadre invisible
  $pdf->AliasNbPages("nombredepages");
  $pdf->contenu_code=$code;
  $pdf->contenu_dateexp=$dateexp;
  switch ($nombre_taxes) {
    case 1:
      switch ($nb_remises_lignes) {
        case 0:
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>110,"PU"=>20,"Montant"=>20);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Montant"=>"R");
          $fonts=array( "Code"=>array("FreeSerif","B","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","","9"),"PU"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"));
					$fonts_acteur=array( "Code"=>array("FreeSerif","I","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","I","9"),"PU"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"));
          $type=array("Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Montant"=>"Texte");
          break;
        default:
          //  Attention largeur minimum 6 ???? !!!! pour taxe ????
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>90,"PU"=>20,"Remise"=>20,"Montant"=>20);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Remise"=>"R","Montant"=>"R");
          $fonts=array( "Code"=>array("FreeSerif","B","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","","9"),"PU"=>array("FreeSerif","","9"),"Remise"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"));
          $fonts_acteur=array( "Code"=>array("FreeSerif","I","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","I","9"),"PU"=>array("FreeSerif","","9"),"Remise"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"));
          $type=array( "Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Remise"=>"Texte","Montant"=>"Texte");
        break;
      }
      break;
    default:
      switch ($nb_remises_lignes) {
        case 0:
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>104,"PU"=>20,"Montant"=>20,"T"=>6);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Montant"=>"R","T"=>"C");
          $fonts=array( "Code"=>array("FreeSerif","B","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","","9"),"PU"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"),"T"=>array("FreeSerif","","9"));
          $fonts_acteur=array( "Code"=>array("FreeSerif","I","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","I","9"),"PU"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"),"T"=>array("FreeSerif","","9"));
          $type=array("Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Montant"=>"Texte","T"=>"Texte");
          break;
        default:
          //  Attention largeur minimum 6 ???? !!!! pour taxe ????
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>84,"PU"=>20,"Remise"=>20,"Montant"=>20,"T"=>6);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Remise"=>"R","Montant"=>"R","T"=>"R");
          $fonts=array( "Code"=>array("FreeSerif","B","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","","9"),"PU"=>array("FreeSerif","","9"),"Remise"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"),"T"=>array("FreeSerif","","9"));
          $fonts_acteur=array( "Code"=>array("FreeSerif","I","9"),"Quantité"=>array("FreeSerif","B","9"),"Désignation"=>array("FreeSerif","I","9"),"PU"=>array("FreeSerif","","9"),"Remise"=>array("FreeSerif","","9"),"Montant"=>array("FreeSerif","","9"),"T"=>array("FreeSerif","","9"));
          $type=array( "Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Remise"=>"Texte","Montant"=>"Texte","T"=>"Texte");
        break;
      }
    break;
  }


	$pdf->impression_cgv="false";
  $pdf->AddPage();
  /*
   * Impression du corps de la page : modele 5 sur 2 lignes éventuellement
   * 1° ligne Code et désignation fournisseur
   * 2° ligne Code Quantité, Désignation,PU,Remise(le cas écheant), montant, code taxe (le cas échéant)
   */ 
	 
	include('_graal_bloc_code_docciaux_impression_corpus_doc_05.php');
    //  Fin de document
  include("_graal_bloc_code_docciaux_impression_pied_doc_01.php");
	fa_fin_creation_demfou();
}
?>
