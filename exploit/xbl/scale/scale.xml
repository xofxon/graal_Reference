<?xml version="1.0"?>
<bindings xmlns="http://www.mozilla.org/xbl"
	xmlns:xbl="http://www.mozilla.org/xbl"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
	<binding id="scale" extends="xul:box">
		<content orient="horizontal" min="0" max="100" units="">
			<xul:box xbl:inherits="orient" flex="1">
				<children includes="cursor|spacer"/>
				<xul:image anonid="scale-resize" src=""/>
			</xul:box>
		</content>
		<implementation>
			<method name="init">
				<body><![CDATA[
					var cursors = this.cursors;
					var cursor = null, prev = null, spacer = null;
					for(var i=0; i<cursors.length; i++) {
						cursor = cursors[i];
						prev = cursor.previousSibling;
						if(prev==null||prev.nodeName!="spacer") {
							spacer = this.ownerDocument.createElement("spacer");
							this.insertBefore(spacer, cursor);
						}
					}
				]]></body>
			</method>
			<method name="majFlex">
				<parameter name="inc"/>
				<body><![CDATA[
					if(inc!=0) {
						this.resize.removeAttribute("collapsed");
						this.resize.setAttribute("src", "data:image/gif;base64,R0lGODlhAQABAJEAAAAAAP///////wAAACH5BAEAAAIALAAAAAABAAEAAAICVAEAOw==");
						var cursors = this.cursors;
						var min = 0;
						var spacer = null, cursor = null, prev = null, next = null;
						for(var i=0; i<cursors.length; i++) {
							cursor = cursors[i];
							if(inc>0) {
								prev = cursor.previousCursor;
								if(prev!=null&&prev.relativeFlex>cursor.relativeFlex) cursor.relativeFlex = prev.relativeFlex;
							} else {
								next = cursor.nextCursor;
								if(next!=null&&next.relativeFlex<cursor.relativeFlex) cursor.relativeFlex = next.relativeFlex;
							}
							cursor.previousSibling.flex = (cursor.relativeFlex - min);
							min = cursor.relativeFlex;
						}
						this.lastSpacer.flex = (this.max - (min + this.min));
						this.resize.removeAttribute("src");
						this.resize.setAttribute("collapsed", true);
					}
				]]></body>
			</method>
			<constructor><![CDATA[
				this.lastSpacer = this.ownerDocument.createElement("spacer");
				this.lastSpacer.setAttribute("flex", 0);
				this.appendChild(this.lastSpacer);
				if(this.getAttribute("values")!="") {
					this.values = this.getAttribute("values").split(",");
					this.setAttribute("min", 0);
					this.setAttribute("max", this.values.length-1);
				}
				this.init();
				this.majFlex(1);
			]]></constructor>
			<field name="selectedCursor">null</field>
			<field name="values">null</field>
			<field name="units"><![CDATA[this.getAttribute("units");]]></field>
			<field name="lastSpacer"><![CDATA[null]]></field>
			<field name="resize"><![CDATA[this.ownerDocument.getAnonymousElementByAttribute(this, "anonid", "scale-resize");]]></field>
			<property name="cursors" onget="return this.getElementsByTagName('cursor')"/>
			<property name="min" onget="return parseFloat(this.getAttribute('min'));"/>
			<property name="max" onget="return parseFloat(this.getAttribute('max'));"/>
		</implementation>
		<handlers>
			<handler event="click" button="0"><![CDATA[
				if(this.getAttribute("disabled")!="true") {
					if(this.cursors.length==1&&this.cursors[0].getAttribute("disabled")!="true") {
						this.selectedCursor=this.cursors[0];
						this.selectedCursor.focus();
					} 
					if(this.selectedCursor) {
						var elt = this.selectedCursor;
						var relFlex = elt._getNewRelativeFlex(event);
						var inc = relFlex - elt.relativeFlex;
						if(inc>0) {
							elt.relativeFlex = Math.ceil((elt.relativeFlex+relFlex)/2);
						} else if(inc<0) {
							elt.relativeFlex = Math.floor((elt.relativeFlex+relFlex)/2);
						}  
					}
				}
			]]></handler>
		</handlers>
	</binding>
	<binding id="cursor" extends="xul:image">
		<content index="0"/>
		<implementation>
			<constructor><![CDATA[
				this.relativeFlex = this.relativeFlex;
			]]></constructor>
			<property name="scale" onget="return this.parentNode;"/>
			<property name="reverse" onget="return this.getAttribute('dir')=='reverse' || this.getAttribute('dir')=='rtl';"/>
			<property name="values" onget="return this.scale.values;"/>
			<property name="units" onget="return this.scale.units;"/>
			<property name="min" onget="return this.scale.min;"/>
			<property name="max" onget="return this.scale.max;"/>
			<property name="relativeFlex">
				<getter><![CDATA[
					if(!this.reverse) return this.index - this.min;
					else return this.max - this.index;
				]]></getter>
				<setter><![CDATA[
					if(this.scale.getAttribute("disabled")!="true"&&this.getAttribute("disabled")!="true") {
						var old = this.relativeFlex;
						var inc = val-old;
						var cur = null;
						var min = 0; max = this.max - this.min;
						cur = this;
						if(inc>0) {
							while((cur = cur.nextCursor)!=null) {
								if(cur.getAttribute("disabled")=="true") {
									max = cur.relativeFlex;
									break;
								}
							}
						} else {
							while((cur = cur.previousCursor)!=null) {
								if(cur.getAttribute("disabled")=="true") {
									min = cur.relativeFlex;
									break;
								}
							}
						}
						if(val<min) val = min;
						else if(val>max) val = max;
					}
					if(!this.reverse) this.setAttribute("index", (val + this.min));
					else this.setAttribute("index", (this.max - val));

					if(this.values) {
						this.setAttribute("value", this.values[val]);
						this.setAttribute("tooltiptext", this.values[val]+this.units);
					} else {
						this.setAttribute("value", this.getAttribute("index"));
						this.setAttribute("tooltiptext", this.getAttribute("index")+this.units);
					}

					this.scale.majFlex(inc);
					if(inc!=0) {
						var evt = document.createEvent("Events");
						evt.initEvent("change", true, true);
						this.dispatchEvent(evt);
					}
				]]></setter>
			</property>
			<property name="value" onget="return this.getAttribute('value');">
				<setter><![CDATA[
					if(this.values) {
						this.index = this.values.indexOf(val);
					} else if(!isNaN(parseInt(val))) {
						this.index = parseInt(val);
					}
				]]></setter>
			</property>
			<property name="index">
				<getter><![CDATA[
					var ind = parseInt(this.getAttribute('index'));
					if(this.values) {
						if(this.value!="") {
							ind = this.values.indexOf(this.value);
						}
					} 
					return ind;
				]]></getter>
				<setter><![CDATA[
					if(val<this.min) val = this.min;
					else if(val>this.max) val = this.max;
					var old = this.index;
					var inc = val-old;
					if(this.values) {
						this.setAttribute("value", this.values[val]);
						this.setAttribute("tooltiptext", this.values[val]+this.units);
					} else {
						this.setAttribute("value", val);
						this.setAttribute("tooltiptext", val+this.units);
					}
					this.setAttribute("index", val);
					this.scale.majFlex(inc);
					if(inc!=0) {
						var evt = document.createEvent("Events");
						evt.initEvent("change", true, true);
						this.dispatchEvent(evt);
					}
				]]></setter>
			</property>
			<property name="nextCursor">
				<getter><![CDATA[
					var next = this.nextSibling.nextSibling;
					if(next!=null && next.nodeName=="cursor") return next;
					return null;
				]]></getter>
			</property>
			<property name="previousCursor">
				<getter><![CDATA[
					var prev = this.previousSibling.previousSibling;
					if(prev!=null && prev.nodeName=="cursor") return prev;
					return null;
				]]></getter>
			</property>
			<method name="_getNewRelativeFlex">
				<parameter name="event"/>
				<body><![CDATA[
					var find = false;
					var px = 0, w = 0, h = 0, wCursor = 0, hCursor = 0;
					var cursors = this.scale.cursors;
					var horiz = this.scale.getAttribute("orient")=="horizontal";
					var width = 0, delta = 0;
					if(horiz) {
						width = this.scale.boxObject.width;
						delta = (event.screenX - this.scale.boxObject.x - document.documentElement.boxObject.screenX);
					} else {
						width = this.scale.boxObject.height;
						delta = (event.screenY - this.scale.boxObject.y - document.documentElement.boxObject.screenY);
					}
					for(var i=0; i<cursors.length; i++) {
						wCursor = (horiz)?cursors[i].boxObject.width:cursors[i].boxObject.height; 
						find = find || (cursors[i] == this);
						if(!find) delta -= wCursor;
						w += wCursor;
					}
					px = (width-w)/(this.max-this.min);
					return Math.round(delta/px);
				]]></body>
			</method>
		</implementation>
		<handlers>
			<handler event="draggesture"><![CDATA[
				var elt = this;
				if(this.getAttribute("disabled")!="true") {
					document.addEventListener("mousemove", handleMove, false);
					document.addEventListener("mouseup", endMove, false);
					document.addEventListener("mouseover", outWindow, false);
				}
				function handleMove(event) {elt.relativeFlex = elt._getNewRelativeFlex(event);}
				function outWindow(event) {if(event.target.nodeName=="window") endMove(event);}
				function endMove(event) {
					document.removeEventListener("mousemove", handleMove, false);
					document.removeEventListener("mouseup", endMove, false);
					document.removeEventListener("mouseover", outWindow, false);
				}
			]]></handler>
			<handler event="keypress"><![CDATA[
				if(event.keyCode==40||event.keyCode==39) { // v, ->
					this.relativeFlex++;
				} else if(event.keyCode==38||event.keyCode==37) { // ^, <-
					this.relativeFlex--;
				} else if(event.keyCode==34||event.keyCode==35) { // A, End
					if(this.nextCursor==null||this.nextCursor.relativeFlex==this.relativeFlex) this.relativeFlex=this.max - this.min;
					else this.relativeFlex=this.nextCursor.relativeFlex;
				} else if(event.keyCode==33||event.keyCode==36) { // V, Home
					if(this.previousCursor==null||this.previousCursor.relativeFlex==this.relativeFlex) this.relativeFlex=0;
					else this.relativeFlex=this.previousCursor.relativeFlex;
				}
			]]></handler>
			<handler event="focus"><![CDATA[
				this.scale.selectedCursor = this;
				this.setAttribute("focused", true);
				this.scale.setAttribute("focused", true);
			]]></handler>
			<handler event="blur"><![CDATA[
				this.scale.selectedCursor = null; 
				this.removeAttribute("focused");
				this.scale.removeAttribute("focused");
			]]></handler>
			<handler event="click" button="0"><![CDATA[
				event.stopPropagation();
				event.preventDefault();
			]]></handler>
		</handlers>
	</binding>
</bindings>