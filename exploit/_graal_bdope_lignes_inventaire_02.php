<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_lignes_inventaire_01";
fa_acces_script();
define('EOL', "\r\n");
$vf_c_echo="";
$vl_tableau_cle=fa_recup_param("vl_tableau_cle","");
$vl_tableau_qte=fa_recup_param("vl_tableau_qte","");
$vl_tabqte = unserialize(stripslashes($vl_tableau_qte));
$vl_tabcle = unserialize(stripslashes($vl_tableau_cle));
$vl_inv_cleunik=intval(fa_recup_param("vl_inv_cleunik",""));
$vl_b_transaction_ok=true;
$vl_e_i=-1;
$trace="";
foreach($vl_tabcle as $vl_art_inventaire) {
  $vl_e_i++;
  $vl_art_cleunik=$vl_tabcle[$vl_e_i];
  $vl_qte_mvt=fa_floatval($vl_tabqte[$vl_e_i]);
  //  Mise à jour information ligne d'inventaire
  $sql_req="UPDATE _inventaire_lignes set qte_inven=$vl_qte_mvt,etat=2 where art_cleunik=$vl_art_cleunik and inv_cleunik=$vl_inv_cleunik;";
  $trace.=$sql_req.EOL;
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Maj derpa à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_art_achats,_article set pu_inv=der_pa,nbdec_pu=nbdec_prix where _article.art_cleunik=$vl_art_cleunik and _inventaire_lignes.art_cleunik=$vl_art_cleunik and _art_achats.art_cleunik=$vl_art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-1;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Prix de revient de fabrication à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_art_fabs set pu_inv=pr,nbdec_pu=nbdec_pr where _inventaire_lignes.art_cleunik=$vl_art_cleunik and _art_fabs.art_cleunik=$vl_art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-2;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Maj PAMP à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_art_achats,_article set pu_inv=pamp,nbdec_pu=nbdec_prix where _article.art_cleunik=$vl_art_cleunik and _inventaire_lignes.art_cleunik=$vl_art_cleunik and _art_achats.art_cleunik=$vl_art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-3;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Prix de revient générique à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_article set pu_inv=pr_generique,nbdec_pu=nbdec_prix where _article.art_cleunik=$vl_art_cleunik and _inventaire_lignes.art_cleunik=$vl_art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-5;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
}
//echo $trace;
if ($vl_b_transaction_ok==false) {echo 'La sauvegarde de l\'inventaire a échoué.'.$vl_c_mess_err;} else {echo 'La sauvegarde d\'inventaire a été correctement effectuée.';}
?>
