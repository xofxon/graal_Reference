<?php
//	Recherche nombre de tarifs sur quantité
$sql_req="select count(*) as nombre from _art_tarifs a2 where a2.actif=1 and a2.art_cleunik=$vl_c_art_cleunik and a2.type=$vl_c_type_tarifs and quantite_haute<>0;";
$sql_result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($sql_result);
$vl_e_nombre_quantites=$row['nombre'];
_graal_libere_requete_bd($sql_result);
if ($vl_e_nombre_quantites!=0){
	$vl_actif=1;
	$sql_req ="SELECT _acteurs.act_cleunik as act_cleunik,tar_cleunik,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference,";
	$sql_req.=" choix_code,choix_valeur_texte_01,nomcommercial,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,quantite_basse,quantite_haute ";
	$sql_req.=" FROM _article,_art_tarifs,_choix,_acteurs where choix_cleunik=tarif_cleunik and _art_tarifs.art_cleunik=$vl_c_art_cleunik and _article.art_cleunik=$vl_c_art_cleunik ";
	$sql_req.=" and _acteurs.act_cleunik=_art_tarifs.act_cleunik and type=$vl_c_type_tarifs";
	switch ($vl_actif) {
	  case 1 : $sql_req.= " and _art_tarifs.actif=1";break;
	  case 2 : $sql_req.= " and _art_tarifs.actif=2";break;
	  case 3 : break;
	}
	$sql_req.=" and _art_tarifs.act_cleunik=0";
	$sql_req.=" order by quantite_haute asc,choix_valeur_texte_01;";
	$result = _graal_requete_bd($sql_req);
	//die($sql_req);
	$script_quantite=<<<EOT
		var vl_ok=false;
EOT;
	while ($row = mysql_fetch_assoc($result)) {
		$borne_haute=fa_reel(fa_ent_xml($row['quantite_haute']),0);
		$pu=fa_ent_xml($row['pu_reference']);
		$script_quantite.="if ((fa_value_get('tb_qte')<=$borne_haute) &&(vl_ok==false)){fa_value_set('tb_pu','$pu');vl_ok=true;}";
	}
	_graal_libere_requete_bd($result);
	$script_quantite.=<<<EOT
		if (vl_ok==false){fa_value_set('tb_pu','$pu');vl_ok=true;}
		if (vl_ok==false){
			alert("Problème choix tarif !!");
		}
EOT;
} else {
	$script_quantite="";
}
?>