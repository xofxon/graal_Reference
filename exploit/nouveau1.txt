http://localhost/graal/exploit/_graal_pdf_cdecli_confirmation_01.php?vl_commercial_cleunik=20000039&vl_genre_adresse=2&raf=5http://localhost/graal/exploit/_graal_pdf_cdecli_confirmation_01.php?vl_commercial_cleunik=20000040&vl_genre_adresse=2&raf=5http://localhost/graal/exploit/_graal_pdf_cdecli_confirmation_01.php?vl_commercial_cleunik=10007262&vl_genre_adresse=2&raf=5http://localhost/graal/exploit/_ab_test_invoice_05.php?raf=1select * from _cdecli_entetes where action_cleunik=1003768310007262SELECT round(port_taux,2) as mo04,frais_taux as mo05,escompte_taux as mo07,escompte_type,acompte_taux as mo11,f1.catcompta_cleunik,f2.taxes_cleunik,f3.taux FROM _entete_cdecli f1 left join _param_categories_compta f2 using(catcompta_cleunik) left join _param_taxes f3 using(taxes_cleunik) where commercial_cleunik=20000040_vue_cdecli_ht_00SELECT * FROM _vue_cdecli_ht_00 f1 where commercial_cleunik=10007262SELECT * FROM _vue_cdecli_ht_01 f1 where commercial_cleunik=10007262select port_type,port_taux from _cdecli_entetes where commercial_cleunik=10007262select a1.commercial_cleunik AS commercial_cleunik,sum(((a3.qte * a1.pu) * a1.coef_facture)) AS htbrut,(case a1.remise_genr when 1 then (case a1.remise_taux when 0 then 0 else sum((((a3.qte * a1.pu) * a1.coef_facture) * (a1.remise_taux / 100))) end) else sum(a1.remise_taux) end) AS montantremise_ligne,(case a1.remise_genr when 1 then (case a1.remise_taux when 0 then sum(((a3.qte * a1.pu) * a1.coef_facture)) else sum((((a3.qte * a1.pu) * a1.coef_facture) - (((a3.qte * a1.pu) * a1.coef_facture) * (a1.remise_taux / 100)))) end) else sum((((a3.qte * a1.pu) * a1.coef_facture) - a1.remise_taux)) end) AS htbrutremise,count(0) AS nombredelignes,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik, from _cdecli_lignes a1 left join _cdecli_lignes_qte a3 using(commercial_ligne_cleunik) where a1.commercial_cleunik=10007262 group by a1.catcompta_cleunik,a1.pc_cleunik,a1.commercial_cleunik,a1.taxes_cleunikselect a1.commercial_cleunik AS commercial_cleunik,sum(a1.htbrutremise) AS htbrutremise,(case a3.remise_genr when 2 then (case a3.remise_taux when 0 then 0 else sum(((a1.htbrutremise * (a3.remise_taux / 100)) * (case a3.remise_natu when 1 then -(1) else 1 end))) end) else sum((a3.remise_taux*a1.nombredelignes)) end) AS montantremise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,a1.nombredelignes from _vue_cdecli_ht_00 a1 left join _cdecli_entetes a3 using(commercial_cleunik) where a1.commercial_cleunik=10007262 group by a1.catcompta_cleunik,a1.pc_cleunik,a1.taxes_cleunik,a1.commercial_cleunik,a1.nombredelignesselect f1.commercial_cleunik,(case f1.port_type when 1 then f1.port_taux else ,f1.port_taux,f1.catcompta_cleunik,f2.taxes_vente_port,f2.intitule as intitule_catcompta,f3.denomination as intitule_taxes from _cdecli_entetes f1 left join _param_categories_compta f2 using(catcompta_cleunik) left join _param_taxes f3 on f2.taxes_vente_port=f3.taxes_cleunik where f1.port_taux<>0;SELECT f1.commercial_cleunik,f1.htbrutremise,f1.montantremise_pied,f1.catcompta_cleunik,f1.pc_cleunik,f2.intitule as intitule_catcompta,f3.intitule as intitule_pc,f4.denomination as intitule_taxes,round((f4.taux*(f1.htbrutremise/100)),2) as montant_taxe,round(f1.htbrutremise+(f4.taux*(f1.htbrutremise/100)),2) as montant_ttc FROM _vue_cdecli_ht_01 f1 left join _param_categories_compta f2 using(catcompta_cleunik) left join _param_pc f3 using(pc_cleunik) left join _param_taxes f4 on f1.taxes_cleunik=f4.taxes_cleunik where commercial_cleunik=10007262 select f1.commercial_cleunik,(case f1.port_type when 1 then f1.port_taux else 0 end) as montant_port,f1.port_taux,f1.catcompta_cleunik,f2.taxes_vente_port,f2.intitule as intitule_catcompta,f3.denomination as intitule_taxes from _cdecli_entetes f1 left join _param_categories_compta f2 using(catcompta_cleunik) left join _param_taxes f3 on f2.taxes_vente_port=f3.taxes_cleunik where f1.commercial_cleunik=10007262drop view if exists _vue_cdecli_ht_01;drop view if exists _vue_cdecli_ht_00_inter;drop view if exists _vue_cdecli_ht_00;CREATE view `_vue_cdecli_ht_00` AS select a1.commercial_cleunik AS commercial_cleunik,sum(((a3.qte * a1.pu) * a1.coef_facture)) AS htbrut,(case a1.remise_genr when 1 then (case a1.remise_taux when 0 then 0 else sum((((a3.qte * a1.pu) * a1.coef_facture) * (a1.remise_taux / 100))) end) else sum(a1.remise_taux) end) AS montantremise_ligne,(case a1.remise_genr when 1 then (case a1.remise_taux when 0 then sum(((a3.qte * a1.pu) * a1.coef_facture)) else sum((((a3.qte * a1.pu) * a1.coef_facture) - (((a3.qte * a1.pu) * a1.coef_facture) * (a1.remise_taux / 100)))) end) else sum((((a3.qte * a1.pu) * a1.coef_facture) - a1.remise_taux)) end) AS htbrutremise,count(0) AS nombredelignes,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik from _cdecli_lignes a1 left join _cdecli_lignes_qte a3 using(commercial_ligne_cleunik) group by a1.catcompta_cleunik,a1.pc_cleunik,a1.commercial_cleunik,a1.taxes_cleunik;CREATE view `_vue_cdecli_ht_00_inter` AS select a1.commercial_cleunik AS commercial_cleunik,sum(a1.htbrutremise) as total_doc from _vue_cdecli_ht_00 a1 group by a1.commercial_cleunik;//  Requete pour remise genre=2 cad UNE SEULE remise sur le total -> il faut proratiser sur les différents HT (1 par taux de taxe)//  Requete pour remise genre=1 cad remise à la ligne -> on applique la remise ligne à ligne, en tenat compte des différents HT (1 par taux de taxe) //  Type 1 -> %//  Type 2 Montant select a1.commercial_cleunik AS commercial_cleunik,round(sum(a1.htbrutremise)*100/a2.total_doc,2) as pourcentage,round(a2.total_doc,2) as total_doc,round(sum(a1.htbrutremise),2) AS htbrutremise,(case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end) AS montantremise_pied,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,0 as nombredelignes,'Marchandises' as genre_ligne from _vue_cdecli_ht_00 a1 left join _vue_cdecli_ht_00_inter a2 using(commercial_cleunik) left join _cdecli_entetes a3 using(commercial_cleunik) where a1.commercial_cleunik=10007262 and a3.remise_genr=2 group by a1.catcompta_cleunik,a1.pc_cleunik,a1.taxes_cleunik,a1.commercial_cleunik,a2.total_docunion allselect a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,round(sum(a1.htbrutremise),2) AS htbrutremise,(case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end) AS montantremise_pied,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,a1.nombredelignes as nombredelignes,'Marchandises' as genre_ligne from _vue_cdecli_ht_00 a1 left join _vue_cdecli_ht_00_inter a2 using(commercial_cleunik) left join _cdecli_entetes a3 using(commercial_cleunik) where a1.commercial_cleunik=10007262 and a3.remise_genr=1 group by a1.catcompta_cleunik,a1.pc_cleunik,a1.taxes_cleunik,a1.commercial_cleunik,a1.nombredelignes,a2.total_doc;select a1.commercial_cleunik AS commercial_cleunik,round(sum(a1.htbrutremise)*100/a2.total_doc,2) as pourcentage,round(a2.total_doc,2) as total_doc,round(sum(a1.htbrutremise),2) AS htbrutremise,(case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end) AS montantremise_pied,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,a4.denomination,a4.taux,round(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*(a4.taux/100),2) AS montant_taxe,0 as nombredelignes,'Marchandises' as genre_ligne from _vue_cdecli_ht_00 a1 left join _vue_cdecli_ht_00_inter a2 using(commercial_cleunik) left join _cdecli_entetes a3 using(commercial_cleunik) left join _param_taxes a4 on a1.taxes_cleunik=a4.taxes_cleunik where a1.commercial_cleunik=10007262 and a3.remise_genr=2 group by a1.taxes_cleunik,a1.commercial_cleunik,a2.total_docunion allselect a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,round(sum(a1.htbrutremise),2) AS htbrutremise,(case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end) AS montantremise_pied,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,a4.denomination,a4.taux,round(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*(a4.taux/100),2) AS montant_taxe,a1.nombredelignes as nombredelignes,'Marchandises' as genre_ligne from _vue_cdecli_ht_00 a1 left join _vue_cdecli_ht_00_inter a2 using(commercial_cleunik) left join _cdecli_entetes a3 using(commercial_cleunik) left join _param_taxes a4 on a1.taxes_cleunik=a4.taxes_cleunik where a1.commercial_cleunik=10007262 and a3.remise_genr=1 group by a1.taxes_cleunik,a1.commercial_cleunik,a1.nombredelignes,a2.total_doc  union all select a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,0 AS htbrutremise,0 AS montantremise_pied,(case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(155.28*a1.port_taux/100,2) end) else round(a1.port_taux) end) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a2.compte_vente_port AS pc_cleunik,a2.taxes_vente_port AS taxes_cleunik,a4.denomination as denomination_taxe,round(a4.taux,2) as taux_taxe,round((case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(155.28*a1.port_taux/100,2) end) else round(a1.port_taux) end)*(a4.taux/100),2) as montant_taxe,0 as nombredelignes,"Port" as genre_ligne from _cdecli_entetes a1 left join _param_categories_compta a2 using (catcompta_cleunik) left join _param_taxes a4 on a2.taxes_vente_port=a4.taxes_cleunik where commercial_cleunik=10007262// Requête pour avoir le total marchandisesselectifnull((select round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS total_marchandises from _vue_cdecli_ht_00 a1 left join _vue_cdecli_ht_00_inter a2 using(commercial_cleunik) left join _cdecli_entetes a3 using(commercial_cleunik) where a1.commercial_cleunik=10007262 and a3.remise_genr=2),0)+ifnull((select round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as total_marchandises from _vue_cdecli_ht_00 a1 left join _vue_cdecli_ht_00_inter a2 using(commercial_cleunik) left join _cdecli_entetes a3 using(commercial_cleunik) where a1.commercial_cleunik=10007262 and a3.remise_genr=1),0) as total_marchandises;// Requête calcul du portselect a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,0 AS htbrutremise,0 AS montantremise_pied,(case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(155.28*a1.port_taux/100,2) end) else round(a1.port_taux) end) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a2.compte_vente_port AS pc_cleunik,a2.taxes_vente_port AS taxes_cleunik,a4.denomination as denomination_taxe,round(a4.taux,2) as taux_taxe,round((case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(155.28*a1.port_taux/100,2) end) else round(a1.port_taux) end)*(a4.taux/100),2) as montant_taxe,0 as nombredelignes,"Port" as genre_ligne from _cdecli_entetes a1 left join _param_categories_compta a2 using (catcompta_cleunik) left join _param_taxes a4 on a2.taxes_vente_port=a4.taxes_cleunik where commercial_cleunik=10007262select "Port" as genre_ligne,a4.denomination,a4.taux,((case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(155.28*a1.port_taux/100,2) end) else round(a1.port_taux) end)) as port from _cdecli_entetes a1 left join _param_categories_compta a2 using (catcompta_cleunik) left join _param_taxes a4 on a2.taxes_vente_port=a4.taxes_cleunik where commercial_cleunik=10007262// Requête calcul des fraisselect ((case a1.frais_type when 1 then (case a1.frais_taux when 0 then 0 else round(sum(155.28*a1.frais_taux/100),2) end) else round(a1.frais_taux) end)) as frais from _cdecli_entetes a1 where commercial_cleunik=10007262