<?php
<?php
//header('Content-type: text/plain; charset=utf-8');
include("_graal_fonctions_diverses.php");
include("_graal_fonctions_mysql_emailing.php");
define('EOL', "\r\n");
session_start();
$redire_defaut="http://xsoftware.fr/img/html/fond_header.png";
$param=fa_recup_param('p01',$redire_defaut);
//die($param);
if ($param=="$redire_defaut"){"Location: $redire_defaut";}
//$argument=explode("|",base64_decode($param));
$argument=explode("!",$param);
$vl_e_intweb_cleunik=intval($argument[1]);
$vl_c_action_uuid=$argument[2];
$vl_e_redire=$argument[3];
$vl_e_refweb=$argument[4];
//  Recherche courriel
$sql_req="SELECT count(*) as nombre FROM _act_interlo_mail where intweb_cleunik=$vl_e_intweb_cleunik and refweb='$vl_e_refweb';";
$result=_graal_requete_bd($sql_req);
if($result === false) {header("Location: $redire_defaut");}
$row = mysql_fetch_assoc($result);
$vl_e_nombre=$row['nombre'];
_graal_libere_requete_bd($result);
/*
echo $param.EOL;
echo $vl_e_intweb_cleunik.EOL;
echo $vl_c_action_uuid.EOL;
echo $vl_e_refweb.EOL;
echo $vl_e_redire.EOL;
echo $vl_e_nombre.EOL;
*/
if($vl_e_nombre === 0) {
	//echo "Pas trouvé refweb dans base".EOL;
	header("Location: $redire_defaut");
}
$sql_req="SELECT nbclic,action_cleunik FROM _emailing_trackin where intweb=$vl_e_intweb_cleunik and c_uuid='$vl_c_action_uuid';";
//echo $sql_req.EOL;
$result=_graal_requete_bd($sql_req);
if (mysql_num_rows($result)!= 0) {
	$row = mysql_fetch_assoc($result);
	$vl_e_nbclic=$row['nbclic'];
	$vl_action_cleunik_liee=$row['action_cleunik'];
	//echo $vl_e_nbclic.EOL;
	//echo $vl_action_cleunik_liee.EOL;
	_graal_libere_requete_bd($result);
	$votreip=fa_ent_xml($_SERVER["REMOTE_ADDR"]);
	$votrehost=fa_ent_xml(gethostbyaddr($_SERVER["REMOTE_ADDR"]));
	$sql_req="UPDATE _emailing_trackin SET nbclic=nbclic+1,dateheureclic=now(),ipclic='$votreip' where intweb=$vl_e_intweb_cleunik and c_uuid='$vl_c_action_uuid';";
	//echo $sql_req.EOL;
	$result=_graal_requete_bd($sql_req);
	if (intval($vl_e_nbclic)===0){
	//if (0===0)
		//	Première fois
		//  Récupération des interlocuteurs rattachés à cette adresse
	  //echo "Premier clic".EOL;
	  $tab_int_cleunik=array();$tab_act_cleunik=array();$nombre_interlo=0;
		$sql_req="SELECT a1.int_cleunik,a2.act_cleunik FROM _act_interlo_mail a1 left join _acteurs a2 using(act_cleunik) where refweb='$vl_e_refweb';";
	  $result = _graal_requete_bd($sql_req);
	  while ($row = mysql_fetch_assoc($result)) {
	    array_push($tab_int_cleunik,$row['int_cleunik']);
	    array_push($tab_act_cleunik,$row['act_cleunik']);
	    $nombre_interlo++;
	  }
	  _graal_libere_requete_bd($result);
	  //  
	  //  On cree l'action
	  $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
	  $sujet="Connexion suite emailing";
	  $description="";
		$description.="Adresse de courriel emailing $vl_e_refweb".EOL;
		$description.="Adresse IP : $votreip".EOL;
		$description.="Host : $votrehost".EOL;
		$description.="Page de destination : $vl_e_redire";
		$description=$description;
	  $statut=-23;  //  En cours
	  $sql_req="INSERT INTO _actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurecreation,sujet,c_uuid,statut,description) VALUES ($vl_action_cleunik,-110132,now(),now(),'$sujet',(select uuid()),$statut,'$description');";
	  $result = _graal_requete_bd($sql_req);
	  for ($i=0;$i<$nombre_interlo;$i++){
	    $sql_req="INSERT INTO _graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ($tab_act_cleunik[$i],$tab_int_cleunik[$i],$vl_action_cleunik,-110429,4096,2);";
	    $result = _graal_requete_bd($sql_req);
	  }
	  $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_liee,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-145,choix_cleunik_gauche=-144;";
	  $result = _graal_requete_bd($sql_req);
	}
}
if (trim($vl_e_redire)==""){
	//echo "redirection par défaut vers $redire_defaut".EOL;
	header("Location: http://xsoftware.fr/img/html/fond_header.png");
} else {
	//echo "redirection vers $vl_e_redire".EOL;
	header("Location: http://xsoftware.fr/img/html/fond_header.png");
}
?>

?> 