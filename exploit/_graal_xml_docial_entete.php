<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$genreaction=fa_recup_param("genreaction","??");
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik",-1));
session_write_close();
switch ($genreaction){
  case "offcli":
  case "livcli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "retcli":
  case "retfou":
  case "relfou":
    $fichier="_".$genreaction."_entetes";
    $fichier_01="_".$genreaction."_lignes";
    $fichier_02="_".$genreaction."_lignes_qte";
		$sql_req="SELECT a1.action_cleunik,a1.commercial_cleunik,code,"._graalsql_date('a1.dateheurecreation')." as datecreation,"._graalsql_time('a1.dateheurecreation')." as heurecreation,";
		$sql_req.=_graalsql_date('a1.dateheuremodif')." as datemodif,"._graalsql_time('a1.dateheuremodif')." as heuremodif,act_cleunik,blocnotebrut_entete,reference_acteur,";
		$sql_req.=" a1.devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,reg_cleunik,blocnotebrut_pied,";
		$sql_req.=" rendezvous,modliv,typpor,dateheureexpedition,dateheurelivraison,date(a1.dateheureexpedition) as dateexp,"._graalsql_time('dateheureexpedition')." as heureexp,";
		$sql_req.=" date(a1.dateheurelivraison) as dateliv,"._graalsql_time('a1.dateheurelivraison')." as heureliv,a2.nomcommercial,a1.frais_type as frais_type,";
		$sql_req.=" a1.frais_taux as frais_taux,a1.port_type as port_type,a1.port_taux as port_taux,a1.acompte_type as acompte_type,a1.acompte_taux as acompte_taux,a1.modliv_bis,";
		$sql_req.=" a1.assujetti_tpf from $fichier a1 left join _acteurs a2 using(act_cleunik) where a1.commercial_cleunik=$vl_commercial_cleunik";
    break;
  case "cdecli":
    $fichier="_".$genreaction."_entetes";
    $fichier_01="_".$genreaction."_lignes";
    $fichier_02="_".$genreaction."_lignes_qte";
		$sql_req="SELECT date(a3.date_echeance) as date_echeance,a1.action_cleunik,a1.commercial_cleunik,code,"._graalsql_date('a1.dateheurecreation')." as datecreation,"._graalsql_time('a1.dateheurecreation')." as heurecreation,";
		$sql_req.=_graalsql_date('a1.dateheuremodif')." as datemodif,"._graalsql_time('a1.dateheuremodif')." as heuremodif,act_cleunik,blocnotebrut_entete,reference_acteur,";
		$sql_req.=" a1.devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,reg_cleunik,blocnotebrut_pied,";
		$sql_req.=" rendezvous,modliv,typpor,dateheureexpedition,dateheurelivraison,date(a1.dateheureexpedition) as dateexp,"._graalsql_time('dateheureexpedition')." as heureexp,";
		$sql_req.=" date(a1.dateheurelivraison) as dateliv,"._graalsql_time('a1.dateheurelivraison')." as heureliv,a2.nomcommercial,a1.frais_type as frais_type,";
		$sql_req.=" a1.frais_taux as frais_taux,a1.port_type as port_type,a1.port_taux as port_taux,a1.acompte_type as acompte_type,a1.acompte_taux as acompte_taux,a1.modliv_bis,";
		$sql_req.=" a1.assujetti_tpf from $fichier a1 left join _acteurs a2 using(act_cleunik) left join _echeancier a3 on a1.action_cleunik=a3.action_cleunik ";
		$sql_req.=" where a1.commercial_cleunik=$vl_commercial_cleunik";
    break;
  case "faccli":
  case "facfou":
    $fichier="_".$genreaction."_entetes";
    $fichier_01="_".$genreaction."_lignes";
    $fichier_02="_".$genreaction."_lignes_qte";
	$sql_req="SELECT date(a3.date_echeance) as date_echeance,date(a1.date_fact) as datedoc,a1.action_cleunik,a1.commercial_cleunik,code,"._graalsql_date('a1.dateheurecreation')." as datecreation,";
	$sql_req.=_graalsql_time('a1.dateheurecreation')." as heurecreation,"._graalsql_date('a1.dateheuremodif')." as datemodif,"._graalsql_time('a1.dateheuremodif')." as heuremodif,";
	$sql_req.=" act_cleunik,blocnotebrut_entete,reference_acteur,a1.devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,";
	$sql_req.=" reg_cleunik,blocnotebrut_pied,rendezvous,modliv,typpor,dateheureexpedition,dateheurelivraison,date(a1.dateheureexpedition) as ";
	$sql_req.=" dateexp,"._graalsql_time('dateheureexpedition')." as heureexp,date(a1.dateheurelivraison) as dateliv,"._graalsql_time('a1.dateheurelivraison')." as heureliv,";
	$sql_req.=" a2.nomcommercial,a1.frais_type as frais_type,a1.frais_taux as frais_taux,a1.port_type as port_type,a1.port_taux as port_taux,a1.acompte_type as acompte_type,";
	$sql_req.=" a1.acompte_taux as acompte_taux,a1.modliv_bis,a1.assujetti_tpf from $fichier a1 left join _acteurs a2 using(act_cleunik) left join _echeancier a3 on a1.action_cleunik=a3.action_cleunik ";
	$sql_req.=" where a1.commercial_cleunik=$vl_commercial_cleunik";
    break;		
  case "avocli":
  case "avofin":
    $fichier="_avocli_entetes";
    $fichier_01="_avocli_lignes";
    $fichier_02="_avocli_lignes_qte";
    $sql_req="SELECT date(a3.date_echeance) as date_echeance,date(a1.date_avoi) as datedoc,a1.action_cleunik,a1.commercial_cleunik,code,"._graalsql_date('a1.dateheurecreation')." as datecreation,";
    $sql_req.=_graalsql_time('a1.dateheurecreation')." as heurecreation,"._graalsql_date('a1.dateheuremodif')." as datemodif,"._graalsql_time('a1.dateheuremodif')." as heuremodif,";
    $sql_req.=" act_cleunik,blocnotebrut_entete,reference_acteur,a1.devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,";
    $sql_req.=" reg_cleunik,blocnotebrut_pied,rendezvous,modliv,typpor,dateheureexpedition,dateheurelivraison,date(a1.dateheureexpedition) as ";
    $sql_req.=" dateexp,"._graalsql_time('dateheureexpedition')." as heureexp,date(a1.dateheurelivraison) as dateliv,"._graalsql_time('a1.dateheurelivraison')." as heureliv,";
    $sql_req.=" a2.nomcommercial,a1.frais_type as frais_type,a1.frais_taux as frais_taux,a1.port_type as port_type,a1.port_taux as port_taux,a1.acompte_type as acompte_type,";
    $sql_req.=" a1.acompte_taux as acompte_taux,type_avoir,a1.modliv_bis,a1.assujetti_tpf from $fichier a1 left join _acteurs a2 using(act_cleunik) left join _echeancier a3 on a1.action_cleunik=a3.action_cleunik ";
    $sql_req.=" where a1.commercial_cleunik=$vl_commercial_cleunik";
		break;
  case "avofou":
  case "avofif":
    $fichier="_avofou_entetes";
    $fichier_01="_avofou_lignes";
    $fichier_02="_avofou_lignes_qte";
    $sql_req="SELECT date(a3.date_echeance) as date_echeance,date(a1.date_avoi) as datedoc,a1.action_cleunik,a1.commercial_cleunik,code,"._graalsql_date('a1.dateheurecreation')." as datecreation,";
    $sql_req.=_graalsql_time('a1.dateheurecreation')." as heurecreation,"._graalsql_date('a1.dateheuremodif')." as datemodif,"._graalsql_time('a1.dateheuremodif')." as heuremodif,";
    $sql_req.=" act_cleunik,blocnotebrut_entete,reference_acteur,a1.devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,";
    $sql_req.=" reg_cleunik,blocnotebrut_pied,rendezvous,modliv,typpor,dateheureexpedition,dateheurelivraison,date(a1.dateheureexpedition) as ";
    $sql_req.=" dateexp,"._graalsql_time('dateheureexpedition')." as heureexp,date(a1.dateheurelivraison) as dateliv,"._graalsql_time('a1.dateheurelivraison')." as heureliv,";
    $sql_req.=" a2.nomcommercial,a1.frais_type as frais_type,a1.frais_taux as frais_taux,a1.port_type as port_type,a1.port_taux as port_taux,a1.acompte_type as acompte_type,";
    $sql_req.=" a1.acompte_taux as acompte_taux,type_avoir,a1.modliv_bis,a1.assujetti_tpf from $fichier a1 left join _acteurs a2 using(act_cleunik) left join _echeancier a3 on a1.action_cleunik=a3.action_cleunik ";
    $sql_req.=" where a1.commercial_cleunik=$vl_commercial_cleunik";
		break;
  default:
    $fichier="foireux";
    break;  //  Toutes les actions génériques
}
//  Recherche des entêtes
$sql_req_01="select sum(a3.qte * a1.poidsbrut) AS poidsbrut,sum(a3.qte * a1.poidsnet) AS poidsnet,sum(a3.qte_condi) AS qte_condi from $fichier_01 a1 left join $fichier_02 a3 ";
$sql_req_01.=" using (commercial_ligne_cleunik) where a1.commercial_cleunik=$vl_commercial_cleunik group by a1.commercial_cleunik;";
$result = _graal_requete_bd($sql_req);
$result_01 = _graal_requete_bd($sql_req_01);
echo fa_xcree_entete_xml();
$row = mysql_fetch_assoc($result);
$row_01 = mysql_fetch_assoc($result_01);
//echo $sql_req;
echo('<Description>');
$action_cleunik=$row['action_cleunik'];
// parseType = indication pour le type des données, utile pour le tri sur la colonne
//echo('<req data="'.fa_ent_xml($sql_req).'"/>');
echo('<action_cleunik data="'.fa_ent_xml($action_cleunik).'"/>');
echo('<commercial_cleunik data="'.fa_ent_xml($row['commercial_cleunik']).'"/>');
echo('<code data="'.fa_ent_xml($row['code']).'"/>');
echo('<datecreation data="'.fa_ent_xml($row['datecreation']).'"/>');
echo('<heurecreation data="'.fa_ent_xml($row['heurecreation']).'"/>');
echo('<datemodif data="'.fa_ent_xml($row['datemodif']).'"/>');
echo('<heuremodif data="'.fa_ent_xml($row['heuremodif']).'"/>');
echo('<act_cleunik data="'.fa_ent_xml($row['act_cleunik']).'"/>');
echo('<blocnotebrut_entete data="'.fa_ent_xml($row['blocnotebrut_entete']).'"/>');
echo('<reference_acteur data="'.fa_ent_xml($row['reference_acteur']).'"/>');
echo('<devise data="'.fa_ent_xml($row['devise']).'"/>');
echo('<tarif_cleunik data="'.fa_ent_xml($row['tarif_cleunik']).'"/>');
echo('<remise_taux data="'.fa_ent_xml($row['remise_taux']).'"/>');
echo('<remise_type data="'.fa_ent_xml($row['remise_type']).'"/>');
echo('<remise_genr data="'.fa_ent_xml($row['remise_genr']).'"/>');
echo('<escompte_taux data="'.fa_ent_xml($row['escompte_taux']).'"/>');
echo('<escompte_type data="'.fa_ent_xml($row['escompte_type']).'"/>');
echo('<remise_natu data="'.fa_ent_xml($row['remise_natu']).'"/>');
echo('<catcompta_cleunik data="'.fa_ent_xml($row['catcompta_cleunik']).'"/>');
echo('<reg_cleunik data="'.fa_ent_xml($row['reg_cleunik']).'"/>');
echo('<blocnotebrut_pied data="'.fa_ent_xml($row['blocnotebrut_pied']).'"/>');
echo('<rendezvous data="'.fa_ent_xml($row['rendezvous']).'"/>');
echo('<modliv data="'.fa_ent_xml($row['modliv']).'"/>');
echo('<modliv_bis data="'.fa_ent_xml($row['modliv_bis']).'"/>');
echo('<typpor data="'.fa_ent_xml($row['typpor']).'"/>');
echo('<dateheureexpedition data="'.fa_ent_xml($row['dateheureexpedition']).'"/>');
echo('<dateexpedition data="'.fa_ent_xml($row['dateexp']).'"/>');
echo('<heureexpedition data="'.fa_ent_xml($row['heureexp']).'"/>');
echo('<dateheurelivraison data="'.fa_ent_xml($row['dateheurelivraison']).'"/>');
echo('<datelivraison data="'.fa_ent_xml($row['dateliv']).'"/>');
echo('<heurelivraison data="'.fa_ent_xml($row['heureliv']).'"/>');
echo('<nomcommercial data="'.fa_ent_xml($row['nomcommercial']).'"/>');
echo('<frais_type data="'.fa_ent_xml($row['frais_type']).'"/>');
echo('<frais_taux data="'.fa_ent_xml($row['frais_taux']).'"/>');
echo('<port_type data="'.fa_ent_xml($row['port_type']).'"/>');
echo('<port_taux data="'.fa_ent_xml($row['port_taux']).'"/>');
echo('<acompte_type data="'.fa_ent_xml($row['acompte_type']).'"/>');
echo('<acompte_taux data="'.fa_ent_xml($row['acompte_taux']).'"/>');
echo('<type_avoir data="'.fa_ent_xml($row['type_avoir']).'"/>');
echo('<datedoc data="'.fa_ent_xml($row['datedoc']).'"/>');
echo('<date_echeance data="'.fa_ent_xml($row['date_echeance']).'"/>');
echo('<assujetti_tpf data="'.fa_ent_xml($row['assujetti_tpf']).'"/>');

echo('<poidsbrut data="'.fa_ent_xml($row_01['poidsbrut']).'"/>');
echo('<poidsnet data="'.fa_ent_xml($row_01['poidsnet']).'"/>');
echo('<qte_condi data="'.fa_ent_xml($row_01['qte_condi']).'"/>');
switch ($genreaction){
  case "offcli":
    echo('<int_privilegie_offcli data="'.pf_cherche_graal(-110419,$action_cleunik).'"/>');
    echo('<int_privilegie_cdecli data="'.pf_cherche_graal(-110420,$action_cleunik).'"/>');
    echo('<int_privilegie_livcli data="'.pf_cherche_graal(-110421,$action_cleunik).'"/>');
    echo('<int_privilegie_faccli data="'.pf_cherche_graal(-110422,$action_cleunik).'"/>');
    break;
  case "cdecli":
  case "livcli":
  case "faccli":
  case "avocli":
  case "avofin":
  case "retcli":
    echo('<int_privilegie_cdecli data="'.pf_cherche_graal(-110420,$action_cleunik).'"/>');
    echo('<int_privilegie_livcli data="'.pf_cherche_graal(-110421,$action_cleunik).'"/>');
    echo('<int_privilegie_faccli data="'.pf_cherche_graal(-110422,$action_cleunik).'"/>');
    echo('<int_privilegie_retcli data="'.pf_cherche_graal(-110440,$action_cleunik).'"/>');
    break;
  case "demfou":
    echo('<int_privilegie_demfou data="'.pf_cherche_graal(-110423,$action_cleunik).'"/>');
    echo('<int_privilegie_cdefou data="'.pf_cherche_graal(-110424,$action_cleunik).'"/>');
    echo('<int_privilegie_recfou data="'.pf_cherche_graal(-110425,$action_cleunik).'"/>');
    echo('<int_privilegie_facfou data="'.pf_cherche_graal(-110426,$action_cleunik).'"/>');
    break;
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retfou":
  case "relfou":
  case "avofou":
  case "avofif":
    echo('<int_privilegie_cdefou data="'.pf_cherche_graal(-110424,$action_cleunik).'"/>');
    echo('<int_privilegie_recfou data="'.pf_cherche_graal(-110425,$action_cleunik).'"/>');
    echo('<int_privilegie_facfou data="'.pf_cherche_graal(-110426,$action_cleunik).'"/>');
    echo('<int_privilegie_retfou data="'.pf_cherche_graal(-110441,$action_cleunik).'"/>');
    echo('<int_privilegie_relfou data="'.pf_cherche_graal(-110442,$action_cleunik).'"/>');
    break;
  default:
    $fichier="foireux";
    break;  //  Toutes les actions génériques
}
switch ($genreaction){
  case "offcli":
    echo('<int_privilegie_offcli_cleunik data="'.pf_cherche_graal_cleunik(-110419,$action_cleunik).'"/>');
    echo('<int_privilegie_cdecli_cleunik data="'.pf_cherche_graal_cleunik(-110420,$action_cleunik).'"/>');
    echo('<int_privilegie_livcli_cleunik data="'.pf_cherche_graal_cleunik(-110421,$action_cleunik).'"/>');
    echo('<int_privilegie_faccli_cleunik data="'.pf_cherche_graal_cleunik(-110422,$action_cleunik).'"/>');
    break;
  case "cdecli":
  case "livcli":
  case "faccli":
  case "avocli":
  case "avofin":
  case "retcli":
    echo('<int_privilegie_cdecli_cleunik data="'.pf_cherche_graal_cleunik(-110420,$action_cleunik).'"/>');
    echo('<int_privilegie_livcli_cleunik data="'.pf_cherche_graal_cleunik(-110421,$action_cleunik).'"/>');
    echo('<int_privilegie_faccli_cleunik data="'.pf_cherche_graal_cleunik(-110422,$action_cleunik).'"/>');
    echo('<int_privilegie_retcli_cleunik data="'.pf_cherche_graal_cleunik(-110440,$action_cleunik).'"/>');
    break;
  case "demfou":
    echo('<int_privilegie_demfou_cleunik data="'.pf_cherche_graal_cleunik(-110423,$action_cleunik).'"/>');
    echo('<int_privilegie_cdefou_cleunik data="'.pf_cherche_graal_cleunik(-110424,$action_cleunik).'"/>');
    echo('<int_privilegie_recfou_cleunik data="'.pf_cherche_graal_cleunik(-110425,$action_cleunik).'"/>');
    echo('<int_privilegie_facfou_cleunik data="'.pf_cherche_graal_cleunik(-110426,$action_cleunik).'"/>');
    break;
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retfou":
  case "relfou":
  case "avofou":
  case "avofif":
    echo('<int_privilegie_cdefou_cleunik data="'.pf_cherche_graal_cleunik(-110424,$action_cleunik).'"/>');
    echo('<int_privilegie_recfou_cleunik data="'.pf_cherche_graal_cleunik(-110425,$action_cleunik).'"/>');
    echo('<int_privilegie_facfou_cleunik data="'.pf_cherche_graal_cleunik(-110426,$action_cleunik).'"/>');
    echo('<int_privilegie_retfou_cleunik data="'.pf_cherche_graal_cleunik(-110441,$action_cleunik).'"/>');
    echo('<int_privilegie_relfou_cleunik data="'.pf_cherche_graal_cleunik(-110442,$action_cleunik).'"/>');
    break;
  default:
    $fichier="foireux";
    break;  //  Toutes les actions génériques
}
echo('</Description>');
_graal_libere_requete_bd($result);
_graal_libere_requete_bd($result_01);
_graal_ferme_connexion();
function pf_cherche_graal($vv_choix_cleunik,$vv_action_cleunik) {
  $sql_req="SELECT concat_ws(' ',a2.prenom,a2.patronyme) as qui,a1.principal FROM _graal a1 left join _act_interlo a2 using(int_cleunik) where a1.action_cleunik=$vv_action_cleunik and a1.choix_cleunik=$vv_choix_cleunik;";
  $result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($result) == 0) {
    $qui="Personne";
  } else {
    $row = mysql_fetch_assoc($result);
    $qui=fa_ent_xml($row['qui']);
  }
  _graal_libere_requete_bd($result);
  return $qui;
}
function pf_cherche_graal_cleunik($vv_choix_cleunik,$vv_action_cleunik) {
  $sql_req="SELECT  int_cleunik FROM _graal where action_cleunik=$vv_action_cleunik and choix_cleunik=$vv_choix_cleunik;";
  $result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($result) == 0) {
    $qui="-1";
  } else {
    $row = mysql_fetch_assoc($result);
    $qui=fa_ent_xml($row['int_cleunik']);
  }
  _graal_libere_requete_bd($result);
  return $qui;
}
?>
