<?php
include("_graal_header_pdf_02.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_numerotation.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
include("_graal_fonctions_documents.php");
include("_graal_fonctions_documents_ciaux.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik","0"));
$vl_e_action_cleunik=intval(fa_recup_param("vl_e_action_cleunik","0"));
$genre_adresse=intval(fa_recup_param("vl_genre_adresse","2"));  // 1-> adresse de livraison, 2 adresse de facturation 
$vl_c_fichier_seul=fa_recup_param("vl_c_fichier_seul","non");
if ($vl_commercial_cleunik==0) {fa_redirige("acces_interdit");}
if ($vl_commercial_cleunik==-2){
	$vl_action_cleunik_sourc=intval(fa_recup_param('vl_action_cleunik','0'));
	$req_action="select commercial_cleunik from _faccli_entetes where action_cleunik=$vl_e_action_cleunik;";
    $result = _graal_requete_bd($req_action);
    while ($row = mysql_fetch_assoc($result)){
      	$vl_commercial_cleunik=fa_nt($row['commercial_cleunik']);
    } 
}
$param_generaux_graal_010=intval(fa_recup_session('vs_param_generaux_graal_010',2)); //  1->mémoriser le pdf dans le fichier, 2->ne pas le mémoriser dans le fichier
$param_generaux_graal_023=intval(fa_recup_session('vs_param_generaux_graal_023',2)); //  Identifiant document CGV
$param_generaux_graal_026=intval(fa_recup_session('vs_param_generaux_graal_026',-1)); //  Mode d'édition des CGV (Conditions générales de vente)
$param_generaux_graal_057=intval(fa_recup_session('vs_param_generaux_graal_057',-1)); //  Logo sur la première page d'édition
$param_generaux_graal_058=intval(fa_recup_session('vs_param_generaux_graal_058',-1)); //  Logo sur les autres pages d'adition
$param_generaux_graal_075=intval(fa_recup_session('vs_param_generaux_graal_075',0)); //  Largeur logo première page
$param_generaux_graal_076=intval(fa_recup_session('vs_param_generaux_graal_076',0)); //  Hauteur logo première page
$param_generaux_graal_077=intval(fa_recup_session('vs_param_generaux_graal_077',0)); //  Largeur logo autres pages
$param_generaux_graal_078=intval(fa_recup_session('vs_param_generaux_graal_078',0)); //  Hauteur logo autres pages

$vl_c_fic_ligne="_avocli_lignes";
$vl_c_fic_qte="_avocli_lignes_qte";
$vl_c_fic_entete="_avocli_entetes";
$vl_e_fic_adresses="_avocli_adresses";

$vl_c_id_fenetre="Edi_00009";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_b_acces=$vl_tb_droits[0];
if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_dico_00058=fa_recup_dico("dico_00058");
$police_du_document="FreeSerif";	// Il faut intégrer la police : 819.5 Ko
$police_du_document="Courier";		//	Police non intégrée : 3.6 Ko
$police_du_document="times";		//	Police non intégrée : 3.5 Ko	Pas de différence visuelle avec FreeSerif
$genreaction="avocli";
$genreregroupement="initial";
include("_graal_req_docial_recap_montants.inc.php");
require_once('_graal_pdf_bloc_001.php');
define('EOL', "\r\n");
class pseudo extends _graal_TCPDF {
function Header() {}
}
class toto extends _graal_TCPDF {
// private variables
var $contenu_code;
var $contenu_nom_commercial;
var $contenu_dateexp;
var $contenu_code_bondepreparation;
var $impression_cgv;
function Header() {
  global $vl_commercial_cleunik;
  global $genre_adresse;
  global $action_cleunik;
  global $datecre;
  global $dateliv;
  global $codealphanum15;
  global $description_reg;
  global $vosreferences;
  global $blocnotebrut_entete;
  global $y;
  global $cols;
  global $format;
  global $nbligne_montant_pied;
  global $hauteur_blocnote_pied;
	global $raisonsoc;
	global $vl_e_fic_adresses;
	global $param_generaux_graal_057;
	global $param_generaux_graal_088;	
	global $param_generaux_graal_075;
	global $param_generaux_graal_076;
	global $param_generaux_graal_077;
	global $param_generaux_graal_078;
	global $date_echeance;
	
	$vl_c_bvj_101=fa_recup_dico_telquel("bvj_101");$vl_c_bvj_101="EPAC INTERNATIONAL";
	$vl_c_bvj_102=fa_recup_dico_telquel("bvj_102");$vl_c_bvj_102="92, avenue du général Leclerc";
	$vl_c_bvj_103=fa_recup_dico_telquel("bvj_103");$vl_c_bvj_103="92100 Boulogne Billancourt";
	$vl_c_bvj_104=fa_recup_dico_telquel("bvj_104");$vl_c_bvj_104="01.41.22.94.10";
	$vl_c_bvj_105=fa_recup_dico_telquel("bvj_105");$vl_c_bvj_105="01.73.62.97.48";
	$vl_c_bvj_106=fa_recup_dico_telquel("bvj_106");$vl_c_bvj_106="Site : www.epac-franchise.com";
	$vl_c_bvj_107=fa_recup_dico_telquel("bvj_107");$vl_c_bvj_107="TVA Intracom : FR 80 702 035 809 000 61";
	$vl_c_bvj_108=fa_recup_dico_telquel("bvj_108");$vl_c_bvj_101="EPAC INTERNATIONAL";
	$vl_c_bvj_109=fa_recup_dico_telquel("bvj_109");$vl_c_bvj_101="EPAC INTERNATIONAL";
	$vl_c_bvj_110=fa_recup_dico_telquel("bvj_110");$vl_c_bvj_101="EPAC INTERNATIONAL";
	
	$vl_c_bvj_111=fa_recup_dico_telquel("bvj_111");
	$vl_c_bvj_112=fa_recup_dico_telquel("bvj_112");
	$vl_c_bvj_113=fa_recup_dico_telquel("bvj_113");
	$vl_c_bvj_114=fa_recup_dico_telquel("bvj_114");
	$vl_c_bvj_115=fa_recup_dico_telquel("bvj_115");
	$vl_c_bvj_116=fa_recup_dico_telquel("bvj_116");
	$vl_c_bvj_117=fa_recup_dico_telquel("bvj_117");
	$vl_c_bvj_118=fa_recup_dico_telquel("bvj_118");
	$vl_c_bvj_122=fa_recup_dico_telquel("bvj_122");
	$vl_c_bvj_123=fa_recup_dico_telquel("bvj_123");
	
	
  switch ($this->getPage()) {
    case 1:
			$this->_graal_logo($param_generaux_graal_057,10,6,$param_generaux_graal_075,$param_generaux_graal_076);
			$this->SetFont($this->police_du_document, "B",11);
      $this->_graal_pdf_cadre_00($contenu="Avoir ".$this->contenu_code,$colonne=120,$ligne=10,$largeur=80,$hauteur=10,"1111","DF");
      $this->_graal_pdf_cadre_00("Page ".$this->getPage()."/{nombredepages}",$colonne=120,$ligne=20,$largeur=20,$hauteur=10,'0000');
      $this->_graal_pdf_cadre_00("Le $datecre",$colonne=140,$ligne=20,$largeur=27,$hauteur=10,'0000');
      $this->_graal_pdf_cadre_00("$codealphanum15",$colonne=167,$ligne=20,$largeur=33,$hauteur=10,'0000');
      $this->SetFont($this->police_du_document, "",10);
      //$this->_graal_pdf_cadre_02($description_reg." : le ".$date_echeance,$legende="Mode de règlement",$colonne=10,$ligne=80,$largeur=85,$hauteur=10,'0000',"C","L");
      //$this->_graal_pdf_cadre_01($this->contenu_dateexp,$legende="Date de départ",$colonne=95,$ligne=80,$largeur=25,$hauteur=10,'0011');
      //$this->_graal_pdf_cadre_01($dateliv,$legende="Livraison au plus tard",$colonne=120,$ligne=80,$largeur=35,$hauteur=10,'0011');
      
      $y=10;
		$this->SetXY(45,$y);$this->MultiCell(0, 4, $vl_c_bvj_101,0,'L');$y+=4;
		
		//die ("$vl_c_bvj_101");
		//exit();
		$this->SetXY(45,$y);$this->MultiCell(0, 4, $vl_c_bvj_102,0,'L');$y+=4;
		$this->SetXY(45,$y);$this->MultiCell(0, 4, $vl_c_bvj_103,0,'L');$y+=4;
		$this->Image('css/telephone.jpg', 45, $y, 4, 4);
		$this->SetXY(49,$y);$this->MultiCell(0, 4, $vl_c_bvj_104,0,'L');$y+=4;
		$this->Image('css/fax.jpg', 45, $y, 4, 4);
		$this->SetXY(49,$y);$this->MultiCell(0, 4, $vl_c_bvj_105,0,'L');$y+=4;
		
		$this->SetXY(45,$y);$this->MultiCell(0, 4, $vl_c_bvj_106,0,'L');$y+=4;
		$this->SetXY(45,$y);$this->MultiCell(0, 4, $vl_c_bvj_107,0,'L');$y+=4;
		//$this->Image('css/courriel.jpg', 85, $y, 4, 4);
		//$this->SetXY(89,$y);$this->MultiCell(0, 4, $vl_c_bvj_108,0,'L');$y+=4;
      
      
      if (trim($vosreferences)!="") {
        $this->_graal_pdf_cadre_02($vosreferences,$legende="Vos références",$colonne=155,$ligne=80,$largeur=45,$hauteur=10,'0011',"C","L");
      }
      
			$interlo_privilegie=-110422;
			//  Recherche interlocuteur privilégié d'offre, de commande, de livraison, de raception, de facture ... selon le document
			// Recherche adresse de livraison ou de facturation, selon $genre_adresse
			//  Impression du bloc note entête
			//  Entête du tableau
			include("_graal_bloc_code_docciaux_04.php");
      break;
    default:
			if ($this->impression_cgv=="false") {
				$this->_graal_logo($param_generaux_graal_087,10,6,$param_generaux_graal_077,$param_generaux_graal_078);
	      $this->SetFont($this->police_du_document, "B",11);
	      $this->_graal_pdf_cadre_00($contenu="Facture ".$this->contenu_code,$colonne=120,$ligne=10,$largeur=80,$hauteur=10,"1111","DF");
	      $this->_graal_pdf_cadre_00("Page ".$this->getPage()."/{nombredepages}",$colonne=120,$ligne=20,$largeur=20,$hauteur=10,'0000');
	      $this->_graal_pdf_cadre_00("Le $datecre",$colonne=140,$ligne=20,$largeur=27,$hauteur=10,'0000');
	      $this->_graal_pdf_cadre_00("$codealphanum15",$colonne=167,$ligne=20,$largeur=33,$hauteur=10,'0000');
	      //  Entête du tableau
	      $this->SetFont($this->police_du_document, "",9);
	      $y=$this->getY()+10;
	      $y=80;
	      if ($nbligne_montant_pied>2) {
	        $this->addCols_00( $cols,$xyz=array("10",$y,(30+(($nbligne_montant_pied-2)*5)+$hauteur_blocnote_pied)));
	      } else {
	        $this->addCols_00( $cols,$xyz=array("10",$y,30+$hauteur_blocnote_pied));
	      }
	      $this->addLineFormat_00($format,$cols);
	      $this->setY($y+10);
	      $y=$this->getY();
			} else {
				//	On imprime les conditions générales de vente
			}
      break;
  }
}
}
$sql_req="SELECT f1.blocnotebrut,f1.code_interne,f1.mnemotechnique_interne as z06,f1.description_interne,f4.qte,f4.qte_nbdec,f4.qte_unite as z10,f1.pu as pu,f1.pu_type as z12,f1.nbdec_pu,f1.remise_taux,f2.choix_valeur_texte_01 as z17,f3.choix_valeur_texte_01 as z18,f1.typeligne as z19,f1.coef_facture as coef_facture,f1.remise_genr,f1.remise_natu,f1.remise_type,$sql_htbrutremise,f5.code from _avocli_lignes f1,_choix f2,_choix f3,_avocli_lignes_qte f4,_param_taxes f5 WHERE commercial_cleunik=$vl_commercial_cleunik and f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f2.choix_cleunik = qte_unite and f3.choix_cleunik=statut and f5.taxes_cleunik=f1.taxes_cleunik order by f1.ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
if (mysql_num_rows($result)==0) {
  //  Rien à éditer
  $pdf = new _graal_TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pdf->_graal_pf_rai(); 
} else {
  //  Recherche informations entête
  //  Recherche du nombre de remises de lignes pour déterminer l'affichage ou non de la colonne  
  //  Recherche du nombre de taux de taxes différents pour déterminer l'affichage ou non de la colonne  
	include("_graal_bloc_code_docciaux_03.php");
	  //  Calcul du nombre de lignes de montants dans le pied
	include("_graal_bloc_code_docciaux_montants_pied_doc.php");
  $pseudo_pdf = new pseudo(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pseudo_pdf->Open();
  $pseudo_pdf->SetFont($police_du_document, "", 9);  //  Police utilisée pour les lignes
  if (trim($blocnotebrut_pied)!="") {
    $hauteur_blocnote_pied=round($pseudo_pdf->_graal_hauteur_00( $y=0, $blocnotebrut_pied,$x=10,$pos=2,array($police_du_document, "", 9)),0);
  } else {
    $hauteur_blocnote_pied=0;
  }
  //  S'il y a 2 lignes de montants, le pied peut commencer à 270
  $position_pied=270;
  if ($nbligne_montant_pied>2) {
    $position_pied=$position_pied-(($nbligne_montant_pied-2)*5);
  }
  $position_pied-=$hauteur_blocnote_pied;
  $pdf = new toto(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
  // set document information
  $pdf->SetCreator(PDF_CREATOR);
  //$pdf->SetProtection(array('print'));  //  On protège le document : seule l'impression est autorisée. 
  /*
   * le 27 août 2009 -> ne plus utiliser la protection, sinon on ne peut rien faire avec le document via le programme pdftk
   */
  //$pdf->setPrintHeader(false);
  $pdf->setPrintFooter(false);  //  Définir ce que l'on mettra dans le pied
  $pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
  //set auto page breaks
  //$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
  $pdf->SetAutoPageBreak(TRUE, 10);
  $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
  //$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
  $pdf->SetFooterMargin(5);
//  $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
//  $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
  $pdf->SetLineWidth(0.01);  //  Cadre invisible
  $pdf->AliasNbPages("nombredepages");
  $pdf->contenu_code=$code;
  $pdf->contenu_dateexp=$dateexp;
  switch ($nombre_taxes) {
    case 1:
      switch ($nb_remises_lignes) {
        case 0:
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>110,"PU"=>20,"Montant"=>20);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Montant"=>"R");
          $fonts=array( "Code"=>array($police_du_document,"B","9"),"Quantité"=>array($police_du_document,"B","9"),"Désignation"=>array($police_du_document,"","9"),"PU"=>array($police_du_document,"","9"),"Montant"=>array($police_du_document,"","9"));
          $type=array("Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Montant"=>"Texte");
          break;
        default:
          //  Attention largeur minimum 6 ???? !!!! pour taxe ????
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>90,"PU"=>20,"Remise"=>20,"Montant"=>20);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Remise"=>"R","Montant"=>"R");
          $fonts=array( "Code"=>array($police_du_document,"B","9"),"Quantité"=>array($police_du_document,"B","9"),"Désignation"=>array($police_du_document,"","9"),"PU"=>array($police_du_document,"","9"),"Remise"=>array($police_du_document,"","9"),"Montant"=>array($police_du_document,"","9"));
          $type=array( "Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Remise"=>"Texte","Montant"=>"Texte");
        break;
      }
      break;
    default:
      switch ($nb_remises_lignes) {
        case 0:
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>104,"PU"=>20,"Montant"=>20,"T"=>6);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Montant"=>"R","T"=>"C");
          $fonts=array( "Code"=>array($police_du_document,"B","9"),"Quantité"=>array($police_du_document,"B","9"),"Désignation"=>array($police_du_document,"","9"),"PU"=>array($police_du_document,"","9"),"Montant"=>array($police_du_document,"","9"),"T"=>array($police_du_document,"","9"));
          $type=array("Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Montant"=>"Texte","T"=>"Texte");
          break;
        default:
          //  Attention largeur minimum 6 ???? !!!! pour taxe ????
          $cols=array( "Code"=>25,"Quantité"=>15,"Désignation"=>84,"PU"=>20,"Remise"=>20,"Montant"=>20,"T"=>6);
          $format=array("Code"=>"L","Quantité"=>"C","Désignation"=>"L","PU"=>"R","Remise"=>"R","Montant"=>"R","T"=>"R");
          $fonts=array( "Code"=>array($police_du_document,"B","9"),"Quantité"=>array($police_du_document,"B","9"),"Désignation"=>array($police_du_document,"","9"),"PU"=>array($police_du_document,"","9"),"Remise"=>array($police_du_document,"","9"),"Montant"=>array($police_du_document,"","9"),"T"=>array($police_du_document,"","9"));
          $type=array( "Code"=>"Texte","Quantité"=>"Texte","Désignation"=>"Texte","PU"=>"Texte","Remise"=>"Texte","Montant"=>"Texte","T"=>"Texte");
        break;
      }
    break;
  }
	$pdf->impression_cgv="false";
  $pdf->AddPage();
  //	Impression du corps de la page : modele 1 : Quantité, Désignation,PU,Remise(le cas écheant), montant, code taxe (le cas échéant)
	include('_graal_bloc_code_docciaux_impression_corpus_doc_01.php');
  //  Fin de document
  include("_graal_bloc_code_docciaux_impression_pied_doc_01.php");
  fa_fin_creation_avocli();
}
?>
