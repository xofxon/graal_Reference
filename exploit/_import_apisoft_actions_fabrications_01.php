<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_typedoc=fa_recup_param('vl_c_type_doc','?????');
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
include("_import_class_data_km.php");
$o_action=new _graal_import();
$o_entete=new _graal_import();
$o_lignes=new _graal_import();
$o_nomenc=new _graal_import();
$o_detail=new _graal_import();
$art_cod=array();$art_cle=array();$art_ind=array();$art_mne=array();$art_des=array();
$sql_req="select art_cleunik,code,indice,mnemotechnique,description from $vl_c_base_destination._article;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
  array_push ($art_ind, $row['indice']);
  array_push ($art_mne, $row['mnemotechnique']);
  array_push ($art_des, $row['description']);
}
_graal_libere_requete_bd($result);
switch ($vl_c_typedoc) {
  case "fabbon":
    $vl_c_nomfic_ent="entetebonfabrication";
    $vl_c_nomfic_lig="lignebonfabrication";
    break;
  case "ordbon":
    $vl_c_nomfic_ent="enteteordrefabrication";
    $vl_c_nomfic_lig="ligneordrefabrication";
    break;
}
$sql_req_doc="SELECT `Code`,`Depot`,`DepotDest`,date(Date) as `date1`,time(Date) as `heure1`,`Description`,`Note`,`Transfert`,date(DateModification) as `date2`,time(DateModification) as `heure2` FROM $vl_c_base_origine.$vl_c_nomfic_ent order by Code ;";
$sql_req_lig="SELECT `Code` as `Code`,`NumeroLigne` as `NumeroLigne`,`CodeArticle` as `CodeArticle`,`Désignation` as `Désignation`,`Quantité` as `Quantité`,`PrixUnitaire` as `PrixUnitaire`,`Longueur` as `Longueur`,`Largeur` as `Largeur`,`Epaisseur` as `Epaisseur`,`PoidsNet` as `PoidsNet`,`Descriptif` as `Descriptif`,`UniteMesure` as `UniteMesure`,`NombreDec` as `NombreDec`,`CodeChrono` as `CodeChrono`,`TypeLigne` as `TypeLigne`,`NumSerieCompo` as `NumSerieCompo` FROM $vl_c_base_origine.$vl_c_nomfic_lig where Code <>'' and CodeArticle <> '' order by Code,NumeroLigne";
//  Attention pas de tri : pour Baronnat ca a l'air d'être trié dans l'ordre des nomenclatures
$sql_req_nom="SELECT `CodeDoc` as `CodeDoc`,`TypeDoc` as `TypeDoc`,`NChrono` as `NChrono`,`CodeArticle` as `CodeArticle`,`CodeComposante` as `CodeComposante`,`Quantite` as `Quantite`,`AImprimer` as `AImprimer`,`Equivalence` as `Equivalence`,`Valorisation` as `Valorisation`,`NombreDec` as `NombreDec`,`CodeChronoCompo` as `CodeChronoCompo`,`QuantiteTotale` as `QuantiteTotale`,`CodeChronoSerie` as `CodeChronoSerie`,`Designation` as `Designation` FROM $vl_c_base_origine.lignenomencdansdoc where TypeDoc='BF'";
$vf_e_choix_cleunik_doc=-110119;
$o_entete->req="INSERT INTO $vl_c_base_destination._fab_entetes (action_cleunik,fab_cleunik,code,dateheurecreation,dateheuremodif,blocnotebrut) VALUES ";
$vl_fab_cleunik=_graal_requete_max("fab_cleunik","_fab_entetes");
$o_lignes->req="INSERT INTO $vl_c_base_destination._fab_lignes (fab_ligne_cleunik,fab_cleunik,noligne,art_cleunik,qte_lancee,qte_fabriq,pu,statut,dateheurecreation,dateheuremodif,blocnotebrut) VALUES ";
$vl_fab_ligne_cleunik=_graal_requete_max("fab_ligne_cleunik",$vl_c_base_destination."._fab_lignes");
$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
$o_action->req="INSERT INTO $vl_c_base_destination._actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurefin,dateheurecreation,sujet,c_uuid,reference,statut) VALUES ";
$vl_fab_ligne_nomenc_cleunik=_graal_requete_max("fab_ligne_nomenc_cleunik","_fab_lignes_nomenc");
$fab_ligne_nomenc_cleunik_detail=_graal_requete_max("fab_ligne_nomenc_cleunik_detail","_fab_lignes_nomenc_detail");
$o_nomenc->req="INSERT INTO $vl_c_base_destination._fab_lignes_nomenc (fab_ligne_nomenc_cleunik,fab_ligne_cleunik,art_cleunik_pere,art_cleunik_fils,noligne,quantite_lancee,quantite_fabriq,statut,unite_quantite,nb_decimales_qte,pu,hg,nbdec_pu) VALUES ";
$o_detail->req="INSERT INTO $vl_c_base_destination._fab_lignes_nomenc_detail (fab_ligne_nomenc_cleunik_detail,fab_ligne_nomenc_cleunik,quantite_fabriq_saisie,quantite_rebute_saisie,unite_quantite,int_cleunik) VALUES ";
$fab_cod=array();$fab_cre=array();$fab_des=array();$fab_mod=array();
$result = _graal_requete_bd($sql_req_doc);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($fab_cod, $row['Code']);
  array_push ($fab_cre, $row['date1']." ".$row['heure1'] );
  array_push ($fab_des, $row['Description']);
  array_push ($fab_mod, $row['date2']." ".$row['heure2'] );
}
_graal_libere_requete_bd($result);
$i=0;$b=500;
$result = _graal_requete_bd($sql_req_lig);
$lignefab_cod=array();$lignefab_cle=array();$lignefab_nol=array();$qte_fabriq=array();
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_trouve_art=array_search($row['CodeArticle'], $art_cod);
  $vl_e_trouve_fab=array_search($row['Code'], $fab_cod);
  if ($vl_e_trouve_art===false || $vl_e_trouve_fab===false ) {} else {
    $i++;
    $dateheuredebut=$fab_cre[$vl_e_trouve_fab];
    $dateheurefin=$fab_mod[$vl_e_trouve_fab];
    $dateheurecreation=$fab_cre[$vl_e_trouve_fab];
    $sujet=addslashes($fab_des[$vl_e_trouve_fab]."-".$art_des[$vl_e_trouve_art]);
    $vl_uuid=_graal_requete_uuid();
    $noligne=$row['NumeroLigne'];
    settype($noligne,'integer');
    settype($noligne,'string');
    $reference=addslashes($row['Code']."-".$noligne."-".$art_cod[$vl_e_trouve_art]);
    $statut=-23;  //  En cours
    $statut=-40;  //  Terminé
    $o_action->dat.="($vl_action_cleunik,$vf_e_choix_cleunik_doc,'$dateheuredebut','$dateheurefin','$dateheurecreation','$sujet','$vl_uuid','$reference',$statut),";
    $o_entete->dat.="($vl_action_cleunik,$vl_fab_cleunik,'$reference','$dateheurecreation','$dateheurefin','$sujet'),";
    $vl_noligne=$row['NumeroLigne'];
    $vl_art_cleunik=$art_cle[$vl_e_trouve_art];
    $vl_qte_lancee=$row['Quantité'];
    $vl_qte_fabriq=$row['Quantité'];
    $vl_pu=$row['PrixUnitaire'];
    $statut=-23;  //  En cours
    $statut=-40;  //  Terminé
    $dateheurecreation=$fab_cre[$vl_e_trouve_fab];
    $dateheuremodif=$fab_mod[$vl_e_trouve_fab];
    $o_lignes->dat.="($vl_fab_ligne_cleunik,$vl_fab_cleunik,$vl_noligne,$vl_art_cleunik,$vl_qte_lancee,$vl_qte_fabriq,$vl_pu,$statut,'$dateheurecreation','$dateheuremodif',''),";
    $vl_c_lgf=$row['Code']."-".$row['CodeChrono']."-".$row['CodeArticle'];
    array_push ($lignefab_cod, $vl_c_lgf);
    array_push ($lignefab_cle, $vl_fab_ligne_cleunik);
    array_push ($lignefab_nol, 1);
		array_push ($qte_fabriq,$vl_qte_fabriq);
    $vl_action_cleunik++;$vl_fab_cleunik++;$vl_fab_ligne_cleunik++;
  }
  if ($i % $b==0){
    $o_action->execute();
    $o_entete->execute();
    $o_lignes->execute();
  }
}
$o_action->execute();
$o_entete->execute();
$o_lignes->execute();
_graal_libere_requete_bd($result);
$nbfab=$i;
$i=0;$b=500;
$result = _graal_requete_bd($sql_req_nom);
$o_nomenc->dump=true;
while ($row = mysql_fetch_assoc($result)) {
  $vl_c_lgf=$row['CodeDoc']."-".$row['NChrono']."-".$row['CodeArticle'];
  $vl_e_trouve_lig=array_search($vl_c_lgf, $lignefab_cod);
  $vl_e_trouve_art_pere=array_search($row['CodeArticle'], $art_cod);
  $vl_e_trouve_art_fils=array_search($row['CodeComposante'], $art_cod);
  if ($vl_e_trouve_lig===false || $vl_e_trouve_art_pere===false || $vl_e_trouve_art_fils===false) {} else {
    $i++;
    $vl_fab_ligne_cleunik=$lignefab_cle[$vl_e_trouve_lig];
    $vl_art_cleunik_pere=$art_cle[$vl_e_trouve_art_pere];
    $vl_art_cleunik_fils=$art_cle[$vl_e_trouve_art_fils];
    $vl_noligne=$lignefab_nol[$vl_e_trouve_lig];
    $vl_nouvelle_noligne=$vl_noligne;
		$vl_nouvelle_noligne++;
		$lignefab_nol[$vl_e_trouve_lig]=$vl_nouvelle_noligne;
    $vl_quantite_lancee=$row['Quantite'];
    $vl_quantite_fabriq=$row['Quantite'];
    $vl_statut=-23;
		$vl_statut=-40;  //  Terminé
    $vl_nb_decimales_qte=$row['NombreDec'];
    $vl_pu=$row['Valorisation'];
    $vl_hg=2;
    $vl_nbdec_pu=4;
    $o_nomenc->dat.="($vl_fab_ligne_nomenc_cleunik,$vl_fab_ligne_cleunik,$vl_art_cleunik_pere,$vl_art_cleunik_fils,$vl_noligne,$vl_quantite_lancee,$vl_quantite_fabriq,$vl_statut,-14,$vl_nb_decimales_qte,$vl_pu,$vl_hg,$vl_nbdec_pu),";
 		$quantite_fabriq_saisie=$vl_quantite_fabriq*$qte_fabriq[$vl_e_trouve_lig];
		$o_detail->dat.="($fab_ligne_nomenc_cleunik_detail,$vl_fab_ligne_nomenc_cleunik,$quantite_fabriq_saisie,0,-14,0),";
		$vl_fab_ligne_nomenc_cleunik++;
		$fab_ligne_nomenc_cleunik_detail++;
  }
  if ($i % $b==0){
    $o_nomenc->execute();
		$o_detail->execute();
  }
}
$o_nomenc->execute();
$o_detail->execute();
_graal_libere_requete_bd($result);
$nb_nomenc=$i;
switch ($vl_c_typedoc) {
  case "fabbon":echo($nbfab." bons de fabrication ajoutés ($nb_nomenc lignes de nomenclatures).");break;
  case "fabord":echo($nbfab." ordres de fabrication ajoutés ($nb_nomenc lignes de nomenclatures).");break;
}
?>
