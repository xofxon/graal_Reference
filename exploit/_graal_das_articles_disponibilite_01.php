<?php
include("_graal_header_xml.inc.php");
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));  
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));
$vl_e_qte_nulle=intval(fa_recup_param("vl_e_qte_nulle",'3'));
$vl_c_sortie=fa_recup_param('sortie','das');

$sql_req ="SELECT f1.art_cleunik as `art_cleunik`,qte_stock as `qte_stock`,f3.choix_valeur_texte_01 as 'unite',"._graalsql_date('f1.dateheure_dermvt')." as `dateheure_dermvt` ";
$sql_req.=",f1.dateheure_dermvt as `dateheure_dermvt_tri`,nb_decimales_qte as `nb_decimales_qte`,f2.code as `code`,f2.mnemotechnique as `mnemotechnique`,";
$sql_req.="f2.description as `description`,f2.actif as `actif`,"._graalsql_date('f1.dateheure_invent')." as `dateheure_invent` ,";
$sql_req.="f1.dateheure_invent as `dateheure_invent_tri`,sum(f5.qte-f5.qte_deja) as encommande_cli,sum(f7.qte-f7.qte_deja) as encommande_fou,(qte_stock-(sum(f5.qte-f5.qte_deja))+(sum(f7.qte-f7.qte_deja))) as dispo ";
$sql_req.=" FROM _art_stock f1 left join _article f2 using(art_cleunik) left join _cdecli_lignes f4 using(art_cleunik) left join _cdecli_lignes_qte f5 on f4.commercial_ligne_cleunik";
$sql_req.=" =f5.commercial_ligne_cleunik left join _choix  f3 on f3.choix_cleunik=f1.unite_stock left join _cdefou_lignes f6 using(art_cleunik) left join _cdefou_lignes_qte f7 ";
$sql_req.=" on f6.commercial_ligne_cleunik=f7.commercial_ligne_cleunik  ";
$sql_req.=" where (f5.statut=-38 or f5.statut is null) and (f7.statut=-38 or f7.statut is null) ";
$sql_req.=" and f4.art_cleunik=f1.art_cleunik ";

$sql_req ="SELECT f1.art_cleunik as `art_cleunik`,qte_stock as `qte_stock`,f3.choix_valeur_texte_01 as 'unite',"._graalsql_date('f1.dateheure_dermvt')." as `dateheure_dermvt` ";
$sql_req.=",f1.dateheure_dermvt as `dateheure_dermvt_tri`,nb_decimales_qte as `nb_decimales_qte`,f2.code as `code`,f2.mnemotechnique as `mnemotechnique`,";
$sql_req.="f2.description as `description`,f2.actif as `actif`,"._graalsql_date('f1.dateheure_invent')." as `dateheure_invent` ,";
$sql_req.="f1.dateheure_invent as `dateheure_invent_tri`,";
$sql_req.="(select sum(f5.qte-f5.qte_deja) from _cdecli_lignes f4 using(art_cleunik) left join _cdecli_lignes_qte f5 on f4.commercial_ligne_cleunik=f5.commercial_ligne_cleunik ";
$sql_req.=" where (f5.statut=-38 or f5.statut is null)  and f4.art_cleunik=f1.art_cleunik )";
$sql_req.=" as encommande_cli,";

//sum(f7.qte-f7.qte_deja) as encommande_fou,(qte_stock-(sum(f5.qte-f5.qte_deja))+(sum(f7.qte-f7.qte_deja))) as dispo ";
$sql_req.=" FROM _art_stock f1 left join _article f2 using(art_cleunik) ";
$sql_req.=" left join _choix  f3 on f3.choix_cleunik=f1.unite_stock ";
$sql_req.=" where 1 ";

$sql_req ="SELECT f1.art_cleunik as `art_cleunik`,qte_stock as `qte_stock`,f3.choix_valeur_texte_01 as 'unite',DATE_FORMAT(f1.dateheure_dermvt, GET_FORMAT(DATE, 'EUR')) as `dateheure_dermvt` ,";
$sql_req.=" f1.dateheure_dermvt as `dateheure_dermvt_tri`,nb_decimales_qte as `nb_decimales_qte`,f2.code as `code`,f2.mnemotechnique as `mnemotechnique`,f2.description as `description`,";
$sql_req.=" f2.actif as `actif`,DATE_FORMAT(f1.dateheure_invent, GET_FORMAT(DATE, 'EUR')) as `dateheure_invent` ,f1.dateheure_invent as `dateheure_invent_tri`,";
$sql_req.=" (select sum(f5.qte-f5.qte_deja) from _cdecli_lignes f4 left join _cdecli_lignes_qte f5 using(commercial_ligne_cleunik)  where (f5.statut=-38 or f5.statut is null)  ";
$sql_req.=" and f4.art_cleunik=f1.art_cleunik ) as encommande_cli,(select sum(f6.qte-f6.qte_deja) from _cdefou_lignes f7 left join _cdefou_lignes_qte f6 using(commercial_ligne_cleunik)  ";
$sql_req.=" where (f6.statut=-38 or f6.statut is null)  and f7.art_cleunik=f1.art_cleunik ) as encommande_fou ";
$sql_req.=" FROM _art_stock f1 left join _article f2 using(art_cleunik)  left join _choix  f3 on f3.choix_cleunik=f1.unite_stock  ";
$sql_req.=" where 1 ";


switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND f2.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND f2.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND f2.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND f2.types_gestion & 4";break;        
  case 'fabrication': $sql_req.= " AND f2.types_gestion & 8";break;        
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND f2.actif=1";break;// Actifs
  case 2: $sql_req.= " AND f2.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_validite) {
  case '': break;
  default: $sql_req.=" and (f2.dateheurevalidite >= '$vl_c_validite' or f2.dateheurevalidite is null)";break;  
}
switch ($vl_c_zone) {
  case '1': $sql_req.=" and f2.description like '$vl_c_recherche%' group by f1.art_cleunik ORDER BY `description` ASC";break;//  Description courte
  case '2': $sql_req.=" and f2.code like '$vl_c_recherche%' group by f1.art_cleunik ORDER BY `code` ASC";break;//  Code
  case '3': $sql_req.=" and f2.mnemotechnique like '$vl_c_recherche%' group by f1.art_cleunik ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
//$sql_req.= " LIMIT 0, $vl_e_limit";

switch ($vl_c_sortie) {
  case "das":
    $result = _graal_requete_bd($sql_req);
	echo('<donnees>');
	$nombre=0;
	while ($row = mysql_fetch_assoc($result)) {
		if ($nombre==$vl_e_limit){
			break;
		}
		$nb_dec=fa_ent_xml($row['nb_decimales_qte']);
		  if ($row['qte_stock']==0) {
		    $qte_stock=""; } else 
		  {
		    $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
		  }
		  $val_qte_stock=$row['qte_stock']*1000;
		  if ($row['encommande_cli']==0) {
		    $encommande_cli=""; } else 
		  {
		    $encommande_cli=fa_reel(fa_ent_xml($row['encommande_cli']),$nb_dec);
		  }
		  $val_encommande_cli=$row['encommande_cli']*1000;
		  if ($row['encommande_fou']==0) {
		    $encommande_fou=""; } else 
		  {
		    $encommande_fou=fa_reel(fa_ent_xml($row['encommande_fou']),$nb_dec);
		  }
		  $val_encommande_fou=$row['encommande_fou']*1000;
		$dispo=fa_reel((fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec)-(fa_reel(fa_ent_xml($row['encommande_cli']),$nb_dec))+(fa_reel(fa_ent_xml($row['encommande_fou']),$nb_dec))),$nb_dec);
	  $val_dispo=$dispo*1000;
	  $vl_b_edition=false;
		switch ($vl_e_qte_nulle) {
	  		case 1: if ($val_dispo==0.0){$vl_b_edition=true;};break;// Nulle
	  		case 2: if ($val_dispo<>0.0){$vl_b_edition=true;};break;// Non nulle
	  		case 3: $vl_b_edition=true;break;// Tous
	  		case 4: if ($val_dispo<0.0){$vl_b_edition=true;};break;// Négatives
		}
		if ($dispo==0.0){$dispo="";}
		if ($vl_b_edition==true){
			$nombre++;
			echo('<quoi ');
		  
		  echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		  echo(' code="'.fa_ent_xml($row['code']).'"');
		  echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
		  echo(' description="'.fa_ent_xml($row['description']).'"');
		  echo(' qte_stock="'.$qte_stock.'"');
		  printf(' val_qte_stock="%011u"',$val_qte_stock);
		  echo(' unite="'.fa_ent_xml($row['unite']).'"');
		  echo(' dateheure_dermvt="'.fa_ent_xml($row['dateheure_dermvt']).'"');
		  echo(' dateheure_dermvt_tri="'.fa_ent_xml($row['dateheure_dermvt_tri']).'"');
		  echo(' dateheure_invent="'.fa_ent_xml($row['dateheure_invent']).'"');
		  echo(' dateheure_invent_tri="'.fa_ent_xml($row['dateheure_invent_tri']).'"');
		  if ($row['actif']==1) {
		    echo(' properties=""');
		  } else {
		    echo(' properties="css_0001"');
		  }
		  echo(' encommande_cli="'.$encommande_cli.'"');
		  printf(' val_encommande_cli="%011u"',$val_encommande_cli);
		  echo(' encommande_fou="'.$encommande_fou.'"');
		  printf(' val_encommande_fou="%011u"',$val_encommande_fou);
		  echo(' dispo="'.$dispo.'"');
		  printf(' val_dispo="%011u"',$val_dispo);
		  echo('/>');
		}
	}
	echo('</donnees>');
	_graal_libere_requete_bd($result);
	_graal_ferme_connexion();
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
