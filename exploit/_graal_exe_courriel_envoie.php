<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_courriel.php");
include("_graal_fonctions_cryptage.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
//require("_graal_verifie_existence_courriel.php");
/*
****************************************** Litanies des abérations connues de ce script **************************
***********22222222222222222222
* la vérification de la syntaxe d'un courriel ne semble pas fonctionner
***********33333333333333333333
* le remplacement du retour à la ligne+"." dans le corps du message n'a pas l'air de fonctionner
*/
if (strtoupper(substr(PHP_OS,0,3)=='WIN')) {
  $eol="\r\n";
  $sautligne=$eol;
} elseif (strtoupper(substr(PHP_OS,0,3)=='MAC')) {
  $eol="\r";
} else {
  $eol="\n";
  $sautligne="\n";
}
$sep_ret='|';
define('EOL', "\r\n");
$vl_c_exp = "/^( [a-zA-Z0-9] )+( [a-zA-Z0-9\._-] )*@( [a-zA-Z0-9_-])+( [a-zA-Z0-9\._-] +)+$/";
$vl_c_genre=fa_recup_param('vl_c_genre','???');
$vl_c_sujet=fa_recup_telquel('vl_c_sujet','');
$vl_c_message=fa_recup_telquel('vl_c_message','');
$vl_c_motscle=fa_recup_param('vl_c_motscle','');
$vl_c_id=fa_recup_param('vl_c_id','?');
$vl_c_priorite=fa_recup_param('vl_c_priorite','');
$vl_c_sensitivity=fa_recup_param('vl_c_sensitivity','');
$vl_c_idorigine=fa_recup_param('vl_c_idorigine','');
$vl_c_references=fa_recup_param('vl_c_references','');
$vl_int_cleunik_initial=intval(fa_recup_param('vl_int_cleunik_initial','-2'));
$vl_c_type_envoi=intval(fa_recup_param('vl_c_type_envoi','1'));
$vl_c_type_action=intval(fa_recup_param('vl_c_type_action','1'));
$vl_c_type_courriel=intval(fa_recup_param('vl_c_type_courriel',''));
$vl_c_integre_pj_sipossible=intval(fa_recup_param('vl_c_integre_pj_sipossible',''));

$vl_c_integre_pj_sipossible=1;	//Voir mail scott marlin du 2-2-2010 à 11h33 sur multipart-related

$vl_c_confirmation_lecture=intval(fa_recup_param('vl_c_confirmation_lecture',''));
$vl_action_cleunik_liee=intval(fa_recup_param('vl_action_cleunik_liee','-1'));
$vl_tb_reg_00010=_graal_requete_regle("Reg_00010"); //  Relier automatiquement l'utilisateur créateur de l'action
$vl_int_cleunik_uti=intval(fa_recup_session('vs_int_cleunik','0'));
$vl_act_cleunik_uti=intval(fa_recup_session('vs_act_cleunik','0'));
$vs_mesid=fa_recup_session('vs_mesid','xsoftware');
$vl_c_boundary="====".md5(uniqid(rand()))."====";
$vl_c_boundary_bis="==".md5(uniqid(rand()));
$vl_c_boundary_ter="===".md5(uniqid(rand()));

$vl_e_sendmail_from=intval(fa_recup_param('vl_e_sendmail_from','0'));
$sql_req = "SELECT compte AS compte FROM _uti_cpt_bal where uticptbal_cleunik=$vl_e_sendmail_from";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
$vl_c_sendmail_from=$vl_c_xml->from[0]->attributes();
$vl_c_smtp=$vl_c_xml->smtp[0]->attributes();
$vl_c_port_smtp=$vl_c_xml->port_smtp[0]->attributes();//  ne sert à rien !!
$vl_c_emetteur=$vl_c_xml->emetteur[0]->attributes();
$vl_c_adressereponses=$vl_c_xml->adressereponse[0]->attributes();
$vl_c_cheminretour=$vl_c_xml->cheminretour[0]->attributes();
$vl_c_adresseerreurs=$vl_c_xml->adresseerreurs[0]->attributes();
$vl_c_type_compte=$vl_c_xml->type_compte[0]->attributes();
$vl_c_adresseconfirmationlecture=$vl_c_xml->adresseconfirmationlecture[0]->attributes();
/*
le 20 juillet 2007, le type de compte 2 -> wanadoo orange ne gère pas les noms dans les adresses de destinataires de la même manière que les autres types de compte
Donc pour l'instant, on ne les met pas !!!
*/
//************************************************
//  Vérification du minimum vital
//************************************************
//$vl_c_smtp='mail.christophe-charron.org';

/*
**************** à verifier
$vl_b_valid_syntax=eregi($vl_c_exp, $vl_c_destinataires);
if(!$vl_b_valid_syntax) {echo "Le courriel du destinataire est mal formé ...";exit;}
*/
//if (strlen($vl_c_sujet)==0) {echo "Il faut renseigner le sujet ...";exit;}
if (strlen($vl_c_message)==0) {echo "Le message est vide ...";exit;}
if (strlen($vl_c_sendmail_from)==0) {echo "Le compte émetteur est vide ...";exit;}
if (strlen($vl_c_smtp)==0) {echo "Le compte de messagerie est vide ...";exit;}
if (strlen($vl_c_emetteur)==0) {echo "Il faut renseigner l'émetteur...";exit;}
//  On saucissonne le message en lignes de 70 caractères
$vl_c_message=wordwrap($vl_c_message, 70);
/*
//  On tente de remplacer le retour à la ligne +"." mais ça n'a pas l'air de fonctionner
if (strtoupper(substr(PHP_OS,0,3)=='WIN')) {
  $vl_c_message = str_replace("\r\n.", "\r\n..", $vl_c_message);
} elseif (strtoupper(substr(PHP_OS,0,3)=='MAC')) {
  $vl_c_message = str_replace("\r.", "\r..", $vl_c_message);
} else {
  $vl_c_message = str_replace("\n.", "\n..", $vl_c_message);
}
*/

switch ($vl_c_genre) {
  case "normal":
  case "reponse":
  case "transfert":
  case "renvoi":
	$choix_cleunik_action=-110103;
	break;
  case "ar":
	$choix_cleunik_action=-110121;
	break;
  case "brouillon":
	$choix_cleunik_action=-110140;
	break;
}
switch ($vl_c_genre) {
  case "normal":
  case "reponse":
  case "transfert":
  case "renvoi":
  case "brouillon":
    //  Récupération des destinataires
    $vl_e_action_cleunik_origine=intval(fa_recup_param('vl_e_action_cleunik',''));
    $vl_c_liste_dest="";
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_01');   //  noms
    $vl_t_nom_dest=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_02');   //  courriels
    $vl_t_cou_dest=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_04');   //  clé unique des interlocuteurs
    $vl_t_int_dest=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    //  On récupère les copies carbones
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_05');   //  noms
    $vl_t_nom_cc=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_06');   //  courriels
    $vl_t_cou_cc=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_08');   //  clé unique des interlocuteurs
    $vl_t_int_cc=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    //  On récupère les copies carbones invisibles
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_09');   //  noms
    $vl_t_nom_cci=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_10');   //  courriels
    $vl_t_cou_cci=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_12');   //  clé unique des interlocuteurs
    $vl_t_int_cci=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    //  On va récupérer les éventuelles pièces jointes
    $vl_c_var=fa_recup_param('var','vs_tempo_courriel_14');   //  Tableau des cleunik des pièces jointes
    $vl_t_pj_cleunik=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $statut_action=-23;
    $choix_cleunik_destinataire=-110401;
    break;
  case "ar":
    $vl_e_action_cleunik_origine=intval(fa_recup_param('vl_e_action_cleunik',''));
    $sql_req="SELECT _courriel_re.mel_id,_courriel_re.datas_vrac FROM _courriel_re,_actions where _courriel_re.action_cleunik=_actions.action_cleunik and _actions.action_cleunik=$vl_e_action_cleunik_origine;";
    $result=_graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    $vl_c_references=$row['mel_id'];
    $vl_c_xml=simplexml_load_string($row['datas_vrac']);
    $vl_t_cou_dest=array();
    $vl_t_int_dest=array();
    $vl_t_nom_cc=array();$vl_t_cou_cc=array();$vl_t_int_cc=array();$vl_t_nom_cci=array();$vl_t_cou_cci=array();$vl_t_int_cci=array();$vl_t_pj_cleunik=array();
    $vl_t_nom_dest[0]=$vl_c_xml->nom_cou_destinataires_le[0]->attributes();
    $vl_t_cou_dest[0]=$vl_c_xml->nom_cou_destinataires_le[0]->attributes();
    _graal_libere_requete_bd($result);
    preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_t_cou_dest[0] , $regs);
    $vl_c_z10=$regs[0]; //  Destinataire de l'AR
    $vl_t_nom_dest[0]=base64_encode($vl_c_z10);
    $vl_t_cou_dest[0]=$vl_c_z10;
    $sql_req="SELECT f1.int_cleunik as int_cleunik,f2.actif as actif_acteur,f3.actif as actif_interlo FROM _act_interlo_mail f1,_acteurs f2,_act_interlo f3 where refweb='$vl_c_z10' and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f2.actif=1 and f3.actif=1";
    $result=_graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vl_t_int_dest[0]=$row['int_cleunik'];
    }
    _graal_libere_requete_bd($result);
    $statut_action=-40;
    $choix_cleunik_destinataire=-110417;
    break;
  default:
    echo "Ciao bambino";
    exit;
    break;
}
$vl_e_i=-1;
foreach($vl_t_nom_dest as $vl_raf) {
  $vl_e_i++;
  $vl_t_nom_dest[$vl_e_i]=rawurldecode(base64_decode($vl_t_nom_dest[$vl_e_i]));
  switch ($vl_c_type_compte) {
    case "1": //  Compte <> Orange
      switch ($vl_c_type_envoi) {
        case 1:// un envoi par destinataire
          $vl_tc_liste_dest[$vl_e_i]='"'.$vl_t_nom_dest[$vl_e_i].'"'.'<'.$vl_t_cou_dest[$vl_e_i].'>';
          $vl_tc_liste_int[$vl_e_i]=$vl_t_int_dest[$vl_e_i];
          $vl_tc_liste_dest_memo[$vl_e_i]='"'.$vl_t_nom_dest[$vl_e_i].'"'.'<'.$vl_t_cou_dest[$vl_e_i].'>';
          break;
        case 2:// Un envoi pour tous les destinataires
          $vl_tc_liste_dest[0].=$vl_t_nom_dest[$vl_e_i].'<'.$vl_t_cou_dest[$vl_e_i].'>,';
          $vl_tc_liste_int[0].=$vl_t_int_dest[$vl_e_i].',';
          $vl_tc_liste_dest_memo[0]=$vl_t_nom_dest[$vl_e_i].'<'.$vl_t_cou_dest[$vl_e_i].'>,';
          break;
      }
      break;
    case "2": //  Compte Orange
      switch ($vl_c_type_envoi) {
        case 1:// un envoi par destinataire
          $vl_tc_liste_dest[$vl_e_i]=$vl_t_cou_dest[$vl_e_i];
          $vl_tc_liste_int[$vl_e_i]=$vl_t_int_dest[$vl_e_i];
          $vl_tc_liste_dest_memo[$vl_e_i]=$vl_t_nom_dest[$vl_e_i].'<'.$vl_t_cou_dest[$vl_e_i].'>';
          break;
        case 2:// Un envoi pour tous les destinataires
          $vl_tc_liste_dest[0].=$vl_t_cou_dest[$vl_e_i].',';
          $vl_tc_liste_int[0].=$vl_t_int_dest[$vl_e_i].',';
          $vl_tc_liste_dest_memo[0].=$vl_t_nom_dest[$vl_e_i].'<'.$vl_t_cou_dest[$vl_e_i].'>,';
          break;
      }
      break;
  }
}
switch ($vl_c_type_envoi) {
  case 2:
    $vl_tc_liste_dest[0]=substr($vl_tc_liste_dest[0],0,-1);
    $vl_tc_liste_int[0]=substr($vl_tc_liste_int[0],0,-1);
    $vl_tc_liste_dest_memo[0]=substr($vl_tc_liste_dest_memo[0],0,-1);
    break;
}
switch ($vl_c_genre) {
  case "normal":
  case "reponse":
  case "transfert":
  case "renvoi":
    if (count($vl_tc_liste_dest)==0) {echo "Il faut au moins un destinataire ...";exit;}
    if (count($vl_tc_liste_int)==0) {echo "Il faut au moins un interlocuteur (message a priori impossible) ...";exit;}
    break;
  case "ar":
    if (count($vl_tc_liste_dest)==0) {echo "Il faut au moins un destinataire ...";exit;}
    break;
  case "brouillon":
  	break;
}
$vl_e_i=-1;
foreach($vl_t_nom_cc as $vl_raf) {
  $vl_e_i++;
  $vl_t_nom_cc[$vl_e_i]=rawurldecode(base64_decode($vl_t_nom_cc[$vl_e_i]));
  $vl_tc_liste_int_cc[0].=$vl_t_int_cc[$vl_e_i].',';
  $vl_liste_cc_memo.=$vl_t_nom_cc[$vl_e_i].'<'.$vl_t_cou_cc[$vl_e_i].'>,';
  switch ($vl_c_type_compte) {
    case "1":
      $vl_liste_cc.=$vl_t_nom_cc[$vl_e_i].'<'.$vl_t_cou_cc[$vl_e_i].'>,';
      break;
    case 2:
      $vl_liste_cc.=$vl_t_cou_cc[$vl_e_i].',';
      break;
  }
}
if (strlen($vl_liste_cc)!=0) {$vl_liste_cc=substr($vl_liste_cc,0,-1);$vl_tc_liste_int_cc[0]=substr($vl_tc_liste_int_cc[0],0,-1);$vl_liste_cc_memo=substr($vl_liste_cc_memo,0,-1);}
$vl_e_i=-1;
foreach($vl_t_nom_cci as $vl_raf) {
  $vl_e_i++;
  $vl_t_nom_cci[$vl_e_i]=rawurldecode(base64_decode($vl_t_nom_cci[$vl_e_i]));
  $vl_tc_liste_int_cci[0].=$vl_t_int_cci[$vl_e_i].',';
  $vl_liste_cci_memo.=$vl_t_nom_cci[$vl_e_i].'<'.$vl_t_cou_cci[$vl_e_i].'>,';
  switch ($vl_c_type_compte) {
    case "1":
      $vl_liste_cci.=$vl_t_nom_cci[$vl_e_i].'<'.$vl_t_cou_cci[$vl_e_i].'>,';
      break;
    case 2:
      $vl_liste_cci.=$vl_t_cou_cci[$vl_e_i].',';
      break;
  }
}
if (strlen($vl_liste_cci)!=0) {$vl_liste_cci=substr($vl_liste_cci,0,-1);$vl_tc_liste_int_cci[0]=substr($vl_tc_liste_int_cci[0],0,-1);$vl_liste_cci_memo=substr($vl_liste_cci_memo,0,-1);}
$vl_e_i=-1;
foreach($vl_t_pj_cleunik as $vl_raf) {
  $vl_e_i++;
  $vl_tc_liste_pj_cleunik[$vl_e_i]=$vl_t_pj_cleunik[$vl_e_i];
  $sql_req = "select document as pj,emplacement as emplacement,hash as hash,mime as mime FROM _documents WHERE doc_cleunik=$vl_tc_liste_pj_cleunik[$vl_e_i];";
  $result = _graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_tc_liste_pj[$vl_e_i]=$row['pj'];
  $vl_tc_liste_pj_nom[$vl_e_i]=$row['emplacement'];
  $vl_tc_liste_pj_mime[$vl_e_i]=$row['mime'];
  $vl_nom=addslashes($row['emplacement']);
  $vl_hash=addslashes($row['hash']);
  $vl_pj=addslashes($row['pj']);
  $vl_mime=addslashes($row['mime']);
  _graal_libere_requete_bd($result);
  if ($vl_tc_liste_pj_mime[$vl_e_i]=="") {
    $vl_tc_liste_pj_mime[$vl_e_i]=fa_mime_type_buffer($vl_tc_liste_pj[$vl_e_i]);
  }
  if ($vl_tc_liste_pj_mime[$vl_e_i]=="") {
    $vl_tc_liste_pj_mime[$vl_e_i]="application/octet-stream";
  }
}
//  Traitement des images intégrées
$vl_c_images_integrees="$eol$eol";
$vl_c_recherche = 'src="data:';
$vl_e_nb = substr_count ($vl_c_message, $vl_c_recherche);
$vl_pos_deb=0;
$vl_t_content_type=array();
$vl_t_base64=array();
$vl_t_id=array();
$vl_t_init=array();
$j=-1;
for($i=0;$i<$vl_e_nb;$i++) {
  $fin=strpos($vl_c_message, $vl_c_recherche,$vl_pos_deb);
  $vl_pos_deb=$fin+1;
  $fin_01=strpos($vl_c_message,':',$fin); //  Recherche à partir 'src="data:image/'
  $fin_02=strpos($vl_c_message,';',$fin_01); //  Recherche à partir 'src="data:image/'
  $type_content=substr($vl_c_message,$fin_01+1,$fin_02-$fin_01-1);
  $fin_01=strpos($vl_c_message,',',$fin); //  Recherche à partir 'src="data:image/'
  $fin_02=strpos($vl_c_message,'"',$fin_01); //  Recherche à partir 'src="data:image/'
  $base64=substr($vl_c_message, $fin_01+1,$fin_02-$fin_01-1);

  $vl_init=substr($vl_c_message, $fin,$fin_02-$fin+1);
  $vl_pos_deja=array_search($vl_init,$vl_t_init);
  if ($vl_pos_deja===false) {
    $j++;
    $vl_t_init[$j]=$vl_init;
    $vl_t_base64[$j]=$base64;
    $vl_t_content_type[$j]=$type_content;
    //  Recherche de l'image dans la base
    $ctx = hash_init('sha1');
    hash_update($ctx, "$base64");
    $hash=hash_final($ctx);
    $sql_req="SELECT hash FROM _courriel_images where hash='$hash';";
    $result=_graal_requete_bd($sql_req);
    if($ligne=mysql_fetch_row($result)) {
    } else {
      $sql_req="INSERT INTO _courriel_images set hash='$hash',image='$base64',mime='".addslashes($type_content)."';";
      _graal_exec_requete($sql_req);
    }
    $vl_t_id[$j]='src="cid:'.$hash.'"';
    $mabelleimage=chunk_split($base64);
    $vl_c_images_integrees.="--$vl_c_boundary_bis$eol";
    $vl_c_images_integrees.="Content-Type: $type_content; name=\"$hash\"$eol";
    $vl_c_images_integrees.="Content-Transfer-Encoding: base64$eol";
    $vl_c_images_integrees.="Content-ID: <$hash>$eol";
    $vl_c_images_integrees.=$eol;
    $vl_c_images_integrees.=$mabelleimage.$eol;
    $vl_c_images_integrees.=$eol.$eol;
  }
}
$vl_c_message=str_replace($vl_t_init,$vl_t_id,$vl_c_message);
$vl_c_recherche = 'background="data:';
$vl_e_nb = substr_count ($vl_c_message, $vl_c_recherche);
$vl_pos_deb=0;
for($i=0;$i<$vl_e_nb;$i++) {
  $fin=strpos($vl_c_message, $vl_c_recherche,$vl_pos_deb);
  $vl_pos_deb=$fin+1;
  $fin_01=strpos($vl_c_message,':',$fin); //  Recherche à partir 'background="data:image/'
  $fin_02=strpos($vl_c_message,';',$fin_01); //  Recherche à partir 'background="data:image/'
  $type_content=substr($vl_c_message,$fin_01+1,$fin_02-$fin_01-1);
  $fin_01=strpos($vl_c_message,',',$fin); //  Recherche à partir 'background="data:image/'
  $fin_02=strpos($vl_c_message,'"',$fin_01); //  Recherche à partir 'background="data:image/'
  $base64=substr($vl_c_message, $fin_01+1,$fin_02-$fin_01-1);

  $vl_init=substr($vl_c_message, $fin,$fin_02-$fin+1);
  $vl_pos_deja=array_search($vl_init,$vl_t_init);
  if ($vl_pos_deja===false) {
    $j++;
    $vl_t_init[$j]=$vl_init;
    $vl_t_base64[$j]=$base64;
    $vl_t_content_type[$j]=$type_content;
    //  Recherche de l'image dans la base
    $ctx = hash_init('sha1');
    hash_update($ctx, "$base64");
    $hash=hash_final($ctx);
    $sql_req="SELECT hash FROM _courriel_images where hash='$hash';";
    $result=_graal_requete_bd($sql_req);
    if($ligne=mysql_fetch_row($result)) {
    } else {
      $sql_req="INSERT INTO _courriel_images set hash='$hash',image='$base64',mime='".addslashes($type_content)."';";
      _graal_exec_requete($sql_req);
    }
    $vl_t_id[$j]='background="cid:'.$hash.'"';
    $mabelleimage=chunk_split($base64);
    $vl_c_images_integrees.="--$vl_c_boundary_bis$eol";
    $vl_c_images_integrees.="Content-Type: $type_content; name=\"$hash\"$eol";
    $vl_c_images_integrees.="Content-Transfer-Encoding: base64$eol";
    $vl_c_images_integrees.="Content-ID: <$hash>$eol";
    $vl_c_images_integrees.=$eol;
    $vl_c_images_integrees.=$mabelleimage.$eol;
    $vl_c_images_integrees.=$eol.$eol;
  }
}
$vl_c_message=str_replace($vl_t_init,$vl_t_id,$vl_c_message);
//  On décide de toujours commencer par l'émetteur
$vl_c_headers="From: $vl_c_emetteur".$eol;
if (strlen($vl_c_cheminretour)!=0) {$vl_c_headers .= "Return-Path: $vl_c_cheminretour$eol";} else {$vl_c_headers .= "Return-Path: $vl_c_emetteur$eol";}
$vl_c_headers.="Date: ".date(r).$eol;
if ($vl_c_genre!="ar") {
  if (strlen($vl_c_adressereponses)!=0) {$vl_c_headers .= "Reply-To: $vl_c_adressereponses $eol";} else {$vl_c_headers .= "Reply-To: $vl_c_emetteur $eol";}
}
/*
 * ça a l'air de poser problèmes non pas en local avec WAMP mais sur site avec haisoft ? gmail ?
 * Décommenté le 9/9/2008
 * {$vl_c_headers .= "X-Errors: $vl_c_adresseerreurs $eol";}
 */
if (strlen($vl_c_adresseerreurs)!=0) {$vl_c_headers .= "Errors-To: $vl_c_adresseerreurs$eol";}
if (strlen($vl_c_adresseerreurs)!=0) {$vl_c_headers .= "X-Errors-To: $vl_c_adresseerreurs$eol";}
$vl_c_headers .= "X-Mailer: XsOFtware Logiciel de gestion en ligne pour les TPE".$eol;
if (strlen($vl_liste_cc)!=0) {$vl_c_headers .= "Cc: $vl_liste_cc$eol";}
if (strlen($vl_liste_cci)!=0) {$vl_c_headers .= "Bcc: $vl_liste_cci$eol";}
if (strlen($vl_c_motscle)!=0) {$vl_c_headers .= "Keywords: $vl_c_motscle$eol";}
switch ($vl_c_priorite){
  case "1": case "2": case "3": case "4": case "5":
    $vl_c_headers .= "X-Priority: $vl_c_priorité$eol";
    break;
  case "0":break;
}
switch ($vl_c_sensitivity){
  case "0":break;
  case "1":$vl_c_headers .= "Sensitivity: personnal$eol";break;
  case "2":$vl_c_headers .= "Sensitivity: private$eol";break;
}
switch ($vl_c_confirmation_lecture) {
  case "1":
    if ($vl_c_adresseconfirmationlecture!="") {
        $vl_c_headers .= "Disposition-Notification-To: $vl_c_adresseconfirmationlecture$eol";
      } else {
        $vl_c_headers .= "Disposition-Notification-To: $vl_c_emetteur$eol";
      }
      $vl_c_headers .= "Disposition-Notification-Options: notify = optional,disposition, critical-content".$eol;
      break;
}
$vl_c_action_uuid=_graal_requete_uuid();
if (strlen($vl_c_idorigine)!=0) {$vl_c_headers .= "In-Reply-To: $vl_c_idorigine$eol";}
if (strlen($vl_c_references)!=0) {
  $vl_c_headers .= "References: $vl_c_references$eol";
} else {
  $vl_c_headers .= "References: $vl_c_action_uuid$eol";
}
//*******************************************
//  Modification ponctuelle des paramètres du serveur
//*******************************************
ini_set('SMTP',$vl_c_smtp);
ini_set('sendmail_from',$vl_c_sendmail_from);
//ini_set('smtp_port',$vl_c_port_smtp); à priori, inopérant en remote sur haisoft. Donc toujours port 25
$vl_b_ok=true;
for($vl_e_i=0;$vl_e_i< count($vl_tc_liste_dest);$vl_e_i++){
  //  On calcule préalablement le nombre de pj
  if (strlen($vl_c_id)!=0){
    if ($vl_c_id=="?"){
      $vl_c_id="<"._graal_requete_uuid().$vs_mesid.">";
      $vl_c_id=str_replace("-",".",$vl_c_id);
      }
  }
  $vl_c_headers_id="Message-ID: $vl_c_id $eol";

    switch ($vl_c_type_courriel) {
      case 1: //  Envoi texte
        $vl_c_headers_inter01="MIME-Version: 1.0".$eol;
        if (count($vl_tc_liste_pj)!=0) {
          if ($vl_c_integre_pj_sipossible==1) {
            $vl_c_headers_inter01.="Content-Type: multipart/mixed; boundary=\"$vl_c_boundary\"$eol";
          } else {
            //$vl_c_headers_inter01.="Content-Type: multipart/related; boundary=\"$vl_c_boundary\"$eol";	// souci perte mail 2-2-2010
            $vl_c_headers_inter01.="Content-Type: multipart/mixed; boundary=\"$vl_c_boundary\"$eol";
          }
          $vl_c_header_fin=$vl_c_headers.$vl_c_headers_id.$vl_c_headers_inter01;
          $vl_c_message_fin=$eol."--$vl_c_boundary".$eol;
          $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
          $vl_c_message_fin.=$sautligne;
          //$vl_c_message_fin.="Subject: $vl_c_sujet$eol";
          $vl_c_message_fin.=$vl_c_message;
        } else {
          //  Texte seul, sans pièces jointes
          $vl_c_headers_inter01.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
          //$vl_c_headers_inter01.="Subject: $vl_c_sujet$eol";
          $vl_c_header_fin=$vl_c_headers.$vl_c_headers_id.$vl_c_headers_inter01;
          $vl_c_message_fin=$sautligne.$vl_c_message.$eol.$eol;
        }
        $vl_c_message_pj="";
        for($vl_e_j=0;$vl_e_j<count($vl_tc_liste_pj);$vl_e_j++){
          if ($vl_tc_liste_pj_nom[$vl_e_j]!="") {
            $vl_c_pj_base64=chunk_split(base64_encode($vl_tc_liste_pj[$vl_e_j]));
            $vl_c_message_pj.=$eol.$eol."--$vl_c_boundary".$eol;
            $vl_c_message_pj.="Content-Type: $vl_tc_liste_pj_mime[$vl_e_j]; name=\"".$vl_tc_liste_pj_nom[$vl_e_j]."\"$eol";
            $vl_c_message_pj.="Content-Transfer-Encoding: base64$eol";
            // Petit plus pour les fichiers joints : Il est possible de demander à ce que le fichier soit si possible affiché dans le corps du mail
            $vl_c_message_pj.="Content-Disposition: inline; filename=\"".($vl_tc_liste_pj_nom[$vl_e_j])."\"$eol";
            // Il est indispensable d'introduire une ligne vide entre l'entête et le texte
            $vl_c_message_pj.=$eol;
            $vl_c_message_pj.=$vl_c_pj_base64.$eol;
            $vl_c_message_pj.=$eol.$eol;
          }
        }
        if ($vl_c_message_pj!="") {$vl_c_message_fin.=$vl_c_message_pj;}
        break;
      case 2: //  Envoi HTML
        $vl_message_brut=strip_tags($vl_c_message);
        $vl_c_header_fin=$vl_c_headers.$vl_c_headers_id."MIME-Version: 1.0".$eol;
        //  4 cas de figures :
        //  - 1° -> Avec Pièces jointes et avec images incorporées
        //  - 2° -> Avec Pièces jointes et sans images incorporées
        //  - 3° -> Sans pièces jointes et avec images incorporées
        //  - 4° -> Sans pièces jointes et sans images incorporées
        if ((count($vl_tc_liste_pj)!=0) and (count($vl_t_id)!=0)) {
          //  - 1° -> Avec Pièces jointes et avec images incorporées
          $vl_c_header_fin.="Content-type: multipart/mixed; boundary=\"$vl_c_boundary\"$eol";
          $vl_c_message_fin="This is a multi-part message in MIME format.";
          $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
          $vl_c_message_fin.="Content-type: multipart/alternative; boundary=\"$vl_c_boundary_ter\"$eol";
          $vl_c_message_fin.=$eol."--$vl_c_boundary_ter".$eol;
          $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
          //$vl_c_message_fin.="Subject: $vl_c_sujet$eol";
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.=$vl_message_brut.$eol;
          $vl_c_message_fin.=$eol."--$vl_c_boundary_ter".$eol;
          //$vl_c_message_fin.="Content-Type: multipart/related; boundary=\"$vl_c_boundary_bis\"$eol";
          $vl_c_message_fin.="Content-Type: multipart/mixed; boundary=\"$vl_c_boundary_bis\"$eol";
          $vl_c_message_fin.=$eol."--$vl_c_boundary_bis".$eol;
          $vl_c_message_fin.="Content-type: text/html; charset=utf-8".$eol;  //  Par défaut pour du html
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.="<html>$vl_c_message</html>";
          $vl_c_message_fin.=$vl_c_images_integrees;
          $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary_bis--".$eol;
          $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary_ter--".$eol;
          $vl_c_message_pj="";
          for($vl_e_j=0;$vl_e_j<count($vl_tc_liste_pj);$vl_e_j++){
            if ($vl_tc_liste_pj_nom[$vl_e_j]!="") {
              $vl_c_pj_base64=chunk_split(base64_encode($vl_tc_liste_pj[$vl_e_j]));
              $vl_c_message_pj.=$eol.$eol."--$vl_c_boundary".$eol;
              $vl_c_message_pj.="Content-Type: $vl_tc_liste_pj_mime[$vl_e_j]; name=\"".($vl_tc_liste_pj_nom[$vl_e_j])."\"$eol";
              $vl_c_message_pj.="Content-Transfer-Encoding: base64$eol";
              // Petit plus pour les fichiers joints : Il est possible de demander à ce que le fichier soit si possible affiché dans le corps du mail
              $vl_c_message_pj.="Content-Disposition: inline; filename=\"".($vl_tc_liste_pj_nom[$vl_e_j])."\"$eol";
              // Il est indispensable d'introduire une ligne vide entre l'entête et le texte
              $vl_c_message_pj.=$eol;
              $vl_c_message_pj.=$vl_c_pj_base64.$eol;
              $vl_c_message_pj.=$eol.$eol;
            }
          }
          $vl_c_message_fin.=$vl_c_message_pj;
        }
        if ((count($vl_tc_liste_pj)!=0) and (count($vl_t_id)==0)) {
          //  - 2° -> Avec Pièces jointes et sans images incorporées
          $vl_c_header_fin.="Content-type: multipart/mixed; boundary=\"$vl_c_boundary\"$eol";
          $vl_c_message_fin="This is a multi-part message in MIME format.";
          $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
          $vl_c_message_fin.="Content-type: multipart/alternative; boundary=\"$vl_c_boundary_ter\"$eol";
          $vl_c_message_fin.=$eol."--$vl_c_boundary_ter".$eol;
          $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
          //$vl_c_message_fin.="Subject: $vl_c_sujet$eol";
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.=$vl_message_brut.$eol;
          $vl_c_message_fin.=$eol."--$vl_c_boundary_ter".$eol;
          $vl_c_message_fin.="Content-type: text/html; charset=utf-8".$eol;  //  Par défaut pour du html
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.="<html>$vl_c_message</html>";
          $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary_ter--".$eol;
          $vl_c_message_pj="";
          for($vl_e_j=0;$vl_e_j<count($vl_tc_liste_pj);$vl_e_j++){
            if ($vl_tc_liste_pj_nom[$vl_e_j]!="") {
              $vl_c_pj_base64=chunk_split(base64_encode($vl_tc_liste_pj[$vl_e_j]));
              $vl_c_message_pj.=$eol.$eol."--$vl_c_boundary".$eol;
              $vl_c_message_pj.="Content-Type: $vl_tc_liste_pj_mime[$vl_e_j]; name=\"".($vl_tc_liste_pj_nom[$vl_e_j])."\"$eol";
              $vl_c_message_pj.="Content-Transfer-Encoding: base64$eol";
              // Petit plus pour les fichiers joints : Il est possible de demander à ce que le fichier soit si possible affiché dans le corps du mail
              $vl_c_message_pj.="Content-Disposition: inline; filename=\"".($vl_tc_liste_pj_nom[$vl_e_j])."\"$eol";
              // Il est indispensable d'introduire une ligne vide entre l'entête et le texte
              $vl_c_message_pj.=$eol;
              $vl_c_message_pj.=$vl_c_pj_base64.$eol;
              $vl_c_message_pj.=$eol.$eol;
            }
          }
          $vl_c_message_fin.=$vl_c_message_pj;
        }
        if ((count($vl_tc_liste_pj)==0) and (count($vl_t_id)!=0)) {
          //  - 3° -> Sans pièces jointes et avec images incorporées
          $vl_c_header_fin.="Content-type: multipart/alternative; boundary=\"$vl_c_boundary\"$eol";
          $vl_c_message_fin="This is a multi-part message in MIME format.";
          $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
          $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
          //$vl_c_message_fin.="Subject: $vl_c_sujet$eol";
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.=$vl_message_brut.$eol;
          $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
          //$vl_c_message_fin.="Content-Type: multipart/related; boundary=\"$vl_c_boundary_bis\"$eol";
          $vl_c_message_fin.="Content-Type: multipart/mixed; boundary=\"$vl_c_boundary_bis\"$eol";
          $vl_c_message_fin.=$eol."--$vl_c_boundary_bis".$eol;
          $vl_c_message_fin.="Content-type: text/html; charset=utf-8".$eol;  //  Par défaut pour du html
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.="<html>$vl_c_message</html>";
          $vl_c_message_fin.=$vl_c_images_integrees;
          $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary_bis--".$eol;
        }
        if ((count($vl_tc_liste_pj)==0) and (count($vl_t_id)==0)) {
          //  - 4° -> Sans pièces jointes et sans images incorporées
          $vl_c_header_fin.="Content-type: multipart/alternative; boundary=\"$vl_c_boundary\"$eol";
          $vl_c_message_fin="This is a multi-part message in MIME format.";
          $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
          $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
          //$vl_c_message_fin.="Subject: $vl_c_sujet$eol";
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.=$vl_message_brut.$eol;
          $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
          $vl_c_message_fin.="Content-type: text/html; charset=utf-8".$eol;  //  Par défaut pour du html
          $vl_c_message_fin.="Content-Disposition: inline;".$eol;
          $vl_c_message_fin.=$sautligne;
          $vl_c_message_fin.="<html>$vl_c_message</html>";
        }

        /*
        $vl_c_message_fin.=$eol."--$vl_c_boundary".$eol;
        $vl_c_message_fin.="Content-Type: multipart/alternative; boundary=\"$vl_c_boundary_bis\"$eol";
        $vl_c_message_fin.=$eol."--$vl_c_boundary_bis".$eol;
        $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
        $vl_c_message_fin.="Content-Disposition: inline;".$eol;
        $vl_c_message_fin.=$vl_message_brut.$eol;
        $vl_c_message_fin.=$eol."--$vl_c_boundary_bis".$eol;
        $vl_c_message_fin.="Content-type: text/html; charset=utf-8".$eol;  //  Par défaut pour du html
        $vl_c_message_fin.="Content-Disposition: inline;".$eol;
        $vl_c_message_fin.=$vl_c_message;
        $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary_bis--".$eol;
        */
        break;
      case 3: //  Accusé de réception
        $vl_c_headers_inter01="MIME-Version: 1.0".$eol;
        $vl_c_headers_inter01.="Content-Type: multipart/report;	report-type=disposition-notification; boundary=\"$vl_c_boundary\"$eol";
        $vl_c_header_fin=$vl_c_headers.$vl_c_headers_id.$vl_c_headers_inter01;
        $vl_c_message_fin=$eol."--$vl_c_boundary".$eol;
        $vl_c_message_fin.="Content-type: text/plain; charset=utf-8".$eol;  //  Par défaut pour du texte
        //$vl_c_message_fin.="Subject: $vl_c_sujet$eol";
        $vl_c_message_fin.="Content-Transfer-Encoding: quoted-printable$eol$eol";
        $vl_c_message_fin.=$vl_c_message.$eol.$eol;
        $vl_c_message_ar="--$vl_c_boundary$eol";
        $vl_c_message_ar.="Content-Type: message/disposition-notification$eol";
        $vl_c_message_ar.="Content-Transfer-Encoding: 7bit$eol$eol";
        $vl_c_message_ar.="Final-Recipient: rfc822;$vl_c_emetteur$eol";
        $vl_c_message_ar.="Original-Message-ID: $vl_c_references$eol";
        $vl_c_message_ar.="Disposition: manual-action/MDN-sent-automatically; displayed";
        $vl_c_message_fin.=$vl_c_message_ar;
        break;
    }
    switch ($vl_c_type_courriel) {
      case 1:
        if (count($vl_tc_liste_pj)!=0) {
          $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary--".$eol;
        } else {
          //  Texte seul, sans pièces jointes
        }
        break;
      case 2:
        $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary--".$eol;
        break;
      case 3:
        $vl_c_message_fin.=$eol.$eol."--$vl_c_boundary--".$eol;
        break;
    }
  //mb_internal_encoding('UTF-8');
  //if (mb_send_mail($vl_tc_liste_dest[$vl_e_i],$vl_c_sujet, $vl_c_message_fin, $vl_c_header_fin) == true){
  //if (mail($vl_tc_liste_dest[$vl_e_i],mb_encode_mimeheader($vl_c_sujet, 'UTF-8', 'B'), $vl_c_message_fin, $vl_c_header_fin) == true){
  //if (mail($vl_tc_liste_dest[$vl_e_i],header_quoted_printable_encode_xof(base64_encode($vl_c_sujet),$encoding='UTF-8',$quoi="B"), $vl_c_message_fin, $vl_c_header_fin) == true){  ne fonctionne pas
  switch ($vl_c_genre) {
	  case "normal":
	  case "reponse":
	  case "transfert":
	  case "renvoi":
	  case "ar":
		  if (mail($vl_tc_liste_dest[$vl_e_i],header_quoted_printable_encode_xof($vl_c_sujet), $vl_c_message_fin, $vl_c_header_fin,"-f $vl_c_sendmail_from") == true){
		  //if (false == true){
		    $retour.="ok, courrier envoyé à $vl_tc_liste_dest[$vl_e_i]".$eol;
		    $vl_b_ok=true;
		  }
		  else {
		    $vl_b_ok=false;
		    $retour.="Le courriel n'a pas été envoyé à $vl_tc_liste_dest[$vl_e_i]".$eol;
		    $retour.="************";
		    $retour.="Sujet : ".header_quoted_printable_encode_xof($vl_c_sujet);
		    $retour.="From : $vl_c_sendmail_from";
		    $retour.="$vl_c_message_fin.$vl_c_header_fin";
		    $retour.="************";
		  }
	  	break;
	  case "brouillon":
		$vl_b_ok=true;
		break;
}
    //  Ajout action
    $sujet=addslashes($vl_c_sujet);
    $message=addslashes($vl_c_message);
    $header=addslashes($vl_c_header_fin);
    $destinataires=addslashes($vl_tc_liste_dest[$vl_e_i]);

    $datas_vrac="";
    $datas_vrac.=fa_xcree_entete_xml();
    $datas_vrac.='<parametres>';
    $datas_vrac.='<int_destinataires data="'.$vl_tc_liste_int[$vl_e_i].'"/>';
    $datas_vrac.='<int_destinataires_cc data="'.$vl_tc_liste_int_cc[$vl_e_i].'"/>';
    $datas_vrac.='<int_destinataires_cci data="'.$vl_tc_liste_int_cci[$vl_e_i].'"/>';

    $datas_vrac.='<nom_cou_destinataires data="'.fa_ent_xml($vl_tc_liste_dest_memo[$vl_e_i]).'"/>';
    $datas_vrac.='<nom_cou_destinataires_cc data="'.fa_ent_xml($vl_liste_cc_memo).'"/>';
    $datas_vrac.='<nom_cou_destinataires_cci data="'.fa_ent_xml($vl_liste_cci_memo).'"/>';

    $datas_vrac.='<nom_images_integrees_nombre data="'.count($vl_t_id).'"/>';
    for($vl_e_j=0;$vl_e_j< count($vl_t_id);$vl_e_j++){
      $datas_vrac.='<nom_images_integrees data="'.fa_ent_xml($vl_t_id[$vl_e_j]).'"/>';
    }

    $datas_vrac.='<pj_nombre data="'.count($vl_tc_liste_pj_nom).'"/>';
    for($vl_e_j=0;$vl_e_j< count($vl_tc_liste_pj_nom);$vl_e_j++){
      $datas_vrac.='<nom_pj data="'.fa_ent_xml($vl_tc_liste_pj_nom[$vl_e_j]).'"/>';
      $datas_vrac.='<cleunik_pj data="'.fa_ent_xml($vl_tc_liste_pj_cleunik[$vl_e_j]).'"/>';
    }
    $datas_vrac.='<int_integre_pj_sipossible data="'.$vl_c_integre_pj_sipossible.'"/>';
    $datas_vrac.='<int_priorite data="'.$vl_c_priorite.'"/>';
    $datas_vrac.='<int_sensitivity data="'.$vl_c_sensitivity.'"/>';
    $datas_vrac.='<int_type_courriel data="'.$vl_c_type_courriel.'"/>';

    $datas_vrac.='</parametres>';


    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=$choix_cleunik_action,dateheurecreation=now(),dateheuredebut=now(),c_uuid='$vl_c_action_uuid',action_type=1,sujet='$sujet',statut=$statut_action;";
    if(_graal_exec_requete($sql_req)=='ok') {
      //  On rattache toutes les pièces jointes à l'action
      for($vl_e_j=0;$vl_e_j< count($vl_tc_liste_pj_nom);$vl_e_j++){
        $sql_req_01 = "INSERT INTO _documents_rattachement set doc_cleunik=".$vl_tc_liste_pj_cleunik[$vl_e_j].",rat_cleunik=$vl_action_cleunik,portee=$vl_e_piejoi;";
        _graal_exec_requete($sql_req_01);
      }
      //  On rattache tous les interlocuteurs destinataires "simples", destinataires d'AR
      $sql_req="SELECT act_cleunik as act_cleunik,int_cleunik FROM _act_interlo where int_cleunik in (".$vl_tc_liste_int[$vl_e_i].");";
      $result = _graal_requete_bd($sql_req);
      while ($row = mysql_fetch_assoc($result)){
        $vl_act_cleunik=fa_ent_xml($row['act_cleunik']);
        $vl_int_cleunik=fa_ent_xml($row['int_cleunik']);
        $sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=$choix_cleunik_destinataire,portee=$vl_e_interl,principal=2;";
        _graal_exec_requete($sql_req_01);
      }
      _graal_libere_requete_bd($result);
      //  On rattache tous les interlocuteurs en copie carbone
      if (strlen($vl_liste_cc)!=0) {
        $sql_req="SELECT act_cleunik as act_cleunik,int_cleunik FROM _act_interlo where int_cleunik in (".$vl_tc_liste_int_cc[$vl_e_i].");";
        $result = _graal_requete_bd($sql_req);
        while ($row = mysql_fetch_assoc($result)){
          $vl_act_cleunik=fa_ent_xml($row['act_cleunik']);
          $vl_int_cleunik=fa_ent_xml($row['int_cleunik']);
          $sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110403,portee=$vl_e_interl,principal=1;";
          _graal_exec_requete($sql_req_01);
        }
        _graal_libere_requete_bd($result);
      }
      //  On rattache tous les interlocuteurs en copie carbone invisibles
      if (strlen($vl_liste_cci)!=0) {
        $sql_req="SELECT act_cleunik as act_cleunik,int_cleunik FROM _act_interlo where int_cleunik in (".$vl_tc_liste_int_cci[$vl_e_i].");";
        $result = _graal_requete_bd($sql_req);
        while ($row = mysql_fetch_assoc($result)){
          $vl_act_cleunik=fa_ent_xml($row['act_cleunik']);
          $vl_int_cleunik=fa_ent_xml($row['int_cleunik']);
          $sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110404,portee=$vl_e_interl,principal=1;";
          _graal_exec_requete($sql_req_01);
        }
        _graal_libere_requete_bd($result);
      }
      //  En cas de transfert, on lie également l'expéditeur du courriel originel
      if ($vl_int_cleunik_initial!=-2) {
        $sql_req="SELECT act_cleunik as act_cleunik,int_cleunik FROM _act_interlo where int_cleunik=$vl_int_cleunik_initial;";
        $result = _graal_requete_bd($sql_req);
        while ($row = mysql_fetch_assoc($result)){
          $vl_act_cleunik=fa_ent_xml($row['act_cleunik']);
          $sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik_initial,act_cleunik=$vl_act_cleunik,choix_cleunik=-110418,portee=$vl_e_interl,principal=1;";
          _graal_exec_requete($sql_req_01);
        }
      }
		if ($vl_tb_reg_00010[0]==1) {
			//	On ajoute l'utilisateur comme auteur de l'action (soumis à règle reg_00010)
			$sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik_uti,act_cleunik=$vl_act_cleunik_uti,choix_cleunik=-110435,portee=$vl_e_interl,principal=1;";
			_graal_exec_requete($sql_req);
		}
      //  Recherche du message dans la base
      $ctx = hash_init('sha1');
      hash_update($ctx, "$vl_c_message");
      $hash=hash_final($ctx);
      $sql_req="SELECT courriel_en_mes_cleunik as cleunik FROM _courriel_en_mes where hash='$hash';";
      $result=_graal_requete_bd($sql_req);
      if($ligne=mysql_fetch_row($result)) {
        $vl_courriel_en_mes_cleunik=$ligne[0];
      } else {
        $vl_courriel_en_mes_cleunik=_graal_requete_max("courriel_en_mes_cleunik","_courriel_en_mes");
        $sql_req="INSERT INTO _courriel_en_mes set courriel_en_mes_cleunik=$vl_courriel_en_mes_cleunik,hash='$hash',message='$message';";
        _graal_exec_requete($sql_req);
      }
      $sql_req="INSERT INTO _courriel_en set action_cleunik=$vl_action_cleunik,courriel_en_mes_cleunik=$vl_courriel_en_mes_cleunik,sujet='$sujet',header='$header',destinataires='$destinataires',type=$vl_c_type_courriel,datas_vrac='$datas_vrac',mel_id='$vl_c_id';";
      _graal_exec_requete($sql_req);
      if ($vl_c_type_courriel==3) {
        //  On met à jour l'état d'AR
        $sql_req="UPDATE _courriel_re set etat_ar=2 where action_cleunik=$vl_e_action_cleunik_origine";
        _graal_requete_bd($sql_req);
        //  On lie l'action d'origine et l'envoi
        $action_cleunik_gauche=$vl_e_action_cleunik_origine;
        $action_cleunik_droite=$vl_action_cleunik;
        $choix_cleunik_droite=-50;
        $choix_cleunik_gauche=-48;
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$action_cleunik_gauche,action_cleunik_droite=$action_cleunik_droite,choix_cleunik_gauche=$choix_cleunik_gauche,choix_cleunik_droite=$choix_cleunik_droite";
        _graal_exec_requete($sql_req);
      }
      if (($vl_c_genre=="reponse") or ($vl_c_genre=="transfert")){
        //  On lie l'action d'origine et l'envoi
        $action_cleunik_gauche=$vl_e_action_cleunik_origine;
        $action_cleunik_droite=$vl_action_cleunik;
        $choix_cleunik_droite=-49;
        $choix_cleunik_gauche=-48;
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$action_cleunik_gauche,action_cleunik_droite=$action_cleunik_droite,choix_cleunik_gauche=$choix_cleunik_gauche,choix_cleunik_droite=$choix_cleunik_droite";
        _graal_exec_requete($sql_req);
      }
			//  On lie l'action éventuellement l'action d'origine et l'envoi
      if ($vl_action_cleunik_liee!=-1) {
        $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$vl_action_cleunik_liee,action_cleunik_droite=$vl_action_cleunik,choix_cleunik_droite=-24,choix_cleunik_gauche=-24;";
        _graal_exec_requete($sql_req);
      }
    } else {
      $vf_c_echo=-1;
    }

}
//*******************************************
//  Remise en l'état des paramètres du serveur
//*******************************************
ini_restore('SMTP');
ini_restore('sendmail_from');
//ini_restore('smtp_port');
_graal_ferme_connexion();

if ($vl_b_ok==false) {
  echo "".$sep_ret.$retour.$eol.$vl_c_sujet.$eol."$vl_c_message_fin".$eol;
} else {
  echo "0".$sep_ret.$eol.$retour.$eol.$vl_c_sujet.$eol.$sep_ret;
}
//echo ("".$sep_ret.$vl_tc_liste_dest[0].$eol.$vl_tc_nom_dest[0].$eol.$vl_tc_liste_dest_memo[0].$eol.$vl_c_sujet.$eol.$vl_c_header_fin.$vl_c_message_fin);
?>
