<?php
define('EOL', "\r\n");
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
include("_graal_fonctions_documents.php");
$vl_e_doc_cleunik=intval(fa_recup_param('vl_e_doc_cleunik','0'));
$vl_e_angle_rotation=intval(fa_recup_param('vl_e_angle_rotation','0'));
if (fa_verif_droit($vl_e_doc_cleunik)==false) {fa_redirige("document_interdit");}
$sql_req = "SELECT document AS pj, emplacement as nom,mime as mime,hash FROM _documents WHERE doc_cleunik=$vl_e_doc_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nom=$row['nom'];
$ext = substr(strtolower(strrchr(basename($nom), ".")), 1);
/*
 * liste exhaustive des type OOo
 * http://framework.openoffice.org/documentation/mimetypes/mimetypes.html
 * http://www.w3schools.com/media/media_mimeref.asp
 * 
 */
//header("Content-disposition: attachment; filename=\"".basename($nom)."\"");
header("Content-disposition: inline; filename=\"".basename($nom)."\"");
switch ($ext) {
	case "txt":
		header('Content-type: text/plain; charset=utf-8');
		echo $row['pj'];
		break;
	case "png":
		header('Content-type: image/png');
		echo $row['pj'];
		break;
	case "gif":
		header('Content-type: image/gif');
		echo $row['pj'];
		break;
	case "jpg":
	case "jpeg":
	case "jpe":
		header('Content-type: image/jpeg');
		echo $row['pj'];
		break;
	case "tiff":
	case "tif":
		header('Content-type: image/tiff');
		echo $row['pj'];
		break;		
	case "pdf":
		header('Content-type: application/pdf');
		echo $row['pj'];
		break;		
	case "odp";
		header('Content-Type: application/vnd.oasis.opendocument.presentation');
		echo $row['pj'];
		break;
	case "odt";
		header('Content-Type: application/vnd.oasis.opendocument.text');
		echo $row['pj'];
		break;
	case "ods";
		header('Content-Type: application/vnd.oasis.opendocument.spreadsheet');
		echo $row['pj'];
		break;		
	case "doc";
		header('Content-Type: application/msword');
		echo $row['pj'];
		break;		
	case "xls";
		header('Content-Type: application/vnd.ms-excel');
		echo $row['pj'];
		break;		
	case "ppt";
		header('Content-Type: application/vnd.ms-powerpoint');
		echo $row['pj'];
		break;
	case "avi";
		header('Content-Type: video/x-msvideo');
		echo $row['pj'];
		break;
	case "htm":
	case "html":
		header('Content-type: text/html; charset=utf-8');
		echo $row['pj'];
		break;
	case "docx":
		header('Content-type: application/vnd.openxmlformats-officedocument.wordprocessingml.document');
		echo $row['pj'];
		break;
	case "xlsx":
		header('Content-type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
		echo $row['pj'];
		break;
/*	
 * 
 * trouvÃ© ici : http://www.bram.us/2007/05/25/office-2007-mime-types-for-iis/
 * 
.docm,application/vnd.ms-word.document.macroEnabled.12
.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document
.dotm,application/vnd.ms-word.template.macroEnabled.12
.dotx,application/vnd.openxmlformats-officedocument.wordprocessingml.template
.potm,application/vnd.ms-powerpoint.template.macroEnabled.12
.potx,application/vnd.openxmlformats-officedocument.presentationml.template
.ppam,application/vnd.ms-powerpoint.addin.macroEnabled.12
.ppsm,application/vnd.ms-powerpoint.slideshow.macroEnabled.12
.ppsx,application/vnd.openxmlformats-officedocument.presentationml.slideshow
.pptm,application/vnd.ms-powerpoint.presentation.macroEnabled.12
.pptx,application/vnd.openxmlformats-officedocument.presentationml.presentation
.xlam,application/vnd.ms-excel.addin.macroEnabled.12
.xlsb,application/vnd.ms-excel.sheet.binary.macroEnabled.12
.xlsm,application/vnd.ms-excel.sheet.macroEnabled.12
.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
.xltm,application/vnd.ms-excel.template.macroEnabled.12
.xltx,application/vnd.openxmlformats-officedocument.spreadsheetml.template
*/		
		
		
	
	default:
		echo "Pas visualisable ... $nom extension $ext";
		break;
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
