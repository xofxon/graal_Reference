<?php
function fa_ml_depot($vl_e_art_cleunik,$vl_e_depot=-1,$vl_c_broadcaster) {
  $vl_c_dico_00010=fa_recup_dico('dico_00010');
  $sql_req_depot=<<<EOT
SELECT choix_cleunik as choix_cleunik,choix_valeur_texte_01 as `depot` FROM _art_dep_emp, _choix where choix_cleunik=choix_depot and art_cleunik=$vl_e_art_cleunik 
ORDER BY 2;
EOT;
  $sql_result_depot = _graal_requete_bd($sql_req_depot);
  $vl_e_nombre_depot=mysql_num_rows($sql_result_depot);
  if ($vl_e_nombre_depot == 0){
  	$sql_req_depot=<<<EOT
SELECT choix_cleunik as choix_cleunik,choix_valeur_texte_01 as `depot` FROM _choix where choix_cleunik=-15 
ORDER BY 2;
EOT;
 	$sql_result_depot = _graal_requete_bd($sql_req_depot);
  	$vl_e_nombre_depot=mysql_num_rows($sql_result_depot);
  }
  $ml_depot="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_depot' _graal_nombre='$vl_e_nombre_depot' observes='$vl_c_broadcaster'><menupopup>";
  if ($vl_e_nombre_depot == 0){
    $ml_depot.="<menuitem value='0' id='0' _graal_cleunik='0' label='$vl_c_dico_00010' selected='true'/>";
  }
  else {
    while ($row = mysql_fetch_assoc($sql_result_depot)){
      if (($vl_e_depot!=-1)&&($row['choix_cleunik']==$vl_e_depot)) {$selected="selected='true'";}
      $ml_depot.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['depot'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['depot']))."' $selected/>";
    }
    _graal_libere_requete_bd($sql_result_depot);
  }
  $ml_depot.="</menupopup></menulist>";
  return $ml_depot;
}
function fa_ml_empla($vl_e_art_cleunik,$vl_e_empla=-1,$vl_c_broadcaster) {
  $vl_c_dico_00010=fa_recup_dico('dico_00010');
  $sql_req_depot=<<<EOT
SELECT choix_cleunik as choix_cleunik,choix_valeur_texte_01 as `empla` FROM _art_dep_emp, _choix where choix_cleunik=choix_empla and art_cleunik=$vl_e_art_cleunik 
ORDER BY 2;
EOT;
  $sql_result_depot = _graal_requete_bd($sql_req_depot);
  $vl_e_nombre_depot=mysql_num_rows($sql_result_depot);
  if ($vl_e_nombre_depot == 0){
  	$sql_req_depot=<<<EOT
SELECT choix_cleunik as choix_cleunik,choix_valeur_texte_01 as `empla` FROM _choix where choix_cleunik=-16 
ORDER BY 2;
EOT;
  	$sql_result_depot = _graal_requete_bd($sql_req_depot);
  	$vl_e_nombre_depot=mysql_num_rows($sql_result_depot);
  }
  $ml_empla="<menulist sizetopopup='none' flex='1' id='ml_empla' _graal_nombre='$vl_e_nombre_depot' observes='$vl_c_broadcaster'><menupopup>";
  if ($vl_e_nombre_depot == 0){
    $ml_empla.="<menuitem value='0' id='0' _graal_cleunik='0' label='$vl_c_dico_00010' selected='true'/>";
  }
  else {
    while ($row = mysql_fetch_assoc($sql_result_depot)){
      if (($vl_e_empla!=-1)&&($row['choix_cleunik']==$vl_e_empla)) {$selected="selected='true'";}
      $ml_empla.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['empla'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['empla']))."' $selected/>";
    }
    _graal_libere_requete_bd($sql_result_depot);
  }
  $ml_empla.="</menupopup></menulist>";
  return $ml_empla;
}
function fa_mousto_ajout() {
  global $vl_mousto_uti_cleunik;
  global $vl_mousto_int_cleunik;
  global $vl_mousto_art_cleunik;
  global $vl_mousto_blocnotebrut;
  global $vl_mousto_date_mvt;
  global $vl_mousto_choix_depot;
  global $vl_mousto_choix_empla;
  global $vl_mousto_qte_mvt;
  global $vl_mousto_pu_mvt;
  global $vl_mousto_genre_mvt;
  global $vl_mousto_type_mvt;
  global $qte_avant;

  $vl_mousto_b_transaction_ok=true;
  $vl_mousto_b_maj_stock_sur_article=true;
    //  Recherche infos article
    $sql_req = "SELECT qte_stock,unite_stock,nb_decimales_qte,dateheure_dermvt,gestion FROM _art_stock where art_cleunik=$vl_mousto_art_cleunik";
    $result = _graal_requete_bd($sql_req);
    if (mysql_num_rows($result) == 0) {
      $vl_mousto_gestion=2;$vl_mousto_unite_stock=-14;$vl_mousto_nb_decimales_qte=4;
      $sql_req="INSERT INTO _art_stock set art_cleunik=$vl_mousto_art_cleunik,gestion=$vl_mousto_gestion,unite_stock=$vl_mousto_unite_stock,nb_decimales_qte=$vl_mousto_nb_decimales_qte ;";    
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
      $vl_mousto_qte_pre=0;
      $vl_mousto_unite_mvt=$vl_mousto_unite_stock;
      $vl_mousto_dateheure_dermvt_old="";
	  $sql_req_01=$sql_req;
	  $vl_gestion_dep_emp=$vl_mousto_gestion;
    }  
    else {
      $row=mysql_fetch_assoc($result);
      $vl_mousto_qte_pre=fa_ent_xml($row['qte_stock']);
      $vl_mousto_unite_mvt=fa_ent_xml($row['unite_stock']);
      $vl_mousto_nb_decimales_qte=fa_ent_xml($row['nb_decimales_qte']);
      $vl_mousto_dateheure_dermvt_old=fa_ent_xml($row['dateheure_dermvt']);
      $vl_gestion_dep_emp=fa_ent_xml($row['gestion']);
    }
    _graal_libere_requete_bd($result);
    if ($vl_gestion_dep_emp==1){
	//  Recherche infos dépot emplacement
	    $sql_req = "SELECT art_depemp_cleunik FROM _art_dep_emp where art_cleunik=$vl_mousto_art_cleunik and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla;";
	    $result = _graal_requete_bd($sql_req);
	    if (mysql_num_rows($result) == 0) {
	    	$vl_art_depemp_cleunik=_graal_requete_max("art_depemp_cleunik","_art_dep_emp");
	      $sql_req="INSERT INTO _art_dep_emp set art_cleunik=$vl_mousto_art_cleunik,choix_depot=$vl_mousto_choix_depot,choix_empla=$vl_mousto_choix_empla,qte_stock=0,qte_inven=0;";    
	      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
		  $sql_req_01_bis=$sql_req;
	    }
	    _graal_libere_requete_bd($result);  
    }
    //  Recherche dernier mouvement de stock avant la date du mouvement actuel
    $sql_req="select qte_pos from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and dateheuremvt <= '$vl_mousto_date_mvt' and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla order by dateheuremvt desc limit 1";
    // select * from _mouvements_stock where art_cleunik=10000821 and dateheuremvt <= '2003-12-31 13:00:17' order by dateheuremvt desc limit 1
    //  Récupération du stock à cet instant pour qu'il serve de base au nouvel enregistrement
    $result = _graal_requete_bd($sql_req);
    if (mysql_num_rows($result) == 0) {
      $vl_mousto_qte_pos=0;
    }  
    else {
      $row=mysql_fetch_assoc($result);
      $vl_mousto_qte_pos=fa_ent_xml($row['qte_pos']);
      _graal_libere_requete_bd($result);
    }
	$sql_req_02=$sql_req;
    switch ($vl_mousto_type_mvt) {
      case 1:$vl_mousto_qte_pos+=$vl_mousto_qte_mvt;$vl_mousto_e_coeff=1;break;//  Entrée
      case 2:$vl_mousto_qte_pos-=$vl_mousto_qte_mvt;$vl_mousto_e_coeff=-1;break;//  Sortie 
      case 3:$vl_mousto_qte_pos=$vl_mousto_qte_mvt;$vl_mousto_e_coeff=1;break;//  Inventaire
    }
    //  Insertion mouvement de stock
    $vl_mousto_mvt_cleunik=_graal_requete_max_particuliere("mvt_cleunik","_mouvements_stock");
    $sql_req = "INSERT INTO _mouvements_stock set mvt_cleunik=$vl_mousto_mvt_cleunik,art_cleunik=$vl_mousto_art_cleunik,uti_cleunik=$vl_mousto_uti_cleunik,int_cleunik=$vl_mousto_int_cleunik,dateheuremvt='$vl_mousto_date_mvt',dateheuresaisie=now(),choix_depot=$vl_mousto_choix_depot,choix_empla=$vl_mousto_choix_empla,qte_mvt=$vl_mousto_qte_mvt,qte_pos=$vl_mousto_qte_pos,unite_mvt=$vl_mousto_unite_mvt,genre_mvt=$vl_mousto_genre_mvt,type_mvt=$vl_mousto_type_mvt,pu_mvt=$vl_mousto_pu_mvt,blocnotebrut='$vl_mousto_blocnotebrut';";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
    $sql_req_03=$sql_req;
    
    //  Recherche de toutes les écritures, postérieures à celle qui vient d'être saisie
    $sql_req="select type_mvt,mvt_cleunik,qte_pos from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and dateheuremvt > '$vl_mousto_date_mvt' and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla order by dateheuremvt asc";
    $result = _graal_requete_bd($sql_req);
	$sql_req_04=$sql_req;
	$vl_der_mvt_cleunik=-1;
    while ($row = mysql_fetch_assoc($result)) {
      switch ($row['type_mvt']) {
        case 1://  Entrée
        case 2://  Sortie
          $sql_req_b1="UPDATE _mouvements_stock set qte_pos=qte_pos+($vl_mousto_qte_mvt*$vl_mousto_e_coeff) where mvt_cleunik=".$row['mvt_cleunik'];
          $vl_der_mvt_cleunik=$row['mvt_cleunik'];
		  $sql_req_05.=$sql_req_b1.EOL;
          $vf_c_echo=_graal_exec_requete($sql_req_b1);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req_b1.EOL;}
      	  
          
          break;
        case 3://  Inventaire -> on arrête le parcours (2 indique le nombre de structures imbriquées que l'on quitte
        	$vl_mousto_b_maj_stock_sur_article=false;
        	break 2;//  Inventaire -> on arrête le parcours (2 indique le nombre de structures imbriquées que l'on quitte
      }
    }
    _graal_libere_requete_bd($result);
    if ($vl_mousto_b_maj_stock_sur_article==true) {
      if ($vl_mousto_date_mvt>$vl_mousto_dateheure_dermvt_old) {
        $vl_mousto_dateheure_dermvt_new=$vl_mousto_date_mvt;
      } else {
        $vl_mousto_dateheure_dermvt_new=$vl_mousto_dateheure_dermvt_old;
      }
      switch ($vl_mousto_type_mvt) {
        case 1://  Entrée
        	$sql_req="UPDATE _art_stock set dateheure_dermvt='$vl_mousto_dateheure_dermvt_new',qte_stock=coalesce(qte_stock,0)+$vl_mousto_qte_mvt,cumul_entrees=coalesce(cumul_entrees,0)+$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik;";
      		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur modif ".$sql_req.EOL;}
      		$sql_req_06=$sql_req;
      		$sql_req="UPDATE _art_dep_emp set qte_stock=coalesce(qte_stock,0)+$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla;";
      		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur modif ".$sql_req.EOL;}
        	$sql_req_07=$sql_req;
      		break;
        case 2://  Sortie 
        	$sql_req="UPDATE _art_stock set dateheure_dermvt='$vl_mousto_dateheure_dermvt_new',qte_stock=coalesce(qte_stock,0)-$vl_mousto_qte_mvt,cumul_sorties=coalesce(cumul_sorties,0)+$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik;";
      		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
      		$sql_req_06=$sql_req;
      		$sql_req="UPDATE _art_dep_emp set qte_stock=coalesce(qte_stock,0)-$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla;";
      		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur modif ".$sql_req.EOL;}
        	$sql_req_07=$sql_req;
      		break;
        case 3://  Inventaire
        	
        	$sql_req="UPDATE _art_stock set qte_inven=$vl_mousto_qte_mvt,dateheure_invent='$vl_mousto_date_mvt' where art_cleunik=$vl_mousto_art_cleunik;";
      		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
      		$sql_req_06=$sql_req;
      		$sql_req="UPDATE _art_dep_emp set qte_inven=$vl_mousto_qte_mvt,dateheure_invent='$vl_mousto_date_mvt' where art_cleunik=$vl_mousto_art_cleunik and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla;";
      		$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur modif ".$sql_req.EOL;}
        	$sql_req_07=$sql_req;
      		if ($vl_mousto_date_mvt>$vl_mousto_dateheure_dermvt_old) {
      			$sql_req="UPDATE _art_dep_emp set qte_stock=$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla;";
      			$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur modif ".$sql_req.EOL;}
        		$sql_req_08=$sql_req;
      		} else {
      			if ($vl_der_mvt_cleunik!=-1) {
		    		$sql_req="UPDATE _art_dep_emp f1, _mouvements_stock f2 set f1.qte_stock=f2.qte_pos where f1.art_cleunik=$vl_mousto_art_cleunik and f1.choix_depot=$vl_mousto_choix_depot and f1.choix_empla=$vl_mousto_choix_empla and f2.mvt_cleunik=$vl_der_mvt_cleunik;";
      				$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
      				$sql_req_11=$sql_req;
		    	}
      		}
        	$sql_req="select count(*) as nombre,sum(qte_stock) as stock from _art_dep_emp where art_cleunik=$vl_mousto_art_cleunik;";
    		$result = _graal_requete_bd($sql_req);
			$sql_req_09=$sql_req;
			$row = mysql_fetch_assoc($result);
		    if ($row['nombre']!=0) {
		    	$nouveau_stock=$row['stock'];
		        $sql_req="UPDATE _art_stock set qte_stock=$nouveau_stock where art_cleunik=$vl_mousto_art_cleunik;";
      			$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
      			$sql_req_10=$sql_req;
		    } else {
		    	if ($vl_der_mvt_cleunik!=-1) {
		    		$sql_req="UPDATE _art_stock f1, _mouvements_stock f2 set f1.qte_stock=f2.qte_pos where f1.art_cleunik=$vl_mousto_art_cleunik and f2.mvt_cleunik=$vl_der_mvt_cleunik;";
      				$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
      				$sql_req_11=$sql_req;
		    	}
		    }
		    _graal_libere_requete_bd($result);
      		break;
      }
    }  
    
  /*
    //  Mise à jour information article
    $vl_mousto_nouveau_stock=$vl_mousto_qte_mvt;  //pour l'instant pas de recalcul en fonction d'éventuels mouvement "parasites"
    $sql_req="UPDATE _art_stock set qte_inven=$vl_mousto_qte_mvt,dateheure_invent='$vl_mousto_dateheuremvt',qte_stock=$vl_mousto_nouveau_stock where art_cleunik=$vl_mousto_art_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur update ".$sql_req.EOL;}
  */
   /* 
  echo "sql_req_01_bis->$sql_req_01_bis".EOL;
  echo "sql_req_01->$sql_req_01".EOL;
  echo "sql_req_02->$sql_req_02".EOL;
  echo "sql_req_03->$sql_req_03".EOL;
  echo "sql_req_04->$sql_req_04".EOL;
  echo "sql_req_05->$sql_req_05".EOL;
  echo "sql_req_06->$sql_req_06".EOL;
  echo "sql_req_07->$sql_req_06".EOL;
  echo "sql_req_08->$sql_req_08".EOL;
  echo "sql_req_09->$sql_req_09".EOL;
  echo "sql_req_10->$sql_req_10".EOL;
  echo "sql_req_11->$sql_req_11".EOL;
  echo $vl_mousto_c_mess_err.EOL;
  */
  if ($vl_mousto_b_transaction_ok==false) {
    return "-1";
  } else {
    return $vl_mousto_mvt_cleunik;
  }
}
function fa_mousto_supprime($vl_mousto_mvt_cleunik) {
  $vl_mousto_b_transaction_ok=true;
  $vl_mousto_b_maj_stock_sur_article=true;
    //  Recherche du mouvement de stock
    $sql_req = "SELECT `mvt_cleunik`, `art_cleunik`, `uti_cleunik`, `int_cleunik`, `blocnotebrut`, `dateheuremvt`, `dateheuresaisie`, `choix_depot`, `choix_empla`, `qte_mvt`, `qte_pos`, `unite_mvt`, `genre_mvt`, `type_mvt`, `pu_mvt` FROM _mouvements_stock where mvt_cleunik=$vl_mousto_mvt_cleunik;";
    $result = _graal_requete_bd($sql_req);
    $_SESSION['req_01']=$sql_req;
    if (mysql_num_rows($result) == 0) {
      _graal_libere_requete_bd($result);
      return -1;
    }  
    else {
      $row=mysql_fetch_assoc($result);
      $vl_mousto_art_cleunik=fa_ent_xml($row['art_cleunik']);
      $vl_mousto_qte_mvt=fa_ent_xml($row['qte_mvt']);
      $vl_mousto_date_mvt=fa_ent_xml($row['dateheuremvt']);
      $vl_mousto_choix_depot=fa_ent_xml($row['choix_depot']);
      $vl_mousto_choix_empla=fa_ent_xml($row['choix_empla']);
      $vl_mousto_type_mvt=fa_ent_xml($row['type_mvt']);
      $vl_mousto_dateheure_dermvt_old=fa_ent_xml($row['dateheure_dermvt']);
      _graal_libere_requete_bd($result);
      $sql_req = "DELETE FROM _mouvements_stock where mvt_cleunik=$vl_mousto_mvt_cleunik;";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur sup mouvement ".$sql_req.EOL;}
      
      //$_SESSION['req_03']=$sql_req;
      switch ($vl_mousto_type_mvt) {
        case 1:$vl_mousto_e_coeff=-1;break;//  Entrée
        case 2:$vl_mousto_e_coeff=1;break;//  Sortie 
        case 3:return -1;break;//  Inventaire : on ne supprime pas une écriture d'inventaire (20/08/2008)
      }
      $sql_req="UPDATE _art_dep_emp set qte_stock=coalesce(qte_stock,0)+($vl_mousto_qte_mvt*$vl_mousto_e_coeff) where art_cleunik=$vl_mousto_art_cleunik and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla;";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur modif ".$sql_req.EOL;}
      //  Recherche de toutes les écritures, postérieures à celle qui vient d'être saisie
      $sql_req="select type_mvt,mvt_cleunik,qte_pos from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and dateheuremvt >= '$vl_mousto_date_mvt' and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla order by dateheuremvt asc";
      $result = _graal_requete_bd($sql_req);
      //$_SESSION['req_02']=$sql_req;
      while ($row = mysql_fetch_assoc($result)) {
        switch ($row['type_mvt']) {
          case 1://  Entrée
          case 2://  Sortie
            $sql_req_01="UPDATE _mouvements_stock set qte_pos=qte_pos+($vl_mousto_qte_mvt*$vl_mousto_e_coeff) where mvt_cleunik=".$row['mvt_cleunik'];
            $vf_c_echo=_graal_exec_requete($sql_req_01);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur maj sur suppression ".$sql_req_01.EOL;}
            break;
          case 3://Inventaire -> on arrête le parcours (2 indique le nombre de structures imbriquées que l'on quitte
          	$vl_mousto_b_maj_stock_sur_article=false;
          	break 2;//  Inventaire -> on arrête le parcours (2 indique le nombre de structures imbriquées que l'on quitte
        }
      }
      _graal_libere_requete_bd($result);
      if ($vl_mousto_b_maj_stock_sur_article==true) {
        $sql_req="select max(dateheuremvt) as dateheure_dermvt from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and type_mvt=$vl_mousto_type_mvt;";
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        $dateheure_dermvt=fa_nt($row['dateheure_dermvt']);
        switch ($vl_mousto_type_mvt) {
          case 1://  Entrée
          	$sql_req="UPDATE _art_stock set dateheure_dermvt=$dateheure_dermvt,qte_stock=qte_stock-$vl_mousto_qte_mvt,cumul_entrees=cumul_entrees-$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik;";
          	break;
          case 2://  Sortie
          	$sql_req="UPDATE _art_stock set dateheure_dermvt=$dateheure_dermvt,qte_stock=qte_stock+$vl_mousto_qte_mvt,cumul_sorties=cumul_sorties-$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik;";
          	break; 
        }
        $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur maj article ".$sql_req.EOL;}
      }
    }  
  if ($vl_mousto_b_transaction_ok==false) {
    return -1;
  } else {
    return $vl_mousto_mvt_cleunik;
  }
}
function fa_mousto_supprime_document($vl_mousto_mvt_cleunik,$choix_cleunik) {
	/*
	-136, 'SRECFOU', 'Suppression Réception fournisseur
	-135, 'SLIVCLI', 'Suppression Livraison client
  -134, 'SFACCLI', 'Supression Facturation client
  -133, 'SAv.', 'Suppression Avoir
	 */
  $vl_mousto_b_transaction_ok=true;
  $vl_mousto_b_maj_stock_sur_article=true;
	$vl_mousto_c_mess_err="";
    //  Recherche du mouvement de stock
    $sql_req = "SELECT `mvt_cleunik`, `art_cleunik`, `uti_cleunik`, `int_cleunik`, `blocnotebrut`, `dateheuremvt`, `dateheuresaisie`, `choix_depot`, `choix_empla`, `qte_mvt`, `qte_pos`, `unite_mvt`, `genre_mvt`, `type_mvt`, `pu_mvt` FROM _mouvements_stock where mvt_cleunik=$vl_mousto_mvt_cleunik;";
    $result = _graal_requete_bd($sql_req);
		//$vl_mousto_c_mess_err.=$sql_req;
    if (mysql_num_rows($result) == 0) {
      _graal_libere_requete_bd($result);
			return -1;
    } else {
      $row=mysql_fetch_assoc($result);
      $vl_mousto_art_cleunik=fa_ent_xml($row['art_cleunik']);
			$vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
      $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
      $vl_mousto_blocnotebrut="Suppression ".fa_ent_xml($row['blocnotebrut']);
      $vl_mousto_pu_mvt=fa_ent_xml($row['mousto_pu_mvt']);;
      $vl_mousto_qte_mvt=fa_ent_xml($row['qte_mvt']);
			$vl_mousto_qte_mvt=$vl_mousto_qte_mvt*-1;
      $vl_mousto_date_mvt=fa_ent_xml($row['dateheuremvt']);
      $vl_mousto_choix_depot=fa_ent_xml($row['choix_depot']);
      $vl_mousto_choix_empla=fa_ent_xml($row['choix_empla']);
      $vl_mousto_type_mvt=fa_ent_xml($row['type_mvt']);
			$vl_mousto_qte_pos=fa_ent_xml($row['qte_pos']);
			$vl_mousto_unite_mvt=fa_ent_xml($row['unite_mvt']);
			$vl_mousto_pu_mvt=fa_ent_xml($row['pu_mvt']);
			$vl_mousto_genre_mvt=$choix_cleunik;
			$vl_mousto_dateheure_dermvt_old=fa_ent_xml($row['dateheure_dermvt']);
      _graal_libere_requete_bd($result);
			$vl_mousto_mvt_cleunik=_graal_requete_max_particuliere("mvt_cleunik","_mouvements_stock");
			$sql_req = "INSERT INTO _mouvements_stock set mvt_cleunik=$vl_mousto_mvt_cleunik,art_cleunik=$vl_mousto_art_cleunik,uti_cleunik=$vl_mousto_uti_cleunik,int_cleunik=$vl_mousto_int_cleunik,dateheuremvt='$vl_mousto_date_mvt',dateheuresaisie=now(),choix_depot=$vl_mousto_choix_depot,choix_empla=$vl_mousto_choix_empla,qte_mvt=$vl_mousto_qte_mvt,qte_pos=$vl_mousto_qte_pos,unite_mvt=$vl_mousto_unite_mvt,genre_mvt=$vl_mousto_genre_mvt,type_mvt=$vl_mousto_type_mvt,pu_mvt=$vl_mousto_pu_mvt,blocnotebrut='$vl_mousto_blocnotebrut';";
    	$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
//$vl_mousto_c_mess_err.=$sql_req;
      switch ($vl_mousto_type_mvt) {
        case 1:$vl_mousto_e_coeff=-1;break;//  Entrée
        case 2:$vl_mousto_e_coeff=1;break;//  Sortie 
        case 3:exit;break;//  Inventaire : on ne supprime pas une écriture d'inventaire (20/08/2008)
      }
      //  Recherche de toutes les écritures, postérieures à celle qui vient d'être saisie
      $sql_req="select type_mvt,mvt_cleunik,qte_pos from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and dateheuremvt >= '$vl_mousto_date_mvt' and choix_depot=$vl_mousto_choix_depot and choix_empla=$vl_mousto_choix_empla order by dateheuremvt asc;";
      $result = _graal_requete_bd($sql_req);
//$vl_mousto_c_mess_err.=$sql_req;
      while ($row = mysql_fetch_assoc($result)) {
        switch ($row['type_mvt']) {
          case 1://  Entrée
          case 2://  Sortie
            $sql_req_01="UPDATE _mouvements_stock set qte_pos=qte_pos+($vl_mousto_qte_mvt*$vl_mousto_e_coeff) where mvt_cleunik=".$row['mvt_cleunik'].";";
						$vl_mousto_c_mess_err.=$sql_req_01;
            $vf_c_echo=_graal_exec_requete($sql_req_01);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur maj sur suppression ".$sql_req_01.EOL;}
            break;
          case 3:$vl_mousto_b_maj_stock_sur_article=false;break 2;//  Inventaire -> on arrête le parcours (2 indique le nombre de structures imbriquées que l'on quitte
        }
      }
      _graal_libere_requete_bd($result);
      if ($vl_mousto_b_maj_stock_sur_article==true) {
        $sql_req="select max(dateheuremvt) as dateheure_dermvt from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and type_mvt=$vl_mousto_type_mvt;";
				$vl_mousto_c_mess_err.=$sql_req;
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        $dateheure_dermvt=fa_nt($row['dateheure_dermvt']);
        switch ($vl_mousto_type_mvt) {
          case 1:$sql_req="UPDATE _art_stock set dateheure_dermvt=$dateheure_dermvt,qte_stock=qte_stock-$vl_mousto_qte_mvt,cumul_entrees=cumul_entrees-$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik;";break;//  Entrée
          case 2:$sql_req="UPDATE _art_stock set dateheure_dermvt=$dateheure_dermvt,qte_stock=qte_stock+$vl_mousto_qte_mvt,cumul_sorties=cumul_sorties-$vl_mousto_qte_mvt where art_cleunik=$vl_mousto_art_cleunik;";break;//  Sortie 
        }
        $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur maj article ".$sql_req.EOL;}
				//$vl_mousto_c_mess_err.=$sql_req;
      }
    }
	return $vl_mousto_c_mess_err;
	/*	
  if ($vl_mousto_b_transaction_ok==false) {
    return -1;
  } else {
    return $vl_mousto_mvt_cleunik;
  }
  */
}
?>
