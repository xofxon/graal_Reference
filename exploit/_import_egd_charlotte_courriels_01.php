<?php
/*
 * http://localhost/graal/exploit/_import_egd_charlotte_courriels_01.php
 * https://egdiffusion.xsoftware.fr/2c760b07-4c7a-402f-b015-d2ca450b9b0c/graal/exploit/_import_egd_charlotte_courriels_01.php
 */
include("_graal_header_txt.inc.php");
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','egdiffusion');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_egdiffusion');
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vf_e_typeacteur=110001;
include("_import_class_data_km.php");
$sql_req = "SELECT distinct(Champ1) as adresse_courriel FROM $vl_c_base_origine.a_travailler_charlotte a ";
$sql_req.= " union all ";
$sql_req.= " SELECT distinct(Champ1) as adresse_courriel FROM $vl_c_base_origine.autres_prospects_charlotte";
$sql_req.= " union all ";
$sql_req.= " SELECT distinct(Champ1) as adresse_courriel FROM $vl_c_base_origine.autres_prospects_charlotte";
$sql_req.= " union all ";
$sql_req.= " SELECT distinct(Champ1) as adresse_courriel FROM $vl_c_base_origine.prospects_charlotte";
$result = _graal_requete_bd($sql_req);
$o_web=new _graal_import();
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
$vf_e_act_cleunik=10000001;
$vf_e_int_cleunik=10000001;
$vl_e_mail_defaut=-11;
echo $sql_req.EOL;
while ($row = mysql_fetch_assoc($result)) {
    $vl_c_chaine=trim($row['adresse_courriel']);
    //  On ajoute uniquement si le mail de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vf_e_intweb_cleunik++;
      $refweb=addslashes($row['adresse_courriel']);
      echo $refweb.EOL;
      flush();
      $uuid=_graal_requete_uuid();
      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
    }
  if ($i % $i1==0){
    $o_web->execute();
  }
}
$o_web->execute();
_graal_libere_requete_bd($result);
echo("$i courriels importés.");
?>
