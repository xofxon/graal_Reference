<?php
include("_graal_header_pdf_02.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_numerotation.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
include("_graal_fonctions_documents.php");
include("_graal_fonctions_documents_ciaux.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik","0"));
$vl_e_action_cleunik=intval(fa_recup_param("vl_e_action_cleunik","0"));
$genre_adresse=intval(fa_recup_param("vl_genre_adresse","1"));  // 1-> adresse de livraison, 2 adresse de facturation 
if ($vl_commercial_cleunik==0) {fa_redirige("acces_interdit");}
$param_generaux_graal_006=intval(fa_recup_session('vs_param_generaux_graal_006',2)); //  1->mémoriser le pdf dans le fichier, 2->ne pas le mémoriser dans le fichier
$param_generaux_graal_023=intval(fa_recup_session('vs_param_generaux_graal_023',2)); //  Identifiant document CGV
$param_generaux_graal_026=intval(fa_recup_session('vs_param_generaux_graal_026',-1)); //  Mode d'édition des CGV (Conditions générales de vente)
$param_generaux_graal_051=intval(fa_recup_session('vs_param_generaux_graal_051',-1)); //  Logo sur la première page d'édition
$param_generaux_graal_052=intval(fa_recup_session('vs_param_generaux_graal_052',-1)); //  Logo sur les autres pages d'adition
$param_generaux_graal_063=intval(fa_recup_session('vs_param_generaux_graal_063',0)); //  Largeur logo première page
$param_generaux_graal_064=intval(fa_recup_session('vs_param_generaux_graal_064',0)); //  Hauteur logo première page
$param_generaux_graal_065=intval(fa_recup_session('vs_param_generaux_graal_065',0)); //  Largeur logo autres pages
$param_generaux_graal_066=intval(fa_recup_session('vs_param_generaux_graal_066',0)); //  Hauteur logo autres pages
$vl_c_fic_ligne="_offcli_lignes";
$vl_c_fic_qte="_offcli_lignes_qte";
$vl_c_fic_entete="_offcli_entetes";
$vl_e_fic_adresses="_offcli_adresses";
$genreaction="offcli";
$vl_c_id_fenetre="Edi_00040";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_b_acces=$vl_tb_droits[0];
if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_dico_00058=fa_recup_dico("dico_00058");
$police_du_document="FreeSerif";	// Il faut intégrer la police : 819.5 Ko
$police_du_document="Courier";		//	Police non intégrée : 3.6 Ko
$police_du_document="times";		//	Police non intégrée : 3.5 Ko	Pas de différence visuelle avec FreeSerif

$genreregroupement="initial";
include("_graal_req_docial_recap_montants.inc.php");
require_once('_graal_pdf_bloc_001.php');
define('EOL', "\r\n");
class pseudo extends _graal_TCPDF {
function Header() {}
}
class toto extends _graal_TCPDF {
// private variables
var $contenu_code;
var $contenu_nom_commercial;
var $contenu_dateexp;
var $contenu_code_bondepreparation;
var $impression_cgv;
function Header() {
  global $vl_commercial_cleunik;
  global $genre_adresse;
  global $action_cleunik;
  global $datecre;
  global $dateliv;
  global $codealphanum15;
  global $description_reg;
  global $vosreferences;
  global $blocnotebrut_entete;
  global $y;
  global $cols;
  
  global $format;
  global $cols_01;
  global $format_01;
  global $nbligne_montant_pied;
  global $hauteur_blocnote_pied;
	global $raisonsoc;
	global $vl_e_fic_adresses;
	global $param_generaux_graal_051;
	global $param_generaux_graal_052;	
	global $param_generaux_graal_063;
	global $param_generaux_graal_064;
	global $param_generaux_graal_065;
	global $param_generaux_graal_066;
	
	$vl_c_bvj_100=fa_recup_dico_telquel("bvj_100");
	$vl_c_bvj_101=fa_recup_dico_telquel("bvj_101");
	$vl_c_bvj_102=fa_recup_dico_telquel("bvj_102");
	$vl_c_bvj_103=fa_recup_dico_telquel("bvj_103");
	$vl_c_bvj_104=fa_recup_dico_telquel("bvj_104");
	$vl_c_bvj_105=fa_recup_dico_telquel("bvj_105");
	$vl_c_bvj_106=fa_recup_dico_telquel("bvj_106");
	$vl_c_bvj_107=fa_recup_dico_telquel("bvj_107");
	$vl_c_bvj_108=fa_recup_dico_telquel("bvj_108");
	$vl_c_bvj_109=fa_recup_dico_telquel("bvj_109");
	$vl_c_bvj_110=fa_recup_dico_telquel("bvj_110");
	
  switch ($this->getPage()) {
    case 1:
	  $this->_graal_logo($param_generaux_graal_051,10,6,$param_generaux_graal_063,$param_generaux_graal_064);
      $this->SetFont( $this->police_du_document, "BIU",13);
      $this->SetXY(75,75);$this->MultiCell(0, 4, $vl_c_bvj_100,0,'L');
      $this->SetFont( $this->police_du_document, "",10);
      $this->SetXY(110,82);$this->MultiCell(0, 4, "$vl_c_bvj_102 $datecre",0,'L');
      $this->SetFont($this->police_du_document, "",10);
      /*
      	
			//  Recherche interlocuteur privilégié d'offre, de commande, de livraison, de raception, de facture ... selon le document
			// Recherche adresse de livraison ou de facturation, selon $genre_adresse
			//  Impression du bloc note entête
			//  Entête du tableau
		*/	
      		$interlo_privilegie=-110419;
			$y=$this->getY();
			$ref_col01=array("$vl_c_bvj_105","$vl_c_bvj_106","$vl_c_bvj_103","$vl_c_bvj_104");
			$cols01=array($ref_col01[ 0]=>20, $ref_col01[ 1]=>23,$ref_col01[ 2]=>57,$ref_col01[ 3]=>90);
			$format01=array($ref_col01[ 0]=>"C",$ref_col01[ 1]=>"C",$ref_col01[ 2]=>"C",$ref_col01[ 3]=>"C");
		  	$fonts01=array($ref_col01[ 0]=>array($police_du_document,"","8"), $ref_col01[ 1]=>array($police_du_document,"","8"),$ref_col01[ 2]=>array($police_du_document,"","8"),$ref_col01[ 3]=>array($police_du_document,"","8"));
  			$type01=array($ref_col01[ 0]=>"Texte",$ref_col01[ 1]=>"Texte",$ref_col01[ 2]=>"Texte",$ref_col01[ 3]=>"Texte");
    		$line01 = array($ref_col01[ 0]=>$this->contenu_code,$ref_col01[ 1]=>$datecre,$ref_col01[ 2]=>$description_reg,$ref_col01[ 3]=>$vosreferences);
    		$y=90;
    		$this->addCols_03( $cols01,$xyz=array(10,$y,10));
    		$this->addLineFormat_00($format01,$cols01);
    		$this->SetXY(10,100);
    		$y=97;
    		$this->addLine_00( $y, $line01,$cols01,$format01,$fonts01,$type01 );
			include("_graal_bloc_code_docciaux_06.php");
      break;
    default:
 	 if ($this->impression_cgv=="false") {
				$this->_graal_logo($param_generaux_graal_052,10,6,$param_generaux_graal_065,$param_generaux_graal_066);
	     	  $this->SetFont($this->police_du_document, "",11);
			  $this->SetXY(10,80);
			  $this->MultiCell(0, 4, $blocnotebrut_entete,0,"L");
			  //  Entête du tableau
			  $this->SetFont($this->police_du_document, "",9);
			  $y=$this->getY();
			  $position_debut_lignes=round($y+10,0);
			  $this->addCols_00( $cols,$xyz=array("10",$y,40+$hauteur_blocnote_pied));
			  $this->addLineFormat_00($format,$cols);
			  $this->SetY($position_debut_lignes);
			  $y=$position_debut_lignes;
			} else {
				//	On imprime les conditions générales de vente
			}
      break;
  }
}
}
$sql_req="SELECT f1.blocnotebrut,f1.code_interne,f1.mnemotechnique_interne as z06,f1.description_interne,f4.qte,f4.qte_nbdec,f4.qte_unite as z10,f1.pu as pu,f1.pu_type as z12,f1.nbdec_pu,f1.remise_taux,f2.choix_valeur_texte_01 as z17,f3.choix_valeur_texte_01 as z18,f1.typeligne as z19,f1.coef_facture as coef_facture,f1.remise_genr,f1.remise_natu,f1.remise_type,$sql_htbrutremise,f5.code from _offcli_lignes f1,_choix f2,_choix f3,_offcli_lignes_qte f4,_param_taxes f5 WHERE commercial_cleunik=$vl_commercial_cleunik and f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f2.choix_cleunik = qte_unite and f3.choix_cleunik=statut and f5.taxes_cleunik=f1.taxes_cleunik order by f1.ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
if (mysql_num_rows($result)==0) {
  //  Rien à éditer
  $pdf = new _graal_TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pdf->_graal_pf_rai(); 
} else {
  //  Recherche informations entête
  //  Recherche du nombre de remises de lignes pour déterminer l'affichage ou non de la colonne  
  //  Recherche du nombre de taux de taxes différents pour déterminer l'affichage ou non de la colonne  
	include("_graal_bloc_code_docciaux_03.php");
  //  Calcul du nombre de lignes de montants dans le pied
	include("_graal_bloc_code_docciaux_montants_pied_doc.php");
  $pseudo_pdf = new pseudo(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pseudo_pdf->Open();
  $pseudo_pdf->SetFont($police_du_document, "", 9);  //  Police utilisée pour les lignes
  if (trim($blocnotebrut_pied)!="") {
    $hauteur_blocnote_pied=round($pseudo_pdf->_graal_hauteur_00( $y=0, $blocnotebrut_pied,$x=10,$pos=2,array( "FreeSerif", "", 9)),0);
  } else {
    $hauteur_blocnote_pied=0;
  }
  //  S'il y a 2 lignes de montants, le pied peut commencer à 270
  $position_pied=250;
  if ($nbligne_montant_pied>2) {
    $position_pied=$position_pied-(($nbligne_montant_pied-2)*5);
  }
  $position_pied-=$hauteur_blocnote_pied;
  $pdf = new toto(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
  // set document information
  $pdf->SetCreator(PDF_CREATOR);
  //$pdf->SetProtection(array('print'));  //  On protège le document : seule l'impression est autorisée. 
  /*
   * le 27 août 2009 -> ne plus utiliser la protection, sinon on ne peut rien faire avec le document via le programme pdftk
   */
  //$pdf->setPrintHeader(false);
  $pdf->setPrintFooter(false);  //  Définir ce que l'on mettra dans le pied
  $pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
  //set auto page breaks
  //$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
  $pdf->SetAutoPageBreak(TRUE, 10);
  $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
  //$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
  $pdf->SetFooterMargin(5);
//  $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
//  $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
  $pdf->SetLineWidth(0.03);  //  Cadre invisible
  $pdf->AliasNbPages("nombredepages");
  $pdf->contenu_code=$code;
  $pdf->contenu_dateexp=$dateexp;
  
  
  $vl_c_bvj_124=fa_recup_dico_telquel("bvj_124");
  $vl_c_bvj_125=fa_recup_dico_telquel("bvj_125");
  $vl_c_bvj_126=fa_recup_dico_telquel("bvj_126");
  $vl_c_bvj_127=fa_recup_dico_telquel("bvj_127");
  
  $ref_col=array($vl_c_bvj_124,$vl_c_bvj_126,$vl_c_bvj_127,$vl_c_bvj_125);
  $cols=array($ref_col[ 0]=>102, $ref_col[ 1]=>26,$ref_col[ 2]=>27,$ref_col[ 3]=>35);
  $format=array($ref_col[ 0]=>"L",$ref_col[ 1]=>"C",$ref_col[ 2]=>"R",$ref_col[ 3]=>"R");
  $fonts=array($ref_col[ 0]=>array($police_du_document,"","9"), $ref_col[ 1]=>array($police_du_document,"B","9"),$ref_col[ 2]=>array($police_du_document,"","9"),$ref_col[ 3]=>array($police_du_document,"","9"));
  $type=array($ref_col[ 0]=>"Texte",$ref_col[ 1]=>"Texte",$ref_col[ 2]=>"Texte",$ref_col[ 3]=>"Texte");
  
	$pdf->impression_cgv="false";
  $pdf->AddPage();
  //	Impression du corps de la page : modele 6 : Quantité, Désignation,PU, montant
	include('_graal_bloc_code_docciaux_impression_corpus_doc_10.php');
  //  Fin de document
  include("_graal_bloc_code_docciaux_impression_pied_doc_05.php");
  fa_fin_creation_offcli();
}
?>
