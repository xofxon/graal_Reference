<?php 
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_droits_fenetres_01";
$t_origines_ok[1]="_graal_fen_droits_traitements_01";
fa_acces_script();
$vl_e_mini=intval(fa_recup_session('borne_mini','0'));
$vl_e_maxi=intval(fa_recup_session('borne_maxi','0'));
$vf_c_action=fa_recup_param('vf_c_action','??????');
$vl_e_fen_cleunik=intval(fa_recup_param('vl_e_fen_cleunik','0'));
$vl_e_uti_cleunik=intval(fa_recup_param('vl_e_uti_cleunik','0'));
$vl_e_duf_cleunik=intval(fa_recup_param('vl_e_duf_cleunik','0'));
$vl_e_uti_cleunik_ori=intval(fa_recup_param('vl_e_uti_cleunik_ori','0'));
$vl_e_acces=intval(fa_recup_param('vl_e_acces','0'));
$vl_e_ajout=intval(fa_recup_param('vl_e_ajout','0'));
$vl_e_modif=intval(fa_recup_param('vl_e_modif','0'));
$vl_e_suppr=intval(fa_recup_param('vl_e_suppr','0'));
$vl_e_type=intval(fa_recup_param('vl_e_type','0'));
$vl_t_fen_cleunik=fa_recup_param("vl_t_fen_cleunik","");
$vf_c_echo='';
switch (TRUE) {
  case $vf_c_action=='??????':
    exit;
    break;
  case $vf_c_action=='tout_supprimer':
    $sql_req = "DELETE FROM _droits_uti_fen WHERE _droits_uti_fen.uti_cleunik=$vl_e_uti_cleunik and _droits_uti_fen.fen_cleunik in (select _objets.fen_cleunik from _objets WHERE _objets.type_objet=$vl_e_type)";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='supprimer': 
    $sql_req = "DELETE FROM _droits_uti_fen WHERE _droits_uti_fen.duf_cleunik = $vl_e_duf_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='ajouter':
    $vl_e_duf_cleunik=_graal_requete_max("duf_cleunik","_droits_uti_fen");
    $sql_req = "INSERT INTO _droits_uti_fen set fen_cleunik=$vl_e_fen_cleunik,uti_cleunik=$vl_e_uti_cleunik,duf_cleunik=$vl_e_duf_cleunik,duf_acces=$vl_e_acces,duf_ajout=$vl_e_ajout,duf_modif=$vl_e_modif,duf_suppr=$vl_e_suppr";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='modifier':
    $sql_req = "update _droits_uti_fen set duf_acces=$vl_e_acces,duf_ajout=$vl_e_ajout,duf_modif=$vl_e_modif,duf_suppr=$vl_e_suppr WHERE _droits_uti_fen.duf_cleunik=$vl_e_duf_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="ajouter_kilometre":
    $vl_t_fen_cleunik=unserialize(stripslashes($vl_t_fen_cleunik));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_t_fen_cleunik as $vl_raf) {
      $vl_e_i++;
      $vl_e_fen_cleunik=$vl_t_fen_cleunik[$vl_e_i];
      $sql_req = "SELECT _objets.fen_acces as fen_acces,_objets.fen_ajout as fen_ajout,_objets.fen_modif as fen_modif,_objets.fen_suppr as fen_suppr FROM _objets where _objets.fen_cleunik=$vl_e_fen_cleunik";
      $result = _graal_requete_bd($sql_req);
      $row = mysql_fetch_assoc($result);
      $vl_e_acces=$row['fen_acces'];
      $vl_e_ajout=$row['fen_ajout'];
      $vl_e_modif=$row['fen_modif'];
      $vl_e_suppr=$row['fen_suppr'];
      $vl_e_duf_cleunik=_graal_requete_max("duf_cleunik","_droits_uti_fen");
      $sql_req = "INSERT INTO _droits_uti_fen set fen_cleunik=$vl_e_fen_cleunik,uti_cleunik=$vl_e_uti_cleunik,duf_cleunik=$vl_e_duf_cleunik,duf_acces=$vl_e_acces,duf_ajout=$vl_e_ajout,duf_modif=$vl_e_modif,duf_suppr=$vl_e_suppr";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    }
    if ($vl_b_transaction_ok==false) {$vf_c_echo='Les ajouts ont échoué.'.$vl_c_mess_err;} else {$vf_c_echo='ok';}
    break;
} 
_graal_ferme_connexion();
echo $vf_c_echo;
       
?>
