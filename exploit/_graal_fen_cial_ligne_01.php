<?php
include("_graal_header_xul.inc.php");
include("_graal_fonctions_mousto.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$vl_e_uti_cleunik=intval(fa_recup_session("vs_uti_cleunik","0"));
$commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik","0"));if ($commercial_cleunik==0) {fa_redirige("acces_interdit");}
$commercial_ligne_cleunik=intval(fa_recup_param("commercial_ligne_cleunik","0"));
$vl_c_genreaction=fa_recup_param('genreaction','generique');
$vl_c_specificite=fa_recup_param('vl_c_specificite','');
switch ($vl_c_genreaction) {
  case "offcli";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_offcli_lignes";$vl_c_fic_qte="_offcli_lignes_qte";$vl_c_fic_entete="_offcli_entetes";$vl_c_id_fenetre="Fen_00704";break;
  case "cdecli";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_cdecli_lignes";$vl_c_fic_qte="_cdecli_lignes_qte";$vl_c_fic_entete="_cdecli_entetes";$vl_c_id_fenetre="Fen_00705";break;
  case "livcli";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_livcli_lignes";$vl_c_fic_qte="_livcli_lignes_qte";$vl_c_fic_entete="_livcli_entetes";$vl_c_id_fenetre="Fen_00706";break;
  case "faccli";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_faccli_lignes";$vl_c_fic_qte="_faccli_lignes_qte";$vl_c_fic_entete="_faccli_entetes";$vl_c_id_fenetre="Fen_00707";break;
  case "avocli";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_avocli_lignes";$vl_c_fic_qte="_avocli_lignes_qte";$vl_c_fic_entete="_avocli_entetes";$vl_c_id_fenetre="Fen_00735";break;
  case "retcli";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_retcli_lignes";$vl_c_fic_qte="_retcli_lignes_qte";$vl_c_fic_entete="_retcli_entetes";$vl_c_id_fenetre="Fen_01110";break;
  case "avofin";$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_avocli_lignes";$vl_c_fic_qte="_avocli_lignes_qte";$vl_c_fic_entete="_avocli_entetes";$vl_c_id_fenetre="Fen_00735";break;
  case "demfou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_demfou_lignes";$vl_c_fic_qte="_demfou_lignes_qte";$vl_c_fic_entete="_demfou_entetes";$vl_c_id_fenetre="Fen_00708";break;
  case "cdefou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_cdefou_lignes";$vl_c_fic_qte="_cdefou_lignes_qte";$vl_c_fic_entete="_cdefou_entetes";$vl_c_id_fenetre="Fen_00709";break;
  case "recfou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_recfou_lignes";$vl_c_fic_qte="_recfou_lignes_qte";$vl_c_fic_entete="_recfou_entetes";$vl_c_id_fenetre="Fen_00710";break;
  case "facfou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_facfou_lignes";$vl_c_fic_qte="_facfou_lignes_qte";$vl_c_fic_entete="_facfou_entetes";$vl_c_id_fenetre="Fen_00711";break;
  case "retfou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_retfou_lignes";$vl_c_fic_qte="_retfou_lignes_qte";$vl_c_fic_entete="_retfou_entetes";$vl_c_id_fenetre="Fen_01111";break;
  case "relfou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_relfou_lignes";$vl_c_fic_qte="_relfou_lignes_qte";$vl_c_fic_entete="_relfou_entetes";$vl_c_id_fenetre="Fen_01136";break;
  case "avofou";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_avofou_lignes";$vl_c_fic_qte="_avofou_lignes_qte";$vl_c_fic_entete="_avofou_entetes";$vl_c_id_fenetre="Fen_01141";break;
  case "avofif";$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_avofou_lignes";$vl_c_fic_qte="_avofou_lignes_qte";$vl_c_fic_entete="_avofou_entetes";$vl_c_id_fenetre="Fen_01141";break;
  default:fa_redirige("acces_interdit");break;
}
switch ($vl_c_specificite) {
	case "livcli_partielle":$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_cdecli_lignes";$vl_c_fic_qte="_cdecli_lignes_qte";$vl_c_fic_entete="_livcli_entetes";break;
	case "recfou_partielle":$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_cdefou_lignes";$vl_c_fic_qte="_cdefou_lignes_qte";$vl_c_fic_entete="_recfou_entetes";break;	
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_b_acces=$vl_tb_droits[0];if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$param_generaux_graal_179=intval(fa_recup_session('vs_param_generaux_graal_179','2'));
$vl_c_bpj_100=fa_recup_dico("bpj_100");
$vl_c_bpj_101=fa_recup_dico("bpj_101");
$vl_c_bpj_102=fa_recup_dico("bpj_102");
$vl_c_bpj_103=fa_recup_dico("bpj_103");
$vl_c_bpj_104=fa_recup_dico("bpj_104");
$vl_c_bpj_105=fa_recup_dico("bpj_105");
$vl_c_bpj_106=fa_recup_dico("bpj_106");
$vl_c_bpj_107=fa_recup_dico("bpj_107");
$vl_c_bpj_108=fa_recup_dico("bpj_108");
$vl_c_bpj_109=fa_recup_dico("bpj_109");
$vl_c_bpj_110=fa_recup_dico("bpj_110");
$vl_c_bpj_111=fa_recup_dico("bpj_111");
$vl_c_bpj_112=fa_recup_dico("bpj_112");
$vl_c_bpj_113=fa_recup_dico("bpj_113");
$vl_c_bpj_114=fa_recup_dico("bpj_114");
$vl_c_bpj_115=fa_recup_dico("bpj_115");
$vl_c_bpj_116=fa_recup_dico("bpj_116");
$vl_c_bpj_117=fa_recup_dico("bpj_117");
$vl_c_bpj_118=fa_recup_dico("bpj_118");
$vl_c_bpj_119=fa_recup_dico("bpj_119");
$vl_c_bpj_120=fa_recup_dico("bpj_120");
$vl_c_bpj_121=fa_recup_dico("bpj_121");
$vl_c_bpj_122=fa_recup_dico("bpj_122");
$vl_c_bpj_123=fa_recup_dico("bpj_123");
$vl_c_bpj_124=fa_recup_dico("bpj_124");
$vl_c_bpj_125=fa_recup_dico("bpj_125");
$vl_c_bpj_126=fa_recup_dico("bpj_126");
$vl_c_bpj_127=fa_recup_dico("bpj_127");
$vl_c_bpj_128=fa_recup_dico("bpj_128");
$vl_c_bpj_129=fa_recup_dico("bpj_129");
$vl_c_bpj_130=fa_recup_dico("bpj_130");
$vl_c_bpj_131=fa_recup_dico("bpj_131");
$vl_c_bpj_132=fa_recup_dico("bpj_132");
$vl_c_bpj_133=fa_recup_dico("bpj_133");
$vl_c_bpj_134=fa_recup_dico("bpj_134");
$vl_c_bpj_135=fa_recup_dico("bpj_135");
$vl_c_bpj_136=fa_recup_dico("bpj_136");
$vl_c_bpj_137=fa_recup_dico("bpj_137");
$vl_c_bpj_138=fa_recup_dico("bpj_138");
$vl_c_bpj_139=fa_recup_dico("bpj_139");
$vl_c_bpj_140=fa_recup_dico("bpj_140");
$vl_c_bpj_141=fa_recup_dico("bpj_141");
$vl_c_bpj_142=fa_recup_dico("bpj_142");
$vl_c_bpj_143=fa_recup_dico("bpj_143");
$vl_c_bpj_144=fa_recup_dico("bpj_144");
$vl_c_bpj_145=fa_recup_dico("bpj_145");
$vl_c_bpj_146=fa_recup_dico("bpj_146");
$vl_c_bpj_147=fa_recup_dico("bpj_147");
$vl_c_bpj_148=fa_recup_dico("bpj_148");
$vl_c_bpj_149=fa_recup_dico("bpj_149");
$vl_c_bpj_150=fa_recup_dico("bpj_150");
$vl_c_bpj_151=fa_recup_dico("bpj_151");
$vl_c_bpj_152=fa_recup_dico("bpj_152");
$vl_c_bpj_153=fa_recup_dico("bpj_153");
$vl_c_bpj_154=fa_recup_dico("bpj_154");
$vl_c_bpj_155=fa_recup_dico("bpj_155");
$vl_c_bpj_156=fa_recup_dico("bpj_156");
$vl_c_bpj_157=fa_recup_dico("bpj_157");
$vl_c_bpj_158=fa_recup_dico("bpj_158");
$vl_c_bpj_159=fa_recup_dico("bpj_159");
$vl_c_bpj_160=fa_recup_dico("bpj_160");
$vl_c_bpj_161=fa_recup_dico("bpj_161");
$vl_c_bpj_162=fa_recup_dico("bpj_162");
$vl_c_bpj_163=fa_recup_dico("bpj_163");
$vl_c_bpj_164=fa_recup_dico("bpj_164");
$vl_c_bpj_165=fa_recup_dico("bpj_165");
$vl_c_bpj_166=fa_recup_dico("bpj_166");
$vl_c_bpj_167=fa_recup_dico("bpj_167");
$vl_c_bpj_168=fa_recup_dico("bpj_168");
$vl_c_bpj_169=fa_recup_dico("bpj_169");
$vl_c_bpj_170=fa_recup_dico("bpj_170");
$vl_c_bpj_171=fa_recup_dico("bpj_171");
$vl_c_bpj_172=fa_recup_dico("bpj_172");
$vl_c_bpj_173=fa_recup_dico("bpj_173");
$vl_c_bpj_174=fa_recup_dico("bpj_174");
$vl_c_bpj_175=fa_recup_dico("bpj_175");
$vl_c_bpj_176=fa_recup_dico("bpj_176");
$vl_c_bpj_177=fa_recup_dico("bpj_177");
$vl_c_bpj_178=fa_recup_dico("bpj_178");


$vl_c_bpj_179=fa_recup_dico("bpj_179");
$vl_c_bpj_180=fa_recup_dico("bpj_180");
$vl_c_bpj_181=fa_recup_dico("bpj_181");
$vl_c_bpj_182=fa_recup_dico("bpj_182");
$vl_c_bpj_183=fa_recup_dico("bpj_183");
$vl_c_bpj_184=fa_recup_dico("bpj_184");
$vl_c_bpj_185=fa_recup_dico("bpj_185");
$vl_c_bpj_186=fa_recup_dico("bpj_186");
$vl_c_bpj_187=fa_recup_dico("bpj_187");
$vl_c_bpj_188=fa_recup_dico("bpj_188");
$vl_c_bpj_189=fa_recup_dico("bpj_189");
$vl_c_bpj_190=fa_recup_dico("bpj_190");
$vl_c_bpj_191=fa_recup_dico("bpj_191");
$vl_c_bpj_192=fa_recup_dico("bpj_192");
$vl_c_bpj_193=fa_recup_dico("bpj_193");
$vl_c_bpj_194=fa_recup_dico("bpj_194");
$vl_c_bpj_195=fa_recup_dico("bpj_195");
$vl_c_bpj_196=fa_recup_dico("bpj_196");
$vl_c_bpj_197=fa_recup_dico("bpj_197");
$vl_c_bpj_198=fa_recup_dico("bpj_198");
$vl_c_bpj_199=fa_recup_dico("bpj_199");
$vl_c_bpj_200=fa_recup_dico("bpj_200");
$vl_c_bpj_201=fa_recup_dico("bpj_201");
$vl_c_bpj_202=fa_recup_dico("bpj_202");

$vl_c_bpj_203=fa_recup_dico("bpj_203");
$vl_c_bpj_204=fa_recup_dico("bpj_204");

$vl_c_bpj_203="Dépôt";
$vl_c_bpj_204="Emplacement";


$vl_c_dico_00002=fa_recup_dico('dico_00002');
$vl_c_dico_00003=fa_recup_dico('dico_00003');
$vl_c_dico_00004=fa_recup_dico('dico_00004');
$vl_c_dico_00005=fa_recup_dico('dico_00005');
$vl_c_dico_00006=fa_recup_dico('dico_00006');
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_dico_00010=fa_recup_dico('dico_00010');
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$sql_req="SELECT a1.code as code,a2.raisonsoc as raisonsoc,a2.act_cleunik as act_cleunik,"._graalsql_date('a1.dateheureexpedition')." as dateexp,"._graalsql_time('dateheureexpedition')." as heureexp,"._graalsql_date('a1.dateheurelivraison')." as dateliv,"._graalsql_time('a1.dateheurelivraison')." as heureliv,a1.reference_acteur,a1.action_cleunik,a1.devise,a1.tarif_cleunik from $vl_c_fic_entete a1 left join _acteurs a2 using(act_cleunik) where commercial_cleunik=$commercial_cleunik;";
//die($sql_req);
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_code=fa_ent_xml($row['code']);
$vl_c_acteur=fa_ent_xml($row['raisonsoc']);
$vl_c_dateexp=$row['dateexp'];
$vl_c_dateliv=$row['dateliv'];
$date_demande=$row['dateliv'];
$vl_c_reference_acteur=fa_ent_xml($row['reference_acteur']);
$vl_c_action_cleunik=$row['action_cleunik'];

switch ($vl_c_genreaction) {
  case "offcli":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110419,$vl_c_action_cleunik);break;
  case "cdecli":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110420,$vl_c_action_cleunik);break;
  case "livcli":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110421,$vl_c_action_cleunik);break;
  case "faccli":
  case "avocli":
  case "avofin":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110422,$vl_c_action_cleunik);break;
  case "demfou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110423,$vl_c_action_cleunik);break;
  case "cdefou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110424,$vl_c_action_cleunik);break;
  case "recfou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110425,$vl_c_action_cleunik);break;
  case "facfou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110426,$vl_c_action_cleunik);break;
  case "retcli":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110440,$vl_c_action_cleunik);break;
  case "retfou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110441,$vl_c_action_cleunik);break;
  case "relfou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110442,$vl_c_action_cleunik);break;
  case "avofou":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110426,$vl_c_action_cleunik);break;
  case "avofif":$vl_c_int_privilegie_cdecli=pf_cherche_graal(-110426,$vl_c_action_cleunik);break;
  default:fa_redirige("acces_interdit");break;
}
switch ($vl_c_genreaction){
	case "avofin":
		$vl_b_cache_dates="true";
		break;
	default:
		$vl_b_cache_dates="false";
		break;
}
$act_cleunik=$row['act_cleunik'];
$vl_c_tarif_cleunik=$row['tarif_cleunik'];
$ml_devise=fa_brik_menulist_choix(xxx,5,-1,1,$row['devise'],'ml_devise',"broadcaster_02",0);
$ml_tarif_entete=fa_brik_menulist_choix(xxx,1,-1,-1,$row['tarif_cleunik'],'ml_tarif',"broadcaster_02",0); //  Tarifs clients
_graal_libere_requete_bd($result);
$vl_c_codart="";
$vl_c_desart="";
$vl_c_qte="";
if ($commercial_ligne_cleunik==0) {
  //  Nouvelle ligne
  $vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));
  $selection_article=fa_ent_xml($vl_c_xml->selection_article->attributes());
$vl_c_boutons=<<<EOT
  <hbox> 
    <button flex="1" id="bt_ajouter" label="$vl_c_dico_00002" crop="end" dir="normal" oncommand="pf_validation('enregistrer')" collapsed="true"/>
    <button flex="1" id="bt_annuler" label="$vl_c_dico_00006" crop="end" dir="normal" oncommand="pf_etat_fen('annuler');" />
    <button flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
EOT;
$bloc_choix_article=<<<EOT
  <hbox id="hb_selart" flex="1">
  <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex="1" id="selart_ml_zone" class="normal" oncommand="pf_param_choix_selart();" value="$selection_article">
    <menupopup>
      <menuitem label="$vl_c_bpj_111" value="1"/>
      <menuitem label="$vl_c_bpj_112" value="2"/>
      <menuitem label="$vl_c_bpj_113" value="3"/>
    </menupopup>
  </menulist>

  <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
    minlength="1"
    maxrows="50"
    ref="urn:suggest:values"
    label="?label"
    properties="?prop"
    issuggest="?issuggest"
     
    
    _graal_cleunik=""
    id="selart"
  />
  <button id="bt_dest_a" class="ad02 pseudo_tbb" oncommand="pf_sel_article();"/>
  </hbox>
EOT;
$vl_c_ligne_cleunik=0;
$sql_req="SELECT max(a1.ligne_cleunik)+1 as maxo FROM $vl_c_fic_ligne a1 where commercial_cleunik=$commercial_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_ligne_cleunik=$row['maxo'];
if ($vl_c_ligne_cleunik==0) {$vl_c_ligne_cleunik=1;}
$ml_unite_vente=fa_brik_menulist_choix("109",5,-1,1,'','ml_unite_vente',"broadcaster_02",'0');
$ml_unite_condi=fa_brik_menulist_choix("128",5,-1,1,'','ml_unite_condi',"broadcaster_02",'0');
$ml_statut=fa_brik_menulist_choix("129",5,-1,1,-38,'ml_statut',"broadcaster_02",-38);
$vl_c_typeligne="-";
$vl_c_coef_facture=1;
$ligne_qte_cleunik=-1;
$mvt_cleunik=-1;
$vl_c_nbdec_pu=2;
$vl_c_cache_hb_tarif_ligne="true";
$vl_c_bloc_depo_empla=<<<EOT
    <groupbox id="gp_depo_empla" orient="horizontal" collapsed="true" flex="1">
      <caption><label value="$vl_c_bpj_203/$vl_c_bpj_204"/></caption>
       <label control="la_depot" value="$vl_c_bpj_203"/>
      <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" id="ml_depot" class="normal" observes="broadcaster_02" _graal_nombre="0" flex="1">
			   <menupopup id="mp_depot">
				</menupopup>
			</menulist>
    
      <label control="la_empla" value="$vl_c_bpj_204"/>
       <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" id="ml_empla" class="normal" observes="broadcaster_02" _graal_nombre="0" flex="1">
				<menupopup id="mp_empla">
				</menupopup>
			</menulist>
    </groupbox> 
EOT;
pf_bloc_qte();
} else {
//  Ligne existante
$sql_req ="SELECT a1.ligne_cleunik,a1.art_cleunik,a1.code_interne as code_interne,a1.description_interne as description_interne,a1.code_acteur as code_acteur,";
$sql_req.=" a1.description_acteur as description_acteur,round(a1.pu,a1.nbdec_pu) as pu,a1.pu as pu_brut, a1.pu_type as pu_type,a1.nbdec_pu as nbdec_pu,";
$sql_req.=" a1.tarif_cleunik as tarif_cleunik,a1.remise_taux as remise_taux,a1.remise_type as remise_type,a1.remise_genr as remise_genr,a1.remise_natu as remise_natu,";
$sql_req.=" a1.poidsbrut as poidsbrut,a1.poidsnet as poidsnet,a1.devise as devise,a1.blocnotebrut as blocnotebrut,a1.typeligne as typeligne,a1.coef_facture";
$sql_req.=" FROM $vl_c_fic_ligne a1 where commercial_ligne_cleunik=$commercial_ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_art_cleunik=$row['art_cleunik'];
$vl_c_codart=fa_ent_xml($row['code_interne']);
$vl_c_desart=fa_ent_xml($row['description_interne']);
$vl_c_code_acteur=fa_ent_xml($row['code_acteur']);
$vl_c_desart_acteur=fa_ent_xml($row['description_acteur']);
$vl_c_pu=$row['pu'];
$vl_c_nbdec_pu=$row['nbdec_pu'];
$vl_remise_taux=$row['remise_taux'];
$vl_c_remise_type=$row['remise_type'];
$vl_c_remise_genr=$row['remise_genr'];
$vl_c_remise_natu=$row['remise_natu'];
$vl_c_tarif_cleunik=$row['tarif_cleunik'];
$vl_c_ligne_cleunik=$row['ligne_cleunik'];
$vl_c_typeligne=$row['typeligne'];
$vl_c_coef_facture=$row['coef_facture'];
$vl_c_pu_type=$row['pu_type'];
$vl_c_blocnotebrut=fa_ent_xml($row['blocnotebrut']);
_graal_libere_requete_bd($result);
/*
 * Gestion des tarifs par quantité
 */
include_once("_graal_inc_actions_js_tarifs_quantite.php");
$script_quantite=base64_encode($script_quantite);

switch ($vl_c_specificite) {
	case "livcli_partielle":
	case "recfou_partielle":
		$vl_e_nombre_quantites=0;
		break;
}
	
if ($vl_e_nombre_quantites==0){
	$vl_c_cache_hb_tarif_ligne="false";
} else {
	$vl_c_cache_hb_tarif_ligne="true";
}
switch ($vl_c_specificite) {
	case "livcli_partielle":
		//$colonne_doc_origine="a1.cdecli_ligne_qte_cleunik as ligne_doc_origine,";
		$colonne_doc_origine="ligne_qte_cleunik as ligne_doc_origine,";
	    break;
	case "recfou_partielle":
		//$colonne_doc_origine="a1.cdefou_ligne_qte_cleunik as ligne_doc_origine,";
		$colonne_doc_origine="ligne_qte_cleunik as ligne_doc_origine,";
	    break;
	default:
		switch ($vl_c_genreaction) {
			case "livcli":
				$colonne_doc_origine="a1.cdecli_ligne_qte_cleunik as ligne_doc_origine,";
	    		break;
			case "recfou":
				$colonne_doc_origine="a1.cdefou_ligne_qte_cleunik as ligne_doc_origine,";
	    		break;
			default:
				$colonne_doc_origine="-1 as ligne_doc_origine,";
		}
	    break;
}
switch ($vl_c_specificite) {
	case "livcli_partielle":
	case "recfou_partielle":
	    $sql_req ="SELECT a1.commercial_ligne_cleunik,a1.ligne_cleunik,a1.qte as qte_brut,a1.qte_unite,a1.qte_nbdec,round(a1.qte,a1.qte_nbdec) as qte,date(a1.dateheure_demande) as date_demande,";
	    $sql_req.=" a1.dateheure_demande as dateheure_demande_brut,a1.dateheure_confirm,a1.statut,a1.unite_condi,$colonne_doc_origine";
		$sql_req.=" a1.qte_condi,a1.nb_stock_in_condi,a1.choix_depot,a1.choix_empla,a2.gestion as gestion_depot_empla,a1.ligne_qte_cleunik,-1 as mvt_cleunik FROM $vl_c_fic_ligne a0 ";
		$sql_req.=" left join $vl_c_fic_qte a1 using (commercial_ligne_cleunik) left join _art_stock a2 using(art_cleunik) where a1.commercial_ligne_cleunik=$commercial_ligne_cleunik;";
	    break;
	default:
		switch ($vl_c_genreaction) {
		  case "offcli":
		  case "cdecli":
		  case "demfou":
		  case "cdefou":
		  case "relfou":
		    $sql_req ="SELECT a1.commercial_ligne_cleunik,a1.ligne_cleunik,a1.qte as qte_brut,a1.qte_unite,a1.qte_nbdec,round(a1.qte,a1.qte_nbdec) as qte,date(a1.dateheure_demande) as date_demande,";
		    $sql_req.=" a1.dateheure_demande as dateheure_demande_brut,a1.dateheure_confirm,a1.statut,a1.unite_condi,$colonne_doc_origine";
			$sql_req.=" a1.qte_condi,a1.nb_stock_in_condi,a1.choix_depot,a1.choix_empla,a2.gestion as gestion_depot_empla,a1.ligne_qte_cleunik,-1 as mvt_cleunik FROM $vl_c_fic_ligne a0 ";
			$sql_req.=" left join $vl_c_fic_qte a1 using (commercial_ligne_cleunik) left join _art_stock a2 using(art_cleunik) where a1.commercial_ligne_cleunik=$commercial_ligne_cleunik;";
		    break;
		  case "livcli":
		  
		  case "faccli":
		  case "avocli":
		  case "avofin":
		  case "recfou":
		  case "facfou":
		  case "retcli":
		  case "retfou":
		  case "avofou":
		  case "avofif":
		 		$sql_req ="SELECT a1.commercial_ligne_cleunik,a1.ligne_cleunik,a1.qte as qte_brut,a1.qte_unite,a1.qte_nbdec,round(a1.qte,a1.qte_nbdec) as qte,";
				$sql_req.=" date(a1.dateheure_demande) as date_demande,a1.dateheure_demande as dateheure_demande_brut,a1.dateheure_confirm,a1.statut,a1.unite_condi,$colonne_doc_origine";
				$sql_req.=" a1.qte_condi,a1.nb_stock_in_condi,a1.choix_depot,a1.choix_empla,a2.gestion as gestion_depot_empla,a1.ligne_qte_cleunik,IFNULL(a1.mvt_cleunik,-1) as mvt_cleunik FROM $vl_c_fic_ligne a0"; 
				$sql_req.=" left join $vl_c_fic_qte a1 using (commercial_ligne_cleunik) left join _art_stock a2 using(art_cleunik) where a1.commercial_ligne_cleunik=$commercial_ligne_cleunik;";
		    break;
		}
}
//die($sql_req);
$result = _graal_requete_bd($sql_req);
$nombre_qte= mysql_num_rows($result);
switch ($nombre_qte) {
  case 0: //  Pas bien normal ça !!
    break;
  case 1: //  Une seule ligne
    $row=mysql_fetch_assoc($result);
    $ligne_qte_cleunik_partielle=fa_nn($row['ligne_doc_origine']);
    switch ($vl_c_specificite) {
		case "livcli_partielle":
		case "recfou_partielle":
			$commercial_ligne_cleunik_partielle=0;
			$commercial_ligne_cleunik_partielle=$commercial_ligne_cleunik;
			break;
		default:
    		$commercial_ligne_cleunik_partielle=$commercial_ligne_cleunik;
    		break;
    }
    $ml_unite_vente=fa_brik_menulist_choix("109",5,-1,1,fa_nn($row['qte_unite']),'ml_unite_vente',"broadcaster_02",fa_nn($row['qte_unite']));
    $ml_unite_condi=fa_brik_menulist_choix("128",5,-1,1,fa_nn($row['unite_condi']),'ml_unite_condi',"broadcaster_02",fa_nn($row['unite_condi']));
    if ($row['statut']==-39) {
      $ml_statut="<hbox flex='1'>";
      $statut_lignebloque=true;
      $ml_statut.=fa_brik_menulist_choix("129",5,-1,1,fa_nn($row['statut']),'ml_statut',"broadcaster_02",fa_nn($row['statut']));
      $ml_statut.="<button id='bt_ligne_soldee' class='ac05' label='Débloquer' oncommand='pf_etat_fen(\"debloque\");' /></hbox>";
    } else {
      $ml_statut=fa_brik_menulist_choix("129",5,-1,1,fa_nn($row['statut']),'ml_statut',"broadcaster_02",fa_nn($row['statut']));
    }
    $qte=fa_nn($row['qte']);
    $qte_unite=fa_nn($row['qte_unite']);
    $qte_nbdec=fa_nn($row['qte_nbdec']);
    $date_demande=fa_nn($row['date_demande']);
    $dateheure_confirm=fa_nn($row['date_heure_confirm']);
    $statut=fa_nn($row['statut']);
    $unite_condi=fa_nn($row['unite_condi']);
    $qte_condi=fa_nn($row['qte_condi']);
    $nb_stock_in_condi=fa_nn($row['nb_stock_in_condi']);
    $ligne_qte_cleunik=fa_nn($row['ligne_qte_cleunik']);
    $mvt_cleunik=fa_nn($row['mvt_cleunik']);
    if (fa_nn($row['gestion_depot_empla'])==1) {
    	$vl_cache_gp_depot_empla="true";
    } else {
    	if ($param_generaux_graal_179==2){
    		$vl_cache_gp_depot_empla="true";
    	} else {
    		$vl_cache_gp_depot_empla="false";
    	}
    }
    //$vl_cache_gp_depot_empla="false";
    $ml_depot=fa_ml_depot($vl_c_art_cleunik,$row['choix_depot'],"broadcaster_02");
    $ml_empla=fa_ml_empla($vl_c_art_cleunik,$row['choix_empla'],"broadcaster_02");
$vl_c_bloc_depo_empla=<<<EOT
    <groupbox id="gp_depo_empla" orient="horizontal" flex="1" collapsed="$vl_cache_gp_depot_empla">
      <caption><label value="$vl_c_bpj_203/$vl_c_bpj_204"/></caption>
       <label control="la_depot" value="$vl_c_bpj_203"/>
         $ml_depot
      <label control="la_empla" value="$vl_c_bpj_204"/>
        $ml_empla
    </groupbox> 
EOT;

    break;
  default:  //  Plus d'une ligne
    //  On traitera plus tard
    break;
}
_graal_libere_requete_bd($result);
switch ($nombre_qte) {
  case 0: //  Pas bien normal ça !!
  case 1: //  Une seule ligne
    pf_bloc_qte();
    break;
  default:  //  Plus d'une ligne
    //  On traitera plus tard
$vl_c_bloc_qte=<<<EOT
EOT;
    break;
}
$vl_c_boutons=<<<EOT
  <hbox> 
    <button width="40" flex="1" id="bt_modifier" label="$vl_c_dico_00003" crop="end" dir="normal" oncommand="pf_etat_fen('modifier')" />
    <button width="40" flex="1" id="bt_supprimer" label="$vl_c_dico_00004" crop="end" dir="normal" oncommand="pf_validation('supprimer')" />
    <button width="40" flex="1" id="bt_enregistrer" label="$vl_c_dico_00005" crop="end" dir="normal" disabled="true" oncommand="pf_validation('enregistrer')" />
    <button width="40" flex="1" id="bt_annuler" label="$vl_c_dico_00006" crop="end" dir="normal" oncommand="pf_etat_fen('annuler');" />
    <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
EOT;
$bloc_choix_article="";
}

switch ($vl_c_specificite) {
	case "livcli_partielle":$commercial_ligne_cleunik=0;$vl_e_critere_tarif_cleunik="101";$vl_c_type_tarifs="1";$vl_c_fic_ligne="_livcli_lignes";$vl_c_fic_qte="_livcli_lignes_qte";$vl_c_fic_entete="_livcli_entetes";break;
	case "recfou_partielle":$commercial_ligne_cleunik=0;$vl_e_critere_tarif_cleunik="127";$vl_c_type_tarifs="2";$vl_c_fic_ligne="_recfou_lignes";$vl_c_fic_qte="_recfou_lignes_qte";$vl_c_fic_entete="_recfou_entetes";break;	
}
switch ($vl_c_specificite) {
	case "livcli_partielle":
	case "recfou_partielle":
		$vl_c_boutons=<<<EOT
  <hbox> 
    <button width="40" flex="1" id="bt_ajouter" label="$vl_c_dico_00002" crop="end" dir="normal" oncommand="pf_validation('enregistrer')"/>
    <button width="40" flex="1" id="bt_annuler" label="$vl_c_dico_00006" crop="end" dir="normal" oncommand="pf_etat_fen('annuler');" />
    <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
EOT;
}

switch (fa_recup_session("vs_envaj","0")){
	case 0:
		$position_bloc_qte_avant="";
		$position_bloc_qte_apres=$vl_c_bloc_qte;
		break;
	case 1:
		$position_bloc_qte_avant=$vl_c_bloc_qte;
		$position_bloc_qte_apres="";
		break;
}
include("_graal_header_winxul.inc.php");
include("_graal_header_textfied.inc.php");
$vl_c_dico_00106=fa_recup_dico("dico_00106");
$vl_c_context_00=<<<EOT
  <popupset>
    <popup id="pop_arbre_tarif">
      <menuitem class="menuitem-iconic ad09" label="$vl_c_dico_00106" oncommand="fa_infos_colonnes_arbre_recup('$vl_c_id_fenetre','arbre_tarif');" />
    </popup>
    <popup id="pop_tr_histo_cial_01">
      <menuitem class="menuitem-iconic ad09" label="$vl_c_dico_00106" oncommand="fa_infos_colonnes_arbre_recup('$vl_c_id_fenetre','tr_histo_cial_01');" />
    </popup>
    <popup id="pop_tr_histo_cial_02">
      <menuitem class="menuitem-iconic ad09" label="$vl_c_dico_00106" oncommand="fa_infos_colonnes_arbre_recup('$vl_c_id_fenetre','tr_histo_cial_02');" />
    </popup>
    <popup id="pop_tr_histo_cial_03">
      <menuitem class="menuitem-iconic ad09" label="$vl_c_dico_00106" oncommand="fa_infos_colonnes_arbre_recup('$vl_c_id_fenetre','tr_histo_cial_03');" />
    </popup>
    <popup id="pop_tr_histo_cial_04">
      <menuitem class="menuitem-iconic ad09" label="$vl_c_dico_00106" oncommand="fa_infos_colonnes_arbre_recup('$vl_c_id_fenetre','tr_histo_cial_04');" />
    </popup>

  </popupset>
EOT;
echo <<<END
<window context="graal_cp00" title="$vl_c_bpj_100" id="_win_fen_cial_lignes" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
$vl_c_context_00
<broadcasterset>
  <broadcaster id="broadcaster_01"/>
  <broadcaster id="broadcaster_02"/>
</broadcasterset>
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_cial_lignes_01.js.php");
echo <<<END
<groupbox>
  <caption><label value="$vl_c_bpj_101"/></caption>
  <vbox flex="1" class="overflow_01">
      <hbox>
        <label control="la_code" value="$vl_c_bpj_102"/>
        <textbox flex="1" id="tb_code" value="$vl_c_code" readonly="true" _graal_act_cleunik="$act_cleunik"/>
        <label control="la_nomcommercial" value="$vl_c_bpj_103"/>
        <textbox flex="1" id="tb_nomcommercial" value="$vl_c_acteur" readonly="true"/>
      </hbox>
    <hbox>
        <label control="la_reference_acteur" value="$vl_c_bpj_104"/>
        <textbox flex="1" id="tb_reference_acteur" readonly="true" value="$vl_c_reference_acteur"/>
        <label control="la_int_privilegie_cdecli" value="$vl_c_bpj_105"/>
        <textbox flex="1" id="tb_int_privilegie_cdecli" readonly="true" value="$vl_c_int_privilegie_cdecli"/>
    </hbox>
      <hbox collapsed="$vl_b_cache_dates">
        <label control="la_expedition" value="$vl_c_bpj_106"/>
        <textbox flex="1" id="tb_date_expedition" readonly="true" value="$vl_c_dateexp"/>
        <label control="la_livraison" value="$vl_c_bpj_107"/>
        <textbox flex="1" id="tb_date_livraison" readonly="true" value="$vl_c_dateliv"/>
    </hbox>
    <hbox> 
        <label control="la_devise" value="$vl_c_bpj_108"/>
        $ml_devise
        <label control="la_tarif" value="$vl_c_bpj_109"/>
        $ml_tarif_entete
    </hbox>
  </vbox>
</groupbox>
  <groupbox >
  <caption flex="1">
    <label value="$vl_c_bpj_110"/>
    <toolbarbutton observes="broadcaster_02" id="tob_ouvre_article" class="ai07" tooltiptext="$vl_c_bpj_116" oncommand="pf_ouvre('article');"/>
    <label value="$vl_c_bpj_136"/>
		<textbox id="tb_ligne_cleunik" type="number" hidespinbuttons="true" value="$vl_c_ligne_cleunik" _graal_typeligne="$vl_c_typeligne"/>
  $bloc_choix_article  
	</caption>
  
  <vbox>
      <hbox>
        <label control="la_taux" value="$vl_c_bpj_114"/>
        <textbox disabled="true" flex="1" id="tb_art_code" _graal_cleunik="$vl_c_art_cleunik" value="$vl_c_codart"/>
        <textbox disabled="true" flex="4" id="tb_art_description" value="$vl_c_desart"/>
      </hbox>
      <hbox>
        <label control="la_taux" value="$vl_c_bpj_115"/>
        <textbox disabled="true" flex="1" id="tb_art_code_acteur" value="$vl_c_code_acteur"/>
        <textbox disabled="true" flex="4" id="tb_art_description_acteur" value="$vl_c_desart_acteur"/>
      </hbox>
  </vbox>
    <groupbox>
      
      <vbox>
      $position_bloc_qte_avant
        <hbox>
		<caption><label value="$vl_c_bpj_120"/></caption>
        <hbox id="hb_tarif_ligne" flex="1" collapsed="$vl_c_cache_hb_tarif_ligne">
				<label value="$vl_c_bpj_109" />
		          <menulist sizetopopup="none" observes="broadcaster_02" minwidth="100" value="1" _graal_nombre_quantite="0" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex="1" id="ml_tarif_ligne" oncommand="pf_change_tarif();" flags="" ref="*" querytype="xml" datasources="">
		      <template><query expr="*"/><action>
		        <menupopup>
		          <menuitem uri="?" _graal_quantite_basse="?_quantite_basse" _graal_quantite_haute="?_graal_quantite_haute" _graal_selection="?selection" disabled="?disabled" selected="?selected" class="?class" _graal_cleunik="?_graal_cleunik" value="?_graal_cleunik" label="?label"  tooltiptext="?label" _graal_tarif="?_graal_tarif" _graal_nb_dec="?_graal_nb_dec"/>
		        </menupopup>
		      </action></template>
		    </menulist>
		</hbox>
          <label value="$vl_c_bpj_117" />
          <toolbarbutton observes="broadcaster_02" id="tob_acces_pu" class="af06" tooltiptext="Modifier le PU" collapsed="true" oncommand="pf_modifie_pu();"/>
          <textbox observes="_raf_broadcaster_01" id="tb_pu" type="number" hidespinbuttons="true" decimalplaces="$vl_c_nbdec_pu"   value="$vl_c_pu" class="droite" disabled="true" tooltiptext="$vl_c_pu"/>
          <textbox observes="broadcaster_02" id="tb_nbdec_pu" type="number" hidespinbuttons="true" size="1"   disabled="true" value="$vl_c_nbdec_pu" tooltiptext="Nombre de décimales du PU"/>
          <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" observes="broadcaster_01" flex="1" id="ml_pu_type" class="normal" oncommand="" value="$vl_c_pu_type" _graal_nombre="2">
            <menupopup>
              <menuitem label="$vl_c_bpj_118" value="1"/>
              <menuitem label="$vl_c_bpj_119" value="2" />
            </menupopup>
          </menulist>
          <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" observes="broadcaster_01" flex="1" id="ml_coef_facture" class="normal" oncommand="" value="$vl_c_coef_facture" _graal_nombre="2">
            <menupopup>
              <menuitem label="$vl_c_bpj_174" value="1"/>
              <menuitem label="$vl_c_bpj_175" value="0" />
            </menupopup>
          </menulist>
          
          
        </hbox>
      <hbox flex="1">
        <caption><label value="$vl_c_bpj_121"/></caption>
       <label control="la_remise_natu" value="$vl_c_bpj_122"/>
       <menulist sizetopopup="none" flex="1" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" id="ml_remise_natu" class="sans_icone" observes="broadcaster_02" _graal_nombre="2" value="$vl_c_remise_natu">
				<menupopup>
					<menuitem value="1" label="$vl_c_bpj_123" crop="none" />
          <menuitem value="2" label="$vl_c_bpj_124" crop="none" />
				</menupopup>
			</menulist>
      <label control="la_remise_taux" value="$vl_c_bpj_125"/>
       <textbox flex="1" id="tb_remise_taux" type="number" hidespinbuttons="true" decimalplaces="2" observes="broadcaster_02"   class="droite" value="$vl_remise_taux"/>
       <label control="la_remise_type" value="$vl_c_bpj_126"/>
       <menulist sizetopopup="none" flex="1" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" id="ml_remise_type" class="sans_icone" observes="broadcaster_02" _graal_nombre="6" value="$vl_c_remise_type">
				<menupopup>
					<menuitem value="1" label="$vl_c_bpj_127" crop="none" />
          <menuitem value="2" label="$vl_c_bpj_128" crop="none" />
          <menuitem value="3" label="$vl_c_bpj_129" crop="none" hidden="true"/>
          <menuitem value="4" label="$vl_c_bpj_130" crop="none" hidden="true"/>
          <menuitem value="5" label="$vl_c_bpj_131" crop="none" hidden="true"/>
          <menuitem value="6" label="$vl_c_bpj_132" crop="none" hidden="true"/>
				</menupopup>
			</menulist>

       <label control="la_remise_genr" value="$vl_c_bpj_133"/>
       <menulist sizetopopup="none" flex="1" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" id="ml_remise_genr" class="sans_icone" observes="broadcaster_02" _graal_nombre="2" value="$vl_c_remise_genre">
				<menupopup>
					<menuitem value="1" label="$vl_c_bpj_134" crop="none" selected="true"/>
          <menuitem value="2" label="$vl_c_bpj_135" crop="none" hidden="true"/>
				</menupopup>
			</menulist>
    	</hbox>
      </vbox>
    </groupbox>
    $position_bloc_qte_apres
    $vl_c_bloc_depo_empla   
    <hbox>
      <label control="la_blocnotebrut_ligne" value="$vl_c_bpj_141"/>
      <textbox observes="broadcaster_01" id="tb_blocnotebrut_ligne"   multiline="true" rows="3" flex="1" value="$vl_c_blocnotebrut"/>
    </hbox>
  $vl_c_boutons
  </groupbox>
  <tabbox id="tabbox_01" flex="1" orient="vertical" class="overflow_01">
    <tabs id="tab_infogene">
       <tab id="tab_tarifs" linkedpanel="tabpanel_tarifs" label="$vl_c_bpj_146" first-tab='true'/>
       <tab id="tab_histo_cial_01" linkedpanel="tabpanel_histo_cial_01" label="$vl_c_bpj_147" />
       <tab id="tab_histo_cial_02" linkedpanel="tabpanel_histo_cial_02" label="$vl_c_bpj_148" last-tab='true'/>
       <tab id="tab_histo_cial_03" linkedpanel="tabpanel_histo_cial_03" label="$vl_c_bpj_201" />
       <tab id="tab_histo_cial_04" linkedpanel="tabpanel_histo_cial_04" label="$vl_c_bpj_202" last-tab='true'/>

    </tabs>
    <tabpanels flex="1">
  		<tabpanel id="tabpanel_tarifs" flex="1" class="overflow_01">
        <tree id="arbre_tarif" flex="1" hidecolumnpicker="false" flags="" ref="*" querytype="xml" datasources="" seltype="single" enableColumnDrag="true" context="pop_arbre_tarif">
        <treecols>
          <treecol id="tc_tar_cleunik_particulier" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_code_tarif_particulier" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_act_cleunik_particulier" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_designation_tarif_particulier" label="$vl_c_bpj_142" sort="?designation_type" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_nomacteur_tarif_particulier" label="$vl_c_bpj_143" sort="?nomacteur_particulier" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_tarif_particulier" class="droite" label="$vl_c_bpj_144" sort="?tarif_type"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_datevalidite_tarif_particulier" class="droite" label="$vl_c_bpj_145" sort="?datevalidite"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_maj_tarif_particulier" class="droite" label="Date dernière MAJ" sort="?datemaj"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_borne_basse_tarif_particulier" class="droite" label="Borne basse" sort="?val_borne_basse" /><splitter class="tree-splitter" resizeafter="grow"/>
     	 <treecol id="tc_borne_haute_tarif_particulier" class="droite" label="Borne haute" sort="?val_borne_haute" /><splitter class="tree-splitter" resizeafter="grow"/>
      	<treecol id="tc_val_borne_basse_tarif_particulier" ignoreincolumnpicker="true" hidden="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      	<treecol id="tc_val_borne_haute_tarif_particulier" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
        </treecols>
        <template><query expr="*"/><action>
          <treechildren>
            <treeitem uri="?" seltype="single">
              <treerow>
                <treecell properties="?properties" label="?tar_cleunik_type"/>
                <treecell properties="?properties" label="?code_type"/>
                <treecell properties="?properties" label="?act_cleunik_particulier"/>
                <treecell properties="?properties" label="?designation_type"/>
                <treecell properties="?properties" label="?nomacteur_particulier"/>
                <treecell properties="?properties" label="?tarif_type"/>
                <treecell properties="?properties" label="?datevalidite"/>
                <treecell properties="?properties" label="?datemaj"/>
                <treecell properties="?properties" label="?borne_basse"/>
            	<treecell properties="?properties" label="?borne_haute"/>
           	 	<treecell properties="?properties" label="?val_borne_basse"/>
            	<treecell properties="?properties" label="?val_borne_haute"/>
              </treerow>
            </treeitem>
          </treechildren>
        </action></template>
      </tree>
    </tabpanel>
    <tabpanel id="tabpanel_histo_cial_01" flex="1" class="overflow_01">
      <tree id="tr_histo_cial_01" flex="1" flags="" ref="*" querytype="xml" datasources="" enableColumnDrag="true" hidecolumnpicker="false" ondblclick="pf_dblclick_arbre_histo_cial(this.id)" context="pop_tr_histo_cial_01">
        <treecols>
          <treecol hidden="true" id="tc_commercial_ligne_cleunik_01" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol hidden="true" id="tc_commercial_cleunik_01" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol hidden="true" id="tc_art_cleunik_01" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol hidden="true" id="tc_action_cleunik_01" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_date_01" class="droite" label="$vl_c_bpj_149" sort="?z17"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_code_01" label="$vl_c_bpj_150" sort="?z05" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_ligne_cleunik_01" label="$vl_c_bpj_151" sort="?z03" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_qte_01" class="droite" label="$vl_c_bpj_152" sort="?z08" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_z16_01" label="$vl_c_bpj_157" sort="?z16" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_pu_01" class="droite" label="$vl_c_bpj_153" sort="?z11" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_remise_taux_01" class="droite" label="$vl_c_bpj_154" sort="?z14" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_htligne_01" class="droite" label="$vl_c_bpj_155" sort="?htligne" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_statut_01" label="$vl_c_bpj_156" sort="?z20" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="coef_facture_clair_01" label="" sort="?coef_facture_clair" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_htbrutremise_01" class="droite" label="$vl_c_bpj_177" sort="?htbrutremise" /><splitter class="tree-splitter" resizeafter="grow"/>
        </treecols>
        <template><query expr="*"/><action>
          <treechildren>
            <treeitem uri="?" seltype="single">
              <treerow>
                <treecell label="?z01"/>
                <treecell label="?z02"/>
                <treecell label="?z04"/>
                <treecell label="?z21"/>
                <treecell label="?dateheure"/>
                <treecell label="?z05"/>
                <treecell label="?z03"/>
                <treecell label="?z08"/>
                <treecell label="?z16"/>
                <treecell label="?z11"/>
                <treecell label="?z14"/>
                <treecell label="?htligne" properties="?prop_coef_facture"/>
                <treecell label="?z20"/>
                <treecell label="?coef_facture_clair"/>
                <treecell label="?htbrutremise"  properties="?prop_coef_facture"/>
              </treerow>
            </treeitem>
          </treechildren>
        </action></template>
      </tree>
    </tabpanel>
    <tabpanel id="tabpanel_histo_cial_02" flex="1" class="overflow_01">
      <tree id="tr_histo_cial_02" flex="1" flags="" ref="*" querytype="xml" datasources="" enableColumnDrag="true" hidecolumnpicker="false" ondblclick="pf_dblclick_arbre_histo_cial(this.id)" context="pop_tr_histo_cial_02">
    <treecols>
      <treecol hidden="true" id="tc_commercial_ligne_cleunik_02" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="tc_commercial_cleunik_02" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="tc_art_cleunik_02" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="tc_action_cleunik_02" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_date_02" class="droite" label="$vl_c_bpj_159" sort="?z17"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_code_02" label="$vl_c_bpj_159" sort="?z05" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_ligne_cleunik_02" label="$vl_c_bpj_160" sort="?z03" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_qte_02" class="droite" label="$vl_c_bpj_161" sort="?z08" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_code_article_02" label="$vl_c_bpj_162" sort="?z22" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_desc_article_02" label="$vl_c_bpj_163" sort="?z23" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_z16_02" label="$vl_c_bpj_168" sort="?z16" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_pu_02" class="droite" label="$vl_c_bpj_164" sort="?z11" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_remise_taux_02" class="droite" label="$vl_c_bpj_165" sort="?z14" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_htligne_02" class="droite" label="$vl_c_bpj_166" sort="?htligne" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_statut_02" label="$vl_c_bpj_167" sort="?z20" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="coef_facture_clair_02" label="" sort="?coef_facture_clair" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_htbrutremise_02" class="droite" label="$vl_c_bpj_178" sort="?htbrutremise" /><splitter class="tree-splitter" resizeafter="grow"/>
    </treecols>
    <template><query expr="*"/><action>
      <treechildren>
        <treeitem uri="?" seltype="single">
          <treerow>
            <treecell label="?z01"/>
            <treecell label="?z02"/>
            <treecell label="?z04"/>
            <treecell label="?z21"/>
            <treecell label="?dateheure"/>
            <treecell label="?z05"/>
            <treecell label="?z03"/>
            <treecell label="?z08"/>
            <treecell label="?z22"/>
            <treecell label="?z23"/>
            <treecell label="?z16"/>
            <treecell label="?z11"/>
            <treecell label="?z14"/>
            <treecell label="?htligne" properties="?prop_coef_facture"/>
            <treecell label="?z20"/>
            <treecell label="?coef_facture_clair"/>
            <treecell label="?htbrutremise"  properties="?prop_coef_facture"/>
          </treerow>
        </treeitem>
      </treechildren>
    </action></template>
  </tree>
  </tabpanel>

    <tabpanel id="tabpanel_histo_cial_03" flex="1" class="overflow_01">
      <tree id="tr_histo_cial_03" flex="1" flags="" ref="*" querytype="xml" datasources="" enableColumnDrag="true" hidecolumnpicker="false" ondblclick="pf_dblclick_arbre_histo_cial(this.id)" context="pop_tr_histo_cial_03">
        <treecols>
          <treecol hidden="true" id="tc_commercial_ligne_cleunik_03" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol hidden="true" id="tc_commercial_cleunik_03" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol hidden="true" id="tc_art_cleunik_03" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol hidden="true" id="tc_action_cleunik_03" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_date_03" class="droite" label="$vl_c_bpj_179" sort="?z17"/><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_code_03" label="$vl_c_bpj_180" sort="?z05" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_ligne_cleunik_03" label="$vl_c_bpj_181" sort="?z03" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_qte_03" class="droite" label="$vl_c_bpj_182" sort="?z08" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_z16_03" label="$vl_c_bpj_187" sort="?z16" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_pu_03" class="droite" label="$vl_c_bpj_183" sort="?z11" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_remise_taux_03" class="droite" label="$vl_c_bpj_184" sort="?z14" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_htligne_03" class="droite" label="$vl_c_bpj_185" sort="?htligne" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_statut_03" label="$vl_c_bpj_186" sort="?z20" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="coef_facture_clair_03" label="" sort="?coef_facture_clair" /><splitter class="tree-splitter" resizeafter="grow"/>
          <treecol id="tc_htbrutremise_03" class="droite" label="$vl_c_bpj_188" sort="?htbrutremise" /><splitter class="tree-splitter" resizeafter="grow"/>
        </treecols>
        <template><query expr="*"/><action>
          <treechildren>
            <treeitem uri="?" seltype="single">
              <treerow>
                <treecell label="?z01"/>
                <treecell label="?z02"/>
                <treecell label="?z04"/>
                <treecell label="?z21"/>
                <treecell label="?dateheure"/>
                <treecell label="?z05"/>
                <treecell label="?z03"/>
                <treecell label="?z08"/>
                <treecell label="?z16"/>
                <treecell label="?z11"/>
                <treecell label="?z14"/>
                <treecell label="?htligne" properties="?prop_coef_facture"/>
                <treecell label="?z20"/>
                <treecell label="?coef_facture_clair"/>
                <treecell label="?htbrutremise"  properties="?prop_coef_facture"/>
              </treerow>
            </treeitem>
          </treechildren>
        </action></template>
      </tree>
    </tabpanel>
    <tabpanel id="tabpanel_histo_cial_04" flex="1" class="overflow_01">
      <tree id="tr_histo_cial_04" flex="1" flags="" ref="*" querytype="xml" datasources="" enableColumnDrag="true" hidecolumnpicker="false" ondblclick="pf_dblclick_arbre_histo_cial(this.id)" context="pop_tr_histo_cial_04">
    <treecols>
      <treecol hidden="true" id="tc_commercial_ligne_cleunik_04" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="tc_commercial_cleunik_04" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="tc_art_cleunik_04" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="tc_action_cleunik_04" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_date_04" class="droite" label="$vl_c_bpj_189" sort="?z17"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_code_04" label="$vl_c_bpj_190" sort="?z05" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_ligne_cleunik_04" label="$vl_c_bpj_191" sort="?z03" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_qte_04" class="droite" label="$vl_c_bpj_192" sort="?z08" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_code_article_04" label="$vl_c_bpj_193" sort="?z22" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_desc_article_04" label="$vl_c_bpj_194" sort="?z23" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_z16_04" label="$vl_c_bpj_199" sort="?z16" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_pu_04" class="droite" label="$vl_c_bpj_195" sort="?z11" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_remise_taux_04" class="droite" label="$vl_c_bpj_196" sort="?z14" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_htligne_04" class="droite" label="$vl_c_bpj_197" sort="?htligne" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_statut_04" label="$vl_c_bpj_198" sort="?z20" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="coef_facture_clair_04" label="" sort="?coef_facture_clair" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_htbrutremise_04" class="droite" label="$vl_c_bpj_200" sort="?htbrutremise" /><splitter class="tree-splitter" resizeafter="grow"/>
    </treecols>
    <template><query expr="*"/><action>
      <treechildren>
        <treeitem uri="?" seltype="single">
          <treerow>
            <treecell label="?z01"/>
            <treecell label="?z02"/>
            <treecell label="?z04"/>
            <treecell label="?z21"/>
            <treecell label="?dateheure"/>
            <treecell label="?z05"/>
            <treecell label="?z03"/>
            <treecell label="?z08"/>
            <treecell label="?z22"/>
            <treecell label="?z23"/>
            <treecell label="?z16"/>
            <treecell label="?z11"/>
            <treecell label="?z14"/>
            <treecell label="?htligne" properties="?prop_coef_facture"/>
            <treecell label="?z20"/>
            <treecell label="?coef_facture_clair"/>
            <treecell label="?htbrutremise"  properties="?prop_coef_facture"/>
          </treerow>
        </treeitem>
      </treechildren>
    </action></template>
  </tree>
  </tabpanel>


    
    
  </tabpanels>
 </tabbox> 
</window>
END;
function pf_cherche_graal($vv_choix_cleunik,$vv_action_cleunik) {
  $sql_req="SELECT concat_ws(' ',a2.prenom,a2.patronyme) as qui,a1.principal FROM _graal a1 left join _act_interlo a2 using(int_cleunik) where a1.action_cleunik=$vv_action_cleunik and a1.choix_cleunik=$vv_choix_cleunik;";
  $result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($result) == 0) {
    $qui="Personne";
  } else {
    $row = mysql_fetch_assoc($result);
    $qui=fa_ent_xml($row['qui']);
  }
  _graal_libere_requete_bd($result);
  return $qui;
}
function pf_bloc_qte() {
global $vl_c_bloc_qte;
global $vl_c_bpj_137;
global $vl_c_bpj_138;
global $vl_c_bpj_139;
global $vl_c_bpj_140;
global $vl_c_bpj_169;
global $vl_c_bpj_170;
global $qte;
global $qte_condi;
global $ml_unite_vente;
global $ml_unite_condi;
global $ml_statut;
global $nb_stock_in_condi;
global $qte_nbdec;
global $ligne_qte_cleunik;
global $mvt_cleunik;
global $vl_b_cache_dates;
global $ligne_qte_cleunik_partielle;
$vl_c_bloc_qte=<<<EOT
<groupbox>
  <caption><label value="$vl_c_bpj_137"/></caption>
  <vbox flex="1" class="overflow_01">
      <hbox>
        <label control="la_qte" value="$vl_c_bpj_138"/>
        <textbox flex="1" ligne_qte_doc_origine="$ligne_qte_cleunik_partielle" id="tb_qte" type="number" hidespinbuttons="true" decimalplaces="$qte_nbdec" observes="broadcaster_01"   class="droite" _graal_qte_nbdec="$qte_nbdec" _graal_cleunik="$ligne_qte_cleunik" _graal_mvt_cleunik="$mvt_cleunik"/>
        $ml_unite_vente
        <button width="25" observes="broadcaster_01" id="tob_conv_vente_vers_condi" class="ai07" tooltiptext="$vl_c_bpj_169" oncommand="pf_conv_vente_vers_condi();"/>
      </hbox>
      <hbox>
        <label control="la_qte_condi" value="$vl_c_bpj_139"/>
        <textbox flex="1" id="tb_qte_condi" type="number" hidespinbuttons="true" decimalplaces="2" observes="broadcaster_01"   class="droite" _graal_nb_stock_in_condi="$nb_stock_in_condi"/>
        $ml_unite_condi
        <button width="25" observes="broadcaster_01" id="tob_conv_condi_vers_vente" class="ai07" tooltiptext="$vl_c_bpj_170" oncommand="pf_conv_condi_vers_vente();"/>
      </hbox>
      <hbox>
				<hbox collapsed="$vl_b_cache_dates">	
	        <label control="la_date_demande" value="$vl_c_bpj_140"/>
			<datepicker type="popup" monthLeadingZero="true" dateLeadingZero="true" observes="broadcaster_01" id="dp_date_demande"/>
			<timepicker collapsed="true" is24HourClock="true" id="tb_heur_demande" observes="broadcaster_02"/>
				</hbox>
      $ml_statut
    </hbox>
  </vbox>
</groupbox>
EOT;
}
?>
