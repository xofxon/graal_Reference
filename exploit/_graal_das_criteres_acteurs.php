<?php
include("_graal_header_xml.inc.php");
$vl_c_etat=fa_recup_param('vl_c_etat','1');
$vl_c_position=fa_recup_param('vl_c_position','1');
$vl_e_portee=intval(fa_recup_param('vl_e_portee','6'));
$vl_c_operateur_01="=";
$vl_c_oui=fa_recup_dico("dico_00013");
$vl_c_non=fa_recup_dico("dico_00014");
$vl_c_actif=fa_recup_dico("dico_00046");
$vl_c_inactif=fa_recup_dico("dico_00047");
switch ($vl_c_etat){
  case "1": break;  //  Tous
  case "2": //  les utilisés
    $vl_c_operateur_01=">";
    break;
  case "3": //  pas utilisés
    $vl_c_operateur_01="=";
    break;
}
$sql_req = "select critere_cleunik,critere_code,critere_denomination,case critere_actif WHEN 1 THEN '$vl_c_actif' ELSE '$vl_c_inactif' END AS critere_actif,";
$sql_req .= "IF (critere_portee & 2,'$vl_c_oui','$vl_c_non') as portee_prospect_client,";
$sql_req .= "IF (critere_portee & 4,'$vl_c_oui','$vl_c_non') as portee_client,";
$sql_req .= "IF (critere_portee & 8,'$vl_c_oui','$vl_c_non') as portee_prospect_fournisseur,";
$sql_req .= "IF (critere_portee & 16,'$vl_c_oui','$vl_c_non') as portee_fournisseur,";
$sql_req .= "IF (critere_portee & 32,'$vl_c_oui','$vl_c_non') as portee_autre_acteur,";
$sql_req .= "IF (critere_portee & 64,'$vl_c_oui','$vl_c_non') as portee_acteur_indetermine";
$sql_req .= " from _criteres where (critere_cleunik >9999 or critere_cleunik in(126))  and ( critere_portee &$vl_e_portee and critere_portee & 8192)";
switch ($vl_c_position){
  case "1": break;  //  Actifs et inactifs
  case "2": //  les utilisés
    $sql_req .= " AND critere_actif =1";
    break;
  case "3": //  les pas utilisés
    $sql_req .= " AND critere_actif =2";
    break;
}
switch ($vl_c_etat){
  case "1": break;  //  Tous
  case "2": //  les utilisés
  case "3": //  les pas utilisés
   $sql_req .= " and (SELECT count(*) as nombre from _act_choix_fixes where _act_choix_fixes.critere_cleunik = _criteres.critere_cleunik) $vl_c_operateur_01 0";
}
$sql_req .= " ORDER BY critere_denomination";
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
    echo(' critere_cleunik="'.fa_ent_xml($row['critere_cleunik']).'"');
    echo(' critere_code="'.fa_ent_xml($row['critere_code']).'"');
    echo(' critere_denomination="'.fa_ent_xml($row['critere_denomination']).'"');
    echo(' critere_actif="'.fa_ent_xml($row['critere_actif']).'"');
    echo(' portee_prospect_client="'.fa_ent_xml($row['portee_prospect_client']).'"');
    echo(' portee_client="'.fa_ent_xml($row['portee_client']).'"');
    echo(' portee_prospect_fournisseur="'.fa_ent_xml($row['portee_prospect_fournisseur']).'"');
    echo(' portee_fournisseur="'.fa_ent_xml($row['portee_fournisseur']).'"');
    echo(' portee_autre_acteur="'.fa_ent_xml($row['portee_autre_acteur']).'"');
    echo(' portee_acteur_indetermine="'.fa_ent_xml($row['portee_acteur_indetermine']).'"');
    echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
