<?php
include("_graal_var_portee.php");
function fa_cherche_si_pj_autorisee($action_cleunik){
	$sql_req="select doc_cleunik from _documents_rattachement where rat_cleunik=$action_cleunik and portee &$vl_e_piejoi";
	$result = _graal_requete_bd($sql_req);
	while ($row = mysql_fetch_assoc($result)) {
		$doc_cleunik=$row['doc_cleunik'];
		if (fa_verif_droit($doc_cleunik)==false){return false;}
	}
	_graal_libere_requete_bd($result);
	return true;
}
function fa_extrait_ecrit_fichier($doc_cleunik){
	$sql_req = "SELECT document AS formulaire FROM _documents WHERE doc_cleunik=$doc_cleunik;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	if (mysql_num_rows($result) == 0) {
		return "";
	} else {
		$uuid=_graal_requete_uuid();
		$pdf_referent="mail/$uuid";
		$handle_file=fopen($pdf_referent, 'wb');
		fwrite($handle_file, $row['formulaire']);
		fclose($handle_file);
		_graal_libere_requete_bd($result);
		return $pdf_referent;
	}
}
function fa_insere_document($vf_e_doc_cleunik,$vl_c_nom_fichier,$typedoc,$size,$tmp,$vf_c_genre,$vl_e_portee_cleunik,$vl_e_uti_cleunik,$droits_proprio,$droits_groupe,$droits_lambda){
	global $vl_e_entrep,$vl_e_procli,$vl_e_client,$vl_e_profou,$vl_e_fourni,$vl_e_autrac,$vl_e_actind,$vl_e_notess,$vl_e_psodoc,$vl_e_docume,$vl_e_articl,$vl_e_action,$vl_e_interl,$vl_e_acteur,$vl_e_gedged,$vl_e_utilis,$vl_e_piejoi,$vl_e_criter,$vl_e_faxfax;
	$type=fa_mime_type_buffer(file_get_contents($tmp));
	$hash=hash_file('sha1', $tmp);
	$vf_c_retour_existe=explode("|",fa_verifie_hash($hash));
	if ($vf_c_retour_existe[0]==0){
		$type=addslashes($type);
		$sql_req = "INSERT INTO _documents set doc_cleunik=$vf_e_doc_cleunik,emplacement='$vl_c_nom_fichier',typedoc=$typedoc,dateheurecreation = now(),tailledoc=$size,document='".addslashes(file_get_contents($tmp))."',mime='$type',hash='$hash';";
		//echo $sql_req;
		$retour=_graal_exec_requete($sql_req);
		//  Gestion du critère "Extension de fichier"
	  $vl_critere_cleunik=121;
	  $extension=fa_extension($vl_c_nom_fichier);
	  $sql_req="SELECT choix_cleunik from _choix where critere_cleunik=$vl_critere_cleunik and choix_valeur_texte_01='$extension'";
	  $result = _graal_requete_bd($sql_req);
	  if (mysql_num_rows($result) == 0) {
	    $vl_choix_cleunik=_graal_requete_max("choix_cleunik","_choix");
	    $sql_req_01 = "INSERT INTO _choix set choix_cleunik=$vl_choix_cleunik,critere_cleunik=$vl_critere_cleunik,choix_valeur_texte_01='$extension',choix_valeur_texte_02='$extension',choix_actif=1";
	    $vf_c_echo=_graal_exec_requete($sql_req_01);
	  } else {
	    $row = mysql_fetch_assoc($result);
	    $vl_choix_cleunik=fa_ent_xml($row['choix_cleunik']);
	  }
	  _graal_libere_requete_bd($result);
	  $sql_req="REPLACE INTO _documents_choix_fixes (doc_cleunik,choix_cleunik,critere_cleunik,typedoc,uti_cleunik) VALUES ($vf_e_doc_cleunik,$vl_choix_cleunik,$vl_critere_cleunik,$typedoc,0)";
	  $result_02 = _graal_requete_bd($sql_req);
	  if($result_02 === false) {$vf_c_echo='Erreur 02 ->'.mysql_error($cnx) . $sql_req;} else {$vf_c_echo='ok';}
	  //  Code pour récupérer les infos exif d'une image -> faire un critère ?
	  /*
	  //  On récupère l'exif si c'est une image
	  $tab_images = array(IMAGETYPE_GIF,IMAGETYPE_JPEG,IMAGETYPE_PNG,IMAGETYPE_SWF,IMAGETYPE_PSD,IMAGETYPE_BMP,IMAGETYPE_TIFF_II,IMAGETYPE_TIFF_MM,IMAGETYPE_JPC,IMAGETYPE_JP2,IMAGETYPE_JPX,IMAGETYPE_JB2,IMAGETYPE_SWC,IMAGETYPE_IFF,IMAGETYPE_WBMP,IMAGETYPE_XBM);
	  if(in_array(exif_imagetype($vl_c_fichier), $tab_images)) {
	    echo "$vl_c_fichier:<br />\n";
	    $exif = exif_read_data($vl_c_fichier, 'IFD0');
	    echo $exif===false ? "Aucun en-tête de donnés n'a été trouvé.<br />\n" : "L'image contient des en-têtes<br />\n";
	    
	    $exif = exif_read_data($vl_c_fichier, 0, true);
	    //$exif = exif_read_data($vl_c_fichier, 'EXIF');
	    echo "$vl_c_fichier:<br />\n";
	    foreach ($exif as $key => $section) {
	        foreach ($section as $name => $val) {
	            if ('MakerNote'!=$name) {
	              echo "$key.$name: $val\n";
	              }
	        }
	    }
	  } 
	  */
	} else {
		$vf_e_doc_cleunik=$vf_c_retour_existe[1];
		//echo "Existe $vf_e_doc_cleunik";
		$retour='ok';
	}
	if ($retour=='ok') {
	  $sql_req="";
	  switch ($vf_c_genre) {
	    case 'action' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_action;";break;
	    case 'acteur' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_acteur;";break;
	    case 'articl' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_articl;";break;
	    case 'interl' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_portee_cleunik,portee=$vl_e_interl;";break;
	    case 'entrep' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=0,portee=$vl_e_entrep;";break;
	    case 'utilis' : $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";break;
	  }
	  $toto=$sql_req;
	  _graal_exec_requete($sql_req);
	  //echo $toto;
	  switch ($vf_c_genre) {
	    case 'utilis' :  //  On ne gère les droits que pour les utilisateurs 
	      $sql_req = "INSERT INTO _droits_doc set doc_cleunik=$vf_e_doc_cleunik,uti_cleunik=$vl_e_uti_cleunik,droits_proprio=$droits_proprio,droits_groupe=$droits_groupe,droits_lambda=$droits_lambda";
	      _graal_exec_requete($sql_req);
	      break;
	  }
	  return $vf_e_doc_cleunik."|ok|";
	} else {
	  return "0|$retour|";
	}	
}
function fa_verif_droit($vv_cleunik){
	$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
	$vl_e_int_cleunik=$_SESSION["vs_int_cleunik"];
	$vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));
	if (isset($vl_c_xml->gesdoc_ml_zone)){$gesdoc_ml_zone=$vl_c_xml->gesdoc_ml_zone->attributes();}else{$gesdoc_ml_zone='1';}
	$vl_c_xml="";
	//echo $gesdoc_ml_zone;
	switch ($gesdoc_ml_zone){
		case 1:	//	accès libre
			$vf_b_renvoyer=true;
		case 2:	//	accès soumis à droits
			$sql_req = "select droits_proprio from _droits_doc where doc_cleunik=$vv_cleunik AND uti_cleunik=$vl_e_uti_cleunik;";
	      $result = _graal_requete_bd($sql_req);
	      $row = mysql_fetch_assoc($result);
	      $vf_e_droits=$row['droits_proprio'];
			_graal_libere_requete_bd($result);
			if (is_null($vf_e_droits)){
				$vf_b_renvoyer=false;
			} else {
				if (($vf_e_droits & 2) == 2) {
					//	Accès au moins en lecture donc ok
					$vf_b_renvoyer=true;
				} else {
					$vf_b_renvoyer=false;
					return false;
				}
			}
			break;
		case 3:	//	accès soumis à absence de liste noire
			$sql_req = "select doc_cleunik from _doc_noire where doc_cleunik=$vv_cleunik AND uti_cleunik=$vl_e_uti_cleunik;";
	      $result = _graal_requete_bd($sql_req);
	      $row = mysql_fetch_assoc($result);
	      $vf_e_droits=$row['doc_cleunik'];
			_graal_libere_requete_bd($result);
			if (is_null($vf_e_droits)){
				$vf_b_renvoyer=true;
			} else {
				$vf_b_renvoyer=false;
				return false;
			}			
		case 4:	//	accès soumis à présence dans liste blanche
			$sql_req = "select doc_cleunik from _doc_blanc where doc_cleunik=$vv_cleunik AND uti_cleunik=$vl_e_uti_cleunik;";
	      $result = _graal_requete_bd($sql_req);
	      $row = mysql_fetch_assoc($result);
	      $vf_e_droits=$row['doc_cleunik'];
			_graal_libere_requete_bd($result);
			if (is_null($vf_e_droits)){
				$vf_b_renvoyer=false;
				return false;
			} else {
				$vf_b_renvoyer=true;
			}
			break;
		
		default:
			$vf_b_renvoyer=false;
			return false;
	}
	/*
	 * Gestion de la liste noire des acteurs
	 */
	$sql_req = "select f1.doc_cleunik from _documents_rattachement f1 left join _acteurs_noire f2 on f1.rat_cleunik=f2.act_cleunik and f1.portee in(8192) ";
	$sql_req.= " where f1.doc_cleunik=$vv_cleunik and f2.uti_cleunik=$vl_e_uti_cleunik";
      $result = _graal_requete_bd($sql_req);
      $nb_row = mysql_num_rows($result);
	_graal_libere_requete_bd($result);
	$vf_b_renvoyer = ($sql_req." renvoie $nb_row résultats");
	
	if ($nb_row!=0){
		$vf_b_renvoyer=false;
	} else {
		$vf_b_renvoyer=true;
	}
	//echo $sql_req;
		
	$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
	if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
	//echo $vs_gesacteurs_ml_zone;
	switch ($vs_gesacteurs_ml_zone){
		case '1':	//	Accès libre
			$vf_b_renvoyer=true;
			break;
		case '3':	//	Accès sur liste noire
			$sql_req = "select f1.doc_cleunik from _documents_rattachement f1 left join _acteurs_noire f2 on f1.rat_cleunik=f2.act_cleunik and f1.portee in(8192) ";
			$sql_req.= " where f1.doc_cleunik=$vv_cleunik and f2.uti_cleunik=$vl_e_uti_cleunik";
	      $result = _graal_requete_bd($sql_req);
	      $nb_row = mysql_num_rows($result);
			_graal_libere_requete_bd($result);
			$vf_b_renvoyer = ($sql_req." renvoie $nb_row résultats");
			
			if ($nb_row!=0){
				$vf_b_renvoyer=false;
			} else {
				$vf_b_renvoyer=true;
			}
			break;
		case '4':	//	Accès sur liste blanche
			/*
			 * On commence par rechercher s'il y a au moins un rattachement de l'interlocuteur associé à l'utilisateur (ajout du 27 mai 2010)
			 */
			$sql_req = "select f1.doc_cleunik from _documents_rattachement f1 left join _graal f2 on f1.rat_cleunik=f2.action_cleunik ";
			$sql_req.= " where f1.doc_cleunik=$vv_cleunik and f2.int_cleunik=$vl_e_int_cleunik;";
			$result = _graal_requete_bd($sql_req);
	      	$nb_row = mysql_num_rows($result);
			_graal_libere_requete_bd($result);
			$vf_b_renvoyer = ($sql_req." renvoie $nb_row résultats");
			//echo $vf_b_renvoyer;
			if ($nb_row!=0){
				$vf_b_renvoyer=true;
				return true;
			} else {
				$vf_b_renvoyer=false;
			}
			/*
			 * on commence par rechercher s'il y a des acteurs absents de la liste blanche sur les actions liées au document (pièce jointe)
			 */
			$sql_req = "select f1.doc_cleunik from _documents_rattachement f1 left join _graal f2 on f1.rat_cleunik=f2.action_cleunik left join _acteurs_blanc f3 ";
			$sql_req.= " on f3.act_cleunik=f2.act_cleunik and f3.uti_cleunik=$vl_e_uti_cleunik where f1.doc_cleunik=$vv_cleunik and f3.act_cleunik is null and f2.act_cleunik<>0";
			$result = _graal_requete_bd($sql_req);
	      	$nb_row = mysql_num_rows($result);
			_graal_libere_requete_bd($result);
			$vf_b_renvoyer = ($sql_req." renvoie $nb_row résultats");
			//echo $vf_b_renvoyer;
			if ($nb_row!=0){
				$vf_b_renvoyer=false;
				return false;
			} else {
				$vf_b_renvoyer=true;
			}
			/*
			 * On continuer en comptant le nombre de rattachement puis en vérifiant que les rattaché appartiennent à la liste blanche
			 */
			$sql_req = "select f1.rat_cleunik from _documents_rattachement f1 where f1.portee in(8192) and f1.doc_cleunik=$vv_cleunik and rat_cleunik<> 0";
			$result = _graal_requete_bd($sql_req);
			//echo $sql_req;
			while ($row = mysql_fetch_assoc($result)) {
				$sql_req_01="select act_cleunik from _acteurs_blanc where act_cleunik=".$row['rat_cleunik']." and uti_cleunik=$vl_e_uti_cleunik";
				//echo $sql_req_01;
				$result_01 = _graal_requete_bd($sql_req_01);
	      		$nb_row_01 = mysql_num_rows($result_01);
				_graal_libere_requete_bd($result_01);
				if ($nb_row_01!=0){
					$vf_b_renvoyer=true;
				} else {
					_graal_libere_requete_bd($result);
					return false;
				}
				
			}
			_graal_libere_requete_bd($result);
			$sql_req = "select f1.doc_cleunik from _documents_rattachement f1 left join _acteurs_blanc f2 on f1.rat_cleunik=f2.act_cleunik and f1.portee in(8192) ";
			$sql_req.= " where f1.doc_cleunik=$vv_cleunik and f2.uti_cleunik=$vl_e_uti_cleunik";
			$sql_req.= " union all ";
			$sql_req.= " select f1.doc_cleunik from _documents_rattachement f1 left join _graal f2 on f1.rat_cleunik=f2.action_cleunik left join _acteurs_blanc f3 on f3.act_cleunik=f2.act_cleunik ";
			$sql_req.= " where f1.doc_cleunik=$vv_cleunik and f3.uti_cleunik=$vl_e_uti_cleunik";
			
	      $result = _graal_requete_bd($sql_req);
	      $nb_row = mysql_num_rows($result);
			_graal_libere_requete_bd($result);
			$vf_b_renvoyer = ($sql_req." renvoie $nb_row résultats");
			//echo $sql_req;
			if ($nb_row!=0){
				$vf_b_renvoyer=true;
			} else {
				$vf_b_renvoyer=false;
			}
			break;
	}
		
		
		
		
		
	return $vf_b_renvoyer;
}
function fa_verifie_hash($vf_c_hash){
//  Vérification que le hash du document ne soit pas déjà présent
    $sql_req = "select count(*) FROM _documents WHERE hash = '$vf_c_hash' and typedoc in(3,9,13,153,154,900)";
    if ($res = _graal_requete_bd($sql_req)) {
      $ligne = mysql_fetch_row($res);
      $nombre_doc=$ligne[0];
      $vf_c_echo=$nombre_doc;
      $sql_req = "select doc_cleunik FROM _documents WHERE hash = '$vf_c_hash' and typedoc in(3,9,13,153,154,900)";
      if ($res = _graal_requete_bd($sql_req)) {
        $ligne = mysql_fetch_row($res);
        $vf_e_doc_cleunik=$ligne[0];
        $vf_c_echo.="|".$vf_e_doc_cleunik."|";
      }
    }
    else {
      $vf_c_echo="-1|-1|";
    }
	return $vf_c_echo;	
}
function fa_concat_plusieurs_pdf($vl_c_var){
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$vl_c_var"]);
    $tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."concatenation.pdf";
	$nom_fichier=$tmp.$nom_fichier_seul;
    $vl_e_i=-1;
    $liste_fichiers="";
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $liste_fichiers.=$vl_t_listecles[$vl_e_i].' ';
    }
    $argument="pdftk $liste_fichiers cat output $nom_fichier";
	exec($argument,$retour,$result);
	$path=$nom_fichier;
	return $path;
}
?>