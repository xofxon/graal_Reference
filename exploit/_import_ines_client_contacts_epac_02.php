<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','ines_epac');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_epac');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','clients');
$vl_c_quoi=fa_recup_param('quoi','');
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik',''));
$vl_valeur_a_tester=fa_recup_param('vl_valeur_a_tester','clients');
$vl_valeurs_exclues=fa_recup_param('vl_valeurs_exclues','clients');
$vf_e_typeacteur=110006;
$sql_req = "SELECT distinct($vl_c_quoi) FROM $vl_c_base_origine where CHAMP='$vl_valeur_a_tester' and $vl_c_quoi not in('$vl_valeurs_exclues')";
//echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=$vl_e_critere_cleunik";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  //$sql_req_01 .=",choix_code='".addslashes($row['Nom'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row["$vl_c_quoi"])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=127";
  $i++;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) {$vf_c_echo.=mysql_error($cnx) . $sql_req_01.EOL;} else {$vf_c_echo.='ok';}
}
//echo $vf_c_echo.EOL;
_graal_libere_requete_bd($result);
include("_import_ines_sp_array_tiers_contacts.php");
//var_dump($acteur_cod);
$t01_cod=array();$t01_cle=array();$t01_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=$vl_e_critere_cleunik";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t01_cod, $row['code']);
  array_push ($t01_cle, $row['cleunik']);
  array_push ($t01_tex, $row['text']);
}
_graal_libere_requete_bd($result);
//var_dump($t01_tex);
include("_import_class_data_km.php");
$sql_req = "";
$sql_req = "SELECT CT_REF,$vl_c_quoi FROM $vl_c_base_origine where CHAMP='$vl_valeur_a_tester' and $vl_c_quoi not in('$vl_valeurs_exclues')";
$sql_req.= " order by 1";
//$sql_req.=" Limit 10";
//echo $sql_req.EOL;
//die("$sql_req");
$result = _graal_requete_bd($sql_req);
$o_choix=new _graal_import();
$o_choix->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (int_cleunik,act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
session_write_close();
//if (1==2){
while ($row = mysql_fetch_assoc($result)) {
	$code_interlo=sprintf("%d",$row['CT_REF']);
	$vl_e_trouve_interlo=array_search($code_interlo, $int_cod);
	//die ("Trouvé ".$row['Code']);
	if ($vl_e_trouve_interlo===false) {
		//echo $code_acteur." pas trouvé".EOL;
	} else {
		$vf_e_act_cleunik=$act_cle[$vl_e_trouve_interlo];
		$vf_e_int_cleunik=$int_cle[$vl_e_trouve_interlo];
		//echo " $code_acteur trouve".EOL;
		$vl_e_choix_cleunik=0;
		$val_test=$row["$vl_c_quoi"];
		//echo $val_test.EOL;
	    if (trim($val_test!="")){
		    $vl_e_trouve=array_search($val_test, $t01_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t01_cle[$vl_e_trouve];}
		    if ($vl_e_choix_cleunik!=0) {
		    	$i++;
		      $o_choix->dat.="($vf_e_int_cleunik,$vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik,$vf_e_typeacteur),";
		      //echo $o_choix->dat.EOL;
		    } else {
		    	//echo "pas trouvé";
		    }
	    }
	    
		
	  if ($i % $i1==0){
	    //$o_choix->execute();
	    echo ($o_choix->execute());
	  }
	}
}
//$o_choix->execute();
echo ($o_choix->execute());
_graal_ferme_connexion();
echo("$i critères importés.");
?>
