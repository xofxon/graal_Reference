<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_fla_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_frla');
/*
 * Recherche ds dépôts
 */
$sql_req = "SELECT distinct(CodeDepot) as code FROM $vl_c_base_origine.stock where CodeDepot <> '' and CodeDepot not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=116);";
echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
$vf_c_echo="ok";
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_ins = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_ins .=" critere_cleunik=116";
  $sql_req_ins .=",choix_cleunik=$vf_e_choix_cleunik";
  $sql_req_ins .=",choix_code='".addslashes($row['code'])."'";
  $sql_req_ins .=",choix_valeur_texte_01='".addslashes($row['code'])."'";
  $sql_req_ins .=",choix_actif=1";
  $result_ins = _graal_requete_bd($sql_req_ins);
}
_graal_libere_requete_bd($result);
/*
 * Recherche des emplacements
 */
$sql_req = "SELECT distinct(Emplacement) as code FROM $vl_c_base_origine.stock where Emplacement <> '' and Emplacement not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=117);";
echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
$vf_c_echo="ok";
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_ins = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_ins .=" critere_cleunik=117";
  $sql_req_ins .=",choix_cleunik=$vf_e_choix_cleunik";
  $sql_req_ins .=",choix_code='".addslashes($row['code'])."'";
  $sql_req_ins .=",choix_valeur_texte_01='".addslashes($row['code'])."'";
  $sql_req_ins .=",choix_actif=1";
  $result_ins = _graal_requete_bd($sql_req_ins);
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($vf_c_echo);
?>
