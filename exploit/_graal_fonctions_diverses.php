<?php session_start();
$c_xmlns='xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul" xmlns:html="http://www.w3.org/1999/xhtml"';
function fa_acces_script() {
	if ($_SESSION["vs_envad"]==true) {
	  $origine=pathinfo(parse_url($_SERVER["HTTP_REFERER"], PHP_URL_PATH));
	  $origine_nom=$origine['filename'];
	  global $t_origines_ok;
	  $vl_pos=array_search($origine_nom,$t_origines_ok);
	  if ($vl_pos===false) {
	  	{header("Location: ./pagesparticulieres/accesprohibe_bis.php?reference=".$_SERVER["HTTP_REFERER"]."&script_en_cours=".$_SERVER["PHP_SELF"]."&o0=$origine_nom&o1=".$t_origines_ok[4]);}  //  On reste sur le site, sinon, on perds le bénéfice du https
	  	die("interditdacces|./pagesparticulieres/accesprohibe_bis.php?reference=".$_SERVER["HTTP_REFERER"]."&script_en_cours=".$_SERVER["PHP_SELF"]."&o0=$origine_nom&o1=".$t_origines_ok[4]);
	  }
	}
}
function fa_acces_script_test() {
  $origine=pathinfo(parse_url($_SERVER["HTTP_REFERER"], PHP_URL_PATH));
  $origine_nom=$origine['filename'];
  global $t_origines_ok;
  $vl_pos=array_search($origine_nom,$t_origines_ok);
  if ($vl_pos===false) {
    {header("Location: ./pagesparticulieres/accesprohibe_bis.php?reference=".$_SERVER["HTTP_REFERER"]."&script_en_cours=".$_SERVER["PHP_SELF"]."&o0=$origine_nom&o1=".$t_origines_ok[4]);}  //  On reste sur le site, sinon, on perds le bénéfice du https
    die();
    //fa_redirige("acces_prohibé");
  }
}
function fa_brik_checkbox_choix($vv_critere_cleunik,$vv_flex,$vv_portee,$vv_actif,$vv_choix_cleunik,$vv_id,$vv_observer,$vv_pref,$vv_grise,$vv_coche){
  switch ($vv_critere_cleunik) {
    case 98:
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS valeur,_choix.choix_valeur_texte_02 as type,choix_actif as actif ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN ($vv_critere_cleunik)";
      break;
  }
  if ($vv_portee!=-1) {$sql_req.=" and choix_portee & $vv_portee";}
  if ($vv_actif!=-1) {$sql_req.=" and choix_actif=$vv_actif";}
  if($vv_pref!=0) {$sql_req.=" and _choix.choix_valeur_texte_02 & $vv_pref";}
  $sql_req.=")";
  if ($vv_choix_cleunik!='') {$sql_req.=" or (choix_cleunik=$vv_choix_cleunik)";}
  $vl_id=$vv_id;
  $sql_req.=" ORDER BY choix_valeur_texte_01 ASC;";
  $sql_result = _graal_requete_bd($sql_req);
  $vl_e_nombre_types=mysql_num_rows($sql_result);
  $vv_brik="";
  if (trim($vv_observer)!="") {
    $vl_c_observer="observes='$vv_observer'";
  } else {
    $vl_c_observer="";
  }
  $vv_brik.='<vbox flex="'.$vv_flex.'" id="'.$vl_id.'" _graal_nombre="'.$vl_e_nombre_types.'" _graal_adr_typecoordonnees="0">';
  $i=-1;
  if ($vv_grise!=true) {
  $vl_c_fonction=<<<EOT
    if (this.checked==true) {
    fa_att_set("$vl_id","_graal_adr_typecoordonnees",parseInt(fa_att_get("$vl_id","_graal_adr_typecoordonnees"))+parseInt(fa_att_get(this.id,"_graal_adr_typecoordonnees")));
  } else {
    fa_att_set("$vl_id","_graal_adr_typecoordonnees",parseInt(fa_att_get("$vl_id","_graal_adr_typecoordonnees"))-parseInt(fa_att_get(this.id,"_graal_adr_typecoordonnees")));
  }
EOT;
  $vl_c_disabled="";
  } else {
    $vl_c_fonction="";
    $vl_c_disabled="disabled='true'";
  }
  if ($vv_coche==true) {
    $vl_coche="checked='true'";
  } else {
    $vl_coche="";
  }
  while ($row = mysql_fetch_assoc($sql_result)){
    $i++;
    if ($row['actif']==1) {
      $vv_brik.="<checkbox oncommand='$vl_c_fonction' $vl_c_observer $vl_c_disabled $vl_coche _graal_adr_typecoordonnees='" .fa_remplace_quotes(fa_ent_xml($row['type'])). "' id='cb_adresse".$i."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' />";
    } else {
      $vv_brik.="<checkbox oncommand='$vl_c_fonction' $vl_c_observer $vl_c_disabled $vl_coche _graal_adr_typecoordonnees='" .fa_remplace_quotes(fa_ent_xml($row['type'])). "' id='cb_adresse".$i."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' disabled='true' />";
    }
  }
  $vv_brik.='</vbox>';
  _graal_libere_requete_bd($sql_result);
  return $vv_brik;
}
function fa_brik_menulist_choix($vv_critere_cleunik,$vv_flex,$vv_portee,$vv_actif,$vv_choix_cleunik,$vv_id,$vv_observer,$vv_pref,$vv_cache="false"){
  switch ($vv_critere_cleunik) {
    case 66:
	  $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,concat_ws(' ',_choix.choix_valeur_texte_01,'(',_choix.choix_code,')') AS type_tiers,_choix.choix_actif as 'actif' FROM _choix WHERE (_choix.critere_cleunik=$vv_critere_cleunik "; // par pays
      break;
    case "59A": //  toutes les langues sauf le français
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' FROM _choix WHERE (_choix.critere_cleunik IN (59)";
      break;
    case "59B": //  toutes les langues sauf le français
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' FROM _choix WHERE (_choix.critere_cleunik IN (59) and _choix.choix_cleunik not in(120131)";
      break;
    case "92A":
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur',_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE ( _choix.critere_cleunik IN (92) ";
      if ($vv_portee!=-1) {$sql_req.=" and choix_portee & $vv_portee";}
      if ($vv_actif!=-1) {$sql_req.=" and choix_actif=$vv_actif";}
      $sql_req.=") UNION ";
      $sql_req.= "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur',_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix where critere_cleunik=92 and choix_cleunik in(select choix_cleunik from _act_interlo_choix_fixes where critere_cleunik=92 and _act_interlo_choix_fixes.int_cleunik=$vv_choix_cleunik)";
      $sql_req.= " ORDER BY 2 ASC;";

      break;
    case "94A": //  Tous les genres d'actions utilisés
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (94) and (SELECT count(*) as nombre from _actions where _actions.choix_cleunik = _choix.choix_cleunik) > 0";
      break;
    case "94B": //  Tous les genres d'actions utilisables en création
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (94) and (_choix.choix_cleunik > 0 or _choix.choix_cleunik IN (-110100,-110106,-110107))";
      break;
    case "94C":  //  Tous les genres d'action utilisables en modification
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur',_choix.choix_actif as 'actif' ";
      //$sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (94) and (_choix.choix_cleunik > 0 or _choix.choix_cleunik IN (-110100,-110101,-110102,-110103,-110104,-110106,-110107,-110108,-110109,-110110,-110111,-110112,-110113,-110114,-110115,-110116,-110117,-110118,-110119,-110120,-110121,-110122,-110123,-110124,-110125,-110126,-110127,-110128,-110129,-110130,-110131,-110132,-110133,-110134,-110135,-110136,-110137,-110138))";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (94) ";
      break;
    case "124A": //  Tous les statuts d'actions utilisés
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (124) and (SELECT count(*) as nombre from _actions where _actions.statut = _choix.choix_cleunik) > 0";
      break;
    case "129X":
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (129)";
      break;
    case "130X":
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS valeur,_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (130)";
      break;
    case 60:
    case "79":
    case 82:
    case 83:
    case 84:
    case 85:
    case 86:
    case 98:
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN ($vv_critere_cleunik)";
      break;
    case "xxx":
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur',_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE ( 1=2 ";
      break;
   case 116:
    case 117:
	  $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,concat_ws(' ',_choix.choix_valeur_texte_01,'(',_choix.choix_code,')') AS valeur,_choix.choix_actif as 'actif' FROM _choix WHERE (_choix.critere_cleunik=$vv_critere_cleunik "; // par pays, dépot, emplacement
      break;
    default:
      $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur',_choix.choix_actif as 'actif' ";
      $sql_req.= " FROM _choix WHERE ( _choix.critere_cleunik IN ($vv_critere_cleunik) ";
      break;
  }
  switch ($vv_critere_cleunik) {
    case "92A":
      break;
    default:
      if ($vv_portee!=-1) {$sql_req.=" and choix_portee & $vv_portee";}
      if ($vv_actif!=-1) {$sql_req.=" and choix_actif=$vv_actif";}
      $sql_req.=")";
      if ($vv_choix_cleunik!='') {$sql_req.=" or (choix_cleunik in($vv_choix_cleunik))";}
      break;
  }
  $vl_id=$vv_id;
  $cleunik='_graal_cleunik';
  switch ($vv_critere_cleunik) {
    case 108: //  unités de stock
    case 119: //  unités de reappro
    case 128: //  unités de conditionnement
    case 132: //  unités de poids
      $sql_req.=" ORDER BY actif,valeur ASC;";break;
    case "92A": //  Fonctions + Fonction utilisée par l'interlocuteur
      break;
    default : $sql_req.=" ORDER BY choix_valeur_texte_01 ASC;";break;
  }
  switch ($vv_critere_cleunik) {
    case "92A": //  Fonctions + Fonction utilisée par l'interlocuteur
      $sql_result = _graal_requete_bd($sql_req);
      break;
    default :
      $sql_result = _graal_requete_bd($sql_req);
      break;
  }
  $vl_e_nombre_types=mysql_num_rows($sql_result);
	switch ($vv_critere_cleunik) {
    case "94A": //  Tous les genres d'actions utilisés
    case "124A": //  Tous les statuts d'actions utilisés
    case "129X": //  Tous les statuts des lignes d'actions commerciales
    case "130X": //  Tous les genres de mouvements de stock
			$vl_e_nombre_types++;
      break;
  }
  $vv_brik="";

	/*
	 * Jusqu'au 24 décembre 2008,
	 * crop="none"
	 * sizetopopup="always"
	 *
	 */

  if (trim($vv_observer)!="") {
    $vv_brik.='<menulist sizetopopup="none" crop="end" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" class="sans_icone" old_class="menuitem-iconic" observes="'.$vv_observer.'" flex="'.$vv_flex.'" id="'.$vl_id.'" _graal_nombre="'.$vl_e_nombre_types.'">';
  } else {
    $vv_brik.='<menulist sizetopopup="none" crop="end" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" class="sans_icone" old_class="menuitem-iconic" flex="'.$vv_flex.'" id="'.$vl_id.'" _graal_nombre="'.$vl_e_nombre_types.'">';
  }
  $vv_brik.='<menupopup>';
  switch ($vv_critere_cleunik) {
    case "94A": //  Tous les genres d'actions utilisés
      $vl_c_dico_00071=fa_recup_dico("dico_00071");
      {$vv_brik.="<menuitem value='-1' id='-1' _graal_cleunik='-1' label='".$vl_c_dico_00071."' tooltiptext='".$vl_c_dico_00071."' selected='true'/>";}
      break;
    case "124A": //  Tous les statuts d'actions utilisés
      $vl_c_dico_00072=fa_recup_dico("dico_00072");
      {$vv_brik.="<menuitem value='-1' id='-1' _graal_cleunik='-1' label='".$vl_c_dico_00072."' tooltiptext='".$vl_c_dico_00072."' selected='true'/>";}
      break;
    case "129X": //  Tous les statuts des lignes d'actions commerciales
      $vl_c_dico_00072=fa_recup_dico("dico_00072");
      {$vv_brik.="<menuitem value='-1' id='-1' _graal_cleunik='-1' label='".$vl_c_dico_00072."' tooltiptext='".$vl_c_dico_00072."' />";}
      break;
	case "130X": //  Tous les genres de mouvements de stock
      $vl_c_dico_00072="Tous les genres de mouvements";
      {$vv_brik.="<menuitem value='-1' id='-1' _graal_cleunik='-1' label='".$vl_c_dico_00072."' tooltiptext='".$vl_c_dico_00072."' />";}
      break;
  }
  switch ($vv_critere_cleunik) {
    case "67":
    case "92":
    case "92A":
    case "94":
    case "94C":
    case "95":
    case 101:
    case 108:
    case 109:
    case 110:
    case "115":
    case 116:
    case 117:
    case 119:
    case 122:
    case 123:
    case "124":
    case 127:
    case 128:
    case "129":
    case 130:
    case 131:
    case 132:
    case 135:
    case 137:
    case 138:
    case 139:
    case 140:
    case 143:
    case 144:
    case 145:
    case 146:
    case "xxx":
      while ($row = mysql_fetch_assoc($sql_result)){
        $class="";
        if ($row['actif']==1) {
          $selected="";
          if($vv_pref!=0 && ($row['choix_cleunik']==$vv_pref)){$selected="selected='true'";}
          $vv_brik.="<menuitem crop='end' value='" .fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' $selected/>";}
        else {
          $class="class='obsolete'";
          $vv_brik.="<menuitem crop='end' $class value='" .fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur'])). "'  tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' disabled='true' />";
        }
      }
      break;
    default:
      while ($row = mysql_fetch_assoc($sql_result)) {
        $selected="";$class="";
        if($vv_pref!=0){
          if ($row['choix_cleunik']==$vv_pref) {$selected="selected='true'";}
        }
        if ($row['actif']==2) {$class="class='obsolete'";}
        $vv_brik.="<menuitem $class crop='end' value='" .fa_remplace_quotes(fa_ent_xml($row['type_tiers'])). "' id='".$row['choix_cleunik'] ."' ".$cleunik."='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['type_tiers']))."'  tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['type_tiers']))."' $selected/>";
      }
  }
  $vv_brik.='</menupopup>';
  $vv_brik.='</menulist>';
  _graal_libere_requete_bd($sql_result);
  return $vv_brik;
  //return $sql_req;
}
function fa_brik_menulist_utilisateurs($vv_flex="1",$vv_actif="1",$vv_id="ml_utilisateur",$vv_observer,$vv_except=""){
  if ($vv_observer==true) {
    $vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id' observer='broadcaster_01'><menupopup>";
  } else {
    $vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id'><menupopup>";
  }
  $sql_req = "SELECT _utilisateur.uti_cleunik as uti_cleunik,concat(_utilisateur.prenom,' ',_utilisateur.patronyme) AS prenom_nom,actif FROM _utilisateur where actif in ($vv_actif)";
  if ($vv_except!='') {$sql_req.=" and uti_cleunik not in($vv_except)";}
  $sql_req.=" order by patronyme;";
  $sql_result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($sql_result) == 0){
    $vv_brik.="<menuitem value='Aucun utilisateur !!!' _graal_cleunik='-1'fa_brik_menulist_choix label='Aucun utilisateur !!!' selected='true'/>";
  } else {
    while ($row = mysql_fetch_assoc($sql_result)){
      if ($row['actif']==2) {
        $classe="obsolete";
      } else {
        $classe="";
      }
      $vv_brik.="<menuitem class='$classe' _graal_cleunik='".$row['uti_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['prenom_nom']))."'  tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['prenom_nom']))."' selected='true'/>";
    }
  }
  $vv_brik.="</menupopup></menulist>";
  _graal_libere_requete_bd($sql_result);
  return $vv_brik;
}
function fa_brik_menulist_coche($vv_critere_cleunik,$vv_flex,$vv_portee,$vv_actif,$vv_choix_cleunik,$vv_id,$vv_observer,$vv_pref){
  $sql_req = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS type_tiers,_choix.choix_actif as 'actif' ";
  switch ($vv_critere_cleunik){
  	 case "94A": //  Tous les genres d'actions utilisés
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (94) and (SELECT count(*) as nombre from _actions where _actions.choix_cleunik = _choix.choix_cleunik) > 0";
      $oncommand="pf_deselectionne_choix_tous_genres();";
		$lib_tous=fa_ent_xml("< Tous les genres >");
      break;
    case '94x':
		$sql_req.= " FROM _choix WHERE (1=2 ";
		$oncommand="pf_deselectionne_choix_tous_genres();";
		$lib_tous="";
		break;
  	case 101:
		$sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN ($vv_critere_cleunik) ";
		$oncommand="pf_deselectionne_choix_tous_tarifs();";
		$lib_tous=fa_ent_xml("< Tous les tarifs >");
		break;
  	case 122:
		$sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN ($vv_critere_cleunik) and (SELECT count(*) as nombre from _actions where _actions.confidentialite = _choix.choix_cleunik) > 0";
		$oncommand="pf_deselectionne_choix_tous_confidentialite();";
		$lib_tous=fa_ent_xml("< Toutes les confidentialités >");
		break;
	case 123:
		$sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN ($vv_critere_cleunik) and (SELECT count(*) as nombre from _actions where _actions.priorite = _choix.choix_cleunik) > 0";
		$oncommand="pf_deselectionne_choix_tous_priorite();";
		$lib_tous=fa_ent_xml("< Toutes les priorités >");
		break;
	case 124:
		$sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN ($vv_critere_cleunik) and (SELECT count(*) as nombre from _actions where _actions.statut = _choix.choix_cleunik) > 0";
		$oncommand="pf_deselectionne_choix_tous_statuts();";
		$lib_tous=fa_recup_dico("dico_00072");
		break;
	case "130X":
      $sql_req.= " FROM _choix WHERE (_choix.critere_cleunik IN (130)";
      $oncommand="pf_deselectionne_choix_tous_mouvements();";
      $lib_tous=fa_ent_xml("< Tous les genres de mouvements >");
      break;

  }
  if ($vv_portee!=-1) {$sql_req.=" and choix_portee & $vv_portee";}
  if ($vv_actif!=-1) {$sql_req.=" and choix_actif=$vv_actif";}
  $sql_req.=")";
  if ($vv_choix_cleunik!='') {$sql_req.=" or (choix_cleunik in($vv_choix_cleunik))";}
  $vl_id=$vv_id;
  $cleunik='_graal_cleunik';
  $sql_req.=" ORDER BY choix_valeur_texte_01 ASC;";
  //die($sql_req);
  $sql_result = _graal_requete_bd($sql_req);
  $vl_e_nombre_types=mysql_num_rows($sql_result);
  if (trim($lib_tous)!=""){
  	$vl_e_nombre_types++;	//	il faut compter la ligne "Tous les statuts"
  }
  $vv_brik="";
  if (trim($vv_observer)!="") {
    $vv_brik.='<menulist sizetopopup="none" crop="end" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" class="menuitem-iconic" observes="'.$vv_observer.'" flex="'.$vv_flex.'" id="'.$vl_id.'" _graal_nombre="'.$vl_e_nombre_types.'">';
  } else {
    $vv_brik.='<menulist sizetopopup="none" crop="end" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" class="menuitem-iconic" flex="'.$vv_flex.'" id="'.$vl_id.'" _graal_nombre="'.$vl_e_nombre_types.'">';
  }
  $vv_brik.='<menupopup>';
  if (trim($lib_tous)!=""){
  	$vv_brik.="<menuitem value='-1' id='-1' _graal_cleunik='-1' label='".$lib_tous."' tooltiptext='".$lib_tous."' type='checkbox' checked='true'/>";
  }
  while ($row = mysql_fetch_assoc($sql_result)) {
    $selected="";$class="";
    if($vv_pref!=0){
      if ($row['choix_cleunik']==$vv_pref) {$selected="	checked='true'";}
    }
    if ($row['actif']==2) {$class="class='obsolete'";}
    $vv_brik.="<menuitem $class oncommand='$oncommand' type='checkbox' crop='none' value='" .fa_remplace_quotes(fa_ent_xml($row['type_tiers'])). "' id='".$row['choix_cleunik'] ."' ".$cleunik."='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['type_tiers']))."'  tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['type_tiers']))."' $selected/>";
  }
  $vv_brik.='</menupopup>';
  $vv_brik.='</menulist>';
  _graal_libere_requete_bd($sql_result);
  return $vv_brik;
}
function fa_compte_rc($vv_chaine) {
  $tableau=explode("\n",$vv_chaine);
  $vl_ligne=count($tableau);
  unset($tableau);
  return $vl_ligne;
}

function fa_cree_graal_cp00($vl_c_win_id,$vl_tc_composants=array()) {
	/*<key id="ctrl_f1" modifiers="control" keycode="VK_F1" oncommand="fa_infos_fenetre('$vl_c_win_id')"/>*/
$recinfos=<<<EOT
	<key id="ctrl_f1" modifiers="control" keycode="VK_F1" oncommand="fa_ouvre('_graal_fen_actions_post_it_01.php');"/>
EOT;
	$rectel=<<<EOT
	<key id="ctrl_f2" modifiers="control" keycode="VK_F2" oncommand="fa_ouvre_action('_graal_bdope_actions_01.php?vf_c_action=ajouterrectel','rectel');"/>
EOT;
	$html=<<<EOT
	<key id="ctrl_f3" modifiers="control" keycode="VK_F3" oncommand="fa_ouvre_action('_graal_fen_courriel_01.php?type=html','email_html');"/>
EOT;
	$quitter=<<<EOT
	<key id="ctrl_f4" modifiers="control" keycode="VK_F11" oncommand="fa_ferme();"/>
EOT;
	$texte=<<<EOT
	<key id="ctrl_f5" modifiers="control" keycode="VK_F5" oncommand="fa_ouvre_action('_graal_fen_courriel_01.php?type=texte','email_text');"/>
EOT;
	$emitel=<<<EOT
	<key id="ctrl_f6" modifiers="control" keycode="VK_F6" oncommand="fa_ouvre_action('','emitel');"/>
EOT;
	$lambda=<<<EOT
	<key id="ctrl_f7" modifiers="control" keycode="VK_F7" oncommand="fa_ouvre_action('','lambda');"/>
EOT;
	$favoris=<<<EOT
	<key id="ctrl_f9" modifiers="control" keycode="VK_F9" oncommand="fa_ouvre('_graal_fen_favoris_01.php');"/>
EOT;
	$nouveau=<<<EOT
	<key id="ctrl_f10" modifiers="control" keycode="VK_F12" oncommand="fa_ouvre('_graal_fen_menu003_00.php');"/>
EOT;
	$menu_lat=<<<EOT
	<key id="ctrl_alt_M" modifiers="control alt" keycode="M" oncommand="try {window.top.aad_pf_cache();}catch (e) {}"/>
EOT;
  $vl_c_chaine="";
  $vl_c_chaine.='<popupset >';
  $vl_c_chaine.='<popup id="graal_cp00">';
  $vl_c_chaine.='<menuitem class="normal" key="ctrl_f1" label="Informations sur la fenêtre" oncommand="fa_infos_fenetre('."'".$vl_c_win_id."')".'"/>';
  $vl_c_chaine.='</popup>';
  $vl_c_chaine.='</popupset>';
  $vl_c_chaine.='<keyset>';
	$vl_c_chaine.="$recinfos";
	$vl_c_chaine.="$rectel";
	$vl_c_chaine.="$html";
	$vl_c_chaine.="$quitter";
	$vl_c_chaine.="$texte";
	$vl_c_chaine.="$lambda";
	$vl_c_chaine.="$emitel";
	$vl_c_chaine.="$favoris";
	$vl_c_chaine.="$menu_lat";
	$vl_c_chaine.="$nouveau";
  $vl_c_chaine.='</keyset>';
  $vl_c_chaine.='<html:div class="cache" id="html_qui_grise"></html:div>';
  return $vl_c_chaine;
}
function fa_cree_raccourcis(&$vv_chaine,&$vv_tab){
/*
 * création des raccourcis claviers pour les onglets : code pas optimisé du tout !!!
 */
	$ok=false;$i_key=0;
	while ($ok===false) {
		//$vl_k=strtoupper($vv_chaine{$i_key});
		$vl_k=mb_strtoupper($vv_chaine{$i_key},'utf-8');	//	nécessaire depuis la 3.6 firefox
		$vl_e_trouve=array_search($vl_k, $vv_tab);
	  if ($vl_e_trouve===false) {
	  	array_push ($vv_tab, $vl_k);
			$ok=true;
	  } else {
	  	$i_key++;
			if ($i_key>=15){
				$vl_k="";
				$ok=true;
			}
	  }
	}
	return $vl_k;
}
function fa_echap_quotes($vl_c_chaine) {
  $a="'";$b="\'";
  $vl_c_nouveau=str_replace($a,$b,$vl_c_chaine);
  $a='"';$b='\"';
  $vl_c_nouveau=str_replace($a,$b,$vl_c_nouveau);
  return $vl_c_nouveau;
}
function fa_ent_xml($str) {
	$toto=preg_replace(array("'&'", "'\"'", "'<'","'>'","'\n'","'\''"), array('&#38;', '&#34;','&lt;','&gt;','&#10;','&#39;'), $str);
	return fa_ent_xml_cabal_02($toto);
  //return preg_replace(array("'&'", "'\"'", "'<'","'>'","'\n'"), array('&#38;', '&#34;','&lt;','&gt;','&#10;'), $str);
}
function fa_ent_xml_cabal($vv_chaine) {
  //Fonction servant à remplacer tous les caractères cabalistiques qui pourraient empêcher la construction d'un fichier XML
  $a[0]='/[^a-zéèàëê0-9]/i'; // Tout ce qui n'est pas compris entre a et z ou = éèàëê sans distinction de minuscule ou majuscule ou 0 à 9
  //$a[0]='[^:alnum:]|[:punct:]|[:space:]'; //  Tout ce qui n'est pas alphanumérique
  $b[0]='_';
  return preg_replace($a, $b, $vv_chaine);
}
function fa_ent_xml_cabal_01($vv_chaine) {
  //Fonction servant à remplacer tous les caractères cabalistiques qui pourraient empêcher la construction d'un fichier XML
  $a[0]='/[\x01\x02\x03\x04\x05\x06\x07\x08\x09\xOA\xOB\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f]/i'; // Les 32 premièrs caractères ascii
  $b[0]='';
  return preg_replace($a, $b, $vv_chaine);
}
function fa_ent_xml_cabal_02($vv_chaine){
	return preg_replace("/\\x0|[\x01-\x1f]/U","",$vv_chaine);
}
function fa_extension($file){
  $file=basename($file);
  if(eregi(".",$file)){
    $file_extension_tab=explode(".",$file);
    $file_extension=$file_extension_tab[count($file_extension_tab)-1];
    $file_extension=strtolower($file_extension);
    return $file_extension;
  } else {
    return "NULL";
  }
}
function fa_extrait_charset($url){
  $tab=get_headers($url,1);
  //var_dump($tab);
  $ct=$tab['Content-Type'];
  $charset="";
  if (is_array($ct)) {
    for($i=0;$i<sizeof($ct);$i++){
      if(preg_match('/charset=/i', $ct[$i])) {
        $pos = strpos($ct[$i], 'charset=');
        $charset=substr($ct[$i], ($pos+8), 50);
      }
    }
  } else {
    if(preg_match('/charset=/i', $ct)) {
      $pos = strpos($ct, 'charset=');
      $charset=substr($ct, $pos+8, 50);
    }
  }
  if ($charset!='') {return $charset;}
  $all_meta_tags=fa_get_all_meta_tags($url,array('only_property' => 'http-equiv'));
  $ct=$all_meta_tags['content-type'];
  if(preg_match('/charset=/i', $ct)) {
    $pos = strpos($ct, 'charset=');
    $charset=substr($ct, $pos+8, 50);
  }
/*
if (trim($charset)=="") {
  $charset=mb_detect_encoding($ct);
}
*/
  return $charset;
}
function fa_floatval($reel) {
  $a[0]="#,#"; // Remplace les virgules par des points dans les saisie de réèls
  $b[0]='.';
  $remplace=preg_replace($a, $b, $reel);
  return floatval($remplace);
}

function fa_get_all_meta_tags( $filename, $options = array() ) {

    $use_include_path   = ( isset($options['use_include_path']) && TRUE === $options['use_include_path'] );
    $all_attributes     = ( isset($options['all_attributes']) && TRUE === $options['all_attributes'] );
    $only_property      = ( isset($options['only_property']) && in_array(strtolower($options['only_property']), array('http-equiv', 'name')) ) ? strtolower($options['only_property']) : '';
    $result = array();

    // Chargement du contenu du fichier
    if ( !$content = @join('', @file($filename)) ) return FALSE;

    // Extraction et enregistrements de informations relatives aux balises méta présentes dans le document
    $pattern = ( $only_property != '' )
        ? '`<meta\s+(.*?'.$only_property.'.*?)\s*/?>`i'
        : '`<meta(.*?)\s*/?>`i';
    if ( !preg_match_all($pattern, $content, $matches) ) return $result;


        for ( $i = 0, $count = count($matches[0]), $attributes = array(); $i < $count; $i++ ) {

            // Extraction et enregistrements des attributs de la balise courante
            if ( preg_match_all('`([a-z\-]+)=(\'|")?(.*?)\\2|([a-z\-]+)=([^ ]+)`i', $matches[1][$i], $matchesAtt) ) {

                $attributes = array();

                // Extraction des attributs
                for ( $j = 0, $countAtt = count($matchesAtt[0]); $j < $countAtt; $j++ ) {
                    $key    = ( isset($matchesAtt[1][$j]) && !empty($matchesAtt[1][$j]) ) ? $matchesAtt[1][$j] : $matchesAtt[4][$j];
                    $value  = ( isset($matchesAtt[3][$j]) && !empty($matchesAtt[3][$j]) ) ? $matchesAtt[3][$j] : $matchesAtt[5][$j];
                    $attributes[$key] = $value;
                }

                // Enregistrement des informations pour la propriété courante ("http-equiv" ou "name")
                $myKey = $myValue = '';
                switch ( TRUE ) {
                    case ( array_key_exists('http-equiv', $attributes) ):
                        $myKey = 'http-equiv';
                        break;
                    case ( array_key_exists('name', $attributes) ):
                        $myKey = 'name';
                        break;
                    default:
                        continue;
                }
                $myValue = str_replace('.', '_', strtolower($attributes[$myKey]));
                unset($attributes[$myKey]);
                if ( $only_property == '' ) $result[$myKey][$myValue] = ( FALSE === $all_attributes ) ? $attributes['content'] : $attributes;
                else $result[$myValue] = ( FALSE === $all_attributes ) ? $attributes['content'] : $attributes;

        	}

    }

	return $result;

} // end of 'get_all_meta_tags()'
function fa_mime_type_buffer($flux) {
  if(!extension_loaded('fileinfo')) {
	dl('fileinfo.' . PHP_SHLIB_SUFFIX);
}
if(!extension_loaded('fileinfo')) {
	$mime=("fileinfo extension is not avaliable, please compile it");
	$mime="";
	return $mime;
}
  $finfo = new finfo(FILEINFO_MIME);
  $mime=$finfo->buffer($flux);
  return ($mime);
}
function fa_nn($vv_quoi){
  if (is_null($vv_quoi)) {return "null";} else {return $vv_quoi;}
}
function fa_nn_blanc($vv_quoi){
  if (is_null($vv_quoi)) {return "";} else {return $vv_quoi;}
}
function fa_nn_zero($vv_quoi){
  if (is_null($vv_quoi)) {return 0;} else {return $vv_quoi;}
}
function fa_nt($vv_quoi){
  if (is_null($vv_quoi)) {return "null";} else {return "'".addslashes($vv_quoi)."'";}
}
function fa_reel($nombre,$nb_decimales=2,$sep_decim='.',$sep_k=' ') {
return number_format($nombre,$nb_decimales,$sep_decim,$sep_k);
}
function fa_reel_fiche($nombre,$nb_decimales=2,$sep_decim='.',$sep_k='') {
	return $nombre;
	//return number_format($nombre,$nb_decimales,$sep_decim,$sep_k);
}

function fa_recup_balise_titre($url, &$info) {
//RECUPERATION balise titre
$fp = @fopen($url, "r");
if ($fp) {
    while ($line = fgets($fp)) {
      $line = trim($line);
      $test = strtolower($line);
      $opentitlepos = strpos($test, '<title>');
      if ($opentitlepos !== FALSE) {
        $closetitlepos = strpos($test, '</title>');
        if ($closetitlepos !== FALSE) {
          $info->title = substr($line, $opentitlepos + 7, $closetitlepos - ($opentitlepos + 7));
          break;
        }
      }
    }
    fclose($fp);
    return(TRUE);
}
else
  {
      return(FALSE);
  }
}
function fa_recup_dico($vl_c_param) {
  $vl_c_valdef="Et merde !!!";
  $vl_c_valdef=$vl_c_param;
  $vl_c_recup=isset($_SESSION[$vl_c_param]) ? $_SESSION[$vl_c_param] : $vl_c_valdef;
  $vl_c_recup=fa_ent_xml($vl_c_recup);
  return fa_remplace_quotes($vl_c_recup);
}
function fa_recup_dico_js($vl_c_param) {
  $vl_c_valdef="Et merde !!!";
  $vl_c_valdef=$vl_c_param;
  $vl_c_recup=isset($_SESSION[$vl_c_param]) ? $_SESSION[$vl_c_param] : $vl_c_valdef;
  return $vl_c_recup;
}
function fa_recup_dico_telquel($vl_c_param) {
  $vl_c_valdef="Et merde !!!";
  $vl_c_valdef=$vl_c_param;
  $vl_c_recup=isset($_SESSION[$vl_c_param]) ? $_SESSION[$vl_c_param] : $vl_c_valdef;
  return $vl_c_recup;
  //$vl_c_recup=fa_ent_xml($vl_c_recup);
  //return fa_remplace_quotes($vl_c_recup);
}
function fa_recup_telquel($vl_c_param,$vl_c_valdef) {
  $vl_c_recup=$vl_c_valdef;
  if (isset($_GET[$vl_c_param])) {
      $vl_c_recup=$_GET[$vl_c_param] ;
    }
    else if (isset($_POST[$vl_c_param])) {
      $vl_c_recup=$_POST[$vl_c_param] ;

    }
  return stripslashes($vl_c_recup);
}
function fa_recup_param($vl_c_param,$vl_c_valdef) {
  $vl_c_recup=$vl_c_valdef;
  if (isset($_GET[$vl_c_param])) {
      $vl_c_recup=get_magic_quotes_gpc() ? $_GET[$vl_c_param]:addslashes($_GET[$vl_c_param]) ;
    }
    else if (isset($_POST[$vl_c_param])) {
      $vl_c_recup=get_magic_quotes_gpc() ? $_POST[$vl_c_param]:addslashes($_POST[$vl_c_param]) ;
    }
  return $vl_c_recup;
}
function fa_recup_session($vl_c_param,$vl_c_valdef) {
  $vl_c_recup=isset($_SESSION[$vl_c_param]) ? $_SESSION[$vl_c_param] : $vl_c_valdef;
  return $vl_c_recup;
}
function fa_redirige($vv_genre) {
	global $vl_c_id_fenetre;
	global $sql_serveur;
	global $sql_user;
	global $sql_passwd;
	global $sql_bdd;
  switch ($vv_genre) {
    case "acces_interdit":
      //{header("Location: http://www.lemonde.fr");}  //  On reste sur le site, sinon, on perds le bénéfice du https
      {header("Location: ./pagesparticulieres/accesinterdit.php?fen=$vl_c_id_fenetre");}
      break;
		case "document_interdit":
			{header("Location: ./pagesparticulieres/documentinterdit.php");}
			break;
		case "courriel_interdit":
			{header("Location: ./pagesparticulieres/courrielinterdit.php");}
			break;
    case "acces_bizar":
      //{header("Location: http://moon.google.com/");}   //  On reste sur le site, sinon, on perds le bénéfice du https
      {header("Location: ./pagesparticulieres/accesmauvaisehumeur.php");}
      break;
    case "acces_prohibé":
      {header("Location: ./pagesparticulieres/accesprohibe.php");}  //  On reste sur le site, sinon, on perds le bénéfice du https
      die();
      break;

    case "deconnexion_intempestive":
  		//{header("Location: ./pagesparticulieres/mauvaiseconnexion.php?1=$sql_serveur&2=$sql_user&3=$sql_passwd&4=$sql_bdd&5=".$_SESSION["vsid_uuid"]);}

    	if ($_SERVER["HTTP_HOST"]!="localhost"){
      		{header("Location: ./pagesparticulieres/mauvaiseconnexion.php");}
      	} else {
      		{header("Location: ./pagesparticulieres/mauvaiseconnexion.php?1=$sql_serveur&2=$sql_user&3=$sql_passwd&4=$sql_bdd&5=".$_SESSION["vsid_uuid"]);}
      	}

      break;
    case "lune":
      {header("Location: http://moon.google.com/");}
			die();
      break;
    default :
      {header("Location: ".$vv_genre);}
  }

}
function fa_remplace_quotes($vl_c_chaine) {
  $a="'";
  $b="&apos;";
  $vl_c_nouveau=str_replace($a,$b,$vl_c_chaine);
  $a='"';
  $b="&quot;";
  $vl_c_nouveau=str_replace($a,$b,$vl_c_nouveau);
  return $vl_c_nouveau;
}
function fa_remplace_quotes_js($vl_c_chaine) {
  $a="'";
  $b="\'";
  $vl_c_nouveau=str_replace($a,$b,$vl_c_chaine);
  $a='"';
  $b='\"';
  $vl_c_nouveau=str_replace($a,$b,$vl_c_nouveau);
  return $vl_c_nouveau;
}
function fa_remplace_html_br($vl_c_chaine) {
  return preg_replace(array("'&#10;'","'\n'"), array('<html:br></html:br>','<html:br></html:br>'), $vl_c_chaine);
}
function fa_vire_script($vv_valeur) {
return preg_replace('@<script[^>]*?>.*?</script>@si', '', $vv_valeur);
/*
   $vf_c_blocnote_riche = eregi_replace("<script[^>.]*>","",$vf_c_blocnote_riche);
   $vf_c_blocnote_riche = eregi_replace("</script[^>.]*>","",$vf_c_blocnote_riche);
   // Si vous desirez enlever <div> ...
   //$texte = eregi_replace("<div[^>.]*>","",$texte);
*/
}
function fa_xcree_entete_rdf() {
//  Nommé comme cela pour être en fin de liste pour conserver la coloration syntaxique sous PSPad
$vl_c_entete='';
$vl_c_entete.='<?xml version="1.0" encoding="utf-8"?>';
$vl_c_entete.='<RDF:RDF xmlns:RDF="http://www.w3.org/1999/02/22-rdf-syntax-ns#"';
$vl_c_entete.=' xmlns:row="http://dummy/rdf#" xmlns:NC="http://home.netscape.com/NC-rdf#">';
$vl_c_entete.='<RDF:Bag about="urn:data:row">';
return $vl_c_entete;
}
function fa_xcree_entete_rdf_8859_1() {
//  Nommé comme cela pour être en fin de liste pour conserver la coloration syntaxique sous PSPad
$vl_c_entete='';
$vl_c_entete.='<?xml version="1.0" encoding="ISO-8859-1"?>';
$vl_c_entete.='<RDF:RDF xmlns:RDF="http://www.w3.org/1999/02/22-rdf-syntax-ns#"';
$vl_c_entete.=' xmlns:row="http://dummy/rdf#" xmlns:NC="http://home.netscape.com/NC-rdf#">';
$vl_c_entete.='<RDF:Bag about="urn:data:row">';
return $vl_c_entete;
}
function fa_xcree_entete_xml() {
//  Nommé comme cela pour être en fin de liste pour conserver la coloration syntaxique sous PSPad
$vl_c_entete='';
$vl_c_entete.='<?xml version="1.0" encoding="utf-8"?>';
return $vl_c_entete;
}
?>
