<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_cial_representant_01";
fa_acces_script();
$vf_c_echo="";
$genreaction=fa_recup_param("genreaction","??");
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik",-1));
$vl_e_action_cleunik=intval(fa_recup_param("vl_e_action_cleunik",-1));
switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
    $fichier="_".$genreaction."_representants";
    break;
  case "avocli":
	case "avofin":
    $fichier="_avocli_representants";
    break;

  default:
    $fichier="foireux";
    break;  //  Toutes les actions génériques
}
$vl_action_rep_cleunik=intval(fa_recup_param("vl_action_rep_cleunik",-1));
$vl_act_cleunik_rep=intval(fa_recup_param("vl_act_cleunik_rep",-1));
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_commission_typ=intval(fa_recup_param("vl_commission_typ","1"));
$vl_commission_taux=fa_floatval(fa_recup_param("vl_commission_taux","0"));
$vl_commission_fixe=fa_floatval(fa_recup_param("vl_commission_fixe","0"));
$vl_commission_regle=intval(fa_recup_param("vl_commission_regle","1"));
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM $fichier WHERE action_rep_cleunik=$vl_action_rep_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    $sql_req="delete FROM _graal where act_cleunik=$vl_act_cleunik_rep and int_cleunik=0 and action_cleunik=$vl_e_action_cleunik and choix_cleunik=-110427;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="ajouter":
    $vl_action_rep_cleunik=_graal_requete_max("action_rep_cleunik","$fichier");
    $sql_req = "INSERT INTO $fichier (action_rep_cleunik,commercial_cleunik,act_cleunik_rep,commission_typ,commission_taux,commission_fixe,commission_regle) VALUES ($vl_action_rep_cleunik,$vl_commercial_cleunik,$vl_act_cleunik_rep,$vl_commission_typ,$vl_commission_taux,$vl_commission_fixe,$vl_commission_regle)";
    $vf_c_echo=_graal_exec_requete($sql_req);
    $sql_req="INSERT INTO _graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ($vl_act_cleunik_rep,0,$vl_e_action_cleunik,-110427,8192,1);";
    //$vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE $fichier set commission_typ=$vl_commission_typ,commission_taux=$vl_commission_taux,commission_fixe=$vl_commission_fixe,commission_regle=$vl_commission_regle WHERE action_rep_cleunik=$vl_action_rep_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="kilometres_supprimer";
    $vl_t_action_rep_cleunik=fa_recup_param("vl_t_action_rep_cleunik","");
    $vl_t_action_rep_cleunik=unserialize(stripslashes($vl_t_action_rep_cleunik));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_t_action_rep_cleunik as $vl_raf) {
      $vl_e_i++;
      $vl_action_rep_cleunik=$vl_t_action_rep_cleunik[$vl_e_i];
      $sql_req = "DELETE FROM $fichier WHERE action_rep_cleunik=$vl_action_rep_cleunik;";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    }
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
//echo $sql_req;
?>
