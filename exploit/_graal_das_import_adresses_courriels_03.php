<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_mail.php");
$vv_quoi=fa_recup_param('quoi','adresses_courriel_site');
$vv_ou=fa_recup_param('ou','http://test03.christophe-charron.org/public/php/2008_09_30/2008_09_30_essais_courriels.htm');
$sess_id=session_id();
$path="mail/".$sess_id."_"._graal_requete_uuid();
$temp='mail/';
$path_data=$temp.$sess_id."_"._graal_requete_uuid()."_data";
switch ($vv_quoi) {
	case "liens":
	//$chaine = file_get_contents("http://www.christophe-charron.org/develo/xul/xul_index.php");
	//$chaine = file_get_contents("http://meltingpot.fortunecity.com/japan/148/wwfb/ac_c.html");
		$chaine = file_get_contents("$vv_ou");
		pf_saucissonne("liens");
		break;
	case "page":
		/*
		 * trouvé cette syntaxe ici http://www.tux-planet.fr/extraire-les-adresses-email-d-une-page-web/
		 *  mais elle n'est pas satisfaisante
		 * echo exec("wget -q -O - $vv_ou | grep -oe '\w*.\w*@\w*.\w*.\w\+' | sort -u");		
		*/
		/*
		 * trouvé une syntaxe plus satisfaisante ici  http://forum.ubuntu-fr.org/viewtopic.php?pid=2096058
		 */
		echo('<donnees>');
//		exec("wget -q -O - $vv_ou | grep -iEo '[a-z\.0-9\-\_]{1,}@[a-z0-9\-\_]*\.[a-z]{2,4}' | sort -u > $path");
//		exec("wget -q -O - $vv_ou | grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z]{2,4}' | sort -u > $path"); // ne prends pas les syntaxes de type moncourriel@cci.lyon.fr
		exec("wget -q -O - $vv_ou | grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z]{2,4}|[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z0-9_-]*\.[a-z]{2,4}' | sort -u > $path");
		if (!$handle = fopen($path, "r")) {
  		$retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
			echo('<quoi ');
			echo(' refweb="Adresse de site invalide"');
			echo('/>');
		} else {
		    while (!feof($handle)) {
					$buffer = fgets($handle, 4096);
					if (rtrim($buffer)!="") {
						echo('<quoi ');
	  				echo(' refweb="'.fa_ent_xml(rtrim($buffer,"\n")).'"');
						$vl_c_mailacontroler=str_replace(' ', '', rtrim($buffer,"\n"));
				    if(!ff_verifie($vl_c_mailacontroler)){ 
				      $vl_c_syntaxe_courriel="Attention, syntaxiquement, '$vl_c_mailacontroler' n'est pas une adresse e-mail valide.";
				    } else {
				      $vl_c_syntaxe_courriel="Syntaxiquement, '$vl_c_mailacontroler' est une adresse e-mail valide.";
				      $vl_c_syntaxe_courriel="Ok";
				    }
				    echo(' controle_01="'.fa_ent_xml($vl_c_syntaxe_courriel).'"');
						echo('/>');
					}
		    }
	    fclose($handle);
			unlink($path);
		}
		echo('</donnees>');
		break;
	case "fich":
	case "text":
		echo('<donnees>');
    $vl_c_data=fa_recup_session("$vv_ou",'');
    unset($_SESSION["$vl_c_var"]);
		if (!$handle = fopen($path_data, "w")) {
  		$retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
			echo('<quoi ');
			echo(' refweb="Adresse de site invalide"');
			echo('/>');
		} else {
			fwrite($handle,$vl_c_data);
			fclose($handle);
			//exec("grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z]{2,4}' $path_data | sort -u > $path");// ne prends pas les syntaxes de type moncourriel@cci.lyon.fr
			//exec("grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z0-9_-]*\.[a-z]{2,4}' $path_data | sort -u > $path");
			exec("grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z]{2,4}|[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z0-9_-]*\.[a-z]{2,4}' $path_data | sort -u > $path");
	    if (!$handle = fopen($path, "r")) {
	  		$retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
				echo('<quoi ');
				echo(' refweb="Adresse de site invalide"');
				echo('/>');
			} else {
		    while (!feof($handle)) {
					$buffer = fgets($handle, 4096);
					if (rtrim($buffer)!="") {
						echo('<quoi ');
	  				echo(' refweb="'.fa_ent_xml(rtrim($buffer,"\n")).'"');
						$vl_c_mailacontroler=str_replace(' ', '', rtrim($buffer,"\n"));
				    if(!ff_verifie($vl_c_mailacontroler)){ 
				      $vl_c_syntaxe_courriel="Attention, syntaxiquement, '$vl_c_mailacontroler' n'est pas une adresse e-mail valide.";
				    } else {
				      $vl_c_syntaxe_courriel="Syntaxiquement, '$vl_c_mailacontroler' est une adresse e-mail valide.";
				      $vl_c_syntaxe_courriel="Ok";
				    }
				    echo(' controle_01="'.fa_ent_xml($vl_c_syntaxe_courriel).'"');
						echo('/>');
					}
		    }
	    	fclose($handle);
				unlink($path);
			}
		}
		unlink($path_data);
		echo('</donnees>');
		break;
	case "sources_courriels":
		echo('<donnees>');
		$vl_c_var=fa_recup_param('var','vs_tempo_panier_action');
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$vl_c_var"]);
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $vl_action_cleunik.=$vl_t_listecles[$vl_e_i].',';
    }
    if ($vl_action_cleunik!="") {$vl_action_cleunik=substr($vl_action_cleunik, 0, -1);}
    $sql_cond=" action_cleunik IN ($vl_action_cleunik)";
		$vl_e_courriel_brut_cleunik=intval(fa_recup_param('vl_e_courriel_brut_cleunik','0'));
		$sql_req = "SELECT courriel AS courriel FROM _courriel_recus_brut WHERE $sql_cond;";
		$result = _graal_requete_bd($sql_req);
		while ($row = mysql_fetch_assoc($result)) {
			$vl_c_data.=$row['courriel'];
		}
		_graal_libere_requete_bd($result);
/*
			echo('<sql ');
			echo(' req="'.$sql_req.'"');
			echo('/>');
*/
		if (!$handle = fopen($path_data, "w")) {
  		$retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
			echo('<quoi ');
			echo(' refweb="Adresse de site invalide"');
			echo('/>');
		} else {
			fwrite($handle,$vl_c_data);
			fclose($handle);
			//exec("grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z]{2,4}' $path_data | sort -u > $path");// ne prends pas les syntaxes de type moncourriel@cci.lyon.fr
			//exec("grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z0-9_-]*\.[a-z]{2,4}' $path_data | sort -u > $path");
			exec("grep -iEo '[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z]{2,4}|[a-z\.0-9_-]{1,}@[a-z0-9_-]*\.[a-z0-9_-]*\.[a-z]{2,4}' $path_data | sort -u > $path");
	    if (!$handle = fopen($path, "r")) {
	  		$retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
				echo('<quoi ');
				echo(' refweb="Adresse de site invalide"');
				echo('/>');
			} else {
		    while (!feof($handle)) {
					$buffer = fgets($handle, 4096);
					if (rtrim($buffer)!="") {
						echo('<quoi ');
	  				echo(' refweb="'.fa_ent_xml(rtrim($buffer,"\n")).'"');
						$vl_c_mailacontroler=str_replace(' ', '', rtrim($buffer,"\n"));
				    if(!ff_verifie($vl_c_mailacontroler)){ 
				      $vl_c_syntaxe_courriel="Attention, syntaxiquement, '$vl_c_mailacontroler' n'est pas une adresse e-mail valide.";
				    } else {
				      $vl_c_syntaxe_courriel="Syntaxiquement, '$vl_c_mailacontroler' est une adresse e-mail valide.";
				      $vl_c_syntaxe_courriel="Ok";
				    }
				    echo(' controle_01="'.fa_ent_xml($vl_c_syntaxe_courriel).'"');
						echo('/>');
					}
		    }
	    	fclose($handle);
				unlink($path);
			}
		}
		unlink($path_data);
		echo('</donnees>');
		break;
}
function pf_saucissonne($vv_quoi) {
	global $chaine;
	switch ($vv_quoi) {
		case "liens":
			$motif='#<a href="(.*?)"(.*?)>#is';
			$motif='`<a(?:[^>]+?)?href="(.+?)"(?:[^>]*?)>((?:\s|.)*?)</a>`im';	//	récupéré dans phpsolutions 5/2008, page 31 (Robots d'indexation et référencement)
			break;
		case "adresses_courriel":
			break;		
	}
	preg_match_all($motif,$chaine,$out,PREG_PATTERN_ORDER);
	foreach ($out[1] as $link) {
		echo "$link<br />";
	}
}


?>
