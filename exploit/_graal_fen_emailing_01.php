<?php
include("_graal_header_xul.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_cryptage.php");
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_action_cleunik=intval(fa_recup_param('action_cleunik','-1'));
$vl_c_type_courriel=fa_recup_param('type','texte');
$vl_c_genre=fa_recup_param('genre','normal');
$vf_c_modification=fa_recup_param('modification','normal');// n'est utilisé que pour le renvoi de emailing (possibilité modification ou pas)
switch ($vl_c_genre) {
  case "normal":
    break;
  case "continuer":
    break;
}
switch ($vl_c_type_courriel) {
  case "texte":$vl_c_id_fenetre="Fen_00628";$vl_e_typedesinscription="902";$vl_e_typesondage="904";$vl_e_typedoc="6";break;//Envoi de courriels format texte brut
  case "html" :$vl_c_id_fenetre="Fen_00627";$vl_e_typedesinscription="901";$vl_e_typesondage="903";$vl_e_typedesinscription_texte="902";$vl_e_typesondage_texte="904";$vl_e_typedoc="10";$vl_e_typedoc_texte="6";break;//Envoi de courriels format html
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_b_ajout=$vl_tb_droits[1];
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bok_100=fa_recup_dico("bok_100");
$vl_c_bok_101=fa_recup_dico("bok_101");
$vl_c_bok_102=fa_recup_dico("bok_102");
$vl_c_bok_103=fa_recup_dico("bok_103");
$vl_c_bok_104=fa_recup_dico("bok_104");
$vl_c_bok_105=fa_recup_dico("bok_105");
$vl_c_bok_106=fa_recup_dico("bok_106");
$vl_c_bok_107=fa_recup_dico("bok_107");
$vl_c_bok_108=fa_recup_dico("bok_108");
$vl_c_bok_109=fa_recup_dico("bok_109");
$vl_c_bok_110=fa_recup_dico("bok_110");
$vl_c_bok_111=fa_recup_dico("bok_111");
$vl_c_bok_112=fa_recup_dico("bok_112");
$vl_c_bok_113=fa_recup_dico("bok_113");
$vl_c_bok_114=fa_recup_dico("bok_114");
$vl_c_bok_115=fa_recup_dico("bok_115");
$vl_c_bok_116=fa_recup_dico("bok_116");
$vl_c_bok_117=fa_recup_dico("bok_117");
$vl_c_bok_118=fa_recup_dico("bok_118");
$vl_c_bok_119=fa_recup_dico("bok_119");
$vl_c_bok_120=fa_recup_dico("bok_120");
$vl_c_bok_121=fa_recup_dico("bok_121");
$vl_c_bok_122=fa_recup_dico("bok_122");
$vl_c_bok_123=fa_recup_dico("bok_123");
$vl_c_bok_124=fa_recup_dico("bok_124");
$vl_c_bok_125=fa_recup_dico("bok_125");
$vl_c_bok_126=fa_recup_dico("bok_126");
$vl_c_bok_127=fa_recup_dico("bok_127");
$vl_c_bok_128=fa_recup_dico("bok_128");
$vl_c_bok_129=fa_recup_dico("bok_129");
$vl_c_bok_130=fa_recup_dico("bok_130");
$vl_c_bok_131=fa_recup_dico("bok_131");
$vl_c_bok_132=fa_recup_dico("bok_132");
$vl_c_bok_133=fa_recup_dico("bok_133");
$vl_c_bok_134=fa_recup_dico("bok_134");
$vl_c_bok_135=fa_recup_dico("bok_135");
$vl_c_bok_136=fa_recup_dico("bok_136");
$vl_c_bok_137=fa_recup_dico("bok_137");
$vl_c_bok_138=fa_recup_dico("bok_138");
$vl_c_bok_139=fa_recup_dico("bok_139");
$vl_c_bok_140=fa_recup_dico("bok_140");
$vl_c_bok_141=fa_recup_dico("bok_141");
$vl_c_bok_142=fa_recup_dico("bok_142");
$vl_c_bok_143=fa_recup_dico("bok_143");
$vl_c_bok_144=fa_recup_dico("bok_144");
$vl_c_bok_145=fa_recup_dico_js("bok_145");
$vl_c_bok_146=fa_recup_dico_js("bok_146");
$vl_c_bok_147=fa_recup_dico_js("bok_147");
$vl_c_bok_148=fa_recup_dico_js("bok_148");
$vl_c_bok_149=fa_recup_dico_js("bok_149");
$vl_c_bok_150=fa_recup_dico_js("bok_150");
$vl_c_bok_151=fa_recup_dico_js("bok_151");
$vl_c_bok_152=fa_recup_dico_js("bok_152");
$vl_c_bok_153=fa_recup_dico("bok_153");
$vl_c_bok_154=fa_recup_dico("bok_154");
$vl_c_bok_155=fa_recup_dico("bok_155");
$vl_c_bok_156=fa_recup_dico("bok_156");
$vl_c_bok_160=fa_recup_dico("bok_160");
$vl_c_bok_161=fa_recup_dico("bok_161");
$vl_c_bok_162=fa_recup_dico("bok_162");
$vl_c_bok_164=fa_recup_dico("bok_164");
$vl_c_bok_165=fa_recup_dico("bok_165");
$vl_c_bok_166=fa_recup_dico("bok_166");
$vl_c_bok_167=fa_recup_dico("bok_167");
$vl_c_bok_168=fa_recup_dico("bok_168");

$vl_c_bok_169=fa_recup_dico("bok_169");
$vl_c_bok_170=fa_recup_dico("bok_170");
$vl_c_bok_171=fa_recup_dico("bok_171");
$vl_c_bok_172=fa_recup_dico("bok_172");
$vl_c_bok_173=fa_recup_dico("bok_173");
$vl_c_bok_174=fa_recup_dico("bok_174");
$vl_c_bok_175=fa_recup_dico("bok_175");
$vl_c_bok_176=fa_recup_dico("bok_176");
$vl_c_bok_177=fa_recup_dico("bok_177");
$vl_c_bok_178=fa_recup_dico("bok_178");

$vl_c_bok_179=fa_recup_dico("bok_179");$vl_c_bok_179="Nom complet";
$vl_c_bok_180=fa_recup_dico("bok_180");$vl_c_bok_180="Prénom";
$vl_c_bok_181=fa_recup_dico("bok_181");$vl_c_bok_181="Civilité";
$vl_c_bok_182=fa_recup_dico("bok_182");$vl_c_bok_182="Insérer un lien tracking";
$vl_c_bok_183=fa_recup_dico("bok_183");$vl_c_bok_183="Insérer une pseudo-image pour tracer l'ouverture de l'emailing";
$vl_c_bok_184=fa_recup_dico("bok_184");$vl_c_bok_184="Intégrer une image et insérer un lien tracking";
$vl_c_bok_185=fa_recup_dico("bok_185");$vl_c_bok_185="Insérer un lien vers une image puis un lien tracking";


$vl_c_dico_00007=fa_recup_dico("dico_00007");
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_dico_00129=fa_recup_dico("dico_00129");
$vl_c_dico_00106=fa_recup_dico("dico_00106");
$vl_c_dico_00149=fa_recup_dico('dico_00149');
//  On recherche l'action d'origine
$vl_sujet="";
$vl_c_message_text_b64="";
//  On recherche tous les comptes possibles pour l'utilisateur
$vl_compte="<hbox>";
$sql_req = "SELECT _uti_cpt_bal.uticptbal_cleunik as cleunik,_uti_cpt_bal.titre as titre,_uti_cpt_bal.compte AS compte FROM _uti_cpt_bal,_droits_cpt_bal where _droits_cpt_bal.uti_cleunik=$vl_e_uti_cleunik and _droits_cpt_bal.uticptbal_cleunik=_uti_cpt_bal.uticptbal_cleunik and _uti_cpt_bal.genre = 1 order by titre;";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_compte.="<label value='$vl_c_boj_105' />";
}
else {
  $vl_b_envoi=false;
  $vl_compte.="<label value='$vl_c_boj_106'/><menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_emetteur'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)) {
  	$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
	$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
    $vl_c_smtp=$vl_c_xml->smtp[0]->attributes();
    if ($vl_c_smtp!="") {
      $vl_b_envoi=true;
      $vl_compte.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre'])). "' _graal_cleunik='".$row['cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' selected='true'/>";
    }
  }
  $vl_compte.="</menupopup></menulist>";
  if ($vl_b_envoi==true) {
$vl_bouton_envoi=<<<EOT
<button flex='1' id='bt_enregistrer' label='$vl_c_bok_101' crop='end' dir='normal' oncommand='pf_validation("enregistrer");' tabindex='5'/>
<button id="bt_envoi_requete" label="Exécuter la sélection" crop="end" dir="normal" oncommand="pf_validation('enregistrer');" collapsed="true"/>
EOT;
  }
}
$vl_compte.="</hbox>";
_graal_libere_requete_bd($sql_result);
$vl_modeles="";
if (($vl_e_action_cleunik==-1) || ($vf_c_modification=="modif")){
  //  On recherche tous les modèles
  $vl_modeles="<hbox>";
  $sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.descriptif_sommaire AS descriptif_sommaire FROM _droits_doc, _documents WHERE _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc=$vl_e_typedoc";
  $sql_result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($sql_result) == 0){
    $vl_modeles.="<label value='$vl_c_bok_111' />";
  }
  else {
    $vl_modeles.="<label value='$vl_c_bok_112'/>";
    switch ($vl_c_type_courriel) {
      case "texte":
        break;
      case "html":
        $vl_modeles.="<toolbarbutton tooltiptext='$vl_c_bok_153' id='bt_selectionne_note' class='ai02' onclick='pf_ouvre_selection_note();' />";
        break;
    }
    $vl_modeles.="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' id='ml_modeles' flex='1' oncommand='pf_top_model(fa_mlget(\"ml_modeles\"));'><menupopup><menuitem label='$vl_c_bok_116' _graal_cleunik='0' selected='true'/>";
    while ($row = mysql_fetch_assoc($sql_result)){
      $vl_modeles.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")". "' _graal_cleunik='".$row['doc_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")"."'/>";
    }
    $vl_modeles.="</menupopup></menulist>";
  }
  $vl_modeles.="</hbox>";
  _graal_libere_requete_bd($sql_result);
}
$vl_modeles_texte="";
if (($vl_e_action_cleunik==-1) || ($vf_c_modification=="modif")){
  //  On recherche tous les modèles
  $vl_modeles_texte="<hbox flex='1'>";
  $sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.descriptif_sommaire AS descriptif_sommaire FROM _droits_doc, _documents WHERE _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc=$vl_e_typedoc_texte";
  $sql_result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($sql_result) == 0){
    $vl_modeles_texte.="<label value='$vl_c_bok_111' />";
  }
  else {
    $vl_modeles_texte.="<label value='$vl_c_bok_112'/>";
    $vl_modeles_texte.="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' id='ml_modeles_texte' flex='1' oncommand='pf_top_model_texte(fa_mlget(\"ml_modeles_texte\"));'><menupopup><menuitem label='$vl_c_bok_116' _graal_cleunik='0' selected='true'/>";
    while ($row = mysql_fetch_assoc($sql_result)){
      $vl_modeles_texte.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")". "' _graal_cleunik='".$row['doc_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")"."'/>";
    }
    $vl_modeles_texte.="</menupopup></menulist>";
  }
  $vl_modeles_texte.="</hbox>";
  _graal_libere_requete_bd($sql_result);
}
$param_generaux_graal_030=intval(fa_recup_session('vs_param_generaux_graal_030','0'));
if ($param_generaux_graal_030==1) {$ra_affichernom_oui="selected='true'";}
if ($param_generaux_graal_030==2) {$ra_affichernom_non="selected='true'";}
$sql_req="SELECT titre,descriptif_sommaire,doc_cleunik FROM _documents WHERE _documents.typedoc = $vl_e_typedesinscription;";
$result = _graal_requete_bd($sql_req);
$nb_liens_desinscription=mysql_num_rows($result);
if ($nb_liens_desinscription!=0){
	$desinscription_emailing=<<<EOT
	<toolbarbutton type="menu-button" class="ac06" observes="broadcaster_02" id="tb_desinscription" tooltiptext="$vl_c_bok_161">
	  <menupopup>
EOT;
	while ($row = mysql_fetch_assoc($result)){
		$quoi_desinscription=fa_ent_xml($row['titre'])."(".fa_ent_xml($row['descriptif_sommaire']).")";
	  $desinscription_emailing.='<menuitem label="'.$quoi_desinscription.'" oncommand="pf_insere_desinscription(\''.fa_ent_xml($row['doc_cleunik']).'\');"/>';
	}
	$desinscription_emailing.="</menupopup></toolbarbutton>";
}
_graal_libere_requete_bd($result);
$sql_req="SELECT titre,descriptif_sommaire,doc_cleunik FROM _documents WHERE _documents.typedoc = $vl_e_typedesinscription_texte;";
$result = _graal_requete_bd($sql_req);
$nb_liens_desinscription=mysql_num_rows($result);
if ($nb_liens_desinscription!=0){
	$desinscription_emailing_texte=<<<EOT
	<toolbarbutton type="menu-button" class="ac06" observes="broadcaster_02" id="tb_desinscription_texte" tooltiptext="$vl_c_bok_161">
	  <menupopup>
EOT;
	while ($row = mysql_fetch_assoc($result)){
		$quoi_desinscription_texte=fa_ent_xml($row['titre'])."(".fa_ent_xml($row['descriptif_sommaire']).")";
	  $desinscription_emailing_texte.='<menuitem flex="1" label="'.$quoi_desinscription_texte.'" oncommand="pf_insere_desinscription_texte(\''.fa_ent_xml($row['doc_cleunik']).'\');"/>';
	}
	$desinscription_emailing_texte.="</menupopup></toolbarbutton>";
}
_graal_libere_requete_bd($result);
/*
 * sondages
 */
$param_generaux_graal_198=intval(fa_recup_session('vs_param_generaux_graal_198','0'));
if ($param_generaux_graal_030!=0) {
	$sql_req="SELECT titre,descriptif_sommaire,doc_cleunik FROM _documents WHERE _documents.typedoc = $vl_e_typesondage;";
	$result = _graal_requete_bd($sql_req);
	$nb_liens_sondage=mysql_num_rows($result);
	if ($nb_liens_sondage!=0){
		$sondage_emailing=<<<EOT
		<toolbarbutton type="menu-button" class="ac06" observes="broadcaster_02" id="tb_sondage" tooltiptext="Insérer un lien sondage">
		  <menupopup>
EOT;
		while ($row = mysql_fetch_assoc($result)){
			$quoi_sondage=fa_ent_xml($row['titre'])."(".fa_ent_xml($row['descriptif_sommaire']).")";
		  $sondage_emailing.='<menuitem label="'.$quoi_sondage.'" oncommand="pf_insere_sondage(\''.fa_ent_xml($row['doc_cleunik']).'\');"/>';
		}
		$sondage_emailing.="</menupopup></toolbarbutton>";
	}
	_graal_libere_requete_bd($result);
	$sql_req="SELECT titre,descriptif_sommaire,doc_cleunik FROM _documents WHERE _documents.typedoc = $vl_e_typesondage_texte;";
	$result = _graal_requete_bd($sql_req);
	$nb_liens_sondage=mysql_num_rows($result);
	if ($nb_liens_sondage!=0){
		$sondage_emailing_texte=<<<EOT
		<toolbarbutton type="menu-button" class="ac06" observes="broadcaster_02" id="tb_sondage_texte" tooltiptext="$Insérer un lien sondage">
		  <menupopup>
EOT;
		while ($row = mysql_fetch_assoc($result)){
			$quoi_sondage_texte=fa_ent_xml($row['titre'])."(".fa_ent_xml($row['descriptif_sommaire']).")";
		  $sondage_emailing_texte.='<menuitem flex="1" label="'.$quoi_sondage_texte.'" oncommand="pf_insere_sondage_texte(\''.fa_ent_xml($row['doc_cleunik']).'\');"/>';
		}
		$sondage_emailing_texte.="</menupopup></toolbarbutton>";
	}
	_graal_libere_requete_bd($result);
}

$param_generaux_graal_170=fa_recup_session('vs_param_generaux_graal_170',0); //  Adresse pour tracking
if (($param_generaux_graal_170=="0") || ($param_generaux_graal_170=="")) {
	$tracking="";
} else {
$tracking=<<<EOT
<toolbarbutton observes="broadcaster_01" class="aa13" tooltiptext="$vl_c_bok_182" oncommand="pf_insere_tracking();"/>
<toolbarbutton observes="broadcaster_01" class="aa13" tooltiptext="$vl_c_bok_184" oncommand="pf_insere_image_tracking();"/>
<toolbarbutton observes="broadcaster_01" class="aa13" tooltiptext="$vl_c_bok_185" oncommand="pf_insere_lien_image_tracking();"/>
EOT;
}
$param_generaux_graal_196=fa_recup_session('vs_param_generaux_graal_196',0); //Adresse de localisation des images "preuve" d'ouverture emailing
if (($param_generaux_graal_196=="0") || ($param_generaux_graal_196=="")) {
	$preuve_ouverture="";
} else {
$preuve_ouverture=<<<EOT
<toolbarbutton observes="broadcaster_01" class="ab17" tooltiptext="$vl_c_bok_183" oncommand="pf_insere_preuve_ouverture();"/>
EOT;
}
if (($vl_e_action_cleunik<>-1) && ($vf_c_modification=="modif")){
	$vl_c_bouton_modif_contenu="<button flex='1' id='bt_enregistrer_modif' label='Enregistrer le nouveau corps' crop='end' dir='normal' oncommand='pf_validation_modification()' tabindex='5'/>";
} else {
	$vl_c_bouton_modif_contenu="";
}
include("_graal_header_winxul.inc.php");
include("_graal_header_textfied.inc.php");
echo <<<END
<window context="graal_cp00" _graal_act_cleunik="$vl_e_act_cleunik" _graal_int_cleunik="$vl_e_int_cleunik" title="$vl_c_bok_102" id="_graal_emailing_01" onload="fa_aa(this);pf_etat_fen('ini')" onunload="pf_onunload();" $c_xmlns>
$vl_c_graal_cp00
<popup id="graal_cp_dest"><menuitem label="$vl_c_bok_141" oncommand="pf_supprime_ligne('li_dest_a');"/></popup>
<popup id="graal_cp_li_pj"><menuitem label="$vl_c_bok_141" oncommand="pf_supprime_ligne('li_pj');"/></popup>
<popup id="pop_selections">
	<menuitem class="menuitem-iconic ad09" label="$vl_c_dico_00106" oncommand="fa_infos_colonnes_arbre_recup('$vl_c_id_fenetre','arbre_deja_envoyes');" />
  <menuitem class="menuitem-iconic ai15" label="$vl_c_bok_165" oncommand="pf_acteur_ouvre();" />
  <menuitem class="menuitem-iconic ai18" label="$vl_c_bok_166" oncommand="pf_interlo_ouvre();" />
  <menuitem class="menuitem-iconic ag18" label="$vl_c_bok_167" oncommand="pf_courriel_ouvre('arbre_deja_envoyes');" />
</popup>
END;
include("js/_graal_03.js.php");
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include_once("js/_graal_05_dates.js.php");
include("js/_graal_emailing_01.js.php");
include("js/_graal_emailing_01_complement.js");
echo <<<END
  <tabbox id="tabbox_01" flex="1" orient="vertical" class="overflow_01">
    <tabs>
       <tab id="tab_edition" label="$vl_c_bok_103" selected="true" linkedpanel="tabpanel_edition"/>
       <tab id="tab_deja" label="$vl_c_bok_155" collapsed="true" linkedpanel="tabpanel_deja"/>
			 <tab id="tab_file_attente" label="$vl_c_bok_168" hidden="true" linkedpanel="tabpanel_file_attente"/>
       <tab id="tab_complement" linkedpanel="tabpanel_complement" label="$vl_c_bok_104"/>

    </tabs>
    <tabpanels flex="1">
		<tabpanel id="tabpanel_edition" flex="1">
      <hbox flex="1">
      <vbox id="messagepanel" flex="1">
        <vbox>
$vl_compte
<groupbox >
<hbox>
  <tabbox flex="1"  orient="horizontal" >
    <tabs  orient="vertical" class="tabs-left">
       <tab label="$vl_c_bok_107" id="tab_dest_a" linkedpanel="tabpanel_dest_a" class="tab-left" />
       <tab label="$vl_c_bok_138" id="tab_pj" linkedpanel="tabpanel_pj" class="tab-left"/>
    </tabs>
    <tabpanels flex="1" >
       <tabpanel id="tabpabnel_dest_a" >
        <vbox flex="1">
               <hbox flex="1">
          <label id="id_encore" value="$vl_c_bok_156" collapsed="true"/>
          <button id="bt_panier_dest_a" class="al02" onclick="pf_ouvre_panier_courriel(this.id)" label="$vl_c_bok_156" flex="1"/>
         <hbox collapsed="true">
        <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
          minlength="2"
          maxrows="50"
          ref="urn:suggest:values"
          label="?label"
          properties="?prop"
          issuggest="?issuggest"


          _graal_cleunik=""
          id="dest_a"
          tabindex="1"
        />
        <toolbarbutton id="bt_dest_a" class="ad02" label="$vl_c_bok_139" oncommand="pf_sel_courriel(this.id);" tabindex="2"/>
        </hbox>
        </hbox>
        <tree flex="40" id="arb_destinataires" enableColumnDrag="true" flags="" ref="*" querytype="xml" datasources="" onselect="" context="">
     <treecols>
      <treecol id="arb_dest_courriel" label="$vl_c_bok_132" sort="?refweb"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="arb_dest_nompreno" label="$vl_c_bok_179" sort="?prenom_nom"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="arb_dest_civilite" label="$vl_c_bok_181" sort="?civilite"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="arb_dest_prenom" label="$vl_c_bok_180" sort="?prenom"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="arb_dest_nom" label="$vl_c_bok_133" sort="?patronyme"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="arb_dest_intweb_cleunik" label="intweb_cleunik"  hidden="true" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="arb_dest_int_cleunik" label="int_cleunik"  hidden="true" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
     </treecols>
     <template><query expr="*"/><action>
       <treechildren >
         <treeitem uri="?" seltype="single">
           <treerow >
             <treecell label="?refweb"/>
             <treecell label="?prenom_nom"/>
             <treecell label="?civilite"/>
             <treecell label="?prenom"/>
             <treecell label="?patronyme"/>
             <treecell label="?intweb_cleunik"/>
             <treecell label="?int_cleunik"/>
             </treerow>
         </treeitem>
       </treechildren>
     </action></template>
   </tree>


                          <listbox rows="4" id="li_dest_a" context="graal_cp_dest" collapsed="true">
                    <listhead >
                      <listheader label="$vl_c_bok_132" />
                      <listheader label="$vl_c_bok_179" />
					  <listheader label="$vl_c_bok_181" />
					  <listheader label="$vl_c_bok_180" />
					  <listheader label="$vl_c_bok_133" />
                    </listhead>
                    <listcols >
              	     <listcol flex="1"/>
                     <listcol flex="1"/>
              	     <listcol flex="1"/>
                     <listcol flex="1"/>
              	     <listcol flex="1"/>
                    </listcols>
                  </listbox>

        </vbox>


      </tabpanel>
    <tabpanel id="tabpabnel_pj" >
  <vbox flex="1">
END;
if (($vl_e_action_cleunik==-1) || ($vf_c_modification=="modif")){
echo <<<END
    <hbox flex="1">
      <toolbarbutton observes="broadcaster_01" class="al02" tooltiptext="$vl_c_bok_135" id="tb_ouvre_fichier_disque" oncommand="pf_ouvre_fichier('disque');"/>
      <toolbarbutton observes="broadcaster_01" class="ai03" tooltiptext="$vl_c_bok_136" id="tb_ouvre_fichier_ged" oncommand="pf_ouvre_fichier('ged');"/>
      <toolbarbutton observes="broadcaster_01" class="al14" tooltiptext="$vl_c_bok_137" id="tb_ouvre_fichier_pj" oncommand="pf_ouvre_panier_pj();"/>
      <hbox flex="1">
        <textbox flex="7" observes="broadcaster_01" id="tb_emplacement"   maxlenght="260"/>
      </hbox>
    </hbox>
END;
}
echo <<<END
    <listbox rows="4" flex="1" context="graal_cp_li_pj" id="li_pj">
      <listhead >
        <listheader label="$vl_c_bok_134" />
      </listhead>
      <listcols >
        <listcol flex="1"/>
      </listcols>
    </listbox>
  </vbox>
</tabpanel>

    </tabpanels>
  </tabbox>

</hbox>
</groupbox>

          <hbox flex="1">
          <label value="$vl_c_bok_110"/>
          <textbox flex="1" id="tb_sujet"   tabindex="3"/>
          </hbox>

        </vbox>
        <deck id="dk_01" selectedIndex="0" flex="1">
        <_graal_deck value="Deck n° 1 du message">
END;
switch ($vl_c_type_courriel) {
  case "texte":
    echo('<textbox id="tb_message" multiline="true" wrap="off" flex="1" value=""   tabindex="4"/>');
    break;
  case "html":
echo<<<END
		<tabbox flex="1"  orient="horizontal" >
    <tabs  orient="vertical" class="tabs-left">
       <tab label="Partie HTML" id="tab_corpus_html" linkedpanel="tabpanel_corpus_html" class="tab-left" />
       <tab label="Partie Texte" id="tab_corpus_text" linkedpanel="tabpanel_corpus_text" class="tab-left"/>
    </tabs>
    <tabpanels flex="1" >
       <tabpanel id="tabpanel_corpus_html" >
END;
    echo('<vbox flex="1">');
		echo($vl_modeles);
		if (($vl_e_action_cleunik==-1) || ($vf_c_modification=="modif")){
      include("js/_graal_editeur_wysiwyg.js.php");
      include("_graal_inc_baroutils_01.php");
      include("_graal_inc_baroutils_02.php");
    }
    echo('<deck id="workarea" flex="1">');
		echo('<html:iframe onload="event.stopPropagation();" id="content" flex="2" src="_graal_page_blanche_02.php" />');
		echo('<vbox flex="2"><textbox flex="1" multiline="true" id="tb_source"/><button label="Modifier le html" oncommand="pf_retro();"/></vbox>');
    echo('</deck>');
    echo('</vbox>');
    break;
}
echo <<<END
		</tabpanel>
		<tabpanel id="tabpanel_corpus_text" >
			<vbox flex="1">
				<hbox>$vl_modeles_texte $desinscription_emailing_texte $sondage_emailing_texte</hbox>
				<textbox id="tb_message_texte" multiline="true" wrap="off" flex="1" value=""   />
			</vbox>
		</tabpanel>
		</tabpanels>
		</tabbox>
          </_graal_deck>
          <_graal_deck value="Deck n° 2 pour erreur">
            <vbox flex="1">
              <textbox id="tb_cr" multiline="true" wrap="on" flex="1" value=""  />
              <button label="$vl_c_bok_115"  oncommand="fa_gid('dk_01').selectedIndex=0;" />
            </vbox>
          </_graal_deck>
          <_graal_deck value="Deck n° 3 RAF invisible">
            <vbox flex="1">
              <html:iframe onload="event.stopPropagation();" id="faux_content" src="$vl_c_message_text_b64_brut" />
              <html:iframe onload="event.stopPropagation();" id="faux_entete" src="$vl_c_message_head_b64_brut" />
            </vbox>
          </_graal_deck>

        </deck>
        <vbox><hbox>
      <deck id="dk_02" selectedIndex="0" flex="1">
        <_graal_deck value="Deck boutons de validation">
          <button flex="1" id="bt_raf" label="$vl_c_bok_162" crop="end" dir="normal" oncommand="pf_raf();" tabindex="5"/>
		  $vl_c_bouton_modif_contenu
		$vl_bouton_envoi
        <button flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
		<button flex="1" id="bt_raz" label="$vl_c_dico_00129" crop="end" dir="normal" oncommand="pf_etat_fen('annuler');" />
		<button id="bt_info_fen" class="ab19" label="$vl_c_dico_00149"  crop="end" dir="normal" oncommand="fa_infos_fenetre('$vl_c_win_id')" />
        </_graal_deck>
        <_graal_deck value="Deck boutons retour validation">
          <button flex="1" id="bt_validation_ok" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('reinitialise');" />
        </_graal_deck>
      </deck>
   </hbox></vbox>
   </vbox>

    </hbox>
  </tabpanel>

<!--  Début Complément-->
		<tabpanel id="tabpanel_deja" >
		<vbox flex="1">
		<toolbar id="tob_deja_envoye" grippyhidden="true" collapsed="true" >
				<toolbarbutton id="tb_nombre_destinataires" label="" tooltiptext="$vl_c_bok_172" _graal_nombre="0"/>
  		  <toolbarbutton class="table-rafraichir" tooltiptext="$vl_c_bok_173" oncommand="pf_affiche_deja_envoyes_force();"/>
		</toolbar>
		<tree id="arbre_deja_envoyes" flex="1" flags="" ref="*" querytype="xml" datasources="" seltype="" enableColumnDrag="true" context="pop_selections">
    <treecols>
      <treecol id="tc_refweb_deja" label="$vl_c_bok_132" sort="?refweb"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_prenom_nom_deja" label="$vl_c_bok_133" sort="?prenom_nom"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_nomcommercial_deja" label="$vl_c_bok_164" sort="?nomcommercial"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_intweb_cleunik_deja" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_int_cleunik_deja" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_act_cleunik_deja" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_typeacteur_deja" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
    </treecols>
    <template><query expr="*"/><action>
      <treechildren>
        <treeitem uri="?" seltype="single">
          <treerow>
            <treecell label="?refweb" properties="?prop_ref_web"/>
            <treecell label="?prenom_nom" properties="?prop_interlo"/>
						<treecell label="?nomcommercial" properties="?prop_acteur"/>
						<treecell label="?intweb_cleunik"/>
						<treecell label="?int_cleunik"/>
						<treecell label="?act_cleunik"/>
						<treecell label="?typeacteur"/>
					</treerow>
        </treeitem>
      </treechildren>
    </action></template>
  </tree>
	</vbox>


		</tabpanel>

		<tabpanel id="tabpanel_file_attente">
		<vbox flex="1">
		<toolbar id="tob_file_attente" grippyhidden="true" >
				<toolbarbutton id="tb_nombre_destinataires_file_attente" label="0" tooltiptext="$vl_c_bok_174" _graal_nombre="0"/>
  		  <toolbarbutton class="table-rafraichir" tooltiptext="$vl_c_bok_175" oncommand="pf_affiche_attente_force();"/>
				<toolbarbutton class="table-rafraichir" tooltiptext="N'afficher que le nombre 'envoyable'" oncommand="pf_affiche_attente_force_limite();"/>
				<toolbarbutton id="bt_panier_file_attente" class="al02" tooltiptext="Ajouter des courriels à la file d'attente" onclick="pf_ouvre_panier_courriel(this.id)" />
				<toolbarbutton hidden="true" id="bt_panier_file_attente_ajouter" tooltiptext="Ajouter des courriels à la file d'attente" class="al02" onclick="pf_ouvre_panier_courriel(this.id)" />
		</toolbar>
		<tree id="arbre_file_attente" flex="1" flags="" ref="*" querytype="xml" datasources="" seltype="" enableColumnDrag="true" context="pop_file_attente">
    <treecols>
      <treecol id="tc_refweb_file_attente" label="$vl_c_bok_169" sort="?refweb"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_prenom_nom_file_attente" label="$vl_c_bok_170" sort="?prenom_nom"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_nomcommercial_file_attente" label="$vl_c_bok_171" sort="?nomcommercial"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_intweb_cleunik_file_attente" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_int_cleunik_file_attente" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_act_cleunik_file_attente" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_typeacteur_file_attente" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
    </treecols>
    <template><query expr="*"/><action>
      <treechildren>
        <treeitem uri="?" seltype="single">
          <treerow>
            <treecell label="?refweb" properties="?prop_ref_web"/>
            <treecell label="?prenom_nom" properties="?prop_interlo"/>
						<treecell label="?nomcommercial" properties="?prop_acteur"/>
						<treecell label="?intweb_cleunik"/>
						<treecell label="?int_cleunik"/>
						<treecell label="?act_cleunik"/>
						<treecell label="?typeacteur"/>
					</treerow>
        </treeitem>
      </treechildren>
    </action></template>
  </tree>
	<button width="40" id="bt_validation_attente" label="Envoyer la liste d'attente (dans la limite de la quantité restante autorisée). Peut-être assez long ..." crop="end" dir="normal" oncommand="pf_valid_attente();" collapsed="true"/>
	</vbox>


		</tabpanel>



  	<tabpanel id="tabpanel_complement">
          <vbox>
            <groupbox>
              <caption><label value="$vl_c_bok_160" /></caption>
              <radiogroup id='rdg_affichernom' value="$param_generaux_graal_030">
                <radio id='ra_affichernom_oui' label="$vl_c_dico_00013" value='1' dir="reverse" $ra_affichernom_oui/>
                <radio id='ra_affichernom_non' label="$vl_c_dico_00014" value='2' $ra_affichernom_non/>
               </radiogroup>
							 <vbox>
							 	<label value="Texte de remplacement"/>
								<textbox id="tb_remplacement_noms" value=""/>
							</vbox>
            </groupbox>
        </vbox>

      <vbox flex="0">
        <hbox flex="0">
          <hbox>
            <groupbox>
              <caption><label value="$vl_c_bok_117" /></caption>
              <radiogroup id='rdg_unpardestinataire' >
                <radio id='ra_unpardestinataire_oui' label="$vl_c_dico_00013" value='1' dir="reverse"/>
                <radio id='ra_unpardestinataire_non' label="$vl_c_dico_00014" value='2' />
               </radiogroup>
            </groupbox>
            <groupbox>
              <caption><label value="$vl_c_bok_118" /></caption>
              <radiogroup id='rdg_uneactionpardestinataire' >
                <radio id='ra_uneactionpardestinataire_oui' label="$vl_c_dico_00013" value='1' dir="reverse"/>
                <radio id='ra_uneactionpardestinataire_non' label="$vl_c_dico_00014" value='2' />
               </radiogroup>
            </groupbox>
          </hbox>
        </hbox>

        <hbox flex="0">
          <hbox>
            <groupbox>
              <caption><label value="$vl_c_bok_119" /></caption>
              <radiogroup id='rdg_priorite' >
                <radio id='ra_priorite_0' label="$vl_c_bok_130" value='0' dir="reverse"/>
                <radio id='ra_priorite_1' label="$vl_c_bok_121" value='1' />
                <radio id='ra_priorite_2' label="$vl_c_bok_122" value='2' />
                <radio id='ra_priorite_3' label="$vl_c_bok_123" value='3' />
                <radio id='ra_priorite_4' label="$vl_c_bok_124" value='4' />
                <radio id='ra_priorite_5' label="$vl_c_bok_125" value='5' />
               </radiogroup>
            </groupbox>
            <groupbox>
              <caption><label value="$vl_c_bok_120" /></caption>
              <radiogroup id='rdg_sensitivite' >
                <radio id='ra_sensitivite_0' label="$vl_c_bok_131" value='0' dir="reverse"/>
                <radio id='ra_sensitivite_1' label="$vl_c_bok_126" value='1' />
                <radio id='ra_sensitivite_2' label="$vl_c_bok_127" value='2' />
                <radio id='ra_sensitivite_2' label="$vl_c_bok_128" value='2' />
                <radio id='ra_sensitivite_2' label="$vl_c_bok_129" value='2' />
               </radiogroup>
            </groupbox>
            <groupbox>
              <caption><label value="$vl_c_bok_140" /></caption>
              <radiogroup id='rdg_integre_pj_sipossible' >
                <radio id='ra_integre_pj_sipossible_1' label="$vl_c_dico_00013" value='1' />
                <radio id='ra_integre_pj_sipossible_2' label="$vl_c_dico_00014" value='2' dir="reverse"/>
               </radiogroup>
            </groupbox>

          </hbox>
        </hbox>
        <hbox flex="0">
          <hbox>
            <groupbox>
              <caption><label value="$vl_c_bok_142" /></caption>
              <radiogroup id='rdg_confirmation_lecture' >
                <radio id='ra_confirmation_lecture_1' label="$vl_c_dico_00013" value='1' />
                <radio id='ra_confirmation_lecture_2' label="$vl_c_dico_00014" value='2' dir="reverse"/>
               </radiogroup>
            </groupbox>

          </hbox>
        </hbox>
			<textbox id="tb_c_uuid" hidden="true" value="" />
      </vbox>
      <vbox flex="1">
      </vbox>
		</tabpanel>
<!--  Fin Onglet compléments -->
    </tabpanels>
  </tabbox>
 </window>
END;
?>
