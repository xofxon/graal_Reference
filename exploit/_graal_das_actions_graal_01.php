<?php
include("_graal_header_xml.inc.php");
include("_graal_var_portee.php");
$vl_e_action_cleunik=intval(fa_recup_param('vl_action_cleunik','10281'));
$vl_c_sortie=fa_recup_param('sortie','das');
$prop_acteur_principal="ad05";
// execution de la requÃ¨te SQL
$sql_req = "SELECT f01.act_cleunik as `act_cleunik`,f01.int_cleunik as `int_cleunik`,f01.action_cleunik as `action_cleunik`,f01.choix_cleunik as `choix_cleunik`,f01.portee as `portee`,f02.choix_valeur_texte_01 as `choix_valeur_texte_01`,case f03.nomcommercial when '' then f03.raisonsoc else f03.nomcommercial END as `raisonsoc`,'' as `interlocuteur`,'ai15' as prop_act,'' as prop_int,f07.choix_valeur_texte_01 as type_acteur_en_clair,f01.principal as principal,f03.actif as act_actif,1 as int_actif FROM _graal f01,_choix f02,_acteurs f03,_choix f07 where action_cleunik=$vl_e_action_cleunik and f01.portee = $vl_e_acteur and f02.choix_cleunik=f01.choix_cleunik and f01.act_cleunik=f03.act_cleunik and f07.choix_cleunik=f03.typeacteur"; 
$sql_req.=" union all "; 
$sql_req.="SELECT f01.act_cleunik as `act_cleunik`,f01.int_cleunik as `int_cleunik`,f01.action_cleunik as `action_cleunik`,f01.choix_cleunik as `choix_cleunik`,f01.portee as `portee`,f02.choix_valeur_texte_01 as `choix_valeur_texte_01`,case f03.nomcommercial when '' then f03.raisonsoc else f03.nomcommercial END as `raisonsoc`,concat_ws(' ',f05.choix_valeur_texte_01,f04.prenom,f04.patronyme) as `interlocuteur`,'' as prop_act,'ai18' as prop_int,f07.choix_valeur_texte_01 as type_acteur_en_clair,f01.principal as principal,f03.actif as act_actif,f04.actif as int_actif FROM _graal f01,_choix f02,_acteurs f03,_act_interlo f04,_choix f05,_choix f07 where action_cleunik=$vl_e_action_cleunik and f02.choix_cleunik=f01.choix_cleunik and f01.act_cleunik=f03.act_cleunik and f04.int_cleunik =f01.int_cleunik and f05.choix_cleunik = f04.choix_cleunik and f01.portee = $vl_e_interl and f07.choix_cleunik=f03.typeacteur;"; 
switch ($vl_c_sortie) {
  case "das":
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
		exit();
    break;
  }
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
  echo(' int_cleunik="'.fa_ent_xml($row['int_cleunik']).'"');
  echo(' action_cleunik="'.fa_ent_xml($row['action_cleunik']).'"');
  echo(' choix_cleunik="'.fa_ent_xml($row['choix_cleunik']).'"');
  echo(' portee="'.fa_ent_xml($row['portee']).'"');
  echo(' choix_valeur_texte_01="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
  echo(' raisonsoc="'.fa_ent_xml($row['raisonsoc']).'"');
  echo(' interlocuteur="'.fa_ent_xml($row['interlocuteur']).'"');
  
  if ($row['prop_int']=='ai18') {
  	if ($row['int_actif']==2) {
  		$prop_int="ai18 css_0001";
  	} else {
  		$prop_int="ai18";
  	}
		if ($row['act_actif']==2) {
  		$prop_act="ai15 css_0001";
  	} else {
  		$prop_act="ai15";
  	}
  } else {
  	if ($row['int_actif']==2) {
  		$prop_int="ai18 css_0001";
  	} else {
  		$prop_int="ai18";
  	}
		if ($row['act_actif']==2) {
  		$prop_act="ai15 css_0001";
  	} else {
  		$prop_act="ai15";
  	}
  }
	echo(' prop_act="'.$prop_act.'"');
	echo(' prop_int="'.$prop_int.'"');
  echo(' type_acteur_en_clair="'.fa_ent_xml($row['type_acteur_en_clair']).'"');
  if (fa_ent_xml($row['principal'])==2) {
    echo(' principal="'.$prop_acteur_principal.'"');
  } else {
    echo(' principal=""');
  }
  echo(' val_principal="'.fa_ent_xml($row['principal']).'"');
 echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
