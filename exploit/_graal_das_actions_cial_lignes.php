<?php
include("_graal_header_xml.inc.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
$vl_e_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','10281'));
$vl_c_genreaction=fa_recup_param('genreaction','cdecli');
switch ($vl_c_genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retcli":
  case "retfou":
  case "relfou":
    $fichier_01="_".$vl_c_genreaction."_lignes";
    $fichier_02="_".$vl_c_genreaction."_lignes_qte";
    break;
  case "avocli":
	case "avofin":
    $fichier_01="_avocli_lignes";
    $fichier_02="_avocli_lignes_qte";
    break;
  case "avofou":
	case "avofif":
    $fichier_01="_avofou_lignes";
    $fichier_02="_avofou_lignes_qte";
    break;
  default:
    $fichier_01="foireux";
    $fichier_02="foireux";
    break;  //  Toutes les actions génériques
}
switch ($vl_c_genreaction){
	  case "relfou":
	    $complement_01=",f4.cdefou_ligne_qte_cleunik";
	    break;
	  default:
	    $complement_01="";
	    break;  //  Toutes les actions génériques
	}
// execution de la requète SQL
$sql_req="SELECT f1.commercial_ligne_cleunik as z01,f1.commercial_cleunik as z02,f1.ligne_cleunik as z03,f1.art_cleunik as z04,f1.code_interne as z05,f1.mnemotechnique_interne as z06,";
$sql_req.=" f1.description_interne as z07,f4.qte as z08,f4.qte_nbdec as z09,f4.qte_unite as z10,f1.pu as z11,f1.pu_type as z12,f1.nbdec_pu as z13,f1.remise_taux,";
$sql_req.=" f2.choix_valeur_texte_01 as z17,f3.choix_valeur_texte_01 as z18,f1.typeligne as z19,f1.coef_facture as coef_facture,f1.remise_genr,f1.remise_natu,";
$sql_req.=" f1.remise_type,$sql_htbrutremise,f4.statut,f4.qte_deja as qte_deja,f4.dateheure_confirm,"._graalsql_date('f4.dateheure_confirm')." as dateheure_confirm_claire, ";
$sql_req.=" f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur $complement_01";
$sql_req.=" from $fichier_01 f1 left join $fichier_02 f4 on f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik left join _choix f2 on f2.choix_cleunik = qte_unite ";
$sql_req.=" left join _choix f3 on f3.choix_cleunik=f4.statut";
$sql_req.=" WHERE f1.commercial_cleunik=$vl_e_commercial_cleunik order by f1.ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
//echo $sql_req;
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
	
	switch ($vl_c_genreaction){
	  case "relfou":
	  	$commande_ligne=pf_cherche_commande_ligne($row['cdefou_ligne_qte_cleunik']);
	    break;
	  default:
	    break;  //  Toutes les actions génériques
	}
	
	
	
	
  $nb_dec_qte=fa_ent_xml($row['z09']);
  $nb_dec_pu=fa_ent_xml($row['z13']);
  echo(' code_acteur="'.fa_ent_xml($row['code_acteur']).'"');
  echo(' commande_ligne="'.$commande_ligne.'"');
  echo(' mnemotechnique_acteur="'.fa_ent_xml($row['mnemotechnique_acteur']).'"');
  echo(' description_acteur="'.fa_ent_xml($row['description_acteur']).'"');
  echo(' dateheure_confirm="'.fa_ent_xml($row['dateheure_confirm']).'"');
  echo(' dateheure_confirm_claire="'.fa_ent_xml($row['dateheure_confirm_claire']).'"');
  echo(' z01="'.fa_ent_xml($row['z01']).'"');
  echo(' z02="'.fa_ent_xml($row['z02']).'"');
  echo(' z03="'.fa_ent_xml($row['z03']).'"');
  echo(' z04="'.fa_ent_xml($row['z04']).'"');
  echo(' z05="'.fa_ent_xml($row['z05']).'"');
  echo(' z06="'.fa_ent_xml($row['z06']).'"');
  echo(' z07="'.fa_ent_xml($row['z07']).'"');
  if ($row['z08']==0) {$z08="";} else {$z08=fa_reel(fa_ent_xml($row['z08']),$nb_dec_qte);}
  echo(' z08="'.$z08.'"');
  if ($row['qte_deja']==0) {$qte_deja="";} else {$qte_deja=fa_reel(fa_ent_xml($row['qte_deja']),$nb_dec_qte);}
  echo(' qte_deja="'.$qte_deja.'"');
  if ($row['z11']==0) {$z11="";} else {$z11=fa_reel(fa_ent_xml($row['z11']),$nb_dec_pu);}
  echo(' z11="'.$z11.'"');
  if ($row['remise_taux']==0) {
    $z14="";
    $remise_type="";
    $remise_genre="";
  } else {
    $z14=fa_reel(fa_ent_xml($row['remise_taux']),$nb_dec_pu);
    switch ($row['remise_type']) {
      case 1:$remise_type="%";break;
      case 2:$remise_type="€";break;
    }
    switch ($row['remise_natu']) {
      case 1:$remise_genre="- ";break;
      case 2:$remise_genre="+ ";break;
    }
  }
  echo(' z14="'.$remise_genre.$z14.'"');
  if (fa_ent_xml($row['z19'])=='T') {
  	$unite="";
  	$statut="";
  	$ral="";
  } else {
  	$unite=fa_ent_xml($row['z17']);
  	$statut=fa_ent_xml($row['z18']);
  	if ($row['z19']!=-39){
  		//	en cours de traitement
  		$ral=fa_reel(fa_ent_xml($row['z08']-$row['qte_deja']),$nb_dec_qte);
  		if ($ral==0){$ral="";}
  	} else {
  		$ral="";
  	}
  }
  echo(' ral="'.$ral.'"');
  echo(' z17="'.$unite.'"');
  $htligne=$row['z08']*$row['z11'];
  if ($htligne==0) {$htligne="";} else {$htligne=fa_reel(fa_ent_xml($htligne),$nb_dec_pu);}
  $htbrutremise=fa_reel(fa_ent_xml($row['htbrutremise']),$nb_dec_pu);
  if ($htbrutremise==$htligne) {$htbrutremise="";}
  if ($htbrutremise==0) {$htbrutremise="";}
  echo(' htligne="'.$htligne.'"');
  echo(' z18="'.$statut.'"');
  $coef_facture=$row['coef_facture'];
  if($coef_facture==0) {$coef_facture_clair="Non facturable";$prop_coef_facture="ag15";} else {$coef_facture_clair="";$prop_coef_facture="";}
  echo(' coef_facture_clair="'.$coef_facture_clair.'"');
  echo(' prop_coef_facture="'.$prop_coef_facture.'"');
  echo(' htbrutremise="'.$htbrutremise.'"');
  echo(' remise_type="'.$remise_type.'"');
  if ($row['statut']==-39) {
    echo(' prop_statut="ac05"');
  } else {
    echo(' prop_statut=""');
  }
echo('/>');
}
echo('</donnees>');
// fermeture du curseur et de la connexion
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
function pf_cherche_commande_ligne($cdefou_ligne_qte_cleunik) {
	$sql_req="SELECT f1.code,f3.ligne_cleunik";
	$sql_req.=" from _cdefou_entetes f1 left join _cdefou_lignes f3 using(commercial_cleunik) left join _cdefou_lignes_qte f2 using(commercial_ligne_cleunik) ";
	$sql_req.=" WHERE f2.ligne_qte_cleunik=$cdefou_ligne_qte_cleunik ;";
	$result = _graal_requete_bd($sql_req);
	//echo $sql_req;
	$row = mysql_fetch_assoc($result);
	$commande=$row['code'];
	$ligne_cleunik=sprintf("%02d", $row['ligne_cleunik']);
	_graal_libere_requete_bd($result);
	return $commande."-".$ligne_cleunik;
}
?>
