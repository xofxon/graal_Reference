<?php
include("_graal_header_xul.inc.php");
$vl_e_type=intval(fa_recup_param('vl_e_type',1));
$vl_c_genreaction=fa_recup_param("genreaction","aucune");
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_mm=intval(fa_recup_param('vl_c_mm',date("m")));
$vl_c_jj=intval(fa_recup_param('vl_c_jj',date("d")));
$vl_c_aa=intval(fa_recup_param('vl_c_aa',date("Y")));
$vl_c_jourdebut=intval(fa_recup_param('vl_c_jour_debut',1));	//	1 -> lundi, 0 -> dimanche
$vl_b_affiche_joursavant=fa_recup_param('vl_b_affiche_joursavant',false);
$vl_b_affiche_joursapres=fa_recup_param('vl_b_affiche_joursapres',false);
$vl_c_detail_action=fa_recup_param("detail","non");
$vl_c_premier_jour_du_mois=sprintf("%04d-%02d-%02d", $vl_c_aa,$vl_c_mm,1);
$vl_c_aff_we=fa_recup_param("vl_c_aff_we",1);
switch ($vl_c_aff_we){
	case 1:$pas_afficher_we="false";break;
	case 2:$pas_afficher_we="true";break;
}
//$pas_afficher_we="true";
$vl_c_dico_00002=fa_recup_dico('dico_00002');
$vl_c_dico_00003=fa_recup_dico('dico_00003');
$vl_c_dico_00004=fa_recup_dico('dico_00004');
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_dico_00019=fa_recup_dico('dico_00019');
$vl_c_dico_00020=fa_recup_dico('dico_00020');
$vl_c_dico_00021=fa_recup_dico('dico_00021');
$vl_c_dico_00022=fa_recup_dico('dico_00022');
$vl_c_dico_00023=fa_recup_dico('dico_00023');
$vl_c_dico_00024=fa_recup_dico('dico_00024');
$vl_c_dico_00025=fa_recup_dico('dico_00025');
$vl_c_dico_00045=fa_recup_dico('dico_00045');
switch ($vl_c_genreaction){
  case "toutes":
  case "toutes_principales":
  case "favorites"              :$vl_c_id_fenetre="Fen_00339";$id_inc_actions_recherche="Div_00374";break;
  case "emitel"                 :$vl_c_id_fenetre="Fen_00441";$id_inc_actions_recherche="Div_00404";break;
  case "rectel"                 :$vl_c_id_fenetre="Fen_00442";$id_inc_actions_recherche="Div_00405";break;
  case "emimail"                :$vl_c_id_fenetre="Fen_00454";$id_inc_actions_recherche="Div_00424";break;
  case "recmail":
  case "recmail_lecture":
  case "recmail_erreur":
  case "recmail_ar":
  case "emailing":
	  $vl_c_id_fenetre="Fen_00455";$id_inc_actions_recherche="Div_00425";break;
  case "offcli"                 :$vl_c_id_fenetre="Fen_00456";$id_inc_actions_recherche="Div_00426";break;
  case "demfou"                 :$vl_c_id_fenetre="Fen_00457";$id_inc_actions_recherche="Div_00427";break;
  case "cdecli"                 :$vl_c_id_fenetre="Fen_00458";$id_inc_actions_recherche="Div_00428";break;
  case "cdefou"                 :$vl_c_id_fenetre="Fen_00459";$id_inc_actions_recherche="Div_00429";break;
  case "livcli"                 :$vl_c_id_fenetre="Fen_00460";$id_inc_actions_recherche="Div_00430";break;
  case "recfou"                 :$vl_c_id_fenetre="Fen_00461";$id_inc_actions_recherche="Div_00431";break;
  case "faccli"                 :$vl_c_id_fenetre="Fen_00462";$id_inc_actions_recherche="Div_00432";break;
  case "profor"                 :$vl_c_id_fenetre="Fen_00462";$id_inc_actions_recherche="Div_00432";break;
  case "avocli"                 :$vl_c_id_fenetre="Fen_00734";$id_inc_actions_recherche="Div_00537";break;
  case "facfou"                 :$vl_c_id_fenetre="Fen_00463";$id_inc_actions_recherche="Div_00433";break;
  case "chat"                   :$vl_c_id_fenetre="Fen_00507";$id_inc_actions_recherche="Div_00471";break;
  case "fabrica"  				:$vl_c_id_fenetre="Fen_00554";$id_inc_actions_recherche="Div_00483";break;
  case "avecpj"                 :$vl_c_id_fenetre="Fen_00586";$id_inc_actions_recherche="Div_00495";break;
  case "formul"                 :$vl_c_id_fenetre="Fen_00662";$id_inc_actions_recherche="Div_00513";break;
	case "desins_mail"			:$vl_c_id_fenetre="Fen_00738";$id_inc_actions_recherche="Div_00540";break;
	case "remban"				:$vl_c_id_fenetre="Fen_00953";$id_inc_actions_recherche="Div_00560";break;
	case "post_it"				:$vl_c_id_fenetre="Fen_01048";$id_inc_actions_recherche="Div_00572";break;
	case "bordex"				:$vl_c_id_fenetre="Fen_01060";$id_inc_actions_recherche="Div_00572";break;
	case "emailing_track"		:$vl_c_id_fenetre="Fen_01077";$id_inc_actions_recherche="Div_00576";break;
	case "alertes"				:$vl_c_id_fenetre="Fen_01145";$id_inc_actions_recherche="Div_00598";break;
	case "aucune":
  default:
    fa_redirige("acces_interdit");
    break;
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_c_id_fen_action="Fen_00425";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fen_action,$vl_e_uti_cleunik);
$vl_b_ajout=$vl_tb_droits[1];$vl_b_modif=$vl_tb_droits[2];$vl_b_suppr=$vl_tb_droits[3];$vl_b_impri=$vl_tb_droits[4];$vl_b_detai=0;
$vl_tc_composants=array($id_inc_actions_recherche);
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bda_100=fa_recup_dico("bda_100");
$vl_c_bda_101=fa_recup_dico("bda_101");
$vl_c_bda_102=fa_recup_dico("bda_102");
$vl_c_bda_103=fa_recup_dico("bda_103");
$vl_c_bda_104=fa_recup_dico("bda_104");
$vl_c_bda_105=fa_recup_dico("bda_105");
$vl_c_bda_106=fa_recup_dico("bda_106");
$vl_c_bda_109=fa_recup_dico("bda_109");
$vl_c_bda_110=fa_recup_dico("bda_110");
$vl_c_bda_111=fa_recup_dico("bda_111");
$vl_c_bda_112=fa_recup_dico("bda_112");
$vl_c_bda_113=fa_recup_dico("bda_113");
$vl_c_bda_114=fa_recup_dico("bda_114");
$vl_c_bda_115=fa_recup_dico("bda_115");
$vl_c_bda_116=fa_recup_dico("bda_116");
$vl_c_bda_117=fa_recup_dico("bda_117");
$vl_c_bda_118=fa_recup_dico("bda_118");
$vl_c_bda_119=fa_recup_dico("bda_119");
$vl_c_bda_120=fa_recup_dico("bda_120");
$vl_c_bda_121=fa_recup_dico("bda_121");
$menu_ajout="";
$menu_ajout.="<menupopup id='menu_ajout'><menuitem class='menuitem-iconic ba07' label='$vl_c_bda_103' oncommand='parent.window.pf_etat_fen_bem(\"ajouter\")' tooltiptext='$vl_c_dico_00002 Ctrl+Shift+F2' keycode='k-ajouter'/>";
$menu_ajout.="<menu label='$vl_c_bda_101'><menupopup>";
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00001",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_dico_00019.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110000\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00002",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba02" label="'.$vl_c_dico_00020.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110001\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00005",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba04" label="'.$vl_c_dico_00022.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110002\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00006",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba01" label="'.$vl_c_dico_00021.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110003\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00009",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba03" label="'.$vl_c_dico_00023.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110004\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00010",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba05" label="'.$vl_c_dico_00024.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110005\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00011",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba06" label="'.$vl_c_dico_00025.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'110006\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Trait_00219",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ai18" label="'.$vl_c_dico_00045.'" oncommand="parent.window.pf_ajoute_bem(\'tel\',\'tousss\')" />';}
$menu_ajout.="</menupopup></menu>";
$menu_ajout.="<menu label='$vl_c_bda_109'><menupopup>";
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00671",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_111.'" oncommand="parent.window.pf_ouvre_acteur(\'110001\',\'offcli\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00671",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_112.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'offcli\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00477",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_110.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'cdecli\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00672",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_113.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'livcli\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00742",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_121.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'profor\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00673",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_114.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'faccli\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00674",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_115.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'avocli\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00674",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_116.'" oncommand="parent.window.pf_ouvre_acteur(\'110003\',\'avofin\')" />';}
$menu_ajout.="</menupopup></menu>";

$menu_ajout.="<menu label='$vl_c_bda_117'><menupopup>";
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00675",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_118.'" oncommand="parent.window.pf_ouvre_acteur(\'110002\',\'demfou\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00675",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_119.'" oncommand="parent.window.pf_ouvre_acteur(\'110004\',\'demfou\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00676",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ba07" label="'.$vl_c_bda_120.'" oncommand="parent.window.pf_ouvre_acteur(\'110004\',\'cdefou\')" />';}
$menu_ajout.="</menupopup></menu>";


$menu_ajout.="<menuitem class='ba07' label='$vl_c_bda_102' oncommand='parent.window.pf_ajoute_bem(\"rectel\",\"\");'/>";
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00696",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic xx02" label="'.$vl_c_bda_104.'" oncommand="parent.window.pf04_emichat(-1);" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00066",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ah09" label="'.$vl_c_bda_105.'" oncommand="parent.window.pf_ajoute_bem(\'emimail_texte\',\'tousss\')" />';}
$vl_tb_droits=_graal_requete_droits_fenetre("Fen_00513",$vl_e_uti_cleunik);if ($vl_tb_droits[0]==true) {$menu_ajout.='<menuitem class="menuitem-iconic ah09" label="'.$vl_c_bda_106.'" oncommand="parent.window.pf_ajoute_bem(\'emimail_html\',\'tousss\')" />';}
$menu_ajout.="</menupopup>";

/*
if ($vl_b_ajout==true) 
{echo ('<button type="menu" width="40" flex="1" id="bt_ajouter" label="'.$vl_c_dico_00002.'" crop="end" dir="normal" >');echo($menu_ajout);echo("</button>");}
else {echo('<spacer flex="1"/>');}
if ($vl_b_modif==true) {echo('<button tooltiptext ="'.$vl_c_dico_00003.' Ctrl+Shift+F3" keycode="k-modifier" width="40" flex="1" id="bt_modifier" label="'.$vl_c_dico_00003.'" crop="end" dir="normal" oncommand="pf_dblclick_arbre_actions_bem()" />');}
else {echo('<spacer flex="1"/>');}
*/



$vl_c_dico_00130=fa_recup_dico("dico_00130");
$vl_c_dico_00131=fa_recup_dico("dico_00131");
$vl_c_dico_00132=fa_recup_dico("dico_00132");
$vl_c_dico_00133=fa_recup_dico("dico_00133");
$vl_c_dico_00134=fa_recup_dico("dico_00134");
$vl_c_dico_00135=fa_recup_dico("dico_00135");
$vl_c_dico_00136=fa_recup_dico("dico_00136");
$vl_c_dico_00137=fa_recup_dico("dico_00137");
$vl_c_dico_00138=fa_recup_dico("dico_00138");
$vl_c_dico_00139=fa_recup_dico("dico_00139");
$vl_c_dico_00140=fa_recup_dico("dico_00140");
$vl_c_dico_00141=fa_recup_dico("dico_00141");
$vl_c_dico_00142=fa_recup_dico("dico_00142");
$vl_c_dico_00143=fa_recup_dico("dico_00143");
$vl_c_dico_00144=fa_recup_dico("dico_00144");
$vl_c_dico_00145=fa_recup_dico("dico_00145");
$vl_c_dico_00146=fa_recup_dico("dico_00146");
$vl_c_dico_00147=fa_recup_dico("dico_00147");
$vl_c_dico_00148=fa_recup_dico("dico_00148");




/*
 * Début Paramètres pour la gestion des requêtes action
 */
$vl_c_lesquelles=fa_recup_param('vl_c_lesquelles','toutes');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_quelleplage=fa_recup_param('vl_c_quelleplage','debut');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_limit=intval(fa_recup_param('vl_e_limit','0'));
$vl_e_genre=intval(fa_recup_param('vl_e_genre','-1'));
$vl_e_statut=fa_recup_param('vl_e_statut','-1');
$vl_e_act_cleunik=intval(fa_recup_param('act_cleunik','-1'));
$vl_e_int_cleunik=intval(fa_recup_param('int_cleunik','-1'));
$vl_e_operat=intval(fa_recup_param('vl_operat','1'));
$vl_e_operat_genre=intval(fa_recup_param('vl_operat_genre','1'));
$vl_e_zone=intval(fa_recup_param('vl_zone','1'));
$vl_e_type_recherche=intval(fa_recup_param('vl_type_recherche','1'));
$vl_e_priorite=fa_recup_param('vl_e_priorite','-1');
$vl_e_operat_priorite=intval(fa_recup_param('vl_operat_priorite','1'));
$vl_c_concerne_qui=intval(fa_recup_param('vl_c_concerne_qui','1'));
$vs_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
$vl_e_confiden=fa_recup_param('vl_e_confiden','-1');
$vl_operat_confiden=intval(fa_recup_param('vl_operat_confiden','1'));
/*
 * la requête de comptage des pièces jointe est-elle utile dans ce cas ?
 */
$req_compte_pj="select count(*) from _documents_rattachement where _documents_rattachement.rat_cleunik=_actions.action_cleunik and portee &$vl_e_piejoi";
$req_compte_pj="0";
/*
 * Fin Paramètres pour la gestion des requêtes action
 */


$vl_b_affiche_lundi=fa_recup_param('vl_b_affiche_lundi',true);
$vl_b_affiche_mardi=fa_recup_param('vl_b_affiche_mardi',true);
$vl_b_affiche_mercr=fa_recup_param('vl_b_affiche_mercr',true);
$vl_b_affiche_jeudi=fa_recup_param('vl_b_affiche_jeudi',true);
$vl_b_affiche_vendr=fa_recup_param('vl_b_affiche_vendr',true);
$vl_b_affiche_samed=fa_recup_param('vl_b_affiche_samed',true);
$vl_b_affiche_diman=fa_recup_param('vl_b_affiche_diman',true);
/*
 * le 4 janvier 2009
 * 
 * Problème pour cacher la colonne dimanche si on dit que la semaine commence par un dimanche !!!
 * 
 * 
 */
$vl_c_jourdebut=0;	//	Jour de début = Dimanche
$vl_c_jourdebut=1;	//	Jour de début = Lundi
//$vl_c_mm=2;
//$vl_c_jj=1;
//$vl_c_aa=2009;
// Mois



$month[0] = "$vl_c_dico_00130" ;
$month[1] = "$vl_c_dico_00131" ;
$month[2] = "$vl_c_dico_00132" ;
$month[3] = "$vl_c_dico_00133" ;
$month[4] = "$vl_c_dico_00134" ;
$month[5] = "$vl_c_dico_00135" ;
$month[6] = "$vl_c_dico_00136" ;
$month[7] = "$vl_c_dico_00137" ;
$month[8] = "$vl_c_dico_00138" ;
$month[9] = "$vl_c_dico_00139" ;
$month[10]= "$vl_c_dico_00140" ;
$month[11]= "$vl_c_dico_00141" ;
// nombre de jours par mois
$nbjmonth[0] = 31 ;
$nbjmonth[1] = ($vl_c_aa%4==0?($vl_c_aa%100==0?($vl_c_aa%400?29:28):29):28) ;
$nbjmonth[2] = 31 ;
$nbjmonth[3] = 30 ;
$nbjmonth[4] = 31 ;
$nbjmonth[5] = 30 ;
$nbjmonth[6] = 31;
$nbjmonth[7] = 31 ;
$nbjmonth[8] = 30 ;
$nbjmonth[9] = 31 ;
$nbjmonth[10] = 30 ;
$nbjmonth[11] = 31 ;
$mois_en_cours=$month[$vl_c_mm-1];
$vl_c_mm_prec=$vl_c_mm-1;
if ($vl_c_mm_prec==0){
	$vl_c_mm_prec=12;
	$vl_c_aa_prec=$vl_c_aa-1;
} else {
	$vl_c_aa_prec=$vl_c_aa;
}
$vl_c_derjour_prec=$nbjmonth[$vl_c_mm_prec-1];



$vl_c_mm_suiv=$vl_c_mm+1;
if ($vl_c_mm_suiv==13){
	$vl_c_mm_suiv=1;
	$vl_c_aa_suiv=$vl_c_aa+1;
} else {
	$vl_c_aa_suiv=$vl_c_aa;
}
$vl_c_prejour_suiv=0;
// Premier jour de la semaine
$jj = date ("w", mktime (0,0,0,$vl_c_mm,1,$vl_c_aa)) ;
switch ($vl_c_jourdebut) {
	case 0://	Dimanche
		$day[0] = "$vl_c_dico_00142" 	;if($vl_b_affiche_diman==true){$tab_ata_cache[O]="joker=''";} else {$tab_ata_cache[O]="collapsed='true'";}
	  $day[1] = "$vl_c_dico_00143" 	;if($vl_b_affiche_lundi==true){$tab_ata_cache[1]="joker=''";} else {$tab_ata_cache[1]="collapsed='true'";}
	  $day[2] = "$vl_c_dico_00144" 	;if($vl_b_affiche_mardi==true){$tab_ata_cache[2]="joker=''";} else {$tab_ata_cache[2]="collapsed='true'";}
	  $day[3] = "$vl_c_dico_00145" 	;if($vl_b_affiche_mercr==true){$tab_ata_cache[3]="joker=''";} else {$tab_ata_cache[3]="collapsed='true'";}
	  $day[4] = "$vl_c_dico_00146"	;if($vl_b_affiche_jeudi==true){$tab_ata_cache[4]="joker=''";} else {$tab_ata_cache[4]="collapsed='true'";}
	  $day[5] = "$vl_c_dico_00147" 	;if($vl_b_affiche_vendr==true){$tab_ata_cache[5]="joker=''";} else {$tab_ata_cache[5]="collapsed='true'";}
	  $day[6] = "$vl_c_dico_00148"	;if($vl_b_affiche_samed==true){$tab_ata_cache[6]="joker=''";} else {$tab_ata_cache[6]="collapsed='true'";}
		break;
	case 1://	Lundi
		$day[0] = "$vl_c_dico_00143"	;if($vl_b_affiche_lundi==true){$tab_ata_cache[0]="";} else {$tab_ata_cache[0]="collapsed='true'";}
	  $day[1] = "$vl_c_dico_00144"	;if($vl_b_affiche_mardi==true){$tab_ata_cache[1]="";} else {$tab_ata_cache[1]="collapsed='true'";}
	  $day[2] = "$vl_c_dico_00145" 	;if($vl_b_affiche_mercr==true){$tab_ata_cache[2]="";} else {$tab_ata_cache[2]="collapsed='true'";}
	  $day[3] = "$vl_c_dico_00146"	;if($vl_b_affiche_jeudi==true){$tab_ata_cache[3]="";} else {$tab_ata_cache[3]="collapsed='true'";}
	  $day[4] = "$vl_c_dico_00147" 	;if($vl_b_affiche_vendr==true){$tab_ata_cache[4]="";} else {$tab_ata_cache[4]="collapsed='true'";}
	  $day[5] = "$vl_c_dico_00148"	;if($vl_b_affiche_samed==true){$tab_ata_cache[5]="";} else {$tab_ata_cache[5]="collapsed='true'";}
	  $day[6] = "$vl_c_dico_00142" 	;if($vl_b_affiche_diman==true){$tab_ata_cache[6]="";} else {$tab_ata_cache[6]="collapsed='true'";}
		$jj--;	//	Pour décalage de colonne
		if ($jj==-1){$jj=6;}
		break;
}
$s=0;
$tab_no_semaine[$s]=date ("W", mktime (0,0,0,$vl_c_mm,1,$vl_c_aa)) ;
$semaine_en_cours=date("W");
// Première ligne des jours
$j = $jj ;
$dom = 1 ;
$k=-1;
$vl_indice_derniere_case_a_remplir=0;
$vl_indice_premiere_case_a_remplir=0;
for ($i=0;$i<7;$i++){
	$k++;
 	if ($j<=$i) {
		$vl_nojour=$dom++;
		$tab_indice[$k]=$k;
		$tab_nojour[$k]=$vl_nojour;
		$tab_datecl[$k]=sprintf("%02d.%02d.%04d", $vl_nojour, $vl_c_mm, $vl_c_aa);
		$tab_class_boite[$k]="dayboz bb";
		$tab_liste_actions_jour[$k]="";
		$tab_nombr_actions_jour[$k]="";
		if ($vl_indice_premiere_case_a_remplir==0) {$vl_indice_premiere_case_a_remplir=$k;}		
		//if ($dom==$vl_c_jj) {$tab_class_boite[$k]="jourmainte bb";}
 } else {
	 	$vl_nojour=$vl_c_derjour_prec-($jj-1)+$i;
		$tab_indice[$k]=$k;
		if( $vl_b_affiche_joursavant==true){
			$tab_nojour[$k]=$vl_nojour;
			if ($vl_indice_premiere_case_a_remplir==0) {$vl_indice_premiere_case_a_remplir=$vl_nojour;}		
		} else {
			$tab_nojour[$k]="";
			//if ($vl_indice_premiere_case_a_remplir==0) {$vl_indice_premiere_case_a_remplir=$k;}
		}
		$tab_datecl[$k]=sprintf("%02d.%02d.%04d", $vl_nojour, $vl_c_mm_prec, $vl_c_aa_prec);
		$tab_class_boite[$k]="joursavant bb";
		$tab_liste_actions_jour[$k]="";
		$tab_nombr_actions_jour[$k]="";
		//if ($dom==$vl_c_jj) {$tab_class_boite[$k]="jourmainte bb";}
	}
}
//	jours suivants
for ($i=0;$i<5;$i++){
	for ($j=0;$j<7;$j++){
		$k++;   
		if($dom <= $nbjmonth[($vl_c_mm-1)]){
			$vl_nojour=$dom++;
			$tab_indice[$k]=$k;
			$vl_indice_derniere_case_a_remplir=$k;
			$tab_nojour[$k]=$vl_nojour;
			$tab_datecl[$k]=sprintf("%02d.%02d.%04d", $vl_nojour, $vl_c_mm, $vl_c_aa);
			$tab_class_boite[$k]="dayboz bb";
			$tab_liste_actions_jour[$k]="";
			$tab_nombr_actions_jour[$k]="";
			//if ($dom==$vl_c_jj) {$tab_class_boite[$k]="jourmainte bb";}
			if ($j==0) {
				$s++;
				$tab_no_semaine[$s]=date ("W", mktime (0,0,0,$vl_c_mm,$vl_nojour,$vl_c_aa)) ;
			}
	  } else { 
			if (checkdate($vl_nojour,$vl_c_mm,$vl_c_aa)){
				$vl_nojour=$dom++;
				$tab_indice[$k]=$k;
				$vl_indice_derniere_case_a_remplir=$k;
				$tab_nojour[$k]=$vl_nojour;
				$tab_datecl[$k]=sprintf("%02d.%02d.%04d", $vl_nojour, $vl_c_mm, $vl_c_aa);
				$tab_class_boite[$k]="dayboz bb";
				$tab_liste_actions_jour[$k]="";
				$tab_nombr_actions_jour[$k]="";
				//if ($dom==$vl_c_jj) {$tab_class_boite[$k]="jourmainte bb";}
				if ($j==0) {
					$s++;
					$tab_no_semaine[$s]=date ("W", mktime (0,0,0,$vl_c_mm,$vl_nojour,$vl_c_aa)) ;
				}
	    } else {
	    	$tab_indice[$k]=$k;
				$vl_c_prejour_suiv++;
				if ($vl_b_affiche_joursapres==true) {
					$tab_nojour[$k]=$vl_c_prejour_suiv;					
				} else {
					$tab_nojour[$k]="";				
				}
				$tab_datecl[$k]=sprintf("%02d.%02d.%04d", $vl_c_prejour_suiv, $vl_c_mm_suiv, $vl_c_aa_suiv);
				$tab_class_boite[$k]="joursapres bb";
				$tab_liste_actions_jour[$k]="";
				$tab_nombr_actions_jour[$k]="";
				if ($j==0) {
					$s++;
					$tab_no_semaine[$s]=-1;
				}
	    }
		}
 	}
}





//	Gestion des actions
/*
 * Bornes de dates pour la requête actions
 */
$vl_c_datedebut=sprintf("%04d%02d%02d", $vl_c_aa, $vl_c_mm, 1);
$vl_c_datefin=sprintf("%04d%02d%02d", $vl_c_aa, $vl_c_mm,$nbjmonth[$vl_c_mm-1]);
include("_graal_req_actions_01.php");
if (strlen($vl_c_in)!=0) {
  $vl_c_in=substr($vl_c_in,0,-1);
  $qui_dat=array();$qui_cle=array();
	if ($vl_e_genre!=-110122) {
	  $sql_req="select action_cleunik,qui_interlo as `qui_interlo` from _vue_graal_principaux where action_cleunik in($vl_c_in);";
	  $result = _graal_requete_bd($sql_req);
	  while ($row = mysql_fetch_assoc($result)) {
	    array_push ($qui_dat, fa_ent_xml($row['qui_interlo']));
	    array_push ($qui_cle, $row['action_cleunik']);
	  }
	  _graal_libere_requete_bd($result);
	}
	$les_colonnes_communes=" _actions.statut as statut_124,f4.choix_valeur_texte_01 as statut,_actions.priorite as priorite_123,_actions.choix_cleunik as genre_094,";
  switch ($vl_e_zone) {
    case 1: //description
      switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
          $sql_req_finale ="SELECT DATEDIFF(dateheurefin,'$vl_c_premier_jour_du_mois') as nb_jours_dans_le_mois,DATEDIFF(dateheurefin,dateheuredebut) as nb_jours,gestion_duree,";
          $sql_req_finale.=" _actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as ";
          $sql_req_finale.=" `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,";
          $sql_req_finale.=" _actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes";
          $sql_req_finale.=" _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4 ";
          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and ";
          $sql_req_finale.=" f4.choix_cleunik=_actions.statut";
          break;
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT DATEDIFF(dateheurefin,'$vl_c_premier_jour_du_mois') as nb_jours_dans_le_mois,DATEDIFF(dateheurefin,dateheuredebut) as nb_jours,gestion_duree,";
          $sql_req_finale.=" _actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as ";
          $sql_req_finale.=" `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,";
          $sql_req_finale.=" _actions.dateheuremodif,_actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes";
          $sql_req_finale.=" _actions.sujet as `sujet`,_actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') as `score`,($req_compte_pj) as nb_pj ";
          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_actions_texte f5 where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik ";
          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut and _actions.action_cleunik=f5.action_cleunik";
          break;
      }
      break;
    case 2: //sujet
    switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT DATEDIFF(dateheurefin,'$vl_c_premier_jour_du_mois') as nb_jours_dans_le_mois,DATEDIFF(dateheurefin,dateheuredebut) as nb_jours,";
          $sql_req_finale.=" gestion_duree,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`";
          $sql_req_finale.=" ,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes";
          $sql_req_finale.="  _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4";
          $sql_req_finale.="  where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and";
          $sql_req_finale.="  f4.choix_cleunik=_actions.statut";
          break;
      }
    case 3:	//contenu
      switch ($vl_e_type_recherche) {
        case 3: //  Contenu
          $sql_req_finale ="SELECT DATEDIFF(dateheurefin,'$vl_c_premier_jour_du_mois') as nb_jours_dans_le_mois,DATEDIFF(dateheurefin,dateheuredebut) as nb_jours,";
          $sql_req_finale.=" gestion_duree,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`";
          $sql_req_finale.=" ,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes";
          $sql_req_finale.="  _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4 ";
          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and ";
          $sql_req_finale.=" f4.choix_cleunik=_actions.statut";
          break;
      }
      break;
    case 4: //référence
		$sql_req_finale ="SELECT DATEDIFF(dateheurefin,'$vl_c_premier_jour_du_mois') as nb_jours_dans_le_mois,DATEDIFF(dateheurefin,dateheuredebut) as nb_jours,";
		$sql_req_finale.=" gestion_duree,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`";
		$sql_req_finale.=" ,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
		$sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes";
		$sql_req_finale.="  _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4 ";
		$sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and ";
		$sql_req_finale.=" f4.choix_cleunik=_actions.statut";
	    break;
    case 5: //Raison sociale acteur concerné
		$sql_req_finale ="SELECT DATEDIFF(dateheurefin,'$vl_c_premier_jour_du_mois') as nb_jours_dans_le_mois,DATEDIFF(dateheurefin,dateheuredebut) as nb_jours,";
		$sql_req_finale.=" gestion_duree,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`";
		$sql_req_finale.=" ,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
		$sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes";
		$sql_req_finale.="  _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4 ";
		$sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and ";
		$sql_req_finale.=" f4.choix_cleunik=_actions.statut";
	    break;
    }
  switch ($vl_c_quelleplage) { 
    case "debut":$sql_req_finale.=" order by score DESC,_actions.dateheuredebut DESC,_actions.dateheurefin DESC";break;
    case "fin":$sql_req_finale.=" order by score DESC,_actions.dateheurefin DESC";break;
  } 
	switch ($vl_e_type_recherche) {
     case 3: //  Contenu
     	if ($vl_e_limit!=0) {
     		$sql_req_finale.= " LIMIT 0,$vl_e_limit";
			}
      break;
  }
  $result = _graal_requete_bd($sql_req_finale);
	//echo( $sql_req_finale);
	//echo ('<req="'.fa_ent_xml($sql_req_finale).'" />');
	
	
	while ($row = mysql_fetch_assoc($result)) {
			$vl_c_sujet=fa_ent_xml($row['sujet']);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
			switch ($row['choix_cleunik']) {
				case "-110106" : $vl_c_class="class='ai05'";break;	//	Réception appel téléphonique
				case "-110107" : $vl_c_class="class='ai06'";break;	//	Emission appel téléphonique
				/*
				case "-110114" : vl_c_genre="offcli";break;
        case "-110115" : vl_c_genre="demfou";break;
        case "-110108" : vl_c_genre="cdecli";break;
        case "-110109" : vl_c_genre="cdefou";break;
        case "-110110" : vl_c_genre="livcli";break;
        case "-110111" : vl_c_genre="recfou";break;
        case "-110112" : vl_c_genre="faccli";break;
        case "-110113" : vl_c_genre="facfou";break;
        case "-110116" : vl_c_genre="avocli";break;
        case "-110117" : vl_c_genre="avofin";break;
        */
        case "-110118" : $vl_c_class="class='ag06'";break;	//	Chat
				//case "-110119" : vl_c_genre="fabrica";break;
        case "-110103" : $vl_c_class="class='aj20'";break;	//	mails envoyés
        //case "-110121" : vl_c_genre="emimail_ar";break;
        case "-110122" : $vl_c_class="class='aj20'";break;	//	emailing
        case "-110102" : $vl_c_class="class='ah11'";break;	//	mails reçus
        case "-110120" : $vl_c_class="class='ag06'";break;	//	Avis de lecture
        case "-110104" : $vl_c_class="class='ad19'";break;	//	mails reçus en erreur
        //case "-110123" : vl_c_genre="formul";break;
				//case "-110124" : vl_c_genre="desins_mail";break;
				
				
				case "":$vl_c_class="class='af08'";break;
				default:$vl_c_class="class='af08'";break;
			}
			$dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
			$hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
			$df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
			$hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
			if ($hf=="" && $df=="") {
				$ligne_fin="";
			} else {
				$ligne_fin=" Fin le $df à $hf";
			}
			$vl_c_description=fa_ent_xml($row['description']);
			$vl_c_statut=fa_ent_xml($row['statut']);
			$vl_nbjours=$row['nb_jours'];
			$vl_nb_jours_dans_le_mois=$row['nb_jours_dans_le_mois'];
			$idpopup="pop_up".$row['action_cleunik'];
			$vl_c_genre=$row['genre'];
			$vl_c_class_tooltip="tooltip_094_".$row['genre_094'];
			$vl_e_trouve_interlo=array_search($row['action_cleunik'], $qui_cle);if ($vl_e_trouve_interlo===false) {$vl_c_qui="";} else {$vl_c_qui=$qui_dat[$vl_e_trouve_interlo];}

switch ($vl_c_detail_action){
	case "non":
$vl_c_bulle=<<<EOT
<popupset><tooltip id="$idpopup" orient='vertical'>
<html:div class='$vl_c_class_tooltip'>
<html:span style="font-weight: bold; color: rgb(51, 51, 255);">A $hd le $dd $ligne_fin</html:span>
<html:span style="font-weight: bold;">Genre</html:span>: $vl_c_genre
<html:span style="font-weight: bold;">Sujet</html:span>: $vl_c_sujet
<html:span style="font-weight: bold;">Statut</html:span>: $vl_c_statut
<html:span style="font-weight: bold; color: rgb(0, 153, 0);">Qui</html:span>: $vl_c_qui
<html:span style="font-weight: bold;">Description</html:span>: $vl_c_description
</html:div>
</tooltip></popupset>
EOT;
		$vl_c_listeitem="<richlistitem>";
			$vl_c_listeitem.="<toolbarbutton $vl_c_class ondblclick='parent.window.pf_ouvre_action(".$row['action_cleunik'].");'/>";
			$vl_c_listeitem.="<label tooltip='$idpopup' class='text-link noir' onclick='parent.window.pf_ouvre_action(".$row['action_cleunik'].");' value='$hd $vl_c_sujet' />";
			$vl_c_listeitem.="</richlistitem>";
			$vl_c_listeitem.=$vl_c_bulle;
		break;
	case "oui":
$vl_c_bulle_bis=<<<EOT
<html:div class='$vl_c_class_tooltip'>
<html:span style="font-weight: bold; color: rgb(51, 51, 255);">A $hd le $dd $ligne_fin</html:span><html:br></html:br>
<html:span style="font-weight: bold;">Genre</html:span>: $vl_c_genre<html:br></html:br>
<html:span style="font-weight: bold;">Sujet</html:span>: $vl_c_sujet<html:br></html:br>
<html:span style="font-weight: bold;">Statut</html:span>: $vl_c_statut<html:br></html:br>
<html:span style="font-weight: bold; color: rgb(0, 153, 0);">Qui</html:span>: $vl_c_qui<html:br></html:br>
<html:span style="font-weight: bold;">Description</html:span>: $vl_c_description<html:br></html:br>
</html:div>
EOT;
		$vl_c_listeitem="<richlistitem>";
			$vl_c_listeitem.="<vbox>";
			$vl_c_listeitem.="<toolbarbutton crop='start' $vl_c_class label='$hd $vl_c_sujet' ondblclick='parent.window.pf_ouvre_action(".$row['action_cleunik'].");'/>";
			$vl_c_listeitem.=$vl_c_bulle_bis;
			$vl_c_listeitem.="</vbox>";
			$vl_c_listeitem.="</richlistitem>";
	
}			
			


			

	
			$vl_e_trouve=array_search($row['datedebut'], $tab_datecl);
		if ($vl_e_trouve===false) {
			// pas normal !!!! ????
			// si : peut-être normal : dans l'intervalle de début fin mais date de début antérieure et/ou date de fin postérieure
			if ($row['gestion_duree']==1) {
			/*
			 * 	on est dans le cas ou on a pas trouvé la date de début dans le mois
			 * il faut maintenant remplir les autres cases à concurrences du nombre de jours d'ici la date de fin
			 */
				$k=-1;
				for ($j=$vl_indice_premiere_case_a_remplir-1;$j<$vl_indice_derniere_case_a_remplir+1;$j++) {
					$k++;
					if ($k<=$vl_nb_jours_dans_le_mois+1){
						$tab_liste_actions_jour[$j].="$vl_c_listeitem";
						$tab_nombr_actions_jour[$j]++;
					}
				}
			}
		} else {
			$tab_liste_actions_jour[$vl_e_trouve].="$vl_c_listeitem";
			$tab_nombr_actions_jour[$vl_e_trouve]++;
			if ($row['gestion_duree']==1) {
			/*
			 * 	on est dans le cas ou on a trouvé la date de début dans le mois
			 * il faut maintenant remplir les autres cases à concurrences du nombre de jours d'ici la date de fin
			 */
				$k=0;
				for ($j=$vl_e_trouve+1;$j<=$vl_indice_derniere_case_a_remplir;$j++) {
					$k++;
					if ($k<=$vl_nbjours){
						$tab_liste_actions_jour[$j].="$vl_c_listeitem";
						$tab_nombr_actions_jour[$j]++;
					}
				}
			}
			
			
		}





/*		
    echo(' action_cleunik="'.fa_ent_xml($row['action_cleunik']).'"');
    echo(' description="'.fa_ent_xml($row['description']).'"');
    echo(' choix_cleunik="'.fa_ent_xml($row['choix_cleunik']).'"');
    echo(' dateheuredebut="'.fa_ent_xml($row['dateheuredebut']).'"');
    echo(' dateheurefin="'.fa_ent_xml($row['dateheurefin']).'"');
    
    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
    
    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
    echo(' datedebut="'.$dd.'"');
    echo(' datefin="'.$df.'"');
    echo(' heuredebut="'.$hd.'"');
    echo(' heurefin="'.$hf.'"');
    echo(' genre="'.fa_ent_xml($row['genre']).'"');
    echo(' priorite="'.fa_ent_xml($row['priorite']).'"');
    echo(' statut="'.fa_ent_xml($row['statut']).'"');
		$vl_c_sujet=fa_ent_xml($row['sujet']);
		//$vl_c_sujet = preg_replace('/^\W+|\W+$/', '', $vl_c_sujet);
		$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
    echo(' sujet="'.$vl_c_sujet.'"');
    echo(' reference="'.fa_ent_xml($row['reference']).'"');
    echo(' poidsdesmots="'.fa_ent_xml($row['score']).'"');
    $vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);if ($vl_e_trouve===false) {$vl_c_qui="";} else {$vl_c_qui=$qui_dat[$vl_e_trouve];}
    echo(' qui="'.$vl_c_qui.'"');
    if($row['nb_pj']!=0) {$vl_c_prop_pj="al14";} else {$vl_c_prop_pj="";}
    echo(' prop_pj="'.$vl_c_prop_pj.'"');
    echo('/>');
	*/
	}
	_graal_libere_requete_bd($result);
	
}


$vl_c_entete_jours="";	
// Affichage des jours
$vl_c_entete_jours.="<hbox class='dayname' width='50' collapsed='true'><label value='Sem.'/></hbox>";
$vl_c_menuliste_semaines="";
$vl_c_menuliste_semaines.="<menulist sizetopopup='none' oncommand='pf_cache_semaine(this.value)' value='-1'><menupopup>";
$vl_c_menuliste_semaines.="<menuitem value='-1' label=' Toutes les semaines du mois ' />";
for($i=0;$i<7;$i++){
	switch ($i){
		case 0:
		case 1:
		case 2:
		case 3:
		case 4:
			$vl_c_entete_jours.="<hbox class='dayname' flex='1' $tab_ata_cache[$i]><label value='$day[$i]'/></hbox>";
			break;
		case 5:
		case 6:
			if ($pas_afficher_we!="true"){
				$vl_c_entete_jours.="<hbox class='dayname' flex='1' $tab_ata_cache[$i]><label value='$day[$i]'/></hbox>";
			}
			break;
	}
	
}

$k=-1;
for ($i=0;$i<6;$i++)  {
	//if (checkdate($vl_c_mm,$dom,$vl_c_aa)){
	if($tab_no_semaine[$i]!=-1){
		$vl_c_menuliste_semaines.="<menuitem value='$i' label='Semaine $tab_no_semaine[$i]'/>";
		$vl_c_lignes_suivantes.="<row flex='1' old_minheight='150' id='row_semaine_$i' collapsed='true'>";
		$vl_c_lignes_suivantes.="<vbox class='timebox' width='50' ><label class='weeklabel' value='Sema' tooltiptext='row_semaine_$i'/><label class='weeknum' value='$tab_no_semaine[$i]'/></vbox>";
	  for ($j=0;$j<7;$j++) {
			$k++;
			  switch ($j){
				case 0:
				case 1:
				case 2:
				case 3:
				case 4:
					$vl_b_affiche=true;
					break;
				case 5:
				case 6:
					
					if ($pas_afficher_we=="true"){
						$vl_b_affiche=false;
					} else {
						$vl_b_affiche=true;
					}
					break;
			}
			if ($vl_b_affiche==true){
			$vl_c_debut_liste_actions_jour=<<<EOT
<listbox rows="$tab_nombr_actions_jour[$k]">
  <listcols>
		<listcol flex="1" />
   </listcols>
   <listhead>
		<listheader label="Sujet" />
   </listhead>
EOT;

$vl_c_debut_liste_actions_jour=<<<EOT
<richlistbox flex="1" rows="10">
EOT;
			$vl_c_lignes_suivantes.="<hbox class='$tab_class_boite[$k]' $tab_ata_cache[$j] flex='1'><hbox flex='1'>";
			
			if ($tab_nombr_actions_jour[$k]!=0) {
				$vl_c_lignes_suivantes.="<vbox flex='1'>";
				$vl_c_lignes_suivantes.="<label class='daynum' value='$tab_nojour[$k] ($tab_nombr_actions_jour[$k])'/>";
				$vl_c_lignes_suivantes.="$vl_c_debut_liste_actions_jour";
				$vl_c_lignes_suivantes.="$tab_liste_actions_jour[$k]";
				$vl_c_lignes_suivantes.="</richlistbox>";
				$vl_c_lignes_suivantes.="</vbox>";
			} else {
				$vl_c_lignes_suivantes.="<label class='daynum' value='$tab_nojour[$k]'/>";
			}
			$vl_c_lignes_suivantes.="</hbox></hbox>";
		}
	  }
		$vl_c_lignes_suivantes.="</row><splitter/>";
	}
}
$vl_c_menuliste_semaines.="</menupopup></menulist>";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_aat_102=fa_recup_dico("aat_102");
$vl_c_aat_103=fa_recup_dico("aat_103");
$vl_c_aat_104=fa_recup_dico("aat_104");
include("_graal_header_winxul.inc.php");
echo '<?xml-stylesheet type="text/css" href="css/calendrier/calendar.css"?>';
echo <<<END
<window context="graal_cp00" title="$vl_c_aat_101" id="_graal_calendrier_mois" old_onload="fa_aa(this);" onload="pf_cache_semaine('-1');" $c_xmlns class="overflow_01">
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
echo <<<END
<script type="application/x-javascript"><![CDATA[
function fa_att_set(vv_qui,vv_quoi,vv_valeur){
 try {
	fa_gid(vv_qui).setAttribute(vv_quoi,vv_valeur);
  } catch (e) {
  	var erreur="Erreur ->"+vv_qui+" : "+vv_quoi;
	}
}
function fa_gid(vv_quoi){
  try {
    return document.getElementById(vv_quoi);
    } catch (e) {
		return null;
	}
}
function fa_cache_non(vv_qui) {
 try {
  fa_att_set(vv_qui,"collapsed","false");  //  depuis le 25 novembre 2006
  } catch (e) {
		//alert(e)
	}
}
function fa_cache_oui(vv_qui){
 try {
  fa_att_set(vv_qui,"collapsed","true");  //  depuis le 25 novembre 2006
  } catch (e) {
  	//alert(e);
		// raf
	}
}

function pf_cache_semaine(vv_quoi){
	switch (vv_quoi){
		case '-1':
			fa_cache_non("row_semaine_0");
			fa_cache_non("row_semaine_1");
			fa_cache_non("row_semaine_2");
			fa_cache_non("row_semaine_3");
			fa_cache_non("row_semaine_4");
			fa_cache_non("row_semaine_5");
			break;
		case '0':
			fa_cache_non("row_semaine_0");
			fa_cache_oui("row_semaine_1");
			fa_cache_oui("row_semaine_2");
			fa_cache_oui("row_semaine_3");
			fa_cache_oui("row_semaine_4");
			fa_cache_oui("row_semaine_5");
			break;
		case '1':
			fa_cache_oui("row_semaine_0");
			fa_cache_non("row_semaine_1");
			fa_cache_oui("row_semaine_2");
			fa_cache_oui("row_semaine_3");
			fa_cache_oui("row_semaine_4");
			fa_cache_oui("row_semaine_5");
			break;
		case '2':
			fa_cache_oui("row_semaine_0");
			fa_cache_oui("row_semaine_1");
			fa_cache_non("row_semaine_2");
			fa_cache_oui("row_semaine_3");
			fa_cache_oui("row_semaine_4");
			fa_cache_oui("row_semaine_5");
			break;
		case '3':
			fa_cache_oui("row_semaine_0");
			fa_cache_oui("row_semaine_1");
			fa_cache_oui("row_semaine_2");
			fa_cache_non("row_semaine_3");
			fa_cache_oui("row_semaine_4");
			fa_cache_oui("row_semaine_5");
			break;
		case '4':
			fa_cache_oui("row_semaine_0");
			fa_cache_oui("row_semaine_1");
			fa_cache_oui("row_semaine_2");
			fa_cache_oui("row_semaine_3");
			fa_cache_non("row_semaine_4");
			fa_cache_oui("row_semaine_5");
			break;
		case '5':
			fa_cache_oui("row_semaine_0");
			fa_cache_oui("row_semaine_1");
			fa_cache_oui("row_semaine_2");
			fa_cache_oui("row_semaine_3");
			fa_cache_oui("row_semaine_4");
			fa_cache_non("row_semaine_5");
			break;
			
	}
}
]]></script>

        <vbox id="calMonth" flex="1" class="overflow_01">
          <hbox id="monthbar" class="titlebar">
						<toolbarbutton image="css/calendrier/tasknew.png" type="menu" tooltiptext="Nouvelle action" >$menu_ajout</toolbarbutton>
			<spacer flex="1"/>
						$vl_c_menuliste_semaines
            <spacer flex="1"/>
						<image src="css/calendrier/goprev.png" tooltiptext="Précédent" onclick="window.parent.pf_mois_precedent();"/>
            <label id="monthlabel" class="titletext" value="$mois_en_cours $vl_c_aa"/>
            <image src="css/calendrier/gonext.png" tooltiptext="Suivant" onclick="window.parent.pf_mois_suivant();"/>
            <spacer flex="1"/>
						
          </hbox>
          <grid flex="1" >
            <columns flex="1">
            <column width="50"/>
            <column flex="1" $tab_ata_cache[0] minwidth="200"/>
            <column flex="1" $tab_ata_cache[1] minwidth="200"/>
            <column flex="1" $tab_ata_cache[2] minwidth="200"/>
            <column flex="1" $tab_ata_cache[3] minwidth="200"/>
            <column flex="1" $tab_ata_cache[4] minwidth="200"/>
            <column flex="1" $tab_ata_cache[5] minwidth="200" collapsed="$pas_afficher_we"/>
            <column flex="1" $tab_ata_cache[6] minwidth="200" collapsed="$pas_afficher_we"/>
            </columns>
            <rows flex="1" >
              <row>
								$vl_c_entete_jours
              </row>
							$vl_c_lignes_suivantes
            </rows>
          </grid>
        </vbox>
	
	 </window>
END;
?>
