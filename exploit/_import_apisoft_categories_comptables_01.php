<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');

$sql_req = "SELECT distinct(ComptePortAchat) FROM $vl_c_base_origine.categorieachatvente where ComptePortAchat not in (select code from $vl_c_base_destination._param_pc)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result))
  {
//  Ajout dans la table plan comptable
      $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","$vl_c_base_destination._param_pc");
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._param_pc set";
      $sql_req_01 .=" pc_cleunik=$vf_e_pc_cleunik";
      $sql_req_01 .=",code='".addslashes($row['ComptePortAchat'])."'";
      $sql_req_01 .=",intitule='Compte port achat ".addslashes($row['ComptePortAchat'])."'";
      $sql_req_01 .=",dateheurecreation=now()";
      $sql_req_01 .=",dateheuremodification=now()";
      $sql_req_01 .=",actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false)
      {
          $vf_c_echo=mysql_error($cnx) . $sql_req_01;
      }
        else
          $vf_c_echo='ok';
  }
_graal_libere_requete_bd($result);

$sql_req = "SELECT distinct(ComptePortVente) FROM $vl_c_base_origine.categorieachatvente where ComptePortVente not in (select code from $vl_c_base_destination._param_pc)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result))
  {
//  Ajout dans la table plan comptable
      $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","$vl_c_base_destination._param_pc");
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._param_pc set";
      $sql_req_01 .=" pc_cleunik=$vf_e_pc_cleunik";
      $sql_req_01 .=",code='".addslashes($row['ComptePortVente'])."'";
      $sql_req_01 .=",intitule='Compte port vente ".addslashes($row['ComptePortVente'])."'";
      $sql_req_01 .=",dateheurecreation=now()";
      $sql_req_01 .=",dateheuremodification=now()";
      $sql_req_01 .=",actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false)
      {
          $vf_c_echo=mysql_error($cnx) . $sql_req_01;
      }
        else
          $vf_c_echo='ok';
  }
_graal_libere_requete_bd($result);

$sql_req = "SELECT distinct(CompteFraisAchat) FROM $vl_c_base_origine.categorieachatvente where CompteFraisAchat not in (select code from $vl_c_base_destination._param_pc)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result))
  {
//  Ajout dans la table plan comptable
      $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","$vl_c_base_destination._param_pc");
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._param_pc set";
      $sql_req_01 .=" pc_cleunik=$vf_e_pc_cleunik";
      $sql_req_01 .=",code='".addslashes($row['CompteFraisAchat'])."'";
      $sql_req_01 .=",intitule='Compte frais achats ".addslashes($row['CompteFraisAchat'])."'";
      $sql_req_01 .=",dateheurecreation=now()";
      $sql_req_01 .=",dateheuremodification=now()";
      $sql_req_01 .=",actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false)
      {
          $vf_c_echo=mysql_error($cnx) . $sql_req_01;
      }
        else
          $vf_c_echo='ok';
  }
_graal_libere_requete_bd($result);

$sql_req = "SELECT distinct(CompteFraisVente) FROM $vl_c_base_origine.categorieachatvente where CompteFraisVente not in (select code from $vl_c_base_destination._param_pc)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result))
  {
//  Ajout dans la table plan comptable
      $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","$vl_c_base_destination._param_pc");
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._param_pc set";
      $sql_req_01 .=" pc_cleunik=$vf_e_pc_cleunik";
      $sql_req_01 .=",code='".addslashes($row['CompteFraisVente'])."'";
      $sql_req_01 .=",intitule='Compte frais ventes ".addslashes($row['CompteFraisVente'])."'";
      $sql_req_01 .=",dateheurecreation=now()";
      $sql_req_01 .=",dateheuremodification=now()";
      $sql_req_01 .=",actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false)
      {
          $vf_c_echo=mysql_error($cnx) . $sql_req_01;
      }
        else
          $vf_c_echo='ok';
  }
_graal_libere_requete_bd($result);


$sql_req = "SELECT Code as `Code`,Libelle as `Libelle`,CodeTva as `CodeTva`,ComptePortAchat as `ComptePortAchat`,ComptePortVente as `ComptePortVente`,CompteFraisAchat as `CompteFraisAchat`,CompteFraisVente as `CompteFraisVente`,DateModification as `DateModification`,JournalVente as `JournalVente` FROM $vl_c_base_origine.categorieachatvente where Code not in (select code from $vl_c_base_destination._param_categories_compta) order by Code";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result))
  {
//  Ajout dans la table des _param_categories_compta
      $vf_e_catcompta_cleunik=_graal_requete_max("catcompta_cleunik","$vl_c_base_destination._param_categories_compta");
      $vl_e_compte_vente_port=ff_cherche_compte($row['ComptePortVente']);
      $vl_e_compte_vente_divers=ff_cherche_compte($row['CompteFraisVente']);
      $vl_e_compte_achat_port=ff_cherche_compte($row['ComptePortAchat']);
      $vl_e_compte_achat_divers=ff_cherche_compte($row['CompteFraisAchat']);
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._param_categories_compta set";
      $sql_req_01 .=" catcompta_cleunik=$vf_e_catcompta_cleunik";
      $sql_req_01 .=",code='".addslashes($row['Code'])."'";
      $sql_req_01 .=",intitule='".addslashes($row['Libelle'])."'";
      $sql_req_01 .=",compte_vente_port=$vl_e_compte_vente_port";
      $sql_req_01 .=",compte_vente_divers=$vl_e_compte_vente_divers";
      $sql_req_01 .=",compte_achat_port=$vl_e_compte_achat_port";
      $sql_req_01 .=",compte_achat_divers=$vl_e_compte_achat_divers";
      $sql_req_01 .=",dateheurecreation='".$row['DateModification']."'";
      $sql_req_01 .=",dateheuremodification='".$row['DateModification']."'";
      $sql_req_01 .=",journal='".$row['JournalVente']."'";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false)
      {
          $vf_c_echo=mysql_error($cnx) . $sql_req_01;
      }
        else
          $vf_c_echo='ok';
  }
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo('Fin de la requÃªte');
function ff_cherche_compte($vv_code)
{
  $sql_req_choix_cleunik = "select pc_cleunik from _param_pc where code='".addslashes($vv_code)."'";
  $result_choix_cleunik = _graal_requete_bd($sql_req_choix_cleunik);
  while ($row_choix_cleunik = mysql_fetch_assoc($result_choix_cleunik))
  {
    $vl_e_choix_cleunik=$row_choix_cleunik['pc_cleunik'];
  }
  _graal_libere_requete_bd($result_choix_cleunik);
  return $vl_e_choix_cleunik;
}
?>
