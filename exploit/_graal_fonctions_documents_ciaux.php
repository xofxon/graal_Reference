<?php
function fa_cree_formulaire_pdf_palette($vv_origine,$commercial_cleunik,$param_generaux_graal_087){
	$param_generaux_graal_088=intval(fa_recup_session('vs_param_generaux_graal_088',0)); //  Moment impression fiche palette
	$param_generaux_graal_089=intval(fa_recup_session('vs_param_generaux_graal_089',0)); //  Une fiche palette par palette ?
	$a_faire=false;
	if ($vv_origine=="BonPréparation" && $param_generaux_graal_088==1){
		$a_faire=true;
	}
	if ($a_faire==true){
		switch ($vv_origine){
			case "BonPréparation":
				$vl_c_fic_consignes="_cdecli_consignes";
				break;
		}
		$sql_req="select sum(qte) as qte from $vl_c_fic_consignes where commercial_cleunik=$commercial_cleunik";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$nb_palettes=$row['qte'];
		_graal_libere_requete_bd($result);
		if ($nb_palettes>0){$a_faire=true;}else {$a_faire=false;}
	}
	if ($a_faire==true){
		if (fa_verif_droit($param_generaux_graal_087)==false) {$a_faire=false;}
	}
	if ($a_faire==true){
		$pdf_referent=fa_extrait_ecrit_fichier($param_generaux_graal_087);
		switch ($param_generaux_graal_088){
			case 1:
				switch ($param_generaux_graal_087){
					case -2:	// 1° modele (contenu des champs du formulaire, idem modèle -3)
					case -3:	// 2° modele (contenu des champs du formulaire, idem modèle -2)
						$xfdf_referen=fa_cree_donnees_xfdf_palette_01($vv_origine,$commercial_cleunik);
						break;
					default:
						$nom_pdf_cree="";
						exit;
						break;
				}
				break;	
			default:
				$nom_pdf_cree="";
				exit();
				break;
		}
		//  Recherche des palettes    
		$output="";
		$uuid=_graal_requete_uuid();
		if ($param_generaux_graal_089==1){
			for($i=0;$i <$nb_palettes;$i++){
				$output_01="mail/".$uuid."_$i".".pdf";
				$output.=$output_01." ";
				$argument="pdftk $pdf_referent fill_form $xfdf_referen output $output_01 flatten";
				exec($argument,$retour,$result);
			}
		} else {
			$i=1;
			$output_01="mail/".$uuid."_$i".".pdf";
			$output.=$output_01." ";
			$argument="pdftk $pdf_referent fill_form $xfdf_referen output $output_01 flatten";
			exec($argument,$retour,$result);
		}
		unlink($xfdf_referen);
		unlink($pdf_referent);
		$uuid=_graal_requete_uuid();
		$nom_pdf_cree="mail/".$uuid.".pdf";
		$argument="pdftk $output cat output $nom_pdf_cree";
		exec($argument,$retour,$result);
		
	} else {
		$nom_pdf_cree="";
	}
	return $nom_pdf_cree;
}
function fa_cree_donnees_xfdf_palette_01($vv_origine,$commercial_cleunik){
	/*
	 * Au 27 octobre 2009,
	 * 
	 * S'applique aux documents -2,-3
	 */
/*	
	<?xml version="1.0" encoding="UTF-8"?>
<xfdf xmlns="http://ns.adobe.com/xfdf/" xml:space="preserve">
    <fields>
        <field name="expediteur_nom">
            <value>Baronnat Vins</value>
        </field>
        <field name="expediteur_coordonnees">
            <value>491 Route de Lacenas - 69400 GLEIZE - Tél : 04 74 68 59 20</value>
        </field>
	<field name="destinataire_ligne01">
            <value>Mr et Mme Sauzet</value>
        </field>
	<field name="destinataire_ligne02">
            <value>complement de nom</value>
        </field>
	<field name="destinataire_ligne03">
            <value>111 Rue de la liberté</value>
        </field>
	<field name="destinataire_ligne04">
            <value></value>
        </field>
	<field name="destinataire_ligne05">
            <value>69400 Villefranche S/S</value>
        </field>
    <field name="destinataire_ligne06">
            <value>Pays si différent de france</value>
        </field>
	<field name="transporteur">
            <value>Baronnat</value>
        </field>
    </fields>
    <f href="fichier.pdf" />
</xfdf>
*/
$modele_xfdf=<<<EOT
<?xml version="1.0" encoding="UTF-8"?>
<xfdf xmlns="http://ns.adobe.com/xfdf/" xml:space="preserve">
    <fields>
        <field name="expediteur_nom">
            <value>#01</value>
        </field>
        <field name="expediteur_coordonnees">
            <value>#02</value>
        </field>
	<field name="destinataire_ligne01">
            <value>#03</value>
        </field>
	<field name="destinataire_ligne02">
            <value>#04</value>
        </field>
	<field name="destinataire_ligne03">
            <value>#05</value>
        </field>
	<field name="destinataire_ligne04">
            <value>#06</value>
        </field>
	<field name="destinataire_ligne05">
            <value>#07</value>
        </field>
	<field name="destinataire_ligne06">
            <value>#08</value>
        </field>        
	<field name="transporteur">
            <value>#09</value>
        </field>
    </fields>
    <f href="fichier.pdf" />
</xfdf>
EOT;
	switch ($vv_origine){
		case "BonPréparation":
			$vl_c_fic_consignes="_cdecli_consignes";
			$vl_c_fic_transport="_cdecli_transporteurs";
			$vl_c_fic_adressess="_cdecli_adresses";
			$vl_c_fic_entetesss="_cdecli_entetes";
			break;
	}
	_graal_requete_charge_varlib("Fen_00730",0);
	$vl_c_bqa_105=fa_recup_dico("bqa_105");
	$vl_c_bqa_106=fa_recup_dico("bqa_106");
	$sql_req_00="SELECT nomcommercial as transporteur FROM $vl_c_fic_transport left join _acteurs on ($vl_c_fic_transport.act_cleunik_trans=_acteurs.act_cleunik) where commercial_cleunik=$commercial_cleunik";
	$result_00=_graal_requete_bd($sql_req_00);
	if (mysql_num_rows($result_00)==0) {
		$transporteur="";
	} else {
		$row_00 = mysql_fetch_assoc($result_00);
		$transporteur=$row_00['transporteur'];
	}
	_graal_libere_requete_bd($result_00);
	$sql_req_00="SELECT a2.raisonsoc as raisonsoc,a2.nomcommercial from $vl_c_fic_entetesss a1 left join _acteurs a2 using(act_cleunik) where commercial_cleunik=$commercial_cleunik";
	$result_00=_graal_requete_bd($sql_req_00);
	$row_00 = mysql_fetch_assoc($result_00);
	$nom_commercial=$row_00['nomcommercial'];
	$raisonsoc=$row_00['raisonsoc'];
	if (trim($nom_commercial=="")){
		$vl_c_03=$raisonsoc;
	
	} else {
		$vl_c_03=$nom_commercial;
	}
	_graal_libere_requete_bd($result_00);
	$sql_req="Select a2.adr_complementnom,a2.adr_ligne1,a2.adr_ligne2,a2.adr_cp,a2.adr_ville,a2.choix_cleunik,a3.choix_valeur_texte_01 as pays from $vl_c_fic_adressess a2 left join _choix a3 using(choix_cleunik) where commercial_cleunik=$commercial_cleunik and adr_typecoordonnees&1";//	Adresse de livraison
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$adresse="";
	if (trim($row['adr_complementnom'])!="") {$vl_c_04=$row['adr_complementnom'];}
	if (trim($row['adr_ligne1'])!="") {$vl_c_05=$row['adr_ligne1'];}
	if (trim($row['adr_ligne2'])!="") {$vl_c_06=$row['adr_ligne2'];}
	//if (trim($row['adr_ligne3'])!="") {$adresse.=$row['adr_ligne3'];}
	if (trim($row['adr_cp'].$row['adr_ville'])!="") {$vl_c_07=$row['adr_cp']." ".$row['adr_ville'];}
	if ($row['choix_cleunik']!=60000) {$vl_c_08=$row['pays'];}
	_graal_libere_requete_bd($result);
	$vl_c_01=$vl_c_bqa_105;
	$vl_c_02=$vl_c_bqa_106;
	$vl_c_03=$vl_c_03;
	$vl_c_04=$vl_c_04;
	$vl_c_05=$vl_c_05;
	$vl_c_06=$vl_c_06;
	$vl_c_07=$vl_c_07;
	$vl_c_08=$vl_c_08;
	$vl_c_09=$transporteur;
	$modele_xfdf=str_replace("#01",$vl_c_01,$modele_xfdf);
	$modele_xfdf=str_replace("#02",$vl_c_02,$modele_xfdf);
	$modele_xfdf=str_replace("#03",$vl_c_03,$modele_xfdf);
	$modele_xfdf=str_replace("#04",$vl_c_04,$modele_xfdf);
	$modele_xfdf=str_replace("#05",$vl_c_05,$modele_xfdf);
	$modele_xfdf=str_replace("#06",$vl_c_06,$modele_xfdf);
	$modele_xfdf=str_replace("#07",$vl_c_07,$modele_xfdf);
	$modele_xfdf=str_replace("#08",$vl_c_08,$modele_xfdf);
	$modele_xfdf=str_replace("#09",$vl_c_09,$modele_xfdf);
	$uuid=_graal_requete_uuid();
	$path="mail/".$uuid.".xfdf";
	$handle_file=fopen($path, 'wb');
	fwrite($handle_file, $modele_xfdf);
	fclose($handle_file);
	return $path;
}
function fa_fin_creation_bp($param_generaux_graal_087){
	global $commercial_cleunik,$code_bondepreparation,$pdf,$vl_e_action_cleunik,$param_generaux_graal_002;
	$code=str_replace('/',"_",$code);
	// Eventuelle création des fiches palettes
	if ($param_generaux_graal_087!=1) {
		$nom_fichier_palette=fa_cree_formulaire_pdf_palette("BonPréparation",$commercial_cleunik,$param_generaux_graal_087);
	} else {
		$nom_fichier_palette="";
	}
	//echo($nom_fichier_palette);
	//die();
	//$nom_fichier_palette="";
    $tmp="mail/";
  $nom_fichier_seul=date("Y_m_d_H_i_s_")."bon_de_preparation_$code_bondepreparation.pdf";
  $path=$tmp.$nom_fichier_seul;
  $pdf->Output($path,'F');
  if (trim($nom_fichier_palette!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."bon_de_preparation_$code_bondepreparation"."_palettes.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path $nom_fichier_palette cat output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($path);
		unlink($nom_fichier_palette);
		$path=$nom_fichier;
	}
  if ($param_generaux_graal_002==1) {
  $vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
	$size=filesize($path);
	$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
	if ($vf_c_retour[0]!=0){
		$vf_e_doc_cleunik=$vf_c_retour[0];
		$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code_bondepreparation',dateheurecreation=now();";
		_graal_exec_requete($sql_req);
	}
  }
  header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
  header('Content-type: application/pdf');
  echo file_get_contents($path);
  unlink($path);
}
function fa_fin_creation_bordereau_expedition(){
	global $code,$param_generaux_graal_008,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_094=intval(fa_recup_session('vs_param_generaux_graal_094','0'));//	Edition des CGV sur livraisons clients
    $param_generaux_graal_095=intval(fa_recup_session('vs_param_generaux_graal_095','0'));//	Fichier filigrane sur livraisons clients
	$param_generaux_graal_094=0;
	$param_generaux_graal_095=0;
	$param_generaux_graal_008=0;
	if(($param_generaux_graal_094!=-1)&&($param_generaux_graal_094!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_094);
	}
	if(($param_generaux_graal_095!=-1)&&($param_generaux_graal_095!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_095);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_bordereau_expedition_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_bordereau_expedition_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	if ($param_generaux_graal_008==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}

function fa_fin_creation_avocli(){
	global $code,$param_generaux_graal_010,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_096=intval(fa_recup_session('vs_param_generaux_graal_096','0'));//	Edition des CGV sur factures clients
    $param_generaux_graal_097=intval(fa_recup_session('vs_param_generaux_graal_097','0'));//	Fichier filigrane sur factures clients
	if(($param_generaux_graal_096!=-1)&&($param_generaux_graal_096!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_096);
	}
	if(($param_generaux_graal_097!=-1)&&($param_generaux_graal_097!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_097);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_avocli_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_avocli_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	if ($param_generaux_graal_010==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_avofou(){
	global $code,$param_generaux_graal_138,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	//$param_generaux_graal_0xx=intval(fa_recup_session('vs_param_generaux_graal_092','0'));//	Edition des CGV sur facture fournisseurs
    $param_generaux_graal_140=intval(fa_recup_session('vs_param_generaux_graal_140','0'));//	Fichier filigrane sur factures fournisseurs
	$nom_fichier_cgv="";
/*
    if(($param_generaux_graal_092!=-1)&&($param_generaux_graal_092!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_092);
	}
*/
	if(($param_generaux_graal_140!=-1)&&($param_generaux_graal_140!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_140);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_avofou_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_avofou_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_138==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_confirmation_cdecli(){
	global $code,$param_generaux_graal_004,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_092=intval(fa_recup_session('vs_param_generaux_graal_092','0'));//	Edition des CGV sur commandes clients
    $param_generaux_graal_093=intval(fa_recup_session('vs_param_generaux_graal_093','0'));//	Fichier filigrane sur commandes clients
	/*
	echo ("param_generaux_graal_004**$param_generaux_graal_004**");
	echo ("param_generaux_graal_093**$param_generaux_graal_093**");
	echo ("param_generaux_graal_092**$param_generaux_graal_092**");
	*/
	if(($param_generaux_graal_092!=-1)&&($param_generaux_graal_092!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_092);
	}
	if(($param_generaux_graal_093!=-1)&&($param_generaux_graal_093!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_093);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_cdecli_confirmation_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_cdecli_confirmation_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_004==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_cdefou(){
	global $code,$param_generaux_graal_039,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	//$param_generaux_graal_0xx=intval(fa_recup_session('vs_param_generaux_graal_092','0'));//	Edition des CGV sur commandes fournisseurs
    $param_generaux_graal_099=intval(fa_recup_session('vs_param_generaux_graal_099','0'));//	Fichier filigrane sur commandes fournisseurs
	$nom_fichier_cgv="";
/*
    if(($param_generaux_graal_092!=-1)&&($param_generaux_graal_092!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_092);
	}
*/
	if(($param_generaux_graal_099!=-1)&&($param_generaux_graal_099!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_099);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_cdefou_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_cdefou_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_039==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
			//echo $sql_req;
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_demfou(){
	global $code,$param_generaux_graal_035,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	//$param_generaux_graal_0xx=intval(fa_recup_session('vs_param_generaux_graal_092','0'));//	Edition des CGV sur demandes fournisseurs
    $param_generaux_graal_098=intval(fa_recup_session('vs_param_generaux_graal_098','0'));//	Fichier filigrane sur demandes fournisseurs
	$nom_fichier_cgv="";
/*
    if(($param_generaux_graal_092!=-1)&&($param_generaux_graal_092!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_092);
	}
*/
	if(($param_generaux_graal_098!=-1)&&($param_generaux_graal_098!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_098);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_demfou_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_demfou_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_035==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_faccli(){
	global $code,$param_generaux_graal_010,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf,$vl_c_fichier_seul;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_096=intval(fa_recup_session('vs_param_generaux_graal_096','0'));//	Edition des CGV sur factures clients
    $param_generaux_graal_097=intval(fa_recup_session('vs_param_generaux_graal_097','0'));//	Fichier filigrane sur factures clients
	if(($param_generaux_graal_096!=-1)&&($param_generaux_graal_096!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_096);
	}
	if(($param_generaux_graal_097!=-1)&&($param_generaux_graal_097!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_097);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_faccli_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_faccli_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	if ($param_generaux_graal_010==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	switch ($vl_c_fichier_seul){
		case "non":
			header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
			header('Content-type: application/pdf');
			echo file_get_contents($path);
			unlink($path);
			break;
		case "oui":
			echo($path);
			break;
	}
}
function fa_fin_creation_facfou(){
	global $code,$param_generaux_graal_138,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	//$param_generaux_graal_0xx=intval(fa_recup_session('vs_param_generaux_graal_092','0'));//	Edition des CGV sur commandes fournisseurs
    $param_generaux_graal_140=intval(fa_recup_session('vs_param_generaux_graal_140','0'));//	Fichier filigrane sur commandes fournisseurs
	$nom_fichier_cgv="";
/*
    if(($param_generaux_graal_092!=-1)&&($param_generaux_graal_092!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_092);
	}
*/
	if(($param_generaux_graal_140!=-1)&&($param_generaux_graal_140!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_140);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_facfou_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_facfou_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_138==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_livcli(){
	global $code,$param_generaux_graal_008,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf,$vl_c_fichier_seul;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_094=intval(fa_recup_session('vs_param_generaux_graal_094','0'));//	Edition des CGV sur livraisons clients
    $param_generaux_graal_095=intval(fa_recup_session('vs_param_generaux_graal_095','0'));//	Fichier filigrane sur livraisons clients
	if(($param_generaux_graal_094!=-1)&&($param_generaux_graal_094!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_094);
	}
	if(($param_generaux_graal_095!=-1)&&($param_generaux_graal_095!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_095);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_livcli_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_livcli_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	if ($param_generaux_graal_008==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	switch ($vl_c_fichier_seul){
		case "non":
			header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
			header('Content-type: application/pdf');
			echo file_get_contents($path);
			unlink($path);
			break;
		case "oui":
			echo($path);
			break;
	}
}
function fa_fin_creation_offcli(){
	global $code,$param_generaux_graal_006,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_090=intval(fa_recup_session('vs_param_generaux_graal_090','0'));//	Edition des CGV sur offres clients
    $param_generaux_graal_091=intval(fa_recup_session('vs_param_generaux_graal_091','0'));//	Fichier filigrane sur offres clients
	if(($param_generaux_graal_090!=-1)&&($param_generaux_graal_090!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_090);
	}
	if(($param_generaux_graal_091!=-1)&&($param_generaux_graal_091!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_091);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_off_cli_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_offcli_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	//echo $param_generaux_graal_006;
	if ($param_generaux_graal_006==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
			//echo $sql_req;
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_retcli(){
	global $code,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_105=intval(fa_recup_session('vs_param_generaux_graal_105',2)); //  1->mémoriser le pdf dans la ged, 2->ne pas le mémoriser dans la ged
	$param_generaux_graal_106=intval(fa_recup_session('vs_param_generaux_graal_106','0'));//	Edition des CGV sur retours clients
    $param_generaux_graal_107=intval(fa_recup_session('vs_param_generaux_graal_107','0'));//	Fichier filigrane sur retours clients
	if(($param_generaux_graal_106!=-1)&&($param_generaux_graal_106!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_106);
	}
	if(($param_generaux_graal_107!=-1)&&($param_generaux_graal_107!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_107);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_retcli_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_retcli_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_105==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_retfou(){
	global $code,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	$param_generaux_graal_116=intval(fa_recup_session('vs_param_generaux_graal_116',2)); //  1->mémoriser le pdf dans la ged, 2->ne pas le mémoriser dans la ged
	//$param_generaux_graal_117=intval(fa_recup_session('vs_param_generaux_graal_117','0'));//	Edition des CGV sur commandes fournisseurs
    $param_generaux_graal_118=intval(fa_recup_session('vs_param_generaux_graal_118','0'));//	Fichier filigrane sur commandes fournisseurs
	$nom_fichier_cgv="";
/*
    if(($param_generaux_graal_117!=-1)&&($param_generaux_graal_117!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_117);
	}
*/
	if(($param_generaux_graal_118!=-1)&&($param_generaux_graal_118!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_118);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_retfou_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
  	$pdf->Output($path,'F');
	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_retfou_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	
	if ($param_generaux_graal_116==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_fin_creation_relfou(){
	global $code,$param_generaux_graal_185,$vl_e_action_cleunik,$vl_commercial_cleunik,$pdf;
	$code=str_replace('/',"_",$code);
	//$param_generaux_graal_0xx=intval(fa_recup_session('vs_param_generaux_graal_092','0'));//	Edition des CGV sur commandes fournisseurs
    $param_generaux_graal_187=intval(fa_recup_session('vs_param_generaux_graal_187','0'));//	Fichier filigrane sur commandes fournisseurs
	$nom_fichier_cgv="";
/*
    if(($param_generaux_graal_092!=-1)&&($param_generaux_graal_092!=0)) {
		$nom_fichier_cgv=fa_extrait_ecrit_fichier($param_generaux_graal_092);
	}
*/
	if(($param_generaux_graal_187!=-1)&&($param_generaux_graal_187!=0)) {
		$nom_fichier_fil=fa_extrait_ecrit_fichier($param_generaux_graal_187);
	}
	$tmp="mail/";
	$nom_fichier_seul=date("Y_m_d_H_i_s_")."00_relfou_$code.pdf";
	//$nom_fichier_seul="cdecli_confirmation_$code.pdf";
	$path=$tmp.$nom_fichier_seul;
	//die($path);
  	$pdf->Output($path,'F');
	
  	if (trim($nom_fichier_cgv!="")){
		$argument="pdftk $path $nom_fichier_cgv cat output $nom_fichier_seul";
		exec($argument,$retour,$result);
		unlink($nom_fichier_cgv);
	}
	
	if (trim($nom_fichier_fil!="")){
		$nom_fichier_seul=date("Y_m_d_H_i_s_")."fil_relfou_$code.pdf";
		$nom_fichier=$tmp.$nom_fichier_seul;
		$argument="pdftk $path background $nom_fichier_fil output $nom_fichier";
		exec($argument,$retour,$result);
		unlink($nom_fichier_fil);
		$path=$nom_fichier;
	}
	//$param_generaux_graal_185=1;
	if ($param_generaux_graal_185==1) {
		$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$size=filesize($path);
		$vf_c_retour=explode("|",fa_insere_document($vf_e_doc_cleunik,$nom_fichier_seul,"3",$size,$path,"action",$vl_e_action_cleunik,"","","",""));
		if ($vf_c_retour[0]!=0){
			$vf_e_doc_cleunik=$vf_c_retour[0];
			$sql_req = "INSERT INTO _docciaux set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$vl_e_action_cleunik,code='$code',dateheurecreation=now();";
			_graal_exec_requete($sql_req);
		}
	}
	header("Content-disposition: inline; filename=\"".basename($nom_fichier_seul)."\"");
	header('Content-type: application/pdf');
	echo file_get_contents($path);
	unlink($path);
}
function fa_maj_prepa_compta($genreaction,$quoi,$vl_commercial_cleunik,$vl_action_cleunik,$vl_tab_action_cleunik,$vl_limit){
	/*
	$genreaction=fa_recup_param("genreaction","??");
	$quoi=fa_recup_param("quoi","compta");
	$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik",-1));
	$vl_action_cleunik=intval(fa_recup_param("vl_action_cleunik",-1));
	$vl_tab_action_cleunik=fa_recup_param("vl_tab_action_cleunik",-1);
	*/
	define('EOL', "\r\n");
	$recup_genreaction=$genreaction;
	$recup_vl_commercial_cleunik=$vl_commercial_cleunik;
	global $genreaction;
	$genreaction=$recup_genreaction;
	global $vl_commercial_cleunik;
	$vl_commercial_cleunik=$recup_vl_commercial_cleunik;
	global $sql_req_ht_marchandise_ht;
	global $sql_req_ht_marchandise_tv;
	global $sql_req_port;
	global $sql_req_frais;
	global $sql_req_acompte;
	global $sql_req_tva;
	global $sql_req_parafiscale;
	global $sql_req_tva_montant;
	global $affiche;
	$genreregroupement="compta_ht";
	include("_graal_req_docial_recap_montants.inc.php");
	$sql_req_ht_marchandise_ht_init=$sql_req_ht_marchandise;
	/*
	 * depuis le 1° décembre 2009, changement de mode de calcul de la TVA, pour tenir compte des taxes parafiscales
	 * 
	 * a priori, $sql_req_ht_marchandise_tv_init désomais inutile
	 */
	$genreregroupement="compta_tva";
	include("_graal_req_docial_recap_montants.inc.php");
	$sql_req_ht_marchandise_tv_init=$sql_req_ht_marchandise;
	$sql_req_port_init=$sql_req_port;
	$sql_req_frais_init=$sql_req_frais;
	$sql_req_port_ori=$sql_req_port;
	$sql_req_frais_ori=$sql_req_frais;
	$sql_req_acompte_ori=$sql_req_acompte;
	$sql_req_parafiscale_ori=$sql_req_parafiscale;
	$sql_req_tva_ori=$sql_req_tva;
	$sql_req_tva_montant_ori=$sql_req_tva_montant;
	switch ($quoi){
		case "montants":
			switch ($genreaction){
			  case "offcli":
			  case "livcli":
			  case "demfou":
			  	break;
			  case "cdefou":
			  	$fic_entetes="_cdefou_entetes";			
					break;
			  case "recfou":
			  case "retcli":
			  case "retfou":
			  	break;
			  case "faccli":
			  	$fic_entetes="_faccli_entetes";
			  	break;
			  case "avocli":
			  case "avofin":
			  	$fic_entetes="_avocli_entetes";
			  	break;
			  case "avofou":
			  case "avofif":
			  	$fic_entetes="_avofou_entetes";
			  	break;
			  case "facfou":
			  	$fic_entetes="_facfou_entetes";
			  	break;
			  		break;
			  case "cdecli":
			  	$fic_entetes="_cdecli_entetes";			
					break;
			}
			$old_vl_commercial_cleunik=$vl_commercial_cleunik;
			switch ($old_vl_commercial_cleunik){
				case -2:
					$sql_req="select f1.commercial_cleunik,f1.action_cleunik from $fic_entetes f1 left join _docciaux_montants f2 using(action_cleunik) where f1.action_cleunik=$vl_action_cleunik;";
					break;
				case -3:	//	tous les null
					$sql_req="select f1.commercial_cleunik,f1.action_cleunik from $fic_entetes f1 left join _echeancier f3 ";
					$sql_req.=" on f1.action_cleunik=f3.action_cleunik where f3.montant_du is null or f3.montant_du=0 group by f1.commercial_cleunik order by f1.dateheurecreation desc limit 100;";
					break;
				case -4:	//	tous
					$sql_req="select f1.commercial_cleunik,f1.action_cleunik from $fic_entetes f1 order by f1.dateheurecreation desc limit $vl_limit;";
					break;
			}
			set_time_limit(36000);  //  3600 secondes (1 heure !!! ) 
			$result = _graal_requete_bd($sql_req);
			$i=0;
			while ($row = mysql_fetch_assoc($result)) {
			  $vl_commercial_cleunik=$row['commercial_cleunik'];
			  $vl_action_cleunik=$row['action_cleunik'];
				$sql_req_ht_marchandise_ht=str_replace("where a1.commercial_cleunik=$old_vl_commercial_cleunik","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_ht_init);
				$sql_req_ht_marchandise_tv=str_replace("where a1.commercial_cleunik=$old_vl_commercial_cleunik","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_tv_init);
				$sql_req_port=str_replace("where a1.commercial_cleunik=$old_vl_commercial_cleunik","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_port_ori);
				$sql_req_frais=str_replace("where a1.commercial_cleunik=$old_vl_commercial_cleunik","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_frais_ori);
				$sql_req_acompte=str_replace("where a1.commercial_cleunik=$old_vl_commercial_cleunik","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_acompte_ori);
				$sql_req_parafiscale=str_replace("where a1.commercial_cleunik=$old_vl_commercial_cleunik","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_parafiscale_ori);
				$sql_req_tva_montant=str_replace("where a1.action_cleunik=$old_vl_commercial_cleunik","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_montant_ori);
				$sql_req_tva=str_replace("where a1.action_cleunik=$old_vl_commercial_cleunik","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_ori);
				//echo $sql_req_tva_ori.EOL;
				//echo $sql_req_tva.EOL;
				
				fa_maj_compta($quoi,$vl_action_cleunik);
				if ($affiche==true){
					$i++;
					echo "doc $i -> $vl_commercial_cleunik $vl_action_cleunik".EOL;
					flush();
				}
			}
			_graal_libere_requete_bd($result);
			break;
	}
}
function fa_maj_compta($vl_c_nature,$vl_action_cleunik){
	define('EOL', "\r\n");
	global $genreaction;
	global $vl_commercial_cleunik;
	global $sql_req_ht_marchandise_ht;
	global $sql_req_ht_marchandise_tv;
	global $sql_req_port;
	global $sql_req_frais;
	global $sql_req_acompte;
	global $sql_req_tva;
	global $sql_req_parafiscale;
	global $sql_req_tva_montant;
	/*
	echo "**".$vl_commercial_cleunik."-";
	echo $vl_action_cleunik."**".EOL;
	*/
	//echo "entrée dans maj compta $vl_action_cleunik";
	switch ($genreaction){
		case "offcli":
			$fic_entete="_offcli_entetes";	
			$fic_lignes="_offcli_lignes";
			$fic_ligqte="_offcli_lignes_qte";
			$choix_cleunik=-110114;
			break;
		case "cdecli":
			$fic_entete="_cdecli_entetes";	
			$fic_lignes="_cdecli_lignes";
			$fic_ligqte="_cdecli_lignes_qte";
			$choix_cleunik=-110108;
			break;
		case "livcli":
			$fic_entete="_livcli_entetes";	
			$fic_lignes="_livcli_lignes";
			$fic_ligqte="_livcli_lignes_qte";
			$choix_cleunik=-110110;
			break;
		case "demfou":
			$fic_entete="_demfou_entetes";	
			$fic_lignes="_demfou_lignes";
			$fic_ligqte="_demfou_lignes_qte";
			$choix_cleunik=-110115;
			break;
		case "cdefou":
			$fic_entete="_cdefou_entetes";	
			$fic_lignes="_cdefou_lignes";
			$fic_ligqte="_cdefou_lignes_qte";
			$choix_cleunik=-110109;
			break;
		case "recfou":
			$fic_entete="_recfou_entetes";	
			$fic_lignes="_recfou_lignes";
			$fic_ligqte="_recfou_lignes_qte";
			$choix_cleunik=-110111;
			break;
		case "retcli":
			$fic_entete="_retcli_entetes";	
			$fic_lignes="_retcli_lignes";
			$fic_ligqte="_retcli_lignes_qte";
			$choix_cleunik=-110133;
			break;
		case "retfou":
			$fic_entete="_retfou_entetes";	
			$fic_lignes="_retfou_lignes";
			$fic_ligqte="_retfou_lignes_qte";
			$choix_cleunik=-110134;
			break;
			break;
		case "faccli":
			$fic_entete="_faccli_entetes";	
			$fic_lignes="_faccli_lignes";
			$fic_ligqte="_faccli_lignes_qte";
			$choix_cleunik=-110112;	
			break;
		case "avocli":
			$fic_entete="_avocli_entetes";	
			$fic_lignes="_avocli_lignes";
			$fic_ligqte="_avocli_lignes_qte";
			$choix_cleunik=-110116;
			break;
		case "avofin":	
			$fic_entete="_avocli_entetes";	
			$fic_lignes="_avocli_lignes";
			$fic_ligqte="_avocli_lignes_qte";
			$choix_cleunik=-110117;	
			break;
		case "avofou":
			$fic_entete="_avofou_entetes";	
			$fic_lignes="_avofou_lignes";
			$fic_ligqte="_avofou_lignes_qte";
			$choix_cleunik=-110137;
			break;
		case "avofif":	
			$fic_entete="_avofou_entetes";	
			$fic_lignes="_avofou_lignes";
			$fic_ligqte="_avofou_lignes_qte";		
			$choix_cleunik=-110138;
			break;
		case "facfou":
			$fic_entete="_facfou_entetes";	
			$fic_lignes="_facfou_lignes";
			$fic_ligqte="_facfou_lignes_qte";
			$choix_cleunik=-110113;	
			break;
	}
	
	switch ($vl_c_nature){
		case "compta":
		case "compta_seule":
			break;
		case "montants":
			switch ($genreaction){
				case "offcli":
				case "cdecli":
					$sql_req_tva=$sql_req_tva_montant;	
					break;
				case "livcli":
				case "demfou":
				case "cdefou":
				case "recfou":
				case "retcli":
				case "retfou":
				case "faccli":
				case "avocli":
				case "avofin":	
				case "avofou":
				case "avofif":	
				case "facfou":
					$sql_req_tva=$sql_req_tva_montant;
					break;
			}
			break;			
	}
	$base_ht=0;
	$total_base_brute=0;
	$total_remise=0;
	$total_ht=0;
	$total_taxe=0;
	$total_ttc=0;
	$no_ordre_tt=-1;
	$no_ordre_ht=10;
	$no_ordre_pa=20;
	$no_ordre_tv=25;
	$no_ordre_po=30;
	$no_ordre_fr=40;
	$vf_c_echo="";
	$vf_c_retour="";
	$deb_trans=_graal_requete_bd("START TRANSACTION;");
	$sql_req = "DELETE FROM _docciaux_montants where action_cleunik=$vl_action_cleunik;";
	//echo $sql_req.EOL;
	$vf_c_echo=_graal_exec_requete($sql_req);
	if($vf_c_echo!='ok') {$vf_c_retour.="-sup! $sql_req";}
	$result = _graal_requete_bd($sql_req_ht_marchandise_ht);
	//echo $sql_req_ht_marchandise_ht.EOL;
	while ($row = mysql_fetch_assoc($result)) {
	  if ($row['montant_avec_remise_pied']!=0){
		  $total_base_brute=$row['htbrutremise'];
	    $total_remise=$row['montantremise_pied'];
	    $base_ht+=$row['montant_avec_remise_pied'];
	    $total_ht+=$row['montant_avec_remise_pied'];
	    $total_taxe+=$row['montant_taxe'];
	    $total_ttc+=$row['montant_avec_remise_pied'];
			$no_ordre_tt++;
			//	Insertion HT marchandise
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_ht=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set action_cleunik=$vl_action_cleunik,commercial_cleunik=$vl_commercial_cleunik,choix_cleunik=$choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=1,montant=$vl_ht,ordre=$no_ordre_ht;";
			$vf_c_echo=_graal_exec_requete($sql_req);
	  		if($vf_c_echo!='ok') {$vf_c_retour.="-2".$sql_req.EOL;}
	  }
	} 
	_graal_libere_requete_bd($result);
	//  Port
	$sql_req_port=str_replace("*base_ht*",$base_ht,$sql_req_port);
	//echo $sql_req_port;
	$result = _graal_requete_bd($sql_req_port);
	while ($row = mysql_fetch_assoc($result)) {
	  if ($row['montant_avec_remise_pied']!=0){
			$no_ordre_po++;
			//	Insertion Port
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_port=$row['montant_avec_remise_pied'];
	   		$total_ttc+=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set action_cleunik=$vl_action_cleunik,commercial_cleunik=$vl_commercial_cleunik,choix_cleunik=$choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=2,montant=$vl_port,ordre=$no_ordre_po;";
			$vf_c_echo=_graal_exec_requete($sql_req);
  			if($vf_c_echo!='ok') {$vf_c_retour.=-4;}
	  }
	} 
	_graal_libere_requete_bd($result);
	//  Frais
	$sql_req_frais=str_replace("*base_ht*",$base_ht,$sql_req_frais);
	$result = _graal_requete_bd($sql_req_frais);
	while ($row = mysql_fetch_assoc($result)) {
	  if ($row['montant_avec_remise_pied']!=0){
			$no_ordre_fr++;
			//	Insertion Frais
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_frais=$row['montant_avec_remise_pied'];
	    	$total_ttc+=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set action_cleunik=$vl_action_cleunik,commercial_cleunik=$vl_commercial_cleunik,choix_cleunik=$choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=2,montant=$vl_frais,ordre=$no_ordre_fr;";
			$vf_c_echo=_graal_exec_requete($sql_req);
  			if($vf_c_echo!='ok') {$vf_c_retour.=-8;}
	  }
	} 
	_graal_libere_requete_bd($result);
	
	if ($base_ht!=0.0){
	//	Taxe parafiscale
	$result = _graal_requete_bd($sql_req_parafiscale);
	//echo $sql_req_parafiscale;
	while ($row = mysql_fetch_assoc($result)) {
	  if ($row['montant_avec_remise_pied']!=0){
	  		$no_ordre_pa++;
			//	Insertion taxe parafiscale
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_parafiscale=$row['montant_avec_remise_pied'];
	    	$total_ttc+=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set action_cleunik=$vl_action_cleunik,commercial_cleunik=$vl_commercial_cleunik,choix_cleunik=$choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=2,montant=$vl_parafiscale,ordre=$no_ordre_pa;";
			$vf_c_echo=_graal_exec_requete($sql_req);
  			if($vf_c_echo!='ok') {$vf_c_retour.="-9".EOL.$vf_c_echo;}
	  }
	} 
	_graal_libere_requete_bd($result);
	}
	$result = _graal_requete_bd($sql_req_tva);
	//echo $sql_req_tva.EOL;
	while ($row = mysql_fetch_assoc($result)) {
	  if ($row['tva']!=0){
			$no_ordre_tv++;
			//	Insertion TVA
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_tva=$row['tva'];
			$total_ttc+=$row['tva'];
			$sql_req = "INSERT INTO _docciaux_montants set action_cleunik=$vl_action_cleunik,commercial_cleunik=$vl_commercial_cleunik,choix_cleunik=$choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=-1,type=2,montant=$vl_tva,ordre=$no_ordre_tv;";
			$vf_c_echo=_graal_exec_requete($sql_req);
  			if($vf_c_echo!='ok') {$vf_c_retour.=-3;}
	  }
	} 
	_graal_libere_requete_bd($result);
	//  Acompte
	$result = _graal_requete_bd($sql_req_acompte);
	while ($row = mysql_fetch_assoc($result)) {
	  if ($row['montant_avec_remise_pied']!=0){
	    $netapayer=$total_ttc-$row['montant_avec_remise_pied'];
	  }
	} 
	_graal_libere_requete_bd($result);
	
	//	Insertion TTC
	$req_acteur="select a1.catcompta_cleunik as catcompta_acteur,a2.pc_cleunik as pc_cleunik_acteur from $fic_entete a1 left join _act_compta a2 on a1.act_cleunik=a2.act_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik;";
	//echo $req_acteur;
	$result_01 = _graal_requete_bd($req_acteur);
	while ($row_01 = mysql_fetch_assoc($result_01)) {
		$vl_pc_cleunik=$row_01['pc_cleunik_acteur'];
		$vl_catcompta_cleunik=$row_01['catcompta_acteur'];
		$sql_req = "INSERT INTO _docciaux_montants set action_cleunik=$vl_action_cleunik,commercial_cleunik=$vl_commercial_cleunik,choix_cleunik=$choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=-1,pc_cleunik=$vl_pc_cleunik,type=0,montant=$total_ttc,ordre=0;";
		$vf_c_echo=_graal_exec_requete($sql_req);
		//echo $sql_req.EOL;
		if($vf_c_echo!='ok') {$vf_c_retour.="-1".$sql_req.EOL;}
	}
	_graal_libere_requete_bd($result_01);	
	switch ($vl_c_nature){
		case "compta_seule":
		case "compta":
			//	Mise à jour règlement
			//$sql_req="update _echeancier f1 set f1.montant_du=$total_ttc where f1.action_cleunik=$vl_action_cleunik and f1.etat=1;"; je ne sais plus à quoi sert ce test sur état ... (le 6 avril 2010)
			$sql_req="update _echeancier f1 set f1.montant_du=$total_ttc where f1.action_cleunik=$vl_action_cleunik;";
			//echo $sql_req;
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok'){$vf_c_retour.=-5;}
			// Mise à jour action
			$sql_req="update _actions f1 left join $fic_entete f2 using(action_cleunik) set f1.statut=-40 where f2.commercial_cleunik=$vl_commercial_cleunik and f1.statut <> -40;";
			//echo $sql_req;
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok'){$vf_c_retour.=-6;}
			// mise à jour ligne document
			$sql_req="update $fic_lignes f1 left join $fic_ligqte f2 using(commercial_ligne_cleunik) set f2.statut=-39 where f1.commercial_cleunik=$vl_commercial_cleunik and f2.statut <> -39";
			//echo $sql_req;
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok'){$vf_c_retour.=-7;}
			// mise à jour document
			$sql_req="update $fic_entete f1 set f1.compta_etat=8 where f1.commercial_cleunik=$vl_commercial_cleunik;";
			//echo $sql_req;
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok'){$vf_c_retour.=-77;}
			break;
		case "montants":
			switch ($genreaction){
					case "offcli":
					case "cdecli":
						$sql_req="update _echeancier f1 set f1.montant_du=$total_ttc where f1.action_cleunik=$vl_action_cleunik;";
						$vf_c_echo=_graal_exec_requete($sql_req);
						//echo $sql_req.EOL;
						if($vf_c_echo!='ok'){$vf_c_retour.="-5bis";}
						// mise à jour document
						$sql_req="update $fic_entete f1 set f1.compta_etat=8 where f1.commercial_cleunik=$vl_commercial_cleunik;";
						$vf_c_echo=_graal_exec_requete($sql_req);
						if($vf_c_echo!='ok'){$vf_c_retour.=-77;}
						//echo $sql_req;
						break;
					case "faccli":
					case "avocli":
					case "avofin":
					case "cdefou":
					case "avofou":
					case "avofif":	
					case "facfou":
						$sql_req="update _echeancier f1 set f1.montant_du=$total_ttc where f1.action_cleunik=$vl_action_cleunik;";
						$vf_c_echo=_graal_exec_requete($sql_req);
						//echo $sql_req.EOL;
						if($vf_c_echo!='ok'){$vf_c_retour.="-5bis";}
						break;
					case "livcli":
					case "demfou":
					case "recfou":
					case "retcli":
					case "retfou":
					
						
					
						break;
				}
			break;
		case "compta":
			break;
	}
	if ($vf_c_retour=="") {
		switch ($vl_c_nature){
			case "compta"	:_graal_requete_bd("COMMIT;");break;
			case "compta_seule"	:echo "Comptabilisation ok.";_graal_requete_bd("COMMIT;");break;
			case "montants"	:
				//echo "Calcul montants ok.";
				_graal_requete_bd("COMMIT;");break;
		}
	} else {
		
		switch ($vl_c_nature){
			case "compta"	:_graal_requete_bd("ROLLBACK;");break;
			case "compta_seule"	:echo "Problème lors de la comptabilisation $vf_c_retour.";_graal_requete_bd("ROLLBACK;");break;
			case "montants"	:
				//echo "Problème lors du calcul des montants $vf_c_retour.";
				_graal_requete_bd("ROLLBACK;");break;
		}
		//die($vf_c_retour);
	}
}
function fa_maj_decompta($vl_action_cleunik){
	global $genreaction;
	global $vl_commercial_cleunik;
	switch ($genreaction){
	  case "offcli":
	  case "cdecli":
	  case "livcli":
		case "demfou":
	  case "cdefou":
	  case "recfou":
			$fic_compta="";
			break;
	  case "faccli":
			$fic_entete="_faccli_entetes";	
			$fic_lignes="_faccli_lignes";
			$fic_ligqte="_faccli_lignes_qte";		
			break;
	  case "avocli":
	  case "avofin":	
			$fic_entete="_avocli_entetes";	
			$fic_lignes="_avocli_lignes";
			$fic_ligqte="_avocli_lignes_qte";		
			break;
	  case "avofou":
	  case "avofif":	
			$fic_entete="_avofou_entetes";	
			$fic_lignes="_avofou_lignes";
			$fic_ligqte="_avofou_lignes_qte";		
			break;
	  case "facfou":
			$fic_entete="_facfou_entetes";	
			$fic_lignes="_facfou_lignes";
			$fic_ligqte="_facfou_lignes_qte";		
			break;
	}
	$vf_c_retour="";
	$deb_trans=_graal_requete_bd("START TRANSACTION;");
	/*
	$sql_req = "DELETE FROM $fic_compta where commercial_cleunik=$vl_commercial_cleunik;";
	$vf_c_echo=_graal_exec_requete($sql_req);
	if($vf_c_echo!='ok') {$vf_c_retour.=-2;}
*/
	//	Mise à jour règlement
	$sql_req="update _echeancier f1 set f1.montant_du=NULL where f1.action_cleunik=$vl_action_cleunik;";
	$vf_c_echo=_graal_exec_requete($sql_req);
	if($vf_c_echo!='ok'){$vf_c_retour.=-5;}
// mise à jour document
	$sql_req="update $fic_entete f1 set f1.compta_etat=1 where f1.action_cleunik=$vl_action_cleunik;";
	//echo $sql_req;
	$vf_c_echo=_graal_exec_requete($sql_req);
	if($vf_c_echo!='ok'){$vf_c_retour.=-77;}
	if ($vf_c_retour=="") {
		echo "Dé-Comptabilisation ok.";
	  _graal_requete_bd("COMMIT;");
	} else {
 		echo "Problème lors de la dé-comptabilisation $vf_c_retour.";
		_graal_requete_bd("ROLLBACK;");
	}
}

?>