<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_qui=fa_recup_param('qui','');
$vl_c_quoi=fa_recup_param('quoi','');
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik',''));
switch ($vl_c_qui) {
  case "clients": $sql_req = "SELECT Code as `Code`,Niveau as `Niveau`,Nom as `Nom`,DateModification as `DateModification`,TypeTarif as `TypeTarif`,Categorie as `Categorie`,Frais as `Frais`,Reglement as `Reglement`,Releve as `Releve`,Periodicite as `Periodicite`,UneFactureParBL as `UneFactureParBL`,UneFactureParCde as `UneFactureParCde`,Representant as `Representant` FROM $vl_c_base_origine.familleclient where Code not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";break;
  case "fournis": $sql_req = "SELECT Code as `Code`,Niveau as `Niveau`,Nom as `Nom`,DateModification as `DateModification` FROM $vl_c_base_origine.famillefournisseur where Code not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";break;
  case "prospect": $sql_req = "SELECT Code as `Code`,Designation as `Nom` FROM $vl_c_base_origine.familletiers where Code not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";break;
}
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
//  Ajout dans la table des choix
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=$vl_e_critere_cleunik";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  $sql_req_01 .=",choix_code='".addslashes($row['Code'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['Nom'])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=127";
  $i++;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
}
_graal_libere_requete_bd($result);
switch ($vl_c_qui) {
  case "clients": $sql_req = "SELECT distinct($vl_c_quoi) as code FROM $vl_c_base_origine.Client where $vl_c_quoi not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";break;
  case "fournis": $sql_req = "SELECT distinct($vl_c_quoi) as code FROM $vl_c_base_origine.fournisseur where $vl_c_quoi not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";break;
  case "prospect": $sql_req = "SELECT distinct($vl_c_quoi) as code FROM $vl_c_base_origine.tiers where $vl_c_quoi not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";break;
}
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
//  Ajout dans la table des choix
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=$vl_e_critere_cleunik";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  $sql_req_01 .=",choix_code='".addslashes($row['code'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['code'])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=127";
  $i++;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
}
_graal_libere_requete_bd($result);
if ($i<>0) {echo("$i familles ajoutÃ©es");} else {echo("Aucune nouvelle famille ...");}
?>
