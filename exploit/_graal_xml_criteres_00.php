<?php
include("_graal_header_xml.inc.php");
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','10009'));
$vl_c_portee=fa_recup_param('vl_c_portee','acteurs');
define('EOL', "\r\n");
// execution de la requète SQL
$sql_req="SELECT critere_cleunik as `critere_cleunik`,critere_code as `critere_code`,critere_denomination as `critere_denomination`,critere_type as `critere_type`,critere_choixmultiples as `critere_choixmultiples`,critere_blocnotebrut as `critere_blocnotebrut`,critere_dateheurecreation as `critere_dateheurecreation`,critere_dateheuremodification as `critere_dateheuremodification`,critere_actif as `critere_actif`,critere_portee as `critere_portee`,critere_hl as `critere_hl`,critere_perso as `critere_perso`,critere_codechoixpertinent FROM _criteres where critere_cleunik=$vl_e_critere_cleunik";
$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
$row = mysql_fetch_assoc($result);
echo('<Description>');
echo('<critere_cleunik data="'.fa_ent_xml($row['critere_cleunik']).'"/>');
echo('<critere_code data="'.fa_ent_xml($row['critere_code']).'"/>');
echo('<critere_denomination data="'.fa_ent_xml($row['critere_denomination']).'"/>');
echo('<critere_type data="'.fa_ent_xml($row['critere_type']).'"/>');
echo('<critere_choixmultiples data="'.fa_ent_xml($row['critere_choixmultiples']).'"/>');
echo('<critere_blocnotebrut data="'.fa_ent_xml($row['critere_blocnotebrut']).'"/>');
echo('<critere_dateheurecreation data="'.fa_ent_xml($row['critere_dateheurecreation']).'"/>');
echo('<critere_dateheuremodification data="'.fa_ent_xml($row['critere_dateheuremodification']).'"/>');
echo('<critere_actif data="'.fa_ent_xml($row['critere_actif']).'"/>');
echo('<critere_portee data="'.fa_ent_xml($row['critere_portee']).'"/>');
echo('<critere_hl data="'.fa_ent_xml($row['critere_hl']).'"/>');
echo('<critere_perso data="'.fa_ent_xml($row['critere_perso']).'"/>');
echo('<critere_codechoixpertinent data="'.fa_ent_xml($row['critere_codechoixpertinent']).'"/>');
switch ($vl_c_portee) {
  case "actions"  :$sql_req = "SELECT count(*) as nombre,'typeacteur' as typeacteur from _actions_choix_fixes where _actions_choix_fixes.critere_cleunik = $vl_e_critere_cleunik group by typeacteur";break;
  case "acteurs"  :$sql_req = "SELECT count(*) as nombre,typeacteur as typeacteur from _act_choix_fixes where _act_choix_fixes.critere_cleunik = $vl_e_critere_cleunik group by typeacteur";break;
  case "articles" :$sql_req = "SELECT count(*) as nombre,'typeacteur' as typeacteur from _art_choix_fixes where _art_choix_fixes.critere_cleunik = $vl_e_critere_cleunik group by typeacteur";break;
  case "ged"      :$sql_req = "SELECT count(*) as nombre,'typeacteur' as typeacteur from _documents_choix_fixes where _documents_choix_fixes.critere_cleunik = $vl_e_critere_cleunik group by typeacteur";break;
}
//echo('<req_pres data="'.fa_ent_xml($sql_req).'"/>');
if ($sql_req!='') {
  $result = _graal_requete_bd($sql_req);
  // boucle de récupération des enregistrements de la requête et génération du contenu RDF
  $i=0;
  while ($row = mysql_fetch_assoc($result)) {
    $i++;
    echo('<nombre_utilisations_'.$i.' data="'.fa_ent_xml($row['nombre']).'"/>');
    echo('<typeacteur_'.$i.' data="'.fa_ent_xml($row['typeacteur']).'"/>');
  }
}
echo('</Description>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
