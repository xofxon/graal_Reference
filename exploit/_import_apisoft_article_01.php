<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_artic=fa_recup_param('vl_c_fic_tiers','article');
$vl_e_famille=intval(fa_recup_param('vl_e_famille',0));
$mil_cod=array();$mil_cle=array();
$param_generaux_graal_167=intval(fa_recup_session('vs_param_generaux_graal_167','0'));
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=1000"; //  On recherche les millésimes
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($mil_cod, $row['code']);
  array_push ($mil_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$cou_cod=array();$cou_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=1001"; //  On recherche les couleurs
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($cou_cod, $row['code']);
  array_push ($cou_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$typ_cod=array();$typ_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=1002"; //  On recherche les types de vins
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($typ_cod, $row['code']);
  array_push ($typ_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$ten_cod=array();$ten_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=1004"; //  On recherche les conternants
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($ten_cod, $row['code']);
  array_push ($ten_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$fam_cod=array();$fam_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=$vl_e_famille"; //  On recherche les familles
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($fam_cod, $row['code']);
  array_push ($fam_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$uniachat_cod=array();$uniachat_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=110"; //  On recherche les unités d'achat
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($uniachat_cod, $row['code']);
  array_push ($uniachat_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$univente_cod=array();$univente_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=109"; //  On recherche les unités de ventes
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($univente_cod, $row['code']);
  array_push ($univente_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$unistock_cod=array();$unistock_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=108"; //  On recherche les unités de stock
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($unistock_cod, $row['code']);
  array_push ($unistock_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$unicondi_cod=array();$unicondi_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=128"; //  On recherche les conditionnements
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($unicondi_cod, $row['code']);
  array_push ($unicondi_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$sql_req = "SELECT Code,CodeBarre,Nom,Type,Famille,Sommeil,DerPa,Pamp,Frais,Coefficient,PrixBaseHT,PrixBaseTTC,MargeFrancs,MargePourcent,Longueur,Largeur,Epaisseur,PoidsBrut,Tare,PoidsNet,NombreParColis,ValorisationStk,StockMinGen,StockMaxGen,StockPhyGen,ReliquatFseur,ReliquatClient,UniteVente,UniteStock,EquivalenceVS,Descriptif,FacturationTypePoids,FabricationPrealable,PrestationHoraire,Note,Image,CodeTva,DateCreation,DateModification,DateMajDerPa,GestionStock,CoeffFacturation,Millesime,Couleur,Typedevin,Conditionnement,Tauxalcool,Capacite,Contenant FROM $vl_c_base_origine.$vl_c_fic_artic where Code not in (select _article.code from $vl_c_base_destination._article) order by Code";
$o_article=new _graal_import();
$o_choix=new _graal_import();
$o_achat=new _graal_import();
$o_vente=new _graal_import();
$o_stock=new _graal_import();
$o_dimen=new _graal_import();
$o_article->req="INSERT INTO $vl_c_base_destination._article (art_cleunik,code,mnemotechnique,description,blocnotebrut,blocnotertf,dateheurecreation,dateheuremodif,types_gestion,actif,nbdec_prix,pr_generique,nbdec_qte) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._art_choix_fixes (art_cleunik,choix_cleunik,critere_cleunik,uti_cleunik) VALUES ";
$o_achat->req="INSERT INTO $vl_c_base_destination._art_achats (art_cleunik,der_pa,pamp,dateheure_der_achat,unite_achat) VALUES ";
$o_vente->req="INSERT INTO $vl_c_base_destination._art_ventes (art_cleunik,unite_vente) VALUES ";
$o_stock->req="INSERT INTO $vl_c_base_destination._art_stock (art_cleunik,unite_stock,gestion,nb_decimales_qte,qte_mini,qte_maxi,qte_stock,unite_condi,nb_stock_in_condi) VALUES ";
$o_dimen->req="INSERT INTO $vl_c_base_destination._art_dimensions (art_cleunik,capacite,unite_capacite) VALUES ";
$vf_e_art_cleunik=_graal_requete_max("art_cleunik","$vl_c_base_destination._article");
$i=0;$i1=500;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
//  Ajout dans la table des articles
  $vf_e_art_cleunik++;
  $i++;
  $code=addslashes($row['Code']);
  $mnemotechnique=addslashes($row['Code']);
  $description=addslashes($row['Nom']);
  $blocnotebrut=addslashes($row['Note']).EOL.addslashes($row['Descriptif']);
  $blocnotertf=addslashes($row['Note']).EOL.addslashes($row['Descriptif']);
  $dateheurecreation=$row['DateCreation'];
  $dateheuremodif=$row['DateModification'];
  $der_pa=$row['DerPa'];
  $pamp=$row['Pamp'];
  $dateheure_der_achat=$row['DateMajDerPa'];
  $qte_mini=$row['StockMinGen'];
  $qte_maxi=$row['StockMaxGen'];
  $qte_stock=$row['StockPhyGen'];
  $nb_stock_in_condi=$row['NombreParColis'];
  $capacite=$row['Capacite'];
  $types_gestion=1+2+8; //  Achats + Ventes + Fabrication
  $vl_e_trouve=array_search($row['UniteVente'], $uniachat_cod);if ($vl_e_trouve===false) {$unite_achat=-36;} else {$unite_achat=$uniachat_cle[$vl_e_trouve];}
  $vl_e_trouve=array_search($row['UniteVente'], $univente_cod);if ($vl_e_trouve===false) {$unite_vente=-35;} else {$unite_vente=$univente_cle[$vl_e_trouve];}
  $vl_e_trouve=array_search($row['UniteStock'], $unistock_cod);if ($vl_e_trouve===false) {$unite_stock=-14;} else {$unite_stock=$unistock_cle[$vl_e_trouve];}
  $vl_e_trouve=array_search($row['Conditionnement'], $unicondi_cod);if ($vl_e_trouve===false) {$unite_condi=-37;} else {$unite_condi=$unicondi_cle[$vl_e_trouve];}
  switch ($row['GestionStock']) {
    case -1  : 
      $types_gestion+=4;
      $o_stock->dat.="($vf_e_art_cleunik,$unite_stock,2,$param_generaux_graal_167,$qte_mini,$qte_maxi,$qte_stock,$unite_condi,$nb_stock_in_condi),";
    break;  //  Gestion du stock
  }
  switch ($row['Sommeil']) {
    case 0  : $actif=1;break;  //  Actif
    case -1 : $actif=2;break;  //  Inactif
  }
  $o_article->dat.="($vf_e_art_cleunik,'$code','$mnemotechnique','$description','$blocnotebrut','$blocnotertf','$dateheurecreation','$dateheuremodif',$types_gestion,$actif,2,0,$param_generaux_graal_167),";
  $o_achat->dat.="($vf_e_art_cleunik,$der_pa,$pamp,'$dateheure_der_achat',$unite_achat),";
  $o_vente->dat.="($vf_e_art_cleunik,$unite_vente),";
  $o_dimen->dat.="($vf_e_art_cleunik,$capacite,-55),";
  //  Alimentation choix Millesime
  $vl_e_trouve=array_search($row['Millesime'], $mil_cod);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$mil_cle[$vl_e_trouve];}
  if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,1000,0),";}
  //  Alimentation choix couleur
  $vl_e_trouve=array_search($row['Couleur'], $cou_cod);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$cou_cle[$vl_e_trouve];}
  if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,1001,0),";}
  //  Alimentation choix Types de vins
  $vl_e_trouve=array_search($row['Typedevin'], $typ_cod);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$typ_cle[$vl_e_trouve];}
  if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,1002,0),";}
  //  Alimentation choix Contenant
  $vl_e_trouve=array_search($row['Contenant'], $ten_cod);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$ten_cle[$vl_e_trouve];}
  if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,1004,0),";}
  //  famille
  $vl_e_trouve=array_search($row['Famille'], $fam_cod);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$fam_cle[$vl_e_trouve];}
  if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,$vl_e_famille,0),";}
  if ($i % $i1==0){
    $o_article->execute();
    $o_achat->execute();
    $o_vente->execute();
    $o_stock->execute();
    $o_choix->execute();
    $o_dimen->execute();
  }
}
$o_article->execute();
$o_achat->execute();
$o_vente->execute();
$o_choix->execute();
$o_stock->execute();
$o_dimen->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo("$i articles importés.");
?>
