<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_inventaire_01";
fa_acces_script();
$vf_c_echo="";
$vl_e_mini=intval(fa_recup_session("borne_mini","000000000000"));
$vl_e_maxi=intval(fa_recup_session("borne_maxi","999999999999"));
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_inv_cleunik=intval(fa_recup_param("vl_inv_cleunik",0));
$vl_description=fa_recup_param("vl_description","");
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_dateheureinventaire=fa_recup_param("vl_dateheureinventaire","");
$vl_etat=intval(fa_recup_param("vl_etat",""));
$vl_gestion_depemp=intval(fa_recup_param("vl_gestion_depemp",""));
$vl_tarif_reference=intval(fa_recup_param("vl_tarif_reference",""));
$vl_e_art_cleunik=fa_recup_param("vl_e_art_cleunik","-1");
$vl_critere_cleunik=intval(fa_recup_param("vl_critere_cleunik",""));
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _inventaire WHERE inv_cleunik=$vl_inv_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="ajouter":
    $vl_inv_cleunik=_graal_requete_max("inv_cleunik","_inventaire");
    $sql_req = "INSERT INTO _inventaire set inv_cleunik=$vl_inv_cleunik,description='$vl_description',blocnotebrut='$vl_blocnotebrut',dateheurecreation=now(),dateheureinventaire='$vl_dateheureinventaire',etat=$vl_etat,gestion_depemp=$vl_gestion_depemp,tarif_reference=$vl_tarif_reference,critere_cleunik=$vl_critere_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _inventaire set description='$vl_description',blocnotebrut='$vl_blocnotebrut',dateheureinventaire='$vl_dateheureinventaire',etat='$vl_etat',gestion_depemp=$vl_gestion_depemp,tarif_reference=$vl_tarif_reference,critere_cleunik=$vl_critere_cleunik WHERE inv_cleunik=$vl_inv_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=maj_pu_inv($vl_inv_cleunik,$vl_tarif_reference);$vf_c_echo=$vl_inv_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="articles_kilometre":
    $vl_t_listecles=fa_recup_param('vl_t_listecles','');
    $vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $vl_art_cleunik=$vl_t_listecles[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_art_cleunik";} else {$sql_condition.= ",$vl_art_cleunik";};
    }
    $sql_req="SELECT tarif_reference as `tarif_reference` FROM _inventaire where inv_cleunik=$vl_inv_cleunik";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    $vl_tarif_reference=$row['tarif_reference'];
    _graal_libere_requete_bd($result);
    $sql_req_01="insert into _inventaire_lignes SELECT $vl_inv_cleunik,_article.art_cleunik,0,0,0,-15,-16,0,$vl_tarif_reference,nbdec_prix FROM `_article` where _article.art_cleunik in ($sql_condition) AND _article.types_gestion & 4 and _article.art_cleunik not in (select distinct(art_cleunik) from _inventaire_lignes WHERE inv_cleunik=$vl_inv_cleunik);";
    $vf_c_echo=_graal_exec_requete($sql_req_01);
    if($vf_c_echo=='ok') {$vf_c_echo=maj_pu_inv($vl_inv_cleunik,$vl_tarif_reference);$vf_c_echo=$vl_inv_cleunik;} else {$vf_c_echo=$sql_req_01;}
    break;  
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();

function maj_pu_inv($vl_inv_cleunik,$vl_tarif_reference) {
  //  RAZ
  $sql_req="UPDATE _inventaire_lignes set pu_inv=0,nbdec_pu=0,tarif_reference=$vl_tarif_reference where inv_cleunik=$vl_inv_cleunik;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Maj derpa à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_art_achats,_article set pu_inv=der_pa,nbdec_pu=nbdec_prix where _article.art_cleunik=_inventaire_lignes.art_cleunik and _art_achats.art_cleunik=_article.art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-1;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Prix de revient de fabrication à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_art_fabs set pu_inv=pr,nbdec_pu=nbdec_pr where _inventaire_lignes.art_cleunik=_art_fabs.art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-2;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Maj PAMP à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_art_achats,_article set pu_inv=pamp,nbdec_pu=nbdec_prix where _article.art_cleunik=_inventaire_lignes.art_cleunik and _art_achats.art_cleunik=_article.art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-3;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  //  Prix de revient générique à l'instant de la validation
  $sql_req="UPDATE _inventaire_lignes,_article set pu_inv=pr_generique,nbdec_pu=nbdec_prix where _article.art_cleunik=_inventaire_lignes.art_cleunik and inv_cleunik=$vl_inv_cleunik and _inventaire_lignes.tarif_reference=-5;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
  return $vl_c_mess_err;
}
echo $vf_c_echo;
?>
