<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_artic=fa_recup_param('vl_c_fic_tiers','article');
$vl_e_famille=intval(fa_recup_param('vl_e_famille',0));
$art_cod=array();$art_cle=array();
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(code) from $vl_c_base_origine.$vl_c_fic_artic)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);
$fam_cod=array();$fam_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=$vl_e_famille"; //  On recherche les familles
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($fam_cod, $row['code']);
  array_push ($fam_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$sql_req = "SELECT Code,Famille FROM $vl_c_base_origine.$vl_c_fic_artic where Code in (select _article.code from $vl_c_base_destination._article) order by Code";
//echo $sql_req.EOL;
$o_choix=new _graal_import();
$o_choix->req="INSERT INTO $vl_c_base_destination._art_choix_fixes (art_cleunik,choix_cleunik,critere_cleunik,uti_cleunik) VALUES ";
$i=0;$i1=5000;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
//  Ajout dans la table des articles
  $i++;
  //echo $row['Famille'].EOL;
  $vl_e_trouve=array_search($row['Code'], $art_cod);if ($vl_e_trouve===false) {$vf_e_art_cleunik=0;} else {$vf_e_art_cleunik=$art_cle[$vl_e_trouve];}
  $vl_e_trouve=array_search($row['Famille'], $fam_cod);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$fam_cle[$vl_e_trouve];}
  if (($vl_e_choix_cleunik==0)||($vf_e_art_cleunik==0)) {
  } else {
  	$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,$vl_e_famille,0),";
  }
  if ($i % $i1==0){
    $o_choix->execute();
  }
}
//echo $o_choix->req.$o_choix->dat;
$o_choix->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo("$i critères familles articles importés.");
?>
