<?php 
include("_graal_header_txt.inc.php");
$vl_c_code_banque=fa_recup_param('vl_etablissement','00000');
$vl_c_code_guichet=fa_recup_param('vl_guichet','00000');
$vl_c_compte=fa_recup_param('vl_compte','00000000000');
$vl_c_cle=fa_recup_param('vl_cle','00');
If (strlen($vl_c_code_banque)!=5) {echo 'Un code banque doit comporter 5 chiffres ou lettres.';}
Elseif (strlen($vl_c_code_guichet)!=5) {echo 'Un code guichet doit comporter 5 chiffres ou lettres.';}
Elseif (strlen($vl_c_compte)!=11) {echo 'Un numéro de compte doit comporter 11 chiffres ou lettres.';}
Elseif (strlen($vl_c_cle)!=2) {echo 'Une clé RIB doit comporter 2 chiffres ou lettres.';}
else 
{
  $t_e_coef = array(62, 34, 3) ;
  //concatenation des differents codes.
  $vl_c_rib = $vl_c_code_banque.$vl_c_code_guichet.$vl_c_compte.$vl_c_cle ;
  $vl_c_rib = strtolower($vl_c_rib) ;
  //on remplace les éventuelles lettres par des chiffres.
  $vl_c_rib = strtr($vl_c_rib, "abcdefghijklmnopqrstuvwxyz", "12345678912345678923456789") ;
  //separation du rib en 3 groupes de 7 + 1 groupe de 2.
  //multiplication de chaque groupe par les coef du tableau
  for ($i=0, $s=0; $i<3; $i++) 
  {
    $vl_c_code = substr($vl_c_rib, 7 * $i, 7) ;
    $s += (0 + $vl_c_code) * $t_e_coef[$i] ; 
  }
  //soustraction du modulo 97 de $s à 97 pour obtenir la clé RIB
  $vl_c_cle_calculee = 97 - ($s % 97) ;
  if ($vl_c_cle_calculee == $vl_c_cle) { echo "Ce RIB est bon." ; } else { echo "Le RIB est incorrect." ; }
}
?>
