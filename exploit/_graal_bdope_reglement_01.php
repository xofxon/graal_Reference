<?php
include("_graal_header_txt.inc.php");
define('EOL', "\r\n");
$vf_c_echo="";
$vl_echeance_cleunik=intval(fa_recup_param('echeance_cleunik','-1'));
$vl_c_fichier_echeance=fa_recup_param('fichier_echeance','_faccli_echeancier');
$sql_req_base="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base.="a5.date_fact,"._graalsql_date('a5.date_fact')." as `date_fact_clair`,";
$sql_req_base.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base.="a1.libelle,a1.montant_du,a1.montant_paye,a1.devise_du,a1.devise_paye,";
$sql_req_base.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base.="a5.code as code_document,";
$sql_req_base.="a5.action_cleunik as action_cleunik,";
$sql_req_base.="a5.act_cleunik as act_cleunik,";
$sql_req_base.="a6.actif as actif,";
$sql_req_base.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";
$fichier="_echeancier";
switch ($vl_c_fichier_echeance){
	case '_faccli_echeancier':
	case '_cdecli_echeancier':
	case '_avocli_echeancier':
		$fichier_01="_treso_reglement_cli";
		$fichier_02="_treso_reglement_cli_detail";
		break;
	case '_facfou_echeancier':
	case '_avofou_echeancier':
		$fichier_01="_treso_reglement_fou";
		$fichier_02="_treso_reglement_fou_detail";
		break;
}

$sql_req_base="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base.="a5.date_fact,"._graalsql_date('a5.date_fact')." as `date_fact_clair`,";
$sql_req_base.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base.="a1.libelle,a1.montant_du,a1.montant_paye,a1.devise_du,a1.devise_paye,";
$sql_req_base.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base.="a5.code as code_document,";
$sql_req_base.="a5.action_cleunik as action_cleunik,";
$sql_req_base.="a5.act_cleunik as act_cleunik,";
$sql_req_base.="a6.actif as actif,";
$sql_req_base.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_cli="(select sum((a7.montant_paye*a7.coef)) from `_treso_reglement_cli_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_cli.=" 'ai14' as properties_document,'_faccli_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_cli.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_cli.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_cli.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_cli.=" join _faccli_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_cli.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";


$sql_req_base_avocli="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base_avocli.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base_avocli.="a5.date_avoi,"._graalsql_date('a5.date_avoi')." as `date_fact_clair`,";
$sql_req_base_avocli.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base_avocli.="a1.libelle,a1.montant_du*-1,a1.montant_paye*-1,a1.devise_du,a1.devise_paye,";
$sql_req_base_avocli.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base_avocli.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base_avocli.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base_avocli.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base_avocli.="a5.code as code_document,";
$sql_req_base_avocli.="a5.action_cleunik as action_cleunik,";
$sql_req_base_avocli.="a5.act_cleunik as act_cleunik,";
$sql_req_base_avocli.="a6.actif as actif,";
$sql_req_base_avocli.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_avocli="(select sum((a7.montant_paye*a7.coef*-1)) from `_treso_reglement_cli_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_avocli.=" 'ai14' as properties_document,'_avocli_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_avocli.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_avocli.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_avocli.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_avocli.=" join _avocli_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_avocli.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";


$sql_req_fou="(select sum((a7.montant_paye*a7.coef)) from `_treso_reglement_fou_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_fou.=" 'ah06' as properties_document,'_facfou_echeancier' as fichier_echeance FROM _echeancier a1";
$sql_req_fou.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_fou.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_fou.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_fou.=" join _facfou_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_fou.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";

$sql_req_base_avofou="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base_avofou.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base_avofou.="a5.date_avoi,"._graalsql_date('a5.date_avoi')." as `date_fact_clair`,";
$sql_req_base_avofou.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base_avofou.="a1.libelle,a1.montant_du*-1,a1.montant_paye*-1,a1.devise_du,a1.devise_paye,";
$sql_req_base_avofou.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base_avofou.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base_avofou.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base_avofou.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base_avofou.="a5.code as code_document,";
$sql_req_base_avofou.="a5.action_cleunik as action_cleunik,";
$sql_req_base_avofou.="a5.act_cleunik as act_cleunik,";
$sql_req_base_avofou.="a6.actif as actif,";
$sql_req_base_avofou.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_avofou="(select sum((a7.montant_paye*a7.coef*-1)) from `_treso_reglement_fou_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_avofou.=" 'ah06' as properties_document,'_avofou_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_avofou.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_avofou.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_avofou.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_avofou.=" join _avofou_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_avofou.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";


$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_reglement_cleunik=intval(fa_recup_param("vl_reglement_cleunik",""));
$vl_journal_cleunik=intval(fa_recup_param("vl_journal_cleunik","-1"));
$vl_pc_cleunik=intval(fa_recup_param("vl_pc_cleunik",""));
$vl_mode_paiement=intval(fa_recup_param("vl_mode_paiement",""));
$vl_piece=fa_recup_param("vl_piece","");
$vl_ref_piece=fa_recup_param("vl_ref_piece","");
$vl_dateheurereglemen=fa_recup_param("vl_dateheurereglemen","");
$vl_montant_paye=fa_floatval(fa_recup_param("vl_montant_paye",""));
$vl_montant_pointe=fa_floatval(fa_recup_param("vl_montant_pointe",""));
$vl_devise_paye=intval(fa_recup_param("vl_devise_paye",""));
$vl_coef=intval(fa_recup_param("vl_coef",""));
$vl_acompte=intval(fa_recup_param("vl_acompte",""));
$vl_transfert=intval(fa_recup_param("vl_transfert",""));
$vl_impaye=intval(fa_recup_param("vl_impaye",""));
$vl_remboursement=intval(fa_recup_param("vl_remboursement",""));
$vl_option_remise=intval(fa_recup_param("vl_option_remise",""));
$vl_accepte=intval(fa_recup_param("vl_accepte",""));
$vl_banque=fa_recup_param("vl_banque","");
$vl_domiciliation=fa_recup_param("vl_domiciliation","");
$vl_etablissement=fa_recup_param("vl_etablissement","");
$vl_guichet=fa_recup_param("vl_guichet","");
$vl_compte=fa_recup_param("vl_compte","");
$vl_cle=fa_recup_param("vl_cle","");
$vl_type_ecart=intval(fa_recup_param("vl_type_ecart",""));
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_etat=intval(fa_recup_param("vl_etat",""));
$vl_nombre_rib=intval(fa_recup_param('vl_nombre_rib',1));
$vl_act_cleunik=intval(fa_recup_param('vl_act_cleunik',1));
switch (TRUE) {
	case $vf_c_action=="annuler_reglement":	//	annuler un règlement
		$vf_c_retour="";
		$deb_trans=_graal_requete_bd("START TRANSACTION;");
		$sql_req="Select f1.montant_paye,f2.echeance_cleunik from $fichier_01 f1 left join $fichier_02 f2 using(reglement_cleunik) where f1.reglement_cleunik=$vl_reglement_cleunik;";
		$result = _graal_requete_bd($sql_req);
		while ($row = mysql_fetch_assoc($result)){				
			$montant_paye=fa_nn_zero($row['montant_paye']);
			$echeance_cleunik=fa_nn($row['echeance_cleunik']);
			$sql_req = "UPDATE $fichier set montant_paye=COALESCE(montant_paye,0)-$montant_paye,etat=1 WHERE echeance_cleunik =$echeance_cleunik";
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.="-3|$sql_req";}
		}
		_graal_libere_requete_bd($result);
		$sql_req = "delete from $fichier_01 where reglement_cleunik=$vl_reglement_cleunik;";
    	$vf_c_echo=_graal_exec_requete($sql_req);
		if($vf_c_echo!='ok') {$vf_c_retour.="-2|$sql_req".EOL;}
		if (trim($vf_c_retour)=="") {
        	$vf_c_echo="ok";
        	_graal_requete_bd("COMMIT;");
      	} else {
       		$vf_c_echo=-1;
			$vf_c_echo=$vf_c_retour;
        	_graal_requete_bd("ROLLBACK;");
      	}	
		break;
	case $vf_c_action=="5"://	1 chèque une facture client
	case $vf_c_action=="8"://  Réglement client 1 virement/traite/LCR -> une facture
	case $vf_c_action=="C8"://  Réglement client 1 virement/traite/LCR -> une commande client
	case $vf_c_action=="12"://	1 chèque une facture fournisseur
	case $vf_c_action=="15"://  Réglement fournisseur 1 virement/traite/LCR -> une facture
		
	switch ($vf_c_action){
		case '5':
		case '8':
		case 'C8':
			$fichier_01="_treso_reglement_cli";
			$fichier_02="_treso_reglement_cli_detail";
			break;
		case '12':
		case '15':
			$fichier_01="_treso_reglement_fou";
			$fichier_02="_treso_reglement_fou_detail";
			break;
		}
		$vl_reglement_cleunik=_graal_requete_max("reglement_cleunik","$fichier_01");
		$sql_req = "INSERT INTO $fichier_01 set reglement_cleunik='$vl_reglement_cleunik',journal_cleunik=$vl_journal_cleunik,pc_cleunik=$vl_pc_cleunik,mode_paiement=$vl_mode_paiement";
		$sql_req.=",piece='$vl_piece',ref_piece='$vl_ref_piece',dateheurecreation=now(),dateheurereglemen='$vl_dateheurereglemen',montant_paye=$vl_montant_paye";
		$sql_req.=",montant_pointe=$vl_montant_pointe,devise_paye=$vl_devise_paye,coef=$vl_coef,acompte=$vl_acompte,transfert=$vl_transfert,impaye=$vl_impaye";
		$sql_req.=",remboursement=$vl_remboursement,option_remise=$vl_option_remise,accepte=$vl_accepte,banque='$vl_banque',domiciliation='$vl_domiciliation',etablissement='$vl_etablissement'";
		$sql_req.=",guichet='$vl_guichet',compte='$vl_compte',cle='$vl_cle',type_ecart=$vl_type_ecart,blocnotebrut='$vl_blocnotebrut';";
    $vf_c_echo=_graal_exec_requete($sql_req);
    //echo $sql_req;
		$sql_req = "INSERT INTO $fichier_02 set reglement_cleunik=$vl_reglement_cleunik,echeance_cleunik=$vl_echeance_cleunik,pourcentage_paye=100";
		$sql_req.=",montant_paye=$vl_montant_paye,montant_pointe=$vl_montant_pointe,devise_paye=$vl_devise_paye,coef=$vl_coef";
    $vf_c_echo=_graal_exec_requete($sql_req);
    //echo $sql_req;
		$sql_req = "UPDATE _echeancier set date_paiement='$vl_dateheurereglemen',montant_paye=COALESCE(montant_paye,0)+$vl_montant_paye,devise_paye=$vl_devise_paye,etat=$vl_etat WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    //echo $sql_req;
		if ($vl_nombre_rib==0){
			$vl_rib_cleunik=_graal_requete_max("rib_cleunik","_act_rib");
    	$sql_req = "INSERT INTO _act_rib set rib_cleunik=$vl_rib_cleunik,domiciliation='$vl_domiciliation',blocnotebrut='Créé automatiquement par saisie de réglement',act_cleunik=$vl_act_cleunik,principal=1;";
    	$vf_c_echo=_graal_exec_requete($sql_req);
    	if($vf_c_echo=='ok') {$vf_c_echo="ok";}  else {$vf_c_echo='-1-Ce RIB existe déjà pour cet acteur.';}
		} else {
	    if($vf_c_echo=='ok') {$vf_c_echo="ok";} else {$vf_c_echo=-1;}			
		}
    break;
	
    
    
    case $vf_c_action=="7"://	1 chèque n factures client
	case $vf_c_action=="10"://  Réglement client 1 virement/traite/LCR -> n factures
	case $vf_c_action=="14"://	1 chèque n factures fournisseur
	case $vf_c_action=="17"://  Réglement fournisseur 1 virement/traite/LCR -> n factures	
		switch ($vf_c_action){
		case '7':
		case '10':
			$fichier_01="_treso_reglement_cli";
			$fichier_02="_treso_reglement_cli_detail";
			break;
		case '14':
		case '17':
			$fichier_01="_treso_reglement_fou";
			$fichier_02="_treso_reglement_fou_detail";
			break;
		}
		
			//	liste de clés pour panier échéancier
			$sql_condition_echeancier="";
	        $vl_t_listecles=fa_recup_param("vf_t_panier_echeancier",'');
	        $vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
	        $vl_e_i=-1;
	        $vl_echeance_cleunik="";
	        foreach($vl_t_listecles as $vl_raf) {
	          $vl_e_i++;
	          $vl_echeance_cleunik.=$vl_t_listecles[$vl_e_i].',';
	        }
	        if ($vl_echeance_cleunik!="") {
	          $vl_echeance_cleunik=substr($vl_echeance_cleunik, 0, -1);
	          $sql_condition_echeancier=" where a1.echeance_cleunik IN($vl_echeance_cleunik)";
	        }
	        unset($vl_t_listecles,$vl_raf);
			
		$sql_req=$sql_req_base.$sql_req_cli.$sql_condition_echeancier.$sql_condition.$sql_condition_date_fac;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base_avocli.$sql_req_avocli.$sql_condition_echeancier.$sql_condition.$sql_condition_date_avo;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base.$sql_req_fou.$sql_condition_echeancier.$sql_condition.$sql_condition_date_fac;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base_avofou.$sql_req_avofou.$sql_condition_echeancier.$sql_condition.$sql_condition_date_avo;
		$vf_c_retour="";
		//die($sql_req);
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
		$result = _graal_requete_bd($sql_req);
		$nb_dec=2;
		$vl_reglement_cleunik=-1;
		while ($row = mysql_fetch_assoc($result)){				
			$echeance_cleunik=fa_nn($row['echeance_cleunik']);
			$pc_cleunik=fa_nn($row['pc_cleunik']);
			$mode_paiement=fa_nn($row['mode_paiement']);
			$montant_restant=fa_nn_zero($row['montant_du'])-fa_nn_zero($row['montant_paye']);
			if ($vl_reglement_cleunik==-1){
				$vl_montant_pointe=$vl_montant_paye;
				$vl_reglement_cleunik=_graal_requete_max("reglement_cleunik","$fichier_01");
				$sql_req = "INSERT INTO $fichier_01 set reglement_cleunik='$vl_reglement_cleunik',journal_cleunik=$vl_journal_cleunik,pc_cleunik=$pc_cleunik,mode_paiement=$mode_paiement";
				$sql_req.=",piece='$vl_piece',ref_piece='$vl_ref_piece',dateheurecreation=now(),dateheurereglemen='$vl_dateheurereglemen',montant_paye=$vl_montant_paye";
				$sql_req.=",montant_pointe=$vl_montant_pointe,devise_paye=$vl_devise_paye,coef=$vl_coef,acompte=$vl_acompte,transfert=$vl_transfert,impaye=$vl_impaye";
				$sql_req.=",remboursement=$vl_remboursement,option_remise=$vl_option_remise,accepte=$vl_accepte,banque='$vl_banque',domiciliation='$vl_domiciliation',etablissement='$vl_etablissement'";
				$sql_req.=",guichet='$vl_guichet',compte='$vl_compte',cle='$vl_cle',type_ecart=$vl_type_ecart,blocnotebrut='$vl_blocnotebrut';";
		    	$vf_c_echo=_graal_exec_requete($sql_req);
				if($vf_c_echo!='ok') {$vf_c_retour.="-1";}
				//echo $sql_req.EOL;
			}			
			$sql_req = "INSERT INTO $fichier_02 set reglement_cleunik=$vl_reglement_cleunik,echeance_cleunik=$echeance_cleunik,pourcentage_paye=100";
			$sql_req.=",montant_paye=$montant_restant,montant_pointe=$montant_restant,devise_paye=$vl_devise_paye,coef=$vl_coef";
	    $vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.="-2".EOL.$sql_req.EOL;}
			$sql_req = "UPDATE _echeancier set date_paiement='$vl_dateheurereglemen',montant_paye=montant_paye+$montant_restant,devise_paye=$vl_devise_paye,etat=$vl_etat WHERE echeance_cleunik =$echeance_cleunik";
	    $vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.="-3";}
		}
		_graal_libere_requete_bd($result);
		if (trim($vf_c_retour)=="") {
        $vf_c_echo="ok";
        _graal_requete_bd("COMMIT;");
      } else {
        $vf_c_echo=-1;
				$vf_c_echo=$vf_c_retour;
        _graal_requete_bd("ROLLBACK;");
      }	
    break;		
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _echeancier WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_echeance_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _echeancier set commercial_cleunik='$vl_commercial_cleunik',pc_cleunik='$vl_pc_cleunik',noligne='$vl_noligne',date_paiement='$vl_date_paiement',date_echeance='$vl_date_echeance',libelle='$vl_libelle',montant_du='$vl_montant_du',montant_paye='$vl_montant_paye',devise_du='$vl_devise_du',devise_paye='$vl_devise_paye',taux_de_change='$vl_taux_de_change',mode_paiement='$vl_mode_paiement',blocnotebrut='$vl_blocnotebrut',dateheurecreation='$vl_dateheurecreation',dateheuremodif='$vl_dateheuremodif',etat='$vl_etat' WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_echeance_cleunik;} else {$vf_c_echo=-1;}
    break;
	case $vf_c_action=="solder":
    $sql_req = "UPDATE _echeancier set blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),etat=6 WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="ok";} else {$vf_c_echo=-1;}
    break;	
	case $vf_c_action=="kilometres_solder":
		$vl_t_echeance=fa_recup_param("vl_t_echeance","");
		$vl_t_echeance=unserialize(stripslashes($vl_t_echeance));
		$vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_echeance as $vl_raf) {
      $vl_e_i++;
      $vl_echeance_cleunik=$vl_t_echeance[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_echeance_cleunik";} else {$sql_condition.= ",$vl_echeance_cleunik";};
    }
    $sql_req = "UPDATE _echeancier set blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),etat=6 WHERE echeance_cleunik in ($sql_condition)";
    $vf_c_echo=_graal_exec_requete_debug($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="ok";} else {$vf_c_echo=-1;}
    break;			
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
