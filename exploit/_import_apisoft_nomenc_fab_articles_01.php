<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
define('EOL', "\r\n");
set_time_limit(6000);
echo(date("D M j G:i:s T Y").EOL);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$pere_cod=array();$pere_cle=array();$fils_cod=array();$fils_cle=array();
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeNomenc) from $vl_c_base_origine.lignenomenclature)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($pere_cod, $row['code']);
  array_push ($pere_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);  
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeCompo) from $vl_c_base_origine.lignenomenclature)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($fils_cod, $row['code']);
  array_push ($fils_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);  
$sql_req = "SELECT CodeNomenc as `CodeNomenc`,CodeCompo as `CodeCompo`,Quantite as `Quantite`,NumeroLigne as `NumeroLigne`,NombreDec as `NombreDec`,Description as `Description` FROM $vl_c_base_origine.lignenomenclature where CodeNomenc in (select code from $vl_c_base_destination._article) and CodeCompo in (select code from $vl_c_base_destination._article) order by CodeNomenc;";
$result=_graal_requete_bd($sql_req);
$o_nom=new _graal_import();
$o_nom->req="INSERT INTO $vl_c_base_destination._nomenclatures_fab (art_cleunik_pere,art_cleunik_fils,noligne,quantite,nb_decimales_qte,blocnotebrut) VALUES ";
$sql_req_02="";
$i=0;$b=500;
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_trouve=array_search($row['CodeNomenc'], $pere_cod);if ($vl_e_trouve===false) {$art_cleunik_pere=0;} else {$art_cleunik_pere=$pere_cle[$vl_e_trouve];}
  if ($art_cleunik_pere!=0) {
    $vl_e_trouve=array_search($row['CodeCompo'], $fils_cod);if ($vl_e_trouve===false) {$art_cleunik_fils=0;} else {$art_cleunik_fils=$fils_cle[$vl_e_trouve];}
    if ($art_cleunik_fils!=0) {
      $i++;
      $o_nom->dat.="($art_cleunik_pere,$art_cleunik_fils,".$row['NumeroLigne'].",".$row['Quantite'].",".$row['NombreDec'].",'".addslashes($row['Description'])."'),";
    }
  }
  if ($i % $b==0){
    $o_nom->execute();
  }
}
$o_nom->execute();
_graal_libere_requete_bd($result);
//  a priori, tous les repris on la gestion de la fabrication
//  on enleve la gestion de la fabrication pour ceux qui ne sont pas du tout concernés par les nomenclatures 
$sql_maj="update _article set types_gestion=types_gestion-8 where art_cleunik not in (select distinct(art_cleunik_pere) from _nomenclatures_fab union select distinct(art_cleunik_fils) from _nomenclatures_fab)";
_graal_exec_requete($sql_maj);
$sql_req="select art_cleunik FROM _article where _article.types_gestion & 8;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $art_cleunik=fa_ent_xml($row['art_cleunik']);
  $sql_maj="replace _art_fabs set art_cleunik=$art_cleunik,multiple_base=1;";
  _graal_exec_requete($sql_maj);
}    
_graal_libere_requete_bd($result);

_graal_ferme_connexion();
echo($i.' nomenclatures ajoutées'.EOL);
echo(date("D M j G:i:s T Y").EOL);
?>
