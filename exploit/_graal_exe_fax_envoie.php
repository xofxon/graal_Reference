<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
require_once('tcpdf/tcpdf.php');
require_once("PHPMailer/class.phpmailer.php");
include("_graal_fonctions_cryptage.php");
include("_graal_fonctions_documents.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$eol="\n";
$sautligne="\n";
$sep_ret='|';
define('EOL', "\r\n");
$vl_e_compte=intval(fa_recup_param('vl_e_compte','0'));
$vl_e_intel_cleunik=intval(fa_recup_param('vl_e_intel_cleunik','0'));
$vl_c_type_fax=fa_recup_param('vl_c_type_fax','');
$vl_c_message=fa_recup_telquel('vl_c_message','');
$vl_c_sujet=fa_recup_param('vl_c_sujet','');
$vs_mesid=fa_recup_session('vs_mesid','xsoftware');
if ($vl_e_intel_cleunik!=0){
  $sql_req="SELECT concat_ws(' ',prenom,patronyme) as qui,_act_interlo_fax.intel_05 as nofax,_act_interlo_fax.int_cleunik as int_cleunik,_act_interlo.act_cleunik as act_cleunik FROM _act_interlo_fax,_act_interlo where _act_interlo.int_cleunik=_act_interlo_fax.int_cleunik and _act_interlo_fax.intel_cleunik=$vl_e_intel_cleunik;"; 
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_e_int_cleunik=$row['int_cleunik'];
  $vl_e_act_cleunik=$row['act_cleunik'];
  $vl_c_qui=fa_ent_xml($row['qui']);
  $vl_c_nofax=$row['nofax'];
  _graal_libere_requete_bd($result);
}
$vl_c_nofax=trim($vl_c_nofax);
$sql_req = "SELECT compte AS compte FROM _uti_cpt_bal where uticptbal_cleunik=$vl_e_compte";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
$vl_c_id=$vl_c_xml->id[0]->attributes();
$vl_c_qualite=$vl_c_xml->qualite[0]->attributes();
$vl_c_type_compte=$vl_c_xml->type_compte[0]->attributes();
$vl_c_motdepasse=$vl_c_xml->motdepasse[0]->attributes();
$vl_c_adresse_cr_fax=$vl_c_xml->adresse_cr_fax[0]->attributes();
switch ($vl_c_qualite){
	case 1 :$vl_c_qualite_clair="normal";break;
	case 2 :$vl_c_qualite_clair="hight";break;
	case 3 :$vl_c_qualite_clair="best";break;
	default :$vl_c_qualite_clair="normal";break;
}
$vl_c_destinataire="$vl_c_nofax@ecofax.fr";
//$vl_c_destinataire="christophe.charron@gmail.com";
$vl_c_corpus="password:$vl_c_motdepasse".EOL."quality:$vl_c_qualite_clair".EOL;

$choix_cleunik_action=-110128;	//	Envoi de fax
$statut_action=-23;
$choix_cleunik_destinataire=-110433;	//	Destinataire de fax
$vl_c_action_uuid=_graal_requete_uuid();


switch ($vl_c_type_fax){
	case "texte":
		$vl_c_uuid=_graal_requete_uuid();
		$nom_fichier="fax_tx".$vl_c_uuid.".pdf";
		$path_pj="mail/$nom_fichier";
		// Confection du pdf
		$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
		// set document information
		$pdf->SetCreator(PDF_CREATOR);
		//set margins
		$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
		//set auto page breaks
		$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
		//set image scale factor
		$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO); 
		//initialize document
		$pdf->AliasNbPages();
		$pdf->setPrintHeader(false);
		$pdf->setPrintFooter(false);  //  Définir ce que l'on mettra dans le pied
		// add a page
		$pdf->AddPage();
		$length = $pdf->GetStringWidth( $vl_c_message );
		$pdf->MultiCell($length, 4, $vl_c_message);
		$pdf->Output("$path_pj",'F');
		$mime=fa_mime_type_buffer(file_get_contents($path_pj));
		unset($vl_c_contenupdf);
		unset($pdf);
		// enregistrement du document
		$vf_e_doc_cleunik=0;
		$hash=hash_file('sha1', $path_pj);
		$sql_req = "select doc_cleunik as cleunik FROM _documents WHERE hash = '$hash'";
		if ($res = _graal_requete_bd($sql_req)) {
		  $ligne = mysql_fetch_row($res);
		  $vf_e_doc_cleunik=$ligne[0];
		  _graal_libere_requete_bd($res);
		}
		if ($vf_e_doc_cleunik==0) {	
			$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
			$typedoc=3;   //  On va considéré comme un document "classique" (à voir les effets de bord ??)
			$nom_fichier=addslashes($nom_fichier);
			$size=filesize($path_pj);
			$vf_c_retour=fa_insere_document($vf_e_doc_cleunik,$nom_fichier,$typedoc,$size,$path_pj,"","","","","","","");	
		}
		$mail = new PHPmailer();
		$mail->CharSet = 'utf-8';
		$mail->IsSMTP();
		$mail->IsHTML(false);
		//$mail->Host='christophe-charron.org';	//	Plante ... Pourquoi ?
		$mail->From="$vl_c_adresse_cr_fax";
		//$mail->AddCC("techos@christophe-charron.org","Service Technique");	//	On envoie une copie au destinataire de réponse !!!!!!!!!!!!!!!!!!!! A SUPPRIMER EN PROD ON PASSE LE MOT DE PASSE 
		$mail->AddAddress("$vl_c_destinataire");
		$mail->Subject="$vl_c_id";
		$mail->Body="$vl_c_corpus";
		$mail->AddAttachment("$path_pj","$nom_fichier","base64",$mime);
		if(!$mail->Send()){
		  echo $mail->ErrorInfo; 
		}
		else{	  
		  echo 'Fax envoyé avec succès. ';
		}
		$mail->SmtpClose();
		unset($mail);
		
		$datas_vrac="";
		$datas_vrac.=fa_xcree_entete_xml();
		$datas_vrac.='<parametres>';
		$datas_vrac.='<int_destinataires data="'.$vl_e_int_cleunik.'"/>';
		$datas_vrac.='<nom_cou_destinataires data="'.fa_ent_xml($vl_c_qui).'"/>';
		$datas_vrac.='<pj_nombre data="1"/>';
		$datas_vrac.='<nom_pj data="'.fa_ent_xml($nom_fichier).'"/>';
		$datas_vrac.='<cleunik_pj data="'.fa_ent_xml($vf_e_doc_cleunik).'"/>';
		$datas_vrac.='<intel_cleunik data="'.fa_ent_xml($vl_e_intel_cleunik).'"/>';
		$datas_vrac.='<int_quality data="'.$vl_c_qualite.'"/>';
		$datas_vrac.='</parametres>';
		$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
		$sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=$choix_cleunik_action,dateheurecreation=now(),dateheuredebut=now(),c_uuid='$vl_c_action_uuid',action_type=1,sujet='$vl_c_sujet',statut=$statut_action;";
		if(_graal_exec_requete($sql_req)=='ok') {
			//  On rattache la pièce jointe à l'action
			$sql_req_01 = "INSERT INTO _documents_rattachement set doc_cleunik=".$vf_e_doc_cleunik.",rat_cleunik=$vl_action_cleunik,portee=$vl_e_faxfax;";
			_graal_exec_requete($sql_req_01);
			//  On rattache l'interlocuteur, destinataire du fax
			$sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_e_int_cleunik,act_cleunik=$vl_e_act_cleunik,choix_cleunik=$choix_cleunik_destinataire,portee=$vl_e_interl,principal=2;";
			_graal_exec_requete($sql_req_01);
			//  On rattache l'utilisateur, émetteur du fax
			$vl_e_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  		$vl_e_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
			$sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_e_int_cleunik,act_cleunik=$vl_e_act_cleunik,choix_cleunik=-110432,portee=$vl_e_interl,principal=2;";
			_graal_exec_requete($sql_req_01);
			$sql_req="INSERT INTO _fax_en set action_cleunik=$vl_action_cleunik,sujet='$vl_c_sujet',destinataires='$vl_e_int_cleunik',datas_vrac='$datas_vrac',mel_id='$vl_c_action_uuid';";
			_graal_exec_requete($sql_req);
		}
		break;
	case "doc":
		$vl_c_var=fa_recup_param('var','vs_tempo_fax_01');   //  Tableau des cleunik des pièces jointes
    	$vl_t_pj_cleunik=fa_recup_session("$vl_c_var",'');
    	unset($_SESSION["$var"]);
		$vl_e_i=-1;
		foreach($vl_t_pj_cleunik as $vl_raf) {
			$vl_e_i++;
			$vl_tc_liste_pj_cleunik[$vl_e_i]=$vl_t_pj_cleunik[$vl_e_i];
			$sql_req = "select document as fax,emplacement as emplacement FROM _documents WHERE doc_cleunik=$vl_tc_liste_pj_cleunik[$vl_e_i];";
			$result = _graal_requete_bd($sql_req);
			$row = mysql_fetch_assoc($result);
			$path_pj="mail/fax_pj".$row['emplacement'];
			$nom_fichier=$row['emplacement'];
			$handle_file=fopen($path_pj, 'wb');
			fwrite($handle_file, $row['fax']);
			fclose($handle_file);
			$mime=fa_mime_type_buffer($row['fax']);
			_graal_libere_requete_bd($result);
			$mail = new PHPmailer();
			$mail->CharSet = 'utf-8';
			$mail->IsSMTP();
			$mail->IsHTML(false);
			$mail->AddCustomHeader('X-Mailer: XsOFtware Logiciel de gestion en ligne pour les TPE');
			$mail->AddCustomHeader("Message-ID: $vl_c_action_uuid-Fax-$vs_mesid");
			//$mail->Host='christophe-charron.org';	//	Plante ... Pourquoi ?
			$mail->From="$vl_c_adresse_cr_fax";
			//$mail->AddCC("techos@christophe-charron.org","Service Technique");	//	On envoie une copie au destinataire de réponse !!!!!!!!!!!!!!!!!!!! A SUPPRIMER EN PROD ON PASSE LE MOT DE PASSE 
			$mail->AddAddress("$vl_c_destinataire");
			$mail->Subject="$vl_c_id";
			$mail->Body="$vl_c_corpus";
			$mail->AddAttachment("$path_pj",$nom_fichier,"base64",$mime);
			if(!$mail->Send()){
			  echo $mail->ErrorInfo; 
			}
			else{	  
			  echo 'Fax envoyé avec succès. ';
			}
			$mail->SmtpClose();
			unset($mail);
			
			$datas_vrac="";
			$datas_vrac.=fa_xcree_entete_xml();
			$datas_vrac.='<parametres>';
			$datas_vrac.='<int_destinataires data="'.$vl_e_int_cleunik.'"/>';
			$datas_vrac.='<nom_cou_destinataires data="'.fa_ent_xml($vl_c_qui).'"/>';
			$datas_vrac.='<pj_nombre data="1"/>';
			$datas_vrac.='<nom_pj data="'.fa_ent_xml($nom_fichier).'"/>';
			$datas_vrac.='<cleunik_pj data="'.fa_ent_xml($vl_tc_liste_pj_cleunik[$vl_e_i]).'"/>';
			$datas_vrac.='<intel_cleunik data="'.fa_ent_xml($vl_e_intel_cleunik).'"/>';
			$datas_vrac.='<int_quality data="'.$vl_c_qualite.'"/>';
			$datas_vrac.='</parametres>';
			$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
			$sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=$choix_cleunik_action,dateheurecreation=now(),dateheuredebut=now(),c_uuid='$vl_c_action_uuid',action_type=1,sujet='$vl_c_sujet',statut=$statut_action;";
			if(_graal_exec_requete($sql_req)=='ok') {
				//  On rattache la pièce jointe à l'action
				$sql_req_01 = "INSERT INTO _documents_rattachement set doc_cleunik=".$vl_tc_liste_pj_cleunik[$vl_e_i].",rat_cleunik=$vl_action_cleunik,portee=$vl_e_faxfax;";
				_graal_exec_requete($sql_req_01);
				//  On rattache l'interlocuteur, destinataire du fax
				$sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_e_int_cleunik,act_cleunik=$vl_e_act_cleunik,choix_cleunik=$choix_cleunik_destinataire,portee=$vl_e_interl,principal=2;";
				_graal_exec_requete($sql_req_01);
				//  On rattache l'utilisateur, émetteur du fax
				$vl_e_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
		  		$vl_e_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
				$sql_req_01="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_e_int_cleunik,act_cleunik=$vl_e_act_cleunik,choix_cleunik=-110432,portee=$vl_e_interl,principal=2;";
				_graal_exec_requete($sql_req_01);
				$sql_req="INSERT INTO _fax_en set action_cleunik=$vl_action_cleunik,sujet='$vl_c_sujet',destinataires='$vl_e_int_cleunik',datas_vrac='$datas_vrac',mel_id='$vl_c_action_uuid';";
				_graal_exec_requete($sql_req);
			}
		}  
		break;
}
?>
