<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
/*
le 8 septembre 2008 
  typedoc    1 -> Liens, 
             2 -> Notes,
             3 -> Documents,
             4 -> Dossier,
             5 -> courriels envoyés,
             6 -> modèles de courriels texte,
             7 -> Flux RSS,
             8 -> requêtes personnelles,
             9 -> images des articles, logos de l'entreprise
            10 -> modèles de courriels HTML,
            11 -> modèles de notes,
            12 -> modèles de notification de lecture,
            13 -> pièces jointes,
            14 -> menus personalisés
           101 -> modèles textes entêtes offres clients,
           102 -> modèles textes pied offres clients,
           111 -> modèles textes entêtes commandes clients,
           112 -> modèles textes pied commandes clients,
           121 -> modèles textes entêtes livraison clients,
           122 -> modèles textes pied livraison clients,
           131 -> modèles textes entêtes facture clients,
           132 -> modèles textes pied facture clients,
           141 -> modèles textes entêtes demandes fournisseur,
           142 -> modèles textes pied demandes fournisseur,
           151 -> modèles textes entêtes commandes fournisseur,
           152 -> modèles textes pied commandes fournisseur,
           900 -> Conditions générales de vente
           901 -> Bloc de désinscription pour emailing html
           902 -> Bloc de désinscription pour emailing texte
*/           
$vl_e_typedoc=fa_recup_param('vf_e_typedoc','0');
$vf_c_argfen00=fa_recup_param('lesquels','');
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
switch ($vl_e_typedoc) {
  case 11:
    $sql_req="SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.dateheurecreation AS dateheurecreation,_documents.dateheuremodif AS dateheuremodif,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,'' AS prenom,'' AS patronyme FROM _documents WHERE _documents.doc_cleunik =-1 union ";break;
    break;
  case 101:
  case 102:
  case 111:
  case 112:      
  case 121:
  case 122:
	case 123:
	case 124:
  case 131:
  case 132:      
  case 141:
  case 142:
  case 151:
  case 152:
	case 900:
	case 901:
	case 902:
		$sql_req="SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.dateheurecreation AS dateheurecreation,_documents.dateheuremodif AS dateheuremodif,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,'' AS prenom,'' AS patronyme FROM _documents WHERE _documents.typedoc = $vl_e_typedoc;";break;
    break;
  default:
    break;
}
switch (TRUE) {
 case $vf_c_argfen00 == "menot": 
    $sql_req.="SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.dateheurecreation AS dateheurecreation,_documents.dateheuremodif AS dateheuremodif,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,'' AS prenom,'' AS patronyme FROM _documents	WHERE _documents.doc_cleunik in(SELECT distinct(_documents.doc_cleunik) AS doc_cleunik FROM _droits_doc, _documents	WHERE _documents.doc_cleunik = _droits_doc.doc_cleunik AND _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.typedoc = $vl_e_typedoc) order by doc_cleunik desc;";
    break;
 case $vf_c_argfen00 == "nosnot": 
    $sql_req.="SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.dateheurecreation AS dateheurecreation,_documents.dateheuremodif AS dateheuremodif,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_utilisateur.prenom AS prenom,_utilisateur.patronyme AS patronyme FROM _utilisateur, _droits_doc, _documents	WHERE _utilisateur.uti_cleunik = _droits_doc.uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc = $vl_e_typedoc and (select count(*) from _droits_doc where _documents.doc_cleunik = _droits_doc.doc_cleunik and _droits_doc.uti_cleunik=$vl_e_uti_cleunik) > 0 order by doc_cleunik desc;";
    break;
 case $vf_c_argfen00 == "leurnot": 
    $sql_req.="SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.dateheurecreation AS dateheurecreation,_documents.dateheuremodif AS dateheuremodif,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_utilisateur.prenom AS prenom,_utilisateur.patronyme AS patronyme FROM _utilisateur, _droits_doc, _documents	WHERE _utilisateur.uti_cleunik = _droits_doc.uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc = $vl_e_typedoc AND _droits_doc.uti_cleunik<>$vl_e_uti_cleunik and (select count(*) from _droits_doc where _documents.doc_cleunik = _droits_doc.doc_cleunik and _droits_doc.uti_cleunik=$vl_e_uti_cleunik) > 0;";
    break;
 default :
  break;
}
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
/*  
  echo('<RDF:Description>');
  echo('<row:req>'.fa_ent_xml($sql_req).'</row:req>');
  echo('</RDF:Description>'.EOL);
*/
while ($row = mysql_fetch_assoc($result)){
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:doc_cleunik NC:parseType="Integer">'.fa_ent_xml($row['doc_cleunik']).'</row:doc_cleunik>');
  echo('<row:titre>'.fa_ent_xml($row['titre']).'</row:titre>');
  echo('<row:descriptif_sommaire>'.fa_ent_xml($row['descriptif_sommaire']).'</row:descriptif_sommaire>');
  echo('<row:prenom>'.fa_ent_xml($row['prenom']).'</row:prenom>');
  echo('<row:patronyme>'.fa_ent_xml($row['patronyme']).'</row:patronyme>');
  echo('<row:dateheurecreation>'.fa_ent_xml($row['dateheurecreation']).'</row:dateheurecreation>');
  echo('<row:dateheuremodif>'.fa_ent_xml($row['dateheuremodif']).'</row:dateheuremodif>');
  echo('<row:origine>'.fa_ent_xml($row['origine']).'</row:origine>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
