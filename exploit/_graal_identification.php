<?php 
include("_graal_header_xml.inc.php");
//  Détermination du retour chariot en fonction de l'OS du serveur (Win, Mac, Linux)
if (strtoupper(substr(PHP_OS,0,3)=='WIN')) {
  $eol="\r\n";
} elseif (strtoupper(substr(PHP_OS,0,3)=='MAC')) {
  $eol="\r";
} else {
  $eol="\n";
}
$HTTP_SESSION_VARS["vs_eol"]=$eol;
switch ($_SERVER["HTTP_HOST"]){
  //  Gestion htaccess
  case "demo.christophe-charron.org":
  case "baronnat.christophe-charron.org":
  case "christophe-charron.org":
  //case "localhost":
    $vl_c_id=$_SERVER["PHP_AUTH_USER"];
    $vl_c_pw=$_SERVER["PHP_AUTH_PW"];
    $vl_c_menu="Location: ./exploit/_graal_fen_menu003_00.php";
    $vl_c_mauvaismotdepasse="Location: ./exploit/pagesparticulieres/mauvaismotdepasse.php";
    $vl_c_mauvaiseidentification="Location: ./exploit/pagesparticulieres/mauvaiseidentification.php";
    break;
  //  Gestion saise de mot de passe xul
  case "localhost":
  case "poste01":
  case "famchar":
  case "demo01.christophe-charron.info":
  case "91.121.103.13":
	case "totem.xsoftware.fr":				// Sous-domaine Totem signalétique		07/11/2008
	case "legoff.xsoftware.fr":				// Sous-domaine Dominique Legoff			13/11/2008
	case "paire.xsoftware.fr":				// Sous-domaine Domaine Paire					13/11/2008
	case "xof.xsoftware.fr":					// Sous-domaine xof										13/11/2008
	case "reference.xsoftware.fr":		// Sous-domaine base de référence			13/11/2008
	case "baronnat.xsoftware.fr":			// Sous-domaine Baronnat							13/11/2008
	case "cafe.xsoftware.fr":					// Sous-domaine C-A-F-E								13/11/2008
	case "lacavedepaulette.xsoftware.fr":	// Sous-domaine LA cave de Paulette		14/11/2008
	case "test01.xsoftware.fr":						// Sous-domaine test01								14/11/2008
	
    $vl_c_id=fa_recup_param("vl_c_id","??????");
    $vl_c_pw=fa_recup_param("vl_c_pw","??????");
    $vl_c_menu="Location: ./_graal_fen_menu003_00.php";
    $vl_c_mauvaismotdepasse="Location: ./pagesparticulieres/mauvaismotdepasse.php";
    $vl_c_mauvaiseidentification="Location: ./pagesparticulieres/mauvaiseidentification.php";
    break;
  default:
		$vl_c_mauvaiseidentification="Location: ./pagesparticulieres/mauvaiseidentification.php";
		header($vl_c_mauvaiseidentification);
    break;
}
switch ($_SERVER["HTTP_HOST"]){
  case "demo.christophe-charron.org":
  case "baronnat.christophe-charron.org":
  case "christophe-charron.org":
    //  a priori impossible de se connecter aux stats d'un autre site ?? !!! (uncaught exception: Permission refusée d'appeler la méthode XMLHttpRequest.open)
    //$_SESSION["phpmyvisites_php"]="http://christophe-charron.info/Xsoftware_Analytics/phpmyvisites.php";
    //$_SESSION["phpmyvisites_js"]="js/_graal_phpmyvisites.js.php";
    $_SESSION["phpmyvisites_php"]="";
    $_SESSION["phpmyvisites_js"]="";
    break;
  case "localhost":
    $_SESSION["phpmyvisites_php"]="http://localhost/graal/phpmv2/phpmyvisites.php";
    $_SESSION["phpmyvisites_js"]="js/_graal_phpmyvisites.js.php";
    $_SESSION["phpmyvisites_php"]="";
    $_SESSION["phpmyvisites_js"]="";
    break;
  case "poste01":
    $_SESSION["phpmyvisites_php"]="http://poste01/graal/phpmv2/phpmyvisites.php";
    $_SESSION["phpmyvisites_js"]="js/_graal_phpmyvisites.js.php";
    $_SESSION["phpmyvisites_php"]="";
    $_SESSION["phpmyvisites_js"]="";
    break;
  case "famchar":
    $_SESSION["phpmyvisites_php"]="http://poste01/graal/phpmv2/phpmyvisites.php";
    $_SESSION["phpmyvisites_js"]="js/_graal_phpmyvisites.js.php";
    $_SESSION["phpmyvisites_php"]="";
    $_SESSION["phpmyvisites_js"]="";
    break;
  case "demo01.christophe-charron.info":
    $_SESSION["phpmyvisites_php"]="https://ssl.1and1.fr/demo01.christophe-charron.info/phpmv2/phpmyvisites.php";
    $_SESSION["phpmyvisites_js"]="js/_graal_phpmyvisites.js.php";
    //$_SESSION["phpmyvisites_php"]="";
    //$_SESSION["phpmyvisites_js"]="";
    break;
  default:
    $_SESSION["phpmyvisites_php"]="";
    $_SESSION["phpmyvisites_js"]="";
    break;
}
$sql_req = "SELECT uti_cleunik as uti_cleunik,prenom as prenom,patronyme as patronyme,borne_mini as borne_mini,borne_maxi as borne_maxi,langue_appli as langue,css as css,couleurfocus as couleurfocus,int_cleunik as int_cleunik,param_environ as param_environ FROM _utilisateur WHERE identifiant= '$vl_c_id' AND motdepasse=sha1('$vl_c_pw') and actif=1";
$res = _graal_requete_bd($sql_req);
if($ligne = mysql_fetch_row($res)) {
  $_SESSION["vs_uti_cleunik"]=$ligne[0];
  $_SESSION["vs_qui"]=$ligne[1];
  $_SESSION["borne_mini"]=$ligne[3];
  $_SESSION["borne_maxi"]=$ligne[4];
  $_SESSION["langue_appli"]=$ligne[5];
  $_SESSION["vs_css"]=$ligne[6];
  $_SESSION["vs_couleurfocus"]=$ligne[7];
  $_SESSION["vs_mongraal"]=$ligne[8];
  $_SESSION["vs_nomcomplet"]=$ligne[1].' '.$ligne[2];
  $_SESSION["vs_int_cleunik"]=$ligne[8];
  $_SESSION["vs_param_environ"]=$ligne[9];
  $_SESSION["vs_nb_dec_prix"]=2;  //  Nombre de décimales pour l'affichage des prix
} else {
  //  Désormais (depuis le 14 septembre 2006), on ne se connecte plus, si on ne trouve pas dans la bd le bon mot de passe
  $sql_req1=$sql_req;
  $sql_req = "SELECT uti_cleunik as uti_cleunik,prenom as prenom,patronyme as patronyme,borne_mini as borne_mini,borne_maxi as borne_maxi,langue_appli as langue FROM _utilisateur WHERE identifiant= '$vl_c_id' and actif=1";
  $res = _graal_requete_bd($sql_req);
  if($ligne = mysql_fetch_row($res)) {
    header($vl_c_mauvaismotdepasse);
  } 
  else {
    //die($sql_req1.$eol.$sql_req);
    header($vl_c_mauvaiseidentification); 
  }
}      
$vv_id_fenetre='Connexion';
$sql_cle=_graal_requete_max_particuliere("uticonnexions_cleunik","_uti_connexions");
$vl_c_infosconnexion="";
$vl_c_infosconnexion.=fa_xcree_entete_xml();
$vl_c_infosconnexion.='<parametres>';
$vl_c_infosconnexion.='<ip_brute data="'.fa_ent_xml($_SERVER["REMOTE_ADDR"]).'"/>';
$vl_c_infosconnexion.='<gethostbyadress data="'.fa_ent_xml(gethostbyaddr($_SERVER["REMOTE_ADDR"])).'"/>';
$vl_c_infosconnexion.='<navigateur data="'.fa_ent_xml($_SERVER["HTTP_USER_AGENT"]).'"/>';
$vl_c_infosconnexion.='<typedeserveur data="'.fa_ent_xml($_SERVER["SERVER_SIGNATURE"]).'"/>';
//$vl_c_infosconnexion.='<origine data="'.fa_ent_xml($_SERVER["HTTP_REFERER"]).'"/>';
$vl_c_infosconnexion.='</parametres>';
$sql_req = "INSERT INTO _uti_connexions set uti_cleunik=". $_SESSION['vs_uti_cleunik'].",uticonnexions_cleunik=$sql_cle,dateheuredebutconnexion = now(),infos_ip = '".gethostbyaddr($_SERVER["REMOTE_ADDR"])."',infos_connexion='".$vl_c_infosconnexion."',infos_fenetres='".$vv_id_fenetre."'";
 $res = _graal_requete_bd($sql_req);
$vl_e_dico=3;
$vl_e_langue=$_SESSION["langue_appli"];
$vl_e_uti_cleunik=0;  //  pour l'instant on ne gère pas les dictionnaires personnels
$sql_req = "SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif FROM _objets,_objets_libelle WHERE _objets.fen_cleunik=_objets_libelle.fen_cleunik and _objets_libelle.langue=$vl_e_langue and _objets.type_objet=$vl_e_dico and _objets_libelle.uti_cleunik=$vl_e_uti_cleunik ORDER BY titre";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $_SESSION[$row['titre']]=$row['descriptif'];
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
header($vl_c_menu);
?>
