<?php
define('EOL', "\r\n");
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
require("_graal_fonctions_mail.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
include("_graal_fonctions_documents.php");
$sess_id=session_id();
$vl_courriel_brut_cleunik=intval(fa_recup_param('vl_courriel_brut_cleunik','0'));
$vl_genre=intval(fa_recup_param('vl_genre','telecharger'));
$vl_numero=intval(fa_recup_param('vl_numero','0'));
define('EOL', "\r\n");
$sql_req="select courriel,hash,action_cleunik from _courriel_recus_brut where courriel_brut_cleunik=$vl_courriel_brut_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result); 
$action_cleunik=$row['action_cleunik'];
if (fa_cherche_si_pj_autorisee($action_cleunik)==false) {fa_redirige("courriel_interdit");}
$mime=new mime_parser_class;
$mime->mbox = 0;
$mime->decode_bodies = 1;
$mime->ignore_syntax_errors = 1;
//  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
$path="mail/".$sess_id."_".$row['hash'];
$handle_file=fopen($path, 'wb');
fwrite($handle_file, $row['courriel']);
fclose($handle_file);
$parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$row['hash'],'sess_id'=>$sess_id,);
_graal_libere_requete_bd($result);
$vl_c_erreur="";
$treeitem="";
if(!$mime->Decode($parameters, $decoded)) {
	$vl_c_erreur='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position.EOL;
}
else {
	$index=0;
	$result = fa_arrayFromEmailParts($decoded[0]['Parts'],$index);
	switch ($vl_genre) {
		case "telecharger":
			header("Content-disposition: attachment; filename=\"".$result[$vl_numero]['originalFileName']."\"");
			$vl_c_content_type_defaut="application/force-download";
			$vl_c_content_type_defaut=$result[$vl_numero]['type'];
			header("Content-Type: $vl_c_content_type_defaut");
			echo file_get_contents($result[$vl_numero]['file']);			
			break;
		case "voir":
			$ext = substr(strtolower(strrchr(basename($result[$vl_numero]), ".")), 1);
			/*
			 * liste exhaustive des type OOo
			 * http://framework.openoffice.org/documentation/mimetypes/mimetypes.html
			 * 
			 */
			switch ($ext) {
				case "png":
					header('Content-type: image/png');
					echo file_get_contents($result[$vl_numero]['file']);
					break;
				case "jpg":
				case "jpeg":
				case "jpe":
					header('Content-type: image/jpeg');
					echo file_get_contents($result[$vl_numero]['file']);
					break;
				case "tiff":
				case "tif":
					header('Content-type: image/tiff');
					echo file_get_contents($result[$vl_numero]['file']);
					break;		
				case "pdf":
					header('Content-type: application/pdf');
					echo file_get_contents($result[$vl_numero]['file']);
					break;		
				case "odp";
					header('Content-Type: application/vnd.oasis.opendocument.presentation');
					echo file_get_contents($result[$vl_numero]['file']);
					break;
				case "odt";
					header('Content-Type: application/vnd.oasis.opendocument.text');
					echo file_get_contents($result[$vl_numero]['file']);
					break;
				case "ods";
					header('Content-Type: application/vnd.oasis.opendocument.spreadsheet');
					echo file_get_contents($result[$vl_numero]['file']);
					break;		
				case "doc";
					header('Content-Type: application/msword');
					echo file_get_contents($result[$vl_numero]['file']);
					break;		
				case "xls";
					header('Content-Type: application/vnd.ms-excel');
					echo file_get_contents($result[$vl_numero]['file']);
					break;		
				case "ppt";
					header('Content-Type: application/vnd.ms-powerpoint');
					echo file_get_contents($result[$vl_numero]['file']);
					break;
				case "avi";
					header('Content-Type: video/x-msvideo');
					echo file_get_contents($result[$vl_numero]['file']);
					break;
				default:
					echo "Pas visualisable ... $result[$vl_numero] extension $ext";
					break;			
			break;
		}
	}
}
?>
