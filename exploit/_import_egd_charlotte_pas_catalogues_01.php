<?php
include("_graal_header_txt.inc.php");
/*
 * http://localhost/graal/exploit/_import_egd_charlotte_pas_catalogues_01.php?vl_e_critere_cleunik_origine=10013&vl_e_critere_cleunik_catalog=10014&vl_e_choix_cleunik_origine=10002068&vl_e_choix_cleunik_catalog=10002067
 * https://egdiffusion.xsoftware.fr/2c760b07-4c7a-402f-b015-d2ca450b9b0c/graal/exploit/_import_egd_charlotte_pas_catalogues_01.php?vl_e_critere_cleunik_origine=10015&vl_e_critere_cleunik_catalog=10014&vl_e_choix_cleunik_origine=10001958&vl_e_choix_cleunik_catalog=10001957
 */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','egdiffusion');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_egdiffusion');
$vf_e_typeacteur=110001;
$devise=122047;
$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_fax_defaut=intval(fa_recup_param('vl_e_fax_defaut','-10'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_fax_defaut=intval(fa_recup_param('vl_e_indicatif_fax_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vl_e_genre_acteur_defaut=intval(fa_recup_param('vl_e_genre_acteur_defaut','-5'));

$vl_e_critere_cleunik_origine=intval(fa_recup_param('vl_e_critere_cleunik_origine','10013'));
$vl_e_critere_cleunik_catalog=intval(fa_recup_param('vl_e_critere_cleunik_catalog','10014'));

$vl_e_choix_cleunik_origine=intval(fa_recup_param('vl_e_choix_cleunik_origine','10002068'));
$vl_e_choix_cleunik_catalog=intval(fa_recup_param('vl_e_choix_cleunik_catalog','10002067'));

$fon_cod=array();$fon_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_valeur_texte_01 as code from _choix where critere_cleunik=92"; //  On recherche les focntions
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($fon_cod, $row['code']);
  array_push ($fon_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

include("_import_class_data_km.php");
$sql_req = "SELECT * FROM $vl_c_base_origine.charlotte_pas_catalogue c  order by Champ1";
$result = _graal_requete_bd($sql_req);
$o_acteur=new _graal_import();
$o_adresses=new _graal_import();
$o_interlo=new _graal_import();
$o_choix=new _graal_import();
$o_choixinterlo=new _graal_import();
$o_web=new _graal_import();
$o_fax=new _graal_import();
$o_tel=new _graal_import();
$o_rep=new _graal_import();
$o_acteur->req="INSERT INTO $vl_c_base_destination._acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,blocnotebrut,blocnotertf,dateheuremodif,dateheurecreation,typeacteur,c_uuid,mnemotechnique,devise) VALUES ";
//  Attention, mode de règlement traité plus bas
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$o_choixinterlo->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_adresses (adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik) VALUES ";
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_fax->req="INSERT INTO $vl_c_base_destination._act_interlo_fax (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik,portable,sms) VALUES ";
$o_rep->req="INSERT INTO $vl_c_base_destination._acteurs_representants (act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_relation->req="INSERT INTO $vl_c_base_destination._acteurs_relations(act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$vf_e_act_cleunik=_graal_requete_max("act_cleunik","$vl_c_base_destination._acteurs");
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_adresses");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_fax_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_fax");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
$col_01_precedent="???&&&";
$result = _graal_requete_bd($sql_req);
//echo $sql_req.EOL;

while ($row = mysql_fetch_assoc($result)) {
//  Ajout dans la table des acteurs
	$col_01=fa_nt($row['Champ1']);
	if ($col_01!=$col_01_precedent){
 		$col_01_precedent=$col_01;
	  $vf_e_act_cleunik++;
	  $i++;
	  $codealphanum15="";
	  $raisonsoc=fa_nt($row['Champ1']);
	  $nomcommercial=fa_nt($row['Champ1']);
	  $blocnotebrut=fa_nt($row['Champ11']);
	  $blocnotertf="";
	  $typeacteur=$vf_e_typeacteur;
	  $uuid=_graal_requete_uuid();
	  $mnemotechnique="";
	  $o_acteur->dat.="($vf_e_act_cleunik,'$codealphanum15',$raisonsoc,$nomcommercial,$blocnotebrut,'$blocnotertf',now(),now(),$typeacteur,'$uuid','$mnemotechnique',$devise),";
	  //echo "acteur ($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial','$blocnotebrut','$blocnotertf',now(),now(),$typeacteur,'$uuid','$mnemotechnique',$devise),".EOL;
	  
	  
	  
	$adresse=addslashes($row['Champ4']);
	//echo "adresse $adresse".EOL;flush();
	$adresse = str_replace(CHR(13).CHR(10)," ",$adresse);          
	  $vl_c_chaine=trim($adresse.$row['Champ5'].$row['Champ6']);
	  //  On ajoute uniquement si l'adresse est un minimum renseignée
	  if ($vl_c_chaine!="") {
	  	$vl_e_cleunik_pays=60000;
	    $vf_e_adr_cleunik++;
	    $adr_complementnom="";
	    $adr_ligne1=substr($adresse,0,50);
	    $adr_ligne2=substr($adresse,50,100);
	    $adr_ligne3=substr($adresse,100,150);
	    $adr_cp=intval($row['Champ6']);
	    $adr_ville=addslashes($row['Champ5']);
	    $o_adresses->dat.="($vf_e_adr_cleunik,'',$vf_e_act_cleunik,'$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_ligne3','$adr_cp','$adr_ville',$vl_e_cleunik_pays,1),";
	  }
	  
	  $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik_origine,$vl_e_critere_cleunik_origine,$vf_e_typeacteur,0),";
	  $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik_catalog,$vl_e_critere_cleunik_catalog,$vf_e_typeacteur,0),";
	  //echo $o_choix->dat.EOL;flush();
	} else {
		echo "existe dèjà sur ligne précédente $col_01".EOL;flush();
	}
	
  
  //  Ajout dans la table des _act_interlo (Interlocuteurs des acteurs) des interlocuteurs de livraison
  $vl_c_chaine=trim($row['Champ8'].$row['Champ9'].$row['Champ10'].$row['Champ2'].$row['Champ3']);
  $vl_c_liv=$vl_c_chaine;
  //  On ajoute uniquement si l'interlocuteur de livraison est un minimum renseigné
  if ($vl_c_chaine!=""){
    $vf_e_int_cleunik++;
    $patronyme=addslashes($row['Champ3']);
    $o_interlo->dat.="($vf_e_int_cleunik,'',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
    //echo "interlo ($vf_e_int_cleunik,'',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),".EOL;flush();
  $vl_e_trouve_fon=array_search($row['Champ12'], $fon_cod);
  if ($vl_e_trouve_fon===false) {
  	$vl_e_catcompta_cleunik=-1;
  } else {
  	$vl_e_fon_cleunik=$fon_cle[$vl_e_trouve_fon];
  	$o_choixinterlo->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,$vl_e_fon_cleunik,92,$vf_e_typeacteur,0),";
  }
    
    $vl_c_chaine=trim($row['Champ2']);
    //  On ajoute uniquement si le mail de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vf_e_intweb_cleunik++;
      $refweb=addslashes($row['Champ2']);
      $uuid=_graal_requete_uuid();
      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
    }
    $vl_c_chaine=trim($row['Champ9']);
    //  On ajoute uniquement si le fax de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine); 
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_fax_cleunik++;
      $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
    }
    $vl_c_chaine=trim($row['Champ8']);
    //  On ajoute uniquement si le téléphone de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_tel_cleunik++;
      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
    }
    $vl_c_chaine=trim($row['Champ10']);
    //  On ajoute uniquement si le téléphone portable de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_tel_cleunik++;
      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut,2,2),";
    }
  }
}
//echo $o_acteur->req.$o_acteur->dat.EOL;
$retour=$o_acteur->execute();
$retour=$o_adresses->execute();
/*
echo "************".EOL;
echo $o_interlo->req.$o_interlo->dat.EOL;
echo "************".EOL;
*/
$retour=$o_interlo->execute();
/*
echo $retour.EOL;
echo "************".EOL;
echo $o_choixinterlo->req.$o_choixinterlo->dat.EOL;
*/
$o_choixinterlo->execute();

echo "************".EOL;
echo $retour.EOL;
echo"titi";
echo "************".EOL;
echo $o_choix->req.$o_choix->dat.EOL;
echo "************".EOL;

$o_choix->execute();
$o_web->execute();
$o_fax->execute();
$o_tel->execute();
$o_rep->execute();
_graal_libere_requete_bd($result);
echo("$i propects clients importés.");
?>
