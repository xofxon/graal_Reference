<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','ines_epac');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_epac');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','clients');


$vf_e_typeacteur=110006;


$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vl_b_silencieux=intval(fa_recup_param('vl_b_silencieux','1'));
$vl_c_embraye=fa_recup_param("vl_c_embraye","");
include("_import_ines_sp_array_pays.php");
include("_import_ines_sp_array_tiers.php");
//var_dump ($acteur_cod);
include("_import_ines_sp_array_tiers_contacts.php");
/*
 * Tableau des fonctions criteres 92
 */
$t01_cod=array();$t01_cle=array();$t01_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=92";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t01_cod, $row['code']);
  array_push ($t01_cle, $row['cleunik']);
  array_push ($t01_tex, $row['text']);
}
_graal_libere_requete_bd($result);
//var_dump($t01_tex);
/*
 * Tableau des civilités
 */
$t02_cod=array();$t02_cle=array();$t02_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=86";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t02_cod, $row['code']);
  array_push ($t02_cle, $row['cleunik']);
  array_push ($t02_tex, $row['text']);
}
_graal_libere_requete_bd($result);

include("_import_class_data_km.php");
$sql_req = "";
$sql_req.= " SELECT Numéro,CT_REF,CL_REF,CT_GENRE,CT_PRENOM,CT_NOM,CT_FONCTION,CT_MAIL,CT_USER1,TYPE_CLI,CT_TEL,CT_TEL_HOME,CT_GSM,CT_AD1,CT_AD2,CT_ZIP,CT_VILLE,";
$sql_req.= " CT_STATE,CT_PAYS,CT_ANNIVERSAIRE,CT_DATE,CT_REM";
$sql_req.= " FROM $vl_c_base_origine.$vl_c_fic_tiers a1";

$sql_req.= " order by 1";
//$sql_req.= " limit 10";
$result = _graal_requete_bd($sql_req);

echo $sql_req;

$o_adresses=new _graal_import();
$o_interlo=new _graal_import();
$o_web=new _graal_import();
$o_fonction=new _graal_import();
$o_tel=new _graal_import();
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_interlo_adresses (int_cleunik,adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik,prenom,blocnotebrut) VALUES ";
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik,portable,sms) VALUES ";
$o_fonction->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_interlo_adresses");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
session_write_close();
//if (1==2){
while ($row = mysql_fetch_assoc($result)) {
	$code_acteur=sprintf("%d",$row['CL_REF']);
	$code_interl=sprintf("%d",$row['CT_REF']);
	$vl_e_trouve_interl=array_search($code_interl, $int_cod);
	if ($vl_e_trouve_interl===false) {
		$vl_e_trouve_acteur=array_search($code_acteur, $acteur_cod);
		echo EOL."Cherche $code_acteur '$vl_e_trouve_acteur' interlocuteur $code_interl";flush();
		if ($vl_e_trouve_acteur!=false) {
			echo "trouve acteur ...";
			//die ("pas trouvé ".$row['Code']);
		//  Ajout dans la table des acteurs
		  //$vl_e_trouve_devise=array_search($row['Devise'], $devise_cod);if ($vl_e_trouve_devise===false) {$devise=122047;} else {$devise=$devise_cle[$vl_e_trouve_devise];}
		  
		  $i++;
		  $vf_e_act_cleunik=$acteur_cle[$vl_e_trouve_acteur];
		  $vf_e_int_cleunik=$row['Numéro'];
		  $codealphanum15=$code_interl;
		  $patronyme=fa_nt($row['CT_NOM']);
		  $prenom=fa_nt($row['CT_PRENOM']);
		  $blocnotebrut=fa_nt($row['CT_REM']);
			$val_test=fa_nn_blanc($row['CT_GENRE']);
			//echo $val_test.EOL;
		    if (trim($val_test!="")){
			    $vl_e_trouve=array_search($val_test, $t02_tex);if ($vl_e_trouve===false) {$civilite=-6;} else {$civilite=$t02_cle[$vl_e_trouve];}
		    } else {
		    	$civilite=-6;
		    }
		    $o_interlo->dat.="($vf_e_int_cleunik,'$codealphanum15',$vf_e_act_cleunik,$patronyme,2,$civilite,$prenom,$blocnotebrut),";
			$vl_e_choix_cleunik=0;
		    $val_test=fa_nn_blanc($row['CT_FONCTION']);
		    if (trim($val_test!="")){
			    $vl_e_trouve=array_search($val_test, $t01_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t01_cle[$vl_e_trouve];}
			    if ($vl_e_choix_cleunik!=0) {
			      $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,$vl_e_choix_cleunik,92,$vf_e_typeacteur,0),";
			    }
		    }
		   
			
		  $vl_c_chainefac=trim(fa_nn_blanc($row['CT_AD1']).fa_nn_blanc($row['CT_AD2']).fa_nn_blanc($row['CT_PAYS']).fa_nn_blanc($row['CT_ZIP']).fa_nn_blanc($row['CT_VILLE']));
		  //  On ajoute uniquement si l'adresse est un minimum renseignée
		  if ($vl_c_chainefac!="") {
		    $vl_e_trouve=array_search($row['CT_PAYS'], $pays_cod);if ($vl_e_trouve===false) {$vl_e_cleunik_pays=60000;} else {$vl_e_cleunik_pays=$pays_cle[$vl_e_trouve];}
		    $vf_e_adr_cleunik++;
		    $adr_complementnom="";
		    $adr_ligne1=fa_nt($row['CT_AD1']);
		    $adr_ligne2=fa_nt($row['CT_AD2']);
		    $adr_cp=fa_nt($row['CT_ZIP']);
		    $adr_ville=fa_nt($row['CT_VILLE']);
		    if ($vl_c_chainefac==$vl_c_chaineliv){
		    	$adr_typecoordonnees=3;
		    	$vl_c_chaineliv="";
		    } else {
		    	$adr_typecoordonnees=1;
		    }
		    $o_adresses->dat.="($vf_e_int_cleunik,$vf_e_adr_cleunik,'Int01',$vf_e_act_cleunik,'$adr_complementnom',$adr_ligne1,$adr_ligne2,$adr_cp,$adr_ville,$vl_e_cleunik_pays,$adr_typecoordonnees),";
		    //echo ($o_adresses->req.$o_adresses->dat);
		    //exit();
		  }
			$vl_c_chaine=trim(fa_nn_blanc($row['CT_MAIL']));
		    //  On ajoute uniquement si le mail de livraison
		    if ($vl_c_chaine!=""){
		      $vf_e_intweb_cleunik++;
		      $refweb=fa_nt($row['CT_MAIL']);
		      $uuid=_graal_requete_uuid();
		      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,$refweb,3,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
		    }
			$vl_c_chaine=trim(fa_nn_blanc($row['CT_USER1']));
		    //  On ajoute uniquement si le mail de livraison
		    if ($vl_c_chaine!=""){
		      $vf_e_intweb_cleunik++;
		      $refweb=fa_nt($row['CT_USER1']);
		      $uuid=_graal_requete_uuid();
		      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,$refweb,3,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
		    }
			$vl_c_chaine=trim(fa_nn_blanc($row['CT_TEL']));
			$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
		    //  On ajoute uniquement si le téléphone est renseigné
		    if (trim($vl_c_chaine_nette!="")){
		      $vl_c_chaine_brute=fa_nt($vl_c_chaine);
		      $vf_e_tel_cleunik++;
		      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,$vl_c_chaine_brute,'$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
		    }
			$vl_c_chaine=trim(fa_nn_blanc($row['CT_TEL_HOME']));
			$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
		    //  On ajoute uniquement si le téléphone est renseigné
		    if (trim($vl_c_chaine_nette!="")){
		      $vl_c_chaine_brute=fa_nt($vl_c_chaine);
		      $vf_e_tel_cleunik++;
		      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,$vl_c_chaine_brute,'$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
		    }
			$vl_c_chaine=trim(fa_nn_blanc($row['CT_GSM']));
			$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
		    //  On ajoute uniquement si le téléphone est renseigné
		    if (trim($vl_c_chaine_nette!="")){
		      $vl_c_chaine_brute=fa_nt($vl_c_chaine);
		      $vf_e_tel_cleunik++;
		      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,$vl_c_chaine_brute,'$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut,2,2),";
		    }
		
		  if ($i % $i1==0){
		  	echo "Ajoute $i".EOL;
		  	echo $o_interlo->req.$o_interlo->dat;
		  	echo EOL;
		  	echo $o_tel->req.$o_tel->dat;
		    echo EOL;
		    echo $o_fonction->req.$o_fonction->dat;
		    echo EOL;
		    echo "insertion interlo -> ".$o_interlo->execute().EOL;
		    echo "insertion adresses -> ".$o_adresses->execute().EOL;
		    echo "insertion web -> ".$o_web->execute().EOL;
		    echo "insertion fonction -> ".$o_fonction->execute().EOL;
		    echo "insertion tel -> ".$o_tel->execute().EOL;
		    /*
		    //echo $o_compta->req.$o_compta->dat;
		    //echo EOL;
		    //echo $o_compta->req.$o_compta->dat;
		    $retour_insert=$o_compta->execute();
		    $o_rib->execute();
		    $o_web->execute();
		    $o_rep->execute();
		    $o_relation->execute();
		    
		    */
		  }
		}
	}
}
echo $o_interlo->req.$o_interlo->dat;
		    echo EOL;
$o_interlo->execute();
$o_adresses->execute();
$o_web->execute();
$o_fonction->execute();
$o_tel->execute();
_graal_ferme_connexion();
	echo("$i interlocuteurs importés.");
?>
