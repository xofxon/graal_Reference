<?php
include("_graal_header_xul.inc.php");
$vl_e_uti_cleunik =intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_c_id_fenetre="Fen_00246";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_b_ajout=$vl_tb_droits[1];$vl_b_modif=$vl_tb_droits[2];$vl_b_suppr=$vl_tb_droits[3];$vl_b_impri=$vl_tb_droits[4];$vl_b_detai=1;
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bbx_100=fa_recup_dico("bbx_100");
$vl_c_bbx_101=fa_recup_dico("bbx_101");
$vl_c_bbx_102=fa_recup_dico("bbx_102");
$vl_c_bbx_103=fa_recup_dico("bbx_103");
$vl_c_bbx_104=fa_recup_dico("bbx_104");
$vl_c_bbx_105=fa_recup_dico("bbx_105");
$vl_c_bbx_106=fa_recup_dico("bbx_106");
$vl_c_bbx_106="à";
$vl_c_bbx_107=fa_recup_dico("bbx_107");
$vl_c_bbx_107="Gestion dépôts/emplacements";
$vl_c_bbx_108=fa_recup_dico("bbx_108");
$vl_c_bbx_108="Voir les articles";
$vl_c_bbx_109=fa_recup_dico("bbx_109");
$vl_c_bbx_109="Retour";
$vl_c_bbx_110="Description";
$vl_c_bbx_111="Code";
$vl_c_bbx_112="Id mnémotechnique";
$vl_c_bbx_113="Etat";
$vl_c_bbx_114="Base de valorisation théorique";
$vl_c_bbx_115="Tarif de référence théorique";
$vl_c_bbx_116="Ouvrir l'article";
$vl_c_bbx_117="Rafraîchir";
$vl_c_bbx_118="Inventaire";
$vl_c_bbx_119="Sélectionner les articles";
$vl_c_bbx_120="Critère de tri";
$vl_c_bbx_121="Code choix";
$vl_c_bbx_122="Désignation choix";
$vl_c_bbx_123="Imprimer";

$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_dico_00018=fa_recup_dico("dico_00018");
$vl_c_dico_00083=fa_recup_dico("dico_00083");
$vl_c_dico_00084=fa_recup_dico("dico_00084");
$vl_c_dico_00085=fa_recup_dico("dico_00085");
$vl_c_dico_00163=fa_recup_dico("dico_00163");
$vl_c_menu_context="<popup id='pop_art'><menuitem class='menuitem-iconic ai07' label=\"$vl_c_bbx_116\" oncommand='pf_ouvre(\"art\");' />";
$vl_c_menu_context.="</popup>";
$brik_critere=pf_fabrik_menulist_criteres("1","ml_criteres");
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_bbx_100" id="_win_fen_inventaire" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
$vl_c_menu_context
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_inventaire_01.js.php");
echo <<<END
<broadcasterset><broadcaster id="broadcaster_01" /></broadcasterset>
<deck id="dk_01" flex="1">
<_graal_deck flex="1">
<vbox flex="1">
<vbox id="box_boite_outils_xof_01" flex="4">
  <tree id="arbre_inventaire" flex="1" hidecolumnpicker="true" flags="" ref="*" querytype="xml" datasources="" onselect="pf_sel_ligne(this.id);">
    <treecols>
      <treecol collapsed="true" id="tc_inv_cleunik" label="raf_invisible"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_description" label="$vl_c_bbx_101" sort="?description" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_dateheurecreation" label="$vl_c_bbx_102" sort="?dateheurecreation"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_dateheureinventaire" label="$vl_c_bbx_103" sort="?dateheureinventaire"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_etat" label="$vl_c_bbx_104" sort="?etat"/><splitter class="tree-splitter" resizeafter="grow"/>
    </treecols>
    <template><query expr="*"/><action>
      <treechildren>
        <treeitem uri="?" seltype="single">
          <treerow>
            <treecell label="?inv_cleunik"/>
            <treecell label="?description"/>
            <treecell label="?dateheurecreation"/>
            <treecell label="?dateheureinventaire"/>
            <treecell label="?etat"/>
          </treerow>
        </treeitem>
      </treechildren>
    </action></template>
  </tree>
</vbox>
<splitter />
<hbox flex="1">
<vbox id="box_boite_outils_xof_02" flex="9">
  <hbox>
    <label control="la_description" value="$vl_c_bbx_101"/>
    <textbox observes="broadcaster_01" flex="1" id="tb_description"  />
    <label control="la_description" value="$vl_c_bbx_120"/>
    $brik_critere
  </hbox>
  <vbox>
    
    <hbox>
			
			<label control="la_dateheureinventaire" value="$vl_c_bbx_103"/>
			<datepicker type="popup" monthLeadingZero="true" dateLeadingZero="true" observes="broadcaster_01" id="tb_dateheureinventaire"/>
			<label value="$vl_c_bbx_106"/>
	  <timepicker is24HourClock="true" id="tb_heu_deb" observes="broadcaster_01"/>
      <spacer/>
      <label control="la_gestdepemp" value="$vl_c_bbx_107"/>
      <radiogroup id="rdg_gestdepemp" disabled="true">
        <hbox flex="1">
          <radio observes="broadcaster_01" id="ra_gestdepemp_oui" label="$vl_c_dico_00013" value="1" disabled="true"/>
          <radio observes="broadcaster_01" id="ra_gestdepemp_non" label="$vl_c_dico_00014" selected="true" value="2" disabled="true"/>
        </hbox>
      </radiogroup>
      <label value="$vl_c_bbx_114"/>
      <menulist sizetopopup="none" class="sans_icone" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' observes="broadcaster_01" flex='1' id='ml_tarif_reference' _graal_nombre='5' value="-5">
        <menupopup>
          <menuitem value='-4' label="$vl_c_dico_00018" tooltiptext="$vl_c_dico_00018"/>
          <menuitem value='-1' label="$vl_c_dico_00083" tooltiptext="$vl_c_dico_00083"/>
          <menuitem value='-3' label="$vl_c_dico_00085" tooltiptext="$vl_c_dico_00085"/>
          <menuitem value='-2' label="$vl_c_dico_00084" tooltiptext="$vl_c_dico_00084"/>
          <menuitem value='-5' label="$vl_c_dico_00163" tooltiptext="$vl_c_dico_00163"/>
        </menupopup>
      </menulist>
    </hbox>
    
                      
  </vbox>
  <vbox flex="4">
    <label control="la_blocnotebrut" value="$vl_c_bbx_105"/>
    <textbox observes="broadcaster_01" id="tb_blocnotebrut"   flex="4" multiline="true"/>
    </vbox>
  <vbox>
    <label control="la_etat" value="$vl_c_bbx_104"/>
   <radiogroup id="rdg_etat" flex="1">
     <hbox flex="1">
       <radio observes="broadcaster_01" id="ra_etat_oui" label="$vl_c_dico_00013" value="1" />
       <spacer flex="1"/>
       <radio observes="broadcaster_01" id="ra_etat_non" label="$vl_c_dico_00014" selected="true" value="2" />
     </hbox>
   </radiogroup>
  </vbox>
    <vbox>
    <label control="la_dateheurecreation" value="$vl_c_bbx_102"/>
    <textbox id="tb_dateheurecreation" disabled="true"/>
  </vbox>

</vbox>
<vbox flex="1">
     <vbox id="boutons_standards" >
END;
include("_graal_inc_boutons_01.php");
echo <<<END
      <button tooltiptext ="$vl_c_bbx_108" width="40" flex="1" id="bt_voir_articles" label="$vl_c_bbx_108" crop="end" dir="normal" oncommand="pf_voir_articles()" />
      <button tooltiptext ="$vl_c_bbx_119" width="40" flex="1" id="bt_sele_articles" label="$vl_c_bbx_119" crop="end" dir="normal" oncommand="pf_sele_articles()" />
     </vbox>
    </vbox>
  </hbox>
</vbox>
</_graal_deck>
<vbox flex="1">
  <hbox flex="4">
    <tree id="arbre_lignes_inventaire" flex="1" enableColumnDrag="true" flags="" ref="*" querytype="xml" datasources="" context='pop_art'>
      <treecols>
        <treecol collapsed="true" id="tc_inv_cleunik" label="raf_invisible" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol collapsed="true" id="tc_art_cleunik" label="raf_invisible" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_description" label="$vl_c_bbx_110" sort="?description" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_code" label="$vl_c_bbx_111" sort="?code"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_mnemotechnique" label="$vl_c_bbx_112" sort="?mnemotechnique"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_etat" label="$vl_c_bbx_113" sort="?etat"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_choix_code" label="$vl_c_bbx_121" sort="?choix_code"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_choix_valeur_texte_01" label="$vl_c_bbx_122" sort="?choix_valeur_texte_01"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_tarif_reference" label="$vl_c_bbx_114" class="droite" sort="?val_tarif_reference_theorique"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_qte_inven" label="$vl_c_bbx_118" class="droite" sort="?val_qte_inven"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_tr" label="$vl_c_bbx_115" sort="?tr" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_val_tarif_reference" sort="?val_tarif_reference_theorique" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
        <treecol id="tc_val_qte_inven" sort="?val_qte_inven" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>

      </treecols>
      <template><query expr="*"/><action>
        <treechildren>
          <treeitem uri="?" seltype="single">
            <treerow>
              <treecell label="?inv_cleunik"/>
              <treecell label="?art_cleunik"/>
              <treecell properties="?properties" label="?description"/>
              <treecell properties="?properties" label="?code"/>
              <treecell properties="?properties" label="?mnemotechnique"/>
              <treecell properties="?properties" label="?etat"/>
              <treecell properties="?properties" label="?choix_code"/>
              <treecell properties="?properties" label="?choix_valeur_texte_01"/>
              <treecell properties="?properties" label="?tarif_reference_theorique"/>
              <treecell properties="?properties" label="?qte_inven"/>
              <treecell properties="?properties" label="?tr"/>
              <treecell properties="?properties" label="?val_tarif_reference_theorique"/>
              <treecell properties="?properties" label="?val_qte_inven"/>
            </treerow>
          </treeitem>
        </treechildren>
      </action></template>
    </tree>
  </hbox>
  <hbox>
    <button tooltiptext ="$vl_c_bbx_109" flex="1" id="bt_retour_articles" label="$vl_c_bbx_109" crop="end" dir="normal" oncommand="pf_voir_deck(0);" />
    <button tooltiptext ="$vl_c_bbx_123" flex="1" id="bt_pdf" label="$vl_c_bbx_123" crop="end" dir="normal" oncommand="pf_pdf();" />
    <button tooltiptext ="$vl_c_bbx_117" flex="1" id="bt_rafraichir" label="$vl_c_bbx_117" crop="end" dir="normal" oncommand="pf_affiche_detail_lignes();" />
  </hbox>
</vbox>
</deck>


</window>
END;
function pf_fabrik_menulist_criteres($vv_flex="1",$vv_id="ml_criteres"){
  $vl_c_cleunik_metiers_viticulture="1000,1001,1002,1003,1004";
  $vl_c_cleunik_metiers=$vl_c_cleunik_metiers_viticulture.",0";
  $sql_req ="select critere_cleunik,critere_code,critere_denomination,critere_choixmultiples";
  $sql_req.=" from _criteres where (critere_cleunik >9999 or critere_cleunik in ($vl_c_cleunik_metiers)) and critere_portee & 1024";
  $sql_req.=" AND critere_actif =1";
  $sql_req.=" ORDER BY critere_denomination";
  $sql_result = _graal_requete_bd($sql_req);
  $_graal_nombre=mysql_num_rows($sql_result);
  if ($_graal_nombre== 0){
    $vv_brik="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' observes='broadcaster_01' flex='$vv_flex' id='$vv_id' _graal_nombre='1'><menupopup>";
    $vv_brik.="<menuitem value='Aucun critère !!!' _graal_cleunik='0' label='Aucun critère !!!' selected='true'/>";
  } else {
    $vv_brik="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' observes='broadcaster_01' flex='$vv_flex' id='$vv_id' _graal_nombre='$_graal_nombre'><menupopup>";
    while ($row = mysql_fetch_assoc($sql_result)){
      $vv_brik.="<menuitem value='" .$row['critere_cleunik']. "' _graal_cleunik='".$row['critere_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['critere_denomination']))."' selected='true'/>";
    }
  }
  $vv_brik.="</menupopup></menulist>";
  _graal_libere_requete_bd($sql_result);
  return $vv_brik; 
}
?>

