<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close(); 
$sql_req="select _w_import_acteurs_ligne_01.siret as z07,_w_import_acteurs_ligne_01.imp_cleunik as z01,_w_import_acteurs_ligne_01.lig_cleunik as z02,_w_import_acteurs_ligne_01.codealphanum15 as z03,_w_import_acteurs_ligne_01.raisonsoc as z04,_w_import_acteurs_ligne_01.nomcommercial as z05,(select count(*) from _acteurs where _acteurs.codealphanum15=_w_import_acteurs_ligne_01.codealphanum15) as z06,(select count(*) from _w_import_acteurs_ligne_01 f2 where f2.codealphanum15=_w_import_acteurs_ligne_01.codealphanum15 and f2.imp_cleunik=$vl_e_imp_cleunik) as z08 from _w_import_acteurs_ligne_01 where _w_import_acteurs_ligne_01.imp_cleunik=$vl_e_imp_cleunik;";
//echo $sql_req;

$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' imp_cleunik="'.fa_ent_xml($row['z01']).'"');
  echo(' lig_cleunik="'.fa_ent_xml($row['z02']).'"');
  if ($row['z06']!=0) {
    echo(' nombre_deja="'.fa_ent_xml($row['z06']).'"');
    echo(' val_nombre_deja="'.fa_ent_xml($row['z06']).'"');
  } else {
    echo(' nombre_deja=""');
    echo(' val_nombre_deja="0"');
  }
  echo(' codealphanum15="'.fa_ent_xml($row['z03']).'"');
  echo(' raisonsoc="'.fa_ent_xml($row['z04']).'"');
  echo(' nomcommercial="'.fa_ent_xml($row['z05']).'"');
  echo(' siret="'.fa_ent_xml($row['z07']).'"');
  if ($row['z08']!=1) {
    echo(' nombre_doublon="'.fa_ent_xml($row['z08']).'"');
    echo(' nombre_doublon_bis="'.fa_ent_xml($row['z08']).'"');
  } else {
    echo(' nombre_doublon=""');
    echo(' nombre_doublon_bis="0"');
  }
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
