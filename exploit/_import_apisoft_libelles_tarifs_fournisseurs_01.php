<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
define('EOL', "\r\n");
set_time_limit(6000);
echo(date("D M j G:i:s T Y").EOL);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
session_write_close();
$act_cod=array();$act_cle=array();$art_cod=array();$art_cle=array();
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeArticle) from $vl_c_base_origine.fournisseurarticle)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);
$sql_req="select act_cleunik,codealphanum15 from $vl_c_base_destination._acteurs where typeacteur=110004 and codealphanum15 in(select distinct(CodeFournisseur) from $vl_c_base_origine.fournisseurarticle)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($act_cod, $row['codealphanum15']);
  array_push ($act_cle, $row['act_cleunik']);
}
_graal_libere_requete_bd($result);
$uni_cod=array();$uni_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=110"; //  On recherche les critères unité d'achat
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($uni_cod, $row['code']);
  array_push ($uni_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$o_tarif=new _graal_import();
$o_art_acteurs=new _graal_import();
$o_tarif->req="INSERT INTO $vl_c_base_destination._art_tarifs (tar_cleunik,art_cleunik,act_cleunik,tarif_cleunik,pu_reference,actif,type) VALUES ";
$o_art_acteurs->req="INSERT INTO $vl_c_base_destination._art_acteur (art_acteur_cleunik,art_cleunik,act_cleunik,code,description,dateheurecreation,delai_reappro,unite_reappro,minimum_commande) values ";


$tar_cleunik=_graal_requete_max("tar_cleunik","$vl_c_base_destination._art_tarifs");
$art_acteur_cleunik=_graal_requete_max("art_acteur_cleunik","$vl_c_base_destination._art_acteur");
$sql_req = "SELECT CompteurArtFour,CodeArticle,CodeFournisseur,Reference,DelaiLivraison,PrixAchat,DatePa,MiniCom,Principal,UniteAchat,EquivStockage,Actif,Devise FROM $vl_c_base_origine.fournisseurarticle order by CodeArticle;";

$result=_graal_requete_bd($sql_req);
$i=0;$b=500;
while ($row = mysql_fetch_assoc($result)) {
	$CompteurArtFour=$row['CompteurArtFour'];
	$CodeArticle=$row['CodeArticle'];
	$CodeFournisseur=fa_nt($row['CodeFournisseur']);
	$code=fa_nt($row['Reference']);
	$delai_reappro=$row['DelaiLivraison'];
	$PrixAchat=$row['PrixAchat'];
	$dateheurecreation=fa_nt($row['DatePa']);
	$minimum_commande=$row['MiniCom'];
	$Principal=$row['Principal'];
	$UniteAchat=$row['UniteAchat'];
	$EquivStockage=$row['EquivStockage'];
	$Actif=$row['Actif'];
	$Devise=$row['Devise'];
	$unite_reappro=-20;	//jours
  $vl_e_trouve=array_search($row['CodeArticle'], $art_cod);if ($vl_e_trouve===false) {$art_cleunik=0;} else {$art_cleunik=$art_cle[$vl_e_trouve];}
  if ($art_cleunik!=0) {
    $vl_e_trouve=array_search($row['CodeFournisseur'], $act_cod);if ($vl_e_trouve===false) {$act_cleunik=0;} else {$act_cleunik=$act_cle[$vl_e_trouve];}
    if ($act_cleunik!=0) {
      $i++;
      $o_tarif->dat.="($tar_cleunik,$art_cleunik,$act_cleunik,-32,".$row['PrixAchat'].",1,2),";
      $vl_e_trouve_uni=array_search($row['UniteAchat'], $uni_cod);if ($vl_e_trouve_uni===false) {$unite_reappro=-36;} else {$unite_reappro=$uni_cle[$vl_e_trouve_uni];}
      $o_art_acteurs->dat.="($art_acteur_cleunik,$art_cleunik,$act_cleunik,$code,NULL,$dateheurecreation,$delai_reappro,$unite_reappro,$minimum_commande),";
    }
  }
  if ($i % $b==0){
    $o_tarif->execute();
    $o_art_acteurs->execute();
  }
  $tar_cleunik++;
  $art_acteur_cleunik++;
}
echo $o_art_acteurs->req.$o_art_acteurs->dat;
$o_tarif->execute();
$o_art_acteurs->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($i.' libellés-tarifs ajoutés.'.EOL);
echo(date("D M j G:i:s T Y").EOL);
?>
