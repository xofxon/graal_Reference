<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
include("_graal_fonctions_documents.php");
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_tb_droits_onglet_admin=_graal_requete_droits_fenetre('Trait_00305',$vl_e_uti_cleunik); //  Autorisation de télécharger ou de voir le source d'un courriel
if ($vl_tb_droits_onglet_admin[0]==false) {fa_redirige("document_interdit");}
$vl_e_courriel_brut_cleunik=intval(fa_recup_param('vl_e_courriel_brut_cleunik','0'));
$sql_req = "SELECT a1.courriel AS courriel,a1.hash as hash,a1.action_cleunik FROM _courriel_recus_brut a1 WHERE a1.courriel_brut_cleunik=$vl_e_courriel_brut_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$action_cleunik=$row['action_cleunik'];
if (fa_cherche_si_pj_autorisee($action_cleunik)==false) {fa_redirige("courriel_interdit");}
header("Content-disposition: attachment; filename=courriel_".$row['hash'].".eml");
header("Content-Type: application/force-download");
echo $row['courriel'];
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
