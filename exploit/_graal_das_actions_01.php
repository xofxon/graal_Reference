<?php
include("_graal_header_xml.inc.php");
include("_graal_var_portee.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_c_lesquelles=fa_recup_param('vl_c_lesquelles','toutes');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_quelleplage=fa_recup_param('vl_c_quelleplage','debut');
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','19610123');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','20610123');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','150'));
$vl_e_genre=fa_recup_param('vl_e_genre','-1');
$vl_e_statut=fa_recup_param('vl_e_statut','-1');
$vl_e_act_cleunik=intval(fa_recup_param('act_cleunik','-1'));
$vl_e_int_cleunik=intval(fa_recup_param('int_cleunik','-1'));
$vl_e_operat=intval(fa_recup_param('vl_operat','1'));
$vl_e_operat_genre=intval(fa_recup_param('vl_operat_genre','1'));
$vl_e_zone=intval(fa_recup_param('vl_zone','1'));
$vl_e_type_recherche=intval(fa_recup_param('vl_type_recherche','1'));
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_e_spec=intval(fa_recup_param('spec','0'));
$vl_e_spec_quoi=fa_recup_param('spec_quoi','0');
$vl_e_action_choix=intval(fa_recup_param('vl_e_action_choix','0'));
$vl_e_action_choix_cleunik=fa_recup_param('vl_e_action_choix_cleunik','0');
$vl_e_action_critere_cleunik=fa_recup_param('vl_e_action_critere_cleunik','0');
$vl_e_priorite=fa_recup_param('vl_e_priorite','-1');
$vl_e_operat_priorite=intval(fa_recup_param('vl_operat_priorite','1'));
$vl_c_concerne_qui=intval(fa_recup_param('vl_c_concerne_qui','-1'));
$vs_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
$vl_c_particularisme=intval(fa_recup_param('vl_c_particularisme','-1'));
$vl_e_action_particuliere=intval(fa_recup_param('vl_e_action_particuliere','0'));
$vl_c_type_affichage=fa_recup_param("vl_c_type_affichage","1");
$vl_c_rep_fac=intval(fa_recup_param('vl_c_rep_fac',"-1"));
$vl_c_genreaction=fa_recup_param('vl_c_genreaction',"cdecli");
$vl_e_confiden=fa_recup_param('vl_e_confiden','-1');
$vl_operat_confiden=intval(fa_recup_param('vl_operat_confiden','1'));
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
$vl_c_var=fa_recup_param('var','vs_tempo_panier_action');
$vl_e_panier_cleunik=intval(fa_recup_param('vl_panier_cleunik','-1'));
session_write_close();
switch ($vl_e_spec){
	case -1:
		$vl_c_lesquelles="acteurs";
		$vl_e_act_cleunik=$vl_e_spec_quoi;
		break;
	case -2:
		$vl_c_lesquelles="interlo";
		$vl_e_int_cleunik=$vl_e_spec_quoi;
		break;
}
$qui_dat=array();$qui_cle=array();$qui_actif=array();$qui_act=array();$qui_int=array();
$prop_obsolete="css_0001";
$req_compte_pj="select count(*) from _documents_rattachement where _documents_rattachement.rat_cleunik=_actions.action_cleunik and portee &$vl_e_piejoi";
switch ($vl_e_panier_cleunik){
	case "-1":
	case "":
		switch ($vl_c_particularisme){
				case 14:
					include("_graal_req_actions_02.php");
					break;
				default:
					include("_graal_req_actions_01.php");
					break;
			}
		break;
	default:
		include("_graal_req_panier_actions.php");
		break;
}

//die ($vl_c_in);

if (strlen($vl_c_in)!=0) {
	$vl_c_in=substr($vl_c_in,0,-1);
	if ($vl_c_lesquelles!="dernieres_sauf_emailing"){
		if ($vl_e_genre!=-110122) {
		  $sql_req="select `f1`.`action_cleunik` AS `action_cleunik`,concat_ws(_utf8' ',`f7`.`prenom`,`f7`.`patronyme`,_utf8'(',(case `f6`.`raisonsoc` when _utf8'' then ";
		  $sql_req.=" `f6`.`nomcommercial` else `f6`.`raisonsoc` end),_utf8')') AS `qui_interlo`,`f7`.`actif` AS `interlo_actif`, ";
		  $sql_req.=" concat_ws(_utf8' ',`f7`.`prenom`,`f7`.`patronyme`) as interlo,";
		  $sql_req.=" case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end as acteur";
		  $sql_req.=" from ((`_graal` `f1` left join `_acteurs` `f6` ";
		  $sql_req.=" using(`act_cleunik`)) left join `_act_interlo` `f7` using(`int_cleunik`)) where ((`f1`.`principal` = 2) and (`f1`.`portee` = 4096)) and f1.action_cleunik ";
		  $sql_req.=" in ($vl_c_in)";
		  $sql_req.=" union select `f1`.`action_cleunik` AS `action_cleunik`,(case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end) AS `qui_interlo`,";
		  $sql_req.=" `f6`.`actif` AS `interlo_actif`,";
		  $sql_req.=" '' as interlo,";
		  $sql_req.=" case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end as acteur";
		  $sql_req.=" from (`_graal` `f1` left join `_acteurs` `f6` on((`f1`.`act_cleunik` = `f6`.`act_cleunik`))) where ((`f1`.`principal` = 2) and ";
		  $sql_req.=" (`f1`.`portee` = 8192)) and f1.action_cleunik in ($vl_c_in)";
		  //die($sql_req);
		  $result = _graal_requete_bd($sql_req);
		  while ($row = mysql_fetch_assoc($result)) {
		    array_push ($qui_dat, fa_ent_xml($row['qui_interlo']));
		    array_push ($qui_cle, $row['action_cleunik']);
		    array_push ($qui_actif, $row['interlo_actif']);
		    array_push ($qui_act, fa_ent_xml($row['interlo']));
		    array_push ($qui_int, fa_ent_xml($row['acteur']));
		  }
		  _graal_libere_requete_bd($result);
		} else {
			$sql_req="select count(*) as nombre,action_cleunik from _emailing_refweb group by action_cleunik;";
			$result = _graal_requete_bd($sql_req);
			  while ($row = mysql_fetch_assoc($result)) {
			    array_push ($qui_dat, fa_ent_xml($row['nombre']." courriels destinataires."));
			    array_push ($qui_cle, $row['action_cleunik']);
				array_push ($qui_actif, 1);
			  }
		  _graal_libere_requete_bd($result);
		}
	}

	$les_colonnes_communes=" _actions.statut as statut_124,f4.choix_valeur_texte_01 as statut,_actions.priorite as priorite_123,_actions.choix_cleunik as genre_094,";
	$les_colonnes_communes.="f9.choix_valeur_texte_01 as confidentialite_clair,_actions.confidentialite as confi_122,";
  switch ($vl_c_type_affichage) {
	case "2":	//	Commandes clients avec transporteur et date d'expédition
  switch ($vl_e_zone) {
    case 1: //description
      switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.=" $les_colonnes_communes,_actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,";
          $sql_req_finale.=" f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial as transporteur, ";
          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_cdecli_entetes f6,_cdecli_transporteurs f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik ";
          $sql_req_finale.=" and f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik in ($vl_c_in) and ";
          $sql_req_finale.=" f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,_actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.=" $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') as `score`,";
          $sql_req_finale.=" ($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, ";
          $sql_req_finale.=" f8.nomcommercial as transporteur,f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_cdecli_entetes f6,_cdecli_transporteurs f7,_acteurs f8,_choix f9 ";
          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik and f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and ";
          $sql_req_finale.=" _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut ";
          $sql_req_finale.=" and _actions.action_cleunik=f5.action_cleunik";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
      }
      break;
    case 2: //sujet
    switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.=" $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,";
          $sql_req_finale.=" f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial as transporteur, ";
          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_cdecli_entetes f6,_cdecli_transporteurs f7,_acteurs f8 ,_choix f9 where f6.action_cleunik=_actions.action_cleunik and ";
          $sql_req_finale.=" f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik in ($vl_c_in) and ";
          $sql_req_finale.=" f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
      }
      break;
    case 3:	//contenu
      switch ($vl_e_type_recherche) {
        case 3: //  Contenu
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.=" $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,";
          $sql_req_finale.=" f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial  as transporteur,";
          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_cdecli_entetes f6,_cdecli_transporteurs f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik ";
          $sql_req_finale.=" and f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik in ($vl_c_in) and ";
          $sql_req_finale.=" f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
      }
      break;
  }
  break;
  case "3":	//	Livraisons clients avec transporteur et date d'expédition
  switch ($vl_e_zone) {
    case 1: //description
      switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.=" $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,";
          $sql_req_finale.=" f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial as transporteur, ";
          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_livcli_entetes f6,_livcli_transporteurs f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik and ";
          $sql_req_finale.=" f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik in ($vl_c_in) and ";
          $sql_req_finale.=" f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.=" _actions.dateheurecreation,_actions.dateheuremodif,_actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.=" $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') as `score`,";
          $sql_req_finale.=" ($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, ";
          $sql_req_finale.=" f8.nomcommercial as transporteur,f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";
          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_livcli_entetes f6,_livcli_transporteurs f7,_acteurs f8,_choix f9  ";
          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik and f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik ";
          $sql_req_finale.=" in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut and ";
          $sql_req_finale.=" _actions.action_cleunik=f5.action_cleunik";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
      }
      break;
    case 2: //sujet
    switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
          $sql_req_finale.="  AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
          $sql_req_finale.="  _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,";
          $sql_req_finale.="  f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial as transporteur,";
          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.="   FROM _actions, _choix f2,_choix f3,_choix f4,_livcli_entetes f6,_livcli_transporteurs f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik and ";
          $sql_req_finale.="  f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik in ($vl_c_in) and ";
          $sql_req_finale.="  f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
      }
      break;
    case 3:	//contenu
      switch ($vl_e_type_recherche) {
        case 3: //  Contenu
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
          $sql_req_finale.="  AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." ";
          $sql_req_finale.="  as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,";
          $sql_req_finale.="  f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial  as transporteur, ";
          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_livcli_entetes f6,_livcli_transporteurs f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik ";
          $sql_req_finale.="  and f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_trans and _actions.action_cleunik in ($vl_c_in) and ";
          $sql_req_finale.="  f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
          break;
      }
      break;
  }
		break;

		case 4:	//	Factures clients avec représentant et montant
		  switch ($vl_e_zone) {
		    case 1: //description
		      switch ($vl_e_type_recherche) {
		        case 1: //  Orthographe
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
		          $sql_req_finale.="  AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,";
		          $sql_req_finale.=" description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes _actions.sujet as `sujet`,";
		          $sql_req_finale.=" _actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.="  f8.nomcommercial as representant,f7.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_faccli_entetes f6,";
		          $sql_req_finale.=" _faccli_representants f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik and f7.commercial_cleunik=f6.commercial_cleunik ";
		          $sql_req_finale.=" and f8.act_cleunik=f7.act_cleunik_rep and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik ";
		          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		      	  break;
		        case 2: //  Poids des mots
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
		          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,";
		          $sql_req_finale.=" _actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes _actions.sujet as `sujet`,";
		          $sql_req_finale.=" _actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') as `score`,($req_compte_pj) as nb_pj,";
		          $sql_req_finale.=" f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`, f8.nomcommercial as representant,";
		          $sql_req_finale.=" f7.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_faccli_entetes f6,_faccli_representants f7,_acteurs f8,_choix f9 ";
		          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik and f7.commercial_cleunik=f6.commercial_cleunik and f8.act_cleunik=f7.act_cleunik_rep ";
		          $sql_req_finale.=" and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite ";
		          $sql_req_finale.=" and f4.choix_cleunik=_actions.statut and _actions.action_cleunik=f5.action_cleunik";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		          break;
		      }
		      break;
		    case 2: //sujet
		    switch ($vl_e_type_recherche) {
		        case 1: //  Orthographe
		        case 2: //  Poids des mots
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
		          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,";
		          $sql_req_finale.=" _actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes ";
		          $sql_req_finale.=" _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.=" f8.nomcommercial as representant,f7.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.=" FROM _actions, _choix f2,_choix f3,_choix f4,_faccli_entetes f6,";
		          $sql_req_finale.=" _faccli_representants f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik and f7.commercial_cleunik=f6.commercial_cleunik";
		          $sql_req_finale.=" and f8.act_cleunik=f7.act_cleunik_rep and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik";
		          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		          break;
		      }
		      break;
		    case 3:	//contenu
		      switch ($vl_e_type_recherche) {
		        case 3: //  Contenu
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
		          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,";
		          $sql_req_finale.=" description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes _actions.sujet as `sujet`,";
		          $sql_req_finale.=" _actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.="  f8.nomcommercial  as representant,f7.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_faccli_entetes f6,";
		          $sql_req_finale.=" _faccli_representants f7,_acteurs f8,_choix f9 where f6.action_cleunik=_actions.action_cleunik and f7.commercial_cleunik=f6.commercial_cleunik ";
		          $sql_req_finale.=" and f8.act_cleunik=f7.act_cleunik_rep and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik ";
		          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		          break;
		      }
		      break;
		  }
		break;
		case 5:
			/*
			 * Documents avec montant TTC (commandes clients seules pour l'instant)
			 * Factures clients depus le 23 avril 2010
			 */
			//
		  switch ($vl_e_zone) {
		    case 1: //description
		      switch ($vl_e_type_recherche) {
		        case 1: //  Orthographe
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
		          $sql_req_finale.="  AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,";
		          $sql_req_finale.=" description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes _actions.sujet as `sujet`,";
		          $sql_req_finale.=" _actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.="  f6.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_".$vl_c_genreaction."_entetes f6,_choix f9";
		          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik ";
		          $sql_req_finale.=" and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik ";
		          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		      	  break;
		        case 2: //  Poids des mots
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
		          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,";
		          $sql_req_finale.=" _actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes _actions.sujet as `sujet`,";
		          $sql_req_finale.=" _actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') as `score`,($req_compte_pj) as nb_pj,";
		          $sql_req_finale.=" f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.=" f6.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_".$vl_c_genreaction."_entetes f6,_choix f9";
		          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik ";
		          $sql_req_finale.=" and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite ";
		          $sql_req_finale.=" and f4.choix_cleunik=_actions.statut and _actions.action_cleunik=f5.action_cleunik";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		          break;
		      }
		      break;
		    case 2: //sujet
		    switch ($vl_e_type_recherche) {
		        case 1: //  Orthographe
		        case 2: //  Poids des mots
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
		          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,";
		          $sql_req_finale.=" _actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes ";
		          $sql_req_finale.=" _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.=" f6.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_".$vl_c_genreaction."_entetes f6,_choix f9";
		          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik ";
		          $sql_req_finale.=" and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik";
		          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		          break;
		      }
		      break;
		    case 3:	//contenu
		      switch ($vl_e_type_recherche) {
		        case 3: //  Contenu
		          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  ) ";
		          $sql_req_finale.=" AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,";
		          $sql_req_finale.=" dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,";
		          $sql_req_finale.=" description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,$les_colonnes_communes _actions.sujet as `sujet`,";
		          $sql_req_finale.=" _actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj,f6.dateheureexpedition as dateheureexpedition,"._graalsql_date('f6.dateheureexpedition')." as `dateexpedition`,";
		          $sql_req_finale.="  f6.commercial_cleunik as commercial_cleunik,";
		          $sql_req_finale.=" f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif` ";
		          $sql_req_finale.="  FROM _actions, _choix f2,_choix f3,_choix f4,_".$vl_c_genreaction."_entetes f6,_choix f9";
		          $sql_req_finale.=" where f6.action_cleunik=_actions.action_cleunik ";
		          $sql_req_finale.=" and _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik ";
		          $sql_req_finale.=" and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
		          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
		          break;
		      }
		      break;
		  }
		break;

		case "1":	//	Normal
		default:
			$sql_req_finale_comp00="";$sql_req_finale_comp01="";
			switch ($vl_e_genre){
				case "-110114" : $sql_req_finale_comp01=" left join _offcli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110115" : $sql_req_finale_comp01=" left join _demfou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110108" : $sql_req_finale_comp01=" left join _cdecli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110109" : $sql_req_finale_comp01=" left join _cdefou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110110" : $sql_req_finale_comp01=" left join _livcli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110111" : $sql_req_finale_comp01=" left join _recfou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110112" : $sql_req_finale_comp01=" left join _faccli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110113" : $sql_req_finale_comp01=" left join _facfou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110116" : $sql_req_finale_comp01=" left join _avocli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110117" : $sql_req_finale_comp01=" left join _avocli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110133" : $sql_req_finale_comp01=" left join _retcli_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110134" : $sql_req_finale_comp01=" left join _retfou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110135" : $sql_req_finale_comp01=" left join _relfou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110137" : $sql_req_finale_comp01=" left join _avofou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
		        case "-110138" : $sql_req_finale_comp01=" left join _avofou_entetes f6 on _actions.action_cleunik=f6.action_cleunik ";$sql_req_finale_comp00=",f6.dateheuremodif as dateheuremodif,"._graalsql_date('f6.dateheuremodif')." as `datemodif`";break;
			}
	  switch ($vl_e_zone) {
	    case 1: //description
	      switch ($vl_e_type_recherche) {
	        case 1: //  Orthographe
	          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
	          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
	          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
	          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
	          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
	          $sql_req_finale.="  FROM _actions $sql_req_finale_comp01 ,_choix f2,_choix f3,_choix f4,_choix f9 ";
	          $sql_req_finale.="  where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and ";
	          $sql_req_finale.="  f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
	          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	          break;
	        case 2: //  Poids des mots
	          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
	          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
	          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
	          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,_actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
	          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') ";
	          $sql_req_finale.="  as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
	          $sql_req_finale.=" FROM _actions $sql_req_finale_comp01, _choix f2,_choix f3,_choix f4,_actions_texte f5,_choix f9 ";
	          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut and _actions.action_cleunik=";
	          $sql_req_finale.="  f5.action_cleunik";
	          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	          break;
	      }
	      break;
	    case 2: //sujet
	    switch ($vl_e_type_recherche) {
	        case 1: //  Orthographe
	        case 2: //  Poids des mots
	          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
	          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
	          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
	          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
	          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
	          $sql_req_finale.="  FROM _actions $sql_req_finale_comp01,_choix f2,_choix f3,_choix f4,_choix f9 ";
	          $sql_req_finale.="  where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=";
	          $sql_req_finale.="  _actions.priorite and f4.choix_cleunik=_actions.statut";
	          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	          break;
	      }
	      break;
	    case 3:	//contenu mails recus
	      switch ($vl_e_type_recherche) {
	        case 3: //  Contenu
	          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
	          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
	          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
	          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
	          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
	          $sql_req_finale.=" FROM _actions $sql_req_finale_comp01,_choix f2,_choix f3,_choix f4,_choix f9 ";
	          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=";
	          $sql_req_finale.="  _actions.priorite and f4.choix_cleunik=_actions.statut";
	          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	          break;
	      }
	      break;
	  case 4: //référence
	    switch ($vl_e_type_recherche) {
	        case 1: //  Orthographe
	        case 2: //  Poids des mots
	          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
	          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
	          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
	          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
	          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
	          $sql_req_finale.=" FROM _actions $sql_req_finale_comp01,_choix f2,_choix f3,_choix f4,_choix f9 ";
	          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=";
	          $sql_req_finale.="  _actions.priorite and f4.choix_cleunik=_actions.statut";
	          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	          break;
	      }
	      break;
	  case 5: //acteur principal de l'action
	  case 7: //interlocuteur principal de l'action
	    switch ($vl_e_type_recherche) {
	        case 1: //  Orthographe
	        case 2: //  Poids des mots
	          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
	          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
	          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
	          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
	          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
	          $sql_req_finale.=" FROM _actions $sql_req_finale_comp01 ,_choix f2,_choix f3,_choix f4,_choix f9 ";
	          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=";
	          $sql_req_finale.="  _actions.priorite and f4.choix_cleunik=_actions.statut";
	          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	          break;
	      }
	      break;
	  case 6:	//contenu chats
          $sql_req_finale ="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =_actions.action_cleunik  )";
          $sql_req_finale.="   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,";
          $sql_req_finale.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as ";
          $sql_req_finale.="  `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
          $sql_req_finale.="  $les_colonnes_communes _actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,($req_compte_pj) as nb_pj $sql_req_finale_comp00";
          $sql_req_finale.=" FROM _actions $sql_req_finale_comp01,_choix f2,_choix f3,_choix f4,_choix f9 ";
          $sql_req_finale.=" where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=";
          $sql_req_finale.="  _actions.priorite and f4.choix_cleunik=_actions.statut";
          $sql_req_finale.=" and f9.choix_cleunik=_actions.confidentialite";
	      break;
	  }
		break;


  }
  //die("*". $sql_req_finale."*");
  switch ($vl_c_quelleplage) {
    case "debut":$sql_req_finale.=" order by score DESC,_actions.dateheuredebut DESC,_actions.dateheurefin DESC";break;
    case "fin":$sql_req_finale.=" order by score DESC,_actions.dateheurefin ASC";break;
  }
	switch ($vl_e_type_recherche) {
     case 3: //  Contenu
     	if ($vl_e_limit!=0) {
     		$sql_req_finale.= " LIMIT 0,$vl_e_limit";
			}
      break;
  }
  //die($sql_req_finale);
switch ($vl_c_sortie) {
	case "sql":
		echo $sql_req_finale;
		exit();
  case "das":

    echo('<?xml version="1.0" encoding="UTF-8"?><donnees>');
  $result = _graal_requete_bd($sql_req_finale);
	//echo("*". $sql_req_finale."*");
	//echo ('<req="'.fa_ent_xml($sql_req_finale).'" />');
	while ($row = mysql_fetch_assoc($result)) {
		$vl_b_insere=pf_verif_particularisme($vl_c_particularisme,$row['action_cleunik']);
		if ($vl_b_insere=="ok"){
			echo('<quoi ');
		    echo(' action_cleunik="'.fa_ent_xml($row['action_cleunik']).'"');
		    echo(' description="'.fa_ent_xml($row['description']).'"');
		    echo(' choix_cleunik="'.fa_ent_xml($row['choix_cleunik']).'"');
			echo(' dateheurecreation="'.fa_ent_xml($row['dateheurecreation']).'"');
		    echo(' dateheuredebut="'.fa_ent_xml($row['dateheuredebut']).'"');
		    echo(' dateheurefin="'.fa_ent_xml($row['dateheurefin']).'"');
		    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
		    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
		    $hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
		    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
		    echo(' datedebut="'.$dd.'"');
		    echo(' datefin="'.$df.'"');
		    echo(' heuredebut="'.$hd.'"');
		    echo(' heurefin="'.$hf.'"');
		    echo(' datemodif="'.fa_ent_xml($row['datemodif']).'"');
		    echo(' dateheuremodif="'.fa_ent_xml($row['dateheuremodif']).'"');
		    echo(' genre="'.fa_ent_xml($row['genre']).'"');
		    echo(' priorite="'.fa_ent_xml($row['priorite']).'"');
		    echo(' statut="'.fa_ent_xml($row['statut']).'"');
		    echo(' properties_statut="'."statut_action_001".'"');
		    echo(' prop_124="prop_124_'.$row['statut_124'].'"');
		    echo(' prop_123="prop_123_'.$row['priorite_123'].'"');
		    echo(' prop_094="prop_094_'.$row['genre_094'].'"');
		    echo(' prop_122="prop_122_'.$row['confi_122'].'"');

		    /*
			switch ($vl_e_critere_cleunik){
			  case 94 : //Genres d'actions
			  	echo(' prop_choix_valeur_texte_01="statut_094_'.$vl_e_choix_cleunik.'"');
			  	break;
			  case 123: //Priorités d'actions
			  case 124: //Statuts d'actions

			  	break;
			  case 129: //Statuts de lignes commerciales
			  	echo(' prop_choix_valeur_texte_01="statut_129_'.$vl_e_choix_cleunik.'"');
			  	break;
			}
		    */



			$vl_c_sujet=fa_ent_xml($row['sujet']);
			//$vl_c_sujet = preg_replace('/^\W+|\W+$/', '', $vl_c_sujet);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
		    echo(' sujet="'.$vl_c_sujet.'"');
		    echo(' reference="'.fa_ent_xml($row['reference']).'"');
		    echo(' poidsdesmots="'.fa_ent_xml($row['score']).'"');
		    $vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);
			if ($vl_e_trouve===false) {
				$vl_c_qui="";
				$vl_c_properties_qui="";
				$vl_c_act="";
				$vl_c_int="";
			} else {
				$vl_c_qui=$qui_dat[$vl_e_trouve];
				$vl_c_act=$qui_act[$vl_e_trouve];
				$vl_c_int=$qui_int[$vl_e_trouve];
				if ($qui_actif[$vl_e_trouve]==1){
					$vl_c_properties_qui="";
				} else {
					$vl_c_properties_qui="$prop_obsolete";
				}
			}
		    echo(' qui="'.$vl_c_qui.'"');
		    echo(' acteur_principal="'.$vl_c_act.'"');
		    echo(' interl_principal="'.$vl_c_int.'"');
		    echo(' confidentialite="'.fa_ent_xml($row['confidentialite_clair']).'"');

			echo(' properties_qui="'.$vl_c_properties_qui.'"');
	    	if($row['nb_pj']!=0) {
	    	switch ($row['choix_cleunik']){
					case "-110125":$vl_c_prop_pj="xx06";break;
					case "-110126":$vl_c_prop_pj="al03";break;
	    		default				:$vl_c_prop_pj="al14";break;
	    	}
			} else {
				$vl_c_prop_pj="";
			}
		    echo(' prop_pj="'.$vl_c_prop_pj.'"');
			if($row['nombre_graal_act']!=0) {
				$vl_c_prop_nombre_graal_act="af08";
			} else {
				$vl_c_prop_nombre_graal_act="";
			}
			echo(' prop_nombre_graal_act="'.$vl_c_prop_nombre_graal_act.'"');
			echo(' dateheureexpedition="'.fa_ent_xml($row['dateheureexpedition']).'"');
			echo(' dateexpedition="'.fa_ent_xml($row['dateexpedition']).'"');
			echo(' transporteur="'.fa_ent_xml($row['transporteur']).'"');
			echo(' representant="'.fa_ent_xml($row['representant']).'"');
			echo(' commercial_cleunik="'.fa_ent_xml($row['commercial_cleunik']).'"');

			switch ($vl_c_type_affichage) {
				case 4:	//	Factures clients avec représentant et montant
					$sql_req_ht_marchandise_ht="select sum(montant) as montant_ht from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=1;";
					$result_ht = _graal_requete_bd($sql_req_ht_marchandise_ht);
					$row_ht = mysql_fetch_assoc($result_ht);
					$total_ht=$row_ht['montant_ht'];
					_graal_libere_requete_bd($result_ht);
					echo(' montant="'.$total_ht.'"');
					break;
				case 5:	//	Documents chiffrés TTC
					/*
					 * au 14 janvier 2010, seulement les commandes
					 */
					$sql_req_ttc_doc="select sum(montant) as montant_ttc from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=0;";
					$result_ttc = _graal_requete_bd($sql_req_ttc_doc);
					$row_ttc = mysql_fetch_assoc($result_ttc);
					$total_ttc=$row_ttc['montant_ttc'];
					_graal_libere_requete_bd($result_ttc);
					echo(' montant="'.$total_ttc.'"');
				case 7:	//	Factures et avoirs chiffrés HT et TTC
					$sql_req_ttc_doc="select sum(montant) as montant_ttc from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=0;";
					$result_ttc = _graal_requete_bd($sql_req_ttc_doc);
					$row_ttc = mysql_fetch_assoc($result_ttc);
					$total_ttc=$row_ttc['montant_ttc'];
					_graal_libere_requete_bd($result_ttc);
					echo(' montant_ttc="'.$total_ttc.'"');
					$sql_req_ht_marchandise_ht="select sum(montant) as montant_ht from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=1;";
					$result_ht = _graal_requete_bd($sql_req_ht_marchandise_ht);
					$row_ht = mysql_fetch_assoc($result_ht);
					$total_ht=$row_ht['montant_ht'];
					_graal_libere_requete_bd($result_ht);
					echo(' montant_ht="'.$total_ht.'"');

			  }

		    echo('/>');
		    flush();
		}
	}
	_graal_libere_requete_bd($result);
	echo('</donnees>');
	break;
	case "excel_01":	//	Export factures par représentant
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib("Div_00593",$vl_e_uti_cleunik);

		$vl_c_bem_034=fa_recup_dico("bem_034");
		$vl_c_bem_035=fa_recup_dico("bem_035");
		$vl_c_bem_036=fa_recup_dico("bem_036");
		$vl_c_bem_037=fa_recup_dico("bem_037");
		$vl_c_bem_040=fa_recup_dico("bem_040");
		$vl_c_bem_041=fa_recup_dico("bem_041");
		$vl_c_bem_042=fa_recup_dico("bem_042");
		$vl_c_bem_043=fa_recup_dico("bem_043");
		$vl_c_bem_044=fa_recup_dico("bem_044");
		$vl_c_bem_053=fa_recup_dico("bem_053");
		$vl_c_bem_054=fa_recup_dico("bem_054");
		$vl_c_bem_055=fa_recup_dico("bem_055");


		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Factures representants"));
		$j=0;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_034"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_035"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_042"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_040"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_041"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_036"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_037"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_043"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_044"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_053"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_054"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_055"));$j++;
		$vl_e_noligne=1;
		$result = _graal_requete_bd($sql_req_finale);
		while ($row = mysql_fetch_assoc($result)) {
			$vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);
			if ($vl_e_trouve===false) {
				$vl_c_qui="";
			} else {
				$vl_c_qui=$qui_dat[$vl_e_trouve];
			}
		    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
		    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
		    $hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
		    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
		    $vl_c_sujet=fa_ent_xml($row['sujet']);
			//$vl_c_sujet = preg_replace('/^\W+|\W+$/', '', $vl_c_sujet);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
			$sql_req_ht_marchandise_ht="select sum(montant) as montant_ht from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=1;";
			$result_ht = _graal_requete_bd($sql_req_ht_marchandise_ht);
			$row_ht = mysql_fetch_assoc($result_ht);
			$total_ht=$row_ht['montant_ht'];
			_graal_libere_requete_bd($result_ht);
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['genre']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_qui));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['priorite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['statut']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($dd));$j++;

		    $worksheet->write($vl_e_noligne, $j, utf8_decode($hd));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_sujet));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['$reference']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheurecreation']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['representant']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($total_ht));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		break;
	case "excel_02":	//	Export factures TTC
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib("Div_00593",$vl_e_uti_cleunik);

		$vl_c_bem_034=fa_recup_dico("bem_034");
		$vl_c_bem_035=fa_recup_dico("bem_035");
		$vl_c_bem_036=fa_recup_dico("bem_036");
		$vl_c_bem_037=fa_recup_dico("bem_037");
		$vl_c_bem_040=fa_recup_dico("bem_040");
		$vl_c_bem_041=fa_recup_dico("bem_041");
		$vl_c_bem_042=fa_recup_dico("bem_042");
		$vl_c_bem_043=fa_recup_dico("bem_043");
		$vl_c_bem_044=fa_recup_dico("bem_044");
		$vl_c_bem_053=fa_recup_dico("bem_053");
		$vl_c_bem_054=fa_recup_dico("bem_054");
		$vl_c_bem_055=fa_recup_dico("bem_055");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Documents TTC"));
		$j=0;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_034"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_035"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_042"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_040"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_041"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_036"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_037"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_043"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_044"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_053"));$j++;
		//$worksheet->write(0, $j, utf8_decode("$vl_c_bem_054"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_055"));$j++;
		$vl_e_noligne=1;
		$result = _graal_requete_bd($sql_req_finale);
		while ($row = mysql_fetch_assoc($result)) {
			$vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);
			if ($vl_e_trouve===false) {
				$vl_c_qui="";
			} else {
				$vl_c_qui=$qui_dat[$vl_e_trouve];
			}
		    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
		    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
		    $hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
		    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
		    $vl_c_sujet=fa_ent_xml($row['sujet']);
			//$vl_c_sujet = preg_replace('/^\W+|\W+$/', '', $vl_c_sujet);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
			$sql_req_ttc_doc="select sum(montant) as montant_ttc from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=0;";
			$result_ht = _graal_requete_bd($sql_req_ttc_doc);
			$row_ht = mysql_fetch_assoc($result_ht);
			$total_ht=$row_ht['montant_ttc'];
			_graal_libere_requete_bd($result_ht);
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['genre']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_qui));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['priorite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['statut']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($dd));$j++;

		    $worksheet->write($vl_e_noligne, $j, utf8_decode($hd));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_sujet));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['$reference']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheurecreation']));$j++;
		    //$worksheet->write($vl_e_noligne, $j, utf8_decode($row['representant']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($total_ht));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		break;
	case "excel_03":	//	Export factures HT
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib("Div_00593",$vl_e_uti_cleunik);

		$vl_c_bem_034=fa_recup_dico("bem_034");
		$vl_c_bem_035=fa_recup_dico("bem_035");
		$vl_c_bem_036=fa_recup_dico("bem_036");
		$vl_c_bem_037=fa_recup_dico("bem_037");
		$vl_c_bem_040=fa_recup_dico("bem_040");
		$vl_c_bem_041=fa_recup_dico("bem_041");
		$vl_c_bem_042=fa_recup_dico("bem_042");
		$vl_c_bem_043=fa_recup_dico("bem_043");
		$vl_c_bem_044=fa_recup_dico("bem_044");
		$vl_c_bem_053=fa_recup_dico("bem_053");
		$vl_c_bem_054=fa_recup_dico("bem_054");
		$vl_c_bem_055=fa_recup_dico("bem_055");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Documents HT"));
		$j=0;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_034"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_035"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_042"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_040"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_041"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_036"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_037"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_043"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_044"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_053"));$j++;
		//$worksheet->write(0, $j, utf8_decode("$vl_c_bem_054"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_055"));$j++;
		$vl_e_noligne=1;
		$result = _graal_requete_bd($sql_req_finale);
		while ($row = mysql_fetch_assoc($result)) {
			$vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);
			if ($vl_e_trouve===false) {
				$vl_c_qui="";
			} else {
				$vl_c_qui=$qui_dat[$vl_e_trouve];
			}
		    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
		    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
		    $hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
		    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
		    $vl_c_sujet=fa_ent_xml($row['sujet']);
			//$vl_c_sujet = preg_replace('/^\W+|\W+$/', '', $vl_c_sujet);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
			$sql_req_ttc_doc="select sum(montant) as montant_ht from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=1;";
			$result_ht = _graal_requete_bd($sql_req_ttc_doc);
			$row_ht = mysql_fetch_assoc($result_ht);
			$total_ht=$row_ht['montant_ht'];
			_graal_libere_requete_bd($result_ht);
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['genre']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_qui));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['priorite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['statut']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($dd));$j++;

		    $worksheet->write($vl_e_noligne, $j, utf8_decode($hd));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_sujet));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['$reference']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheurecreation']));$j++;
		    //$worksheet->write($vl_e_noligne, $j, utf8_decode($row['representant']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($total_ht));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		break;
	case "excel_04":	//	Export factures et avoirs clients HT et TTC
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib("Div_00593",$vl_e_uti_cleunik);

		$vl_c_bem_034=fa_recup_dico("bem_034");
		$vl_c_bem_035=fa_recup_dico("bem_035");
		$vl_c_bem_036=fa_recup_dico("bem_036");
		$vl_c_bem_037=fa_recup_dico("bem_037");
		$vl_c_bem_040=fa_recup_dico("bem_040");
		$vl_c_bem_041=fa_recup_dico("bem_041");
		$vl_c_bem_042=fa_recup_dico("bem_042");
		$vl_c_bem_043=fa_recup_dico("bem_043");
		$vl_c_bem_044=fa_recup_dico("bem_044");
		$vl_c_bem_053=fa_recup_dico("bem_053");
		$vl_c_bem_054=fa_recup_dico("bem_054");
		$vl_c_bem_055=fa_recup_dico("bem_055");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Factures par client par période"));
		$j=0;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_042"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_036"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_043"));$j++;
		$worksheet->write(0, $j, utf8_decode("$vl_c_bem_044"));$j++;
		$worksheet->write(0, $j, utf8_decode("HT"));$j++;
		$worksheet->write(0, $j, utf8_decode("TTC"));$j++;
		$vl_e_noligne=1;
		$result = _graal_requete_bd($sql_req_finale);
		while ($row = mysql_fetch_assoc($result)) {
			$vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);
			if ($vl_e_trouve===false) {
				$vl_c_qui="";
			} else {
				$vl_c_qui=$qui_dat[$vl_e_trouve];
			}
		    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
		    $vl_c_sujet=fa_ent_xml($row['sujet']);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
			$sql_req_ttc_doc="select sum(montant) as montant_ht from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=1;";
			$result_ht = _graal_requete_bd($sql_req_ttc_doc);
			$row_ht = mysql_fetch_assoc($result_ht);
			$total_ht=$row_ht['montant_ht'];
			_graal_libere_requete_bd($result_ht);
			$sql_req_ttc_doc="select sum(montant) as montant_ttc from _docciaux_montants where action_cleunik=".$row['action_cleunik']." and type=0;";
			$result_ht = _graal_requete_bd($sql_req_ttc_doc);
			$row_ht = mysql_fetch_assoc($result_ht);
			$total_ttc=$row_ht['montant_ttc'];
			_graal_libere_requete_bd($result_ht);
			$j=0;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_qui));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($dd));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($vl_c_sujet));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['$reference']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($total_ht));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($total_ttc));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		break;


	}
} else {
	echo('<?xml version="1.0" encoding="UTF-8"?><donnees>');
	echo('</donnees>');
}
_graal_ferme_connexion();
function pf_cherche_nombre_ligne_cdecli($action_cleunik){
	$sql_req="select count(*) as nombre from _cdecli_lignes h1 left join _cdecli_lignes_qte h2 using(commercial_ligne_cleunik) join _cdecli_entetes h3 on ";
	$sql_req.=" h1.commercial_cleunik=h3.commercial_cleunik where h3.action_cleunik=$action_cleunik and h2.statut <> -39;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$nombre_cdecli_pas_termine=$row['nombre'];
	_graal_libere_requete_bd($result);
	return $nombre_cdecli_pas_termine;
}
function pf_cherche_nombre_ligne_livcli($action_cleunik){
	$sql_req ="select count(*) as nombre from _livcli_lignes h1 left join _livcli_lignes_qte h2 using(commercial_ligne_cleunik) join _livcli_entetes h3 on";
	$sql_req.=" h1.commercial_cleunik=h3.commercial_cleunik where h3.action_cleunik=$action_cleunik and h2.statut <> -39;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$nombre_livcli_pas_termine=$row['nombre'];
	_graal_libere_requete_bd($result);
	return $nombre_livcli_pas_termine;
}
function pf_cherche_nombre_ligne_recfou($action_cleunik){
	$sql_req="select count(*) as nombre from _recfou_lignes h1 left join _recfou_lignes_qte h2 using(commercial_ligne_cleunik) join _recfou_entetes h3";
	$sql_req.=" on h1.commercial_cleunik=h3.commercial_cleunik where h3.action_cleunik=$action_cleunik and h2.statut <> -39;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$nombre_recfou_pas_termine=$row['nombre'];
	_graal_libere_requete_bd($result);
	return $nombre_recfou_pas_termine;
}
function pf_cherche_nombre_ligne_retfou($action_cleunik){
	$sql_req="select count(*) as nombre from _retfou_lignes h1 left join _retfou_lignes_qte h2 using(commercial_ligne_cleunik) join _retfou_entetes h3";
	$sql_req.=" on h1.commercial_cleunik=h3.commercial_cleunik where h3.action_cleunik=$action_cleunik and h2.statut <> -39;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$nombre_retfou_pas_termine=$row['nombre'];
	_graal_libere_requete_bd($result);
	return $nombre_retfou_pas_termine;
}
function pf_verif_particularisme($vl_c_particularisme,$action_cleunik){
	switch ($vl_c_particularisme){
		case 3://	Commandes client expédiables
			if (pf_cherche_nombre_ligne_cdecli($action_cleunik)<>0) {
				$vl_b_insere="ok";
			} else {
				$vl_b_insere="";
			}
			break;
		case 4://	Livraisons client facturables
			if (pf_cherche_nombre_ligne_livcli($action_cleunik)<>0) {
				$vl_b_insere="ok";
			} else {
				$vl_b_insere="";
			}
			break;
		case 5://	Factures client comptabilisables
			$vl_b_insere="ok";
			break;
		case 6://	Factures client comptabilisées
			$vl_b_insere="ok";
			break;
		case 7://	avoirs client comptabilisables
			$vl_b_insere="ok";
			break;
		case 8://	Avoirs client comptabilisées
			$vl_b_insere="ok";
			break;
		case 9://	factures fournisseur comptabilisables
			$vl_b_insere="ok";
			break;
		case 10://	factures fournisseur comptabilisées
			$vl_b_insere="ok";
			break;
		case 11://	Réceptions fournisseurs facturables
			if (pf_cherche_nombre_ligne_recfou($action_cleunik)<>0) {
				$vl_b_insere="ok";
			} else {
				$vl_b_insere="";
			}
			break;
		case 12://	Factures avec plusieurs BL
			$vl_b_insere="ok";
			break;
		case 15://	Bons de retours fournisseurs facturables (avoirs)
			if (pf_cherche_nombre_ligne_retfou($action_cleunik)<>0) {
				$vl_b_insere="ok";
			} else {
				$vl_b_insere="";
			}
			break;
		case 16://	avoirs fournisseur comptabilisables
			$vl_b_insere="ok";
			break;
		case 17://	avoirs fournisseur comptabilisées
			$vl_b_insere="ok";
			break;
		default:
			$vl_b_insere="ok";
			break;
	}
	return $vl_b_insere;
}
?>
