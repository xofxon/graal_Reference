<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
define('EOL', "\r\n");
set_time_limit(6000);
echo(date("D M j G:i:s T Y").EOL);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
echo "Début lecture 1".EOL;
$art_cod=array();$art_cle=array();
$cat_cod=array();$cat_cle=array();
$cpc_cod=array();$cpc_cle=array();
$tax_cod=array();$tax_cle=array();
$tpf_cod=array();$tpf_cle=array();
$sql_req="select catcompta_cleunik,code from _param_categories_compta where code in(select distinct(Categorie) from $vl_c_base_origine.articlecompta);";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($cat_cod, $row['code']);
  array_push ($cat_cle, $row['catcompta_cleunik']);
}
_graal_libere_requete_bd($result); 
echo(date("D M j G:i:s T Y").EOL);
echo "Début lecture 2".EOL;
$sql_req="select distinct(Compte) from $vl_c_base_origine.articlecompta;";
$result = _graal_requete_bd($sql_req);
$liste_compte="";
while ($row = mysql_fetch_assoc($result)) {
	$liste_compte.=$row['Compte'].",";
}
_graal_libere_requete_bd($result);
if ($liste_compte!=""){
	$liste_compte=substr($liste_compte, 0, -1);
}
$sql_req="select pc_cleunik,code from _param_pc where code in($liste_compte);";
//echo $sql_req.EOL;
//$sql_req="select pc_cleunik,code from _param_pc where code in(select distinct(Compte) from $vl_c_base_origine.articlecompta where Tpf1<>'' limit 10);";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($cpc_cod, $row['code']);
  array_push ($cpc_cle, $row['pc_cleunik']);
}
_graal_libere_requete_bd($result);
//var_dump($cpc_cod);
//die();
echo(date("D M j G:i:s T Y").EOL);
echo "Début lecture 3".EOL;
$sql_req="select taxes_cleunik,code from _param_taxes where code in(select distinct(Tva) from $vl_c_base_origine.articlecompta);";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($tax_cod, $row['code']);
  array_push ($tax_cle, $row['taxes_cleunik']);
}
_graal_libere_requete_bd($result);
echo "Début lecture 4".EOL;
$sql_req="select tpf_cleunik,code from _param_tpf where code in(select distinct(Tpf1) from $vl_c_base_origine.articlecompta);";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($tpf_cod, $row['code']);
  array_push ($tpf_cle, $row['tpf_cleunik']);
}
_graal_libere_requete_bd($result);
echo(date("D M j G:i:s T Y").EOL);
echo $sql_req.EOL;
//var_dump($tpf_cod);
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(CodeArticle) from $vl_c_base_origine.articlecompta)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);
$o_compta=new _graal_import();
$o_compta->req="INSERT INTO $vl_c_base_destination._art_compta (art_cleunik,catcompta_cleunik,pc_cleunik_vente,pc_cleunik_achat,taxes_cleunik,tpf_cleunik) VALUES ";
$sql_req = "SELECT TypeCategorie,CodeArticle,Categorie,Compte,Tva,Tpf1 FROM $vl_c_base_origine.articlecompta where CodeArticle in ( select code from $vl_c_base_destination._article a1 where (select count(*) from $vl_c_base_destination._art_compta a2 where a1.art_cleunik=a2.art_cleunik)=0 ) order by CodeArticle,Categorie,TypeCategorie;";
//$sql_req="SELECT TypeCategorie,CodeArticle,Categorie,Compte,Tva,Tpf1 FROM apisoft_fla_gc.articlecompta where CodeArticle in ( select code from graal_frla._article a1 where (select count(*) from graal_frla._art_compta a2 where a1.art_cleunik=a2.art_cleunik)=0 and Tpf1<>'' ) order by CodeArticle,Categorie,TypeCategorie limit 100;";
echo $sql_req.EOL;
//exit();
$result=_graal_requete_bd($sql_req);
$i=0;$b=5000;$j=0;
while ($row = mysql_fetch_assoc($result)) {
  if ($j!=0) {
    if ($CodeArticle_precedent!=$row['CodeArticle'] || $Categorie_precedent!=$row['Categorie']) {
    	if ($art_cleunik!=0) {
    		$o_compta->dat.="($art_cleunik,$catcompta_cleunik,$pc_cleunik_vente,$pc_cleunik_achat,$taxes_cleunik,$tpf_cleunik),";
      		$i++;
    	}	
    }
  }
  $j++;
  $CodeArticle_precedent=$row['CodeArticle'];
  $Categorie_precedent=$row['Categorie'];
  $vl_e_trouve=array_search($row['CodeArticle'], $art_cod);if ($vl_e_trouve===false) {$art_cleunik=0;} else {$art_cleunik=$art_cle[$vl_e_trouve];}
  if ($art_cleunik!=0) {
    $vl_e_trouve=array_search($row['Categorie'], $cat_cod);if ($vl_e_trouve===false) {$catcompta_cleunik=0;} else {$catcompta_cleunik=$cat_cle[$vl_e_trouve];}
    if ($catcompta_cleunik!=0) {
      $vl_e_trouve=array_search($row['Compte'], $cpc_cod);if ($vl_e_trouve===false) {$pc_cleunik=0;} else {$pc_cleunik=$cpc_cle[$vl_e_trouve];}
      $vl_e_trouve=array_search($row['Tva'], $tax_cod);if ($vl_e_trouve===false) {$taxes_cleunik=-1;} else {$taxes_cleunik=$tax_cle[$vl_e_trouve];}
      $vl_e_trouve=array_search($row['Tpf1'], $tpf_cod);if ($vl_e_trouve===false) {$tpf_cleunik=-1;} else {$tpf_cleunik=$tpf_cle[$vl_e_trouve];}
      if ($pc_cleunik!=0) {
        switch ($row['TypeCategorie']) {
          case 'A':$pc_cleunik_achat=$pc_cleunik;break;
          case 'V':$pc_cleunik_vente=$pc_cleunik;break;
        }
      }
    }
  }
  if ($j % $b==0){
  	echo $j;
  	echo $o_compta->req.$o_compta->dat.EOL;
    $o_compta->execute();
  }
}
if ($j!=0) {
	if ($art_cleunik!=0) {
    	$o_compta->dat.="($art_cleunik,$catcompta_cleunik,$pc_cleunik_vente,$pc_cleunik_achat,$taxes_cleunik,$tpf_cleunik),";
      	$i++;
    }	
}
echo "************".EOL;
echo $o_compta->req.$o_compta->dat.EOL;
echo "************".EOL;
$o_compta->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($i.' enregistrements ajoutés.'.EOL);
echo(date("D M j G:i:s T Y").EOL);
?>
