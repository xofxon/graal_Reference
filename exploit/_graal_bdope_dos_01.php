<?php 
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_dossier_01";
fa_acces_script();
$vf_c_action=fa_recup_param('vf_c_action','??????');
$vf_e_doc_cleunik=intval(fa_recup_param('vf_e_doc_cleunik','0'));
$vf_c_emplacement=fa_recup_param('vf_c_emplacement','');
$vf_c_titre=fa_recup_param('vf_c_titre','');
$vf_c_descriptif_sommaire=fa_recup_param('vf_c_descriptif_sommaire','');
$vf_c_dossier=fa_recup_param('vf_c_dossier','');
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vf_e_typedoc=4;   //  le 8 mai 2008 : typedoc -> //  1 -> Liens 2 -> Notes, 3-> Documents, 4-> Dossier, 5 -> courriels envoyés, 6 -> modèles de courriels texte,7->Flux RSS, 8 -> requêtes personnelles,9 -> images,10 -> modèles de courriels HTML, 11 -> modèles de notes,12 -> modèles de notification de lecture, 13 -> Pièces jointes de courriels
  /*  1 -> Propriétaire, 2 -> Lecture, 4 -> Modification -> 8 -> Suppression */
$droits_proprio=1+2+4+8;
$droits_groupe=0;
$droits_lambda=0;
$vf_c_echo='';
switch (TRUE) {
  case $vf_c_action=='??????':
    exit;
    break;    
  case $vf_c_action=='verifier_droits_acces':   //  Vérification que l'utilisateur a bien accès à la note 
    $sql_req = "select count(*) FROM _droits_doc WHERE doc_cleunik=$vf_e_doc_cleunik and uti_cleunik=$vl_e_uti_cleunik";
  if ($res = _graal_requete_bd($sql_req))
   {
    if($ligne = mysql_fetch_row($res))
    {
        $nombre_doc=$ligne[0];
        if (is_null($nombre_doc))
        { $vf_c_echo= '0'; }
        else
          $vf_c_echo=$nombre_doc;
    }
    else
      $vf_c_echo=$nombre_doc;
   }
    else
      $vf_c_echo=mysql_error($cnx) . $sql_req;
    echo $vf_c_echo;
    exit;
    break;
  case $vf_c_action=='verifier_nom':  //  Vérification que le titre de la note n'existe pas ( avec le type 2 -> note) 
{
    $sql_req = "select count(*) FROM _documents WHERE typedoc=$vf_e_typedoc and titre ='$vf_c_titre'";
  if ($res = _graal_requete_bd($sql_req))
   {
    if($ligne = mysql_fetch_row($res))
    {
        $nombre_doc=$ligne[0];
        if (is_null($nombre_doc))
        {
          $vf_c_echo= '0';
        }
        else
          $vf_c_echo=$nombre_doc;
    }
    else
      $vf_c_echo=$nombre_doc;
   }
    else
      $vf_c_echo=mysql_error($cnx) . $sql_req;
    exit($vf_c_echo);
    break;
}
  case $vf_c_action=='supprimer': //  Suppression d'un document 
    $sql_req = "DELETE FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik";
    break;
  case $vf_c_action=='ajouter': //  Ajout d'un document
    $vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
    $sql_req = "INSERT INTO _documents set doc_cleunik=$vf_e_doc_cleunik,typedoc=$vf_e_typedoc,titre = '$vf_c_titre',dateheurecreation = now(),descriptif_sommaire='$vf_c_descriptif_sommaire',blocnote_riche ='$vf_c_dossier',emplacement='$vf_c_emplacement';";
    break;
  case $vf_c_action=='modifier':  //  Modification d'un document
    $sql_req = "update _documents set titre='$vf_c_titre.',descriptif_sommaire='$vf_c_descriptif_sommaire',blocnote_riche='$vf_c_dossier',dateheuremodif = now(),emplacement='$vf_c_emplacement' where doc_cleunik=$vf_e_doc_cleunik";
    break;
}
//  Traitement de la requête
{
  {
   $res = _graal_requete_bd($sql_req);
      if($res === false)
         echo 'Erreur';
      else
         $vf_c_echo='ok';
         $vf_c_echo=$sql_req;         
  }
 // On continue les traitements particuliers
 switch (TRUE) {
  case $vf_c_action=='ajouter':     //  Insertion dans liaisons droits documents
    $sql_req = "INSERT INTO _droits_doc set doc_cleunik=$vf_e_doc_cleunik,uti_cleunik=$vl_e_uti_cleunik,droits_proprio=$droits_proprio,droits_groupe =$droits_groupe,droits_lambda =$droits_lambda";
    $vf_c_echo=_graal_exec_requete($sql_req);
    $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
} 
  _graal_ferme_connexion();
  echo $vf_c_echo;       
}
?>
