<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_fla_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_frla');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','client');
$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_fax_defaut=intval(fa_recup_param('vl_e_fax_defaut','-10'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_fax_defaut=intval(fa_recup_param('vl_e_indicatif_fax_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vl_e_genre_acteur_defaut=intval(fa_recup_param('vl_e_genre_acteur_defaut','-5'));
$vl_e_critere_cleunik_secteur_geo=intval(fa_recup_param('vl_e_critere_cleunik_secteur_geo','0'));
$vl_e_critere_cleunik_famille=intval(fa_recup_param('vl_e_critere_cleunik_famille','0'));
$vl_e_critere_cleunik_site=intval(fa_recup_param('vl_e_critere_cleunik_site','-12'));
$vl_b_silencieux=intval(fa_recup_param('vl_b_silencieux','1'));
$vl_b_compta=intval(fa_recup_param('$vl_b_compta','1'));
$vl_c_embraye=fa_recup_param("vl_c_embraye","");
$vl_e_critere_cleunik_tarcli=101;
include("_import_apisoft_sp_array_pays.php");
include("_import_apisoft_sp_array_devises.php");
include("_import_apisoft_sp_array_compta.php");
include("_import_apisoft_sp_array_tarifs_cli.php");
include("_import_apisoft_sp_array_geo.php");
include("_import_apisoft_sp_array_fam.php");
include("_import_apisoft_sp_array_representants.php");
include("_import_apisoft_sp_array_transporteurs.php");
switch ($vl_c_fic_tiers){
  case "client":
    $vf_e_typeacteur=110003;
    break;
  case "prospect":
    break;
}
include("_import_apisoft_sp_array_tiers.php");
include("_import_class_data_km.php");
$sql_req = "SELECT Code as 'Code',FacNom as 'FacNom',FacCivilite as 'FacCivilite',FacAdr as 'FacAdr',FacSuiteAdr as 'FacSuiteAdr',FacCp as 'FacCp',FacVille as 'FacVille',";
$sql_req.= " FacPays as 'FacPays',FacTel as 'FacTel',FacFax as 'FacFax',FacPortable as 'FacPortable',FacEMail as 'FacEMail',FacInterloc as 'FacInterloc',LivNom as 'LivNom',";
$sql_req.= " LivCivilite as 'LivCivilite',LivAdr as 'LivAdr',LivSuiteAdr as 'LivSuiteAdr',LivCp as 'LivCp',LivVille as 'LivVille',LivPays as 'LivPays',LivTel as 'LivTel',";
$sql_req.= " LivFax as 'LivFax',LivPortable as 'LivPortable',LivEMail as 'LivEMail',LivInterloc as 'LivInterloc',ModeReg as 'ModeReg',Domiciliation as 'Domiciliation',";
$sql_req.= " Etablissement as 'Etablissement',Guichet as 'Guichet',CompteBanque as 'CompteBanque',CleRib as 'CleRib',Memo as 'Memo',Compte as 'Compte',Identification as 'Identification',";
$sql_req.= " CategorieVente as 'CategorieVente',SecteurGeo as 'SecteurGeo',FamilleClient as 'FamilleClient',Representant as 'Representant',PEscompte as 'PEscompte',PRemise as 'PRemise',";
$sql_req.= " 1BLParFacture as '1BLParFacture',1CdeParFacture as '1CdeParFacture',ExclureRelance as 'ExclureRelance',AssujettiTPF as 'AssujettiTPF',CompteBloque as 'CompteBloque',";
$sql_req.= " NParamDevis as 'NParamDevis',NParamCde as 'NParamCde',NParamBL as 'NParamBL',NParamBR as 'NParamBR',NParamFacture as 'NParamFacture',NExDevis as 'NExDevis',";
$sql_req.= " NExCde as 'NExCde',NExBL as 'NExBL',NExBR as 'NExBR',NExFacture as 'NExFacture',TypeTarif as 'TypeTarif',Releve as 'Releve',Ca as 'Ca',DateCreation as 'DateCreation',";
$sql_req.= " DateModification as 'DateModification',Solde as 'Solde',EncoursAutorise as 'EncoursAutorise',Depot as 'Depot',FraisFacturation as 'FraisFacturation',";
$sql_req.= " Periodicite as 'Periodicite',Devise as 'Devise',Dossier as 'Dossier',MontantPort as 'MontantPort',Caisse_CA_Ht as 'Caisse_CA_Ht',Caisse_CA_HtRemise as 'Caisse_CA_HtRemise',";
$sql_req.= " Caisse_CA_TTC as 'Caisse_CA_TTC',Transporteur as 'Transporteur',Franco as 'Franco',FacSiteInternet as 'FacSiteInternet',LivSiteInternet as 'LivSiteInternet',";
$sql_req.= " BIC as 'BIC',IBAN as 'IBAN' FROM $vl_c_base_origine.$vl_c_fic_tiers";
$vl_c_condition_client="";
if (isset($_SESSION['vl_c_condition_client'])){
	$vl_c_condition_client=$_SESSION['vl_c_condition_client'];
	$sql_req.=" where Code in($vl_c_condition_client) ";
}
$sql_req.= " order by Code";
//$sql_req.=" Limit 10";
//echo $sql_req;
//die("$sql_req");
$result = _graal_requete_bd($sql_req);



$o_acteur=new _graal_import();
$o_compta=new _graal_import();
$o_choix=new _graal_import();
$o_adresses=new _graal_import();
$o_rib=new _graal_import();
$o_interlo=new _graal_import();
$o_web=new _graal_import();
$o_fax=new _graal_import();
$o_tel=new _graal_import();
$o_rep=new _graal_import();
$o_relation=new _graal_import();
$o_fonction=new _graal_import();
$o_sit=new _graal_import();
$o_acteur->req="INSERT INTO $vl_c_base_destination._acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,blocnotebrut,blocnotertf,dateheuremodif,dateheurecreation,typeacteur,c_uuid,mnemotechnique,devise) VALUES ";
//  Attention, mode de règlement traité plus bas
$o_compta->req="INSERT INTO $vl_c_base_destination._act_compta (act_cleunik,compte,tvaintracommunautaire,catcompta_cleunik,encours_autorise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,assujetti_tpf,montant_port,seuil_franco) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_adresses (adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_rib->req="INSERT INTO $vl_c_base_destination._act_rib (rib_cleunik,Domiciliation,Etablissement,Guichet,Compte,Cle,act_cleunik,Principal) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik) VALUES ";
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_fax->req="INSERT INTO $vl_c_base_destination._act_interlo_fax (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik,portable,sms) VALUES ";
$o_rep->req="INSERT INTO $vl_c_base_destination._acteurs_representants (act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_relation->req="INSERT INTO $vl_c_base_destination._acteurs_relations(act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_fonction->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$o_sit->req="INSERT INTO $vl_c_base_destination._act_sites(site_cleunik,refweb,act_cleunik,choix_cleunik) VALUES ";
$vf_e_act_cleunik=_graal_requete_max("act_cleunik","$vl_c_base_destination._acteurs");
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_adresses");
$vf_e_rib_cleunik=_graal_requete_max("rib_cleunik","$vl_c_base_destination._act_rib");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_fax_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_fax");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$vf_e_sit_cleunik=_graal_requete_max("site_cleunik","$vl_c_base_destination._act_sites");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
session_write_close();
//if (1==2){
while ($row = mysql_fetch_assoc($result)) {
	$vl_e_trouve_acteur=array_search($row['Code'], $acteur_cod);
	//die ("Trouvé ".$row['Code']);
	if ($vl_e_trouve_acteur===false) {
		//die ("pas trouvé ".$row['Code']);
	//  Ajout dans la table des acteurs
	  $vl_e_trouve_devise=array_search($row['Devise'], $devise_cod);if ($vl_e_trouve_devise===false) {$devise=122047;} else {$devise=$devise_cle[$vl_e_trouve_devise];}
	  $vf_e_act_cleunik++;
	  $i++;
	  $codealphanum15=$row['Code'];
	  $raisonsoc=addslashes($row['FacNom']);
	  $nomcommercial=addslashes($row['FacNom']);
	  $blocnotebrut=addslashes($row['Memo']);
	  $blocnotertf=addslashes($row['Memo']);
	  $dateheuremodif=fa_nt($row['DateModification']);
	  $dateheurecreation=$row['DateCreation'];
	  $typeacteur=$vf_e_typeacteur;
	  $uuid=_graal_requete_uuid();
	  $mnemotechnique=addslashes($row['Codealpha']);
	  $o_acteur->dat.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial','$blocnotebrut','$blocnotertf',$dateheuremodif,'$dateheurecreation',$typeacteur,'$uuid','$mnemotechnique',$devise),";
		//die($o_acteur->req.$o_acteur->dat);
	/*
	//  Ajout dans la table des _acteurs_soundex_fr pour la recherche phonétique française
	//  Ne fonctionne pas !!!! à fouiller
	  $sql_req_ins = "INSERT INTO _acteurs_soundex_fr set act_cleunik=$vf_e_act_cleunik,raisonsoc='".soundex2($row['raisonsoc']) ."',nomcommercial='".soundex2($row['nomcommercial'])."'";
	  $result_ins = _graal_requete_bd($sql_req_ins);
	  if($result_ins === false)
	  {
	      $vf_c_echo=mysql_error($cnx) . $sql_req_ins;
	  }
	    else
	      $vf_c_echo='ok';
	*/
	  //  Alimentation Informations comptables acteur
	  $vl_e_trouve_compta=array_search($row['CategorieVente'], $compta_cod);if ($vl_e_trouve_compta===false) {$vl_e_catcompta_cleunik=-1;} else {$vl_e_catcompta_cleunik=$compta_cle[$vl_e_trouve_compta];}
	  $vl_e_trouve_tarcli=array_search($row['TypeTarif'], $tarcli_cod);if ($vl_e_trouve_tarcli===false) {$vl_e_tarif_cleunik=-31;} else {$vl_e_tarif_cleunik=$tarcli_cle[$vl_e_trouve_tarcli];}
	  $compte=$row['Compte'];
	  $tvaintracommunautaire=addslashes($row['Identification']);
	  $encours_autorise=fa_nn($row['EncoursAutorise']);
	  $remise_taux=fa_nn($row['PRemise']);
	  $escompte_taux=fa_nn($row['PEscompte']);
	  $assujetti_tpf=fa_nn($row['AssujettiTPF']);
	if ($assujetti_tpf==-1){$assujetti_tpf=1;} else {$assujetti_tpf=2;}
		$montant_port=fa_nn($row['MontantPort']);
	  $seuil_franco=fa_nn($row['Franco']);
	  $o_compta->dat.="($vf_e_act_cleunik,'$compte','$tvaintracommunautaire',$vl_e_catcompta_cleunik,$encours_autorise,$vl_e_tarif_cleunik,$remise_taux,1,2,$escompte_taux,1,1,$assujetti_tpf,$montant_port,$seuil_franco),";
	  //  Alimentation des critères
	  if ($vl_e_critere_cleunik_secteur_geo!=0){
	  	if ($row['SecteurGeo']!=""){
		    $vl_e_trouve_geo=array_search($row['SecteurGeo'], $geo_cod);if ($vl_e_trouve_geo===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$geo_cle[$vl_e_trouve_geo];}
		    if ($vl_e_choix_cleunik!=0) {
		      //  Alimentation des secteurs géographiques
		      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik_secteur_geo,$vf_e_typeacteur),";
		    }
	  	}
	  }
	  if ($vl_e_critere_cleunik_famille!=0){
	    $vl_e_trouve_fam=array_search($row['FamilleClient'], $fam_cod);if ($vl_e_trouve_fam===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$fam_cle[$vl_e_trouve_fam];}
	    if ($vl_e_choix_cleunik!=0) {
	      //  Alimentation des familles clients
	      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik_famille,$vf_e_typeacteur),";
	    }
	  }
	  //  Alimentation Genre d'acteur
	  $o_choix->dat.="($vf_e_act_cleunik,$vl_e_genre_acteur_defaut,80,$vf_e_typeacteur),";
	  //  Liaison avec le représentant
	  $vl_e_trouve_rep=array_search($row['Representant'], $rep_cod);if ($vl_e_trouve_rep===false) {$act_cleunik_droite=0;} else {$act_cleunik_droite=$rep_cle[$vl_e_trouve_rep];}
	  if ($act_cleunik_droite!=0) {
	    //  Alimentation des relations représentant
	    $o_rep->dat.="($vf_e_act_cleunik,-28,-27,$act_cleunik_droite),";
	  }
	  //  Liaison avec le transporteur
	  $vl_e_trouve_trans=array_search($row['Transporteur'], $trans_cod);if ($vl_e_trouve_trans===false) {$act_cleunik_droite=0;} else {$act_cleunik_droite=$trans_cle[$vl_e_trouve_trans];}
	  if ($act_cleunik_droite!=0) {
	    //  Alimentation des transporteurs
	    $o_relation->dat.="($vf_e_act_cleunik,-30,-29,$act_cleunik_droite),";
	  }

	//  Ajout dans la table des _act_adresses (adresses au format français) des adresses de facturation
	  $vl_c_chainefac=trim($row['FacNom'].$row['FacAdr'].$row['FacSuiteAdr'].$row['FacCp'].$row['FacVille']);
	  $vl_c_chaineliv=trim($row['LivNom'].$row['LivAdr'].$row['LivSuiteAdr'].$row['LivCp'].$row['LivVille']);
	  //  On ajoute uniquement si l'adresse est un minimum renseignée
	  if ($vl_c_chainefac!="") {
	    $vl_e_trouve=array_search($row['FacPays'], $pays_cod);if ($vl_e_trouve===false) {$vl_e_cleunik_pays=60000;} else {$vl_e_cleunik_pays=$pays_cle[$vl_e_trouve];}
	    $vf_e_adr_cleunik++;
	    $adr_complementnom=addslashes($row['FacNom']);
	    $adr_ligne1=addslashes($row['FacAdr']);
	    $adr_ligne2=addslashes($row['FacSuiteAdr']);
	    $adr_cp=addslashes($row['FacCp']);
	    $adr_ville=addslashes($row['FacVille']);
	    if ($vl_c_chainefac==$vl_c_chaineliv){
	    	$adr_typecoordonnees=3;
	    	$vl_c_chaineliv="";
	    } else {
	    	$adr_typecoordonnees=1;
	    }
	    $o_adresses->dat.="($vf_e_adr_cleunik,'Fac01',$vf_e_act_cleunik,'$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_cp','$adr_ville',$vl_e_cleunik_pays,$adr_typecoordonnees),";
	    //echo ($o_adresses->req.$o_adresses->dat);
	    //exit();
	  }
	//  Ajout dans la table des _act_adresses (adresses au format français) des adresses de livraison
	  //  On ajoute uniquement si l'adresse est un minimum renseignée
	  if ($vl_c_chaineliv!=""){
	    $vl_e_trouve=array_search($row['LivPays'], $pays_cod);if ($vl_e_trouve===false) {$vl_e_cleunik_pays=60000;} else {$vl_e_cleunik_pays=$pays_cle[$vl_e_trouve];}
	    $vf_e_adr_cleunik++;
	    $adr_complementnom=addslashes($row['LivNom']);
	    $adr_ligne1=addslashes($row['LivAdr']);
	    $adr_ligne2=addslashes($row['LivSuiteAdr']);
	    $adr_cp=addslashes($row['LivCp']);
	    $adr_ville=addslashes($row['LivVille']);
	    $o_adresses->dat.="($vf_e_adr_cleunik,'Liv01',$vf_e_act_cleunik,'$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_cp','$adr_ville',$vl_e_cleunik_pays,2),";
	  }
	  //  Ajout dans la table des _act_rib (Relevés d'identité bancaire des acteurs)
	  $vl_c_chaine=trim($row['Domiciliation'].$row['Etablissement'].$row['Guichet'].$row['CompteBanque'].$row['CleRib']);
	  //  On ajoute uniquement si lE rib est un minimum renseigné on ne vérifie pas la viabilité du RIB
	  if ($vl_c_chaine!="") {
	    $vf_e_rib_cleunik++;
	    $Domiciliation=addslashes($row['Domiciliation']);
	    $Etablissement=addslashes($row['Etablissement']);
	    $Guichet=addslashes($row['Guichet']);
	    $Compte=addslashes($row['CompteBanque']);
	    $Cle=addslashes($row['Cle']);
	    $o_rib->dat.="($vf_e_rib_cleunik,'$Domiciliation','$Etablissement','$Guichet','$Compte','$Cle',$vf_e_act_cleunik,1),";
	  }
		$vl_c_chaine=trim($row['LivSiteInternet']);
	    //  On ajoute uniquement si le site de livraison est renseigné
	    if ($vl_c_chaine!=""){
	      $vf_e_sit_cleunik++;
	      $refweb=addslashes($row['LivSiteInternet']);
	      //$o_sit->dat.="($vf_e_sit_cleunik,'$refweb',$vf_e_act_cleunik,$vl_e_critere_cleunik_site),";	//	on a détourné la zone pour le nouvel export expinet : on n'insère plus depusi le 16 septembre 2010
	    }
		$vl_c_chaine=trim($row['FacSiteInternet']);
	    //  On ajoute uniquement si le site de facturation est renseigné
	    if ($vl_c_chaine!=""){
	      $vf_e_sit_cleunik++;
	      $refweb=addslashes($row['FacSiteInternet']);
	      //$o_sit->dat.="($vf_e_sit_cleunik,'$refweb',$vf_e_act_cleunik,$vl_e_critere_cleunik_site),"; 	//	on a détourné la zone pour le nouvel export expinet : on n'insère plus depusi le 16 septembre 2010
	    }
	  //  Ajout dans la table des _act_interlo (Interlocuteurs des acteurs) des interlocuteurs de livraison
	  $vl_c_chaine=trim($row['LivTel'].$row['LivFax'].$row['LivPortable'].$row['LivEMail'].$row['LivInterloc']);
	  $vl_c_liv=$vl_c_chaine;
	  //  On ajoute uniquement si l'interlocuteur de livraison est un minimum renseigné
	  if ($vl_c_chaine!=""){
	    $vf_e_int_cleunik++;
	    $patronyme=addslashes($row['LivInterloc']);
	    $o_interlo->dat.="($vf_e_int_cleunik,'Liv01',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
	    $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,-7,92,$vf_e_typeacteur,0),";
	    $vl_c_chaine=trim($row['LivEMail']);
	    //  On ajoute uniquement si le mail de livraison est renseigné
	    if ($vl_c_chaine!=""){
	      $vf_e_intweb_cleunik++;
	      $refweb=addslashes($row['LivEMail']);
	      $uuid=_graal_requete_uuid();
	      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
	    }
	    $vl_c_chaine=trim($row['LivFax']);
	    //  On ajoute uniquement si le fax de livraison est renseigné
	    if ($vl_c_chaine!=""){
	      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_fax_cleunik++;
	      $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
	    }
	    $vl_c_chaine=trim($row['LivTel']);
	    //  On ajoute uniquement si le téléphone de livraison est renseigné
	    if ($vl_c_chaine!=""){
	      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_tel_cleunik++;
	      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
	    }
	    $vl_c_chaine=trim($row['LivPortable']);
	    //  On ajoute uniquement si le téléphone portable de livraison est renseigné
	    if ($vl_c_chaine!=""){
	      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_tel_cleunik++;
	      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut,2,2),";
	    }
	  }
	  //  Ajout dans la table des _act_interlo (Interlocuteurs des acteurs) des interlocuteurs de facturation
	  $vl_c_chaine=trim($row['FacTel'].$row['FacFax'].$row['FacPortable'].$row['FacEMail'].$row['FacInterloc']);
	  $vl_c_fac=$vl_c_chaine;
	  if ($vl_c_fac==$vl_c_liv) {$vl_c_chaine="";}
	  //  On ajoute uniquement si l'interlocuteur de livraison est un minimum renseigné
	  if ($vl_c_chaine!=""){
	    $vf_e_int_cleunik++;
	    $patronyme=addslashes($row['FacInterloc']);
	    $o_interlo->dat.="($vf_e_int_cleunik,'Fac01',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
	    $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,-7,92,$vf_e_typeacteur,0),";
	    $vl_c_chaine=trim($row['FacEMail']);
	    //  On ajoute uniquement si le mail de facturation est renseigné
	    if ($vl_c_chaine!=""){
	      $vf_e_intweb_cleunik++;
	      $refweb=addslashes($row['FacEMail']);
	      $uuid=_graal_requete_uuid();
	      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
	    }
	    $vl_c_chaine=trim($row['FacFax']);
	    //  On ajoute uniquement si le fax de facturation est renseigné
	    if ($vl_c_chaine!=""){
	      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_fax_cleunik++;
	      $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
	    }
	    $vl_c_chaine=trim($row['FacTel']);
	    //  On ajoute uniquement si le téléphone de facturation est renseigné
	    if ($vl_c_chaine!=""){
	      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_tel_cleunik++;
	      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
	    }
	    $vl_c_chaine=trim($row['FacPortable']);
	    //  On ajoute uniquement si le téléphone portable de facturation est renseigné
	    if ($vl_c_chaine!=""){
	      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_tel_cleunik++;
	      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut,2,2),";
	    }
	  }
	  if ($i % $i1==0){
	    $o_acteur->execute();
	    //echo $o_compta->req.$o_compta->dat;
	    //echo EOL;
	    //echo $o_compta->req.$o_compta->dat;
	    $retour_insert=$o_compta->execute();
	    $o_choix->execute();
	    $o_adresses->execute();
	    $o_rib->execute();
	    $o_interlo->execute();
	    $o_web->execute();
	    $o_fax->execute();
	    $o_tel->execute();
	    $o_rep->execute();
	    $o_sit->execute();
	    $o_relation->execute();
	    $o_fonction->execute();
	  }
	}
}
//echo $o_acteur->req.$o_acteur->dat;
//echo $o_compta->req.$o_compta->dat;
$o_acteur->execute();
$retour_insert=$o_compta->execute();
$o_choix->execute();
$o_adresses->execute();
$o_rib->execute();
$o_interlo->execute();
$o_web->execute();
$o_fax->execute();
$o_tel->execute();
$o_sit->execute();
$o_rep->execute();
$o_relation->execute();
$o_fonction->execute();
$sql_req="update _act_interlo set choix_cleunik=-137 where substring(patronyme,1,3)='Mr ';";_graal_exec_requete($sql_req);
$sql_req="update _act_interlo set patronyme=substring(patronyme from 4) where substring(patronyme,1,3)='Mr ';";_graal_exec_requete($sql_req);
$sql_req="update _act_interlo set choix_cleunik=-139 where substring(patronyme,1,4)='Mme ';";_graal_exec_requete($sql_req);
$sql_req="update _act_interlo set patronyme=substring(patronyme from 5) where substring(patronyme,1,4)='Mme ';";_graal_exec_requete($sql_req);
_graal_libere_requete_bd($result);
if ($vl_b_compta==1){
	$sql_req="update $vl_c_base_destination._act_compta c0,$vl_c_base_destination._modereg c1,$vl_c_base_origine.client c2,$vl_c_base_destination._acteurs c3 set c0.reg_cleunik=c1.reg_cleunik where c1.codealphanum15=c2.ModeReg and c3.codealphanum15=c2.Code and c0.act_cleunik=c3.act_cleunik and c3.typeacteur=$vf_e_typeacteur;"; // maj mode re déglement des clients
	if (trim($vl_c_condition_client)!=""){
		$sql_req.=" and c2.Code in($vl_c_condition_client) ";
	}
	$result = _graal_requete_bd($sql_req);
	//  Mise à jour des comptes comptables
	$sql_req="select compte,raisonsoc,_act_compta.act_cleunik from _act_compta,_acteurs where _act_compta.act_cleunik=_acteurs.act_cleunik and compte is not null and compte <>'' and compte not in (select distinct code from _param_pc)";
	$result = _graal_requete_bd($sql_req);
	//echo $sql_req.EOL;
	while ($row = mysql_fetch_assoc($result)) {
	  $vf_e_pc_cleunik=_graal_requete_max("pc_cleunik","_param_pc");
	  $code=addslashes($row['compte']);
	  $intitule=addslashes($row['raisonsoc']);
	  $act_cleunik=$row['act_cleunik'];
	  $sql_req_02 = "insert into _param_pc (pc_cleunik,code,intitule,actif) VALUES ($vf_e_pc_cleunik,'$code','$intitule',1);";
	  //echo $sql_req_02.EOL;
	  _graal_exec_requete($sql_req_02);
	  $sql_req_03 = "update _act_compta set pc_cleunik=$vf_e_pc_cleunik where act_cleunik=$act_cleunik;";
	  _graal_exec_requete($sql_req_03);
	  //echo $sql_req_03.EOL;
	}
	_graal_libere_requete_bd($result);
	//$sql_req="update _act_compta f1 left join _param_pc f3 on f1.compte=f3.code set f1.pc_cleunik=f3.pc_cleunik;";
	//_graal_exec_requete($sql_req);
}

_graal_ferme_connexion();
if ($vl_b_silencieux==1){
	echo("$i clients importés.");
}
if ($vl_c_embraye!=""){
	header("$vl_c_embraye");
}
?>
