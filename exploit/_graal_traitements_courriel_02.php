<?php
include("_graal_header_xul.inc.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_type=fa_recup_param('type','1');
$vl_c_id_fenetre="Fen_01147";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_dico_00028=fa_recup_dico("dico_00028");
$vl_c_bgi_100=fa_recup_dico("bgi_100");
$vl_c_bgi_101=fa_recup_dico("bgi_101");
$vl_c_bgi_102=fa_recup_dico("bgi_102");
$vl_c_bgi_103=fa_recup_dico("bgi_103");
$vl_c_bgi_104=fa_recup_dico("bgi_104");
$vl_c_bgi_105=fa_recup_dico("bgi_105");
$vl_c_bgi_106=fa_recup_dico("bgi_106");
$vl_c_bgi_107=fa_recup_dico("bgi_107");
$vl_c_bgi_108=fa_recup_dico("bgi_108");
$vl_c_bgi_109=fa_recup_dico("bgi_109");
$vl_c_bgi_110=fa_recup_dico("bgi_110");
$vl_c_bgi_111=fa_recup_dico("bgi_111");
$vl_c_bgi_112=fa_recup_dico("bgi_112");
$vl_c_bgi_113=fa_recup_dico("bgi_113");
$vl_c_bgi_114=fa_recup_dico("bgi_114");
$vl_c_bgi_115=fa_recup_dico("bgi_115");
$vl_c_bgi_116=fa_recup_dico("bgi_116");$vl_c_bgi_116="Renvoyer la requête de sélection et sortir.";
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_dico_00028=fa_recup_dico("dico_00028");
$vl_c_dico_00106=fa_recup_dico("dico_00106");
$sql_req="select count(*) as nombre from _act_interlo_mail where (datediff(now(),_act_interlo_mail.dateheureverification) >30 or _act_interlo_mail.dateheureverification is null )";
$sql_req.=" and valide in(1,3) and veuxpasdemail in (1,3) ";
switch ($vl_c_type){
	case 1:
		$sql_req.=" and (";
		$sql_req.=" refweb not like '%@wanadoo.fr' and refweb not like '%@orange.fr' ";
		$sql_req.=" and refweb not like '%@hotmail.com' and refweb not like '%@hotmail.fr' and refweb not like '%@msn.com'";
		$sql_req.=" and refweb not like '%@club-internet.fr' and refweb not like '%@cegetel%'";
		$sql_req.=" and refweb not like '%@century21france.fr' and refweb not like '%@axa.fr' and refweb not like '%@hrnet.fr'";
		$sql_req.=" and refweb not like '%@swisslife.fr' and refweb not like '%@gan.fr'";
		$sql_req.=" )";
		//$sql_req.=" LIMIT 25000";
		break;
	case 2:
		$sql_req.=" and (refweb like '%@wanadoo.fr' or refweb like '%@orange.fr')";
		//$sql_req.=" LIMIT 5000";
		break;
	case 3:
		$sql_req.=" and (refweb like '%@hotmail.com' or refweb like '%@hotmail.fr' or refweb like '%@msn.com')";
		//$sql_req.=" LIMIT 5000";
		break;
	case 4:
		$sql_req.=" and (refweb like '%@club-internet.fr' or refweb like '%@cegetel%')";
		//$sql_req.=" LIMIT 5000";
		break;
	case 5:
		$sql_req.=" and (refweb like '%@century21france.fr' or refweb like '%@axa.fr' or refweb like '%@hrnet.fr' or refweb like '%@swisslife.fr' or refweb like '%@gan.fr')";
		//$sql_req.=" LIMIT 5000";
		break;
	case 'G':
		$sql_req="select count(*) as nombre from _act_interlo_mail where ( cr_verification like '450%' or cr_verification like '451%')";
		$sql_req.=" and valide in(1,3) and veuxpasdemail in (1,3);";
		break;
}
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_a_traiter=$row['nombre'];
_graal_libere_requete_bd($result);
switch ($vl_c_type){
	case 1:
		$vl_c_rate="Il reste $nombre_a_traiter adresses de courriel &lt;&gt; orange, wanadoo etc ... à traiter.";
		break;
	case 2:
		$vl_c_rate="Il reste $nombre_a_traiter adresses de courriel = orange, wanadoo à traiter.";
		break;
	case 3:
		$vl_c_rate="Il reste $nombre_a_traiter adresses de courriel = hotmail, msn à traiter.";
		break;
	case 4:
		$vl_c_rate="Il reste $nombre_a_traiter adresses de courriel = club-internet, cegetel ... à traiter.";
		break;
	case 5:
		$vl_c_rate="Il reste $nombre_a_traiter adresses de courriel = century21, axa, hrnet ... à traiter.";
		break;
	case 'G':
		$vl_c_rate="Il reste $nombre_a_traiter adresses de courriel en liste grise à traiter.";
		break;
}

$vl_tc_composants=array($vl_c_id_fenetre);
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_bgi_100" id="_graal_traitements_courriel_02" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_courriel_traitements_02.js.php");
echo <<<END
<vbox class="overflow_01">
		<caption>
            <label control="la_emailing_autorise" value="$vl_c_rate"/>
          </caption>
	<hbox>
        <hbox flex= "1">
        <groupbox>
          <caption>
            <label control="la_emailing_autorise" value="$vl_c_bgi_101"/>
          </caption>
          <hbox>
            <checkbox class="ak16" dir="reverse" observes="broadcaster_01" id='ra_veuxpasdemail_oui' label="$vl_c_dico_00013" value='1' checked="true" disabled="true"/>
            <spacer flex="1"/>
            <checkbox class="ak17" dir="reverse" observes="broadcaster_01" id='ra_veuxpasdemail_non' label="$vl_c_dico_00014" value='2' checked="false" disabled="true"/>
            <spacer flex="1"/>
            <checkbox class="ak18" dir="reverse" observes="broadcaster_01" id='ra_veuxpasdemail_nsp' label="$vl_c_dico_00028" value='3' checked="true" disabled="true"/>
            <spacer flex="1"/>
          </hbox>
        </groupbox>
      </hbox>
      <hbox flex= "1">
        <groupbox>
          <caption>
            <label control="la_valide" value="$vl_c_bgi_102"/>
          </caption>
          <hbox>
            <checkbox class="af16" dir="reverse" observes="broadcaster_01" id='ra_valide_oui' label="$vl_c_dico_00013" value='1' checked="true" disabled="true"/>
            <spacer flex="1"/>
            <checkbox class="ae15" dir="reverse" observes="broadcaster_01" id='ra_valide_non' label="$vl_c_dico_00014" value='2' checked="false" disabled="true"/>
            <spacer flex="1"/>
            <checkbox class="af15" dir="reverse" observes="broadcaster_01" id='ra_valide_nsp' label="$vl_c_dico_00028" value='3' checked="true" disabled="true"/>
            <spacer flex="1"/>
          </hbox>
        </groupbox>
      </hbox>
      <vbox flex="0"><label value='Dernière date de vérification'/>
      <hbox old_flex='1'>
      <menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' observes="broadcaster_bem" id="aao_ml_date_genre" minwidth="20" value="5" disabled="true">
            <menupopup>
              <menuitem label="=" value="1" class="sans_icone"/> <!-- égal-->
              <menuitem label="&lt;" value="2" class="sans_icone"/> <!--  Inférieur -->
              <menuitem label="&gt;" value="3" class="sans_icone"/> <!--  Supérieur -->
              <menuitem label="-30" value="4" class="sans_icone" tooltiptext="Contrôlée il y a moins de 30 jours"/> <!--  Contrôlée il y a moins de 30 jours -->
              <menuitem label="+30" value="5" class="sans_icone" tooltiptext="Contrôlée il y a plus de 30 jours"/> <!--  Contrôlée il y a moins de 30 jours -->
            </menupopup>
          </menulist>
      
END;
$id_pref="";$id_deb="aao_tb_deb";$id_fin="aao_tb_fin";$trimestres="non";$pas_voir_date_fin="true";
include ("_graal_inc_choix_periodes_01.php");
echo <<<END
</hbox></vbox></hbox>
</vbox>	
<button label="$vl_c_bgi_103" oncommand="pf_lance_traitement();" id="bt_lance"/>
<button label="close" oncommand="window.close;" collapsed="true"/>

  <vbox flex="1">
    <iframe id="cr_traitement" flex="1" src="_graal_en_plein_travail.php" />
  </vbox>
  </window>
END;
?>
