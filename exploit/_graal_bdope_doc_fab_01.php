<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_numerotation.php");
include("_graal_fonctions_mousto.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_articles_01";
$t_origines_ok[1]="_graal_fen_actions_01";
fa_acces_script();
$vf_c_action=fa_recup_param("vf_c_action","??????");
//	Variables pour création
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_art_cleunik=intval(fa_recup_param('vl_e_art_cleunik','0'));
$vl_e_qte_lancee=fa_floatval(fa_recup_param('vl_e_qte_lancee','0'));
$vl_c_genreaction=fa_recup_param('genreaction','generique');
//	Variables pour traitement fabrication complete ou pour modification d'une ligne
$vl_action_cleunik=intval(fa_recup_param("vl_action_cleunik","0"));
$vl_fab_ligne_cleunik=intval(fa_recup_param('vl_fab_ligne_cleunik','0'));
$vl_fab_cleunik=intval(fa_recup_param('vl_fab_cleunik','0'));
$vl_c_liste_cle=fa_recup_param("vl_c_liste_cle","");
$vl_c_liste_qtelan=fa_recup_param("vl_c_liste_qtelan","");
$vl_c_liste_qtefab=fa_recup_param("vl_c_liste_qtefab","");
$vl_c_liste_qtereb=fa_recup_param("vl_c_liste_qtereb","");
$vl_c_liste_cle=fa_recup_param("vl_c_liste_cle","");
$vl_c_liste_valeur_complement_type=fa_recup_param("vl_c_liste_valeur_complement_type","");
$vl_c_liste_valeur_complement=fa_recup_param("vl_c_liste_valeur_complement","");
$vl_c_liste_hg=fa_recup_param("vl_c_liste_hg","");
$vl_c_liste_base_valorisation=fa_recup_param("vl_c_liste_base_valorisation","");
$vl_c_liste_note=fa_recup_param("vl_c_liste_note","");
$vl_c_liste_nb_decimales_qte=fa_recup_param("vl_c_liste_nb_decimales_qte","");
$vl_c_liste_nbdec_pu=fa_recup_param("vl_c_liste_nbdec_pu","");
$vl_c_liste_pu=fa_recup_param("vl_c_liste_pu","");
$vl_c_liste_noligne=fa_recup_param("vl_c_liste_noligne","");
$vl_c_liste_art_cleunik=fa_recup_param("vl_c_liste_art_cleunik","");
$vl_c_liste_unite_quantite=fa_recup_param("vl_c_liste_unite_quantite","");
$vl_c_qtefab=fa_floatval(fa_recup_param("vl_c_qtefab",""));
$vl_c_qtereb=fa_floatval(fa_recup_param("vl_c_qtereb",""));
$vl_c_pubru=fa_floatval(fa_recup_param("vl_c_pubru",""));
$vl_c_punet=fa_floatval(fa_recup_param("vl_c_punet",""));
$vl_c_statut=intval(fa_recup_param("vl_c_statut",""));
$vl_dat_fabriq=fa_recup_param('vl_dat_fabriq','');
$vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
//	Variables pour suppression d'une ligne
$vl_fab_ligne_nomenc_cleunik=intval(fa_recup_param('vl_fab_ligne_nomenc_cleunik','0'));
switch (TRUE) {
	case $vf_c_action=="saisie_ensemble":
		$vl_c_liste_cle=unserialize(stripslashes($vl_c_liste_cle));
		$vl_c_liste_qtefab=unserialize(stripslashes($vl_c_liste_qtefab));
		$vl_c_liste_qtereb=unserialize(stripslashes($vl_c_liste_qtereb));
		$vl_c_liste_valeur_complement_type=unserialize(stripslashes($vl_c_liste_valeur_complement_type));
		$vl_c_liste_valeur_complement=unserialize(stripslashes($vl_c_liste_valeur_complement));
		$vl_c_liste_hg=unserialize(stripslashes($vl_c_liste_hg));
		$vl_c_liste_base_valorisation=unserialize(stripslashes($vl_c_liste_base_valorisation));
		$vl_c_liste_nb_decimales_qte=unserialize(stripslashes($vl_c_liste_nb_decimales_qte));
		$vl_c_liste_nbdec_pu=unserialize(stripslashes($vl_c_liste_nbdec_pu));
		$vl_c_liste_pu=unserialize(stripslashes($vl_c_liste_pu));
		$vl_c_liste_noligne=unserialize(stripslashes($vl_c_liste_noligne));
		$vl_c_liste_art_cleunik=unserialize(stripslashes($vl_c_liste_art_cleunik));
		$vl_c_liste_unite_quantite=unserialize(stripslashes($vl_c_liste_unite_quantite));
		$sql_req_01 = "SELECT a1.art_cleunik,a1.noligne,a2.code FROM _fab_lignes a1 left join _fab_entetes a2 using (fab_cleunik) where fab_ligne_cleunik=$vl_fab_ligne_cleunik;";
		$result_01 = _graal_requete_bd($sql_req_01);
		$row_01 = mysql_fetch_assoc($result_01);
		$art_cleunik=fa_nn($row_01['art_cleunik']);
		$code=$row_01['code'];
		_graal_libere_requete_bd($result_01);
		//  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    //  Modification action
	  $req_action="UPDATE _actions set statut=$vl_c_statut where action_cleunik=$vl_action_cleunik;";
    $vf_c_echo=_graal_exec_requete($req_action);
    if($vf_c_echo=='ok') {
    	//	Modification ligne
			$req_action="UPDATE _fab_lignes set qte_fabriq=qte_fabriq+$vl_c_qtefab,qte_rebute=qte_rebute+$vl_c_qtereb,pu=$vl_c_pubru,statut=$vl_c_statut where fab_ligne_cleunik=$vl_fab_ligne_cleunik;";
			if(_graal_exec_requete($req_action)!="ok")  {$vf_c_retour=-2;}
			//	Entrée en stock produit fabriqué
			//$vl_mousto_uti_cleunik=// Récupéré plus haut
      //$vl_mousto_int_cleunik=// Récupéré plus haut
      $vl_mousto_art_cleunik=$art_cleunik;
      $vl_mousto_blocnotebrut="Fabrication $code";
      $vl_mousto_date_mvt=$vl_dat_fabriq;
      $vl_mousto_choix_depot=-15;
      $vl_mousto_choix_empla=-16;
      $vl_mousto_qte_mvt=$vl_c_qtefab-$vl_c_qtereb;
      $vl_mousto_pu_mvt=$vl_c_pubru;
      $vl_mousto_genre_mvt=-45;// Fabrication
      $vl_mousto_type_mvt=1;//  Entrée en stock
      $vl_mousto_mvt_cleunik=fa_mousto_ajout();
      if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="-3";}
    	$vl_e_i=-1;
			$vl_fab_ligne_nomenc_cleunik_detail=_graal_requete_max("fab_ligne_nomenc_cleunik_detail","_fab_lignes_nomenc_detail");
			$req_detail="INSERT INTO _fab_lignes_nomenc_detail (fab_ligne_nomenc_cleunik_detail,fab_ligne_nomenc_cleunik,quantite_fabriq_saisie,quantite_rebute_saisie,unite_quantite,blocnotebrut,dateheuredetail,int_cleunik,nb_decimales_qte,pu,hg,nbdec_pu,valeur_complement,valeur_complement_type,base_valorisation,mvt_cleunik) VALUES ";
			foreach($vl_c_liste_cle as $vl_raf) {
	    	$vl_e_i++;
				//	Sortie du stock des composants
				//$vl_mousto_uti_cleunik=// Récupéré plus haut
	      //$vl_mousto_int_cleunik=// Récupéré plus haut
				if ($vl_c_liste_pu[$vl_e_i]==""){$vl_c_liste_pu[$vl_e_i]=0;}
				if ($vl_c_liste_qtefab[$vl_e_i]==""){$vl_c_liste_qtefab[$vl_e_i]=0;}
				if ($vl_c_liste_qtereb[$vl_e_i]==""){$vl_c_liste_qtereb[$vl_e_i]=0;}
	      $vl_mousto_art_cleunik=$vl_c_liste_art_cleunik[$vl_e_i];
	      $vl_mousto_blocnotebrut="Fabrication $code ligne $vl_c_liste_noligne[$vl_e_i]";
	      $vl_mousto_date_mvt=$vl_dat_fabriq;
	      $vl_mousto_choix_depot=-15;
	      $vl_mousto_choix_empla=-16;
	      $vl_mousto_qte_mvt=$vl_c_liste_qtefab[$vl_e_i]+$vl_c_liste_qtereb[$vl_e_i];
	      $vl_mousto_pu_mvt=$vl_c_liste_pu[$vl_e_i];
	      $vl_mousto_genre_mvt=-45;// Fabrication
	      $vl_mousto_type_mvt=2;//  Sortie de stock
	      $vl_mousto_mvt_cleunik=fa_mousto_ajout();
	      if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="-4";}
				if ($vl_e_i==0) {$req_detail_ajout="";} else {$req_detail_ajout.= ",";}
				if ($vl_c_liste_unite_quantite[$vl_e_i]==""){$vl_c_liste_unite_quantite[$vl_e_i]="null";}
				$req_detail_ajout.="($vl_fab_ligne_nomenc_cleunik_detail,$vl_c_liste_cle[$vl_e_i],$vl_c_liste_qtefab[$vl_e_i],$vl_c_liste_qtereb[$vl_e_i],
				$vl_c_liste_unite_quantite[$vl_e_i],null,'$vl_dat_fabriq',$vl_mousto_int_cleunik,$vl_c_liste_nb_decimales_qte[$vl_e_i],$vl_c_liste_pu[$vl_e_i],$vl_c_liste_hg[$vl_e_i],
				$vl_c_liste_nbdec_pu[$vl_e_i],$vl_c_liste_valeur_complement[$vl_e_i],$vl_c_liste_valeur_complement_type[$vl_e_i],$vl_c_liste_base_valorisation[$vl_e_i],$vl_mousto_mvt_cleunik)";
				$vl_fab_ligne_nomenc_cleunik_detail++;
	  	}
			if(_graal_exec_requete($req_detail.$req_detail_ajout)!="ok")  {$vf_c_retour=-5;}
    } else {
			$vf_c_retour="-1";
		}
		//  Fin de la transaction
    if ($vf_c_retour=="") {
     	$vf_c_retour=$vl_action_cleunik;
      _graal_requete_bd("COMMIT;");
    } else {
      $vf_c_retour.=$vf_c_echo;
			//$vf_c_retour.=$req_detail.$req_detail_ajout;
      _graal_requete_bd("ROLLBACK;");
    }
		echo $vf_c_retour;
		break;
	case $vf_c_action=="ajouter":
		$req_action="INSERT INTO _actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurecreation,sujet,c_uuid,reference,statut) VALUES ";
		$req_fa_ent="INSERT INTO _fab_entetes (action_cleunik,fab_cleunik,code,dateheurecreation,dateheuremodif,blocnotebrut) VALUES ";
		$req_fa_lig="INSERT INTO _fab_lignes (fab_ligne_cleunik,fab_cleunik,noligne,art_cleunik,qte_lancee,qte_fabriq,pu,statut,dateheurecreation,dateheuremodif,blocnotebrut,qte_rebute) VALUES ";
		$req_fa_lig_nom="INSERT INTO _fab_lignes_nomenc (fab_ligne_nomenc_cleunik,fab_ligne_cleunik,art_cleunik_pere,art_cleunik_fils,noligne,quantite_lancee,quantite_fabriq,quantite_rebute,statut,unite_quantite,nb_decimales_qte,blocnotebrut,pu,hg,nbdec_pu,valeur_complement,valeur_complement_type,base_valorisation,arrondi_fab) VALUES ";
		$vf_e_choix_cleunik_doc=-110119;
		$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    $vl_uuid=_graal_requete_uuid();
    $statut=-23;  //  En cours
    $code=_graal_numerote(12);//  Numérotation automatique
    $vf_c_retour="";
    //  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
		$ret=_graal_requete_article($vl_e_art_cleunik);
		$vl_c_code=$ret[0];
		$vl_c_mnemotechnique=$ret[1];
		$vl_c_description=$ret[2]; 
		$vl_c_chaine='Fabrication '.$ret[2].' ('.$ret[0].')';
    //  Ajout action
    $req_action.="($vl_action_cleunik,$vf_e_choix_cleunik_doc,now(),now(),'$vl_c_chaine','$vl_uuid','$code',$statut)";
    $vf_c_echo=_graal_exec_requete($req_action);
    if($vf_c_echo=='ok') {
      //  Ajout entête
			$vl_fab_cleunik=_graal_requete_max("fab_cleunik","_fab_entetes");
			$req_fa_ent.="($vl_action_cleunik,$vl_fab_cleunik,'$code',now(),NULL,NULL);";
			if(_graal_exec_requete($req_fa_ent)!="ok")  {$vf_c_retour=-2;}
			$vl_fab_ligne_cleunik=_graal_requete_max("fab_ligne_cleunik","_fab_lignes");
			$req_fa_lig.="($vl_fab_ligne_cleunik,$vl_fab_cleunik,1,$vl_e_art_cleunik,$vl_e_qte_lancee,0,0,$statut,now(),null,null,0);";
			if(_graal_exec_requete($req_fa_lig)!="ok")  {$vf_c_retour=-3;}
			$sql_req="SELECT art_cleunik_fils,noligne,quantite,unite_quantite,nb_decimales_qte,blocnotebrut,valeur_complement,valeur_complement_type,base_valorisation,arrondi_fab FROM _nomenclatures_fab where art_cleunik_pere=$vl_e_art_cleunik;";
			$result = _graal_requete_bd($sql_req);
			$vl_fab_ligne_nomenc_cleunik=_graal_requete_max("fab_ligne_nomenc_cleunik","_fab_lignes_nomenc");
			$i==0;
			while ($row = mysql_fetch_assoc($result)) {
				$art_cleunik_fils=fa_nn($row['art_cleunik_fils']);
				$noligne=fa_nn($row['noligne']);
				$unite_quantite=fa_nn($row['unite_quantite']);
				$nb_decimales_qte=fa_nn($row['nb_decimales_qte']);
				$blocnotebrut=fa_nt($row['blocnotebrut']);
				$pu=fa_nn($row['pu']);
				$valeur_complement=fa_nn($row['valeur_complement']);
				$valeur_complement_type=fa_nn($row['valeur_complement_type']);
				$base_valorisation=fa_nn($row['base_valorisation']);
				$arrondi_fab=fa_nn($row['arrondi_fab']);
				$quantite=$row['quantite'];
				$vl_e_qte_lancee_nomenc=$quantite;
				if ($i!=0) {$dat_fa_lig_nom.=",";}
				$i++;
				$vl_fab_ligne_nomenc_cleunik++;
				$dat_fa_lig_nom.="($vl_fab_ligne_nomenc_cleunik,$vl_fab_ligne_cleunik,$vl_e_art_cleunik,$art_cleunik_fils,$noligne,$vl_e_qte_lancee_nomenc,0,0,$statut,$unite_quantite,$nb_decimales_qte,$blocnotebrut,$pu,2,4,$valeur_complement,$valeur_complement_type,$base_valorisation,$arrondi_fab)";
			}
			_graal_libere_requete_bd($result);
			if ($dat_fa_lig_nom!="") {
				if(_graal_exec_requete($req_fa_lig_nom.$dat_fa_lig_nom)!="ok")  {$vf_c_retour=-4;}
			}
			
			
		} else {
			$vf_c_retour="-1";
		}
		//  Fin de la transaction
    if ($vf_c_retour=="") {
     	$vf_c_retour=$vl_action_cleunik;
      _graal_requete_bd("COMMIT;");
    } else {
      //$vf_c_retour.=$vf_c_echo;
			$vf_c_echo=_graal_exec_requete("delete from _actions_texte where action_cleunik=$vl_action_cleunik;");
      _graal_requete_bd("ROLLBACK;");
    }
		echo $vf_c_retour;
		break;
	case $vf_c_action=="ajouter_ligne":
		$vl_c_liste_cle=unserialize(stripslashes($vl_c_liste_cle));
		$vl_c_liste_qtelan=unserialize(stripslashes($vl_c_liste_qtelan));
		$vl_c_liste_qtefab=unserialize(stripslashes($vl_c_liste_qtefab));
		$vl_c_liste_qtereb=unserialize(stripslashes($vl_c_liste_qtereb));
		$vl_c_liste_valeur_complement_type=unserialize(stripslashes($vl_c_liste_valeur_complement_type));
		$vl_c_liste_valeur_complement=unserialize(stripslashes($vl_c_liste_valeur_complement));
		$vl_c_liste_hg=unserialize(stripslashes($vl_c_liste_hg));
		$vl_c_liste_base_valorisation=unserialize(stripslashes($vl_c_liste_base_valorisation));
		$vl_c_liste_nb_decimales_qte=unserialize(stripslashes($vl_c_liste_nb_decimales_qte));
		$vl_c_liste_nbdec_pu=unserialize(stripslashes($vl_c_liste_nbdec_pu));
		$vl_c_liste_pu=unserialize(stripslashes($vl_c_liste_pu));
		$vl_c_liste_noligne=unserialize(stripslashes($vl_c_liste_noligne));
		$vl_c_liste_art_cleunik=unserialize(stripslashes($vl_c_liste_art_cleunik));
		$vl_c_liste_unite_quantite=unserialize(stripslashes($vl_c_liste_unite_quantite));
		$vl_c_liste_note=unserialize(stripslashes($vl_c_liste_note));
		$req_fa_lig_nom="INSERT INTO _fab_lignes_nomenc (fab_ligne_nomenc_cleunik,fab_ligne_cleunik,art_cleunik_pere,art_cleunik_fils,noligne,quantite_lancee,quantite_fabriq,quantite_rebute,statut,unite_quantite,nb_decimales_qte,blocnotebrut,pu,hg,nbdec_pu,valeur_complement,valeur_complement_type,base_valorisation,arrondi_fab) VALUES ";
    $vf_c_retour="";
    //  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
		//	Ajout de la ligne de nomenclature
		$vl_fab_ligne_nomenc_cleunik=_graal_requete_max("fab_ligne_nomenc_cleunik","_fab_lignes_nomenc");
		$vl_fab_ligne_nomenc_cleunik_detail=_graal_requete_max("fab_ligne_nomenc_cleunik_detail","_fab_lignes_nomenc_detail");
		$sql_req="SELECT max(noligne) as max from _fab_lignes_nomenc where fab_ligne_cleunik=$vl_fab_ligne_cleunik;";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$noligne=$row['max']+1;
		_graal_libere_requete_bd($result);
		$req_detail="INSERT INTO _fab_lignes_nomenc_detail (fab_ligne_nomenc_cleunik_detail,fab_ligne_nomenc_cleunik,quantite_fabriq_saisie,quantite_rebute_saisie,unite_quantite,blocnotebrut,dateheuredetail,int_cleunik,nb_decimales_qte,pu,hg,nbdec_pu,valeur_complement,valeur_complement_type,base_valorisation,mvt_cleunik) VALUES ";
		$vl_e_i=-1;
		foreach($vl_c_liste_cle as $vl_raf) {
    	$vl_e_i++;
			if ($vl_c_liste_pu[$vl_e_i]==""){$vl_c_liste_pu[$vl_e_i]=0;}
			if ($vl_c_liste_qtefab[$vl_e_i]==""){$vl_c_liste_qtefab[$vl_e_i]=0;}
			if ($vl_c_liste_qtereb[$vl_e_i]==""){$vl_c_liste_qtereb[$vl_e_i]=0;}
			$req_fa_lig_nom_value="($vl_fab_ligne_nomenc_cleunik,$vl_fab_ligne_cleunik,$vl_e_art_cleunik,$vl_c_liste_art_cleunik[$vl_e_i],$noligne,$vl_c_liste_qtelan[$vl_e_i],
			null,null,-23,$vl_c_liste_unite_quantite[$vl_e_i],$vl_c_liste_nb_decimales_qte[$vl_e_i],'$vl_c_liste_note[$vl_e_i]',$vl_c_liste_pu[$vl_e_i],$vl_c_liste_hg[$vl_e_i],
			$vl_c_liste_nbdec_pu[$vl_e_i],$vl_c_liste_valeur_complement[$vl_e_i],$vl_c_liste_valeur_complement_type[$vl_e_i],$vl_c_liste_base_valorisation[$vl_e_i],1);";
			if(_graal_exec_requete($req_fa_lig_nom.$req_fa_lig_nom_value)!="ok")  {
				$vf_c_retour="-3 $req_fa_lig_nom.$req_fa_lig_nom_value";
			} else {
				//	Sortie du stock des composants
				//$vl_mousto_uti_cleunik=// Récupéré plus haut
	      //$vl_mousto_int_cleunik=// Récupéré plus haut
	      $vl_mousto_art_cleunik=$vl_c_liste_art_cleunik[$vl_e_i];
	      $vl_mousto_blocnotebrut="Fabrication $code ligne $vl_c_liste_noligne[$vl_e_i]";
	      $vl_mousto_date_mvt=$vl_dat_fabriq;
	      $vl_mousto_choix_depot=-15;
	      $vl_mousto_choix_empla=-16;
	      $vl_mousto_qte_mvt=$vl_c_liste_qtefab[$vl_e_i]+$vl_c_liste_qtereb[$vl_e_i];
	      $vl_mousto_pu_mvt=$vl_c_liste_pu[$vl_e_i];
	      $vl_mousto_genre_mvt=-45;// Fabrication
	      $vl_mousto_type_mvt=2;//  Sortie de stock
	      if ($vl_mousto_qte_mvt!=0) {
		      $vl_mousto_mvt_cleunik=fa_mousto_ajout();
					if ($vl_mousto_mvt_cleunik==-1){$vl_mousto_mvt_cleunik="null";}
	      } else {
	      	$vl_mousto_mvt_cleunik="null";
	      }
	      if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="-4";}
				if ($vl_e_i==0) {$req_detail_ajout="";} else {$req_detail_ajout.= ",";}
				if ($vl_c_liste_unite_quantite[$vl_e_i]==""){$vl_c_liste_unite_quantite[$vl_e_i]="null";}
				$req_detail_ajout.="($vl_fab_ligne_nomenc_cleunik_detail,$vl_fab_ligne_nomenc_cleunik,$vl_c_liste_qtefab[$vl_e_i],$vl_c_liste_qtereb[$vl_e_i],
				$vl_c_liste_unite_quantite[$vl_e_i],null,'$vl_dat_fabriq',$vl_mousto_int_cleunik,$vl_c_liste_nb_decimales_qte[$vl_e_i],$vl_c_liste_pu[$vl_e_i],$vl_c_liste_hg[$vl_e_i],
				$vl_c_liste_nbdec_pu[$vl_e_i],$vl_c_liste_valeur_complement[$vl_e_i],$vl_c_liste_valeur_complement_type[$vl_e_i],$vl_c_liste_base_valorisation[$vl_e_i],$vl_mousto_mvt_cleunik)";
				$vl_fab_ligne_nomenc_cleunik_detail++;
			}
  	}
		if ($req_detail_ajout!="") {
			if(_graal_exec_requete($req_detail.$req_detail_ajout)!="ok")  {$vf_c_retour="-5";}			
		}
		//  Fin de la transaction
    if ($vf_c_retour=="") {
     	$vf_c_retour=$vl_action_cleunik;
      _graal_requete_bd("COMMIT;");
    } else {
      _graal_requete_bd("ROLLBACK;");
    }
		echo $vf_c_retour;
		break;		
	case $vf_c_action=="supprimer_ligne":
		$vf_c_echo=_graal_exec_requete("delete from _fab_lignes_nomenc where fab_ligne_nomenc_cleunik=$vl_fab_ligne_nomenc_cleunik;");
		echo $vf_c_echo;
		break;
	case $vf_c_action=="modifier_ligne":
		$vl_c_liste_cle=unserialize(stripslashes($vl_c_liste_cle));
		$vl_c_liste_qtefab=unserialize(stripslashes($vl_c_liste_qtefab));
		$vl_c_liste_qtereb=unserialize(stripslashes($vl_c_liste_qtereb));
		$vl_c_liste_valeur_complement_type=unserialize(stripslashes($vl_c_liste_valeur_complement_type));
		$vl_c_liste_valeur_complement=unserialize(stripslashes($vl_c_liste_valeur_complement));
		$vl_c_liste_hg=unserialize(stripslashes($vl_c_liste_hg));
		$vl_c_liste_base_valorisation=unserialize(stripslashes($vl_c_liste_base_valorisation));
		$vl_c_liste_nb_decimales_qte=unserialize(stripslashes($vl_c_liste_nb_decimales_qte));
		$vl_c_liste_nbdec_pu=unserialize(stripslashes($vl_c_liste_nbdec_pu));
		$vl_c_liste_pu=unserialize(stripslashes($vl_c_liste_pu));
		$vl_c_liste_noligne=unserialize(stripslashes($vl_c_liste_noligne));
		$vl_c_liste_art_cleunik=unserialize(stripslashes($vl_c_liste_art_cleunik));
		$vl_c_liste_unite_quantite=unserialize(stripslashes($vl_c_liste_unite_quantite));
		$vl_c_liste_note=unserialize(stripslashes($vl_c_liste_note));
		$sql_req_01 = "SELECT a1.art_cleunik,a1.noligne,a2.code FROM _fab_lignes a1 left join _fab_entetes a2 using (fab_cleunik) where fab_ligne_cleunik=$vl_fab_ligne_cleunik;";
		$result_01 = _graal_requete_bd($sql_req_01);
		$row_01 = mysql_fetch_assoc($result_01);
		$art_cleunik=fa_nn($row_01['art_cleunik']);
		$code=$row_01['code'];
		_graal_libere_requete_bd($result_01);
		//  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
		$vl_fab_ligne_nomenc_cleunik_detail=_graal_requete_max("fab_ligne_nomenc_cleunik_detail","_fab_lignes_nomenc_detail");
		$req_detail="INSERT INTO _fab_lignes_nomenc_detail (fab_ligne_nomenc_cleunik_detail,fab_ligne_nomenc_cleunik,quantite_fabriq_saisie,quantite_rebute_saisie,unite_quantite,blocnotebrut,dateheuredetail,int_cleunik,nb_decimales_qte,pu,hg,nbdec_pu,valeur_complement,valeur_complement_type,base_valorisation,mvt_cleunik) VALUES ";
		$vl_e_i=-1;
		foreach($vl_c_liste_cle as $vl_raf) {
    	$vl_e_i++;
			//	Sortie du stock des composants
			//$vl_mousto_uti_cleunik=// Récupéré plus haut
      //$vl_mousto_int_cleunik=// Récupéré plus haut
			if ($vl_c_liste_pu[$vl_e_i]==""){$vl_c_liste_pu[$vl_e_i]=0;}
			if ($vl_c_liste_qtefab[$vl_e_i]==""){$vl_c_liste_qtefab[$vl_e_i]=0;}
			if ($vl_c_liste_qtereb[$vl_e_i]==""){$vl_c_liste_qtereb[$vl_e_i]=0;}
      $vl_mousto_art_cleunik=$vl_c_liste_art_cleunik[$vl_e_i];
      $vl_mousto_blocnotebrut="Fabrication $code ligne $vl_c_liste_noligne[$vl_e_i]";
      $vl_mousto_date_mvt=$vl_dat_fabriq;
      $vl_mousto_choix_depot=-15;
      $vl_mousto_choix_empla=-16;
      $vl_mousto_qte_mvt=$vl_c_liste_qtefab[$vl_e_i]+$vl_c_liste_qtereb[$vl_e_i];
      $vl_mousto_pu_mvt=$vl_c_liste_pu[$vl_e_i];
      $vl_mousto_genre_mvt=-45;// Fabrication
      $vl_mousto_type_mvt=2;//  Sortie de stock
      if ($vl_mousto_qte_mvt!=0) {
	      $vl_mousto_mvt_cleunik=fa_mousto_ajout();
				if ($vl_mousto_mvt_cleunik==-1){$vl_mousto_mvt_cleunik="null";}	      	
      } else {
      	$vl_mousto_mvt_cleunik="null";
      }
      if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="-4";}
			if ($vl_e_i==0) {$req_detail_ajout="";} else {$req_detail_ajout.= ",";}
			if ($vl_c_liste_unite_quantite[$vl_e_i]==""){$vl_c_liste_unite_quantite[$vl_e_i]="null";}
			$req_detail_ajout.="($vl_fab_ligne_nomenc_cleunik_detail,$vl_c_liste_cle[$vl_e_i],$vl_c_liste_qtefab[$vl_e_i],$vl_c_liste_qtereb[$vl_e_i],
			$vl_c_liste_unite_quantite[$vl_e_i],null,'$vl_dat_fabriq',$vl_mousto_int_cleunik,$vl_c_liste_nb_decimales_qte[$vl_e_i],$vl_c_liste_pu[$vl_e_i],$vl_c_liste_hg[$vl_e_i],
			$vl_c_liste_nbdec_pu[$vl_e_i],$vl_c_liste_valeur_complement[$vl_e_i],$vl_c_liste_valeur_complement_type[$vl_e_i],$vl_c_liste_base_valorisation[$vl_e_i],$vl_mousto_mvt_cleunik)";
			$vl_fab_ligne_nomenc_cleunik_detail++;
  	}
		if(_graal_exec_requete($req_detail.$req_detail_ajout)!="ok")  {$vf_c_retour="-5";}
		//  Fin de la transaction
    if ($vf_c_retour=="") {
     	$vf_c_retour=$vl_action_cleunik;
      _graal_requete_bd("COMMIT;");
    } else {
      //$vf_c_retour.=$vf_c_echo;
      _graal_requete_bd("ROLLBACK;");
    }
		echo $vf_c_retour;
		break;

	default:
		echo $vf_c_action;
		break;
}
?>