<?php
include("_graal_header_xul.inc.php");
include("_graal_fonctions_mousto.php");
$vl_e_uti_cleunik =intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_e_art_cleunik=intval(fa_recup_param("vl_e_art_cleunik","-1"));
$vl_quoi=fa_recup_param("quoi","");
$quantite_inventaire=fa_recup_param("quantite_inventaire",0);
$vl_c_id_fenetre="Fen_00565";
$id_inc_art_mousto="Div_00486";// Tableau des mouvements de stock
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bnz_100=fa_recup_dico("bnz_100");
$vl_c_bnz_101=fa_recup_dico("bnz_101");
$vl_c_bnz_102=fa_recup_dico("bnz_102");
$vl_c_bnz_103=fa_recup_dico("bnz_103");
$vl_c_bnz_104=fa_recup_dico("bnz_104");
$vl_c_bnz_105=fa_recup_dico("bnz_105");
$vl_c_bnz_106=fa_recup_dico("bnz_106");
$vl_c_bnz_107=fa_recup_dico("bnz_107");
$vl_c_bnz_108=fa_recup_dico("bnz_108");
$vl_c_bnz_109=fa_recup_dico("bnz_109");
$vl_c_bnz_110=fa_recup_dico("bnz_110");
$vl_c_bnz_111=fa_recup_dico("bnz_111");
$vl_c_bnz_112=fa_recup_dico("bnz_112");
$vl_c_bnz_113=fa_recup_dico("bnz_113");
$vl_c_bnz_114=fa_recup_dico("bnz_114");$vl_c_bnz_114="Enregistrer";
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_dico_00086=fa_recup_dico("dico_00086");
$vl_c_dico_00087=fa_recup_dico("dico_00087");
$vl_c_dico_00088=fa_recup_dico("dico_00088");
//  On recherche les informations sur l'article 
if ($vl_e_art_cleunik!=-1){
  $sql_req="SELECT _article.code as `code`,_article.mnemotechnique as `mnemotechnique`,_article.description as `description`,_art_stock.gestion as gestion,_art_stock.nb_decimales_qte FROM _article left join _art_stock using(art_cleunik) where _article.art_cleunik=$vl_e_art_cleunik;";
  $result = _graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $ret=_graal_requete_article($vl_e_art_cleunik);
  $vl_c_code=fa_ent_xml($row['code']);
  $vl_c_mnemotechnique=fa_ent_xml($row['mnemotechnique']);
  $vl_c_description=fa_ent_xml($row['description']);
  $vl_gestion_dep_emp=$row['gestion'];
  $vl_nbdecimales=$row['nb_decimales_qte'];
  _graal_libere_requete_bd($result);
	switch ($vl_quoi){
		case "creation_dep_emp_regul_inventaire":
			if ($vl_gestion_dep_emp!=1){
				$sql_req="update _art_stock set gestion=1 where art_cleunik=$vl_e_art_cleunik;";
				$vf_c_echo=_graal_exec_requete($sql_req);
				$vl_gestion_dep_emp=1;
			}
			break;
	}
}
if ($vl_gestion_dep_emp==2) {
  $ml_depot=fa_brik_menulist_choix('xxx',1,-1,-1,'-15','ml_depot',"broadcaster_01",0);
  $ml_empla=fa_brik_menulist_choix('xxx',1,-1,-1,'-16','ml_empla',"broadcaster_01",0);
} else {
  $ml_depot=fa_ml_depot($vl_e_art_cleunik,-1,"broadcaster_01");
  $ml_empla=fa_ml_empla($vl_e_art_cleunik,-1,"broadcaster_01");
}
switch ($vl_quoi){
	case "":
		$ml_genre_mouvement=fa_brik_menulist_choix('130',1,-1,-1,'','ml_genre_mvt',true,-46);
		$ml_type_mvt_value=1;
		$tb_blocnotebrut="";
		$tb_qte_mvt=0;
		break;
	case "regul_inventaire":
	case "creation_dep_emp_regul_inventaire":
		$ml_genre_mouvement=fa_brik_menulist_choix('130',1,-1,-1,'','ml_genre_mvt',true,-41);
		$ml_type_mvt_value=3;
		$tb_blocnotebrut="Inventaire de RÃ©gularisation informatique !!!";
		$tb_qte_mvt=$quantite_inventaire;
		break;
}
$vl_tc_composants=array($id_inc_art_mousto);
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_bnz_100" id="_win_fen_art_mousto" onload="fa_aa(this);pf_aa_init();" onunload="pf_onunload();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include("js/_graal_art_mousto_01.js.php");
include_once("js/_graal_01.js.php");
if ($vl_e_art_cleunik==-1){
echo('<vbox flex="2">');
echo('</vbox>');
echo ("<splitter />");
}
echo <<<END
  <vbox flex="1">
  <groupbox id="groupe_article">
    <caption><label value="$vl_c_bnz_101"/></caption>
    <hbox>
      <label value="$vl_c_bnz_102" />
      <textbox id="tb_code_art" value="$vl_c_code" disabled="true" />
      <label value="$vl_c_bnz_103" />
      <textbox id="tb_code_mnemotechnique" value="$vl_c_mnemotechnique" disabled="true" />
      <label value="$vl_c_bnz_104" />
      <textbox flex="2" id="tb_code_description" value="$vl_c_description" disabled="true" />
    </hbox>
  </groupbox>
  <groupbox >
    <caption><label value="$vl_c_bnz_108"/></caption>
    <hbox>
      <label value="$vl_c_bnz_105"/>
      <hbox>
				<spacer flex="1"/>
				<datepicker type="popup" monthLeadingZero="true" dateLeadingZero="true" observes="broadcaster_01" id="dp_date_deb"/>
				<spacer flex="1"/>
			</hbox>                  
      <label value="$vl_c_bnz_106"/>
      <toolbarbutton id="tb_debut_maintenant" class="ag04" tooltiptext="$vl_c_bnz_107" oncommand="pf_maintenant(this.id)" observes="broadcaster_01"/>
	  <timepicker is24HourClock="true" id="tb_heu_deb" observes="broadcaster_01"/>
      $ml_genre_mouvement
      <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex='1' id='ml_type_mvt' _graal_nombre='3' value="$ml_type_mvt_value">
        <menupopup>
          <menuitem value='1' label="$vl_c_dico_00086"/>
          <menuitem value='2' label="$vl_c_dico_00087"/>
          <menuitem value='3' label="$vl_c_dico_00088"/>
        </menupopup>
      </menulist>
    </hbox>
    <hbox>
      <label value="$vl_c_bnz_110"/>
      <textbox tooltip="$sql_req" flex="1" id="tb_qte_mvt" min="-Infinity" type="number" hidespinbuttons="true" decimalplaces="$vl_nbdecimales" value="$tb_qte_mvt" observes="broadcaster_01" onblur="pf_mousto_valorise();"/>
      $ml_depot
      $ml_empla
    </hbox>
    <hbox>
      <label value="$vl_c_bnz_111"/>
          <hbox flex="2">
            <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" width="400" observes="broadcaster_02" flex="2" id="ml_mousto_base_valorisation" oncommand="pf_change_menu_actifs_mousto_base_valorisation();" flags="" ref="*" querytype="xml" datasources="">
              <template><query expr="*"/><action>
                <menupopup>
                  <menuitem uri="?" class="menuitem-iconic ?prop" _graal_nombre="?nombre" label="?tar_designation" value="?tar_cleunik" _graal_cleunik="?tar_cleunik" _graal_base_valorisation="?pu_reference"/>
                </menupopup>
              </action></template>
            </menulist>
			<textbox id="tb_pu_mvt" type="number" hidespinbuttons="true" decimalplaces="2" disabled="true"  onblur="pf_mousto_valorise();" _graal_base_valorisation=""/>
          </hbox>
      <label value="$vl_c_bnz_112"/>
      <textbox flex="1" id="tb_mt_mvt" type="number" hidespinbuttons="true" decimalplaces="2" disabled="true"  />
    </hbox>
    <label control="la_blocnotebrut" value="$vl_c_bnz_113"/>
    <textbox flex="1" id="tb_blocnotebrut"   multiline="true" value="$tb_blocnotebrut"/>
   </groupbox>
  <hbox> 
    <button width="40" flex="1" id="bt_ajouter" label="$vl_c_bnz_114" crop="end" dir="normal" oncommand="pf_validation('enregistrer')" />
    <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
END;
include("_graal_inc_articles_mousto_01.php");
echo <<<END
</vbox>
</window>
END;
?>
