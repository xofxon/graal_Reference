<?php
include("_graal_header_xml.inc.php");
include("_graal_var_portee.php");
/*
******************
Attention grosse modification le 21 avril 2008 : à cause des caractères unicodes envoyés dans des emails chinois et n'étant pas exploitables dans des fichiers xml, on ne récupère plus le message ici mais dans le _graal_xml_emimail_03
Attention à la future utilisation dans _graal_courriel_01_complement.js
*/
$vl_e_action_cleunik=intval(fa_recup_param("action_cleunik","-1"));
//$sql_req="SELECT _courriel_en.courriel_en_mes_cleunik,sujet,type,datas_vrac,message FROM _courriel_en,_courriel_en_mes where action_cleunik=$vl_e_action_cleunik and _courriel_en_mes.courriel_en_mes_cleunik=_courriel_en.courriel_en_mes_cleunik";
//$sql_req="SELECT _courriel_en.courriel_en_mes_cleunik,sujet,type,datas_vrac,message_texte FROM _courriel_en,_courriel_en_mes where action_cleunik=$vl_e_action_cleunik and _courriel_en_mes.courriel_en_mes_cleunik=_courriel_en.courriel_en_mes_cleunik;";
$sql_req="SELECT _courriel_en.courriel_en_mes_cleunik,sujet,type,datas_vrac,message_texte FROM _courriel_en left join _courriel_en_mes using (courriel_en_mes_cleunik) where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
echo('<Description>');
$row = mysql_fetch_assoc($result);
$vl_c_xml=simplexml_load_string($row['datas_vrac']);

$vl_c_destinataires=$vl_c_xml->nom_cou_destinataires[0]->attributes();
$vl_c_destinataires_cc=$vl_c_xml->nom_cou_destinataires_cc[0]->attributes();
$vl_c_destinataires_cci=$vl_c_xml->nom_cou_destinataires_cci[0]->attributes();
/*
 * seulement utilisé et alimenté dans les emailing
 */
if (isset($vl_c_xml->int_vl_c_affichernom[0])){$vl_c_affichernom=$vl_c_xml->int_vl_c_affichernom[0]->attributes();}
if (isset($vl_c_xml->remplacement_noms[0])){$vl_c_remplacement_noms=$vl_c_xml->remplacement_noms[0]->attributes();}
echo('<courriel_en_mes_cleunik data="'.fa_ent_xml($row['courriel_en_mes_cleunik']).'"/>');
echo('<sujet data="'.fa_ent_xml($row['sujet']).'"/>');
echo('<message_texte data="'.fa_ent_xml($row['message_texte']).'"/>');
echo('<affichernom data="'.fa_ent_xml($vl_c_affichernom).'"/>');
echo('<remplacement_noms data="'.fa_ent_xml($vl_c_remplacement_noms).'"/>');

echo('<type data="'.fa_ent_xml($row['type']).'"/>');
echo('<destinataires data="'.fa_ent_xml($vl_c_destinataires).'"/>');
echo('<destinataires_cc data="'.fa_ent_xml($vl_c_destinataires_cc).'"/>');
echo('<destinataires_cci data="'.fa_ent_xml($vl_c_destinataires_cci).'"/>');

$sql_req="select f1.doc_cleunik as doc_cleunik,f2.emplacement as nom_pj from _documents_rattachement f1 left join _documents f2 using(doc_cleunik) where f1.rat_cleunik=$vl_e_action_cleunik and f1.portee &$vl_e_piejoi;";
$sql_req="select f1.doc_cleunik as doc_cleunik,f2.emplacement as nom_pj,f2.titre as titre,count(f3.doc_cleunik) as nombre_criteres from _documents_rattachement f1 left join _documents f2 using(doc_cleunik) left join _documents_choix_fixes f3 using(doc_cleunik) where f1.rat_cleunik=$vl_e_action_cleunik and f1.portee &$vl_e_piejoi group by doc_cleunik;";
$result = _graal_requete_bd($sql_req);
$vl_e_j=-1;
while ($row = mysql_fetch_assoc($result)) {
	$vl_e_j++;
	echo('<nom_pj_'.$vl_e_j.' data="'.fa_ent_xml($row['nom_pj']).'"/>');
  echo('<cleunik_pj_'.$vl_e_j.' data="'.fa_ent_xml($row['doc_cleunik']).'"/>');
	echo('<nombre_criteres_'.$vl_e_j.' data="'.fa_ent_xml($row['nombre_criteres']).'"/>');
	echo('<titre_'.$vl_e_j.' data="'.fa_ent_xml($row['titre']).'"/>');
	
}
_graal_libere_requete_bd($result);
echo('<pj_nombre data="'.fa_ent_xml($vl_e_j+1).'"/>');

$sql_req="select count(*) as nb from _emailing_cleweb where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<destinataires_nombre data="'.fa_ent_xml($row['nb']).'"/>');
_graal_libere_requete_bd($result);
$sql_req="select count(*) as nb from _emailing_cleweb_attente where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<attente_nombre data="'.fa_ent_xml($row['nb']).'"/>');
_graal_libere_requete_bd($result);
$sql_req="select c_uuid from _actions where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<c_uuid data="'.fa_ent_xml($row['c_uuid']).'"/>');



echo('</Description>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
