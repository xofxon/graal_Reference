<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_typeacteur=intval(fa_recup_param('typeacteur','9'));
$vl_c_raisonsoc=fa_recup_param('raisonsoc','%');
$vl_c_quoi=intval(fa_recup_param('quoi','4'));
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_e_limit=intval(fa_recup_param('vl_e_limit','1'));
$vl_e_int_cleunik=intval(fa_recup_param('vl_e_int_cleunik',-1));
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik',-1));
$vl_c_type_recherche=intval(fa_recup_param('vl_c_type_requete',1));
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_sortie=fa_recup_param('sortie','das');
$prop_obsolete="css_0001";
$sql_req ="SELECT _acteurs.actif as act_actif, _act_interlo.actif as int_actif,_acteurs.act_cleunik as act_cleunik, _act_interlo.int_cleunik as int_cleunik,";
$sql_req.=" _act_interlo_fax.intel_cleunik as intel_cleunik, _acteurs.raisonsoc as raisonsoc, _acteurs.nomcommercial as nomcommercial, _choix.choix_valeur_texte_01 as civilite,";
$sql_req.="  concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui, _act_interlo.prenom as prenom, _act_interlo.patronyme as nom, _act_interlo_fax.telformate as notel,";
$sql_req.="  _act_interlo_fax.intel_05 as intel_05,_choixtel.choix_valeur_texte_01 as genretel, _choixact.choix_valeur_texte_01 as portee,_acteurs.typeacteur as typeacteur";
$sql_req.="  from _acteurs,_act_interlo,_choix,_act_interlo_fax,_choix _choixtel, _choix _choixact where _acteurs.act_cleunik = _act_interlo.act_cleunik";
$sql_req.="  and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo_fax.int_cleunik=_act_interlo.int_cleunik and _choixtel.choix_cleunik = _act_interlo_fax.choix_cleunik";
$sql_req.="  and _choixact.choix_cleunik = _acteurs.typeacteur";
/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */
$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
switch ($vs_gesacteurs_ml_zone){
	case '1':	//	Accès libre
		$req_liste_noire="";
		$req_liste_blanc="";
		break;
	case '3':	//	Accès sur liste noire
		$req_liste_noire=" and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=_acteurs.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		$req_liste_blanc="";
		break;
	case '4':	//	Accès sur liste blanche
		$req_liste_blanc=" and (select count(*) from _acteurs_blanc where _acteurs_blanc.act_cleunik=_acteurs.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) <> 0 ";
		$req_liste_noire="";
		break;
}
$sql_req.= $req_liste_blanc . $req_liste_noire;
switch ($vl_c_type_recherche){
	case 1:	//	Cas normal de recherche
		switch ($vl_e_typeacteur) {
		    case 2: $sql_req.=" and _acteurs.typeacteur =110000";break; //  membres de l'entreprise
		    case 3: $sql_req.=" and _acteurs.typeacteur =110001";break; //  Prospects clients  
		    case 4: $sql_req.=" and _acteurs.typeacteur =110003";break; //  Clients 
		    case 5: $sql_req.=" and _acteurs.typeacteur =110002";break; //  Prospects fournisseurs
		    case 6: $sql_req.=" and _acteurs.typeacteur =110004";break; //  Fournisseurs
		    case 7: $sql_req.=" and _acteurs.typeacteur =110005";break; //  Autres acteurs
		    case 8: $sql_req.=" and _acteurs.typeacteur =110006";break; //  Acteurs indéterminés
		    case 9: break; //  Tous les acteurs
		}
		switch ($vl_c_actifs) {
		  case '1': $sql_req.=" and _acteurs.actif=1";break; //  actifs
		  case '2': $sql_req.=" and _acteurs.actif=2";break;//  inactifs
		  case '0': break;//  tous
		}
		switch ($vl_c_quoi) {
		  case 1 : $sql_req.=" and _acteurs.raisonsoc like '$vl_c_raisonsoc%' ORDER BY `raisonsoc` ASC";break;  //  Raison sociale
		  case 2 : $sql_req.=" and _acteurs.nomcommercial like '$vl_c_raisonsoc%' ORDER BY `nomcommercial` ASC";break;  //  Nom commercial
		  case 3 : $sql_req.=" and (concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) like '$vl_c_raisonsoc%' or concat_ws(' ',_act_interlo.patronyme,_act_interlo.prenom) like '$vl_c_raisonsoc%') ORDER BY qui ASC";break;  //  Interlocuteur
		  case 4 :
				$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
				$b[0]='';
				$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_raisonsoc);
				$sql_req.=" and _act_interlo_fax.intel_05 like '$vl_c_chaine_nette%' ORDER BY `intel_05` ASC";break;  //  fax
		}
		$sql_req.="  LIMIT 0,$vl_e_limit";
		break;
	case 2:	//	fax d'un interlocuteur
		$sql_req.=" and _act_interlo_fax.int_cleunik=$vl_e_int_cleunik";
		break;
	case 3://	fax d'un acteur
		$sql_req.=" and _act_interlo_fax.act_cleunik=$vl_e_act_cleunik";
		break;
}
switch ($vl_c_sortie) {
  	case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
	    break;
	case "das":
    	$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
			echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
			echo(' int_cleunik="'.fa_ent_xml($row['int_cleunik']).'"');
			echo(' intel_cleunik="'.fa_ent_xml($row['intel_cleunik']).'"');
			echo(' raisonsoc="'.fa_ent_xml($row['raisonsoc']).'"');
			echo(' nc="'.fa_ent_xml($row['nomcommercial']).'"');
			echo(' civilite="'.fa_ent_xml($row['civilite']).'"');
			echo(' qui="'.fa_ent_xml($row['qui']).'"');
			echo(' prenom="'.fa_ent_xml($row['prenom']).'"');
			echo(' nom="'.fa_ent_xml($row['nom']).'"');
			echo(' notel="'.fa_ent_xml($row['notel']).'"');
			echo(' genretel="'.fa_ent_xml($row['genretel']).'"');
			echo(' portee="'.fa_ent_xml($row['portee']).'"');
			echo(' typeacteur="'.fa_ent_xml($row['typeacteur']).'"');
			if ($row['act_actif'] ==1) {
		    echo(' prop_act=""');
		  } else {
		    echo(' prop_act="'.$prop_obsolete.'"');
		  }
		  if ($row['int_actif'] ==1) {
		    echo(' prop_int=""');
		  } else {
		    echo(' prop_int="'.$prop_obsolete.'"');
		  }
			echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
		break;
}
?>
