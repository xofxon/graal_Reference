<?php
include("_graal_header_xml.inc.php");
include("_graal_var_portee.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
define('EOL', "\r\n");
// execution de la requète SQL
$vl_e_action_cleunik=intval(fa_recup_param("action_cleunik","-1"));
session_write_close();
$sql_req="SELECT _courriel_en.courriel_en_mes_cleunik,sujet,type,datas_vrac,message FROM _courriel_en left join _courriel_en_mes using(courriel_en_mes_cleunik) where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
$row = mysql_fetch_assoc($result);
//$vl_c_xml=simplexml_load_string($row['datas_vrac']);
//$vl_nb_pj=$vl_c_xml->pj_nombre[0]->attributes();
echo('<Description>');
echo('<courriel_en_mes_cleunik data="'.fa_ent_xml($row['courriel_en_mes_cleunik']).'"/>');
echo('<sujet data="'.fa_ent_xml($row['sujet']).'"/>');
echo('<type data="'.fa_ent_xml($row['type']).'"/>');
_graal_libere_requete_bd($result);

$sql_req="select f1.doc_cleunik as doc_cleunik,f2.emplacement as nom_pj from _documents_rattachement f1 left join _documents f2 using(doc_cleunik) where f1.rat_cleunik=$vl_e_action_cleunik and f1.portee &$vl_e_piejoi;";
$result = _graal_requete_bd($sql_req);
$vl_e_j=-1;
while ($row = mysql_fetch_assoc($result)) {
	$vl_e_j++;
	echo('<nom_pj_'.$vl_e_j.' data="'.fa_ent_xml($row['nom_pj']).'"/>');
  echo('<cleunik_pj_'.$vl_e_j.' data="'.fa_ent_xml($row['doc_cleunik']).'"/>');
}
_graal_libere_requete_bd($result);
echo('<pj_nombre data="'.fa_ent_xml($vl_e_j+1).'"/>');


$sql_req="select count(*) as nb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<destinataires_nombre data="'.fa_ent_xml($row['nb']).'"/>');
$sql_req="select count(*) as nb from _emailing_cleweb left join _act_interlo_mail on _emailing_cleweb.intweb=_act_interlo_mail.intweb_cleunik where valide=2 and action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<destinataires_nombre_pas_actifs data="'.fa_ent_xml($row['nb']).'"/>');
$sql_req="select count(*) as nb from _emailing_cleweb left join _act_interlo_mail on _emailing_cleweb.intweb=_act_interlo_mail.intweb_cleunik where veuxpasdemail=2 and action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<destinataires_nombre_veux_pas_de_mail data="'.fa_ent_xml($row['nb']).'"/>');
$sql_req="select count(*) as nb from _emailing_trackin where action_cleunik=$vl_e_action_cleunik and nbclic<>0;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<destinataires_clics data="'.fa_ent_xml($row['nb']).'"/>');
$sql_req="select count(*) as nb from _emailing_ouvre where action_cleunik=$vl_e_action_cleunik and nbclic<>0;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<destinataires_ouvre data="'.fa_ent_xml($row['nb']).'"/>');
echo('</Description>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
