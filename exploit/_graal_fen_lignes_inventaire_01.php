<?php
include("_graal_header_xul.inc.php");
define('EOL', "\r\n");
$vl_e_etat=intval(fa_recup_param('vl_e_etat',0));
$vl_e_inactifs=intval(fa_recup_param('vl_e_inactifs',0));
$vl_e_inv_cleunik=intval(fa_recup_param('vl_e_inv_cleunik',10000001));
$vl_dateheureinv=fa_recup_param('vl_dateheureinv','19610123');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_b_affichage_critere=intval(fa_recup_param('vl_b_affichage_critere',2));
$vl_c_bby_111=fa_recup_dico("bby_111");
$vl_c_bby_112=fa_recup_dico("bby_112");
$vl_c_id_fenetre="aaaaaa";
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_e_i=0;
$sql_req="SELECT tarif_reference as `tarif_reference`,critere_cleunik FROM _inventaire where inv_cleunik=$vl_e_inv_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_tarif_reference=$row['tarif_reference'];
$vl_critere_cleunik=$row['critere_cleunik'];
_graal_libere_requete_bd($result);
if ($vl_critere_cleunik!=0) {
  $sql_req = "SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik,n3.pr as pr,n3.nbdec_pr as nbdec_pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven,n6.choix_cleunik,n7.choix_code,n7.choix_valeur_texte_01,n8.nb_decimales_qte FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _art_stock n8 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) left join _art_choix_fixes n6 using(art_cleunik) left join _choix n7 using(choix_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 and n6.critere_cleunik=$vl_critere_cleunik";
  $vl_c_zone='4';
} else {
$sql_req = "SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik as art_cleunik,n3.pr as pr,n3.nbdec_pr as nbdec_pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven as qte_inven,n8.nb_decimales_qte FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _art_stock n8 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4";
}
switch ($vl_e_etat) {
  case 1:break; //toutes les lignes
  case 2:$sql_req.= " AND n5.etat=0";break;//  Les lignes à inventorier
  case 3:$sql_req.= " AND n5.etat=1";break; //  Lignes déja inventoriées
  case 4:$sql_req.= " AND n5.etat=2";break; //  Lignes sauvegardées
}
switch ($vl_e_inactifs) {
  case 1:$sql_req.= " AND n1.actif=2";break;//  Articles inactifs
  case 2:$sql_req.= " AND n1.actif=1";break; //  Articles actifs
  case 3:break; //toutes les lignes
}
switch ($vl_c_zone)  {
  case '1':$sql_req.=" ORDER BY `description` ASC";break; //  Description courte
  case '2':$sql_req.=" ORDER BY `code` ASC";break; //  Code
  case '3':$sql_req.=" ORDER BY `mnemotechnique` ASC";break; //  Mnémotechnique
  case '4':$sql_req.=" ORDER by choix_code,code;";break;  // critère
}
$result = _graal_requete_bd($sql_req);
$vl_e_nombre=mysql_num_rows($result);
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" id="_graal_fen_lignes_inventaire" _graal_nombre="$vl_e_nombre" _graal_inv_cleunik="$vl_e_inv_cleunik" _graal_dateheureinv="$vl_dateheureinv" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_fen_lignes_inventaire_01.js.php");
echo <<<END
<description>Il y a $vl_e_nombre lignes.</description>
<vbox flex="1" class="overflow_01">
<arrowscrollbox orient="vertical" flex="1">
END;
while ($row = mysql_fetch_assoc($result)){
  $vl_art_cleunik=fa_ent_xml($row['art_cleunik']);
  $vl_code=fa_ent_xml($row['code']);
  $vl_description=fa_ent_xml($row['description']);
  $vl_mnemotechnique=fa_ent_xml($row['mnemotechnique']);
  $vl_etat=fa_ent_xml($row['etat']);
  $vl_qte_inven=fa_ent_xml($row['qte_inven']);
  $vl_nb_decimales_qte=$row['nb_decimales_qte'];
  $vl_qte_inven=fa_reel($vl_qte_inven,$vl_nb_decimales_qte);
  if ($vl_etat==0) {$vl_qte_inven=-1;}
  if ($vl_etat==1) {$vl_art_cleunik=-1;}
  $vl_e_i++;
  $vl_id="ligne_".$vl_e_i;
  switch ($vl_e_inactifs) {
    case 1: //  Articles actifs
    case 3:
      $vl_c_chaine_actif="<button label='Inactif !!'/>";
    break; //toutes les lignes
    case 2:  //  Articles inactifs
      $vl_c_chaine_actif="";
      break;
  }
  if ($row['actif']==2) {
    $vl_c_chaine_actif_affiche=$vl_c_chaine_actif; } else 
  {
    $vl_c_chaine_actif_affiche="";
  }
  if ($row['derpa']==0) {
    $derpa=""; } else
  {
    //$derpa=fa_reel(fa_ent_xml($row['derpa']),4);
    $derpa=fa_reel(fa_ent_xml($row['derpa']),$row['nbdec_prix']);
  }
  $val_derpa=$row['derpa']*1000;
  if ($row['pamp']==0) {
    $pamp=""; } else 
  {
    //$pamp=fa_reel(fa_ent_xml($row['pamp']),4);
    $pamp=fa_reel(fa_ent_xml($row['pamp']),$row['nbdec_prix']);
    
  }
  $val_pamp=$row['pamp']*1000;
  if ($row['pr']==0) {
    $pr=""; } else 
  {
    //$pr=fa_reel(fa_ent_xml($row['pr']),4);
    $pr=fa_reel(fa_ent_xml($row['pr']),$row['nbdec_pr']);
    
  }
  $val_pr=$row['pr']*1000;
  if ($row['pr_generique']==0) {
    $pr_generique=""; } else 
  {
    //$pr=fa_reel(fa_ent_xml($row['pr']),4);
    $pr_generique=fa_reel(fa_ent_xml($row['pr_generique']),$row['nbdec_pr']);
    
  }
  $val_pr_generique=$row['pr_generique']*1000;



  switch ($vl_tarif_reference) {
    case "-4":  //  Rien
      $vl_c_chaine_prix_reference=('<textbox value="0" disabled="true" />');
      $vl_nb_dec=0;
      break;
    case "-1":  //  Dernier prix d'achat
      $vl_c_chaine_prix_reference=("<textbox class='droite' value='$derpa' disabled='true' />");
      $vl_nb_dec=$row['nbdec_prix'];
      break;
    case "-3":  //  PAMP
      $vl_c_chaine_prix_reference=("<textbox class='droite' value='$pamp' disabled='true' />");
      $vl_nb_dec=$row['nbdec_prix'];
      break;
    case "-2":  //  Prix de revient de fabrication
      $vl_c_chaine_prix_reference=("<textbox class='droite' value='$pr' disabled='true' />");
      $vl_nb_dec=$row['nbdec_pr'];
      break;
    case "-5":  //  Prix de revient générique
      $vl_c_chaine_prix_reference=("<textbox class='droite' value='$pr_generique' disabled='true' />");
      $vl_nb_dec=$row['nbdec_pr'];
      break;

  }
  $vl_c_complement_01="";
  if ($vl_b_affichage_critere==1) {
    switch ($vl_c_zone)  {
      case '1': //  Description courte
      case '2': //  Code
      case '3':
        $vl_c_complement_01="";
        break; //  Mnémotechnique
      case '4':
        $vl_c_complement_01="<label value='".fa_ent_xml($row['choix_code'])."(".fa_ent_xml($row['choix_valeur_texte_01']).")'/>";
       break;  // critère
    }
  }
 
  
if ($vl_etat!=1) {
echo <<<END
  <hbox><spacer flex="2" /><description><html:span style="font-weight: bold;">$vl_description</html:span>(<html:span style="text-decoration: underline;color: rgb(51, 51, 255);">$vl_code</html:span>)-> <html:span style="font-style: italic;">$vl_mnemotechnique</html:span> </description><textbox class='droite' _graal_cleunik="$vl_art_cleunik" _graal_numero="$vl_e_i" id="$vl_id" value="$vl_qte_inven"   onkeypress="pf_clavier(event,'$vl_id')" _graal_nbdec="$vl_nb_dec"/>$vl_c_chaine_prix_reference $vl_c_complement_01 $vl_c_chaine_actif_affiche</hbox>
END;
}
else{
echo <<<END
  <hbox><spacer flex="2" /><description><html:span style="font-weight: bold;">$vl_description</html:span>(<html:span style="text-decoration: underline;color: rgb(51, 51, 255);">$vl_code</html:span>)-> <html:span style="font-style: italic;">$vl_mnemotechnique</html:span> </description><textbox class='droite' _graal_cleunik="$vl_art_cleunik" id="$vl_id" value="$vl_qte_inven" disabled="true" _graal_nbdec="$vl_nb_dec" />$vl_c_chaine_prix_reference $vl_c_complement_01 $vl_c_chaine_actif_affiche</hbox>
END;
}
  echo EOL;
  }
echo <<<END
</arrowscrollbox>
  <hbox >
    <button flex="1" id="bt_sauvegarde" label="$vl_c_bby_111" oncommand="pf_sauvegarde();"/>
    <button flex="1" id="bt_validation" label="$vl_c_bby_112" oncommand="pf_validation();"/>
  </hbox>  
</vbox>
</window>
END;
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
