<?php
require("_graal_fonctions_diverses.php");
require_once("_graal_fonctions_mysql.php");
include_once("_graal_var_portee.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_c_qui=fa_recup_param('vl_c_qui','888888');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
$vl_c_sortie=fa_recup_param('sortie','rdf');
$vl_c_inactifs=fa_recup_param('vl_c_inactifs','0');
$vl_e_tarif_cleunik=intval(fa_recup_param('vl_e_tarif_cleunik',"0"));
$vl_c_limit=fa_recup_param('vl_c_limit','250');
$vl_e_acteur_choix=intval(fa_recup_param('vl_e_acteur_choix',0));
$vl_e_acteur_choix_cleunik=fa_recup_param('vl_e_acteur_choix_cleunik','0');
$vl_e_acteur_critere_cleunik=fa_recup_param('vl_e_acteur_critere_cleunik','0');
$vl_c_particularisme=fa_recup_param('vl_c_particularisme','');
$vl_brk_ml_utilisateurs=intval(fa_recup_param('vl_brk_ml_utilisateurs','0'));
$vl_c_action_particularisme=fa_recup_param('vl_c_action_particularisme','');
$catcompta_cleunik=fa_recup_param('catcompta_cleunik',"-5");

//	Clients
    $requete_particuliere = "SELECT _acteurs.act_cleunik as act_cleunik,a5.choix_valeur_texte_01 as civilite,a4.prenom,a4.patronyme,_acteurs.raisonsoc as raisonsoc,";
    $requete_particuliere.= "_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial, concat_ws(' ',a4.patronyme, a4.prenom) as colonne_complementaire";
$requete_particuliere.= ",a1.adr_complementnom as complement_nom,a1.adr_ligne1,a1.adr_ligne2,a1.adr_ligne3,concat(a1.adr_cp,' ') as cp,a1.adr_ville,a2.choix_valeur_texte_01 as pays";
$requete_particuliere.= " FROM _acteurs left join _act_adresses a1 on _acteurs.act_cleunik=a1.act_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik ";
$requete_particuliere.=" left join _choix on _choix.choix_cleunik=_acteurs.typeacteur";
$requete_particuliere.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik left join _choix a5 on a5.choix_cleunik=a4.choix_cleunik";
$requete_particuliere.=" left join _act_choix_fixes x4 on _acteurs.act_cleunik=x4.act_cleunik";
$requete_particuliere.=" left join _act_interlo_choix_fixes x5 on a4.int_cleunik=x5.int_cleunik ";
$requete_particuliere.=" where _acteurs.typeacteur IN (110003) and a4.actif=1 and _acteurs.raisonsoc like '%%' and x5.choix_cleunik in(80000023)  and x4.choix_cleunik in(10001956)";

//	Prospects Clients
    $requete_particuliere = "SELECT _acteurs.act_cleunik as act_cleunik,a5.choix_valeur_texte_01 as civilite,a4.prenom,a4.patronyme,_acteurs.raisonsoc as raisonsoc,";
    $requete_particuliere.= "_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial, concat_ws(' ',a4.patronyme, a4.prenom) as colonne_complementaire";
$requete_particuliere.= ",a1.adr_complementnom as complement_nom,a1.adr_ligne1,a1.adr_ligne2,a1.adr_ligne3,concat(a1.adr_cp,' ') as cp,a1.adr_ville,a2.choix_valeur_texte_01 as pays";
$requete_particuliere.= " FROM _acteurs left join _act_adresses a1 on _acteurs.act_cleunik=a1.act_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik ";
$requete_particuliere.=" left join _choix on _choix.choix_cleunik=_acteurs.typeacteur";
$requete_particuliere.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik left join _choix a5 on a5.choix_cleunik=a4.choix_cleunik";
$requete_particuliere.=" left join _act_choix_fixes x4 on _acteurs.act_cleunik=x4.act_cleunik";
$requete_particuliere.=" left join _act_interlo_choix_fixes x5 on a4.int_cleunik=x5.int_cleunik ";
$requete_particuliere.=" where _acteurs.typeacteur IN (110001) and a4.actif=1 and _acteurs.raisonsoc like '%%' and x5.choix_cleunik in(80000023)  and x4.choix_cleunik in(10001956)";

 $requete_particuliere = "";
if ($vl_c_type_recherche_cleunik!=""){
	// comme ça ne marche pas dans tous les cas, on utilise l'autre méthode qui fonctionne bien
	$vl_e_acteur_choix_cleunik=$vl_e_choix_cleunik;
	$vl_e_acteur_critere_cleunik=$vl_e_critere_cleunik;
	$vl_e_choix_cleunik=0;
	$vl_e_critere_cleunik=0;
	switch ($vl_c_type_recherche_cleunik){
		case "in":
			$vl_e_acteur_choix=1;
			break;
		case "notin":
			$vl_e_acteur_choix=2;
			break;
	}
	$vl_c_type_recherche_cleunik="";
}
/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */
$sql_req_exclure_entreprise= " AND _acteurs.act_cleunik <>0 ";
$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
switch ($vs_gesacteurs_ml_zone){
	case '1':	//	Accès libre
		$req_liste_noire="";
		$req_liste_blanc="";
		break;
	case '3':	//	Accès sur liste noire
		$req_liste_noire=" and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=_acteurs.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		$req_liste_blanc="";
		$sql_req_exclure_entreprise="";
		break;
	case '4':	//	Accès sur liste blanche
		$req_liste_blanc=" and (select count(*) from _acteurs_blanc where _acteurs_blanc.act_cleunik=_acteurs.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) <> 0 ";
		$req_liste_noire="";
		$sql_req_exclure_entreprise="";
		break;
}
switch ($vl_c_particularisme) {
	case "liste_blanc_tousss":
		$sql_req_exclure_entreprise="";
		switch ($vl_c_action_particularisme){
			case 1:	//	ajouter
				$join_00=" left join _acteurs_blanc on _acteurs.act_cleunik=_acteurs_blanc.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_brk_ml_utilisateurs ";
				$cond_00=" and _acteurs_blanc.act_cleunik is null ";
				 break;
			case 2:	//supprimer
				$join_00=" join _acteurs_blanc on _acteurs.act_cleunik=_acteurs_blanc.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_brk_ml_utilisateurs ";
				break;
		}
		break;
  	case "liste_noire_tousss":
  		$sql_req_exclure_entreprise="";
  		switch ($vl_c_action_particularisme){
			case 1:	//	ajouter
				$join_00=" left join _acteurs_noire on _acteurs.act_cleunik=_acteurs_noire.act_cleunik and _acteurs_noire.uti_cleunik=$vl_brk_ml_utilisateurs ";
				$cond_00=" and _acteurs_noire.act_cleunik is null ";
				 break;
			case 2:	//supprimer
				$join_00=" join _acteurs_noire on _acteurs.act_cleunik=_acteurs_noire.act_cleunik and _acteurs_noire.uti_cleunik=$vl_brk_ml_utilisateurs ";
				break;
		}
		break;
}
switch ($vl_e_acteur_choix){
	case 0:break;
	case 3:break;
	case 1://	avec critère
		$join_01=" left join _act_choix_fixes a3 on _acteurs.act_cleunik=a3.act_cleunik ";
		if ($vl_e_acteur_choix_cleunik!=0){
			$cond_01=" and a3.choix_cleunik in($vl_e_acteur_choix_cleunik) ";
			//$grou_01=" group by _acteurs.act_cleunik";
		} else {
			$cond_01=" and a3.critere_cleunik in($vl_e_acteur_critere_cleunik) ";
			//$grou_01=" group by _acteurs.act_cleunik";
		}

}
switch ($vl_e_critere_cleunik) {
	case 0: //  pas de gestion du critère
		$grou_01=" group by _acteurs.act_cleunik";
    	break;
    	$join_01="";
    	$join_02="";
    	$cond_01="";
    	$grou_01="";
    	$csql_01="";
    	$csql_02="";
    default:

    	switch ($vl_e_choix_cleunik) {
        	case 0: //  on recherche sur le critère

    	switch ($vl_c_type_recherche_cleunik) {
                  	case "in"	:
                  		$join_01=" left join _act_choix_fixes on _acteurs.act_cleunik=_act_choix_fixes.act_cleunik  ";
                  		$cond_01=" and _act_choix_fixes.critere_cleunik in($vl_e_critere_cleunik) ";
                  		$grou_01=" group by _acteurs.act_cleunik";
                  		$vl_c_zone="0";
                  		$csql_02=" ,g1.choix_code,g1.choix_valeur_texte_01,g2.critere_code,g2.critere_denomination ";
                  		$join_02=" left join _choix g1 on _act_choix_fixes.choix_cleunik=g1.choix_cleunik left join _criteres g2 on _act_choix_fixes.critere_cleunik=g2.critere_cleunik ";
                  		break;
                  	case "notin":
                  		$join_01="";
                  		$cond_01="";
                  		$grou_01=" group by _acteurs.act_cleunik having nb=0";
                  		$csql_01=",(select count(*) from _act_choix_fixes f2 where f2.act_cleunik=_acteurs.act_cleunik and critere_cleunik in($vl_e_critere_cleunik)) as nb ";
                  		$vl_c_zone="0";
                  		break;
                 }
            	break;
            default://  on recherche sur le choix du critère
                switch ($vl_c_type_recherche_cleunik) {
                  	case "in"	:
                  		$join_01=" left join _act_choix_fixes on _acteurs.act_cleunik=_act_choix_fixes.act_cleunik  ";
                  		$cond_01=" and _act_choix_fixes.choix_cleunik in($vl_e_choix_cleunik) ";
                  		$grou_01=" group by _acteurs.act_cleunik";
                  		$vl_c_zone="0";
                  		$csql_02=" ,g1.choix_code,g1.choix_valeur_texte_01,g2.critere_code,g2.critere_denomination ";
                  		$join_02=" left join _choix g1 on _act_choix_fixes.choix_cleunik=g1.choix_cleunik left join _criteres g2 on _act_choix_fixes.critere_cleunik=g2.critere_cleunik ";
                  		break;
                  	case "notin":
                  		$join_01=" left join _act_choix_fixes on _acteurs.act_cleunik=_act_choix_fixes.act_cleunik  ";
                  		$cond_01=" AND a2.act_cleunik is NULL or a2.choix_cleunik not in($vl_e_choix_cleunik) ";
                  		$grou_01=" group by _acteurs.act_cleunik";
                  		$vl_c_zone="0";
                  		break;
                 }
                 break;
            }
            $sql_req.= " AND _acteurs.actif in($vl_c_actifs,$vl_c_inactifs)";
}
switch ($vl_c_zone) {
	case '9':	//	Recherche sur patronyme interlocuteur
		$csql_01.=",concat_ws(' ',_act_interlo.patronyme, _act_interlo.prenom) as colonne_complementaire ";
		break;
	case '10':	//	Recherche sur téléphone d'interlocuteur
		$csql_01.=",telformate as colonne_complementaire ";
		break;
	case '11':	//	Recherche sur fax d'interlocuteur
		$csql_01.=",telformate as colonne_complementaire ";
		break;
	case '12':	//	Recherche sur courriel d'interlocuteur
		$csql_01.=",refweb as colonne_complementaire ";
		break;
	case '13':	//	Recherche sur code postal acteur
		$csql_01.=",adr_cp as colonne_complementaire ";
		break;
	case '14':	//	Recherche sur ville acteur
		$csql_01.=",adr_ville as colonne_complementaire ";
		break;
	default:
		$csql_01.=",'' as colonne_complementaire ";
		break;
}
switch ($vl_c_sortie) {
  case "das":
  case "sql":
    $selection = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,";
$selection.= " "._graalsql_datetime("_acteurs.dateheurecreation")." as dateheurecreation_clair,_acteurs.dateheurecreation as dateheurecreation,";
$selection.= " _acteurs.typeacteur as typeacteur,_acteurs.codealphanum15 as code,_acteurs.mnemotechnique as mnemotechnique,_acteurs.actif as actif $csql_01 $csql_02 ";
$selection.= " FROM _acteurs ";
    break;
  case "excel_adresses_postales":
    $selection = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial $csql_01 $csql_02";
$selection.= ",a1.adr_complementnom as complement_nom,a1.adr_ligne1,a1.adr_ligne2,a1.adr_ligne3,concat(a1.adr_cp,' ') as cp,a1.adr_ville,a2.choix_valeur_texte_01 as pays";
$selection.= " FROM _acteurs left join _act_adresses a1 on _acteurs.act_cleunik=a1.act_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik";
    break;
  case "excel_adresses_postales_interlo":
    $selection = "SELECT _acteurs.act_cleunik as act_cleunik,a5.choix_valeur_texte_01 as civilite,a4.prenom,a4.patronyme,_acteurs.raisonsoc as raisonsoc,";
    $selection.= "_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial $csql_01 $csql_02";
$selection.= ",a1.adr_complementnom as complement_nom,a1.adr_ligne1,a1.adr_ligne2,a1.adr_ligne3,concat(a1.adr_cp,' ') as cp,a1.adr_ville,a2.choix_valeur_texte_01 as pays";
$selection.= " FROM _acteurs left join _act_adresses a1 on _acteurs.act_cleunik=a1.act_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik ";
$selection.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik left join _choix a5 on a5.choix_cleunik=a4.choix_cleunik";
    break;
  case "excel_adresses_courriels_interlo":
    $selection = "SELECT _acteurs.act_cleunik as act_cleunik,a5.choix_valeur_texte_01 as civilite,a4.prenom,a4.patronyme,_acteurs.raisonsoc as raisonsoc,";
    $selection.= "_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial $csql_01 $csql_02";
    $selection.= ",a1.refweb,case a1.valide when 1 then 'Actif' when 2 then 'Inactif' when 3 then 'Ne sais pas' END as 'actif',a2.choix_valeur_texte_01 as genre";
	$selection.= " FROM _acteurs ";
	$selection.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik left join _choix a5 on a5.choix_cleunik=a4.choix_cleunik";
	$selection.=" inner join _act_interlo_mail a1 on a4.int_cleunik=a1.int_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik ";
  break;
	case "excel_téléphones_interlo":
    $selection = "SELECT _acteurs.act_cleunik as act_cleunik,a5.choix_valeur_texte_01 as civilite,a4.prenom,a4.patronyme,_acteurs.raisonsoc as raisonsoc,";
    $selection.= "_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial $csql_01 $csql_02";
    $selection.= ",concat(a1.telformate,' ') as 'Tel',a2.choix_valeur_texte_01 as genre";
	$selection.= " FROM _acteurs ";
	$selection.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik left join _choix a5 on a5.choix_cleunik=a4.choix_cleunik";
	$selection.=" inner join _act_interlo_tel a1 on a4.int_cleunik=a1.int_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik ";
    break;
    case "excel_totale_01":
    $selection = "SELECT _acteurs.act_cleunik as act_cleunik,a5.choix_valeur_texte_01 as civilite,a4.prenom,a4.patronyme,_acteurs.raisonsoc as raisonsoc,_acteurs.actif as acteur_actif";
    $selection.= ",_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial $csql_01 $csql_02";
    $selection.= ",ifnull(concat(a1.telformate,' '),'') as 'Tel',ifnull(a2.choix_valeur_texte_01,'') as genre_tel";
    $selection.= ",ifnull(a10.refweb,''),case a10.valide when 1 then 'Actif' when 2 then 'Inactif' when 3 then 'Ne sais pas' when null then '' END as 'actif',ifnull(a20.choix_valeur_texte_01,'') as genre_courriel";
    $selection.= ",ifnull(a11.adr_complementnom,'') as complement_nom,ifnull(a11.adr_ligne1,''),ifnull(a11.adr_ligne2,''),ifnull(a11.adr_ligne3,''),ifnull(concat(a11.adr_cp,' '),'') as cp,ifnull(a11.adr_ville,''),ifnull(a21.choix_valeur_texte_01,'') as pays";
	$selection.= " FROM _acteurs ";
	$selection.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik left join _choix a5 on a5.choix_cleunik=a4.choix_cleunik";
	$selection.=" left join _act_interlo_tel a1 on a4.int_cleunik=a1.int_cleunik left join _choix a2 on a1.choix_cleunik=a2.choix_cleunik ";
	$selection.=" left join _act_interlo_mail a10 on a4.int_cleunik=a10.int_cleunik left join _choix a20 on a10.choix_cleunik=a20.choix_cleunik ";
	$selection.=" left join _act_adresses a11 on _acteurs.act_cleunik=a11.act_cleunik left join _choix a21 on a11.choix_cleunik=a21.choix_cleunik";
    break;

  }


$join_01=$join_00.$join_01." left join _choix on _choix.choix_cleunik=_acteurs.typeacteur ";
switch ($vl_c_zone) {
	case '9':
		$join_01.=" left join _act_interlo on _act_interlo.act_cleunik=_acteurs.act_cleunik";
		break;
	case '10':
		$join_01.=" left join _act_interlo_tel on _act_interlo_tel.act_cleunik=_acteurs.act_cleunik";
		break;
	case '11':
		$join_01.=" left join _act_interlo_fax on _act_interlo_fax.act_cleunik=_acteurs.act_cleunik";
		break;
	case '12':
		$join_01.=" left join _act_interlo_mail on _act_interlo_mail.act_cleunik=_acteurs.act_cleunik";
		break;
	case '13':
	case '14':
		$join_01.=" left join _act_adresses on _act_adresses.act_cleunik=_acteurs.act_cleunik";
		break;

}

/*
echo $vl_c_actifs.EOL;
echo $vl_c_type.EOL;
echo $vl_c_qui.EOL;
die();
*/
//die($vl_c_actifs);

/*
switch ($vl_c_sortie) {
	case "excel_adresses_postales_interlo":
	case "excel_adresses_courriels_interlo":
	case "excel_téléphones_interlo":
	case "excel_totale_01":
	switch ($vl_c_actifs) {
	  case "6":
		$vs_envag=fa_recup_session('vs_envag','0');	//	Traitement de base emailing
		$vs_envah=fa_recup_session('vs_envah','');	//	Nom des bases externes
		$vs_envai=fa_recup_session('vs_envai','');	//	Nom en clair des bases externes
	    $sql_req_panier = "SELECT panier_requete_selection as req,panier_resultat,panier_type,panier_portee FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
	    $result = _graal_requete_bd($sql_req_panier);
	    $row = mysql_fetch_assoc($result);
	    if ($row['panier_type']==1) {
	      $vl_act_cleunik=$row['panier_resultat'];
	      _graal_libere_requete_bd($result);
	    } else {
	      $sql_req_panier = $row['req'];
	      $panier_portee=$row['panier_portee'];
	      //echo $sql_req_panier;
	      _graal_libere_requete_bd($result);
	      //$sql_req_panier="select f1.act_cleunik from box_via_emailing._graal f1 left join box_via_emailing._actions f2 using (action_cleunik) left join box_via_emailing._acteurs f3 on f1.act_cleunik=f3.act_cleunik left join box_via._acteurs f4 on f3.c_uuid=f4.c_uuid where f2.choix_cleunik=-110124 and f3.typeacteur=110006 and f4.act_cleunik is null;";
	    	if ($vs_envag!=0){
				$argument1=explode("|",$vs_envah);
				$nom_base_h=$argument1[0];
				$nom_base_i=$argument1[1];
				$vl_c_recherche="|base_source|";
	      		$vl_c_remplace=$nom_base_h;
	      		$sql_req_panier=str_replace($vl_c_recherche,$vl_c_remplace,$sql_req_panier);
	      		$vl_c_recherche="|base_cible|";
	      		$vl_c_remplace=$nom_base_i;
	      		$sql_req_panier=str_replace($vl_c_recherche,$vl_c_remplace,$sql_req_panier);
			}
	      $result = _graal_requete_bd($sql_req_panier);
	      $vl_act_cleunik="";
	      while ($row = mysql_fetch_assoc($result)) {
	      	if ($panier_portee&$vl_e_interl){
		    	$vl_act_cleunik.=$row['int_cleunik'].',';
		    }
	  		if ($panier_portee&$vl_e_acteur){
		    	$vl_act_cleunik.=$row['act_cleunik'].',';
		    }
	      }
	      if ($vl_act_cleunik!="") {
	        $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
	      }
	  	//die ($panier_portee);
		  	if ($vl_act_cleunik=="") {$vl_act_cleunik=-3;}  //  Impossible
		    if ($panier_portee&$vl_e_interl){
		    	$grou_01="";
		    	$vl_c_inclusion_panier=" AND a4.int_cleunik IN($vl_act_cleunik)";
		    }
	  		if ($panier_portee&$vl_e_acteur){
		    	$vl_c_inclusion_panier=" AND _acteurs.act_cleunik IN($vl_act_cleunik)";
		    }
	    }

	  	break;
	  default:
	  	break;
	}
	default:
}
*/
	switch ($vl_c_actifs) {
	  case "6":
		$vs_envag=fa_recup_session('vs_envag','0');	//	Traitement de base emailing
		$vs_envah=fa_recup_session('vs_envah','');	//	Nom des bases externes
		$vs_envai=fa_recup_session('vs_envai','');	//	Nom en clair des bases externes
	    $sql_req_panier = "SELECT panier_requete_selection as req,panier_resultat,panier_type,panier_portee FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
	    $result = _graal_requete_bd($sql_req_panier);
	    $row = mysql_fetch_assoc($result);
	    if ($row['panier_type']==1) {
	      $vl_act_cleunik=$row['panier_resultat'];
	      _graal_libere_requete_bd($result);
	    } else {
	      $sql_req_panier = $row['req'];
	      $panier_portee=$row['panier_portee'];
	      //echo $sql_req_panier;
	      _graal_libere_requete_bd($result);
	      //$sql_req_panier="select f1.act_cleunik from box_via_emailing._graal f1 left join box_via_emailing._actions f2 using (action_cleunik) left join box_via_emailing._acteurs f3 on f1.act_cleunik=f3.act_cleunik left join box_via._acteurs f4 on f3.c_uuid=f4.c_uuid where f2.choix_cleunik=-110124 and f3.typeacteur=110006 and f4.act_cleunik is null;";
	    	if ($vs_envag!=0){
				$argument1=explode("|",$vs_envah);
				$nom_base_h=$argument1[0];
				$nom_base_i=$argument1[1];
				$vl_c_recherche="|base_source|";
	      		$vl_c_remplace=$nom_base_h;
	      		$sql_req_panier=str_replace($vl_c_recherche,$vl_c_remplace,$sql_req_panier);
	      		$vl_c_recherche="|base_cible|";
	      		$vl_c_remplace=$nom_base_i;
	      		$sql_req_panier=str_replace($vl_c_recherche,$vl_c_remplace,$sql_req_panier);
			}
	      $result = _graal_requete_bd($sql_req_panier);
	      $vl_act_cleunik="";
	      while ($row = mysql_fetch_assoc($result)) {
	      	if ($panier_portee&$vl_e_interl){
		    	$vl_act_cleunik.=$row['int_cleunik'].',';
		    }
	  		if ($panier_portee&$vl_e_acteur){
		    	$vl_act_cleunik.=$row['act_cleunik'].',';
		    }
	      }
	      if ($vl_act_cleunik!="") {
	        $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
	      }
	  	//die ($panier_portee);
		  	if ($vl_act_cleunik=="") {$vl_act_cleunik=-3;}  //  Impossible
		    if ($panier_portee&$vl_e_interl){
		    	$grou_01="";
		    	$join_01.=" left join _act_interlo a4 on a4.act_cleunik=_acteurs.act_cleunik";
		    	$vl_c_inclusion_panier=" AND a4.int_cleunik IN($vl_act_cleunik)";
		    }
	  		if ($panier_portee&$vl_e_acteur){
		    	$vl_c_inclusion_panier=" AND _acteurs.act_cleunik IN($vl_act_cleunik)";
		    }
	    }

	  	break;
	  default:
	  	break;
	}



















switch ($vl_c_actifs) {
  case '3': // Panier ou requête
    //  traités dans les fichiers de sortie ( voir tout en bas du code)
    break;
  case "6":	// Panier ou requête déjà traité plus haut
  case '1':
  case '2':
  case '0':
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_acteur');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        unset($_SESSION["$vl_c_var"]);
        $vl_act_cleunik="";
        if(is_array($vl_t_listecles)) {
          $vl_e_i=-1;
          foreach($vl_t_listecles as $vl_raf) {
            $vl_e_i++;
            $vl_act_cleunik.=$vl_t_listecles[$vl_e_i].',';
          }
        }
        if ($vl_act_cleunik!="") {
          $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
        } else {
          $vl_act_cleunik=-99999999999999999;
        }
        IF ($vl_e_critere_cleunik!=0){
        	$sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,";
        	$sql_req.= " "._graalsql_datetime("_acteurs.dateheurecreation")." as dateheurecreation_clair,_acteurs.dateheurecreation as dateheurecreation,";
            $sql_req.=" _acteurs.typeacteur as typeacteur,_acteurs.codealphanum15 as code,_acteurs.mnemotechnique as mnemotechnique,_acteurs.actif as actif $csql_01 $csql_02 FROM `_acteurs` $join_01 $join_02";
            $sql_req.=" left join _choix on _acteurs.typeacteur=_choix.choix_cleunik ";
            $sql_req.=" WHERE act_cleunik IN($vl_act_cleunik) AND $sql_req_exclure_entreprise $grou_01";
            $grou_01="";
        } else {
        	$sql_req = "$selection $join_01 $join_02 WHERE _acteurs.act_cleunik IN($vl_act_cleunik)";
        }
        $sql_req_finale="$selection $join_01 $join_02";
        break;
      case '1': //  recherche orthographique
        switch ($vl_c_qui) {
          case '999999': //tous
            $sql_req = "$selection $join_01 $join_02 WHERE 1=1 ";
            $sql_req_finale="$selection $join_01 $join_02";
            break;
          case '888888':  //  Favoris
            $sql_req = "$selection $join_01 $join_02";
            $sql_req_finale="$selection $join_01 $join_02";
            $sql_req.= " WHERE _acteurs.act_cleunik IN (SELECT _acteurs_favoris.act_cleunik from _acteurs_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1) ";
            break;
          case '777777':  //  Représentants
            $sql_req = "$selection $join_01 $join_02";
            $sql_req_finale="$selection $join_01 $join_02";
            $sql_req.= " where (SELECT count(*) as nombre from _act_choix_fixes where _act_choix_fixes.choix_cleunik=-26 and _act_choix_fixes.act_cleunik=_acteurs.act_cleunik) >0 ";
            break;
          case '666666':  //  Transporteurs
            $sql_req = "$selection $join_01 $join_02";
            $sql_req_finale="$selection $join_01 $join_02";
            $sql_req.= " where (SELECT count(*) as nombre from _act_choix_fixes where _act_choix_fixes.choix_cleunik=-25 and _act_choix_fixes.act_cleunik=_acteurs.act_cleunik) >0 ";
            break;
		  case "categorie_comptable":
          	$categorie_comptable=" left join _act_compta on _act_compta.act_cleunik=_acteurs.act_cleunik ";
			$sql_req = "$selection $join_01 $join_02 $categorie_comptable WHERE 1=1 and _act_compta.catcompta_cleunik=$catcompta_cleunik ";
            $sql_req_finale="$selection $join_01 $join_02 $categorie_comptable";
          	break;
          case '110001':
          case '110002':
          case '110003':
          case '110004':
          case '110005':
          case '110006':
            $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,";
            $sql_req.= " "._graalsql_datetime("_acteurs.dateheurecreation")." as dateheurecreation_clair,_acteurs.dateheurecreation as dateheurecreation,";
            $sql_req.=" _acteurs.typeacteur as typeacteur,_acteurs.codealphanum15 as code,_acteurs.mnemotechnique as mnemotechnique,_acteurs.actif as actif $csql_01 $csql_02 FROM `_acteurs` $join_01 $join_02";
            $sql_req_finale="$sql_req";
            $sql_req.=" WHERE _acteurs.typeacteur IN ($vl_c_qui)";
            break;

        }
        switch ($vl_c_zone) {
          case '1': //  raison sociale
            $sql_req.="  and _acteurs.raisonsoc like '$vl_c_recherche%'";
            break;
          case '2': //  nom commercial
            $sql_req.=" and _acteurs.nomcommercial like '$vl_c_recherche%'";
            break;
          case '3': //  Code
            $sql_req.="  and _acteurs.codealphanum15 like '$vl_c_recherche%'";
            break;
          case '4': //  Mnémotechnique
            $sql_req.=" and _acteurs.mnemotechnique like '$vl_c_recherche%'";
            break;
		case '8': //	Raison sociale ou nom commercial
			$sql_req.="  and (_acteurs.raisonsoc like '$vl_c_recherche%' or _acteurs.nomcommercial like '$vl_c_recherche%')";
			break;
		case '9': //	Un interlocuteur
			$sql_req.=" and ( concat_ws(' ',_act_interlo.patronyme, _act_interlo.prenom) like '$vl_c_recherche%' or concat_ws(' ',_act_interlo.prenom, _act_interlo.patronyme) like '$vl_c_recherche%' )";
			break;
		case '10': //	Un téléphone
			$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
			$b[0]='';
			$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_recherche);
			if (trim($vl_c_chaine_nette)!="%"){
				$sql_req.=" and _act_interlo_tel.intel_05 like '%$vl_c_chaine_nette%'";
			} else {
        		$sql_req.=" and (_act_interlo_tel.intel_05 like '%$vl_c_chaine_nette%' or _act_interlo_tel.intel_05 is NULL) ";
        	}
			break;
		case '11': //	Un fax
			$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
			$b[0]='';
			$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_recherche);
			if (trim($vl_c_chaine_nette)!="%"){
				$sql_req.=" and _act_interlo_fax.intel_05 like '%$vl_c_chaine_nette%'";
			} else {
        		$sql_req.=" and (_act_interlo_fax.intel_05 like '%$vl_c_chaine_nette%' or _act_interlo_fax.intel_05 is NULL) ";
        	}
			break;
		case '12': //	Une adresse de courriel
			if (trim($vl_c_recherche)!="%"){
				$sql_req.=" and _act_interlo_mail.refweb like '$vl_c_recherche%'";
			} else {
        		$sql_req.=" and (_act_interlo_mail.refweb like '$vl_c_recherche%' or _act_interlo_mail.refweb is NULL) ";
        	}
			break;
		case '13': //  Code postal
			if (trim($vl_c_recherche)!="%"){
            	$sql_req.=" and _act_adresses.adr_cp like '$vl_c_recherche%'";
			} else {
        		$sql_req.=" and (_act_adresses.adr_cp like '$vl_c_recherche%' or _act_adresses.adr_cp is NULL) ";
        	}
            break;
        case '14': //  Ville
        	if (trim($vl_c_recherche)!="%"){
            	$sql_req.=" and _act_adresses.adr_ville like '$vl_c_recherche%'";
        	} else {
        		$sql_req.=" and (_act_adresses.adr_ville like '$vl_c_recherche%' or _act_adresses.adr_ville is NULL) ";
        	}
            break;
        }
        switch ($vl_e_tarif_cleunik) {
          case 0:
            break;
          default:
            $sql_req.=" and act_cleunik in (select distinct(act_cleunik) from _act_compta where _act_compta.tarif_cleunik=$vl_e_tarif_cleunik)";
            break;

        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            switch ($vl_c_actifs) {
              case '1': $sql_req.=" and _acteurs.actif=1";break; //  actifs
              case '2': $sql_req.=" and _acteurs.actif=2";break;//  inactifs
              case '0': break;//  tous
            }
            break;
          default:
            $sql_req.=$cond_01;
            $sql_req.= " AND _acteurs.actif in($vl_c_actifs,$vl_c_inactifs)";
        }
        $sql.= "and $vl_e_acteur_choix=$vl_e_acteur_choix ";
	    switch ($vl_e_acteur_choix){
			case 0:break;
			case 3:break;
			case 1://	avec critère
				$sql_req.=$cond_01;
		        //$sql_req.= " AND _acteurs.actif in($vl_c_actifs,$vl_c_inactifs)";
		        break;
		}
		$sql_req.= $sql_req_exclure_entreprise;
        break;
      case '2' :  //  recherche phonétique
        switch (TRUE) {
          case $vl_c_qui=='9': // Tous
            $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur FROM `_acteurs`,`_choix`";
            $sql_req.=" WHERE _choix.choix_cleunik=_acteurs.typeacteur and _acteurs.act_cleunik in ";
            switch ($vl_c_zone)
              {
              case '1': //  raison sociale
                $sql_req.=" (select _acteurs_soundex_fr.act_cleunik from _acteurs_soundex_fr where raisonsoc='".soundex2($vl_c_recherche)."')";
                break;
              case '2': //  nom commercial
                $sql_req.=" (select _acteurs_soundex_fr.act_cleunik from _acteurs_soundex_fr where nomcommercial='".soundex2($vl_c_recherche)."')";
                break;
              }
            break;
          case $vl_c_qui=='2':  //  Favoris
            $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur FROM `_acteurs`,`_choix`";
            $sql_req.=" WHERE _choix.choix_cleunik=_acteurs.typeacteur AND _acteurs.act_cleunik IN (SELECT _acteurs_favoris.act_cleunik from _acteurs_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1) and _acteurs.act_cleunik in ";
            switch ($vl_c_zone)
              {
              case '1': //  raison sociale
                $sql_req.=" (select _acteurs_soundex_fr.act_cleunik from _acteurs_soundex_fr where raisonsoc='".soundex2($vl_c_recherche)."')";
                break;
              case '2': //  nom commercial
                $sql_req.=" (select _acteurs_soundex_fr.act_cleunik from _acteurs_soundex_fr where nomcommercial='".soundex2($vl_c_recherche)."')";
                break;
              }
            break;
          case $vl_c_qui=='3' || $vl_c_qui=='4' || $vl_c_qui=='5' || $vl_c_qui=='6' || $vl_c_qui=='7' || $vl_c_qui=='8' :
            $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,'' as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur FROM `_acteurs` WHERE _acteurs.typeacteur IN ($vl_c_qui)";
            switch ($vl_c_zone)
              {
              case '1': //  raison sociale
                $sql_req.=" WHERE _acteurs.typeacteur IN ($vl_c_qui) and _acteurs.raisonsoc like '$vl_c_recherche%'";
                break;
              case '2': //  nom commercial
                $sql_req.=" WHERE _acteurs.typeacteur IN ($vl_c_qui) and _acteurs.nomcommercial like '$vl_c_recherche%'";
                break;
              }
            break;
        }

        break;
    }
   break;
}
switch ($vl_e_acteur_choix){
	case 1:	//	avec le choix
		break;
	case 2:
		switch ($vl_c_qui) {
          case '999999': //tous
          case '888888':  //  Favoris
          case '777777':  //  Représentants
          case '666666':  //  Transporteurs
			break;
          case '110001':
          case '110002':
          case '110003':
          case '110004':
          case '110005':
          case '110006':
          	$quiqui=" and a3.typeacteur IN ($vl_c_qui)";
            break;
		}
		if ($vl_e_acteur_choix_cleunik!=0){
			//	sans le choix
		    //$sql_req.=" AND _acteurs.act_cleunik IN (select a3.act_cleunik from _acteurs a3 left outer join _act_choix_fixes a2 using (act_cleunik) where a2.act_cleunik is NULL or a2.choix_cleunik not in($vl_e_acteur_choix_cleunik) $quiqui group by a3.act_cleunik)";
			$sql_req.=" AND _acteurs.act_cleunik IN (select a3.act_cleunik as act_cleunik from _acteurs a3 where (select count(*) from _act_choix_fixes where _act_choix_fixes.act_cleunik=a3.act_cleunik and _act_choix_fixes.choix_cleunik in($vl_e_acteur_choix_cleunik))=0 $quiqui)";
			} else {
				//	sans le critère
			//$sql_req.=" AND _acteurs.act_cleunik IN (select a3.act_cleunik from _acteurs a3 left outer join _act_choix_fixes a2 using (act_cleunik) where a2.act_cleunik is NULL or a2.critere_cleunik not in($vl_e_action_critere_cleunik) $quiqui group by a3.act_cleunik)";
			$sql_req.=" AND _acteurs.act_cleunik IN (select a3.act_cleunik as act_cleunik from _acteurs a3 where (select count(*) from _act_choix_fixes where _act_choix_fixes.act_cleunik=a3.act_cleunik and _act_choix_fixes.critere_cleunik in($vl_e_acteur_critere_cleunik))=0 $quiqui)";
		}
		break;
	case 3:
	default:
		break;
	case 4:	//	avec le critère
		break;
}
/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */
$sql_req.= $cond_00;
$sql_req.= $req_liste_blanc . $req_liste_noire;
$sql_req.= $vl_c_inclusion_panier;
$sql_req.= " $grou_01 ";
switch ($vl_c_zone) {
	case '1': $sql_req.=" ORDER BY `raisonsoc` ASC";break;//  raison sociale
	case '2':
	case '8':
		$sql_req.=" ORDER BY `nomcommercial` ASC";break;//  nom commercial
	case '3': $sql_req.=" ORDER BY `code` ASC";break;//  Code
	case '4': $sql_req.=" ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
/*
echo($sql_req).EOL;
die ($sql_req_finale);
*/
session_write_close();

switch ($vl_c_sortie) {
  case "das":break;
  case "excel_adresses_postales":$nom_worksheet="XsOFt-Graal adresses postales";break;
  case "excel_adresses_postales_interlo":$nom_worksheet="XsOFt-Graal adresses postales";break;
  case "excel_adresses_courriels_interlo":$nom_worksheet="XsOFt-Graal adresses courriel";break;
  case "excel_téléphones_interlo":$nom_worksheet="XsOFt-Graal Téléphones";break;
  case "excel_totale_01":$nom_worksheet="XsOFt-Graal Tel mail adresses";break;	//	ne doit pas dépasser 31 caractères
  case "sql":break;
}



switch ($vl_c_sortie) {
  case "das":
  	switch ($vl_c_qui) {
	  case '888888': //  Favoris, ou liste, pas de limit
	    break;
	  default:
	    switch ($vl_e_critere_cleunik) {
	      case 0: //  pas de gestion du critère
	        switch ($vl_c_limit) {
	          case 0:
	            break;
	          default:
	            $sql_req.= " LIMIT 0, $vl_c_limit";
	            break;
	        }
	        //$sql_req.= " LIMIT 0, 100";
	        break;
	      default:
	        //  no limit
	    }
	    break;
	}
    include("_graal_das_acteurs_01.php");
    break;
  case "excel_adresses_postales":
  case "excel_adresses_postales_interlo":
  case "excel_adresses_courriels_interlo":
  case "excel_téléphones_interlo":
  case "excel_totale_01":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	require_once "sources_excel/class.writeexcel_workbook.inc.php";
	require_once "sources_excel/class.writeexcel_worksheet.inc.php";
	$vl_c_nom_fichier_xls=utf8_decode("adresses.xls");

	$fname = tempnam("mail", "$vl_c_nom_fichier_xls");
	$workbook = new writeexcel_workbook($fname);
	$worksheet =& $workbook->addworksheet(utf8_decode($nom_worksheet));

		if (trim($requete_particuliere)!=""){
			$sql_req=$requete_particuliere;

		}
//die($sql_req);
	$result = _graal_requete_bd($sql_req);
	$nfields = mysql_num_fields($result);
	$vl_e_noligne=0;
	for ($i=0; $i<$nfields; $i++)
	{
	    $fieldname = mysql_field_name($result, $i);
	    $worksheet->write($vl_e_noligne, $i, utf8_decode("$fieldname"));
	}
	//  Lecture des résultats de la requête

	while ($line = mysql_fetch_array($result, MYSQL_ASSOC)) {
	  $j = 0;
	  $vl_e_noligne++;
	  $total_acteur=0;
	  foreach ($line as $field) {
	  	$worksheet->write($vl_e_noligne, $j, utf8_decode("$field"));
	  	$j++;
	  }
	}
	_graal_libere_requete_bd($result);
	$workbook->close();
	header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
	header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
	$fh=fopen($fname, "rb");
	fpassthru($fh);
	break;
case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
