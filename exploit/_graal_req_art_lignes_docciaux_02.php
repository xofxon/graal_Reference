<?php
include("_graal_header_xml.inc.php");
$vl_e_art_cleunik=intval(fa_recup_param('vl_art_cleunik','-2'));
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_statut=intval(fa_recup_param('statut','-1'));
$vl_e_limit=intval(fa_recup_param('limit','1'));
$vl_e_act_cleunik=intval(fa_recup_param('vl_act_cleunik','-2'));
$vl_e_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','-2'));
$vl_operat_statut=intval(fa_recup_param('vl_operat_statut','1'));
$vl_type_recherche=intval(fa_recup_param('vl_type_recherche','0'));
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_particulier=fa_recup_param('vl_c_particulier','-1');
$sql_req="";
if ($vl_e_art_cleunik==-2) {
  $condart=" f1.art_cleunik=f1.art_cleunik and f1.art_cleunik<>0 and ";
} else {
  $condart=" f1.art_cleunik=$vl_e_art_cleunik and f1.art_cleunik<>0 and ";
}
if ($vl_e_act_cleunik==-2) {
  $condact="";
} else {
  $condact=" f2.act_cleunik=$vl_e_act_cleunik and ";
}
if ($vl_e_commercial_cleunik==-2) {
  $condcial="";
} else {
  $condcial=" f1.commercial_cleunik<>$vl_e_commercial_cleunik and ";
}
$sql_req="SELECT f1.art_cleunik as z04,f6.code as z22,f6.description as z23,sum(f7.qte) as z08 from $fic_lignes f1,$fic_entete f2,_article f6,$fic_qte f7 WHERE $condart $condact $condcial f2.commercial_cleunik=f1.commercial_cleunik and f6.art_cleunik=f1.art_cleunik and f1.commercial_ligne_cleunik=f7.commercial_ligne_cleunik";
switch ($vl_c_particulier){
	case "-1":	//	pas de cas particulier
		$sql_req.= " AND (f7.dateheure_confirm between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
		if ($vl_e_statut!=-1) {
			switch ($vl_operat_statut){
				case 1:$sql_req.= " AND f7.statut=$vl_e_statut";break;
				case 2:$sql_req.= " AND f7.statut<>$vl_e_statut";break;
			}
		}
		switch ($vl_type_recherche){
			case 0:break;
			case 1:$sql_req.=" and f6.code like '$vl_c_recherche'";break;	//code article
			case 2:$sql_req.=" and f6.description like '$vl_c_recherche'";break;	//désignation article
			case 3:$sql_req.=" and f6.mnemotechnique like '$vl_c_recherche'";break;	//id mnémotechnique article
		}
		$sql_req.= " group by f1.art_cleunik order by f6.description ASC ";
		if ($vl_e_limit!=-1){
			$sql_req.= " LIMIT 0,$vl_e_limit;";
		}
		break;
	case "1":	//	Heure de confirmation à zéro
		$sql_req.= " AND (f7.dateheure_confirm='00000000000000')";
		break;		
	case "2":	//	Heure de demande à zéro
		$sql_req.= " AND (f7.dateheure_demande='00000000000000')";
		break;		

}
$result = _graal_requete_bd($sql_req);
//echo $sql_req;
echo('<donnees>');
//echo("<requete sql='".fa_ent_xml($sql_req)."'/>");
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  $nb_dec_qte=fa_ent_xml($row['z09']);
  $nb_dec_pu=fa_ent_xml($row['z13']);
  echo(' z01="'.fa_ent_xml($row['z01']).'"');
  echo(' z02="'.fa_ent_xml($row['z02']).'"');
  echo(' z03="'.fa_ent_xml($row['z03']).'"');
  echo(' z04="'.fa_ent_xml($row['z04']).'"');
  echo(' z05="'.fa_ent_xml($row['z05']).'"');
  echo(' z06="'.fa_ent_xml($row['z06']).'"');
  echo(' z07="'.fa_ent_xml($row['z07']).'"');
  if ($row['z08']==0) {$z08="";} else {$z08=fa_reel(fa_ent_xml($row['z08']),$nb_dec_qte);}
  echo(' z08="'.$z08.'"');
  if ($row['z11']==0) {$z11="";} else {$z11=fa_reel(fa_ent_xml($row['z11']),$nb_dec_pu);}
  echo(' z11="'.$z11.'"');
  if ($row['z14']==0) {$z14="";} else {$z14=fa_reel(fa_ent_xml($row['z14']),$nb_dec_pu);}
  echo(' z14="'.$z14.'"');
  echo(' z16="'.fa_ent_xml($row['z16']).'"');
  $htligne=$row['z08']*$row['z11'];
  $htbrutremise=fa_reel(fa_ent_xml($row['htbrutremise']),$nb_dec_pu);
  if ($htbrutremise==$htligne) {$htbrutremise="";}
  if ($htligne==0) {$htligne="";} else {$htligne=fa_reel(fa_ent_xml($htligne),$nb_dec_pu);}
  echo(' htligne="'.$htligne.'"');
  echo(' z17="'.fa_ent_xml($row['z17']).'"');
  $dd=$row['z18'];if ($dd=='00.00.0000') {$dd='';}
  $hd=$row['z19'];if ($hd=='00:00:00') {$hd='';}
  echo(' dateheure="'.$dd.' '.$hd.'"');
  echo(' z20="'.fa_ent_xml($row['z20']).'"');
  echo(' z21="'.fa_ent_xml($row['z21']).'"');
  echo(' z22="'.fa_ent_xml($row['z22']).'"');
  echo(' z23="'.fa_ent_xml($row['z23']).'"');
  echo(' z24="'.fa_ent_xml($row['z24']).'"');
  $coef_facture=$row['coef_facture'];
  if($coef_facture==0) {$coef_facture_clair="Non facturable";$prop_coef_facture="ag15";} else {$coef_facture_clair="";$prop_coef_facture="";}
  echo(' coef_facture_clair="'.$coef_facture_clair.'"');
  echo(' prop_coef_facture="'.$prop_coef_facture.'"');
  echo(' htbrutremise="'.$htbrutremise.'"');
  if ($row['statut']==-39) {
    echo(' prop_statut="ac04"');
  } else {
    echo(' prop_statut=""');
  }
	echo(' ligne_qte_cleunik="'.fa_ent_xml($row['ligne_qte_cleunik']).'"');
   echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
