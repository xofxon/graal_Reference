<?php
$res = _graal_requete_bd($sql_req_uti_01);
if (mysql_num_rows($res)!=0){
	//die(mysql_num_rows($res)."--".$sql_req);
  $ligne = mysql_fetch_row($res); 
  $_SESSION["protocol"]=$_POST['hti_pt'];
  $_SESSION["vs_uti_cleunik"]=$ligne[0];
  $_SESSION["vs_qui"]=$ligne[1];
  $_SESSION["borne_mini"]=$ligne[3];
  $_SESSION["borne_maxi"]=$ligne[4];
  $_SESSION["langue_appli"]=$ligne[5];
  $_SESSION["vs_nomcomplet"]=$ligne[1].' '.$ligne[2];
  $_SESSION["vs_int_cleunik"]=$ligne[8];
  $_SESSION["vs_param_environ"]=$ligne[9];
  $_SESSION["vs_act_cleunik"]=$ligne[10];
  /*
  $string=$ligne[9];
  //die("-".$string."-");
  		$vl_c_xml_uti=simplexml_load_string(fa_recup_session("vs_param_environ",""));
		//$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
		if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$_SESSION["vs_gesacteurs_ml_zone"]=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$_SESSION["vs_gesacteurs_ml_zone"]='1';}
	
	//die($_SESSION["vs_gesacteurs_ml_zone"]);
	//$_SESSION["vs_gesacteurs_ml_zone"]="4";
  
  //die("-".$_SESSION["vs_gesacteurs_ml_zone"]."*".$vl_c_xml_uti."*");
  //die("-".$_SESSION["vs_gesacteurs_ml_zone"]."*".$string."*");
   * 
   */
  $sql_req= "SELECT blocnotertf,nomcommercial FROM _acteurs where act_cleunik=0;";
	$result=_graal_requete_bd($sql_req);
	$row= mysql_fetch_assoc($result);
  $vl_c_xml=simplexml_load_string($row['blocnotertf']);
	$_SESSION["vs_nomcommercial_entreprise"]=$row['nomcommercial'];
	_graal_libere_requete_bd($result);
	include('_graal_liste_param_generaux.php');
	include('_graal_affec_param_generaux.php');
	include('_graal_affec_param_css_actions.php');
} else {
  //  Désormais (depuis le 14 septembre 2006), on ne se connecte plus, si on ne trouve pas dans la bd le bon mot de passe
	$res = _graal_requete_bd($sql_req_uti_02);
  if (mysql_num_rows($res)!=0){
    fa_redirige($vl_c_mauvaismotdepasse);
    die();
  } else {
    fa_redirige($vl_c_mauvaiseidentification); 
    die();
  }
}
$sql_cle=_graal_requete_max_particuliere("uticonnexions_cleunik","_uti_connexions");
$vl_c_infosconnexion="";
$vl_c_infosconnexion.=fa_xcree_entete_xml();
$vl_c_infosconnexion.='<parametres>';
$vl_c_infosconnexion.='<ip_brute data="'.fa_ent_xml($_SERVER["REMOTE_ADDR"]).'"/>';
$vl_c_infosconnexion.='<gethostbyadress data="'.fa_ent_xml(gethostbyaddr($_SERVER["REMOTE_ADDR"])).'"/>';
$vl_c_infosconnexion.='<navigateur data="'.fa_ent_xml($_SERVER["HTTP_USER_AGENT"]).'"/>';
$vl_c_infosconnexion.='<typedeserveur data="'.fa_ent_xml($_SERVER["SERVER_SIGNATURE"]).'"/>';
//$vl_c_infosconnexion.='<origine data="'.fa_ent_xml($_SERVER["HTTP_REFERER"]).'"/>';
$vl_c_infosconnexion.='</parametres>';
$sql_req = "INSERT INTO _uti_connexions set uti_cleunik=". $_SESSION['vs_uti_cleunik'].",uticonnexions_cleunik=$sql_cle,dateheuredebutconnexion = now(),infos_ip = '".gethostbyaddr($_SERVER["REMOTE_ADDR"])."',infos_connexion='".$vl_c_infosconnexion."',infos_fenetres='".$vv_id_fenetre."'";
$res=_graal_exec_requete($sql_req);
if($res === false) {
	fa_redirige("./pagesparticulieres/mauvaiseconnexion.php");
}
$vl_e_dico=3;
$vl_e_langue=$_SESSION["langue_appli"];
$vl_e_uti_cleunik=0;  //  pour l'instant on ne gère pas les dictionnaires personnels
$sql_req = "SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif FROM _objets,_objets_libelle WHERE _objets.fen_cleunik=_objets_libelle.fen_cleunik and _objets_libelle.langue=$vl_e_langue and _objets.type_objet=$vl_e_dico and _objets_libelle.uti_cleunik=$vl_e_uti_cleunik ORDER BY titre";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $_SESSION[$row['titre']]=$row['descriptif'];
}
_graal_libere_requete_bd($result);
?>