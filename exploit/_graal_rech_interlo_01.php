<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
define('EOL', "\r\n");
$vl_c_qui=fa_recup_param('vl_c_qui','110003');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','A');
$vl_c_actifs=fa_recup_param('vl_c_actifs','2');
$vl_t_listecles=fa_recup_param('vl_t_listecles','');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_action_cleunik=intval(fa_recup_param('vl_action_cleunik','0'));
$vl_act_cleunik=intval(fa_recup_param('vl_act_cleunik','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','150'));
$vl_c_presentation_accordeon=fa_recup_param('vl_c_presentation_accordeon','0');
$vl_choix_cleunik=intval(fa_recup_param('vl_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));

$vl_e_int_choix=intval(fa_recup_param('vl_e_int_choix',0));
$vl_e_int_choix_cleunik=fa_recup_param('vl_e_int_choix_cleunik','0');
$vl_e_int_critere_cleunik=fa_recup_param('vl_e_int_critere_cleunik','0');


if ($vl_c_type_recherche_cleunik!=""){
	// comme ça ne marche pas dans tous les cas, on utilise l'autre méthode qui fonctionne bien
	$vl_e_int_choix_cleunik=$vl_e_choix_cleunik;
	$vl_e_int_critere_cleunik=$vl_e_critere_cleunik;
	$vl_e_choix_cleunik=0;
	$vl_e_critere_cleunik=0;
	switch ($vl_c_type_recherche_cleunik){
		case "in":
			$vl_e_int_choix=1;
			break;
		case "notin":
			$vl_e_int_choix=2;
			break;
	}
	$vl_c_type_recherche_cleunik="";
}


switch ($vl_e_int_choix){
	case 0:break;
	case 3:break;
	case 1://	avec critère
		$join_01=" left join _act_interlo_choix_fixes a3 on _act_interlo.int_cleunik=a3.int_cleunik ";
		if ($vl_e_int_choix_cleunik!=0){
			$cond_01=" and a3.choix_cleunik in($vl_e_int_choix_cleunik) ";
		} else {
			$cond_01=" and a3.critere_cleunik in($vl_e_int_critere_cleunik) ";
		}

}
$sql_req = "SELECT _acteurs.act_cleunik as act_cleunik, _act_interlo.int_cleunik as int_cleunik,";
$sql_req.= " case _acteurs.nomcommercial when '' then _acteurs.raisonsoc else _acteurs.nomcommercial END as `raisonsoc`,";
$sql_req.= "  _acteurs.nomcommercial as nc, _choix.choix_valeur_texte_01 as civilite, concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui,";
$sql_req.= "   _choixact.choix_valeur_texte_01 as portee,_act_interlo.actif,_acteurs.codealphanum15,_acteurs.mnemotechnique,_acteurs.typeacteur,";
$sql_req.= "   _acteurs.blocnotebrut as acteur_bn,_act_interlo.blocnotebrut as interlo_bn ";
$sql_req.= "   from _acteurs,_choix,_choix _choixact,_act_interlo $join_01 $join_02";
switch ($vl_e_critere_cleunik) {
	case 0: //  pas de gestion du critère
		$grou_01=" group by _act_interlo.int_cleunik";
    	break;
    	$join_01="";
    	$join_02="";
    	$cond_01="";
    	$grou_01="";
    	$csql_01="";
    	$csql_02="";
    default:

    	switch ($vl_e_choix_cleunik) {
        	case 0: //  on recherche sur le critère

    	switch ($vl_c_type_recherche_cleunik) {
                  	case "in"	:
                  		$join_01=" left join _act_interlo_choix_fixes on _act_interlo.int_cleunik=_act_interlo_choix_fixes.int_cleunik  ";
                  		$cond_01=" and _act_interlo_choix_fixes.critere_cleunik in($vl_e_critere_cleunik) ";
                  		$grou_01=" group by _act_interlo.int_cleunik";
                  		$vl_c_zone="0";
                  		$csql_02=" ,g1.choix_code,g1.choix_valeur_texte_01,g2.critere_code,g2.critere_denomination ";
                  		$join_02=" left join _choix g1 on _act_interlo_choix_fixes.choix_cleunik=g1.choix_cleunik left join _criteres g2 on _act_interlo_choix_fixes.critere_cleunik=g2.critere_cleunik ";
                  		break;
                  	case "notin":
                  		$join_01="";
                  		$cond_01="";
                  		$grou_01=" group by _actinterlo.int_cleunik having nb=0";
                  		$csql_01=",(select count(*) from _act_interlo_choix_fixes f2 where f2.int_cleunik=_act_interlo.int_cleunik and critere_cleunik in($vl_e_critere_cleunik)) as nb ";
                  		$vl_c_zone="0";
                  		break;
                 }
            	break;
            default://  on recherche sur le choix du critère
                switch ($vl_c_type_recherche_cleunik) {
                  	case "in"	:
                  		$join_01=" left join _act_interlo_choix_fixes on _act_interlo.int_cleunik=_act_interlo_choix_fixes.int_cleunik  ";
                  		$cond_01=" and _act_interlo_choix_fixes.choix_cleunik in($vl_e_choix_cleunik) ";
                  		$grou_01=" group by _act_interlo.int_cleunik";
                  		$vl_c_zone="0";
                  		$csql_02=" ,g1.choix_code,g1.choix_valeur_texte_01,g2.critere_code,g2.critere_denomination ";
                  		$join_02=" left join _choix g1 on _act_interlo_choix_fixes.choix_cleunik=g1.choix_cleunik left join _criteres g2 on _act_interlo_choix_fixes.critere_cleunik=g2.critere_cleunik ";
                  		break;
                  	case "notin":
                  		$join_01=" left join _act_interlo_choix_fixes on _act_interlo.int_cleunik=_act_interlo_choix_fixes.int_cleunik  ";
                  		$cond_01=" AND a2.act_cleunik is NULL or a2.choix_cleunik not in($vl_e_choix_cleunik) ";
                  		$grou_01=" group by _act_interlo.int_cleunik";
                  		$vl_c_zone="0";
                  		break;
                 }
                 break;
            }
            $sql_req.= " AND _act_interlo.actif in($vl_c_actifs,$vl_c_inactifs)";
}




/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */
$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
switch ($vs_gesacteurs_ml_zone){
	case '1':	//	Accès libre
		$req_liste_noire="";
		$req_liste_blanc="";
		break;
	case '3':	//	Accès sur liste noire
		$req_liste_noire=" and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=_acteurs.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		$req_liste_blanc="";
		break;
	case '4':	//	Accès sur liste blanche
		$req_liste_blanc=" and (select count(*) from _acteurs_blanc where _acteurs_blanc.act_cleunik=_acteurs.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) <> 0 ";
		//$req_liste_blanc=" or  _acteurs.act_cleunik = 0 ";	//	on seléctionne les interlocuteurs de l'entreprise
		$req_liste_noire="";
		break;
}
switch ($vl_c_actifs) {
	case '11'://	interlocuteurs ayant ouvert un emailing avec un choix de critère donné
		$sql_req_trackin="select f2.int_cleunik as int_cleunik from _emailing_ouvre f1 left join _act_interlo_mail f2 on f2.intweb_cleunik=f1.intweb left join _act_choix_fixes";
		$sql_req_trackin.=" f3 on f3.act_cleunik=f2.act_cleunik left join _choix f4 on f4.choix_cleunik=f3.choix_cleunik left join _criteres f5 on f5.critere_cleunik=f3.critere_cleunik";
		$sql_req_trackin.=" where action_cleunik=$vl_action_cleunik and nbclic<>0 and f3.choix_cleunik=$vl_choix_cleunik;";
		//die ($sql_req_trackin);
		$result = _graal_requete_bd($sql_req_trackin);
      $vl_int_cleunik="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_int_cleunik.=$row['int_cleunik'].',';
      }
      _graal_libere_requete_bd($result);
		if ($vl_int_cleunik!="") {
          $vl_int_cleunik=substr($vl_int_cleunik, 0, -1);
        }
        $sql_req.=" where _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in ($vl_int_cleunik)";
		break;

	case '10'://	interlocuteurs ayant ouvert un emailing
		$sql_req_trackin="select f2.int_cleunik from _emailing_ouvre f1 left join _act_interlo_mail f2 on f2.intweb_cleunik=f1.intweb where action_cleunik=$vl_action_cleunik and nbclic<>0";
		$result = _graal_requete_bd($sql_req_trackin);
      $vl_int_cleunik="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_int_cleunik.=$row['int_cleunik'].',';
      }
      _graal_libere_requete_bd($result);
		if ($vl_int_cleunik!="") {
          $vl_int_cleunik=substr($vl_int_cleunik, 0, -1);
        }
        $sql_req.=" where _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in ($vl_int_cleunik)";
		break;

	case '9'://	interlocuteurs ayant cliqué sur lien emailing (tracking) avec un choix de critère donné
		$sql_req_trackin="select f2.int_cleunik as int_cleunik from _emailing_trackin f1 left join _act_interlo_mail f2 on f2.intweb_cleunik=f1.intweb left join _act_choix_fixes";
		$sql_req_trackin.=" f3 on f3.act_cleunik=f2.act_cleunik left join _choix f4 on f4.choix_cleunik=f3.choix_cleunik left join _criteres f5 on f5.critere_cleunik=f3.critere_cleunik";
		$sql_req_trackin.=" where action_cleunik=$vl_action_cleunik and nbclic<>0 and f3.choix_cleunik=$vl_choix_cleunik;";
		//die ($sql_req_trackin);
		$result = _graal_requete_bd($sql_req_trackin);
      $vl_int_cleunik="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_int_cleunik.=$row['int_cleunik'].',';
      }
      _graal_libere_requete_bd($result);
		if ($vl_int_cleunik!="") {
          $vl_int_cleunik=substr($vl_int_cleunik, 0, -1);
        }
        $sql_req.=" where _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in ($vl_int_cleunik)";
		break;
	case '8'://	interlocuteurs ayant cliqué sur lien emailing (tracking)
		$sql_req_trackin="select f2.int_cleunik from _emailing_trackin f1 left join _act_interlo_mail f2 on f2.intweb_cleunik=f1.intweb where action_cleunik=$vl_action_cleunik and nbclic<>0";
		$result = _graal_requete_bd($sql_req_trackin);
      $vl_int_cleunik="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_int_cleunik.=$row['int_cleunik'].',';
      }
      _graal_libere_requete_bd($result);
		if ($vl_int_cleunik!="") {
          $vl_int_cleunik=substr($vl_int_cleunik, 0, -1);
        }
        $sql_req.=" where _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in ($vl_int_cleunik)";
		break;
  case '7': //  interlocuteurs d'un acteur
    $sql_req.=" where _act_interlo.int_cleunik <> 0 and _act_interlo.act_cleunik = $vl_act_cleunik and _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik ";
    break;
  case '4': //  favoris
    $sql_req.=" where _act_interlo.int_cleunik <> 0 and _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in (SELECT _act_interlo_favoris.int_cleunik from _act_interlo_favoris where _act_interlo_favoris.uti_cleunik=$vl_e_uti_cleunik and _act_interlo_favoris.genre=1) ";
    break;
  case '3': // Panier ou requête
    $sql_req_panier = "SELECT panier_requete_selection as req,panier_resultat,panier_type FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
    $result = _graal_requete_bd($sql_req_panier);
    $row = mysql_fetch_assoc($result);
    if ($row['panier_type']==1) {
      $vl_int_cleunik=$row['panier_resultat'];
      _graal_libere_requete_bd($result);
    } else {
      $sql_req_panier = $row['req'];
      _graal_libere_requete_bd($result);
      $result = _graal_requete_bd($sql_req_panier);
      $vl_e_panier="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_e_panier.=$row[0].',';
      }
    }
    $sql_req.=" where _act_interlo.int_cleunik <> 0 and _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in ($vl_int_cleunik)";
    //die($sql_req);
    break;
  case '1':
  case '2':
  case '0':
  case '5':
  case '6':
    switch ($vl_c_type) {
      case '0': //  Liste de clés d'interlocuteurs
        $vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_int_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_int_cleunik!="") {
          $vl_int_cleunik=substr($vl_int_cleunik, 0, -1);
        }
        $sql_req.=" where _act_interlo.int_cleunik <> 0 and _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik in ($vl_int_cleunik)";
        break;
      case '2': //  Liste de clés d'acteurs
        $vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_act_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_act_cleunik!="") {
          $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
        }
        $sql_req.=" where _act_interlo.int_cleunik <> 0 and _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.act_cleunik in ($vl_act_cleunik)";
        break;

      case '1': //  recherche orthographique


    	IF ($vl_e_critere_cleunik!=0){
    		$sql_req = "SELECT _acteurs.act_cleunik as act_cleunik, _act_interlo.int_cleunik as int_cleunik,";
			$sql_req.= " case _acteurs.nomcommercial when '' then _acteurs.raisonsoc else _acteurs.nomcommercial END as `raisonsoc`,";
			$sql_req.= " _acteurs.nomcommercial as nc, _choix.choix_valeur_texte_01 as civilite, concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui,";
			$sql_req.= " _choixact.choix_valeur_texte_01 as portee,_act_interlo.actif,_acteurs.codealphanum15,_acteurs.mnemotechnique,_acteurs.typeacteur,";
			$sql_req.= " _acteurs.blocnotebrut as acteur_bn,_act_interlo.blocnotebrut as interlo_bn $csql_01 $csql_02";
			$sql_req.= " from _acteurs left join _act_interlo on _acteurs.act_cleunik=_act_interlo.act_cleunik left join _choix on _choix.choix_cleunik=_act_interlo.choix_cleunik ";
			$sql_req.= " left join _choix _choixact on _acteurs.typeacteur=_choixact.choix_cleunik  $join_01 $join_02 where 1=1 and _acteurs.typeacteur IN ($vl_c_qui) $cond_01";
            $vl_e_limit=" 1000000 ";
        } else {
	        $sql_req.=" where _act_interlo.int_cleunik <> 0 and _acteurs.act_cleunik = _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik ";
	        switch ($vl_c_qui) {
	          case '999999':  //  Interlocuteurs de tous les acteurs
	            break;
	          case '888888':  //  Mes interlocteurs favoris
	            break;
	          case '110000':
	          case '110001':
	          case '110002':
	          case '110003':
	          case '110004':
	          case '110005':
	          case '110006':
	            $sql_req.=" and _acteurs.typeacteur IN ($vl_c_qui)";
	            break;
	        }
	        switch ($vl_c_actifs) {
	          case '1': $sql_req.=" and _act_interlo.actif=1";break; //  actifs
	          case '2': $sql_req.=" and _act_interlo.actif=2";break;//  inactifs
	          case '0': break;//  tous
	        }
	        switch ($vl_c_zone) {
	          case "1":  //  Sur la raison sociale des acteurs
	            $sql_req.=" and _acteurs.raisonsoc like '$vl_c_recherche%'";
	            break;
	          case "2": //    Sur le nom commercial des acteurs
	            $sql_req.=" and _acteurs.nomcommercial like '$vl_c_recherche%'";
	            break;
	          case "3": //    Sur le patronyme des interlocuteurs des acteurs
	            $sql_req.=" and ( concat_ws(' ',_act_interlo.patronyme, _act_interlo.prenom) like '$vl_c_recherche%' or concat_ws(' ',_act_interlo.prenom, _act_interlo.patronyme) like '$vl_c_recherche%' )";
	            break;
	          case "4": //    Sur le code alpha-numérique des acteurs
	            $sql_req.=" and _acteurs.codealphanum15 like '$vl_c_recherche%'";
	            break;
	          case "5": //    Sur l'ID mnémotechnique des acteurs
	            $sql_req.=" and _acteurs.mnemotechnique like '$vl_c_recherche%'";
	            break;
	        }
        switch ($vl_e_int_choix){
			case 0:break;
			case 3:break;
			case 1://	avec critère
				$sql_req.=$cond_01;
		        //$sql_req.= " AND _acteurs.actif in($vl_c_actifs,$vl_c_inactifs)";
		        break;
		}
        }
  }
}

switch ($vl_e_int_choix){
	case 1:	//	avec le choix
		break;
	case 2:
		switch ($vl_c_qui) {
          case '999999': //tous
          case '888888':  //  Favoris
          case '777777':  //  Représentants
          case '666666':  //  Transporteurs
			break;
          case '110001':
          case '110002':
          case '110003':
          case '110004':
          case '110005':
          case '110006':
          	$quiqui=" and _acteurs.typeacteur IN ($vl_c_qui)";
            break;
		}
		if ($vl_e_int_choix_cleunik!=0){
			//	sans le choix
			$sql_req.=" AND _act_interlo.int_cleunik IN (select a3.int_cleunik as int_cleunik from _act_interlo a3 where (select count(*) from _act_interlo_choix_fixes where _act_interlo_choix_fixes.int_cleunik=a3.int_cleunik and _act_interlo_choix_fixes.choix_cleunik in($vl_e_int_choix_cleunik))=0 $quiqui)";
			} else {
				//	sans le critère
			$sql_req.=" AND _act_interlo.int_cleunik IN (select a3.int_cleunik as int_cleunik from _act_interlo a3 where (select count(*) from _act_interlo_choix_fixes where _act_interlo_choix_fixes.int_cleunik=a3.int_cleunik and _act_interlo_choix_fixes.critere_cleunik in($vl_e_int_critere_cleunik))=0 $quiqui)";
		}
		break;
	case 3:
	default:
		break;
	case 4:	//	avec le critère
		break;
}
if (trim($req_liste_blanc . $req_liste_noire!="")){
	/*
	 * le 3 mars 2010 : on sélectionne les interlocuteurs de la société
	 */
	if ($vl_e_critere_cleunik!=0){
		$sql_req.= $req_liste_blanc . $req_liste_noire;
	} else {
		$sql_req.= $req_liste_blanc . $req_liste_noire . "UNION ALL " . $sql_req . " and _acteurs.act_cleunik=0 ";
	}
}
switch ($vl_c_actifs) {
	case "4":
	case "7":
		$sql_req.=" order by qui";
		break;
	case '6':
		switch ($vl_c_type) {
			case '1':
				switch ($vl_c_zone) {
		          case "1":  //  Sur la raison sociale des acteurs
		            $sql_req.=" ORDER BY _acteurs.raisonsoc ASC";
		            break;
		          case "2": //    Sur le nom commercial des acteurs
		            $sql_req.=" ORDER BY _acteurs.nomcommercial ASC";
		            break;
		          case "3": //    Sur le patronyme des interlocuteurs des acteurs
		            $sql_req.=" ORDER BY qui ASC";
		            break;
		          case "4": //    Sur le code alpha-numérique des acteurs
		            $sql_req.=" ORDER BY _acteurs.codealphanum15 ASC";
		            break;
		          case "5": //    Sur l'ID mnémotechnique des acteurs
		            $sql_req.=" ORDER BY _acteurs.mnemotechnique ASC";
		            break;
		        }
			break;
		}
  		break;
}
switch ($vl_c_actifs) {
  case '1':
  case '2':
  case '0':
    $sql_req.=" LIMIT $vl_e_limit";
    break;
  case '3':
  case '4':
  case '5':
  case '6':
  case '7':
    //  no limit
    break;
}
$result = _graal_requete_bd($sql_req);
switch ($vl_c_sortie) {
  case "das":
  case "rdf":
    include("_graal_das_rech_interlo_01.php");
    break;
  case "xul":
    switch ($vl_c_type) {
      case "0":
      case "1":
        include("_graal_xul_rech_interlo_01.php");
        break;
      case "2":
        include("_graal_xul_rech_interlo_02.php");
        break;
    }
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
