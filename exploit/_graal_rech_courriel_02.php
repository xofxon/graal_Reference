<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
define('EOL', "\r\n");
$vl_e_typeacteur=intval(fa_recup_param('typeacteur','9'));
$vl_c_raisonsoc=fa_recup_param('raisonsoc','%');
$vl_c_quoi=intval(fa_recup_param('quoi','4'));
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_c_sortie=fa_recup_param('sortie','rdf');
$vl_e_limit=intval(fa_recup_param('vl_e_limit','4'));
$vl_c_veuxpasdemail=fa_recup_param('vl_c_veuxpasdemail','');
$vl_c_valide=fa_recup_param('vl_c_valide','');
$vl_e_masse=intval(fa_recup_param('masse','0'));
$vl_c_deja_dans_emailing=intval(fa_recup_param('vl_c_deja_dans_emailing',-1));
$vl_e_action_cleunik=intval(fa_recup_param('vl_e_action_cleunik',-1));
if ($vl_c_veuxpasdemail!="") {$vl_c_veuxpasdemail=substr($vl_c_veuxpasdemail, 0, -1);}
if ($vl_c_valide!="") {$vl_c_valide=substr($vl_c_valide, 0, -1);}
/*
 * au 14 janvier 2009, pas trouvé de requete qui fasse en une fois et rapidement la recherche de présence dans le fichier des adresses déjà utilisée pour un emaling
 * Les requêtes "classiques" fonctionnent mais s'il y a un gros volume, tout s'écroule !!
 * On fait donc une recherche des clef, que l'on met dans un tableau et ensuite, on teste
 */
if ($vl_c_deja_dans_emailing==2) {
	$qui_refweb_deja_dans_emailing=array();
	$req_presence_dans_emailing="SELECT refweb as refweb
	from _emailing_refweb inner join _act_interlo_mail on _act_interlo_mail.refweb=_emailing_refweb.refweb 
	where _emailing_refweb.action_cleunik =$vl_e_action_cleunik";
  $result = _graal_requete_bd($req_presence_dans_emailing);
  while ($row = mysql_fetch_assoc($result)) {
    array_push ($qui_refweb_deja_dans_emailing, fa_ent_xml($row['refweb']));
  }
  _graal_libere_requete_bd($result);
}
$sql_req = "SELECT _acteurs.act_cleunik as act_cleunik, _act_interlo.int_cleunik as int_cleunik, _act_interlo_mail.intweb_cleunik as intweb_cleunik,
 _acteurs.raisonsoc as raisonsoc, _acteurs.nomcommercial as nc, _acteurs.typeacteur as typeacteur,_acteurs.actif as act_actif,_act_interlo.actif as int_actif,
 _choix.choix_valeur_texte_01 as civilite, concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui, _act_interlo.prenom as prenom, _act_interlo.patronyme as nom,
  _act_interlo_mail.refweb as refweb, _choixweb.choix_valeur_texte_01 as genreweb, _choixact.choix_valeur_texte_01 as portee,_act_interlo_mail.valide as mail_valide,
	_act_interlo_mail.veuxpasdemail as mail_veuxpasdemail,IFNULL(_act_interlo_mail.dateheureverification,0) as dateheureverification,
	IFNULL(_act_interlo_mail.cr_verification,'.') as cr_verification,_act_interlo_mail.blocnotebrut as mail_blocnotebrut 
	from _acteurs 
	inner join _act_interlo on _acteurs.act_cleunik = _act_interlo.act_cleunik 
	inner join _choix on _choix.choix_cleunik = _act_interlo.choix_cleunik
	inner join _act_interlo_mail on _act_interlo_mail.int_cleunik=_act_interlo.int_cleunik
	inner join _choix _choixweb on _choixweb.choix_cleunik = _act_interlo_mail.choix_cleunik
	inner join _choix _choixact on _choixact.choix_cleunik = _acteurs.typeacteur "; 
switch ($vl_c_actifs) {
  case '3': //  C'est un panier 
    $vl_e_panier=fa_recup_param('vl_e_panier','');
    
    
    $sql_req_panier = "SELECT panier_requete_selection as req,panier_resultat,panier_type,panier_portee FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
    $result = _graal_requete_bd($sql_req_panier);
    $row = mysql_fetch_assoc($result);
    $panier_portee=$row['panier_portee'];
    if ($row['panier_type']==1) {
      $vl_act_cleunik=$row['panier_resultat'];
      _graal_libere_requete_bd($result);
    } else {
      $sql_req_panier = $row['req'];
      _graal_libere_requete_bd($result);
      $result = _graal_requete_bd($sql_req_panier);
      $vl_act_cleunik="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_act_cleunik.=$row[act_cleunik].',';
      }
      if ($vl_act_cleunik!="") {
        $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
      }
    }
    switch ($panier_portee) {
      case 8192+2 ://  prospects clients 
      case 8192+4 ://  clients
      case 8192+8 ://  Prospects fournisseurs
      case 8192+16 ://  Fournisseurs
      case 8192+32 ://  Autres acteurs
      case 8192+64 ://  Acteurs indéterminés
        $sql_req.=" and _acteurs.act_cleunik in($vl_act_cleunik)";
        break;
      case 4096+2:  //  interlocuteurs de prospects clients
      case 4096+4:  //  interlocuteurs de clients
      case 4096+8:  //  interlocuteurs de prospects fournisseurs
      case 4096+16:  //  interlocuteurs de fournisseurs
      case 4096+32:  //  interlocuteurs d'autres acteurs
      case 4096+64:  //  interlocuteurs d'acteurs indéterminés
        $sql_req.=" and _act_interlo.int_cleunik in($vl_act_cleunik)";
        break;
    }
    if ($vl_c_veuxpasdemail!="") {$sql_req.=" and _act_interlo_mail.veuxpasdemail in($vl_c_veuxpasdemail)";}
    if ($vl_c_valide!="") {$sql_req.=" and _act_interlo_mail.valide in($vl_c_valide)";}
		if ($vl_c_deja_dans_emailing==2) {$sql_req.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik)";}
    break;
  default:
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_courriel');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        //unset($_SESSION["$vl_c_var"]);  //  Attention, il ne faut pas détruire cette variable car en fait ce script est appelé 2 fois dans pf_masse_04_suite de _graal_courriel_traitements_01.js.php
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_intweb_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_intweb_cleunik!="") {
          $vl_intweb_cleunik=substr($vl_intweb_cleunik, 0, -1);
        } else {
          $vl_intweb_cleunik="-99999999999999999";
        }
        $sql_req.=" and intweb_cleunik IN($vl_intweb_cleunik)";
        break;
      default:
    }
    if ($vl_c_veuxpasdemail!="") {$sql_req.=" and _act_interlo_mail.veuxpasdemail in($vl_c_veuxpasdemail)";}
    if ($vl_c_valide!="") {$sql_req.=" and _act_interlo_mail.valide in($vl_c_valide)";}

    switch ($vl_e_typeacteur) {
        case 2: $sql_req.=" and _acteurs.typeacteur =110000";break; //  membres de l'entreprise
        case 3: $sql_req.=" and _acteurs.typeacteur =110001";break; //  Prospects clients  
        case 4: $sql_req.=" and _acteurs.typeacteur =110003";break; //  Clients 
        case 5: $sql_req.=" and _acteurs.typeacteur =110002";break; //  Prospects fournisseurs
        case 6: $sql_req.=" and _acteurs.typeacteur =110004";break; //  Fournisseurs
        case 7: $sql_req.=" and _acteurs.typeacteur =110005";break; //  Autres acteurs
        case 8: $sql_req.=" and _acteurs.typeacteur =110006";break; //  Acteurs indéterminés
        case 9: break; //  Tous les acteurs
    }
    switch ($vl_c_actifs) {
      case '1': $sql_req.=" and _acteurs.actif=1";break; //  actifs
      case '2': $sql_req.=" and _acteurs.actif=2";break;//  inactifs
      case '0': break;//  tous
    }
    switch ($vl_c_quoi) {
      case 1 : $sql_req.=" and _acteurs.raisonsoc like '$vl_c_raisonsoc%' ORDER BY `raisonsoc` ASC";break;  //  Raison sociale
      case 2 : $sql_req.=" and _acteurs.nomcommercial like '$vl_c_raisonsoc%' ORDER BY `nomcommercial` ASC";break;  //  Nom commercial
      case 3 : $sql_req.=" and concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) like '$vl_c_raisonsoc%' ORDER BY qui ASC";break;  //  Interlocuteur
      case 4 : $sql_req.=" and _act_interlo_mail.refweb like '$vl_c_raisonsoc%' ORDER BY `refweb` ASC";break;  //  adresse courriel
      case 5 : $sql_req.=" and _act_interlo_mail.refweb='$vl_c_raisonsoc'";break;  //  adresse courriel exacte
      case 6 : break;  //  Pas de condition supplémentaire particulière
      default:
    }
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        break;
      default:
        if ($vl_c_deja_dans_emailing!=2) {
					$sql_req.="  LIMIT 0, $vl_e_limit";
				} else {
					/*
					 * on fera le test, en comptant dans la fenêtre suivante
					 * */
				}
    }
    break;
}
session_write_close(); //  Nécessaire pour éviter le blocage du au trop long traitements de vérifiaction d'existence des courriels voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
switch ($vl_c_sortie) {
  case "das":
	case "rdf":
    include("_graal_das_courriel_02.php");
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
}
?>
