<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_numerotation.php");
define('EOL', "\r\n");
$vl_nomcommercial=fa_recup_param('vl_nomcommercial','');
$genreacteur=fa_recup_param('genreacteur','');
$vl_codealphanum15=fa_recup_param('vl_codealphanum15','');
switch ($genreacteur) {
  case "110001":  //  Prospect client
  case "110003":  //  Client
    $num_cleunik=9;
    break;
  case "110002":  //  Prospect fournisseur
  case "110004":  //  Fournisseur
    $num_cleunik=10;
    break;
}
//  Numérotation automatique
$sql_req="select description,der_numero from _numerotations where num_cleunik=$num_cleunik;";
$result=_graal_requete_bd($sql_req);
if (mysql_num_rows($result)!=0) {
  $row=mysql_fetch_assoc($result);
  $vl_c_format=$row['description'];
  $vl_e_valeur=$row['der_numero'];
  _graal_libere_requete_bd($result);
	if(preg_match("/{#n/i",$vl_c_format)) {
		$vl_e_valeur++;
  		//  Mise à jour de la numérotation
  		$sql_req_01="UPDATE _numerotations set der_numero=$vl_e_valeur,dateheuremodif=now() where num_cleunik=$num_cleunik;";
  		if(_graal_exec_requete($sql_req_01)!="ok") {$vf_c_retour=-4;}
	}
	if(preg_match("/{#acteur#}/i",$vl_c_format)) {
		$code=addslashes(_graal_numerotation_formate($vl_codealphanum15,$vl_c_format));
	} else {
		$code=addslashes(_graal_numerotation_formate($vl_e_valeur,$vl_c_format));
	}
  $pc_cleunik=_graal_requete_max("pc_cleunik","_param_pc");
  $sql_req="INSERT INTO _param_pc (pc_cleunik,code,intitule,dateheurecreation,actif) values ($pc_cleunik,'$code','$vl_nomcommercial',now(),1);";
  $result=_graal_requete_bd($sql_req);
} else {
  $pc_cleunik=-1;
}
echo fa_xcree_entete_xml();
echo('<Description>');
echo('<pc_cleunik data="'.$pc_cleunik.'"/>');
echo('<code data="'.fa_ent_xml($code).'"/>');
echo('</Description>');
?>
