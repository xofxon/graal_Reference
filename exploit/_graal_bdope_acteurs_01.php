<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
include("_import_class_data_km.php");
include("_graal_fonctions_documents.php");
include("_graal_fonctions_numerotation.php");
define('EOL', "\r\n");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_acteurs_01";
$t_origines_ok[1]="_graal_fen_acteurs_simple_01";
$t_origines_ok[2]="_graal_fen_acteurs_simple_02";
$t_origines_ok[3]="_graal_fen_act_duplication";
$t_origines_ok[4]="_graal_import_acteurs_01";
$t_origines_ok[5]="_graal_fen_acteurs_simple_03";
$t_origines_ok[6]="_graal_fen_acteurs_simple_04";
$t_origines_ok[7]="_graal_fen_acteurs_simple_05";
$t_origines_ok[8]="_graal_import_acteurs_02";
$t_origines_ok[9]="_graal_import_acteurs_03";
$t_origines_ok[10]="_graal_traitements_acteurs_01";
$t_origines_ok[11]="_graal_import_acteurs_04";
fa_acces_script();
$vf_c_action=fa_recup_param('vf_c_action','??????');
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$vl_act_cleunik=intval(fa_recup_param('vl_act_cleunik',0));
$vl_codealphanum15=fa_recup_param("vl_codealphanum15","");
$vl_raisonsoc=fa_recup_param('vl_raisonsoc','');
$vl_nomcommercial=fa_recup_param('vl_nomcommercial','');
$vl_siret=fa_recup_param('vl_siret','');
$vl_blocnotebrut=fa_recup_param('vl_blocnotebrut','');
//$vl_blocnotertf=fa_recup_param('vl_blocnotertf','');
//$vl_dateheurevalidite=fa_recup_param("vl_dateheurevalidite","");
$vl_typeacteur=intval(fa_recup_param("vl_typeacteur",""));
$vl_mnemotechnique=fa_recup_param("vl_mnemotechnique","");
$vl_modegestion=intval(fa_recup_param("vl_modegestion",""));
$vl_devise=intval(fa_recup_param("vl_devise",""));
$vl_langue=intval(fa_recup_param("vl_langue",""));
$vl_actif=intval(fa_recup_param("vl_actif",""));
$vl_tva=fa_recup_param('vl_tva','');
$vl_compte=fa_recup_param('vl_compte','');
$vl_encours_autorise=fa_floatval(fa_recup_param('vl_encours_autorise',0));
$vl_tarif=intval(fa_recup_param("vl_tarif",""));
$vl_remise_taux=fa_floatval(fa_recup_param("vl_remise_taux",0));
$vl_remise_type=intval(fa_recup_param("vl_remise_type",1));
$vl_remise_genr=intval(fa_recup_param("vl_remise_genr",1));
$vl_escompte_taux=fa_floatval(fa_recup_param("vl_escompte_taux",0));
$vl_escompte_type=intval(fa_recup_param("vl_escompte_type",1));
$vl_remise_natu=intval(fa_recup_param("vl_remise_natu",1));
$vl_modereglement=intval(fa_recup_param("vl_modereglement",-1));
$vl_catcompta_cleunik=intval(fa_recup_param("vl_catcompta_cleunik",-1));
$vl_pc_cleunik=intval(fa_recup_param("vl_pc_cleunik",-1));
$vl_assujetti_tpf=intval(fa_recup_param("vl_assujetti_tpf",1));
$vl_montant_port=fa_floatval(fa_recup_param("vl_montant_port",0));
$vl_seuil_franco=fa_floatval(fa_recup_param("vl_seuil_franco",0));
$vl_commande_mini=fa_floatval(fa_recup_param("vl_commande_mini",0));
if ($vl_pc_cleunik==0) {$vl_pc_cleunik=-1;}
if ($vl_catcompta_cleunik==0){$vl_catcompta_cleunik=-1;}
if ($vl_modereglement==0){$vl_modereglement=-1;}
//  Eventuelles informations interlocuteur
$vl_codealphanum15_interlo=fa_recup_param("vl_codealphanum15_interlo","");
$vl_patronyme=fa_recup_param("vl_patronyme","");
$vl_blocnotebrut_interlo=fa_recup_param("vl_blocnotebrut_interlo","");
$vl_prenom=fa_recup_param("vl_prenom","");
$vl_infodefaut=intval(fa_recup_param("vl_infodefaut",0));
$vl_actif_interlo=intval(fa_recup_param("vl_actif_interlo",0));
$vl_fonction=intval(fa_recup_param("vl_fonction",0));
//$vl_dateheurevalidite=fa_recup_param("vl_dateheurevalidite","");
$vl_choix_cleunik=intval(fa_recup_param("vl_choix_cleunik",0));
//  Eventuelles informations courriel
$vl_refweb=fa_recup_param("vl_refweb","");
$vl_blocnotebrut_courriel=fa_recup_param("vl_blocnotebrut_courriel","");
$vl_veuxpasdemail=intval(fa_recup_param("vl_veuxpasdemail",""));
$vl_infofavori=intval(fa_recup_param("vl_infofavori",""));
$vl_utilisable=intval(fa_recup_param("vl_utilisable","1"));
$vl_choix_cleunik_courriel=intval(fa_recup_param("vl_choix_cleunik_courriel",""));
$vl_valide=intval(fa_recup_param("vl_valide",""));
//  Eventuelles informations tel
$vl_telformate_tel=fa_recup_param("vl_telformate_tel","");
$vl_blocnotebrut_tel=fa_recup_param("vl_blocnotebrut_tel","");
$vl_infofavori_tel=intval(fa_recup_param("vl_infofavori_tel",0));
$vl_choix_cleunik_tel=intval(fa_recup_param("vl_choix_cleunik_tel",0));
$vl_prefixe_choix_cleunik_tel=intval(fa_recup_param("vl_prefixe_choix_cleunik_tel",0));
$vl_portable_tel=intval(fa_recup_param("vl_portable_tel",2));
$vl_sms_tel=intval(fa_recup_param("vl_sms_tel",2));
$vl_c_chaine_nette_tel=preg_replace($a, $b, $vl_telformate_tel);
//  Eventuelles informations fax
$vl_telformate_fax=fa_recup_param("vl_telformate_fax","");
$vl_blocnotebrut_fax=fa_recup_param("vl_blocnotebrut_fax","");
$vl_infofavori_fax=intval(fa_recup_param("vl_infofavori_fax",0));
$vl_choix_cleunik_fax=intval(fa_recup_param("vl_choix_cleunik_fax",0));
$vl_prefixe_choix_cleunik_fax=intval(fa_recup_param("vl_prefixe_choix_cleunik_fax",0));
$vl_c_chaine_nette_fax=preg_replace($a, $b, $vl_telformate_fax);
//  Eventuelles infoarmations adresse postale
$vl_adr_cod=fa_recup_param("vl_adr_cod","");
$vl_adr_complementnom=fa_recup_param("vl_adr_complementnom","");
$vl_adr_ligne1=fa_recup_param("vl_adr_ligne1","");
$vl_adr_ligne2=fa_recup_param("vl_adr_ligne2","");
$vl_adr_ligne3=fa_recup_param("vl_adr_ligne3","");
$vl_adr_cp=fa_recup_param("vl_adr_cp","");
$vl_adr_ville=fa_recup_param("vl_adr_ville","");
$vl_choix_cleunik_pays=intval(fa_recup_param("vl_choix_cleunik_pays",""));
$vl_adr_latitude=fa_floatval(fa_recup_param("vl_adr_latitude",""));
$vl_adr_longitude=fa_floatval(fa_recup_param("vl_adr_longitude",""));
$vl_adr_typecoordonnees=intval(fa_recup_param("vl_adr_typecoordonnees",""));
//  Eventuelles informations deuxième téléphone
$vl_telformate_tel_01=fa_recup_param("vl_telformate_tel_01","");
$vl_blocnotebrut_tel_01=fa_recup_param("vl_blocnotebrut_tel_01","");
$vl_infofavori_tel_01=intval(fa_recup_param("vl_infofavori_tel_01",0));
$vl_choix_cleunik_tel_01=intval(fa_recup_param("vl_choix_cleunik_tel_01",0));
$vl_prefixe_choix_cleunik_tel_01=intval(fa_recup_param("vl_prefixe_choix_cleunik_tel_01",0));
$vl_portable_tel_01=intval(fa_recup_param("vl_portable_tel_01",2));
$vl_sms_tel_01=intval(fa_recup_param("vl_sms_tel_01",2));
$vl_c_chaine_nette_tel_01=preg_replace($a, $b, $vl_telformate_tel_01);
if ($vf_c_action!="importer_0" && $vf_c_action!="importer_02" && $vf_c_action!="importer_03" && $vf_c_action!="importer_04" && $vf_c_action!="changer_genre_kilometre"){
	if ($vl_act_cleunik==0) {exit;}
}
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_tb_reg_00011=_graal_requete_regle("Reg_00011"); //  Numérotation automatique des clients
$vl_tb_reg_00012=_graal_requete_regle("Reg_00012"); //  Numérotation automatique des fournisseurs
$vf_c_echo='';
switch (TRUE) {
  case $vf_c_action=='supprimer':
    if ($vl_act_cleunik==0) {exit;}
    $sql_req = "DELETE FROM _acteurs WHERE _acteurs.act_cleunik = $vl_act_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='ajouter':
    $vl_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
    if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00011[0]==1 && $vl_typeacteur=="110003"){$vl_codealphanum15=_graal_numerote(17);}	//	Numérotation automatique de client
    if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00012[0]==1 && $vl_typeacteur=="110004"){$vl_codealphanum15=_graal_numerote(18);}	//	Numérotation automatique de fournisseur
    $sql_req = "INSERT INTO _acteurs set act_cleunik=$vl_act_cleunik,codealphanum15='$vl_codealphanum15',raisonsoc='$vl_raisonsoc',nomcommercial='$vl_nomcommercial',siret='$vl_siret',blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),dateheurecreation=now(),typeacteur=$vl_typeacteur,c_uuid=(select uuid()),mnemotechnique='$vl_mnemotechnique',modegestion=$vl_modegestion,actif=$vl_actif,devise=$vl_devise,langue=$vl_langue;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
    	$vf_c_echo=$vl_act_cleunik;
    	pf_ajoute_listes($vl_act_cleunik);

    	switch ($vl_typeacteur) {
	      case "110003": //  clients
	      case "110004":  //  fournisseurs
	      case "110001": //  prospects clients
	      case "110002":  //  prospects fournisseurs
	      	/*
	        //  Un update aboutit toujours, sauf si il y a une erreur de syntaxe : on fait donc un replace !!
	        $sql_req = "INSERT INTO _act_compta set act_cleunik=$vl_act_cleunik,compte='$vl_compte',tvaintracommunautaire='$vl_tva',catcompta_cleunik=$vl_catcompta_cleunik,encours_autorise=$vl_encours_autorise,tarif_cleunik=$vl_tarif,remise_taux=$vl_remise_taux,remise_type=$vl_remise_type,remise_genr=$vl_remise_genr,escompte_taux=$vl_escompte_taux,escompte_type=$vl_escompte_type,remise_natu=$vl_remise_natu,reg_cleunik=$vl_modereglement,pc_cleunik=$vl_pc_cleunik,assujetti_tpf=$vl_assujetti_tpf,montant_port=$vl_montant_port,seuil_franco=$vl_seuil_franco,commande_mini=$vl_commande_mini;";
	        $vf_c_echo=_graal_exec_requete($sql_req);
	        if($vf_c_echo=='ok') {
	          $vf_c_echo=$vl_act_cleunik;
	        }
	        else {
	          $vf_c_echo=-1;}
	        */
	      	$vf_c_echo=pf_ajoute_compta($vl_act_cleunik,$vl_typeacteur);
	        break;
	    }
    } else {
    	$vf_c_echo=-1;
    }
    break;
  case $vf_c_action=="ajouter_simple_courriel":
  	if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00011[0]==1 && $vl_typeacteur=="110003"){$vl_codealphanum15=_graal_numerote(17);}	//	Numérotation automatique de client
    if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00012[0]==1 && $vl_typeacteur=="110004"){$vl_codealphanum15=_graal_numerote(18);}	//	Numérotation automatique de fournisseur
    $vl_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
    $sql_req = "INSERT INTO _acteurs set act_cleunik=$vl_act_cleunik,codealphanum15='$vl_codealphanum15',raisonsoc='$vl_raisonsoc',nomcommercial='$vl_nomcommercial',siret='$vl_siret',blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),dateheurecreation=now(),typeacteur=$vl_typeacteur,c_uuid=(select uuid()),mnemotechnique='$vl_mnemotechnique',modegestion=$vl_modegestion,actif=$vl_actif,devise=$vl_devise;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
    	pf_ajoute_listes($vl_act_cleunik);
    	$vf_c_echo=pf_ajoute_compta($vl_act_cleunik,$vl_typeacteur);
      $vl_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
      $sql_req = "INSERT INTO _act_interlo set int_cleunik=$vl_int_cleunik,codealphanum15='$vl_codealphanum15_interlo',act_cleunik=$vl_act_cleunik,patronyme='$vl_patronyme',blocnotebrut='$vl_blocnotebrut_interlo',prenom='$vl_prenom',dateheuremodif=now(),infodefaut=$vl_infodefaut,choix_cleunik=$vl_choix_cleunik,actif=$vl_actif_interlo";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo=='ok') {
        $sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vl_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$vl_fonction,critere_cleunik=92,typeacteur=$vl_typeacteur,uti_cleunik=0";
        if(_graal_exec_requete($sql_req)!='ok') {$vf_c_echo=-1;}
        $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
        $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_courriel',veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
        $vf_c_echo=_graal_exec_requete($sql_req);
        if($vf_c_echo=='ok') {
          $vf_c_echo=$vl_e_fen_cleunik;
        }  else
        {
          $vf_c_echo=-1;
        }
        $vf_c_echo=$vl_int_cleunik;
      } else {
        $vf_c_echo=-1;
      }
      $vf_c_echo=$vl_act_cleunik;
      } else {
        $vf_c_echo=-1;
      }
    break;
  case $vf_c_action=="ajouter_simple_courriel_tel_fax":
  case $vf_c_action=="ajouter_simple_fax":
  	if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00011[0]==1 && $vl_typeacteur=="110003"){$vl_codealphanum15=_graal_numerote(17);}	//	Numérotation automatique de client
    if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00012[0]==1 && $vl_typeacteur=="110004"){$vl_codealphanum15=_graal_numerote(18);}	//	Numérotation automatique de fournisseur
    $vl_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
    $sql_req = "INSERT INTO _acteurs set act_cleunik=$vl_act_cleunik,codealphanum15='$vl_codealphanum15',raisonsoc='$vl_raisonsoc',nomcommercial='$vl_nomcommercial',siret='$vl_siret',blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),dateheurecreation=now(),typeacteur=$vl_typeacteur,c_uuid=(select uuid()),mnemotechnique='$vl_mnemotechnique',modegestion=$vl_modegestion,actif=$vl_actif,devise=$vl_devise;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
    	pf_ajoute_listes($vl_act_cleunik);
    	$vf_c_echo=pf_ajoute_compta($vl_act_cleunik,$vl_typeacteur);
      if (trim($vl_adr_ligne1.$vl_adr_ligne2.$vl_adr_ligne3)!="") {
        $vl_adr_cleunik=_graal_requete_max("adr_cleunik","_act_adresses");
        $sql_req = "INSERT INTO _act_adresses set adr_cleunik=$vl_adr_cleunik,adr_cod='$vl_adr_cod',act_cleunik=$vl_act_cleunik,adr_complementnom='$vl_adr_complementnom',adr_ligne1='$vl_adr_ligne1',adr_ligne2='$vl_adr_ligne2',adr_ligne3='$vl_adr_ligne3',adr_cp='$vl_adr_cp',adr_ville='$vl_adr_ville',choix_cleunik=$vl_choix_cleunik_pays,dateheuremodif=now(),adr_latitude=$vl_adr_latitude,adr_longitude=$vl_adr_longitude,adr_typecoordonnees=$vl_adr_typecoordonnees,adr_type=1";
        $vf_c_echo=_graal_exec_requete($sql_req);
      }
      if (trim($vl_patronyme.$vl_prenom)!="") {
        $vl_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
        $sql_req = "INSERT INTO _act_interlo set int_cleunik=$vl_int_cleunik,codealphanum15='$vl_codealphanum15',act_cleunik=$vl_act_cleunik,patronyme='$vl_patronyme',blocnotebrut='$vl_blocnotebrut',prenom='$vl_prenom',dateheuremodif=now(),infodefaut=$vl_infodefaut,choix_cleunik=$vl_choix_cleunik,actif=$vl_actif";
        $vf_c_echo=_graal_exec_requete($sql_req);
        if($vf_c_echo=='ok') {
          $sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vl_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$vl_fonction,critere_cleunik=92,typeacteur=$vl_typeacteur,uti_cleunik=0";
          if(_graal_exec_requete($sql_req)!='ok') {$vf_c_echo=-1;}
          if ($vl_refweb!="") {
            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_courriel',veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
            $vf_c_echo=_graal_exec_requete($sql_req);
          }
          if ($vl_telformate_tel!="") {
            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_tel");
            $sql_req = "INSERT INTO _act_interlo_tel set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_tel',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_tel',intel_05='$vl_c_chaine_nette_tel',intel_06=$vl_c_chaine_nette_tel,infofavori=$vl_infofavori_tel,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_tel,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_tel,portable=$vl_portable_tel,sms=$vl_sms_tel;";
            $vf_c_echo=_graal_exec_requete($sql_req);
          }
          if ($vl_telformate_fax!="") {
            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_fax");
            $sql_req = "INSERT INTO _act_interlo_fax set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_fax',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_fax',intel_05='$vl_c_chaine_nette_fax',intel_06=$vl_c_chaine_nette_fax,infofavori=$vl_infofavori_fax,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_fax,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_fax;";
            $vf_c_echo=_graal_exec_requete($sql_req);
          }
          $vf_c_echo=$vl_int_cleunik;
        } else {
          $vf_c_echo=-1;
        }
      }
      $vf_c_echo=$vl_act_cleunik;
    }  else {
        $vf_c_echo=-1;
      }
    break;
  case $vf_c_action=="ajouter_simple_courriel_tel_tel":
  case $vf_c_action=="ajouter_simple_tel":
  	if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00011[0]==1 && $vl_typeacteur=="110003"){$vl_codealphanum15=_graal_numerote(17);}	//	Numérotation automatique de client
    if (trim($vl_codealphanum15)=="" && $vl_tb_reg_00012[0]==1 && $vl_typeacteur=="110004"){$vl_codealphanum15=_graal_numerote(18);}	//	Numérotation automatique de fournisseur
    $vl_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
    $sql_req = "INSERT INTO _acteurs set act_cleunik=$vl_act_cleunik,codealphanum15='$vl_codealphanum15',raisonsoc='$vl_raisonsoc',nomcommercial='$vl_nomcommercial',siret='$vl_siret',blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),dateheurecreation=now(),typeacteur=$vl_typeacteur,c_uuid=(select uuid()),mnemotechnique='$vl_mnemotechnique',modegestion=$vl_modegestion,actif=$vl_actif,devise=$vl_devise;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
    	pf_ajoute_listes($vl_act_cleunik);
    	$vf_c_echo=pf_ajoute_compta($vl_act_cleunik,$vl_typeacteur);
      if (trim($vl_adr_ligne1.$vl_adr_ligne2.$vl_adr_ligne3)!="") {
        $vl_adr_cleunik=_graal_requete_max("adr_cleunik","_act_adresses");
        $sql_req = "INSERT INTO _act_adresses set adr_cleunik=$vl_adr_cleunik,adr_cod='$vl_adr_cod',act_cleunik=$vl_act_cleunik,adr_complementnom='$vl_adr_complementnom',adr_ligne1='$vl_adr_ligne1',adr_ligne2='$vl_adr_ligne2',adr_ligne3='$vl_adr_ligne3',adr_cp='$vl_adr_cp',adr_ville='$vl_adr_ville',choix_cleunik=$vl_choix_cleunik_pays,dateheuremodif=now(),adr_latitude=$vl_adr_latitude,adr_longitude=$vl_adr_longitude,adr_typecoordonnees=$vl_adr_typecoordonnees,adr_type=1";
        $vf_c_echo=_graal_exec_requete($sql_req);
      }
      if (trim($vl_patronyme.$vl_prenom)!="") {
        $vl_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
        $sql_req = "INSERT INTO _act_interlo set int_cleunik=$vl_int_cleunik,codealphanum15='$vl_codealphanum15',act_cleunik=$vl_act_cleunik,patronyme='$vl_patronyme',blocnotebrut='$vl_blocnotebrut',prenom='$vl_prenom',dateheuremodif=now(),infodefaut=$vl_infodefaut,choix_cleunik=$vl_choix_cleunik,actif=$vl_actif";
        $vf_c_echo=_graal_exec_requete($sql_req);
        if($vf_c_echo=='ok') {
          $sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vl_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$vl_fonction,critere_cleunik=92,typeacteur=$vl_typeacteur,uti_cleunik=0";
          if(_graal_exec_requete($sql_req)!='ok') {$vf_c_echo=-1;}
          if ($vl_refweb!="") {
            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_courriel',veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
            $vf_c_echo=_graal_exec_requete($sql_req);
          }
          if ($vl_telformate_tel!="") {
            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_tel");
            $sql_req = "INSERT INTO _act_interlo_tel set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_tel',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_tel',intel_05='$vl_c_chaine_nette_tel',intel_06=$vl_c_chaine_nette_tel,infofavori=$vl_infofavori_tel,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_tel,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_tel,portable=$vl_portable_tel,sms=$vl_sms_tel;";
            $vf_c_echo=_graal_exec_requete($sql_req);
          }
          if ($vl_telformate_tel_01!="") {
            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_tel");
            $sql_req = "INSERT INTO _act_interlo_tel set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_tel_01',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut_tel_01',intel_05='$vl_c_chaine_nette_tel_01',intel_06=$vl_c_chaine_nette_tel_01,infofavori=$vl_infofavori_tel_01,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik_tel_01,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_tel_01,portable=$vl_portable_tel_01,sms=$vl_sms_tel_01;";
            $vf_c_echo=_graal_exec_requete($sql_req);
          }
          $vf_c_echo=$vl_int_cleunik;
        } else {
          $vf_c_echo=-1;
        }
      }
      $vf_c_echo=$vl_act_cleunik;
    }  else {
        $vf_c_echo=-1;
      }
    break;



  case $vf_c_action=='modifier':
    $sql_req = "UPDATE _acteurs set codealphanum15='$vl_codealphanum15',raisonsoc='$vl_raisonsoc',nomcommercial='$vl_nomcommercial',siret='$vl_siret',blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),mnemotechnique='$vl_mnemotechnique',modegestion=$vl_modegestion,actif=$vl_actif,devise=$vl_devise,langue=$vl_langue where act_cleunik=$vl_act_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_act_cleunik;} else {$vf_c_echo=-1;}
    if ($vl_actif==2){
      $vl_tb_reg_00001=_graal_requete_regle("Reg_00001"); //  Règle qui détermine si on doit désactiver les interlocuteurs lorsque l'on désactive les acteurs
      $vl_b_desactive_interlo=$vl_tb_reg_00001[0];
      if ($vl_b_desactive_interlo==true) {
        $sql_req = "UPDATE _act_interlo SET actif=2 WHERE act_cleunik in($vl_act_cleunik);";
        $vf_c_echo=_graal_exec_requete($sql_req);
      }
    }
    switch ($vl_typeacteur) {
      case "110003": //  clients
      case "110004":  //  fournisseurs
      case "110001": //  prospects clients
      case "110002":  //  prospects fournisseurs
        //  Un update aboutit toujours, sauf si il y a une erreur de syntaxe : on fait donc un replace !!
        $sql_req = "REPLACE INTO _act_compta set act_cleunik=$vl_act_cleunik,compte='$vl_compte',tvaintracommunautaire='$vl_tva',catcompta_cleunik=$vl_catcompta_cleunik,encours_autorise=$vl_encours_autorise,tarif_cleunik=$vl_tarif,remise_taux=$vl_remise_taux,remise_type=$vl_remise_type,remise_genr=$vl_remise_genr,escompte_taux=$vl_escompte_taux,escompte_type=$vl_escompte_type,remise_natu=$vl_remise_natu,reg_cleunik=$vl_modereglement,pc_cleunik=$vl_pc_cleunik,assujetti_tpf=$vl_assujetti_tpf,montant_port=$vl_montant_port,seuil_franco=$vl_seuil_franco,commande_mini=$vl_commande_mini;";
        $vf_c_echo=_graal_exec_requete($sql_req);
        if($vf_c_echo=='ok') {
          $vf_c_echo=$vl_act_cleunik;
        }
        else {
          $vf_c_echo=-1;}
        break;
    }
    break;
  case $vf_c_action=="verifier_noms":
    $tab_act_cleunik=array();
    $tab_act_cleunik[0]=-2;
		$vf_c_echo=trim($vl_raisonsoc.$vl_nomcommercial);
    if (trim($vl_raisonsoc.$vl_nomcommercial)!="") {
      $cond01="";
      if (trim($vl_raisonsoc)!="") {$cond01.="nomcommercial like '%$vl_raisonsoc%' or raisonsoc like '%$vl_raisonsoc%'";}
      if (trim($vl_nomcommercial)!="") {$cond01.="nomcommercial like '%$vl_nomcommercial%' or raisonsoc like '%$vl_nomcommercial%'";}
      $sql_req="select act_cleunik from _acteurs where 1 and $cond01;";
      $result = _graal_requete_bd($sql_req);
      while ($row = mysql_fetch_assoc($result)) {
        array_push ($tab_act_cleunik, $row['act_cleunik']);
      }
      _graal_libere_requete_bd($result);
    }
    $vf_c_echo.=implode(",",$tab_act_cleunik);
    break;
	case $vf_c_action=="changer_genre":
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
		$sql_req = "UPDATE _acteurs set typeacteur=$vl_typeacteur where act_cleunik=$vl_act_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    $sql_req="update _act_choix_fixes f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.typeacteur=f2.typeacteur where f1.typeacteur<>f2.typeacteur;";
	$vf_c_echo=_graal_exec_requete($sql_req);

    if($vf_c_echo=='ok') {$vf_c_retour.="";
			switch ($vl_typeacteur) {
	      case "110001": 	$vl_e_portee=$vl_e_procli;break;//  prospects clients
	      case "110002":  $vl_e_portee=$vl_e_profou;break;//  prospects fournisseurs
				case "110003": 	$vl_e_portee=$vl_e_client;break;//  clients
	      case "110004":  $vl_e_portee=$vl_e_fourni;break;//  fournisseurs
				case "110005": 	$vl_e_portee=$vl_e_autrac;break;//  autres acteurs
	      case "110006":  $vl_e_portee=$vl_e_actind;break;//  acteurs indéterminés
			}
			$vf_c_retour=pf_verif_portees($vl_portee);
		} else {
			$vf_c_retour.=$sql_req;
		}
		if (trim($vf_c_retour)=="") {
        $vf_c_echo=$vl_e_act_cleunik;
        _graal_requete_bd("COMMIT;");
      } else {
        $vf_c_echo=-1;
				$vf_c_echo=$vf_c_retour;
        _graal_requete_bd("ROLLBACK;");
      }
  	break;
  	case $vf_c_action=="changer_genre_kilometre":
  		$vl_t_acteur=fa_recup_param("vl_t_acteur","");
	    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
	    $vl_b_transaction_ok=true;
	    $vl_e_i=-1;
	    foreach($vl_t_acteur as $vl_raf) {
	      $vl_e_i++;
	      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
	    	$deb_trans=_graal_requete_bd("START TRANSACTION;");
		    $vf_c_retour="";
			$sql_req = "UPDATE _acteurs set typeacteur=$vl_typeacteur where act_cleunik=$vl_act_cleunik";
	    	$vf_c_echo=_graal_exec_requete($sql_req);
		    if($vf_c_echo=='ok') {
		    		$vf_c_retour.="";
					switch ($vl_typeacteur) {
				      case "110001":$vl_e_portee=$vl_e_procli;break;//  prospects clients
				      case "110002":$vl_e_portee=$vl_e_profou;break;//  prospects fournisseurs
					  case "110003":$vl_e_portee=$vl_e_client;break;//  clients
				      case "110004":$vl_e_portee=$vl_e_fourni;break;//  fournisseurs
					  case "110005":$vl_e_portee=$vl_e_autrac;break;//  autres acteurs
				      case "110006":$vl_e_portee=$vl_e_actind;break;//  acteurs indéterminés
					}
					$vf_c_retour=pf_verif_portees($vl_portee);
				} else {
					$vf_c_retour.=$sql_req;
				}
				if (trim($vf_c_retour)=="") {
		        $vf_c_echo=$vl_e_act_cleunik;
		        _graal_requete_bd("COMMIT;");
		      } else {
		        $vf_c_echo=-1;
						$vf_c_echo=$vf_c_retour;
		        _graal_requete_bd("ROLLBACK;");
		      }
	    }
	  	$sql_req="update _act_choix_fixes f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.typeacteur=f2.typeacteur where f1.typeacteur<>f2.typeacteur;";
	  	$vf_c_echo=_graal_exec_requete($sql_req);
  	break;
	case $vf_c_action=="fusionner":
		/*
		 *
		 * update _act_interlo set act_cleunik=10000406 where act_cleunik=10000409;
update _act_interlo_tel set act_cleunik=10000406 where act_cleunik=10000409;
update _act_interlo_mesinst set act_cleunik=10000406 where act_cleunik=10000409;
update _act_interlo_mail set act_cleunik=10000406 where act_cleunik=10000409;
update _act_interlo_fax set act_cleunik=10000406 where act_cleunik=10000409;
update _act_interlo_choix_fixes set act_cleunik=10000406 where act_cleunik=10000409;
update _act_interlo_adresses set act_cleunik=10000406 where act_cleunik=10000409;
update _act_iban set act_cleunik=10000406 where act_cleunik=10000409;
update _act_choix_fixes set act_cleunik=10000406 where act_cleunik=10000409;
update _act_adresses set act_cleunik=10000406 where act_cleunik=10000409;
update _acteurs_representants set act_cleunik_droite=10000406 where act_cleunik_droite=10000409;
update _acteurs_representants set act_cleunik_gauche=10000406 where act_cleunik_gauche=10000409;
update _acteurs_relations set act_cleunik_droite=10000406 where act_cleunik_droite=10000409;
update _acteurs_relations set act_cleunik_gauche=10000406 where act_cleunik_gauche=10000409;
update _act_rib set act_cleunik=10000406 where act_cleunik=10000409;
update _act_sites set act_cleunik=10000406 where act_cleunik=10000409;
update _art_acteur set act_cleunik=10000406 where act_cleunik=10000409;
update _art_tarifs set act_cleunik=10000406 where act_cleunik=10000409;
update _avocli_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _avocli_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _avocli_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _avocli_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
update _cdecli_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _cdecli_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _cdecli_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _cdecli_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
update _cdefou_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _demfou_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update ignore _documents_rattachement set rat_cleunik=10000406 where rat_cleunik=10000409 and portee=8192;
update _faccli_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _faccli_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _faccli_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _faccli_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
update _facfou_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _facfou_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _facfou_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _facfou_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
update _graal set act_cleunik=10000406 where act_cleunik=10000409;
update _livcli_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _livcli_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _livcli_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _livcli_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
update _offcli_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _offcli_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _offcli_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _offcli_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
update _recfou_consignes set act_cleunik=10000406 where act_cleunik=10000409;
update _recfou_entetes set act_cleunik=10000406 where act_cleunik=10000409;
update _recfou_representants set act_cleunik_rep=10000406 where act_cleunik_rep=10000409;
update _recfou_transporteurs set act_cleunik_trans=10000406 where act_cleunik_trans=10000409;
		 *
		 *
		 *
		 */


		break;
	case $vf_c_action=="dupliquer":
	$vl_base_destination=fa_recup_param('vl_base_destination','');
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    $vl_e_act_cleunik_destination=_graal_requete_max("act_cleunik",$vl_base_destination."_acteurs");
    $vl_e_act_cleunik_origine=$vl_act_cleunik;
    $vl_codealphanum15="`codealphanum15` as `codealphanum15`";
    if ($vl_tb_reg_00011[0]==1 && $vl_typeacteur=="110003"){$vl_codealphanum15="'"._graal_numerote(17)."'";}	//	Numérotation automatique de client
    if ($vl_tb_reg_00012[0]==1 && $vl_typeacteur=="110004"){$vl_codealphanum15="'"._graal_numerote(18)."'";}	//	Numérotation automatique de fournisseur
    $sql_req = "INSERT INTO ".$vl_base_destination."_acteurs SELECT $vl_e_act_cleunik_destination,$vl_codealphanum15,`raisonsoc` as `raisonsoc`,`nomcommercial` as `nomcommercial`,`siret` as `siret`,`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,`dateheuremodif` as `dateheuremodif`,`dateheurevalidite` as `dateheurevalidite`,now(),$vl_typeacteur,`c_uuid` as `c_uuid`,`mnemotechnique` as `mnemotechnique`,`modegestion` as `modegestion`,`actif` as `actif`,`devise` as `devise`,langue FROM _acteurs where act_cleunik=$vl_e_act_cleunik_origine;";
    $toto=$sql_req;
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo!='ok') {$vf_c_retour.="1|$sql_req|";}
    if($vf_c_echo=='ok') {
    	pf_ajoute_listes($vl_e_act_cleunik_destination);
      $sql_req = "INSERT INTO ".$vl_base_destination."_acteurs_relations SELECT $vl_e_act_cleunik_destination,choix_cleunik_gauche,choix_cleunik_droite,blocnotebrut,blocnoteriche,act_cleunik_droite FROM _acteurs_relations where act_cleunik_gauche=$vl_e_act_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="2|$sql_req|";}
			$sql_req = "INSERT INTO ".$vl_base_destination."_acteurs_relations SELECT act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,blocnotebrut,blocnoteriche,$vl_e_act_cleunik_destination FROM _acteurs_relations where act_cleunik_droite=$vl_e_act_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="3|$sql_req|";}
      $sql_req = "INSERT INTO ".$vl_base_destination."_acteurs_representants SELECT $vl_e_act_cleunik_destination,choix_cleunik_gauche,choix_cleunik_droite,blocnotebrut,blocnoteriche,act_cleunik_droite,commission_typ,commission_taux,commission_fixe,commission_regle FROM _acteurs_representants where act_cleunik_gauche=$vl_e_act_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="4|$sql_req|";}
      $sql_req = "INSERT INTO ".$vl_base_destination."_acteurs_representants SELECT act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,blocnotebrut,blocnoteriche,$vl_e_act_cleunik_destination,commission_typ,commission_taux,commission_fixe,commission_regle FROM _acteurs_representants where act_cleunik_droite=$vl_e_act_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="5|$sql_req|";}
//$sql_req = "INSERT INTO ".$vl_base_destination."_act_choix_fixes SELECT $vl_e_act_cleunik_destination,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik FROM _act_choix_fixes where act_cleunik=$vl_e_act_cleunik_origine";
//$sql_req = "INSERT INTO ".$vl_base_destination."_act_choix_fixes SELECT $vl_e_act_cleunik_destination,f1.choix_cleunik,f1.critere_cleunik,f1.typeacteur,f1.uti_cleunik FROM _act_choix_fixes f1 inner join  box_via._choix f2 on f1.choix_cleunik=f2.choix_cleunik where f1.act_cleunik=$vl_e_act_cleunik_origine";
	  //$sql_req = "INSERT INTO ".$vl_base_destination."_act_choix_fixes SELECT $vl_e_act_cleunik_destination,f1.choix_cleunik,f1.critere_cleunik,f1.typeacteur,f1.uti_cleunik FROM box_via_emailing._act_choix_fixes f1 inner join  box_via._choix f2 on f1.choix_cleunik=f2.choix_cleunik inner join  box_via._criteres f3 on f1.critere_cleunik=f2.critere_cleunik where f1.act_cleunik=$vl_e_act_cleunik_origine group by choix_cleunik";
      $sql_req = "INSERT INTO ".$vl_base_destination."_act_choix_fixes SELECT $vl_e_act_cleunik_destination,f1.choix_cleunik,f1.critere_cleunik,$vl_typeacteur,f1.uti_cleunik FROM _act_choix_fixes f1 inner join ".$vl_base_destination."_choix f2 on f1.choix_cleunik=f2.choix_cleunik inner join  ".$vl_base_destination."_criteres f3 on f1.critere_cleunik=f2.critere_cleunik where f1.act_cleunik=$vl_e_act_cleunik_origine and f1.choix_cleunik not in(-148,-149) group by choix_cleunik";
$vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="6|$vf_c_echo|";}	// on ne gère pas les erreurs
      /*
       * Critères particuliers de duplication
       */
		$sql_req = "INSERT INTO ".$vl_base_destination."_act_choix_fixes SELECT $vl_e_act_cleunik_destination,-148,148,$vl_typeacteur,0 FROM _acteurs where act_cleunik=$vl_e_act_cleunik_origine;";
		$vf_c_echo=_graal_exec_requete($sql_req);
      	if($vf_c_echo!='ok') {$vf_c_retour.="6-1|$vf_c_echo|";}	// on ne gère pas les erreurs
		$sql_req = "INSERT INTO ".$vl_base_destination."_act_choix_fixes SELECT $vl_e_act_cleunik_destination,-149,148,$vl_typeacteur,0 FROM _acteurs where act_cleunik=$vl_e_act_cleunik_origine;";
		$vf_c_echo=_graal_exec_requete($sql_req);
      	if($vf_c_echo!='ok') {$vf_c_retour.="6-2|$vf_c_echo|";}	// on ne gère pas les erreurs


      $sql_req = "INSERT INTO ".$vl_base_destination."_act_compta SELECT $vl_e_act_cleunik_destination,compte,tvaintracommunautaire,catcompta_cleunik,encours_autorise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,reg_cleunik,pc_cleunik,assujetti_tpf,montant_port,seuil_franco,commande_mini FROM _act_compta where act_cleunik=$vl_e_act_cleunik_origine";

	$vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="7|$sql_req|";}
			$adr_cleunik=_graal_requete_max("adr_cleunik",$vl_base_destination."_act_adresses");
      $sql_req="SELECT adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,dateheuremodif,adr_latitude,adr_longitude,adr_typecoordonnees,adr_type FROM _act_adresses where act_cleunik=$vl_e_act_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      while ($row = mysql_fetch_assoc($result)){
				$adr_cod=fa_nt($row['adr_cod']);
				$adr_complementnom=fa_nt($row['adr_complementnom']);
				$adr_ligne1=fa_nt($row['adr_ligne1']);
				$adr_ligne2=fa_nt($row['adr_ligne2']);
				$adr_ligne3=fa_nt($row['adr_ligne3']);
				$adr_cp=fa_nt($row['adr_cp']);
				$adr_ville=fa_nt($row['adr_ville']);
				$choix_cleunik=fa_nn($row['choix_cleunik']);
				$dateheuremodif=fa_nt($row['dateheuremodif']);
				$adr_latitude=fa_nn($row['adr_latitude']);
				$adr_longitude=fa_nn($row['adr_longitude']);
				$adr_typecoordonnees=fa_nn($row['adr_typecoordonnees']);
				$adr_type=fa_nn($row['adr_type']);
				if ($adr_type=="null"){$adr_type=1;}
        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_adresses set adr_cleunik=$adr_cleunik,adr_cod=$adr_cod,act_cleunik=$vl_e_act_cleunik_destination,adr_complementnom=$adr_complementnom,adr_ligne1=$adr_ligne1,adr_ligne2=$adr_ligne2,adr_ligne3=$adr_ligne3,adr_cp=$adr_cp,adr_ville=$adr_ville,choix_cleunik=$choix_cleunik,dateheuremodif=$dateheuremodif,adr_latitude=$adr_latitude,adr_longitude=$adr_longitude,adr_typecoordonnees=$adr_typecoordonnees,adr_type=$adr_type;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
				$adr_cleunik++;
        if($vf_c_echo!='ok') {$vf_c_retour.="8|$sql_req_ins|";}
      }
      _graal_libere_requete_bd($result);
			$sql_req="SELECT iban_cleunik,act_cleunik,iban_info,iban_papi,iban_bic,iban_pay FROM _act_iban where act_cleunik=$vl_e_act_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
			$iban_cleunik=_graal_requete_max("iban_cleunik",$vl_base_destination."_act_iban");
      while ($row = mysql_fetch_assoc($result)){
				$iban_info=fa_nt($row['iban_info']);
				$iban_papi=fa_nt($row['iban_papi']);
				$iban_bic=fa_nt($row['iban_bic']);
				$iban_pay=fa_nn($row['iban_pay']);
        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_iban set iban_cleunik=$iban_cleunik,act_cleunik=$vl_e_act_cleunik_destination,iban_info=$iban_info,iban_papi=$iban_papi,iban_bic=$iban_bic,iban_pay=$iban_pay;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
        $iban_cleunik++;
        if($vf_c_echo!='ok') {$vf_c_retour.="9|$sql_req_ins|";}
      }
      _graal_libere_requete_bd($result);
			$sql_req="SELECT rib_cleunik,domiciliation,etablissement,guichet,compte,cle,dateheuremodif,blocnotebrut,blocnotertf,dateheurevalidite,act_cleunik,principal FROM _act_rib where act_cleunik=$vl_e_act_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
			$rib_cleunik=_graal_requete_max("rib_cleunik",$vl_base_destination."_act_rib");
      while ($row = mysql_fetch_assoc($result)){
				$domiciliation=fa_nt($row['domiciliation']);
				$etablissement=fa_nt($row['etablissement']);
				$guichet=fa_nt($row['guichet']);
				$compte=fa_nt($row['compte']);
				$cle=fa_nt($row['cle']);
				$dateheuremodif=fa_nt($row['dateheuremodif']);
				$blocnotebrut=fa_nt($row['blocnotebrut']);
				$blocnotertf=fa_nt($row['blocnotertf']);
				$dateheurevalidite=fa_nt($row['dateheurevalidite']);
				$principal=fa_nn($row['principal']);
        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_rib set rib_cleunik=$rib_cleunik,domiciliation=$domiciliation,etablissement=$etablissement,guichet=$guichet,compte=$compte,cle=$cle,dateheuremodif=$dateheuremodif,blocnotebrut=$blocnotebrut,blocnotertf=$blocnotertf,dateheurevalidite=$dateheurevalidite,act_cleunik=$vl_e_act_cleunik_destination,principal=$principal;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
				$rib_cleunik++;
        if($vf_c_echo!='ok') {$vf_c_retour.="10|$sql_req_ins|";}
      }
      _graal_libere_requete_bd($result);
			$sql_req="SELECT site_cleunik,refweb,dateheuremodif,blocnotebrut,blocnotertf,dateheurevalidite,act_cleunik,choix_cleunik FROM _act_sites where act_cleunik=$vl_e_act_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      $site_cleunik=_graal_requete_max("site_cleunik",$vl_base_destination."_act_sites");
      while ($row = mysql_fetch_assoc($result)){
				$refweb=fa_nt($row['refweb']);
				$dateheuremodif=fa_nt($row['dateheuremodif']);
				$blocnotebrut=fa_nt($row['blocnotebrut']);
				$blocnotertf=fa_nt($row['blocnotertf']);
				$dateheurevalidite=fa_nt($row['dateheurevalidite']);
				$choix_cleunik=fa_nn($row['choix_cleunik']);
        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_sites set site_cleunik=$site_cleunik,refweb=$refweb,dateheuremodif=$dateheuremodif,blocnotebrut=$blocnotebrut,blocnotertf=$blocnotertf,dateheurevalidite=$dateheurevalidite,act_cleunik=$vl_e_act_cleunik_destination,choix_cleunik=$choix_cleunik;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
				$site_cleunik++;
        if($vf_c_echo!='ok') {$vf_c_retour.="11|$sql_req_ins|";}
      }
      _graal_libere_requete_bd($result);
			$sql_req="SELECT int_cleunik,codealphanum15,act_cleunik,patronyme,blocnotebrut,prenom,blocnotertf,dateheuremodif,infodefaut,dateheurevalidite,choix_cleunik,actif,patronyme_autre FROM _act_interlo where act_cleunik=$vl_e_act_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
			$int_cleunik=_graal_requete_max("int_cleunik",$vl_base_destination."_act_interlo");
      while ($row = mysql_fetch_assoc($result)){
				$vl_e_int_cleunik_destination=$int_cleunik;
				$vl_e_int_cleunik_origine=$row['int_cleunik'];
				$codealphanum15=fa_nt($row['codealphanum15']);
				$patronyme=fa_nt($row['patronyme']);
				$blocnotebrut=fa_nt($row['blocnotebrut']);
				$blocnotertf=fa_nt($row['blocnotertf']);
				$prenom=fa_nt($row['prenom']);
				$dateheuremodif=fa_nt($row['dateheuremodif']);
				$infodefaut=fa_nn($row['infodefaut']);
				$dateheurevalidite=fa_nt($row['dateheurevalidite']);
				$patronyme_autre=fa_nt($row['patronyme_autre']);
				$actif=fa_nn($row['actif']);
				$choix_cleunik=fa_nn($row['choix_cleunik']);
        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo set int_cleunik=$vl_e_int_cleunik_destination,codealphanum15=$codealphanum15,act_cleunik=$vl_e_act_cleunik_destination,patronyme=$patronyme,blocnotebrut=$blocnotebrut,prenom=$prenom,blocnotertf=$blocnotertf,dateheuremodif=$dateheuremodif,infodefaut=$infodefaut,dateheurevalidite=$dateheurevalidite,choix_cleunik=$choix_cleunik,actif=$actif,patronyme_autre=$patronyme_autre;";
        $vf_c_echo=_graal_exec_requete_debug($sql_req_ins);
				$int_cleunik++;
        if($vf_c_echo!='ok') {
        	$vf_c_retour.="12|$sql_req_ins|";
				} else {
					$sql_req_01="SELECT adr_cleunik,adr_cod,act_cleunik,int_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,dateheuremodif,adr_latitude,adr_longitude,adr_typecoordonnees FROM _act_interlo_adresses where int_cleunik=$vl_e_int_cleunik_origine";
		      $result_01 = _graal_requete_bd($sql_req_01);
					$adr_cleunik=_graal_requete_max("adr_cleunik",$vl_base_destination."_act_interlo_adresses");
		      while ($row_01 = mysql_fetch_assoc($result_01)){
						$adr_cod=fa_nt($row_01['adr_cod']);
						$adr_complementnom=fa_nt($row_01['adr_complementnom']);
						$adr_ligne1=fa_nt($row_01['adr_ligne1']);
						$adr_ligne2=fa_nt($row_01['adr_ligne2']);
						$adr_ligne3=fa_nt($row_01['adr_ligne3']);
						$adr_cp=fa_nt($row_01['adr_cp']);
						$adr_ville=fa_nt($row_01['adr_ville']);
						$choix_cleunik=fa_nn($row_01['choix_cleunik']);
						$dateheuremodif=fa_nt($row_01['dateheuremodif']);
						$adr_latitude=fa_nn($row_01['adr_latitude']);
						$adr_longitude=fa_nn($row_01['adr_longitude']);
						$adr_typecoordonnees=fa_nn($row_01['adr_typecoordonnees']);
						$adr_type=fa_nn($row_01['adr_type']);
		        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_adresses set adr_cleunik=$adr_cleunik,adr_cod=$adr_cod,act_cleunik=$vl_e_act_cleunik_destination,int_cleunik=$vl_e_int_cleunik_destination,adr_complementnom=$adr_complementnom,adr_ligne1=$adr_ligne1,adr_ligne2=$adr_ligne2,adr_ligne3=$adr_ligne3,adr_cp=$adr_cp,adr_ville=$adr_ville,choix_cleunik=$choix_cleunik,dateheuremodif=$dateheuremodif,adr_latitude=$adr_latitude,adr_longitude=$adr_longitude,adr_typecoordonnees=$adr_typecoordonnees,adr_type=$vl_adr_type;";
		        $vf_c_echo=_graal_exec_requete($sql_req_ins);
						$adr_cleunik++;
		        if($vf_c_echo!='ok') {$vf_c_retour.="13|$sql_req_ins|";}
		      }
					_graal_libere_requete_bd($result_01);
					$sql_req = "INSERT INTO ".$vl_base_destination."_act_interlo_choix_fixes SELECT $vl_e_act_cleunik_destination,$vl_e_int_cleunik_destination,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik FROM _act_interlo_choix_fixes where int_cleunik=$vl_e_int_cleunik_origine";
      		$vf_c_echo=_graal_exec_requete($sql_req);
      		if($vf_c_echo!='ok') {$vf_c_retour.=$sql_req;}
					$sql_req_01="SELECT intel_cleunik,int_cleunik,telformate,dateheuremodif,blocnotertf,blocnotebrut,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik FROM _act_interlo_fax where int_cleunik=$vl_e_int_cleunik_origine";
		      $result_01 = _graal_requete_bd($sql_req_01);
	        $intel_cleunik=_graal_requete_max("intel_cleunik",$vl_base_destination."_act_interlo_fax");
		      while ($row_01 = mysql_fetch_assoc($result_01)){
						$telformate=fa_nt($row_01['telformate']);
						$dateheuremodif=fa_nt($row_01['dateheuremodif']);
						$blocnotertf=fa_nt($row_01['blocnotertf']);
						$blocnotebrut=fa_nt($row_01['blocnotebrut']);
						$intel_05=fa_nt($row_01['intel_05']);
						$intel_06=fa_nn($row_01['intel_06']);
						$infofavori=fa_nn($row_01['infofavori']);
						$choix_cleunik=fa_nn($row_01['choix_cleunik']);
						$prefixe_choix_cleunik=fa_nn($row_01['prefixe_choix_cleunik']);
		        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_fax set intel_cleunik=$intel_cleunik,int_cleunik=$vl_e_int_cleunik_destination,telformate=$telformate,dateheuremodif=$dateheuremodif,blocnotertf=$blocnotertf,blocnotebrut=$blocnotebrut,intel_05=$intel_05,intel_06=$intel_06,infofavori=$infofavori,act_cleunik=$vl_e_act_cleunik_destination,choix_cleunik=$choix_cleunik,prefixe_choix_cleunik=$prefixe_choix_cleunik ;";
		        $vf_c_echo=_graal_exec_requete($sql_req_ins);
						$intel_cleunik++;
		        if($vf_c_echo!='ok') {$vf_c_retour.="14|$sql_req_ins|";}
		      }
					_graal_libere_requete_bd($result_01);
					$sql_req_01="SELECT intel_cleunik,int_cleunik,telformate,dateheuremodif,blocnotertf,blocnotebrut,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik,portable,sms FROM _act_interlo_tel where int_cleunik=$vl_e_int_cleunik_origine";
		      $result_01 = _graal_requete_bd($sql_req_01);
					$intel_cleunik=_graal_requete_max("intel_cleunik",$vl_base_destination."_act_interlo_tel");
		      while ($row_01 = mysql_fetch_assoc($result_01)){
						$telformate=fa_nt($row_01['telformate']);
						$dateheuremodif=fa_nt($row_01['dateheuremodif']);
						$blocnotertf=fa_nt($row_01['blocnotertf']);
						$blocnotebrut=fa_nt($row_01['blocnotebrut']);
						$intel_05=fa_nt($row_01['intel_05']);
						$intel_06=fa_nn($row_01['intel_06']);
						$infofavori=fa_nn($row_01['infofavori']);
						$choix_cleunik=fa_nn($row_01['choix_cleunik']);
						$prefixe_choix_cleunik=fa_nn($row_01['prefixe_choix_cleunik']);
						$vl_portable=fa_nn($row_01['portable']);
						$vl_sms=fa_nn($row_01['sms']);
		        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_tel set intel_cleunik=$intel_cleunik,int_cleunik=$vl_e_int_cleunik_destination,telformate=$telformate,dateheuremodif=$dateheuremodif,blocnotertf=$blocnotertf,blocnotebrut=$blocnotebrut,intel_05=$intel_05,intel_06=$intel_06,infofavori=$infofavori,act_cleunik=$vl_e_act_cleunik_destination,choix_cleunik=$choix_cleunik,prefixe_choix_cleunik=$prefixe_choix_cleunik,portable=$vl_portable,sms=$vl_sms ;";
		        $vf_c_echo=_graal_exec_requete($sql_req_ins);
						$intel_cleunik++;
		        if($vf_c_echo!='ok') {$vf_c_retour.="15|$sql_req_ins|";}
		      }
					_graal_libere_requete_bd($result_01);
					$sql_req_01="SELECT intweb_cleunik,int_cleunik,refweb,dateheuremodif,blocnotebrut,blocnotertf,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid,dateheureverification,cr_verification FROM _act_interlo_mail where int_cleunik=$vl_e_int_cleunik_origine";
		      $result_01 = _graal_requete_bd($sql_req_01);
		      $intweb_cleunik=_graal_requete_max("intweb_cleunik",$vl_base_destination."_act_interlo_mail");
		      while ($row_01 = mysql_fetch_assoc($result_01)){
						$refweb=fa_nt($row_01['refweb']);
						$dateheuremodif=fa_nt($row_01['dateheuremodif']);
						$blocnotertf=fa_nt($row_01['blocnotertf']);
						$blocnotebrut=fa_nt($row_01['blocnotebrut']);
						$veuxpasdemail=fa_nn($row_01['veuxpasdemail']);
						$utilisable=fa_nn($row_01['utilisable']);
						$infofavori=fa_nn($row_01['infofavori']);
						$choix_cleunik=fa_nn($row_01['choix_cleunik']);
						$valide=fa_nn($row_01['valide']);
						$c_uuid=fa_nt($row_01['c_uuid']);
						$dateheureverification=fa_nt($row_01['dateheureverification']);
						$cr_verification=fa_nt($row_01['cr_verification']);
		        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_mail set intweb_cleunik=$intweb_cleunik,int_cleunik=$vl_e_int_cleunik_destination,refweb=$refweb,dateheuremodif=$dateheuremodif,blocnotebrut=$blocnotebrut,blocnotertf=$blocnotertf,veuxpasdemail=$veuxpasdemail,infofavori=$infofavori,utilisable=$utilisable,act_cleunik=$vl_e_act_cleunik_destination,choix_cleunik=$choix_cleunik,valide=$valide,c_uuid=$c_uuid,dateheureverification=$dateheureverification,cr_verification=$cr_verification;";
		        $vf_c_echo=_graal_exec_requete($sql_req_ins);
		        $intweb_cleunik++;
		        if($vf_c_echo!='ok') {$vf_c_retour.="16|$sql_req_ins|";}
		      }
					_graal_libere_requete_bd($result_01);
					$sql_req_01="SELECT mesinst_cleunik,int_cleunik,mesinst,dateheuremodif,blocnotebrut,blocnotertf,veuxpasdecontact,infofavori,utilisable,act_cleunik,choix_cleunik_type,choix_cleunik_prot,valide,c_uuid,dateheureverification,cr_verification FROM _act_interlo_mesinst where int_cleunik=$vl_e_int_cleunik_origine";
		      $result_01 = _graal_requete_bd($sql_req_01);
		      $mesinst_cleunik=_graal_requete_max("mesinst_cleunik",$vl_base_destination."_act_interlo_mesinst");
		      while ($row_01 = mysql_fetch_assoc($result_01)){
						$mesinst=fa_nt($row_01['mesinst']);
						$dateheuremodif=fa_nt($row_01['dateheuremodif']);
						$blocnotertf=fa_nt($row_01['blocnotertf']);
						$blocnotebrut=fa_nt($row_01['blocnotebrut']);
						$veuxpasdecontact=fa_nn($row_01['veuxpasdecontact']);
						$utilisable=fa_nn($row_01['utilisable']);
						$infofavori=fa_nn($row_01['infofavori']);
						$choix_cleunik_type=fa_nn($row_01['choix_cleunik_type']);
						$choix_cleunik_prot=fa_nn($row_01['choix_cleunik_prot']);
						$valide=fa_nn($row_01['valide']);
						$c_uuid=fa_nt($row_01['c_uuid']);
						$dateheureverification=fa_nt($row_01['dateheureverification']);
						$cr_verification=fa_nt($row_01['cr_verification']);
		        $sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_mesinst set mesinst_cleunik=$mesinst_cleunik,int_cleunik=$vl_e_int_cleunik_destination,mesinst=$mesinst,dateheuremodif=$dateheuremodif,blocnotebrut=$blocnotebrut,blocnotertf=$blocnotertf,veuxpasdecontact=$veuxpasdecontact,infofavori=$infofavori,utilisable=$utilisable,act_cleunik=$vl_e_act_cleunik_destination,choix_cleunik_type=$choix_cleunik_type,choix_cleunik_prot=$choix_cleunik_prot,valide=$valide,c_uuid=$c_uuid,dateheureverification=$dateheureverification,cr_verification=$cr_verification;";
		        $vf_c_echo=_graal_exec_requete($sql_req_ins);
		        $mesinst_cleunik++;
		        if($vf_c_echo!='ok') {$vf_c_retour.="17|$sql_req_ins|";}
		      }
					_graal_libere_requete_bd($result_01);
					$sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_relations SELECT $vl_e_int_cleunik_destination,choix_cleunik_gauche,choix_cleunik_droite,blocnotebrut,blocnoteriche,int_cleunik_droite FROM _act_interlo_relations where int_cleunik_gauche=$vl_e_int_cleunik_origine";
		      $vf_c_echo=_graal_exec_requete($sql_req_ins);
		      if($vf_c_echo!='ok') {$vf_c_retour.="18|$sql_req_ins|";}
					$sql_req_ins = "INSERT INTO ".$vl_base_destination."_act_interlo_relations SELECT int_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,blocnotebrut,blocnoteriche,$vl_e_int_cleunik_destination FROM _act_interlo_relations where int_cleunik_droite=$vl_e_int_cleunik_origine";
		      $vf_c_echo=_graal_exec_requete($sql_req_ins);
		      if($vf_c_echo!='ok') {$vf_c_retour.="19|$sql_req_ins|";}
				}
      }
      _graal_libere_requete_bd($result);
      $sql_req="update ".$vl_base_destination."_act_choix_fixes f1 left join ".$vl_base_destination."_acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.typeacteur=f2.typeacteur where f1.typeacteur<>f2.typeacteur;";
	$vf_c_echo=_graal_exec_requete($sql_req);
			$vf_c_retour.=pf_verif_portees($vl_portee);
      if (trim($vf_c_retour=="")) {
        $vf_c_echo=$vl_e_act_cleunik_destination."|";
        if ($vl_base_destination!=""){
        	$vf_c_echo.="pasouvre|";
        } else {
        	$vf_c_echo.="|";
        }
        //$vf_c_echo=$toto;
        _graal_requete_bd("COMMIT;");
      } else {
        $vf_c_echo="-1|$vf_c_retour|";
        _graal_requete_bd("ROLLBACK;");
      }
    } else {
    	$vf_c_echo=-1;
			$vf_c_echo=$vf_c_retour;
		}
    break;
	case $vf_c_action=='importer_0':
		/*
		 * Attention, au 22 février 2010, on ne sait pas encore comment gérer les listes blanches et les listes noires des acteurs
		 */
		set_time_limit(6000);
		$vl_t_listecles=fa_recup_param("vs_tempo_panier_lig_cleunik_import_acteurs",'');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$o_acteur=new _graal_import();
		$o_acteur->req="INSERT INTO _acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,siret,dateheurecreation,typeacteur,c_uuid,devise) VALUES ";
		$vl_e_i=-1;
		foreach($vl_t_listecles as $vl_raf) {
		  $vl_e_i++;
		  $vl_liste.=$vl_t_listecles[$vl_e_i].',';
		}
		$vf_c_ok="";
		if ($vl_liste!="") {
		  $vl_liste=substr($vl_liste, 0, -1);
			$deb_trans=_graal_requete_bd("START TRANSACTION;");
			$vf_e_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
			$devise=122047;
			$i=0;$i1=500;
			$sql_req = "select `imp_cleunik`,`lig_cleunik`,`codealphanum15`,`raisonsoc`,`nomcommercial`,`siret` FROM _w_import_acteurs_ligne_01 WHERE lig_cleunik IN($vl_liste)";
			$result = _graal_requete_bd($sql_req);
			while ($row = mysql_fetch_assoc($result)) {
			  $i++;
			  $vf_e_act_cleunik++;
			  $codealphanum15=fa_nt($row['codealphanum15']);
			  $raisonsoc=fa_nt($row['raisonsoc']);
			  $nomcommercial=fa_nt($row['nomcommercial']);
			  $siret=fa_nt($row['siret']);
			  $typeacteur=$vl_typeacteur;
			  $uuid=_graal_requete_uuid();
			  $o_acteur->dat.="($vf_e_act_cleunik,$codealphanum15,$raisonsoc,$nomcommercial,$siret,now(),$typeacteur,'$uuid',$devise),";
			  if ($i % $i1==0){
			    $vf_c_retour=$o_acteur->execute();
					if ($vf_c_retour!="ok") {$vf_c_ok=$vf_c_retour;}
			  }
			}
			$vf_c_retour=$o_acteur->execute();
			if ($vf_c_retour!="ok") {$vf_c_ok=$vf_c_retour;}
			_graal_libere_requete_bd($result);
			if (trim($vf_c_ok=="")) {
        $vf_c_echo=("$i acteurs créés.");
        _graal_requete_bd("COMMIT;");
      } else {
        $vf_c_echo=-1;
				$vf_c_echo=$vf_c_ok;
        _graal_requete_bd("ROLLBACK;");
      }
		}	else {
			$vf_c_echo="Liste vide !!!";
		}
    break;
	case $vf_c_action=='importer_02':
		/*
		 * Attention, au 22 février 2010, on ne sait pas encore comment gérer les listes blanches et les listes noires des acteurs
		 */
		set_time_limit(6000);
		/*
 		* Modèle 2 importation acteur 27 colonnes
 		*/

		$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
		$sep="\t";	//tab
		/*
		 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
		 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
		 */
		session_write_close();
		$erreur="";$data="";
		$sql_req="select f2.document,f2.doc_cleunik,f2.hash from _w_import_acteurs f1,_documents f2  where f1.imp_cleunik=$vl_e_imp_cleunik and f2.doc_cleunik=f1.doc_cleunik";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$doc_cleunik=$row['doc_cleunik'];
		if (fa_verif_droit($doc_cleunik)==false) {$erreur="Pas le droit d'accès à ce fichier";}
		$path="mail/".$row['hash'];
		$handle_file=fopen($path, 'wb');
		fwrite($handle_file, $row['document']);
		fclose($handle_file);
		_graal_libere_requete_bd($result);
		if ($erreur==""){
			if (!$handle_file = fopen($path, "r")) {
			  $erreur="Impossible d'ouvrir le fichier ($path)";
			} else {
				$vf_c_echo="";
				$noligne=0;
				/*
				 * On alimente un tableau des clés de critères
				 */
				$criteres_cle=array();
				$sql_req="select critere_cleunik from _criteres;"; //  On recherche les devises
				$result = _graal_requete_bd($sql_req);
				while ($row = mysql_fetch_assoc($result)) {
				  array_push ($criteres_cle, $row['critere_cleunik']);
				}
				_graal_libere_requete_bd($result);


		    while (($datacsv = fgetcsv($handle_file, 0, $sep)) !== FALSE) {
		      $num = count($datacsv);
		      $noligne++;
		      if ($noligne==1) {
		        if ($num>27) {
		          $erreur="Le nombre de colonnes ($num) est incorrect.";
		          break;
		        }
		      } else {
		      	/*
		      	 * On commence par vérifier la présence du nom commerciale ou de la raison sociale
		      	 */
						$cond01="";
						$codealphanum15=addslashes($datacsv[ 0]);
						$nomcommercial=addslashes($datacsv[ 1]);
						$raisonsoc=addslashes($datacsv[ 2]);
						if (trim($raisonsoc.$nomcommercial)!=""){
				      if (trim($raisonsoc)!="") {$cond01.=" and raisonsoc = '$raisonsoc'";}
				      if (trim($nomcommercial)!="") {$cond01.=" and nomcommercial = '$nomcommercial'";}
				      $sql_req="select count(*) as nombre from _acteurs where 1 $cond01;";
				      $result = _graal_requete_bd($sql_req);
				      $row = mysql_fetch_assoc($result);
							$nombre=$row['nombre'];
				      _graal_libere_requete_bd($result);
							if ($nombre==0){
								/*
								 * Insertion de l'acteur
								 */
								$vf_e_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
								$devise=122047;
							  $uuid=_graal_requete_uuid();
								$sql_req="INSERT INTO _acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,dateheurecreation,typeacteur,c_uuid,devise) VALUES ";
								$sql_req.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial',now(),$vl_typeacteur,'$uuid',$devise);";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}
								/*
								 * Insertion éventuelle de l'adresse postale
								 */
								$vl_adr_ligne1=addslashes($datacsv[ 3]);
								$vl_adr_ligne2=addslashes($datacsv[ 4]);
								$vl_adr_ligne3=addslashes($datacsv[ 5]);
								$vl_adr_cp=addslashes($datacsv[ 6]);
								$vl_adr_ville=addslashes($datacsv[ 7]);
								$vl_choix_cleunik_pays=addslashes($datacsv[ 8]);
								if (trim($vl_adr_ligne1.$vl_adr_ligne2.$vl_adr_ligne3.$vl_adr_cp.$vl_adr_ville.$vl_choix_cleunik_pays)!=""){
					        $vl_adr_cleunik=_graal_requete_max("adr_cleunik","_act_adresses");
									$sql_req = "INSERT INTO _act_adresses set adr_cleunik=$vl_adr_cleunik,act_cleunik=$vf_e_act_cleunik,adr_ligne1='$vl_adr_ligne1',adr_ligne2='$vl_adr_ligne2',adr_ligne3='$vl_adr_ligne3',adr_cp='$vl_adr_cp',adr_ville='$vl_adr_ville',choix_cleunik=$vl_choix_cleunik_pays,dateheuremodif=now(),adr_typecoordonnees=-3,adr_type=1;";
									$vf_c_echo=_graal_exec_requete($sql_req);
									if($vf_c_echo!='ok') {die($vf_c_echo);}
								}
								/*
								 * Insertion éventuelle des critères acteurs
								 */
								if ((trim($datacsv[18].$datacsv[19])!="")&&($datacsv[20]==1)){
									$critere_cleunik=addslashes($datacsv[18]);
									$choix_valeur_texte_01=addslashes($datacsv[19]);
									$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
									if ($vl_e_trouve_critere===false) {} else {
										$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,"");
										if ($vl_e_choix_cleunik!="NON"){
											$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
										}
									}
								}
								if ((trim($datacsv[21].$datacsv[22])!="")&&($datacsv[23]==1)){
									$critere_cleunik=addslashes($datacsv[21]);
									$choix_valeur_texte_01=addslashes($datacsv[22]);
									$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
									if ($vl_e_trouve_critere===false) {} else {
										$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,"");
										if ($vl_e_choix_cleunik!="NON"){
											$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
										}
									}
								}
								if ((trim($datacsv[24].$datacsv[25])!="")&&($datacsv[26]==1)){
									$critere_cleunik=addslashes($datacsv[24]);
									$choix_valeur_texte_01=addslashes($datacsv[25]);
									$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
									if ($vl_e_trouve_critere===false) {} else {
										$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,"");
										if ($vl_e_choix_cleunik!="NON"){
											$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
										}
									}
								}
								/*
								 * Insertion éventuelle de l'interlocuteur
								 */
								$vl_choix_cleunik=addslashes($datacsv[9]);
								$vl_prenom=addslashes($datacsv[10]);
								$vl_patronyme=addslashes($datacsv[11]);
								$vl_prefixe_choix_cleunik_tel=addslashes($datacsv[12]);
								$vl_telformate_tel=addslashes($datacsv[13]);
								$vl_prefixe_choix_cleunik_fax=addslashes($datacsv[14]);
								$vl_telformate_fax=addslashes($datacsv[15]);
								$vl_refweb=addslashes($datacsv[16]);
								$vl_fonction=addslashes($datacsv[17]);
			        	$vl_infodefaut=1;	//	Interlocuteur par défaut
								$vl_veuxpasdemail=3;$vl_infofavori=1;$vl_utilisable=3;$vl_valide=1;
								$vl_choix_cleunik_courriel=-11;	// 	adresse de courriel par défaut
								$vl_choix_cleunik_tel=-9;//	Téléphone par défaut
								$vl_choix_cleunik_fax=-10;//	Fax par défaut
								if (trim($vl_patronyme.$vl_prenom)!="") {
					        $vl_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
					        $sql_req = "INSERT INTO _act_interlo set int_cleunik=$vl_int_cleunik,act_cleunik=$vf_e_act_cleunik,patronyme='$vl_patronyme',prenom='$vl_prenom',dateheuremodif=now(),infodefaut=$vl_infodefaut,choix_cleunik=$vl_choix_cleunik;";
					        $vf_c_echo=_graal_exec_requete($sql_req);
					        if($vf_c_echo=='ok') {
					          $sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vl_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$vl_fonction,critere_cleunik=92,typeacteur=$vl_typeacteur,uti_cleunik=0;";
					          if(_graal_exec_requete($sql_req)!='ok') {$vf_c_echo=-1;}
					          if ($vl_refweb!="") {
					            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
					            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
										$vl_c_chaine_nette_tel=preg_replace($a, $b, $vl_telformate_tel);
					          if ($vl_telformate_tel!="") {
					            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_tel");
					            $sql_req = "INSERT INTO _act_interlo_tel set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_tel',dateheuremodif=now(),intel_05='$vl_c_chaine_nette_tel',intel_06=$vl_c_chaine_nette_tel,infofavori=1,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_tel,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_tel;";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
										$vl_c_chaine_nette_fax=preg_replace($a, $b, $vl_telformate_fax);
					          if ($vl_telformate_fax!="") {
					            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_fax");
					            $sql_req = "INSERT INTO _act_interlo_fax set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_fax',dateheuremodif=now(),intel_05='$vl_c_chaine_nette_fax',intel_06=$vl_c_chaine_nette_fax,infofavori=1,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_fax,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_fax;";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
										/*
										 * Ajout des éventuels critères des interlocuteurs
										 */
										if ((trim($datacsv[18].$datacsv[19])!="")&&($datacsv[20]==2)){
											$critere_cleunik=addslashes($datacsv[18]);
											$choix_valeur_texte_01=addslashes($datacsv[19]);
											$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
											if ($vl_e_trouve_critere===false) {} else {
												$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,"");
												if ($vl_e_choix_cleunik!="NON"){
													$sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vf_e_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
													$vf_c_echo=_graal_exec_requete($sql_req);
													if($vf_c_echo!='ok') {die($vf_c_echo);}
												}
											}
										}
										if ((trim($datacsv[21].$datacsv[22])!="")&&($datacsv[23]==2)){
											$critere_cleunik=addslashes($datacsv[21]);
											$choix_valeur_texte_01=addslashes($datacsv[22]);
											$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
											if ($vl_e_trouve_critere===false) {} else {
												$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,"");
												if ($vl_e_choix_cleunik!="NON"){
													$sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vf_e_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
													$vf_c_echo=_graal_exec_requete($sql_req);
													if($vf_c_echo!='ok') {die($vf_c_echo);}
												}
											}
										}
										if ((trim($datacsv[24].$datacsv[25])!="")&&($datacsv[26]==2)){
											$critere_cleunik=addslashes($datacsv[24]);
											$choix_valeur_texte_01=addslashes($datacsv[25]);
											$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
											if ($vl_e_trouve_critere===false) {} else {
												$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,"");
												if ($vl_e_choix_cleunik!="NON"){
													$sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vf_e_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
													$vf_c_echo=_graal_exec_requete($sql_req);
													if($vf_c_echo!='ok') {die($vf_c_echo);}
												}
											}
										}
					          $vf_c_echo=$vl_int_cleunik;
					        } else {
					          die($vf_c_echo);
					        }
								}
							}
			      }
			    }
				}
			  fclose($handle_file);
				unlink($path);
			}
		}
		if ($erreur!=""){
		  $vf_c_echo=(fa_ent_xml($erreur));
		} else {
			$vf_c_echo="ok";
		}
    break;
	case $vf_c_action=='importer_03':
		/*
		 * Attention, au 22 février 2010, on ne sait pas encore comment gérer les listes blanches et les listes noires des acteurs
		 */
		set_time_limit(6000);
		/*
 		* Modèle 3 importation acteur 31 colonnes
 		*/
		$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
		$sep="\t";	//tab
		/*
		 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
		 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
		 */
		session_write_close();
		$erreur="";$data="";
		$sql_req="select f2.document,f2.doc_cleunik,f2.hash from _w_import_acteurs f1,_documents f2  where f1.imp_cleunik=$vl_e_imp_cleunik and f2.doc_cleunik=f1.doc_cleunik";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$doc_cleunik=$row['doc_cleunik'];
		if (fa_verif_droit($doc_cleunik)==false) {$erreur="Pas le droit d'accès à ce fichier";}
		$path="mail/".$row['hash'];
		$handle_file=fopen($path, 'wb');
		fwrite($handle_file, $row['document']);
		fclose($handle_file);
		_graal_libere_requete_bd($result);
		if ($erreur==""){
			if (!$handle_file = fopen($path, "r")) {
			  die("Impossible d'ouvrir le fichier ($path)");
			} else {
				$vf_c_echo="";
				$noligne=0;
				/*
				 * On alimente un tableau des clés de critères
				 */
				$criteres_cle=array();
				$sql_req="select critere_cleunik from _criteres;"; //  On recherche les devises
				$result = _graal_requete_bd($sql_req);
				while ($row = mysql_fetch_assoc($result)) {
				  array_push ($criteres_cle, $row['critere_cleunik']);
				}
				_graal_libere_requete_bd($result);


		    while (($datacsv = fgetcsv($handle_file, 0, $sep)) !== FALSE) {
		      $num = count($datacsv);
		      $noligne++;
		      if ($noligne==1) {
		        if ($num>31) {
		          die("Le nombre de colonnes ($num) est incorrect (31 attendues).");
		          break;
		        }
		      } else {
		      	/*
		      	 * On commence par vérifier la présence du nom commerciale ou de la raison sociale
		      	 */
						$cond01="";
						$codealphanum15=addslashes($datacsv[ 0]);
						$nomcommercial=addslashes($datacsv[ 1]);
						$raisonsoc=addslashes($datacsv[ 2]);
						$vl_refweb=addslashes($datacsv[16]);
						if (trim($raisonsoc.$nomcommercial)!=""){
				      if (trim($raisonsoc)!="") {$cond01.=" and a1.raisonsoc = '$raisonsoc'";}
				      if (trim($nomcommercial)!="") {$cond01.=" and a1.nomcommercial = '$nomcommercial'";}
					  if (trim($vl_refweb)!="") {$cond01.=" and a2.refweb = '$vl_refweb'";}
				      $sql_req="select count(*) as nombre from _acteurs a1 left join _act_interlo_mail a2 using(act_cleunik) where 1 $cond01;";
				      $result = _graal_requete_bd($sql_req);
				      $row = mysql_fetch_assoc($result);
							$nombre=$row['nombre'];
				      _graal_libere_requete_bd($result);
							if ($nombre==0){
								/*
								 * Insertion de l'acteur
								 */
								$vf_e_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
								$devise=122047;
							  $uuid=_graal_requete_uuid();
								$sql_req="INSERT INTO _acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,dateheurecreation,typeacteur,c_uuid,devise) VALUES ";
								$sql_req.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial',now(),$vl_typeacteur,'$uuid',$devise);";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}

								echo ("Ligne ".$noligne." Ajout ".date("d-m-Y")." ".date("H:i:s")." $vf_e_act_cleunik $raisonsoc $nomcommercial");
								echo EOL;
								/*
								 * Insertion éventuelle de l'adresse postale
								 */
								$vl_adr_ligne1=addslashes($datacsv[ 3]);
								$vl_adr_ligne2=addslashes($datacsv[ 4]);
								$vl_adr_ligne3=addslashes($datacsv[ 5]);
								$vl_adr_cp=addslashes($datacsv[ 6]);
								$vl_adr_ville=addslashes($datacsv[ 7]);
								$vl_choix_cleunik_pays=addslashes($datacsv[ 8]);
								if (trim($vl_adr_ligne1.$vl_adr_ligne2.$vl_adr_ligne3.$vl_adr_cp.$vl_adr_ville.$vl_choix_cleunik_pays)!=""){
					        $vl_adr_cleunik=_graal_requete_max("adr_cleunik","_act_adresses");
									$sql_req = "INSERT INTO _act_adresses set adr_cleunik=$vl_adr_cleunik,act_cleunik=$vf_e_act_cleunik,adr_ligne1='$vl_adr_ligne1',adr_ligne2='$vl_adr_ligne2',adr_ligne3='$vl_adr_ligne3',adr_cp='$vl_adr_cp',adr_ville='$vl_adr_ville',choix_cleunik=$vl_choix_cleunik_pays,dateheuremodif=now(),adr_typecoordonnees=-3,adr_type=1;";
									$vf_c_echo=_graal_exec_requete($sql_req);
									if($vf_c_echo!='ok') {die($vf_c_echo);}
								}
								/*
								 * Insertion éventuelle des critères acteurs
								 */
								if ((trim($datacsv[18].$datacsv[19].$datacsv[20])!="")&&($datacsv[21]==1)){
									$critere_cleunik=addslashes($datacsv[18]);
									$choix_code=addslashes($datacsv[19]);
									$choix_valeur_texte_01=addslashes($datacsv[20]);
									if (trim($choix_code.$choix_valeur_texte_01)=="") {
										$vl_e_trouve_critere=false;
									} else {
										$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
									}
									if ($vl_e_trouve_critere===false) {} else {
										$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
										if ($vl_e_choix_cleunik!="NON"){
											$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
										}
									}
								}
								if ((trim($datacsv[22].$datacsv[23].$datacsv[24])!="")&&($datacsv[25]==1)){
									$critere_cleunik=addslashes($datacsv[22]);
									$choix_code=addslashes($datacsv[23]);
									$choix_valeur_texte_01=addslashes($datacsv[24]);
									if (trim($choix_code.$choix_valeur_texte_01)=="") {
										$vl_e_trouve_critere=false;
									} else {
										$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
									}
									if ($vl_e_trouve_critere===false) {} else {
										$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
										if ($vl_e_choix_cleunik!="NON"){
											$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
										}
									}
								}
								if ((trim($datacsv[26].$datacsv[27].$datacsv[28])!="")&&($datacsv[29]==1)){
									$critere_cleunik=addslashes($datacsv[26]);
									$choix_code=addslashes($datacsv[27]);
									$choix_valeur_texte_01=addslashes($datacsv[28]);
									if (trim($choix_code.$choix_valeur_texte_01)=="") {
										$vl_e_trouve_critere=false;
									} else {
										$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
									}
									if ($vl_e_trouve_critere===false) {} else {
										$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
										if ($vl_e_choix_cleunik!="NON"){
											$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
										}
									}
								}
								/*
								 * Insertion éventuelle de l'interlocuteur
								 */
								$vl_choix_cleunik=addslashes($datacsv[9]);
								$vl_prenom=addslashes($datacsv[10]);
								$vl_patronyme=addslashes($datacsv[11]);
								$vl_prefixe_choix_cleunik_tel=addslashes($datacsv[12]);
								$vl_telformate_tel=addslashes($datacsv[13]);
								$vl_prefixe_choix_cleunik_fax=addslashes($datacsv[14]);
								$vl_telformate_fax=addslashes($datacsv[15]);
								$vl_refweb=addslashes($datacsv[16]);
								$vl_refweb_01=addslashes($datacsv[30]);
								$vl_fonction=addslashes($datacsv[17]);
			        	$vl_infodefaut=1;	//	Interlocuteur par défaut
								$vl_veuxpasdemail=3;$vl_infofavori=1;$vl_utilisable=3;$vl_valide=1;
								$vl_choix_cleunik_courriel=-11;	// 	adresse de courriel par défaut
								$vl_choix_cleunik_tel=-9;//	Téléphone par défaut
								$vl_choix_cleunik_fax=-10;//	Fax par défaut
								if (trim($vl_patronyme.$vl_prenom)!="") {
					        $vl_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
					        $sql_req = "INSERT INTO _act_interlo set int_cleunik=$vl_int_cleunik,act_cleunik=$vf_e_act_cleunik,patronyme='$vl_patronyme',prenom='$vl_prenom',dateheuremodif=now(),infodefaut=$vl_infodefaut,choix_cleunik=$vl_choix_cleunik;";
					        $vf_c_echo=_graal_exec_requete($sql_req);
					        if($vf_c_echo=='ok') {
					          $sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vl_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$vl_fonction,critere_cleunik=92,typeacteur=$vl_typeacteur,uti_cleunik=0;";
					          if(_graal_exec_requete($sql_req)!='ok') {$vf_c_echo=-1;}
					          if ($vl_refweb!="") {
					            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
					            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
							if ($vl_refweb_01!="") {
					            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
					            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb_01',dateheuremodif=now(),veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
										$vl_c_chaine_nette_tel=preg_replace($a, $b, $vl_telformate_tel);
					          if ($vl_telformate_tel!="") {
					            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_tel");
					            $sql_req = "INSERT INTO _act_interlo_tel set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_tel',dateheuremodif=now(),intel_05='$vl_c_chaine_nette_tel',intel_06=$vl_c_chaine_nette_tel,infofavori=1,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_tel,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_tel;";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
										$vl_c_chaine_nette_fax=preg_replace($a, $b, $vl_telformate_fax);
					          if ($vl_telformate_fax!="") {
					            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_fax");
					            $sql_req = "INSERT INTO _act_interlo_fax set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_fax',dateheuremodif=now(),intel_05='$vl_c_chaine_nette_fax',intel_06=$vl_c_chaine_nette_fax,infofavori=1,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_fax,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_fax;";
											$vf_c_echo=_graal_exec_requete($sql_req);
											if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
										/*
										 * Ajout des éventuels critères des interlocuteurs
										 */
										if ((trim($datacsv[18].$datacsv[19].$datacsv[20])!="")&&($datacsv[21]==2)){
											$critere_cleunik=addslashes($datacsv[18]);
											$choix_code=addslashes($datacsv[19]);
											$choix_valeur_texte_01=addslashes($datacsv[20]);
											if (trim($choix_code.$choix_valeur_texte_01)=="") {
												$vl_e_trouve_critere=false;
											} else {
												$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
											}
											if ($vl_e_trouve_critere===false) {} else {
												$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
												if ($vl_e_choix_cleunik!="NON"){
													$sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vf_e_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
													$vf_c_echo=_graal_exec_requete($sql_req);
													if($vf_c_echo!='ok') {die($vf_c_echo);}
												}
											}
										}
										if ((trim($datacsv[22].$datacsv[23].$datacsv[24])!="")&&($datacsv[25]==2)){
											$critere_cleunik=addslashes($datacsv[22]);
											$choix_code=addslashes($datacsv[23]);
											$choix_valeur_texte_01=addslashes($datacsv[24]);
											if (trim($choix_code.$choix_valeur_texte_01)=="") {
												$vl_e_trouve_critere=false;
											} else {
												$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
											}
											if ($vl_e_trouve_critere===false) {} else {
												$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
												if ($vl_e_choix_cleunik!="NON"){
													$sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vf_e_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
													$vf_c_echo=_graal_exec_requete($sql_req);
													if($vf_c_echo!='ok') {die($vf_c_echo);}
												}
											}
										}
										if ((trim($datacsv[26].$datacsv[27].$datacsv[28])!="")&&($datacsv[29]==2)){
											$critere_cleunik=addslashes($datacsv[26]);
											$choix_code=addslashes($datacsv[27]);
											$choix_valeur_texte_01=addslashes($datacsv[28]);
											if (trim($choix_code.$choix_valeur_texte_01)=="") {
												$vl_e_trouve_critere=false;
											} else {
												$vl_e_trouve_critere=array_search($critere_cleunik, $criteres_cle);
											}
											if ($vl_e_trouve_critere===false) {} else {
												$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
												if ($vl_e_choix_cleunik!="NON"){
													$sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vf_e_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
													$vf_c_echo=_graal_exec_requete($sql_req);
													if($vf_c_echo!='ok') {die($vf_c_echo);}
												}
											}
										}
					          $vf_c_echo=$vl_int_cleunik;
					        } else {
					          die($vf_c_echo);
					        }
								}
							} else {
								echo ("Ligne ".$noligne." Déjà présent ".date("d-m-Y")." ".date("H:i:s")." $vf_e_act_cleunik $raisonsoc $nomcommercial");
								echo EOL;

							}
			      }
			    }
				}
			  fclose($handle_file);
				unlink($path);
			}
		}
		if ($erreur!=""){
		  $vf_c_echo=(fa_ent_xml($erreur));
		} else {
			$vf_c_echo="ok";
		}
    break;


    	case $vf_c_action=='importer_04':
		/*
		 * Attention, au 5 juin 2010, on ne sait pas encore comment gérer les listes blanches et les listes noires des acteurs
		 */
		set_time_limit(6000);
		/*
 		* Modèle 4 importation acteur 11 colonnes
 		*/
		$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
		$vl_choix_origine=intval(fa_recup_param('choix_origine','0'));
		$vl_critere_origine=intval(fa_recup_param('critere_origine','0'));
		$sep=";";	//tab
		/*
		 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
		 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
		 */

		session_write_close();
		_graal_requete_bd("SET SESSION wait_timeout = 200;");

		header('Content-type: text/html; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
define('EOL', "<br>");
echo <<<EOT
<script language="JavaScript">
function pf_descendre_bas_de_page(){
	var vl_c_hauteur=document.body.offsetHeight;
        window.scrollTo(0,vl_c_hauteur);
        setTimeout("pf_descendre_bas_de_page()",15000);
    }
    setTimeout("pf_descendre_bas_de_page()",15000);
</script>
EOT;




		$erreur="";$data="";
		$sql_req="select f2.document,f2.doc_cleunik,f2.hash from _w_import_acteurs f1,_documents f2  where f1.imp_cleunik=$vl_e_imp_cleunik and f2.doc_cleunik=f1.doc_cleunik";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$doc_cleunik=$row['doc_cleunik'];
		if (fa_verif_droit($doc_cleunik)==false) {$erreur="Pas le droit d'accès à ce fichier";}
		$path="mail/".$row['hash'];
		$handle_file=fopen($path, 'wb');
		fwrite($handle_file, $row['document']);
		fclose($handle_file);
		_graal_libere_requete_bd($result);
		if ($erreur==""){
			if (!$handle_file = fopen($path, "r")) {
			  die("Impossible d'ouvrir le fichier ($path)");
			} else {
				$vf_c_echo="";
				$noligne=0;
				/*
				 * On alimente un tableau des clés de critères
				 */
				$criteres_cle=array();$criteres_denomination=array();

				$sql_req="select critere_cleunik,critere_denomination from _criteres;"; //  On recherche les devises
				$result = _graal_requete_bd($sql_req);
				while ($row = mysql_fetch_assoc($result)) {
				  array_push ($criteres_cle, $row['critere_cleunik']);
				  array_push ($criteres_denomination, $row['critere_denomination']);
				}
				_graal_libere_requete_bd($result);


		    while (($datacsv = fgetcsv($handle_file, 0, $sep)) !== FALSE) {
		      $num = count($datacsv);
		      $noligne++;
		      if ($noligne==1) {
		        if ($num>11) {
		          die("Le nombre de colonnes ($num) est incorrect (11 attendues).");
		          break;
		        }
		        $denomination_col_10=addslashes(ff_decode($datacsv[10]));
		        $vl_e_trouve_critere=array_search($denomination_col_10, $criteres_denomination);
		        if ($vl_e_trouve_critere===false) {
		        	$critere_cleunik_col_10=-1;
		        } else {
					$critere_cleunik_col_10=$criteres_cle[$vl_e_trouve_critere];
		        }
		      } else {
		      	/*
		      	 * On commence par vérifier la présence du nom commerciale ou de la raison sociale
		      	 */
						$cond01="";
						$codealphanum15="";
						$nomcommercial=addslashes(ff_decode($datacsv[ 0]));
						$raisonsoc=addslashes(ff_decode($datacsv[ 0]));
						$vl_refweb=addslashes(ff_decode($datacsv[7]));
						if (trim($raisonsoc.$nomcommercial)!=""){
				      if (trim($raisonsoc)!="") {$cond01.=" and a1.raisonsoc = '$raisonsoc'";}
				      if (trim($nomcommercial)!="") {$cond01.=" and a1.nomcommercial = '$nomcommercial'";}
					  if (trim($vl_refweb)!="") {$cond01.=" and a2.refweb = '$vl_refweb'";}
				      $sql_req="select count(*) as nombre from _acteurs a1 left join _act_interlo_mail a2 using(act_cleunik) where 1 $cond01;";
				      $result = _graal_requete_bd($sql_req);
				      $row = mysql_fetch_assoc($result);
							$nombre=$row['nombre'];
				      _graal_libere_requete_bd($result);
							if ($nombre==0){
								/*
								 * Insertion de l'acteur
								 */
								$vf_e_act_cleunik=_graal_requete_max("act_cleunik","_acteurs");
								$devise=122047;
							  $uuid=_graal_requete_uuid();
								$sql_req="INSERT INTO _acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,dateheurecreation,typeacteur,c_uuid,devise) VALUES ";
								$sql_req.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial',now(),$vl_typeacteur,'$uuid',$devise);";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}

								echo ("Ligne ".$noligne." Ajout ".date("d-m-Y")." ".date("H:i:s")." $vf_e_act_cleunik $raisonsoc $nomcommercial");
								echo EOL;flush();
								/*
								 * Insertion éventuelle de l'adresse postale
								 */
								$vl_adr_ligne1=addslashes(substr(ff_decode($datacsv[ 2]), 0,49));
								$vl_adr_ligne2=addslashes(substr(ff_decode($datacsv[ 2]),50,99));
								$vl_adr_ligne3="";
								$vl_adr_cp=addslashes(ff_decode($datacsv[ 3]));
								$vl_adr_ville=addslashes(ff_decode($datacsv[ 4]));
								$vl_choix_cleunik_pays=60000;	//	France par défaut
								if (trim($vl_adr_ligne1.$vl_adr_ligne2.$vl_adr_ligne3.$vl_adr_cp.$vl_adr_ville.$vl_choix_cleunik_pays)!=""){
					        $vl_adr_cleunik=_graal_requete_max("adr_cleunik","_act_adresses");
									$sql_req = "INSERT INTO _act_adresses set adr_cleunik=$vl_adr_cleunik,act_cleunik=$vf_e_act_cleunik,adr_ligne1='$vl_adr_ligne1',adr_ligne2='$vl_adr_ligne2',adr_ligne3='$vl_adr_ligne3',adr_cp='$vl_adr_cp',adr_ville='$vl_adr_ville',choix_cleunik=$vl_choix_cleunik_pays,dateheuremodif=now(),adr_typecoordonnees=-3,adr_type=1;";
									$vf_c_echo=_graal_exec_requete($sql_req);
									if($vf_c_echo!='ok') {die($vf_c_echo);}
								}
								/*
								 * Insertion éventuelle des critères acteurs
								 */
								if ((trim(ff_decode($datacsv[10]))!="")&&($critere_cleunik_col_10!=-1)){
									$critere_cleunik=$critere_cleunik_col_10;
									$choix_code="";
									$choix_valeur_texte_01=addslashes(ff_decode($datacsv[10]));
									$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
									if ($vl_e_choix_cleunik!="NON"){
										$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
										$vf_c_echo=_graal_exec_requete($sql_req);
										if($vf_c_echo!='ok') {die($vf_c_echo);}
									}
								}
								/*
								 * Insertion origine importation
								 */
								$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_origine,critere_cleunik=$vl_critere_origine,typeacteur=$vl_typeacteur,uti_cleunik=0";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}


								/*
								 * Insertion naf
								 */
								$choix_code=addslashes(ff_decode($datacsv[8]));
								if (strlen($choix_code)==4){
									/*
									 * ancienne codification, on rajoute un point pour notre gestion
									 *
									 */
									$choix_code=substr($choix_code,0,2).".".substr($choix_code,2,2);
									$critere_cleunik=25;
								} else {
									$critere_cleunik=75;
								}
								$choix_valeur_texte_01="";
								$choix_cleunik=pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code);
								if ($vl_e_choix_cleunik!="NON"){
									$sql_req = "insert into _act_choix_fixes set act_cleunik=$vf_e_act_cleunik,choix_cleunik=$choix_cleunik,critere_cleunik=$critere_cleunik,typeacteur=$vl_typeacteur,uti_cleunik=0";
									$vf_c_echo=_graal_exec_requete($sql_req);
									if($vf_c_echo!='ok') {die($vf_c_echo);}
								}
								/*
								 * Insertion éventuelle de l'interlocuteur
								 */
								$vl_choix_cleunik=-6;
								$vl_prenom="";
								$vl_patronyme=addslashes(ff_decode($datacsv[1]));
								$vl_prefixe_choix_cleunik_tel=121111;
								$vl_telformate_tel=addslashes(ff_decode($datacsv[5]));
								$vl_prefixe_choix_cleunik_fax=121111;
								$vl_telformate_fax=addslashes(ff_decode($datacsv[6]));
								$vl_refweb=addslashes(ff_decode($datacsv[7]));
								$vl_fonction=-7;
			        			$vl_infodefaut=1;	//	Interlocuteur par défaut
								$vl_veuxpasdemail=3;$vl_infofavori=1;$vl_utilisable=3;$vl_valide=1;
								$vl_choix_cleunik_courriel=-11;	// 	adresse de courriel par défaut
								$vl_choix_cleunik_tel=-9;//	Téléphone par défaut
								$vl_choix_cleunik_fax=-10;//	Fax par défaut
								if (trim($vl_patronyme.$vl_prenom)!="") {
					        $vl_int_cleunik=_graal_requete_max("int_cleunik","_act_interlo");
					        $sql_req = "INSERT INTO _act_interlo set int_cleunik=$vl_int_cleunik,act_cleunik=$vf_e_act_cleunik,patronyme='$vl_patronyme',prenom='$vl_prenom',dateheuremodif=now(),infodefaut=$vl_infodefaut,choix_cleunik=$vl_choix_cleunik;";
					        $vf_c_echo=_graal_exec_requete($sql_req);
					        if($vf_c_echo=='ok') {
					          $sql_req = "insert into _act_interlo_choix_fixes set act_cleunik=$vl_act_cleunik,int_cleunik=$vl_int_cleunik,choix_cleunik=$vl_fonction,critere_cleunik=92,typeacteur=$vl_typeacteur,uti_cleunik=0;";
					          if(_graal_exec_requete($sql_req)!='ok') {$vf_c_echo=-1;}
					          if ($vl_refweb!="") {
					            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
					            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
							if ($vl_refweb_01!="") {
					            $vl_intweb_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
					            $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_intweb_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb_01',dateheuremodif=now(),veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_courriel,valide=$vl_valide,c_uuid=(select uuid());";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
								$vl_c_chaine_nette_tel=preg_replace($a, $b, $vl_telformate_tel);
					          if ($vl_telformate_tel!="") {
					            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_tel");
					            $sql_req = "INSERT INTO _act_interlo_tel set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_tel',dateheuremodif=now(),intel_05='$vl_c_chaine_nette_tel',intel_06=$vl_c_chaine_nette_tel,infofavori=1,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_tel,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_tel;";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
								$vl_c_chaine_nette_fax=preg_replace($a, $b, $vl_telformate_fax);
					          if ($vl_telformate_fax!="") {
					            $vl_intel_cleunik=_graal_requete_max("intel_cleunik","_act_interlo_fax");
					            $sql_req = "INSERT INTO _act_interlo_fax set intel_cleunik=$vl_intel_cleunik,int_cleunik=$vl_int_cleunik,telformate='$vl_telformate_fax',dateheuremodif=now(),intel_05='$vl_c_chaine_nette_fax',intel_06=$vl_c_chaine_nette_fax,infofavori=1,act_cleunik=$vf_e_act_cleunik,choix_cleunik=$vl_choix_cleunik_fax,prefixe_choix_cleunik=$vl_prefixe_choix_cleunik_fax;";
								$vf_c_echo=_graal_exec_requete($sql_req);
								if($vf_c_echo!='ok') {die($vf_c_echo);}
					          }
					          $vf_c_echo=$vl_int_cleunik;
					        } else {
					          die($vf_c_echo);
					        }
								}
							} else {
								echo ("Ligne ".$noligne." Déjà présent ".date("d-m-Y")." ".date("H:i:s")." $vf_e_act_cleunik $raisonsoc $nomcommercial");
								echo EOL;flush();

							}
			      }
			    }
				}
			  fclose($handle_file);
				unlink($path);
			}
		}
		if ($erreur!=""){
		  $vf_c_echo=(fa_ent_xml($erreur));
		} else {
			$vf_c_echo="ok";
		}
    break;








  case $vf_c_action=='??????':
    exit;
    break;
}
_graal_ferme_connexion();
echo ($vf_c_echo);
function ff_decode($item){
	if ($item =="" ){return $item;}
	$sCharset = 'UTF-8';
	$item = mb_convert_encoding($item, $sCharset);
	/*
    	if ($sEncoding = mb_detect_encoding($item, 'auto', true) != $sCharset) {
    		if ($sEncoding == NULL) {
				return $item."-".$sEncoding;
    		} else {
    			$item = mb_convert_encoding($item, $sCharset, $sEncoding)."-".$sEncoding;
    		}
    	}
    	*/
        return $item;
}

function pf_cherche_choix_cleunik($critere_cleunik,$choix_valeur_texte_01,$choix_code){
	if ($critere_cleunik==25){
		if (strlen($choix_code)==4){
			// particularité des anciens codes NAF sous la forme 12.3A
			$old_naf=substr($choix_code, 0, 2).".". substr($choix_code, 2, 2);
			$choix_code=$old_naf;
		}
	}
	/*
	if ($critere_cleunik==75){
		if (strlen($choix_code)==5){
			// particularité des codes NAF sous la forme 12.34A
			$old_naf=substr($choix_code, 0, 2).".". substr($choix_code, 2, 3);
			$choix_code=$old_naf;
		}
	}
	*/
	if (trim($choix_code)==""){
		$sql_req="select choix_cleunik from _choix where critere_cleunik=$critere_cleunik and choix_valeur_texte_01='$choix_valeur_texte_01';"; //  On recherche sur la valeur
		$result = _graal_requete_bd($sql_req);
		if (mysql_num_rows($result) == 0) {
			/*
			 * On crée le choix (uniquement la valeur)
			 */
			_graal_libere_requete_bd($result);
			if (($vl_e_critere_cleunik==21)||($vl_e_critere_cleunik==22)||
				($vl_e_critere_cleunik==23)||($vl_e_critere_cleunik==24)||($vl_e_critere_cleunik==25)||($vl_e_critere_cleunik==71)||($vl_e_critere_cleunik==72)||($vl_e_critere_cleunik==73)||
				($vl_e_critere_cleunik==74)||($vl_e_critere_cleunik==75)) {
				$vl_e_choix_cleunik="NON";
			} else {
				$vl_e_choix_cleunik=_graal_requete_max("choix_cleunik","_choix");
		    	$sql_req = "INSERT INTO _choix set choix_cleunik=$vl_e_choix_cleunik,critere_cleunik=$critere_cleunik,choix_valeur_texte_01='$choix_valeur_texte_01',choix_actif=1";
			    $vf_c_echo=_graal_exec_requete($sql_req);
			}
		} else {
			$row = mysql_fetch_assoc($result);
			$vl_e_choix_cleunik=$row['choix_cleunik'];
			_graal_libere_requete_bd($result);
		}
	} else {
		$sql_req="select choix_cleunik from _choix where critere_cleunik=$critere_cleunik and choix_code='$choix_code';"; //  On recherche sur le code
		$result = _graal_requete_bd($sql_req);
		if (mysql_num_rows($result) == 0) {
			_graal_libere_requete_bd($result);
			$sql_req="select choix_cleunik from _choix where critere_cleunik=$critere_cleunik and choix_code='$choix_code' and choix_valeur_texte_01='$choix_valeur_texte_01';"; //  On recherche les couleurs
			$result = _graal_requete_bd($sql_req);
			if (mysql_num_rows($result) == 0) {
				/*
			 * On crée le choix (code et valeur)
			 */
				_graal_libere_requete_bd($result);
				if (($vl_e_critere_cleunik==21)||($vl_e_critere_cleunik==22)||
					($vl_e_critere_cleunik==23)||($vl_e_critere_cleunik==24)||($vl_e_critere_cleunik==25)||($vl_e_critere_cleunik==71)||($vl_e_critere_cleunik==72)||($vl_e_critere_cleunik==73)||
					($vl_e_critere_cleunik==74)||($vl_e_critere_cleunik==75)) {
					$vl_e_choix_cleunik="NON";
				} else {
					$vl_e_choix_cleunik=_graal_requete_max("choix_cleunik","_choix");
			    	$sql_req = "INSERT INTO _choix set choix_cleunik=$vl_e_choix_cleunik,critere_cleunik=$critere_cleunik,choix_code='$choix_code',choix_valeur_texte_01='$choix_valeur_texte_01',choix_actif=1";
				    $vf_c_echo=_graal_exec_requete($sql_req);
				}
			} else {
				$row = mysql_fetch_assoc($result);
				$vl_e_choix_cleunik=$row['choix_cleunik'];
				_graal_libere_requete_bd($result);
			}
		} else {
			$row = mysql_fetch_assoc($result);
			$vl_e_choix_cleunik=$row['choix_cleunik'];
			_graal_libere_requete_bd($result);
		}
	}
	return $vl_e_choix_cleunik;
}
function pf_ajoute_compta($vl_act_cleunik,$vl_typeacteur){
	$sql_req = "insert into _act_compta SELECT  f1.act_cleunik,f3.compte,'',f3.catcompta_cleunik,f3.encours_autorise,f3.tarif_cleunik,f3.remise_taux,";
    $sql_req.= " f3.remise_type,f3.remise_genr,f3.escompte_taux,f3.escompte_type,f3.remise_natu,f3.reg_cleunik,f3.pc_cleunik,f3.assujetti_tpf,f3.montant_port,f3.seuil_franco,f3.commande_mini";
	$sql_req.= " FROM _act_compta f3,_acteurs f1 left join _act_compta f2 on f1.act_cleunik=f2.act_cleunik  ";
	$sql_req.= " where f3.act_cleunik=0 and f1.typeacteur=$vl_typeacteur and f2.act_cleunik is null and f1.act_cleunik in($vl_act_cleunik);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
	$vf_c_echo=$vl_act_cleunik;
	return $vf_c_echo;
}
function pf_ajoute_listes($vl_act_cleunik){
	global $vl_e_uti_cleunik;
	$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
	if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
	switch ($vs_gesacteurs_ml_zone){
		case '1':	//	Accès libre
			break;
		case '4':	//	Accès sur liste blanche
			$sql_req = "INSERT INTO _acteurs_blanc (act_cleunik,uti_cleunik) VALUES ($vl_act_cleunik,$vl_e_uti_cleunik)";
			$vf_c_echo=_graal_exec_requete($sql_req);
			break;
	}
	$sql_req = "SELECT uti_cleunik,param_environ as param_environ from _utilisateur where actif=1;";
	$result = _graal_requete_bd($sql_req);
	while ($row = mysql_fetch_assoc($result)) {
		$vl_e_uti_cleunik_noire=$row['uti_cleunik'];
		$gesacteurs_ml_zone=1;
		if (is_null($row['param_environ'])==false) {
			$vl_c_xml=simplexml_load_string($row['param_environ']);
			if (isset($vl_c_xml->gesacteurs_ml_zone)){$gesacteurs_ml_zone=$vl_c_xml->gesacteurs_ml_zone->attributes();}else{$gesacteurs_ml_zone='1';}
		}
		if ($gesacteurs_ml_zone==3){
			$sql_req_noire = "INSERT INTO _acteurs_noire (act_cleunik,uti_cleunik) VALUES ($vl_act_cleunik,$vl_e_uti_cleunik_noire)";
			$vf_c_echo=_graal_exec_requete($sql_req_noire);
		}
	}
	_graal_libere_requete_bd($result);
}
function pf_verif_portees($vl_portee){
	global $vl_act_cleunik;
	/*
	 * Vérification des portées
		_acteurs_favoris "Acteurs favoris par utilisateur" rien à vérifier
		_acteurs_relations "Relations entre acteurs" choix_cleunik_gauche et choix_cleunik_droite
		_acteurs_representants "Représentants des acteurs" choix_cleunik_gauche et choix_cleunik_droite
		_act_adresses "Adresses des acteurs" vérifier adr_typecoordonnees
		_act_choix_fixes "Choix fixes des acteurs" critere_cleunik
		_act_compta "Informations comptable des acteurs" rien
		_act_iban "I.B.A.N des acteurs" rien
		_act_interlo "Interlocuteurs dacteur" choix_cleunik
		_act_interlo_adresses "Adresses des interlocuteurs d'acteurs (entreprise seulement" adr_typecoordonnees
		_act_interlo_choix_fixes "Choix fixes des interlocuteurs dacteurs" critere_cleunik
		_act_interlo_fax "Fax des interlocuteurs dacteurs" choix_cleunik
		_act_interlo_mail "Courriels des interlocuteurs des acteurs" choix_cleunik
		_act_interlo_mesinst "Messageries instantanée des interlocuteurs des acteurs" choix_cleunik_type choix_cleunik_prot
		_act_interlo_relations "Relations entre interlocuteurs d'acteurs" choix_cleunik_gauche et choix_cleunik_droite !!! Pas controlable (26/11/2008)
		_act_interlo_tel "Ressources "phones" des interlocuteurs des acteurs" choix_cleunik
		_act_rib "RIB des acteurs" rien
		_act_sites "Sites web ds acteurs" choix_cleunik
	*/
	//	_acteurs_relations
	$sql_req = "update _acteurs_relations f2 left join _choix f1 on f2.choix_cleunik_gauche = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_gauche=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _acteurs_relations f2 left join _choix f1 on f2.choix_cleunik_gauche = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_droite=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _acteurs_relations f2 left join _choix f1 on f2.choix_cleunik_droite = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_gauche=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _acteurs_relations f2 left join _choix f1 on f2.choix_cleunik_droite = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_droite=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//	_acteurs_representants
	$sql_req = "update _acteurs_representants f2 left join _choix f1 on f2.choix_cleunik_gauche = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_gauche=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _acteurs_representants f2 left join _choix f1 on f2.choix_cleunik_gauche = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_droite=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _acteurs_representants f2 left join _choix f1 on f2.choix_cleunik_droite = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_gauche=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _acteurs_representants f2 left join _choix f1 on f2.choix_cleunik_droite = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik_droite=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_adresses
	$sql_req = "update _act_adresses f2 left join _choix f1 on f2.adr_typecoordonnees = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_choix_fixes
	$sql_req = "update _act_choix_fixes f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _act_choix_fixes f2 left join _criteres f1 on f2.critere_cleunik = f1.critere_cleunik set f1.critere_portee=f1.critere_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.critere_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo
	$sql_req = "update _act_interlo f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo_adresses
	$sql_req = "update _act_interlo_adresses f2 left join _choix f1 on f2.adr_typecoordonnees = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo_choix_fixes
	$sql_req = "update _act_interlo_choix_fixes f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _act_interlo_choix_fixes f2 left join _criteres f1 on f2.critere_cleunik = f1.critere_cleunik set f1.critere_portee=f1.critere_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.critere_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo_fax
	$sql_req = "update _act_interlo_fax f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo_mail
	$sql_req = "update _act_interlo_mail f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo_mesinst
	$sql_req = "update _act_interlo_mesinst f2 left join _choix f1 on f2.choix_cleunik_type = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	$sql_req = "update _act_interlo_mesinst f2 left join _choix f1 on f2.choix_cleunik_prot = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_interlo_tel
	$sql_req = "update _act_interlo_tel f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
	//_act_sites
	$sql_req = "update _act_sites f2 left join _choix f1 on f2.choix_cleunik = f1.choix_cleunik set f1.choix_portee=f1.choix_portee+$vl_e_portee where f2.act_cleunik=$vl_act_cleunik and ((f1.choix_portee & $vl_e_portee)=0);";
  $vf_c_echo=_graal_exec_requete($sql_req);
  if($vf_c_echo=='ok') {$vf_c_retour.="";} else {$vf_c_retour.=$sql_req;}
}
?>
