<?php
include("_graal_header_pdf_02.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_numerotation.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
include("_graal_fonctions_documents.php");
include("_graal_fonctions_documents_ciaux.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_action_cleunik=intval(fa_recup_param("vl_e_action_cleunik","0"));
if ($vl_e_action_cleunik==0) {fa_redirige("acces_interdit");}

$vl_c_fic_ligne="_livcli_lignes";
$vl_c_fic_qte="_livcli_lignes_qte";
$vl_c_fic_entete="_livcli_entetes";
$vl_e_fic_adresses="_livcli_adresses";
$vl_c_fic_transporteur="_livcli_transporteurs";
$vl_c_id_fenetre="Edi_00007";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_b_acces=$vl_tb_droits[0];
//if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_dico_00058=fa_recup_dico("dico_00058");
$police_du_document="FreeSerif";	// Il faut intégrer la police : 819.5 Ko
$police_du_document="Courier";		//	Police non intégrée : 3.6 Ko
$police_du_document="times";		//	Police non intégrée : 3.5 Ko	Pas de différence visuelle avec FreeSerif
$genreaction="livcli";
$genreregroupement="initial";
require_once('_graal_pdf_bloc_001.php');
define('EOL', "\r\n");
class pseudo extends _graal_TCPDF {
function Header() {}
}
class toto extends _graal_TCPDF {
// private variables
var $contenu_code;
var $contenu_nom_commercial;
var $contenu_dateexp;
var $contenu_code_bondepreparation;
var $impression_cgv;
function Header() {
  global $vl_e_action_cleunik;
  global $y;
  global $cols;
  global $format;
  global $nbligne_montant_pied;
  global $hauteur_blocnote_pied;
  global $juste_la_date_en_clair;
	  //  Recherche informations transporteur      
	  $sql_req_00="SELECT nomcommercial as transporteur FROM _bordereau_transporteurs left join _acteurs on (_bordereau_transporteurs.act_cleunik_trans=_acteurs.act_cleunik) where action_cleunik=$vl_e_action_cleunik";
	  $result_00=_graal_requete_bd($sql_req_00);
	  if (mysql_num_rows($result_00)==0) {
	    $transporteur="???????????????????????";
	  } else {
	    $row_00 = mysql_fetch_assoc($result_00);
	    $transporteur=$row_00['transporteur'];
	  }
	  _graal_libere_requete_bd($result_00);
	  
	  $this->SetFont($this->police_du_document, "B",14);$this->SetXY(10,10);$this->Cell(0, 4,"BARONNAT");
	  $this->SetFont($this->police_du_document, "B",11);
	  $this->SetXY(10,20);
	  $adresse="";
	  $adresse.="491, Route de Lacenas".EOL;
	  $adresse.="69400 Gleizé".EOL;
	  $adresse.="04 74 68 59 20    04 74 62 19 21".EOL;
	  $adresse.="http://www.baronnat.com   info@baronnat.com".EOL;
	  $this->MultiCell(0, 4, $adresse);
	  $this->SetXY(150,10);$this->Cell(0, 4, $juste_la_date_en_clair);
	  $this->SetXY(180,20);$this->Cell(0, 4, "Page ".$this->getPage()."/{nombredepages}");
	  $this->SetFont($this->police_du_document, "",16);
	  $this->SetXY(70,45);
	  $adresse="BORDEREAU D'EXPEDITION";
	  $this->Cell(0, 4, $adresse);
	  $this->SetXY(70,55);
	  $this->SetFont($this->police_du_document, "B",12);
	  $this->Cell(0, 4,"Transport ");
	  $this->SetXY(95,55);
	  $this->SetFont($this->police_du_document, "",12);
	  $this->Cell(0, 4,$transporteur);
	  $adresse="Transport ";
	  
	  //  Entête du tableau
	  $this->SetFont($this->police_du_document, "",9);
	  $y=$this->getY();
	  $y+=10;
	  $this->addCols_00( $cols,$xyz=array("10",$y,30+$hauteur_blocnote_pied));
	  //$this->addLineFormat_00($format,$cols);
	  $y=$this->getY();
	  $this->setY($y+10);
	  $y=$this->getY();
	  
}
}

  $nb_remises_lignes=0;
  $nombre_taxes=0;
  $pseudo_pdf = new pseudo(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true);
  $pseudo_pdf->Open();
  $pseudo_pdf->SetFont( $police_du_document, "", 9);  //  Police utilisée pour les lignes
  $hauteur_blocnote_pied=0;
  $position_pied=270;
  $pdf = new toto(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
  // set document information
  $pdf->SetCreator(PDF_CREATOR);
  //$pdf->SetProtection(array('print'));  //  On protège le document : seule l'impression est autorisée. 
  /*
   * le 27 août 2009 -> ne plus utiliser la protection, sinon on ne peut rien faire avec le document via le programme pdftk
   */
  //$pdf->setPrintHeader(false);
  $pdf->setPrintFooter(false);  //  Définir ce que l'on mettra dans le pied
  $pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
  $pdf->SetAutoPageBreak(TRUE, 10);
  $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
  $pdf->SetFooterMargin(5);
  $pdf->SetLineWidth(0.01);  //  Cadre invisible
  $pdf->AliasNbPages("nombredepages");
  $cols=array( "Numéro"=>25,"Nom Client"=>80,"Nature"=>40,"Colisage"=>45);
  $format=array("Numéro"=>"L","Nom Client"=>"L","Nature"=>"C","Colisage"=>"R");
  $fonts=array( "Numéro"=>array( $police_du_document,"B","9"),"Nom Client"=>array( $police_du_document,"B","9"),"Nature"=>array( $police_du_document,"","9"),"Colisage"=>array( $police_du_document,"","9"));
  $type=array("Numéro"=>"Texte","Nom Client"=>"Texte","Nature"=>"Texte","Colisage"=>"Texte");
  $pdf->impression_cgv="false";
  $pdf->AddPage();
  $art_des=array();$art_cle=array();$art_qte=array();
  $poidsbrut_total=0;$nbcolis_total=0;$nb_palette_total=0;
  $sql_req_00="select f1.action_cleunik from _bordereau_transporteurs_lignes f1 left join _bordereau_transporteurs f2 using(bordereau_cleunik) where f2.action_cleunik=$vl_e_action_cleunik";
  $result_00=_graal_requete_bd($sql_req_00);
  //echo $sql_req_00;
  
  //echo $y.EOL;
  $nbligne=0;
  while ($row_00 = mysql_fetch_assoc($result_00)) {
  	$nbligne++;
	$vl_e_action_cleunik_livcli=$row_00['action_cleunik'];
	$sql_req_01="Select f2.commercial_cleunik,f1.adr_nom,f1.adr_complementnom,f1.adr_ligne1,f1.adr_ligne2,f1.adr_ligne3,f1.adr_cp,f1.adr_ville,f2.code,f2.rendezvous,"._graalsql_date('f2.dateheurelivraison')." as date_livraison,f4.choix_valeur_texte_01 as mode_livraison,f5.choix_valeur_texte_01 as nature_port,f6.choix_valeur_texte_01 as mode_livraison_bis from _livcli_adresses f1 left join _livcli_entetes f2 using(commercial_cleunik) left join _choix f4 on f2.modliv=f4.choix_cleunik left join _choix f5 on f2.typpor=f5.choix_cleunik left join _choix f6 on f2.modliv_bis=f6.choix_cleunik where f1.adr_typecoordonnees&1 and f2.action_cleunik=$vl_e_action_cleunik_livcli;";
	//echo $sql_req_01;
	$result_01 = _graal_requete_bd($sql_req_01);
	$row_01 = mysql_fetch_assoc($result_01);
	$vl_commercial_cleunik=$row_01['commercial_cleunik'];
	$adresse="";
	if (trim($row_01['adr_nom'])!="") {$adresse.=$row_01['adr_nom'].EOL;}
	if (trim($row_01['adr_complementnom'])!="") {$adresse.=$row_01['adr_complementnom'].EOL;}
	//if (trim($qui)!="") {$adresse.=$qui.EOL;}
	if (trim($row_01['adr_ligne1'])!="") {$adresse.=$row_01['adr_ligne1'].EOL;}
	if (trim($row_01['adr_ligne2'])!="") {$adresse.=$row_01['adr_ligne2'].EOL;}
	if (trim($row_01['adr_ligne3'])!="") {$adresse.=$row_01['adr_ligne3'].EOL;}
	if (trim($row_01['adr_cp'].$row_01['adr_ville'])!="") {$adresse.=$row_01['adr_cp']." ".$row_01['adr_ville'].EOL;}
	$adresse.=EOL;
	if (trim($row_01['mode_livraison'])!="") {$adresse.=$row_01['mode_livraison'].EOL.EOL;}
	if (trim($row_01['date_livraison'])!="") {$adresse.="Le ".$row_01['date_livraison']." ".$row_01['mode_livraison_bis'].EOL;}
	if (trim($row_01['rendezvous'])!="") {$adresse.=$row_01['rendezvous'].EOL;}
	$nature=$row_01['nature_port'].EOL.EOL."Produits alimentaires";
	if (trim($row_01['code'])!="") {$code=$row_01['code'];}
	_graal_libere_requete_bd($result_01);
	
	
	
	
	$colisage="";
	$sql_req_01="SELECT IFNULL(round(poids_bru,0),-1) as poidsbrut_memo,nomcommercial as transporteur,round(nombre_colis,0) as nbcolis_memo FROM _livcli_transporteurs left join _acteurs on (_livcli_transporteurs.act_cleunik_trans=_acteurs.act_cleunik) where commercial_cleunik=$vl_commercial_cleunik";
  $result_01=_graal_requete_bd($sql_req_01);
  if (mysql_num_rows($result_01)==0) {
    $nbcolis_memo=-1;
    $poidsbrut_memo=-1;
  } else {
    $row_01 = mysql_fetch_assoc($result_01);
    $nbcolis_memo=$row_01['nbcolis_memo'];
    $poidsbrut_memo=$row_01['poidsbrut_memo'];
  }
  _graal_libere_requete_bd($result_01);
  //  Recherche informations calculées (nombre de colis, poids etc)
  $sql_req_01="select IFNULL(round(sum(a3.qte * a1.poidsbrut),0),-1) AS poidsbrut_calcule,round(sum(a3.qte_condi),0) AS nbcolis_calcule from _livcli_lignes a1 left join _livcli_lignes_qte a3 using (commercial_ligne_cleunik) where a1.commercial_cleunik=$vl_commercial_cleunik group by a1.commercial_cleunik;";
  $result_01=_graal_requete_bd($sql_req_01);
  $row_01 = mysql_fetch_assoc($result_01);
  $nbcolis_calcule=$row_01['nbcolis_calcule'];
  $poidsbrut_calcule=$row_01['poidsbrut_calcule'];
  _graal_libere_requete_bd($result_01);
  //	Recherche informations palettes
  
  $sql_req_01="SELECT IFNULL(round(f1.qte,0),-1) as nb_palette,f2.description,f2.art_cleunik FROM _livcli_consignes f1 left join _article f2 using(art_cleunik) where f1.commercial_cleunik=$vl_commercial_cleunik";
  $result_01=_graal_requete_bd($sql_req_01);
  if (mysql_num_rows($result_01)==0) {
    $nb_palette=-1;
    $description_article="";
  } else {
    $row_01 = mysql_fetch_assoc($result_01);
    $nb_palette=$row_01['nb_palette'];
    $description_article=$row_01['description'];
	$vl_e_trouve=array_search($row_01['art_cleunik'], $art_cle);
	if ($vl_e_trouve===false) {
		array_push ($art_des, fa_ent_xml($row_01['description']));
	    array_push ($art_cle, $row_01['art_cleunik']);
		array_push ($art_qte, $row_01['nb_palette']);
	} else {
		$art_qte[$vl_e_trouve]+=$row_01['nb_palette'];
	}
}
  _graal_libere_requete_bd($result_01);
  if (($poidsbrut_memo==-1)||($poidsbrut_memo==0)) {$poidsbrut=$poidsbrut_calcule;} else {if ($poidsbrut_memo==-2) {$poidsbrut=0;} else {$poidsbrut=$poidsbrut_memo;}}
  if (($nbcolis_memo==-1)||($nbcolis_memo==0)) {$nbcolis=$nbcolis_calcule;} else {if ($nbcolis_memo==-1) {$nbcolis=0;} else {$nbcolis=$nbcolis_memo;}}
	if ($nbcolis!=0) {
		$colisage.="COLIS                     $nbcolis".EOL.EOL;
		$nbcolis_total+=$nbcolis;
	}
	if ($poidsbrut!=0) {
		$colisage.="Poids                     $poidsbrut".EOL;
		$poidsbrut_total+=$poidsbrut;
	}
	if ($description_article!="") {
		$colisage.="$description_article  $nb_palette".EOL;
		$nb_palette_total+=$nb_palette;
	}
	$line = array( "Numéro"=>"$code","Nom Client"=>$adresse,"Nature"=>"$nature","Colisage"=>"$colisage");
    $hauteurligne=$pdf->_graal_pf_imprime_ligne($line,$y,$cols,$format,$fonts,$type,$position_pied);
    //echo $y."nblignes $nbligne".EOL;
    if ($nbligne==5){
    	$pdf->AddPage();
    	$nbligne=0;
    }
  }
  _graal_libere_requete_bd($result_00);
  
  
  $pdf->setXY(10,$position_pied);
  $code="Totalisation";
  $adresse="$nbcolis_total colis";
  $nature="$poidsbrut_total kgs";
  
  $colisage="";
  $vl_e_i=-1;
  foreach($art_des as $vl_raf) {
  	$vl_e_i++;
  	$colisage.="$art_qte[$vl_e_i] $art_des[$vl_e_i]".EOL;
  }
  $line = array( "Numéro"=>"$code","Nom Client"=>$adresse,"Nature"=>"$nature","Colisage"=>"$colisage");
	//$line = array("Code"=>$Code,"Quantité"=>$Quantité,"Désignation"=>$Désignation);
    $pdf->_graal_pf_imprime_ligne($line,$y,$cols,$format,$fonts,$type,$position_pied);
	$blocnotebrut_pied="";
	$blocnotebrut_pied.=EOL.EOL;
	$blocnotebrut_pied.="Palettes Euro rendues                                                        Solde à ce jour".EOL.EOL.EOL;
	$blocnotebrut_pied.="SIGNATURE";
	$pdf->MultiCell(0, 4, $blocnotebrut_pied,"","");

	fa_fin_creation_bordereau_expedition();
  
?>
