<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','client');
$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_fax_defaut=intval(fa_recup_param('vl_e_fax_defaut','-10'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_fax_defaut=intval(fa_recup_param('vl_e_indicatif_fax_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vl_e_genre_acteur_defaut=intval(fa_recup_param('vl_e_genre_acteur_defaut','-5'));
$vl_e_critere_cleunik_secteur_geo=intval(fa_recup_param('vl_e_critere_cleunik_secteur_geo','0'));
$vl_e_critere_cleunik_famille=intval(fa_recup_param('vl_e_critere_cleunik_famille','0'));
$vl_e_critere_cleunik_origine=intval(fa_recup_param('vl_e_critere_cleunik_origine','0'));
$vl_e_critere_cleunik_tarcli=101;
include("_import_apisoft_sp_array_pays.php");
include("_import_apisoft_sp_array_geo.php");
include("_import_apisoft_sp_array_fam.php");
include("_import_apisoft_sp_array_tarifs_cli.php");
include("_import_apisoft_sp_array_representants.php");
$ori_cod=array();$ori_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=$vl_e_critere_cleunik_origine"; //  On recherche les critères origine
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($ori_cod, $row['code']);
  array_push ($ori_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);



switch ($vl_c_fic_tiers){
  case "client":
    break;
  case "tiers":
    $vf_e_typeacteur=110001;
    break;
}
include("_import_class_data_km.php");
$sql_req = "SELECT Code as `Code`,Nom as `Nom`,Politesse as `Politesse`,Adresse as `Adresse`,AdresseSuite as `AdresseSuite`,CP as `CP`,Ville as `Ville`,Tel as `Tel`,Fax as `Fax`,ClientProspect as `ClientProspect`,FamilleTiers as `FamilleTiers`,Secteur as `Secteur`,Proprietaire as `Proprietaire`,Origine as `Origine`,DateDerModif as `DateDerModif`,DateCreation as `DateCreation`,DateClient as `DateClient`,CodeGest as `CodeGest`,Commentaire as `Commentaire`,Historique as `Historique`,Ca as `Ca`,Marge as `Marge`,PMarge as `PMarge`,PTotalSoc as `PTotalSoc`,Solde as `Solde`,NbIncident as `NbIncident`,CompteBloque as `CompteBloque`,EncoursAutorise as `EncoursAutorise`,DateDerFact as `DateDerFact`,LivreNFact as `LivreNFact`,RisqueTheorique as `RisqueTheorique`,MtDerFact as `MtDerFact`,PEscompte as `PEscompte`,PRemise as `PRemise`,CodeNum as `CodeNum`,REP as `REP`,RR as `RR`,ASSIST as `ASSIST`,RES3 as `RES3`,`Tél direct` as `Tél direct`,ECH as `ECH`,`D C` as `D C`,Email as `Email`,Chambres as `Chambres`,Restaurant as `Restaurant`,`Code accorest` as `Code accorest`,Tarif as `Tarif`,Préférence as `Préférence`,CODEALPHA as `CODEALPHA`,`Derniere modif` as `Derniere modif`,Portable as `Portable`,`Prochain contact` as `Prochain contact`,Représentant as `Représentant`,Representant as `Representant`,`Mise à jour` as `Mise à jour`,`FERMETURE HEBDO` as `FERMETURE HEBDO`,`Fermeture Annuelle` as `Fermeture Annuelle`,SEMINAIRES as `SEMINAIRES`,COMMENT as `COMMENT` FROM $vl_c_base_origine.$vl_c_fic_tiers order by Code";
$result = _graal_requete_bd($sql_req);

$o_acteur=new _graal_import();
$o_compta=new _graal_import();
$o_choix=new _graal_import();
$o_baronnat=new _graal_import();
$o_adresses=new _graal_import();
$o_interlo=new _graal_import();
$o_web=new _graal_import();
$o_fax=new _graal_import();
$o_tel=new _graal_import();
$o_rep=new _graal_import();
$o_fonction=new _graal_import();
$o_relation=new _graal_import();
$o_acteur->req="INSERT INTO $vl_c_base_destination._acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,blocnotebrut,blocnotertf,dateheuremodif,dateheurecreation,typeacteur,c_uuid,mnemotechnique,devise) VALUES ";
$o_compta->req="INSERT INTO $vl_c_base_destination._act_compta (act_cleunik,encours_autorise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$o_baronnat->req="INSERT INTO $vl_c_base_destination._z_baronnat_acteurs_clients (act_cleunik,accise,accorest) VALUES ";
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_adresses (adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik) VALUES ";
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_fax->req="INSERT INTO $vl_c_base_destination._act_interlo_fax (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_rep->req="INSERT INTO $vl_c_base_destination._acteurs_representants (act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_relation->req="INSERT INTO $vl_c_base_destination._acteurs_relations(act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_fonction->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";

$vf_e_act_cleunik=_graal_requete_max("act_cleunik","$vl_c_base_destination._acteurs");
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_adresses");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_fax_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_fax");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;

while ($row = mysql_fetch_assoc($result)){
//  Ajout dans la table des acteurs
  $vf_e_act_cleunik++;
  $i++;
  $codealphanum15=$row['Code'];
  $raisonsoc=addslashes($row['Nom']);
  $nomcommercial=addslashes($row['Nom']);
//  $blocnotebrut=addslashes($row['Commentaire']).EOL.addslashes($row['Historique']).EOL.addslashes($row['COMMENT']);
//  $blocnotertf=addslashes($row['Commentaire']).EOL.addslashes($row['Historique']).EOL.addslashes($row['COMMENT']);
  $blocnotebrut=addslashes($row['Historique']).EOL.addslashes($row['COMMENT']);
  $blocnotertf=addslashes($row['Historique']).EOL.addslashes($row['COMMENT']);
  $dateheuremodif=$row['DateDerModif'];
  $dateheurecreation=$row['DateCreation'];
  $typeacteur=$vf_e_typeacteur;
  $uuid=_graal_requete_uuid();
  $mnemotechnique=addslashes($row['CODEALPHA']);
  $devise=122047;
  $o_acteur->dat.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial','$blocnotebrut','$blocnotertf','$dateheuremodif','$dateheurecreation',$typeacteur,'$uuid','$mnemotechnique',$devise),";
  $vl_e_trouve_tarcli=array_search($row['Tarif'], $tarcli_cod);if ($vl_e_trouve_tarcli===false) {$vl_e_tarif_cleunik=-31;} else {$vl_e_tarif_cleunik=$tarcli_cle[$vl_e_trouve_tarcli];}
  $encours_autorise=$row['EncoursAutorise'];
  $remise_taux=$row['PRemise'];$escompte_taux=$row['PEscompte'];
  $o_compta->dat.="($vf_e_act_cleunik,$encours_autorise,$vl_e_tarif_cleunik,$remise_taux,1,2,$escompte_taux,1,1),";
  $o_choix->dat.="($vf_e_act_cleunik,$vl_e_genre_acteur_defaut,80,$vf_e_typeacteur),";
  if ($vl_e_critere_cleunik_secteur_geo!=0){
    $vl_e_trouve_geo=array_search($row['Secteur'], $geo_cod);if ($vl_e_trouve_geo===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$geo_cle[$vl_e_trouve_geo];}
    if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik_secteur_geo,$vf_e_typeacteur),";}
  }
  if ($vl_e_critere_cleunik_famille!=0){
    $vl_e_trouve_fam=array_search($row['FamilleTiers'], $fam_cod);if ($vl_e_trouve_fam===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$fam_cle[$vl_e_trouve_fam];}
    if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik_famille,$vf_e_typeacteur),";}
  }
  if ($vl_e_critere_cleunik_origine!=0){
    $vl_e_trouve_ori=array_search($row['Origine'], $ori_cod);if ($vl_e_trouve_ori===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$ori_cle[$vl_e_trouve_ori];}
    if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik_origine,$vf_e_typeacteur),";}
  }
    //  Liaison avec le représentant
  $vl_e_trouve_rep=array_search($row['Representant'], $rep_cod);if ($vl_e_trouve_rep===false) {$act_cleunik_droite=0;} else {$act_cleunik_droite=$rep_cle[$vl_e_trouve_rep];}
  if ($act_cleunik_droite!=0) {$o_rep->dat.="($vf_e_act_cleunik,-28,-27,$act_cleunik_droite),";}

//  Ajout dans la table des _act_adresses (adresses au format français) des adresses de facturation          
  $vl_c_chaine=trim($row['Adresse'].$row['AdresseSuite'].$row['FacCp'].$row['Ville']);
  //  On ajoute uniquement si l'adresse est un minimum renseignée
  if ($vl_c_chaine!="") {
    $vl_e_cleunik_pays=60000;
    $vf_e_adr_cleunik++;
    $adr_complementnom=addslashes($row['Nom']);
    $adr_ligne1=addslashes($row['Adresse']);
    $adr_ligne2=addslashes($row['AdresseSuite']);
    $adr_cp=addslashes($row['CP']);
    $adr_ville=addslashes($row['Ville']);
    $o_adresses->dat.="($vf_e_adr_cleunik,'Fac01',$vf_e_act_cleunik,'$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_cp','$adr_ville',$vl_e_cleunik_pays,1),";
  }
  //  Ajout dans la table des _act_interlo (Interlocuteurs des acteurs) des interlocuteurs 
  $vl_c_chaine=trim($row['Tel'].$row['Fax'].$row['Portable'].$row['Email']);
  $vl_c_liv=$vl_c_chaine;
  //  On ajoute uniquement si l'interlocuteur de livraison est un minimum renseigné
  if ($vl_c_chaine!=""){
    $vf_e_int_cleunik++;
    if ($row['RR']!="") {$patronyme=addslashes($row['RR']);} else {$patronyme=addslashes($row['Nom']);}
    $o_interlo->dat.="($vf_e_int_cleunik,'Lui01',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
    $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,-7,92,$vf_e_typeacteur,0),";
    $vl_c_chaine=trim($row['Email']);
    //  On ajoute uniquement si le mail de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vf_e_intweb_cleunik++;
      $refweb=addslashes($row['Email']);
      $uuid=_graal_requete_uuid();
      $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
    }
    $vl_c_chaine=trim($row['Fax']);
    //  On ajoute uniquement si le fax de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine); 
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_fax_cleunik++;
      $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
    }
    $vl_c_chaine=trim($row['Tel']);
    //  On ajoute uniquement si le téléphone de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_tel_cleunik++;
      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut),";
    }
    $vl_c_chaine=trim($row['Portable']);
    //  On ajoute uniquement si le téléphone portable de livraison est renseigné
    if ($vl_c_chaine!=""){
      $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
      $vl_c_chaine_brute=addslashes($vl_c_chaine);
      $vf_e_tel_cleunik++;
      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut),";
    }
  }
  if ($i % $i1==0){
    $o_acteur->execute();
    $o_compta->execute();
    $o_choix->execute();
    $o_adresses->execute();
    $o_interlo->execute();
    $o_web->execute();
    $o_fax->execute();
    $o_tel->execute();
    $o_rep->execute();
    $o_relation->execute();
    $o_fonction->execute();
  }
}
$o_acteur->execute();
$o_compta->execute();
$o_choix->execute();
$o_adresses->execute();
$o_interlo->execute();
$o_web->execute();
$o_fax->execute();
$o_tel->execute();
$o_rep->execute();
$o_relation->execute();
$o_fonction->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo("$i prospects importés.");
?>
