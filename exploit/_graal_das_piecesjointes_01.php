<?php
include("_graal_header_xml.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_documents.php");
$vl_e_uti_cleunik=intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_c_recherche=fa_recup_param('vl_c_recherche',"ZZZZZZZZZZZZZZZZZZZZZZZZZZ");
$vl_c_type=fa_recup_param("vl_c_type","???");
$vl_c_nature=fa_recup_param("vl_c_nature","???");
// execution de la requète SQL
$req_compte="select count(*) from _documents_rattachement,_actions where _documents.doc_cleunik=_documents_rattachement.doc_cleunik and ";
$req_compte.="_documents_rattachement.rat_cleunik=_actions.action_cleunik and portee &$vl_e_piejoi";
$req_fav="and _documents.doc_cleunik in (select doc_cleunik from _documents_favoris where uti_cleunik=$vl_e_uti_cleunik";
$sql_req_01="SELECT _documents.doc_cleunik,emplacement,mime,hash,($req_compte) as nombre,'courriels reçus' as genre,"._graalsql_datetime('_documents.dateheurecreation')." as dateheurecreation_clair,_documents.dateheurecreation  ";
$sql_req_01.=" from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _documents_rattachement.doc_cleunik from _documents_rattachement,_actions,_documents ";
$sql_req_01.=" where _documents.doc_cleunik=_documents_rattachement.doc_cleunik and _documents_rattachement.rat_cleunik=_actions.action_cleunik ";
$sql_req_01.=" and _actions.choix_cleunik in(-110102) and portee &65536)";
$sql_req_02="SELECT _documents.doc_cleunik,emplacement,mime,hash,($req_compte) as nombre,'courriels envoyés' as genre,"._graalsql_datetime('_documents.dateheurecreation')." as dateheurecreation_clair,_documents.dateheurecreation";
$sql_req_02.=" from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _documents_rattachement.doc_cleunik from _documents_rattachement,_actions,_documents ";
$sql_req_02.=" where _documents.doc_cleunik=_documents_rattachement.doc_cleunik and _documents_rattachement.rat_cleunik=_actions.action_cleunik ";
$sql_req_02.=" and _actions.choix_cleunik in(-110103,-110104) and portee &65536)";
$sql_req_03="SELECT _documents.doc_cleunik,emplacement,mime,hash,($req_compte) as nombre,'courriels reçus' as genre,"._graalsql_datetime('_documents.dateheurecreation')." as dateheurecreation_clair,_documents.dateheurecreation ";
$sql_req_03.=" from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _documents_rattachement.doc_cleunik from _documents_rattachement,_actions,_documents ";
$sql_req_03.=" where _documents.doc_cleunik=_documents_rattachement.doc_cleunik and _documents_rattachement.rat_cleunik=_actions.action_cleunik ";
$sql_req_03.=" and _actions.choix_cleunik in(-110102) and portee &65536 $req_fav)) ";
$sql_req_03.=" union all ";
$sql_req_03.=" SELECT _documents.doc_cleunik,emplacement,mime,hash,($req_compte) as nombre,'courriels envoyés' as genre,"._graalsql_datetime('_documents.dateheurecreation')." as dateheurecreation_clair,_documents.dateheurecreation ";
$sql_req_03.=" from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _documents_rattachement.doc_cleunik from _documents_rattachement,_actions,_documents ";
$sql_req_03.=" where _documents.doc_cleunik=_documents_rattachement.doc_cleunik and _documents_rattachement.rat_cleunik=_actions.action_cleunik ";
$sql_req_03.=" and _actions.choix_cleunik in(-110103,-110104) and portee &65536 $req_fav))";
switch ($vl_c_type) {
  case 'recfav':
    $sql_req=$sql_req_03;
    break;
  case 'rectou':
    $sql_req=$sql_req_01." union all ".$sql_req_02;
    break;
  case 'recenv':
    $sql_req=$sql_req_02;
    break;
  case 'recrec':
    $sql_req=$sql_req_01;
    break;
}
//die($sql_req);
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	if ($vl_c_nature=="select") {
		$ok=fa_verif_droit($row['doc_cleunik']);
	} else {
		$ok=true;
	}
	if ($ok==true){
		echo('<quoi ');
		  echo(' doc_cleunik="'.fa_ent_xml($row['doc_cleunik']).'"');
		  echo(' nom="'.fa_ent_xml($row['emplacement']).'"');
		  echo(' hash="'.fa_ent_xml($row['hash']).'"');
		  echo(' nombre="'.fa_ent_xml($row['nombre']).'"');
		  echo(' genre="'.fa_ent_xml($row['genre']).'"');
		  echo(' dateheurecreation_clair="'.fa_ent_xml($row['dateheurecreation_clair']).'"');
		  echo(' dateheurecreation="'.fa_ent_xml($row['dateheurecreation']).'"');
	  echo('/>');
	}
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
