<?php
include("_graal_header_txt.inc.php");
include_once("_graal_fonctions_documents_ciaux.php");
define('EOL', "\r\n");
$genreaction=fa_recup_param("genreaction","??");
$quoi=fa_recup_param("quoi","compta");
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik",-1));
$vl_action_cleunik=intval(fa_recup_param("vl_action_cleunik",$vl_commercial_cleunik));
$vl_tab_action_cleunik=fa_recup_param("vl_tab_action_cleunik",-1);
$genreregroupement="compta_ht";
include("_graal_req_docial_recap_montants.inc.php");
$sql_req_ht_marchandise_ht_init=$sql_req_ht_marchandise;
/*
 * depuis le 1° décembre 2009, changement de mode de calcul de la TVA, pour tenir compte des taxes parafiscales
 * 
 * a priori, $sql_req_ht_marchandise_tv_init désomais inutile
 */
$genreregroupement="compta_tva";
include("_graal_req_docial_recap_montants.inc.php");
$sql_req_ht_marchandise_tv_init=$sql_req_ht_marchandise;
$sql_req_port_init=$sql_req_port;
$sql_req_frais_init=$sql_req_frais;
$sql_req_port_ori=$sql_req_port;
$sql_req_frais_ori=$sql_req_frais;
$sql_req_acompte_ori=$sql_req_acompte;
$sql_req_parafiscale_ori=$sql_req_parafiscale;
$sql_req_tva_ori=$sql_req_tva;
$sql_req_tva_montant_ori=$sql_req_tva_montant;
//echo $sql_req_port_ori;
session_write_close();
switch ($quoi){
	case "montants":
		switch ($vl_commercial_cleunik){
			case -2:
				switch ($genreaction){
				  case "offcli":
				  case "livcli":
				  case "demfou":
				  case "cdefou":
				  case "recfou":
				  case "retcli":
				  case "retfou":
				  case "faccli":
				  case "avocli":
				  case "avofin":
				  case "avofou":
				  case "avofif":
				  case "facfou":
				  		break;
				  case "cdecli":
				  	$fic_entetes="_cdecli_entetes";			
						break;
				}
				$sql_req="select * from $fic_entetes f1 left join _docciaux_montants f2 using(action_cleunik) where f2.commercial_cleunik is null group by f1.commercial_cleunik order by f1.commercial_cleunik desc";
				//die($sql_req);
				set_time_limit(36000);  //  3600 secondes (1 heure !!! ) 
				$result = _graal_requete_bd($sql_req);
				$i=0;
				while ($row = mysql_fetch_assoc($result)) {
				  $vl_commercial_cleunik=$row['commercial_cleunik'];
				  $vl_action_cleunik=$row['action_cleunik'];
					$sql_req_ht_marchandise_ht=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_ht_init);
					$sql_req_ht_marchandise_tv=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_tv_init);
					$sql_req_port=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_port_ori);
					$sql_req_frais=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_frais_ori);
					$sql_req_acompte=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_acompte_ori);
					$sql_req_parafiscale=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_parafiscale_ori);
					$sql_req_tva_montant=str_replace("where a1.action_cleunik=-2","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_montant_ori);	
					fa_maj_compta($quoi,$vl_action_cleunik);
					$i++;
					echo "doc $i -> $vl_commercial_cleunik".EOL;
					flush();
				}
				_graal_libere_requete_bd($result);
			break;
		}
		break;
	
	case "compta":
	case "compta_seule":
		switch ($vl_commercial_cleunik){
			case -4:
				$sql_req="SELECT f1.commercial_cleunik,f1.action_cleunik FROM _echeancier f1 where montant_du is null and montant_paye is null and pc_cleunik is not null and pc_cleunik <> 60000003 order by date_echeance desc limit 200;";
				set_time_limit(3600);  //  3600 secondes (1 heure !!! ) 
				$result = _graal_requete_bd($sql_req);
				$i=0;
				while ($row = mysql_fetch_assoc($result)) {
				  $vl_commercial_cleunik=$row['commercial_cleunik'];
				  $vl_action_cleunik=$row['action_cleunik'];
				  fa_maj_decompta($vl_action_cleunik);
					$sql_req_ht_marchandise_ht=str_replace("where a1.commercial_cleunik=-4","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_ht_init);
					$sql_req_ht_marchandise_tv=str_replace("where a1.commercial_cleunik=-4","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_tv_init);
					$sql_req_port=str_replace("where a1.commercial_cleunik=-4","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_port_ori);
					$sql_req_frais=str_replace("where a1.commercial_cleunik=-4","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_frais_ori);
					$sql_req_acompte=str_replace("where a1.commercial_cleunik=-4","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_acompte_ori);
					$sql_req_parafiscale=str_replace("where a1.commercial_cleunik=-4","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_parafiscale_ori);
					$sql_req_tva=str_replace("where a1.action_cleunik=-4","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_ori);	
					fa_maj_compta($quoi,$vl_action_cleunik);
					$i++;
					echo "doc $i -> $vl_commercial_cleunik".EOL;
					flush();
				}
				_graal_libere_requete_bd($result);
			break;
			
			
			
			case -2:
				$sql_req="select f1.commercial_cleunik,f1.action_cleunik from _echeancier f1 where f1.date_paiement is null;";
				set_time_limit(3600);  //  3600 secondes (1 heure !!! ) 
				$result = _graal_requete_bd($sql_req);
				while ($row = mysql_fetch_assoc($result)) {
				  $vl_commercial_cleunik=$row['commercial_cleunik'];
				  $vl_action_cleunik=$row['action_cleunik'];
					$sql_req_ht_marchandise_ht=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_ht_init);
					$sql_req_ht_marchandise_tv=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_tv_init);
					$sql_req_port=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_port_ori);
					$sql_req_frais=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_frais_ori);
					$sql_req_acompte=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_acompte_ori);
					$sql_req_parafiscale=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_parafiscale_ori);
					$sql_req_tva=str_replace("where a1.action_cleunik=-2","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_ori);	
					fa_maj_compta($quoi,$vl_action_cleunik);
				}
				_graal_libere_requete_bd($result);
			break;
			case -3:
				switch ($genreaction){
				  case "offcli":
				  case "cdecli":
				  case "livcli":
					case "demfou":
				  case "cdefou":
				  case "recfou":
				  case "retcli":
				  case "retfou":
						$fic_entete="";
						break;
				  case "faccli":
						$fic_entete="_faccli_entetes";				
						break;
				  case "avocli":
				  case "avofin":	
						$fic_entete="_avocli_entetes";				
						break;
				  case "facfou":
						$fic_entete="_facfou_entetes";				
						break;
				  case "avofou":
				  case "avofif":	
						$fic_entete="_avofou_entetes";				
						break;
				}
				$vl_t_actions=unserialize(stripslashes($vl_tab_action_cleunik));
				$vl_b_transaction_ok=true;
				$vl_e_i=-1;
				$sql_condition="";
				foreach($vl_t_actions as $vl_raf) {
				  $vl_e_i++;
				  $vl_action_cleunik=$vl_t_actions[$vl_e_i];
				  if ($vl_e_i==0) {$sql_condition.= "$vl_action_cleunik";} else {$sql_condition.= ",$vl_action_cleunik";};
				}
				$sql_req="select f1.commercial_cleunik,f1.action_cleunik from $fic_entete f1 join _actions f2 using (action_cleunik) where f2.action_cleunik in($sql_condition);";
				set_time_limit(3600);  //  3600 secondes (1 heure !!! ) 
				//echo $sql_req.EOL;
				//die($sql_req);
				$result = _graal_requete_bd($sql_req);
				while ($row = mysql_fetch_assoc($result)) {
				  	$vl_commercial_cleunik=$row['commercial_cleunik'];
				  	$vl_action_cleunik=$row['action_cleunik'];
					$sql_req_ht_marchandise_ht=str_replace("where a1.commercial_cleunik=-3","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_ht_init);
					//die($sql_req.EOL.$vl_commercial_cleunik.EOL.$sql_req_ht_marchandise_ht.EOL);
					$sql_req_ht_marchandise_tv=str_replace("where a1.commercial_cleunik=-3","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_tv_init);
					$sql_req_port=str_replace("where a1.commercial_cleunik=-3","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_port_ori);
					$sql_req_frais=str_replace("where a1.commercial_cleunik=-3","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_frais_ori);
					$sql_req_acompte=str_replace("where a1.commercial_cleunik=-3","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_acompte_ori);
					$sql_req_parafiscale=str_replace("where a1.commercial_cleunik=-3","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_parafiscale_ori);
					$sql_req_tva=str_replace("where a1.action_cleunik=-3","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_ori);			
					//echo "maj $vl_action_cleunik".EOL;
					//echo $sql_req_tva.EOL;
					fa_maj_compta($quoi,$vl_action_cleunik);
				}
				_graal_libere_requete_bd($result);
			break;
			default:
				$sql_req_ht_marchandise_ht=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_ht_init);
				$sql_req_ht_marchandise_tv=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_ht_marchandise_tv_init);
				$sql_req_port=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_port_ori);
				$sql_req_frais=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_frais_ori);
				$sql_req_acompte=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_acompte_ori);
				$sql_req_parafiscale=str_replace("where a1.commercial_cleunik=-2","where a1.commercial_cleunik=$vl_commercial_cleunik",$sql_req_parafiscale_ori);
				$sql_req_tva=str_replace("where a1.action_cleunik=-2","where a1.action_cleunik=$vl_action_cleunik",$sql_req_tva_ori);	
				fa_maj_compta($quoi,$vl_action_cleunik);
			break;
		}
		break;
	case "enleve":
		switch ($vl_commercial_cleunik){
			case -3:
				switch ($genreaction){
				  case "offcli":
				  case "cdecli":
				  case "livcli":
					case "demfou":
				  case "cdefou":
				  case "recfou":
				  case "retcli":
				  case "retfou":
						$fic_entete="";
						break;
				  case "faccli":
						$fic_entete="_faccli_entetes";				
						break;
				  case "avocli":
				  case "avofin":	
						$fic_entete="_avocli_entetes";				
						break;
				  case "facfou":
						$fic_entete="_facfou_entetes";				
						break;
				  case "avofou":
				  case "avofif":	
						$fic_entete="_avofou_entetes";				
						break;
				}
				$vl_t_actions=unserialize(stripslashes($vl_tab_action_cleunik));
				$vl_b_transaction_ok=true;
				$vl_e_i=-1;
				$sql_condition="";
				foreach($vl_t_actions as $vl_raf) {
				  $vl_e_i++;
				  $vl_action_cleunik=$vl_t_actions[$vl_e_i];
				  if ($vl_e_i==0) {$sql_condition.= "$vl_action_cleunik";} else {$sql_condition.= ",$vl_action_cleunik";};
				}
				$sql_req="select f1.commercial_cleunik,f1.action_cleunik from $fic_entete f1 join _actions f2 using (action_cleunik) where f2.action_cleunik in($sql_condition);";
				set_time_limit(3600);  //  3600 secondes (1 heure !!! ) 
				$result = _graal_requete_bd($sql_req);
				while ($row = mysql_fetch_assoc($result)) {
				  	$vl_commercial_cleunik=$row['commercial_cleunik'];
				  	$vl_action_cleunik=$row['action_cleunik'];
					fa_maj_decompta($vl_action_cleunik);
				}
				_graal_libere_requete_bd($result);
				break;
			default:
				fa_maj_decompta($vl_action_cleunik);
		}	
		break;
}

_graal_ferme_connexion();
?>
