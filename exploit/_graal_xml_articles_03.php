<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_c_art_cleunik=intval(fa_recup_param("vl_e_art_cleunik",'-1'));
$vl_e_act_cleunik=intval(fa_recup_param("vl_e_act_cleunik",'-1'));
$vl_e_tarif_cleunik=intval(fa_recup_param("vl_e_tarif_cleunik",'-1'));
$vl_c_type_tarifs=intval(fa_recup_param("vl_e_type_tarifs",'-1'));
$genreaction=fa_recup_param("genreaction","??");
$commercial_cleunik=intval(fa_recup_param("commercial_cleunik",-1));
switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retcli":
  case "retfou":
    $fichier_entete="_".$genreaction."_entetes";
    break;
  case "avocli":
	case "avofin":
    $fichier_entete="_avocli_entetes";
    break;
  case "avofou":
	case "avofif":
    $fichier_entete="_avofou_entetes";
    break;
  default:
    exit;
    break;  //  Toutes les actions génériques
}
switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "avocli":
	case "avofin":
	case "retcli":
		$vl_genre_libelle="1";
		break;
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retfou":
  case "avofou":
  case "avofif":
		$vl_genre_libelle="2";
    break;
}



$sql_req="SELECT a1.art_cleunik as art_cleunik,a1.code as code,a1.indice as indice,a1.mnemotechnique as mnemotechnique,a1.description as description,
a1.nbdec_prix as nbdec_prix,a1.nbdec_qte as nbdec_qte,a2.unite_vente,a3.unite_condi,a3.gestion as gestion_depo_empla
 FROM _article a1 left join _art_ventes a2 using(art_cleunik)  left join _art_stock a3 using (art_cleunik) where a1.art_cleunik=$vl_c_art_cleunik;";
$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
$row = mysql_fetch_assoc($result);
echo('<Description>');
// parseType = indication pour le type des données, utile pour le tri sur la colonne
//  Informations relatives à la table "_article"
echo('<art_cleunik data="'.fa_ent_xml($row['art_cleunik']).'"/>');
echo('<code data="'.fa_ent_xml($row['code']).'"/>');
echo('<indice data="'.fa_ent_xml($row['indice']).'"/>');
echo('<mnemotechnique data="'.fa_ent_xml($row['mnemotechnique']).'"/>');
echo('<description data="'.fa_ent_xml($row['description']).'"/>');
echo('<nbdec_pu data="'.fa_ent_xml($row['nbdec_prix']).'"/>');
echo('<nbdec_qte data="'.fa_ent_xml($row['nbdec_qte']).'"/>');
echo('<unite_vente data="'.fa_ent_xml($row['unite_vente']).'"/>');
echo('<unite_condi data="'.fa_ent_xml($row['unite_condi']).'"/>');
echo('<gestion_depo_empla data="'.fa_ent_xml($row['gestion_depo_empla']).'"/>');
$vl_c_nbdec_prix=$row['nbdec_prix'];
_graal_libere_requete_bd($result);

$sql_req="SELECT a1.code as art_code_acteur,a1.description as art_description_acteur FROM _art_acteur a1 where a1.art_cleunik=$vl_c_art_cleunik and a1.act_cleunik=$vl_e_act_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<art_code_acteur data="'.fa_ent_xml($row['art_code_acteur']).'"/>');
echo('<art_description_acteur data="'.fa_ent_xml($row['art_description_acteur']).'"/>');
//echo('<art_description_acteur data="'.fa_ent_xml($sql_req).'"/>');
_graal_libere_requete_bd($result);


$sql_req="SELECT descriptif_brut FROM _art_libelle a1 left join _acteurs a2 using (langue) where a1.art_cleunik=$vl_c_art_cleunik and a1.genre=$vl_genre_libelle and a2.act_cleunik=$vl_e_act_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
echo('<descriptif_brut data="'.fa_ent_xml($row['descriptif_brut']).'"/>');
_graal_libere_requete_bd($result);

$sql_req="select round(pu_reference,$vl_c_nbdec_prix) as pu from _art_tarifs where art_cleunik=$vl_c_art_cleunik and actif=1 and type=$vl_c_type_tarifs and tarif_cleunik=$vl_e_tarif_cleunik and act_cleunik in (0,$vl_e_act_cleunik) order by act_cleunik desc";
$result = _graal_requete_bd($sql_req);
$nombre_tarifs= mysql_num_rows($result);
echo('<nombre_tarifs data="'.$nombre_tarifs.'"/>');
//echo('<req data="'.$sql_req.'"/>');
//  On ne récupère que le premier 
$row=mysql_fetch_assoc($result);
echo('<pu data="'.fa_ent_xml($row['pu']).'"/>');
_graal_libere_requete_bd($result);
include_once("_graal_inc_actions_js_tarifs_quantite.php");
echo('<nombre_quantites data="'.$vl_e_nombre_quantites.'"/>');
$script_quantite=base64_encode($script_quantite);
echo('<script_quantite data="'.$script_quantite.'"/>');
//  Recherche information comptable
$sql_req="SELECT a2.catcompta_cleunik as catcompta_cleunik FROM _art_compta a2 where a2.art_cleunik=$vl_c_art_cleunik and catcompta_cleunik=(select catcompta_cleunik from $fichier_entete where commercial_cleunik=$commercial_cleunik);";
$result = _graal_requete_bd($sql_req);
$row=mysql_fetch_assoc($result);
//echo('<reqcatcompta_cleunik data="'.fa_ent_xml($sql_req).'"/>');
echo('<catcompta_cleunik data="'.fa_ent_xml($row['catcompta_cleunik']).'"/>');
echo('</Description>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
