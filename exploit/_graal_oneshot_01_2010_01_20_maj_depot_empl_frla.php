<?php
include("_graal_header_txt.inc.php");
define('EOL', "\r\n");
//http://localhost/graal/exploit/_graal_oneshot_01_2010_01_20_maj_depot_empl_frla.php
//https://frlabacasable.xsoftware.fr/3be61be4-2cc9-420c-b37d-1dcb9f292fd8/graal/exploit/_graal_oneshot_01_2010_01_20_maj_depot_empl_frla.php
//https://frla.xsoftware.fr/3be61be4-2cc9-420c-b37d-1dcb9f292fd8/graal/exploit/_graal_oneshot_01_2010_01_20_maj_depot_empl_frla.php
$sql_maj="update _art_stock set gestion=1;";fa_exec($sql_maj);
$sql_maj="truncate _art_dep_emp;";fa_exec($sql_maj);
$sql_maj="truncate _mouvements_stock_bis;";fa_exec($sql_maj);
$sql_maj="insert into _mouvements_stock_bis select * from _mouvements_stock;";fa_exec($sql_maj);
$sql_maj="update _offcli_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _cdecli_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _livcli_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _avocli_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _faccli_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _retcli_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _demfou_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _cdefou_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _recfou_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _facfou_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _retfou_lignes_qte set choix_depot=-15,choix_empla=-16;";fa_exec($sql_maj);
$sql_maj="update _mouvements_stock set choix_depot=-15,choix_empla=-16";fa_exec($sql_maj);
fa_fajoute_depots_emp();
$sql_maj="update _art_dep_emp f1 left join _mouvements_stock f2 using(art_cleunik) set f1.qte_inven=f2.qte_mvt where f2.type_mvt=3;";fa_exec($sql_maj);
$sql_maj="update _art_dep_emp f1 left join _art_stock f2 using(art_cleunik) set f1.qte_stock=f2.qte_stock;";fa_exec($sql_maj);



echo 'Fin .'.EOL;

function fa_exec($requete){	
	$vf_c_echo=_graal_exec_requete($requete);
	echo "$requete".EOL;
	if($vf_c_echo!='ok') {echo $vf_c_echo.EOL;}
	flush();
}
function fa_fajoute_depots_emp(){
	$vl_art_depemp_cleunik=_graal_requete_max("art_depemp_cleunik","_art_dep_emp");
	$sql_req = "SELECT f1.art_cleunik as art_cleunik FROM _article f1 left join _art_dep_emp f2 using(art_cleunik) where f2.art_cleunik is null;";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)){
    	$vl_art_depemp_cleunik++;
    	$art_cleunik=$row['art_cleunik'];
      $sql_req_01="INSERT INTO _art_dep_emp set art_depemp_cleunik=$vl_art_depemp_cleunik,art_cleunik=$art_cleunik,choix_depot=-15,choix_empla=-16,qte_stock=0,qte_inven=0;";    
      $vf_c_echo=_graal_exec_requete($sql_req_01);
      echo "insert $art_cleunik".EOL;
      fa_maj_mvts($art_cleunik);
      if($vf_c_echo!='ok') {
      	echo $vf_c_echo.EOL;
      }
      flush();
    }
    _graal_libere_requete_bd($result);  
}

function fa_maj_mvts($vl_mousto_art_cleunik){
	$sql_req="select * from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik order by mvt_cleunik asc limit 1";
    // select * from _mouvements_stock where art_cleunik=10000821 and dateheuremvt <= '2003-12-31 13:00:17' order by dateheuremvt desc limit 1
    //  Récupération du stock à cet instant pour qu'il serve de base au nouvel enregistrement
    echo $sql_req.EOL;
	$result = _graal_requete_bd($sql_req);
    if (mysql_num_rows($result) == 0) {
      _graal_libere_requete_bd($result);
    }  else {
      $row=mysql_fetch_assoc($result);
      $vl_mousto_qte_pos=fa_ent_xml($row['qte_pos']);
      $mvt_cleunik_depart=$row['mvt_cleunik'];
      _graal_libere_requete_bd($result);
      $sql_req="select * from _mouvements_stock where art_cleunik=$vl_mousto_art_cleunik and mvt_cleunik > $mvt_cleunik_depart order by mvt_cleunik asc;";
      //echo $sql_req.EOL;
      $result = _graal_requete_bd($sql_req);
	    while ($row = mysql_fetch_assoc($result)) {
	    	$vl_mousto_qte_mvt=fa_ent_xml($row['qte_mvt']);
	    	$vl_mousto_type_mvt=$row['type_mvt'];
	    	//echo "vl_mousto_type_mvt -> $vl_mousto_type_mvt vl_mousto_qte_pos avant -> $vl_mousto_qte_pos vl_mousto_qte_mvt (mouvement)-> $vl_mousto_qte_mvt ";
		    switch ($vl_mousto_type_mvt) {
	      		case 1:$vl_mousto_qte_pos+=$vl_mousto_qte_mvt;break;//  Entrée
	      		case 2:$vl_mousto_qte_pos-=$vl_mousto_qte_mvt;break;//  Sortie 
	      		case 3:$vl_mousto_qte_pos=$vl_mousto_qte_mvt;break;//  Inventaire
	    	}
	    	//echo "vl_mousto_qte_pos après -> $vl_mousto_qte_pos".EOL;
	    	$sql_req_b1="UPDATE _mouvements_stock set qte_pos=$vl_mousto_qte_pos where mvt_cleunik=".$row['mvt_cleunik'];
	    	//echo $sql_req_b1.EOL;
            $vf_c_echo=_graal_exec_requete($sql_req_b1);
            if($vf_c_echo!='ok') {
            	$vl_mousto_b_transaction_ok=false;$vl_mousto_c_mess_err.="Erreur ajout ".$sql_req_b1.EOL;
            }
	    }
        _graal_libere_requete_bd($result);
	}
}


/*
 * CREATE TABLE  `graal_frla`.`_mouvements_stock_bis` (
  `mvt_cleunik` bigint(20) default NULL COMMENT 'Clé Unique Mouvement',
  `art_cleunik` bigint(20) default NULL COMMENT 'Clé Unique article',
  `uti_cleunik` bigint(20) default NULL COMMENT 'Clé Utilisateur ayant saisi le mouvement',
  `int_cleunik` bigint(20) default NULL COMMENT 'Interlocuteur entreprise concerné',
  `blocnotebrut` longtext COMMENT 'Bloc Note brut',
  `dateheuremvt` datetime default NULL COMMENT 'Date/Heure du mouvement',
  `dateheuresaisie` datetime default NULL COMMENT 'Date/Heure de saisie',
  `choix_depot` bigint(20) default '-15' COMMENT 'Dépôt',
  `choix_empla` bigint(20) default '-16' COMMENT 'Emplacement',
  `qte_mvt` decimal(15,4) default NULL COMMENT 'Quantité mouvementée',
  `qte_pos` decimal(15,4) default NULL COMMENT 'Quantité après le mouvement',
  `unite_mvt` bigint(20) default NULL COMMENT 'Unité de stock du mouvement',
  `genre_mvt` bigint(20) default NULL COMMENT 'Genre de mouvement (manuel, réception ...)',
  `type_mvt` tinyint(4) default NULL COMMENT 'Type de mouvement (Entrée, Sortie, Inventaire ... )',
  `pu_mvt` decimal(19,4) default NULL COMMENT 'Prix unitaire du mouvement'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Mouvements de stock';



insert into _mouvements_stock_bis select * from _mouvements_stock;

# articles dont le premier mouvement de stock n'est pas un inventaire





*
*
*
*/
?>