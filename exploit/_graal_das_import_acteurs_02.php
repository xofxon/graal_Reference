<?php
/*
 * Modèle 2 importation acteur 27 colonnes
 */
include("_graal_header_xml.inc.php");
include("_graal_fonctions_documents.php");
$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
$sep="\t";	//tab
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
set_time_limit(6000);
session_write_close();
$erreur="";$data="";
$sql_req="select f2.document,f2.doc_cleunik,f2.hash from _w_import_acteurs f1,_documents f2  where f1.imp_cleunik=$vl_e_imp_cleunik and f2.doc_cleunik=f1.doc_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result); 
$doc_cleunik=$row['doc_cleunik'];
//echo $sql_req;
if (fa_verif_droit($doc_cleunik)==false) {$erreur="Pas le droit d'accès à ce fichier";}
$path="mail/".$row['hash'];
$handle_file=fopen($path, 'wb');
fwrite($handle_file, $row['document']);
fclose($handle_file);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
if ($erreur==""){
	if (!$handle_file = fopen($path, "r")) {
	  $erreur="Impossible d'ouvrir le fichier ($path)";
	} else {
		$vf_c_echo="";
		$row=0;
    while (($datacsv = fgetcsv($handle_file, 0, $sep)) !== FALSE) {
      $num = count($datacsv);
      $row++;
      if ($row==1) {
        if ($num>27) {
          $erreur="Le nombre de colonnes ($num) est incorrect (27 attendues, modèle 2).";
          break;
        }
      } else {
				$data.=('<quoi ');
				$data.=(' cola="'.fa_ent_xml($datacsv[ 0]).'"');
				$data.=(' colb="'.fa_ent_xml($datacsv[ 1]).'"');
				$data.=(' colc="'.fa_ent_xml($datacsv[ 2]).'"');
				$data.=(' cold="'.fa_ent_xml($datacsv[ 3]).'"');
				$data.=(' cole="'.fa_ent_xml($datacsv[ 4]).'"');
				$data.=(' colf="'.fa_ent_xml($datacsv[ 5]).'"');
				$data.=(' colg="'.fa_ent_xml($datacsv[ 6]).'"');
				$data.=(' colh="'.fa_ent_xml($datacsv[ 7]).'"');
				$data.=(' coli="'.fa_ent_xml($datacsv[ 8]).'"');
				$data.=(' colj="'.fa_ent_xml($datacsv[ 9]).'"');
				$data.=(' colk="'.fa_ent_xml($datacsv[10]).'"');
				$data.=(' coll="'.fa_ent_xml($datacsv[11]).'"');
				$data.=(' colm="'.fa_ent_xml($datacsv[12]).'"');
				$data.=(' coln="'.fa_ent_xml($datacsv[13]).'"');
				$data.=(' colo="'.fa_ent_xml($datacsv[14]).'"');
				$data.=(' colp="'.fa_ent_xml($datacsv[15]).'"');
				$data.=(' colq="'.fa_ent_xml($datacsv[16]).'"');
				$data.=(' colr="'.fa_ent_xml($datacsv[17]).'"');
				$data.=(' cols="'.fa_ent_xml($datacsv[18]).'"');
				$data.=(' colt="'.fa_ent_xml($datacsv[19]).'"');
				$data.=(' colu="'.fa_ent_xml($datacsv[20]).'"');
				$data.=(' colv="'.fa_ent_xml($datacsv[21]).'"');
				$data.=(' colw="'.fa_ent_xml($datacsv[22]).'"');
				$data.=(' colx="'.fa_ent_xml($datacsv[23]).'"');
				$data.=(' coly="'.fa_ent_xml($datacsv[24]).'"');
				$data.=(' colz="'.fa_ent_xml($datacsv[25]).'"');
				$data.=(' colaa="'.fa_ent_xml($datacsv[26]).'"');
				$data.=('/>');
      }
    }
	  fclose($handle_file);
		unlink($path);
	}
}
if ($erreur!=""){
	echo('<donnees>');
	echo('<quoi ');
  echo(' cola="'.fa_ent_xml($erreur).'"');
  echo('/>');
	echo('</donnees>');
} else {
	echo('<donnees>');
  echo($data);
	echo('</donnees>');
}
?>
