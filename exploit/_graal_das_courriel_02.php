<?php
header('Content-type: text/xml; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
require("_graal_fonctions_mail.php");
$result = _graal_requete_bd($sql_req);
$prop_obsolete="css_0001";
/*
echo('<sql data="');
echo("$sql_req");
echo('"</sql>');
*/
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
  echo(' int_cleunik="'.fa_ent_xml($row['int_cleunik']).'"');
  echo(' intweb_cleunik="'.fa_ent_xml($row['intweb_cleunik']).'"');
  if ($row['cr_verification']=="." ){
    echo(' cr_verification=""');
  } else {
    echo(' cr_verification="'.fa_ent_xml($row['cr_verification']).'"');
  }
  echo(' tri_cr_verification="'.fa_ent_xml($row['cr_verification']).'"');
  echo(' val_dateheureverification="'.fa_ent_xml($row['dateheureverification']).'"');
  if ($row['dateheureverification']==0) {
    echo(' dateheureverification=""');
  } else {
    echo(' dateheureverification="'.fa_ent_xml($row['dateheureverification']).'"');
  }
  echo(' raisonsoc="'.fa_ent_xml($row['raisonsoc']).'"');
  echo(' nc="'.fa_ent_xml($row['nc']).'"');
  echo(' civilite="'.fa_ent_xml($row['civilite']).'"');
  echo(' qui="'.fa_ent_xml($row['qui']).'"');
  echo(' prenom="'.fa_ent_xml($row['prenom']).'"');
  echo(' nom="'.fa_ent_xml($row['nom']).'"');
  echo(' refweb="'.fa_ent_xml($row['refweb']).'"');
  echo(' genreweb="'.fa_ent_xml($row['genreweb']).'"');
  echo(' portee="'.fa_ent_xml($row['portee']).'"');
  echo(' typeacteur="'.fa_ent_xml($row['typeacteur']).'"');
	
	echo(' blocnotebrut="'.fa_ent_xml($row['mail_blocnotebrut']).'"');
	
  switch ($row['mail_veuxpasdemail']) {
    case 1 : echo(' veuxpasdemail="'."ak16".'"');break;
    case 2 : echo(' veuxpasdemail="'."ak17".'"');break;
    case 3 : echo(' veuxpasdemail="'."ak18".'"');break;
    default : echo(' veuxpasdemail="'.$row['mail_veuxpasdemail'].'"');break;
  } 
  switch ($row['mail_valide']) {
    case 1 : echo(' valide="'."af16".'"');echo(' prop_mail=""');break;
    case 2 : echo(' valide="'."ae15".'"');echo(' prop_mail="'.$prop_obsolete.'"');break;
    case 3 : echo(' valide="'."af15".'"');echo(' prop_mail=""');break;
  } 
  if ($row['act_actif'] ==1) {
    echo(' prop_act=""');
  } else {
    echo(' prop_act="'.$prop_obsolete.'"');
  }
  if ($row['int_actif'] ==1) {
    echo(' prop_int=""');
  } else {
    echo(' prop_int="'.$prop_obsolete.'"');
  }
  switch ($vl_e_masse) {
    case 0:break; //  Raf
    case 3: //  Contrôle syntaxe courriel
      $vl_c_mailacontroler=$row['refweb'];
      if(!ff_verifie($vl_c_mailacontroler)){ $vl_c_syntaxe_courriel="Attention, syntaxiquement, $vl_c_mailacontroler n'est pas une adresse e-mail valide.";
      } else {
        $vl_c_syntaxe_courriel="Syntaxiquement, $vl_c_mailacontroler est une adresse e-mail valide.";
        //$vl_c_syntaxe_courriel="Ok";
      }
      echo(' controle_01="'.fa_ent_xml($vl_c_syntaxe_courriel).'"');
      break;
    case 4: //  Contrôle existence, utilisabilité
      $vl_c_mailacontroler=$row['refweb'];
      $retour=verif_email($vl_c_mailacontroler,false);
      $sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification='".addslashes($retour[1])."' where intweb_cleunik=".$row['intweb_cleunik'].";";
      $result_01=_graal_requete_bd($sql_req_01);
      $vl_c_syntaxe_courriel=$retour[1];
      echo(' controle_01="'.fa_ent_xml($vl_c_syntaxe_courriel).'"');
     switch ($retour[0]) {
     	case 3:
					echo(' prop_controle_01="ae05"');
					break;
     		case false:	
					echo(' prop_controle_01="ad14"');
					break;
      	case true:
	        echo(' prop_controle_01="ad13"');
					break;
				
      }
      break;
    default:
      break;
  }
  echo('/>'.EOL);
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
