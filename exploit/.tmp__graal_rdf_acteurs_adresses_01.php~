<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
define('EOL', "\r\n");
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','-1'));
$vf_c_genre=fa_recup_param('vf_c_genre','');
$vl_c_qui=fa_recup_param('vl_c_qui','nobody');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_e_typeacteur=intval(fa_recup_param('vl_e_typeacteur','0'));
$vl_c_recherche=fa_recup_param('vl_c_recherche','A');
$vl_c_difzero=fa_recup_param('vl_c_difzero','O');
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');  
$vl_c_sortie=fa_recup_param('sortie','rdf');
$vl_c_limit=fa_recup_param('limit','250');
// execution de la requète SQL
switch ($vf_c_genre) {
  case 'A': //  Sélection des adresses d'un tiers
//    $sql_req = "SELECT _act_adresses.adr_cleunik AS adr_cleunik,_act_adresses.act_cleunik AS act_cleunik,_act_adresses.adr_complementnom AS adr_complementnom, _act_adresses.adr_ligne1 AS adr_ligne1,_act_adresses.adr_ligne2 AS adr_ligne2,_act_adresses.adr_ligne3 AS adr_ligne3,_act_adresses.adr_cp AS adr_cp,_act_adresses.adr_ville AS adr_ville,_act_adresses.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS pays,_acteurs.raisonsoc AS raison_soc,_acteurs.nomcommercial AS nomcommercial,_acteurs.typeacteur AS typeacteur,_act_adresses.adr_latitude AS adr_latitude,_act_adresses.adr_longitude AS adr_longitude,_act_adresses.adr_typecoordonnees AS adr_typecoordonnees,alias01_choix.choix_valeur_texte_01 AS adr_typecoordonnees_enclair FROM _acteurs, _act_adresses, _choix,_choix alias01_choix  WHERE _acteurs.act_cleunik = _act_adresses.act_cleunik AND _choix.choix_cleunik = _act_adresses.choix_cleunik AND alias01_choix.choix_cleunik = _act_adresses.adr_typecoordonnees AND _act_adresses.act_cleunik IN ($vl_e_act_cleunik)";
    $sql_req = "SELECT _act_adresses.adr_cleunik AS adr_cleunik,_act_adresses.act_cleunik AS act_cleunik,_act_adresses.adr_complementnom AS adr_complementnom, _act_adresses.adr_ligne1 AS adr_ligne1,_act_adresses.adr_ligne2 AS adr_ligne2,_act_adresses.adr_ligne3 AS adr_ligne3,_act_adresses.adr_cp AS adr_cp,_act_adresses.adr_ville AS adr_ville,_act_adresses.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS pays,_acteurs.raisonsoc AS raison_soc,_acteurs.nomcommercial AS nomcommercial,_acteurs.typeacteur AS typeacteur,_act_adresses.adr_latitude AS adr_latitude,_act_adresses.adr_longitude AS adr_longitude,_act_adresses.adr_typecoordonnees AS adr_typecoordonnees FROM _acteurs, _act_adresses, _choix WHERE _acteurs.act_cleunik = _act_adresses.act_cleunik AND _choix.choix_cleunik = _act_adresses.choix_cleunik AND _act_adresses.act_cleunik IN ($vl_e_act_cleunik)";

    break;
  case 'B': //  Sélection des adresses des tiers avec des coordonnées géo-physiques
//    $sql_req = "SELECT _act_adresses.adr_cleunik AS adr_cleunik,_act_adresses.act_cleunik AS act_cleunik,_act_adresses.adr_complementnom AS adr_complementnom, _act_adresses.adr_ligne1 AS adr_ligne1,_act_adresses.adr_ligne2 AS adr_ligne2,_act_adresses.adr_ligne3 AS adr_ligne3,_act_adresses.adr_cp AS adr_cp,_act_adresses.adr_ville AS adr_ville,_act_adresses.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS pays,_acteurs.raisonsoc AS raison_soc,_acteurs.nomcommercial AS nomcommercial,_acteurs.typeacteur AS typeacteur,_act_adresses.adr_latitude AS adr_latitude,_act_adresses.adr_longitude AS adr_longitude,_act_adresses.adr_typecoordonnees AS adr_typecoordonnees,_choixact.choix_valeur_texte_01 as portee,alias01_choix.choix_valeur_texte_01 AS adr_typecoordonnees_enclair,_acteurs.codealphanum15 AS codealphanum15,_acteurs.mnemotechnique AS mnemotechnique FROM _acteurs, _act_adresses, _choix,_choix _choixact,_choix alias01_choix WHERE _acteurs.act_cleunik = _act_adresses.act_cleunik AND _choix.choix_cleunik = _act_adresses.choix_cleunik  and _choixact.choix_cleunik = _acteurs.typeacteur AND alias01_choix.choix_cleunik = _act_adresses.adr_typecoordonnees ";
    $sql_req = "SELECT _act_adresses.adr_cleunik AS adr_cleunik,_act_adresses.act_cleunik AS act_cleunik,_act_adresses.adr_complementnom AS adr_complementnom, _act_adresses.adr_ligne1 AS adr_ligne1,_act_adresses.adr_ligne2 AS adr_ligne2,_act_adresses.adr_ligne3 AS adr_ligne3,_act_adresses.adr_cp AS adr_cp,_act_adresses.adr_ville AS adr_ville,_act_adresses.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS pays,_acteurs.raisonsoc AS raison_soc,_acteurs.nomcommercial AS nomcommercial,_acteurs.typeacteur AS typeacteur,_act_adresses.adr_latitude AS adr_latitude,_act_adresses.adr_longitude AS adr_longitude,_act_adresses.adr_typecoordonnees AS adr_typecoordonnees,_choixact.choix_valeur_texte_01 as portee,_acteurs.codealphanum15 AS codealphanum15,_acteurs.mnemotechnique AS mnemotechnique FROM _acteurs, _act_adresses, _choix,_choix _choixact WHERE _acteurs.act_cleunik = _act_adresses.act_cleunik AND _choix.choix_cleunik = _act_adresses.choix_cleunik  and _choixact.choix_cleunik = _acteurs.typeacteur ";

    switch ($vl_c_difzero){
      case "N":break;
      case "O":$sql_req .=" AND (_act_adresses.adr_latitude<>0 and _act_adresses.adr_longitude<>0)";break; 
    }
    switch ($vl_e_typeacteur)  {
      case '999999':break;
      case '110000':
      case '110001':
      case '110002':
      case '110003':
      case '110004':
      case '110005':
      case '110006':
        $sql_req.=" and _acteurs.typeacteur IN ($vl_e_typeacteur)";
        break;
      case '888888' : $sql_req.=" and _acteurs.act_cleunik IN (SELECT _acteurs_favoris.act_cleunik from _acteurs_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;
      default : $sql_req.=" and _acteurs.typeacteur IN ($vl_e_typeacteur)";break;
    }
    switch ($vl_c_actifs) {
      case '1': $sql_req.=" and _acteurs.actif=1";break; //  actifs
      case '2': $sql_req.=" and _acteurs.actif=2";break;//  inactifs
      case '0': break;//  tous
    }
    switch ($vl_c_zone)  {
      case '1' : $sql_req.=" and _acteurs.raisonsoc like '$vl_c_recherche%' order by _acteurs.raisonsoc ASC";break;             // Raison sociale
      case '2' : $sql_req.=" and _acteurs.nomcommercial like '$vl_c_recherche%' order by _acteurs.nomcommercial ASC ";break;    // Nom commercial
      case '3' : $sql_req.=" and _acteurs.codealphanum15 like '$vl_c_recherche%' order by _acteurs.codealphanum15 ASC";break;   // Code
      case '4' : $sql_req.=" and _acteurs.mnemotechnique like '$vl_c_recherche%' order by _acteurs.mnemotechnique ASC ";break;  // Mnémotechnique
      case '5' : $sql_req.=" and _act_adresses.adr_cp like '$vl_c_recherche%' order by _act_adresses.adr_cp ASC";break;         // Code postal
      case '6' : $sql_req.=" and _act_adresses.adr_ville like '$vl_c_recherche%' order by _act_adresses.adr_ville ASC ";break;  // Ville
    }
    $sql_req.=" limit $vl_c_limit";
    break;
}
//echo($sql_req.EOL);
//echo($vl_c_sortie.EOL);
$result = _graal_requete_bd($sql_req);
switch ($vl_c_sortie) {
  case "das":
    header('Content-type: text/xml; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
      echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
      echo(' choix_cleunik="'.fa_ent_xml($row['choix_cleunik']).'"');
      echo(' adr_cleunik=">'.fa_ent_xml($row['adr_cleunik']).'"');
      echo(' portee="'.fa_ent_xml($row['portee']).'"');
      echo(' raison_soc="'.fa_ent_xml($row['raison_soc']).'"');
      echo(' typeacteur="'.fa_ent_xml($row['typeacteur']).'"');
      echo(' adr_typecoordonnees="'.fa_ent_xml($row['adr_typecoordonnees']).'"');
      echo(' complementnom="'.fa_ent_xml($row['adr_complementnom']).'"');
      echo(' adr_ligne1="'.fa_ent_xml($row['adr_ligne1']).'"');
      echo(' adr_ligne2="'.fa_ent_xml($row['adr_ligne2']).'"');
      echo(' adr_ligne3="'.fa_ent_xml($row['adr_ligne3']).'"');
      echo(' adr_cp="'.fa_ent_xml($row['adr_cp']).'"');
      echo(' departement=""');
      echo(' adr_ville="'.fa_ent_xml($row['adr_ville']).'"');
      echo(' adr_pays="'.fa_ent_xml($row['pays']).'"');
      echo(' adr_latitude="'.fa_ent_xml($row['adr_latitude']).'"');
      echo(' adr_longitude="'.fa_ent_xml($row['adr_longitude']).'"');
      echo(' nomcommercial="'.fa_ent_xml($row['nomcommercial']).'"');
      echo(' adr_typecoordonnees_enclair="'.fa_ent_xml($row['adr_typecoordonnees_enclair']).'"');
      echo(' codealphanum15="'.fa_ent_xml($row['codealphanum15']).'"');
      echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
      echo('/>');
		}
		echo('</donnees>');
    break;
  case "xul":
$vl_c_jscript=<<<EOT
    <script type="application/x-javascript"><![CDATA[
    const vf_c_fen_adr="_graal_fen_act_adresses_01.php?";
    const vf_c_carte='_graal_loc_01.php';
    function pf_ouvre_adresse(adr_cleunik,act_cleunik,type_acteur) {
      var vl_c_param;
      vl_c_param="genreacteur="+type_acteur+"&";
      vl_c_param+='vl_e_adr_cleunik='+fa_enc(adr_cleunik)+"&vl_e_act_cleunik="+act_cleunik+'&';
      fa_ouvre(vf_c_fen_adr+vl_c_param,600,350)
    }
    function pf_ouvre_google_maps(vl_c_lat,vl_c_lon,vl_c_adr_raison_soc) {
      fa_ouvre(vf_c_carte+'?vl_c_lat='+vl_c_lat+'&vl_c_lon='+vl_c_lon+'&vl_c_adr_raison_soc='+fa_enc(vl_c_adr_raison_soc)+'&');
    }
    ]]></script>
EOT;
    header('Content-type: application/vnd.mozilla.xul+xml');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    include("_graal_header_winxul.inc.php");
    echo('<window class="transparent" id="_graal_das_acteurs_adresses_01.php" xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul" onload="fa_aa(this);">');
    echo $vl_c_jscript;
    include("_graal_visites.inc.php");
    include("js/_graal_01.js.php");
    echo ('<vbox flex="1" id="adressespostales_01" class="overflow_01">');
    $nb=0;
    while ($row = mysql_fetch_assoc($result)){
      $vl_adr_complementnom=fa_remplace_quotes(fa_ent_xml($row['adr_complementnom']));
      $vl_adr_ligne1=fa_remplace_quotes(fa_ent_xml($row['adr_ligne1']));
      $vl_adr_ligne2=fa_remplace_quotes(fa_ent_xml($row['adr_ligne2']));
      $vl_adr_ligne3=fa_remplace_quotes(fa_ent_xml($row['adr_ligne3']));
      $vl_adr_cp=fa_remplace_quotes(fa_ent_xml($row['adr_cp']));
      $vl_adr_ville=fa_remplace_quotes(fa_ent_xml($row['adr_ville']));
      $vl_pays=fa_remplace_quotes(fa_ent_xml($row['pays']));
      $vl_adr_latitude=fa_remplace_quotes(fa_ent_xml($row['adr_latitude']));
      $vl_adr_longitude=fa_remplace_quotes(fa_ent_xml($row['adr_longitude']));
      $vl_adr_typecoordonnees=fa_remplace_quotes(fa_ent_xml($row['adr_typecoordonnees']));
      $vl_raison_soc=fa_remplace_quotes(fa_ent_xml($row['raison_soc']));
      $nb++;
      if ($nb&1)
        echo("<groupbox class='rose_01'>"); //  impair
      else
        echo("<groupbox class='jaune_01'>"); //  pair
      echo ('<hbox>');
      echo ('<vbox>');
      echo("<toolbarbutton class='aj12' tooltiptext='Ouvrir la fiche adresse' oncommand='pf_ouvre_adresse(\"".fa_remplace_quotes(fa_ent_xml($row['adr_cleunik']))."\",\"".fa_remplace_quotes(fa_ent_xml($row['act_cleunik']))."\",\"".fa_remplace_quotes(fa_ent_xml($row['typeacteur']))."\")' />");
      if ($vl_adr_complementnom!="") {echo ("<label value='$vl_adr_complementnom'/>");}
      if ($vl_adr_ligne1!="") {echo ("<label value='$vl_adr_ligne1'/>");}  
      if ($vl_adr_ligne2!="") {echo ("<label value='$vl_adr_ligne2'/>");}
      if ($vl_adr_ligne3!="") {echo ("<label value='$vl_adr_ligne3'/>");}
      if ($vl_adr_cp!="") {echo ("<hbox><label value='$vl_adr_cp'/><label value='$vl_adr_ville'/></hbox>");}
      $ml_pays=fa_brik_menulist_choix("xxx",1,-1,1,fa_ent_xml($row['choix_cleunik']),'ml_pays',"broadcaster_01",60000); //  France par défaut
      echo $ml_pays;
      if ($vl_adr_latitude!="0.000000") {
        echo("<toolbarbutton class='aj12' tooltiptext='Localiser sur google maps' label='Latitude $vl_adr_latitude Longitude $vl_adr_longitude' oncommand='pf_ouvre_google_maps(\"$vl_adr_latitude\",\"$vl_adr_longitude\",\"$vl_raison_soc\")' />");
      }  
      echo ('</vbox>');
      $cb_adresses=fa_brik_checkbox_choix(98,1,-1,1,'','cb_adresse_00',"broadcaster_01",$vl_adr_typecoordonnees,true,true);
      echo $cb_adresses;
      echo ('</hbox>');
      echo("</groupbox>");
    }
    
    echo ('</vbox>');
    echo ('</window>');
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
