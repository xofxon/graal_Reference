<?php
include_once("_graal_fonctions_cryptage.php");
function fa_brik_ajout_rss_action($vv_flex="1",$vv_id="",$vv_observer="",$vv_proc=""){
	$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
  $sql_req = "select f1.doc_cleunik,f2.nom,f2.genre,f3.prenom,f3.patronyme,f4.titre,f4.descriptif_sommaire from _droits_doc f1 inner join _documents_rss f2 using (doc_cleunik) inner join _utilisateur f3 on f1.uti_cleunik=f3.uti_cleunik inner join _documents f4 using(doc_cleunik) where f1.uti_cleunik=$vl_e_uti_cleunik and f2.genre=1";
  $sql_result = _graal_requete_bd($sql_req);
  $vv_brik="";
	if (mysql_num_rows($sql_result) != 0){
  	if ($vv_id!=""){
			if ($vv_observer!="") {
	   		$vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id' observer='$vv_observer'><menupopup>";
		  } else {
		    $vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id'><menupopup>";
		  }
		}
    while ($row = mysql_fetch_assoc($sql_result)){
    	$vl_c_label="Ajouter une action au flux ".fa_remplace_quotes(fa_ent_xml($row['titre']."[".$row['descriptif_sommaire']."]")."-".$row['prenom']." ".$row['patronyme']."-");
      $vv_brik.="<menuitem class='ai10' value='" .$row['doc_cleunik']. "' label='".$vl_c_label."' oncommand='$vv_proc(this.value,\"action\");'/>";
    }
   	if ($vv_id!=""){
			$vv_brik.="</menupopup></menulist>";
		}
  }
  _graal_libere_requete_bd($sql_result);
  return $vv_brik; 
}
function fa_rss_cree_corpus($vf_e_doc_cleunik){
	$EOL="\r\n";
	$vl_c_url_absolue=fa_url_absolue();
	$sql_req="SELECT f1.descriptif_sommaire,f1.titre,f2.nom,f2.nb_affiche,f2.typeacces,f2.niveauacces,f3.c_uuid from _documents f1 inner join _documents_rss f2 using(doc_cleunik) inner join _utilisateur f3 using (uti_cleunik) where f1.doc_cleunik=$vf_e_doc_cleunik;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$vf_c_nb_affichages=$row['nb_affiche'];
	$vl_c_nom=$row['nom'];
	$vl_c_typeacces=$row['typeacces'];
	$vl_c_niveauacces=$row['niveauacces'];
	$vl_c_uuid_utilisateur=$row['c_uuid'];
	/*
	switch ($vl_c_niveauacces){
		case "1":	//	Accès aux informations connexes également
			$param="id=";
			break;
		case "2":	//	Accès restreint
			$param="cle=";
			break;
	}
	*/

	_graal_libere_requete_bd($result);
	switch ($vl_c_typeacces) {
		case 1:	//	rss local, privé
		case 3:	//	local et externe, privé et public
	/*
	 * Premier passage : on crèe en interne
	 */			
			$xml = fa_rss_cree_entete_01($vl_c_url_absolue,$vl_c_nom,$row['titre'],$row['descriptif_sommaire']);
			$sql_req = "SELECT 'actions' as genre,f1.ordre as ordre,f1.action_cleunik as c00,f2.sujet as c01,f2.description as c02,f1.dateheurecreation as c03,";
			$sql_req.= _graalsql_date('dateheuredebut')." as `c04`,"._graalsql_time('dateheuredebut')." as `c05`,";
			$sql_req.= "f3.choix_valeur_texte_01 as `c06`,";
			$sql_req.= "f1.c_uuid as `c07`";
			$sql_req.= " from _documents_rss_actions f1 inner join _actions f2 using(action_cleunik) inner join _choix f3 on f3.choix_cleunik=f2.choix_cleunik where f1.doc_cleunik=$vf_e_doc_cleunik and etat=1 order by ordre desc limit $vf_c_nb_affichages;";
			//echo $sql_req;
			$result = _graal_requete_bd($sql_req);
		  while ($row = mysql_fetch_assoc($result)){
		  	switch ($row['genre']) {
		  		case 'actions':
						$action_cleunik=$row['c00'];
		$sql_req_01=<<<EOT
		select concat_ws(_utf8' ',`f7`.`prenom`,`f7`.`patronyme`,_utf8'(',`f6`.`raisonsoc`,_utf8')') AS `qui_interlo`
		from ((`_graal` `f1` left join `_acteurs` `f6` on((`f1`.`act_cleunik` = `f6`.`act_cleunik`))) left join `_act_interlo` `f7` on((`f1`.`int_cleunik` = `f7`.`int_cleunik`))) 
		where ((`f1`.`principal` = 2) and (`f1`.`portee` = 4096)) AND f1.action_cleunik=$action_cleunik
		union 
		select `f6`.`raisonsoc` AS `qui_interlo`
		from (`_graal` `f1` left join `_acteurs` `f6` on((`f1`.`act_cleunik` = `f6`.`act_cleunik`))) where ((`f1`.`principal` = 2) and (`f1`.`portee` = 8192)) AND f1.action_cleunik=$action_cleunik		
EOT;
					  $result_01 = _graal_requete_bd($sql_req_01);
					  $row_01 = mysql_fetch_assoc($result_01);
						$qui_interlo=$row_01['qui_interlo'];
					  _graal_libere_requete_bd($result_01);
						$titre = $row['c01'];
						$vsid_uuid=$_SESSION["vsid_uuid"];
						$id_param="id=".urlencode(fa_mcrypte("id_flux_rss",$row['c07']."|".$vl_c_uuid_utilisateur."|"."action_ouvrir"."|".$vsid_uuid,"chiffrer"));
						$chemin=$vl_c_url_absolue."_graal_fen_rss_00.php?".$id_param."&";
						$id_param="id=".urlencode(fa_mcrypte("id_flux_rss",$row['c07']."|".$vl_c_uuid_utilisateur."|"."action_lire"."|".$vsid_uuid,"chiffrer"));
						$chemin_lu=$vl_c_url_absolue."_graal_fen_rss_00.php?".$id_param."&";
						//$chemin_lu=$vl_c_url_absolue."_graal_bdope_rss_01.php?".$id_param."&quoi=lu&";
		    		$news = "Le ".$row['c04'].' à '.$row['c05'].' : '.$row['c06']." : ".$row['c02'].'<br>';
						$news.= $qui_interlo."<br>";
						$news.= "<br>"."<br>";
						$news.= '<a style="font-style: italic; color: rgb(0, 0, 153);" href="'.$chemin_lu.'" target="_blank">Cliquez ici pour signifier la lecture.</a>';
						$news.= "<br>"."<br>";
						$date_mysql=$row['c03'];
				    if (($timestamp = strtotime($date_mysql)) === false) {
			        $dateheure=$date_mysql.' GMT';
		      	} else {
		      		$dateheure=date('D, d M Y H:i:s ', $timestamp).date('O', $timestamp);//	Pour bonne gestion des décalages horaires heure d'été heure d'hiver
		      	}
						$xml .='<item>'.$EOL;
				    //$xml .='<author>'.$row['prenom'].' '.$row['patronyme'].'</author>';
				    $xml .='<title><![CDATA['.$titre.']]></title>'.$EOL;
				    $xml .='<link><![CDATA['.$chemin.']]></link>'.$EOL;
				    $xml .='<pubDate><![CDATA['.$dateheure.']]></pubDate>'.$EOL;
				    $xml .='<guid><![CDATA['.$chemin.']]></guid>'.$EOL;
				    $xml .='<comments><![CDATA['.$chemin.']]></comments>'.$EOL;
				    $xml .='<description><![CDATA[';
				    $xml .= $news;
				    $xml .=']]></description>'.$EOL;
				    $xml .='</item>'.$EOL;
		  		break;
		  	}
			}
			$xml .='</channel></rss>';
			_graal_libere_requete_bd($result);
			fa_rss_ecrire_flux($vl_c_nom,$xml,$vl_c_typeacces);
			return $xml;
	}
	switch ($vl_c_typeacces) {
		case 2:	//	externe, public
		case 3:	//	local et externe, privé et public
	/*
	 * Deuxième passage : on crèe en externe
	 */			
			$xml = fa_rss_cree_entete_01($vl_c_url_absolue,$vl_c_nom,$row['titre'],$row['descriptif_sommaire']);
			$sql_req = "SELECT 'actions' as genre,f1.ordre as ordre,f1.action_cleunik as c00,f2.sujet as c01,f2.description as c02,f1.dateheurecreation as c03,";
			$sql_req.= _graalsql_date('dateheuredebut')." as `c04`,"._graalsql_time('dateheuredebut')." as `c05`,";
			$sql_req.= "f3.choix_valeur_texte_01 as `c06`,";
			$sql_req.= "f1.c_uuid as `c07`";
			$sql_req.= " from _documents_rss_actions f1 inner join _actions f2 using(action_cleunik) inner join _choix f3 on f3.choix_cleunik=f2.choix_cleunik where f1.doc_cleunik=$vf_e_doc_cleunik and etat=1 order by ordre desc limit $vf_c_nb_affichages;";
			//echo $sql_req;
			$result = _graal_requete_bd($sql_req);
		  while ($row = mysql_fetch_assoc($result)){
		  	switch ($row['genre']) {
		  		case 'actions':
						$action_cleunik=$row['c00'];
		$sql_req_01=<<<EOT
		select concat_ws(_utf8' ',`f7`.`prenom`,`f7`.`patronyme`,_utf8'(',`f6`.`raisonsoc`,_utf8')') AS `qui_interlo`
		from ((`_graal` `f1` left join `_acteurs` `f6` on((`f1`.`act_cleunik` = `f6`.`act_cleunik`))) left join `_act_interlo` `f7` on((`f1`.`int_cleunik` = `f7`.`int_cleunik`))) 
		where ((`f1`.`principal` = 2) and (`f1`.`portee` = 4096)) AND f1.action_cleunik=$action_cleunik
		union 
		select `f6`.`raisonsoc` AS `qui_interlo`
		from (`_graal` `f1` left join `_acteurs` `f6` on((`f1`.`act_cleunik` = `f6`.`act_cleunik`))) where ((`f1`.`principal` = 2) and (`f1`.`portee` = 8192)) AND f1.action_cleunik=$action_cleunik		
EOT;
					  $result_01 = _graal_requete_bd($sql_req_01);
					  $row_01 = mysql_fetch_assoc($result_01);
						$qui_interlo=$row_01['qui_interlo'];
					  _graal_libere_requete_bd($result_01);
						$titre = $row['c01'];
						$vsid_uuid=$_SESSION["vsid_uuid"];
						$id_param="id=".urlencode(fa_mcrypte("id_flux_rss",$row['c07']."|".$vl_c_uuid_utilisateur."|"."action_ouvrir"."|".$vsid_uuid,"chiffrer"));
						$chemin=$vl_c_url_absolue."_graal_fen_rss_00.php?".$id_param."&";
						$id_param="id=".urlencode(fa_mcrypte("id_flux_rss",$row['c07']."|".$vl_c_uuid_utilisateur."|"."action_lire"."|".$vsid_uuid,"chiffrer"));
						$chemin_lu=$vl_c_url_absolue."_graal_fen_rss_00.php?".$id_param."&";
						//$chemin_lu=$vl_c_url_absolue."_graal_bdope_rss_01.php?".$id_param."&quoi=lu&";
		    		$news = "Le ".$row['c04'].' à '.$row['c05'].' : '.$row['c06']." : ".$row['c02'].'<br>';
						$news.= $qui_interlo."<br>";
						$news.= "<br>"."<br>";
						$news.= '<a style="font-style: italic; color: rgb(0, 0, 153);" href="'.$chemin_lu.'" target="_blank">Cliquez ici pour signifier la lecture.</a>';
						$news.= "<br>"."<br>";
						$date_mysql=$row['c03'];
				    if (($timestamp = strtotime($date_mysql)) === false) {
			        $dateheure=$date_mysql.' GMT';
		      	} else {
		      		$dateheure=date('D, d M Y H:i:s ', $timestamp).date('O', $timestamp);//	Pour bonne gestion des décalages horaires heure d'été heure d'hiver
		      	}
						$xml .='<item>'.$EOL;
				    //$xml .='<author>'.$row['prenom'].' '.$row['patronyme'].'</author>';
				    $xml .='<title><![CDATA['.$titre.']]></title>'.$EOL;
				    $xml .='<link><![CDATA['.$chemin.']]></link>'.$EOL;
				    $xml .='<pubDate><![CDATA['.$dateheure.']]></pubDate>'.$EOL;
				    $xml .='<guid><![CDATA['.$chemin.']]></guid>'.$EOL;
				    $xml .='<comments><![CDATA['.$chemin.']]></comments>'.$EOL;
				    $xml .='<description><![CDATA[';
				    $xml .= $news;
				    $xml .=']]></description>'.$EOL;
				    $xml .='</item>'.$EOL;
		  		break;
		  	}
			}
			$xml .='</channel></rss>';
			_graal_libere_requete_bd($result);
			fa_rss_ecrire_flux($vl_c_nom,$xml,$vl_c_typeacces);
			return $xml;
	}



}
function fa_rss_cree_entete_01($vl_c_url_absolue,$vl_c_nom,$vl_c_titre,$vl_c_descriptif_sommaire) {
	$localisation_flux="http://rss.xsoftware.fr/";
	$EOL="\r\n";
	$dateheure=date('D, d M Y H:i:s ').date('O');//	Pour bonne gestion des décalages horaires heure d'été heure d'hiver
	$vl_c_entete='';
	$vl_c_entete .= '<?xml version="1.0" encoding="UTF-8"?>'.$EOL;
	$vl_c_entete .= '<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">'.$EOL;
	$vl_c_entete .= '<channel>'.$EOL;
	$vl_c_entete .= '<atom:link href="'.$localisation_flux.$vl_c_nom.'" rel="self" type="application/rss+xml" />'.$EOL;
	$vl_c_entete .='<link><![CDATA[http://www.xsoftware.fr]]></link>'.$EOL;
	$vl_c_entete .='<managingEditor><![CDATA[developpements@xsoftware.fr (Christophe Charron)]]></managingEditor>'.$EOL;
	$vl_c_entete .='<generator><![CDATA[XsOFtware Application de gestion en ligne pour les TPE]]></generator>'.$EOL;
	$vl_c_entete .='<copyright><![CDATA[Copyright 2009 xsoftware.fr]]></copyright>'.$EOL;
	$vl_c_entete .='<webMaster><![CDATA[developpements@xsoftware.fr (Christophe Charron)]]></webMaster>'.$EOL;
	$vl_c_entete .='<language><![CDATA[fr-fr]]></language>'.$EOL;
	$vl_c_entete .='<title><![CDATA['.$vl_c_titre.']]></title>'.$EOL;
	$vl_c_entete .='<description><![CDATA['.$vl_c_descriptif_sommaire.']]></description>'.$EOL;
	$vl_c_entete .='<lastBuildDate><![CDATA['.$dateheure.']]></lastBuildDate>'.$EOL;
	$vl_c_entete .='<ttl>10</ttl>'.$EOL;

	//$vl_c_entete .='<lastBuildDate>
	return $vl_c_entete;
}
function fa_rss_ecrire_flux($vl_c_nom,$vl_c_flux,$vf_c_type){
	$vl_c_nom_prive="rss/".$vl_c_nom;
	$vl_c_nom_publi="/home/xsoftwar/sd/rss/www/".$vl_c_nom;
	if (file_exists($vl_c_nom_prive)) {
		if (unlink($vl_c_nom_prive)=== FALSE){
      echo "Impossible d'effectuer la suppression initiale du fichier ($vl_c_nom_prive)";
			exit;
		}
	}
  if (!$handle = fopen($vl_c_nom_prive, 'x+')) {
    echo "Impossible d'ouvrir le fichier ($vl_c_nom_prive)";
    exit;
  } else {
	  if (fwrite($handle, $vl_c_flux) === FALSE) {
	    echo "Impossible d'écrire dans le fichier ($vl_c_nom_prive)";
	    exit;
	  }
	  //echo "L'écriture dans le fichier ($vl_c_nom) a réussi";
  }
  fclose($handle);
	switch ($vf_c_type) {
		case 1:	//	rss local, privé
			break;
		case 2:	//	externe, public
		case 3:	//	local et externe, privé et public
			error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);
			//	planterait en exécution locale
				if (file_exists($vl_c_nom_publi)) {
					if (unlink($vl_c_nom_publi)=== FALSE){
			      //echo "Impossible d'effectuer la suppression initiale du fichier ($vl_c_nom_publi)";
						$raf="";
					}
				}
			  if (!$handle = fopen($vl_c_nom_publi, 'x+')) {
			    //echo "Impossible d'ouvrir le fichier ($vl_c_nom_publi)";
					$raf="";
			  } else {
			  	if (fwrite($handle, $vl_c_flux) === FALSE) {
			    	//echo "Impossible d'écrire dans le fichier ($vl_c_nom_publi)";
						$raf="";
			 		}
			  }
		break;
	}
}

/*
	RSS Extractor and Displayer
	(c) 2007  Scriptol.com - Licence Mozilla 1.1.
	rsslib.php
	
	Requirements:
	- PHP 5.
	- A RSS feed.
	
	Using the library:
	Insert this code into the page that displays the RSS feed:
	
*/

$RSS_Content = array();

function RSS_Tags_Channel($item, $type)
{
		$y = array();
		$tnl = $item->getElementsByTagName("title");
		$tnl = $tnl->item(0);
		$title = $tnl->firstChild->data;

		$tnl = $item->getElementsByTagName("link");
		$tnl = $tnl->item(0);
		$link = $tnl->firstChild->data;

		$tnl = $item->getElementsByTagName("description");
		$tnl = $tnl->item(0);
		$description = $tnl->firstChild->data;

		$y["title"] = $title;
		//$y["link"] = $link;
		$y["description"] = $description;
		$y["type"] = $type;
		
		return $y;
}
function RSS_Tags_Item($item, $type)
{
		$y = array();
		$tnl = $item->getElementsByTagName("title");
		$tnl = $tnl->item(0);
		$title = $tnl->firstChild->data;

		$tnl = $item->getElementsByTagName("link");
		$tnl = $tnl->item(0);
		$link = $tnl->firstChild->data;

		$tnl = $item->getElementsByTagName("description");
		$tnl = $tnl->item(0);
		$description = $tnl->firstChild->data;

		$y["title"] = $title;
		$y["link"] = $link;
		$y["description"] = $description;
		$y["type"] = $type;
		
		return $y;
}


function RSS_Channel($channel)
{
	global $RSS_Content;

	$items = $channel->getElementsByTagName("item");
	
	// Processing channel
	
	$y = RSS_Tags_Channel($channel, 0);		// get description of channel, type 0
	array_push($RSS_Content, $y);
	
	// Processing articles
	
	foreach($items as $item)
	{
		$y = RSS_Tags_Item($item, 1);	// get description of article, type 1
		array_push($RSS_Content, $y);
	}
}

function RSS_Retrieve($url)
{
	global $RSS_Content;

	$doc  = new DOMDocument();
	$doc->load($url);

	$channels = $doc->getElementsByTagName("channel");
	
	$RSS_Content = array();
	
	foreach($channels as $channel)
	{
		 RSS_Channel($channel);
	}
	
}


function RSS_RetrieveLinks($url)
{
	global $RSS_Content;

	$doc  = new DOMDocument();
	$doc->load($url);

	$channels = $doc->getElementsByTagName("channel");
	
	$RSS_Content = array();
	
	foreach($channels as $channel)
	{
		$items = $channel->getElementsByTagName("item");
		foreach($items as $item)
		{
			$y = RSS_Tags_Item($item, 1);	// get description of article, type 1
			array_push($RSS_Content, $y);
		}
		 
	}

}


function RSS_Links($url, $size)
{
	global $RSS_Content;

	$page = "<ul>";

	RSS_RetrieveLinks($url);
	if($size > 0)
		$recents = array_slice($RSS_Content, 0, $size);

	foreach($recents as $article)
	{
		$type = $article["type"];
		if($type == 0) continue;
		$title = $article["title"];
		$link = $article["link"];
		$page .= "<li><a href=\"$link\">$title</a></li>\n";			
	}

	$page .="</ul>\n";

	return $page;
	
}



function RSS_Display($url, $size)
{
	global $RSS_Content;

	$opened = false;
	$page = "";

	RSS_Retrieve($url);
	if($size > 0)
		$recents = array_slice($RSS_Content, 0, $size);

	foreach($recents as $article)
	{
		$type = $article["type"];
		if($type == 0)
		{
			if($opened == true)
			{
				$page .="</ul>\n";
				$opened = false;
			}
			$page .="<b>";
		}
		else
		{
			if($opened == false) 
			{
				$page .= "<ul>\n";
				$opened = true;
			}
		}
		$title = $article["title"];
		$link = $article["link"];
		$description = $article["description"];
		$page .= "<li><a href=\"$link\" target='_blank'>$title </a>";
		if($description != false)
		{
			$page .= "<br>$description";
		}
		$page .= "</li>\n";			
		
		if($type==0)
		{
			$page .="</b><br />";
		}

	}

	if($opened == true)
	{	
		$page .="</ul>\n";
	}
	return $page."\n";
	
}

function RSS_Display_essai($url)
{
	global $RSS_Content;

	$opened = false;
	$page = "";

	RSS_Retrieve($url);
	$recents = array_slice($RSS_Content, 0, $size);
	var_dump($recents);
/*
	foreach($recents as $article)
	{
		$type = $article["type"];
		if($type == 0)
		{
			if($opened == true)
			{
				$page .="</ul>\n";
				$opened = false;
			}
			$page .="<b>";
		}
		else
		{
			if($opened == false) 
			{
				$page .= "<ul>\n";
				$opened = true;
			}
		}
		$title = $article["title"];
		$link = $article["link"];
		$description = $article["description"];
		$page .= "<li><a href=\"$link\" target='_blank'>$title </a>";
		if($description != false)
		{
			$page .= "<br>$description";
		}
		$page .= "</li>\n";			
		
		if($type==0)
		{
			$page .="</b><br />";
		}

	}

	if($opened == true)
	{	
		$page .="</ul>\n";
	}
	return $page."\n";
*/	
}
?>