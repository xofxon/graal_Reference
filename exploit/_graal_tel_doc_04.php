<?php
define('EOL', "\r\n");
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
include("_graal_fonctions_documents.php");
$vl_e_doc_cleunik=intval(fa_recup_param('vl_e_doc_cleunik','0'));
$vl_e_angle_rotation=intval(fa_recup_param('vl_e_angle_rotation','0'));
if (fa_verif_droit($vl_e_doc_cleunik)==false) {fa_redirige("document_interdit");}
$sql_req = "SELECT document AS pj, emplacement as nom,mime as mime,hash FROM _documents WHERE doc_cleunik=$vl_e_doc_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nom=$row['nom'];
$vl_e_trouve=preg_match("/.tif/i", $nom);
if ($vl_e_trouve==true){
	$sess_id=session_id();
	$path="mail/".$sess_id."_".$row['hash'];
	//echo $path;
	$handle_file=fopen($path, 'wb');
	fwrite($handle_file, $row['pj']);
	fclose($handle_file);
	$rotation="";
	if ($vl_e_angle_rotation!=0) {
		$rotation=" -rotate $vl_e_angle_rotation";
	}
	/*
	 * png pose des problÃ¨mes pour les fax multi-pages 
	 * exec("convert $path $rotation -transparent white $path.png");
	echo "convert $path $rotation -transparent white $path.png";
	header('Content-type: image/png');
	echo file_get_contents("$path.png");
	 */
	exec("convert $path $rotation -transparent white $path.png");
	exec("convert $path*.png* $path.pdf");
	//echo "convert $path $rotation -transparent white $path.png";
	header('Content-type: application/pdf');
	echo file_get_contents("$path.pdf");
} else {
	header('Content-type: application/pdf');
	echo $row['pj'];
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
