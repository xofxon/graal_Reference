<?php
include("_graal_header_xml.inc.php");
$vl_fab_ligne_cleunik=intval(fa_recup_param('vl_fab_ligne_cleunik','0'));
$vl_qte_fab=fa_floatval(fa_recup_param('vl_qte_fab','0'));
$vl_qte_reb=fa_floatval(fa_recup_param('vl_qte_reb','0'));
$sql_req =<<<EOT
SELECT a1.*,a2.code as code_article_pere,a2.description as description_article_pere,a3.code as code_article_fils,a3.description as description_article_fils,
a4.choix_valeur_texte_01 as lib_statut,a5.choix_valeur_texte_01 as lib_unite
 FROM _fab_lignes_nomenc a1 left join _article a2 on a1.art_cleunik_pere=a2.art_cleunik left join _article a3 on a1.art_cleunik_fils=a3.art_cleunik 
 left join _choix a4 on a1.statut=a4.choix_cleunik left join _choix a5 on a1.unite_quantite=a5.choix_cleunik 
 where fab_ligne_cleunik=$vl_fab_ligne_cleunik order by noligne asc;
EOT;
//echo $sql_req;
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	//	Recherche prix pour valorisation
	$vl_e_art_cleunik_fils=$row['art_cleunik_fils'];
	$sql_req_01="SELECT n1.art_cleunik,n1.pr_generique,n1.nbdec_prix,n3.pr,n3.nbdec_pr,n4.der_pa,n4.pamp 
 FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) where n1.art_cleunik=$vl_e_art_cleunik_fils;";
	$result_01 = _graal_requete_bd($sql_req_01);
	$row_01 = mysql_fetch_assoc($result_01);
	$vl_derpa=fa_ent_xml($row_01['der_pa']);
	$vl_pamp=fa_ent_xml($row_01['pamp']);
	$vl_pr=fa_reel(fa_ent_xml($row_01['pr']),$row_01['nbdec_pr']);
	$nbdec_prix=fa_ent_xml($row_01['nbdec_prix']);
	$vl_pr_generique=fa_reel(fa_ent_xml($row_01['pr_generique']),$nbdec_prix);
	if ($vl_derpa==""){$vl_derpa=0;}
	if ($vl_pamp==""){$vl_pamp=0;}
	if ($vl_pr==""){$vl_pr=0;}
	$vl_pr=$vl_pr_generique;
	_graal_libere_requete_bd($result_01);
	$base_valorisation=$row['base_valorisation'];
	switch ($base_valorisation){
		case "-4":
			$pu=0;
			break;
		case "-1":	//derpa
			$pu=$vl_derpa;
			break;
		case "-2":	//	PR
			$pu=$vl_pr;
			break;
		case "-3":
			$pu=$vl_pamp;
			break;
		default:
			$sql_req_01 = "SELECT tar_cleunik,pu_reference FROM _art_tarifs where art_cleunik=$vl_e_art_cleunik and tar_cleunik=$base_valorisation;";
			$result_01 = _graal_requete_bd($sql_req_01);
			$row_01 = mysql_fetch_assoc($result_01);
			$pu=fa_ent_xml($row_01['pu_reference']);
			_graal_libere_requete_bd($result_01);
			break;
	}	
	echo('<quoi ');
	$fab_ligne_nomenc_cleunik=$row['fab_ligne_nomenc_cleunik'];
  echo(' fab_ligne_nomenc_cleunik="'.fa_ent_xml($fab_ligne_nomenc_cleunik).'"');
  echo(' art_cleunik_fils="'.fa_ent_xml($row['art_cleunik_fils']).'"');
  echo(' code_article_pere="'.fa_ent_xml($row['code_article_pere']).'"');
  echo(' description_article_pere="'.fa_ent_xml($row['description_article_pere']).'"');
  echo(' code_article_fils="'.fa_ent_xml($row['code_article_fils']).'"');
	echo(' description_article_fils="'.fa_ent_xml($row['description_article_fils']).'"');
	echo(' quantite_lancee="'.fa_ent_xml($row['quantite_lancee']).'"');
	$quantite_fabriq=$row['quantite_lancee']*($vl_qte_fab-$vl_qte_reb);
	$quantite_rebute=$row['quantite_lancee']*$vl_qte_reb;
	switch ($row['arrondi_fab']){
		case 1:	// pas d'arrondi
			break;
		case 2: //	arrondi supérieur
			$quantite_fabriq=ceil($quantite_fabriq);
			$quantite_rebute=ceil($quantite_rebute);
			break;
		case 3: //	arrondi inférieur
			$quantite_fabriq=floor($quantite_fabriq);
			$quantite_rebute=floor($quantite_rebute);
			break;
	}
	echo(' quantite_fabriq="'.fa_ent_xml($quantite_fabriq).'"');
	echo(' quantite_rebute="'.fa_ent_xml($quantite_rebute).'"');
	echo(' statut="'.fa_ent_xml($row['lib_statut']).'"');
	echo(' unite_quantite="'.fa_ent_xml($row['unite_quantite']).'"');
	echo(' unite_quantite_lib="'.fa_ent_xml($row['lib_unite']).'"');
	echo(' pu="'.fa_ent_xml($pu).'"');
  echo(' hg="'.fa_ent_xml($row['hg']).'"');
	echo(' valeur_complement_type="'.fa_ent_xml($row['valeur_complement_type']).'"');
	echo(' valeur_complement="'.fa_ent_xml($row['valeur_complement']).'"');
	echo(' base_valorisation="'.fa_ent_xml($row['base_valorisation']).'"');
	echo(' nb_decimales_qte="'.fa_ent_xml($row['nb_decimales_qte']).'"');
	echo(' nbdec_pu="'.fa_ent_xml($row['nbdec_pu']).'"');				
	echo(' noligne="'.fa_ent_xml($row['noligne']).'"');
	
	//echo(' noligne="'.fa_ent_xml($base_valorisation).'"');
	
	
  if ($row['valeur_complement']<>0.0){
  	switch ($row['valeur_complement_type']) {
	  	case 1:$valeur_complement_type_clair="Unitaire";
			case 2:$valeur_complement_type_clair="Forfaitaire";
  	}
  } else {
  	$valeur_complement_type="";
  }
	echo(' valeur_complement_type_clair="'.fa_ent_xml($valeur_complement_type).'"');	
	
	
	
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>