<?php
// Auteur : Communauté PEAR
// Mise en exemple par Alexandre TRANCHANT
//La variable $mail est-elle une adresse e-mail syntaxiquement valide ?

require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
require("_graal_fonctions_mail.php");
header('Content-type: text/html; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
define('EOL', "<br>");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);
$valide="1,3";
$veuxpasdemail="1,3";
$vl_c_type=fa_recup_param('type','1');
set_time_limit(36000);
session_write_close();
_graal_requete_bd("SET SESSION wait_timeout = 200;");
echo <<<EOT
<script language="JavaScript">
function pf_descendre_bas_de_page(){
	var vl_c_hauteur=document.body.offsetHeight;
        window.scrollTo(0,vl_c_hauteur);
        setTimeout("pf_descendre_bas_de_page()",15000);  
    }
    setTimeout("pf_descendre_bas_de_page()",15000);  
</script>
EOT;
$vl_b_trace=false;
$limite_nombre_a_traiter=98;
$temps_de_pause=61;
$sql_req="select distinct(refweb) from _act_interlo_mail where ( cr_verification like '450%' or cr_verification like '451%')";
$sql_req.=" and valide in($valide) and veuxpasdemail in ($veuxpasdemail) ";
$sql_req.=" LIMIT 1000";
//echo("$sql_req").EOL;flush();
$top1 = top_chrono(); 
$result = _graal_requete_bd($sql_req);
$i=0;$i1=500;
echo "1° : lecture ".EOL;flush();
$t01_cod=array();$t01_dom=array();
$t02_cod=array();
$t03_exi=array();$t03_bad=array();
while ($row = mysql_fetch_assoc($result)) {
	$refweb=$row['refweb'];
	array_push($t01_cod,$refweb);
  	$i++;
	if ($i % $i1==0){
	    echo("$i intweb_cleunik=>$refweb").EOL;flush();
	  }
	//
	list ( $util, $domaine ) = split ("@",$refweb);
	array_push($t01_dom,$domaine);
	$vl_e_trouve_domaine=array_search($domaine, $t02_cod);
	if ($vl_e_trouve_domaine===false) {
		array_push($t02_cod,$domaine);
	} 
}
array_multisort($t01_dom,$t01_cod);
_graal_libere_requete_bd($result);
//var_dump($t01_cod);flush();
$top2 = top_chrono(); 
$temps= $top2-$top1;
$temps = number_format($temps,3,"."," ");
echo "Temps pour ".sizeof($t01_cod)." adresses de courriel :  $temps seconde(s)".EOL;flush(); 
echo "2° : début Vérification des ".sizeof($t02_cod)." DNS ".EOL;flush();
//var_dump($t02_cod);flush();
sort($t02_cod);

$i=0;$i1=100;
for($i=0;$i<sizeof($t02_cod);$i++){
	if ( checkdnsrr ( $t02_cod[$i], "MX" ) )  {
		if ($i % $i1==0){
	    	echo "$i oui-Vérification de ".$t02_cod[$i].EOL;flush();
	  	}
		array_push($t03_exi,$t02_cod[$i]);
	} else {
		if ($i % $i1==0){
	    	echo "$i non-Vérification de ".$t02_cod[$i].EOL;flush();
	  	}
		array_push($t03_bad,$t02_cod[$i]);
	}
} 
echo "2° : fin Vérification des DNS ".EOL;flush();
$top3 = top_chrono(); 
$temps= $top3-$top2;
$temps = number_format($temps,3,"."," ");
echo "temps ".sizeof($t02_cod)." domaines :  $temps seconde(s)".EOL;flush(); 
$t02_cod=array();
switch ($vl_c_type){
	case 1:
		echo "3° : Vérification des adresses ".EOL;flush();
		//var_dump($t03_exi).EOL;flush();
		echo sizeof($t03_exi)." domaines oui".EOL;flush();
		//var_dump($t03_bad).EOL;flush();
		echo sizeof($t03_bad)." domaines non".EOL;flush();
		//$domaine
		$i=0;$i1=25;
		for($i=0;$i<sizeof($t03_bad);$i++){
			if (trim($t03_bad[$i]!="")){
				$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification='Domaine inexistant',valide=2 where refweb like '%@".$t03_bad[$i]."';";
				$result_01=_graal_requete_bd($sql_req_01);
			}
			if ($i % $i1==0){
		    	echo "$i maj ".$sql_req_01.EOL;flush();
		  	}
		} 
		
		break;	
}
$top4 = top_chrono(); 
$temps= $top4-$top3;
$temps = number_format($temps,3,"."," ");
echo "temps ".sizeof($t03_bad)." domaines :  $temps seconde(s)".EOL;flush(); 
//die("fin");

$i=0;$i1=1;
$email_expediteur="webmestre@christophe-charron.org";
$HTTP_HOST=$_SERVER["HTTP_HOST"];
$domaine_en_cours_analyse="";
$nombre_traites=0;
$nombre_pauses=0;
$vl_b_cherche_mx=true;
for($i=0;$i<sizeof($t01_cod);$i++){
	//if ($i==20){die("Fin impromptue du traitement");}
	if ($i % $i1==0){
    	echo $heure = date("H:i:s"). "-$i Lecture ".$t01_cod[$i].EOL;flush();
  	}
	list ( $util, $domaine ) = split ("@",$t01_cod[$i]);
	$vl_e_trouve_domaine=array_search($domaine, $t03_exi);
	if ($vl_e_trouve_domaine===false) {
		// nom de domaine inexistant
		echo "pas trouvé domaine ".$t01_cod[$i].EOL;flush();
	} else {
		switch(strtolower($domaine)) {
         	case "free.fr":
         	case "aliceadsl.fr":
         	case "infonie.fr":
         	case "online.fr":
         	case "libertysurf.fr":
         		$cr=fa_nt("Les adresses du domaine free.fr ne sont pas contrôlables.".EOL."Voir ici des explications : http://postmaster.free.fr/");
         		$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=3 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
		        if ($vl_b_trace==true){ echo "ignoré $i maj ".$sql_req_01.EOL;flush();}
				break;
         	case "aol.com":
         		$cr=fa_nt("Les adresses du domaine aol.com ne sont pas contrôlables.".EOL."Voir ici des explications : http://eutoscos.web.aol.com/eu_tos_primary/ISO-8859-1/html/ISO-8859-1_578.dat");
         		$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=3 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
         		if ($vl_b_trace==true){echo "ignoré $i maj ".$sql_req_01.EOL;flush();}
				break;
         	default:
				if (($deja_connecte_ce_domaine===true) && ($domaine==$domaine_en_cours_analyse)){
					if ($vl_b_trace==true){echo "déjà connecté ".$t01_cod[$i].EOL;flush();}
					fputs ( $connection, "RCPT TO: <{$t01_cod[$i]}>\r\n" );// envoi de l'adresse cible.
		            $To = fgets ( $connection, 1024 ); // reception reponse serveur.
		            // nous vérifions les reponses du serveur a propos de la commande to et mail.
		            // le serveur renvoie le code  550 si elle n'existe pas
		            $cr=fa_nt(trim($To));
		            if ( !ereg ( "^250", $To )) {
		            	if ( ereg ( "^550", $To )) {
		            		$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=2 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
		            		if ($vl_b_trace==true){echo "deuz pas valide $i maj ".$sql_req_01.EOL;flush();}
		            	} else {
		            		if ( ereg ( "^552", $To )) {
		            			$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=2 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
		            			if ($vl_b_trace==true){echo "deuz pas valide $i maj ".$sql_req_01.EOL;flush();}
		            		} else {
		            			$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=3 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
		            			if ($vl_b_trace==true){echo "deuz on ne sait pas $i maj ".$sql_req_01.EOL;flush();}
		            		}
		            	}
		            } else {
		            	$cr=fa_nt('Cet email est valide (à cette date)'.EOL.trim($To));
		                $sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=1 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
		                if ($vl_b_trace==true){echo "deuz $i maj ".$sql_req_01.EOL;flush();}
		            }
		            $nombre_traites++;
		            if ($nombre_traites>=$limite_nombre_a_traiter){
		            	$nombre_traites=0;
		            	$deja_connecte_ce_domaine=false;
		            	$domaine_en_cours_analyse="";
		            	fputs ( $connection, "QUIT\r\n");// cloture de la connection.
		            	fclose($connection);
		            	echo "Vérification $i ... on ferme pour mieux ouvrir".EOL;flush();
		            	switch ($vl_c_type){
		            		case 2://	wanadoo
		            		case 3://	hotmail
		            		case 4://	club-internet
		            		case 5://	club-internet
		            			sleep($temps_de_pause);
		            			$nombre_pauses++;
		            			echo "Pause $nombre_pauses Fin de la temporisation de $temps_de_pause secondes $i ...".EOL;flush();
		            			break;
		            	}
		            }
				} else {
					if ($vl_b_trace==true){echo "$i etape 0 ".EOL;flush();}
					if ($domaine_en_cours_analyse!=""){
						fputs ( $connection, "QUIT\r\n");// cloture de la connection.
		            	fclose($connection);
		            	if ($vl_b_trace==true){echo "$i etape 1 ".EOL;flush();}
					}
					if ($vl_b_trace==true){echo "$i etape-etape 2 $domaine ".EOL;flush();}
					//	il faut se connecter
					$domaine_en_cours_analyse=$domaine;
					$deja_connecte_ce_domaine=true;
					/*
					switch ($vl_c_type){
		            	case 2://	wanadoo
		            	case 3://	hotmail
		            	//case 4://	club-internet
		            		if ($nombre_pauses>0){
		            			$vl_b_cherche_mx=false;
		            		}
	            			break;
		            	default:
		            		$vl_b_cherche_mx=true;
		            		break;
		            	}
		            	*/
					$vl_b_cherche_mx=true;
		            if ($vl_b_cherche_mx==true) {
		            	$tableau_cibles=array();
						if ( getmxrr ($domaine, $mxHote)) {
				              for ( $iter = 0,$j = 1; $iter < count ( $mxHote ); $iter++,$j++ ) {
				                $tableau_cibles[$iter]=$mxHote[$iter];
				              }
				              $nombre_mx=count($mxHote);
				              if ($vl_b_trace==true){echo "$i etape 2-1 trouvé les $nombre_mx MX".EOL;flush();}
				          } else {
				        	// si il n'y a pas de  MX record simplement prendre le $domaine comme adresse pour la connection socket .
				          	$tableau_cibles[0]=$domaine;
				          	$nombre_mx=1;
				          	if ($vl_b_trace==true){echo "$i etape 2-2 pas trouvé les MX".EOL;flush();}
				        }
		            }
		            if ($vl_b_trace==true){echo "$i etape 3 nombre mx $nombre_mx".EOL;flush();}
			        for ( $ibis = 0,$j = 1; $ibis < $nombre_mx; $ibis++,$j++ ) {
			        	if ($vl_b_trace==true){echo "$i etape 4 ".EOL;flush();}
		          		$cible=$tableau_cibles[$ibis];
		          		$connection= @fsockopen ($cible,25,$errno, $errstr, 3);
		          		if ($connection) {
		          			if ($vl_b_trace==true){echo "$i etape 5 ".EOL;flush();}
			          		if ( ereg ( "^220", $Out = fgets ( $connection, 1024 ) ) ) {
				            	fputs ( $connection, "HELO $HTTP_HOST\r\n" );//nous saluons le serveur smtp.
			              		$Out = fgets ( $connection, 1024 ); // reception reponse serveur.
					            fputs ( $connection, "MAIL FROM: <{$email_expediteur}>\r\n" );// envoi de l'adresse de l'envoyeur au serveur.
					            $From = fgets ( $connection, 1024 ); // reception reponse serveur.
				                fputs ( $connection, "RCPT TO: <{$t01_cod[$i]}>\r\n" );// envoi de l'adresse cible.
			              		$To = fgets ( $connection, 1024 ); // reception reponse serveur.
				              	// nous vérifions les reponses du serveur a propos de la commande to et mail.
			              		// le serveur renvoie le code  550 si elle n'existe pas
					            $cr=fa_nt(trim($To));
			              		if ( !ereg ( "^250", $To )) {
					            	if ( ereg ( "^550", $To )) {
					            		$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=2 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
					            		if ($vl_b_trace==true){echo "prems $i maj ".$sql_req_01.EOL;flush();}
					            	} else {
		            					$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=3 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
		            					if ($vl_b_trace==true){echo "prems on ne sait pas $i maj ".$sql_req_01.EOL;flush();}
		            				}
					            	break;
					            } else {
					            	$cr=fa_nt('Cet email est valide (à cette date)'.EOL.trim($To));
					                $sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=1 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
					                if ($vl_b_trace==true){echo "prems $i maj ".$sql_req_01.EOL;flush();}
					            	break;
					            }
			            	}
		          		} else {
		          			if ($vl_b_trace==true){echo "$i etape 6 ".EOL;flush();}
		          		}
			        }
			        if (!$connection) {
			        	if ($vl_b_trace==true){echo "$i etape 7 ".EOL;flush();}
				        $cr=fa_nt("Pas pu se connecter au serveur de courrier");
						$sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification=$cr,valide=3 where refweb='".$t01_cod[$i]."';";$result_01=_graal_requete_bd($sql_req_01);
						if ($vl_b_trace==true){echo "etape 7 pas pu résoudre $i maj ".$sql_req_01.EOL;flush();}
			        }
				}
			break;
		}
	}
} 
if ($domaine_en_cours_analyse!=""){
	fputs ( $connection, "QUIT\r\n");// cloture de la connection.
    fclose($connection);
    echo "$i Fermeture dernière connexion ".EOL;flush();
}
$top5 = top_chrono(); 
$temps= $top5-$top4;
$temps = number_format($temps,3,"."," ");
echo "temps traitement ".sizeof($t01_cod)." adresses :  $temps seconde(s)".EOL;flush(); 
echo "Fin traitement";EOL;flush();
_graal_ferme_connexion();
function top_chrono() { 
  $chrono= microtime(); 
  $chrono= explode(" ",$chrono); 
  $chrono= $chrono[1] + $chrono[0]; 
  return ($chrono); 
}
?>

