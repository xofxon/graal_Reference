<?php
//include("_graal_header_txt.inc.php");

require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
require("_graal_fonctions_mail.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
define('EOL', "\r\n");
$sess_id=session_id();
$vl_c_var=fa_recup_param('var','vs_tempo_panier_cle_recep');
$vl_e_courriel_brut_cleunik=intval(fa_recup_param('vl_e_courriel_brut_cleunik','0'));
/*
 * Attention, Attention
 * depuis le 14 avril 2009, on ne peut analyser qu'un seul courriel Ã  la fois
 * car on affiche en fonction du charset du courriel
 * et donc comme plusieurs courriels peuvent avoir plusieurs charset ...
 */


if ($vl_e_courriel_brut_cleunik!=0) {
  $vl_liste=$vl_e_courriel_brut_cleunik;
} else { 
  $vl_t_listecles=fa_recup_session("$vl_c_var",'');
  unset($_SESSION["$vl_c_var"]);
  $vl_e_i=-1;
  foreach($vl_t_listecles as $vl_raf) {
    $vl_e_i++;
    $vl_liste.=$vl_t_listecles[$vl_e_i].',';
  }
  if ($vl_liste!="") {
    $vl_liste=substr($vl_liste, 0, -1);
  }
}
//echo $vl_liste.EOL;
error_reporting(E_ALL ^ E_WARNING ^ E_NOTICE); //  On dÃ©sactive temporairement les warnings parce que parfois le iconv_mime_decode renvoie une erreur
// execution de la requÃ¨te SQL
if ($vl_liste=="" ) {exit;}
$sql_req="select courriel_brut_cleunik,courriel,hash,integre,idpop,sequence from _courriel_recus_brut where courriel_brut_cleunik in ($vl_liste)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $mime=new mime_parser_class;
  $mime->mbox = 0;
  $mime->decode_bodies=1;
  $mime->decode_headers=1;
  $mime->ignore_syntax_errors = 1;
  $courriel=$row['courriel'];
  //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
  $path="mail/".$sess_id."_".$row['hash'];
  $handle_file=fopen($path, 'wb');
  fwrite($handle_file, $row['courriel']);
  fclose($handle_file);
  $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$row['hash'],'sess_id'=>$sess_id,);
//  $parameters=array('Data'=>$row['courriel'],'SaveBody'=>'mail','Hash'=>$row['hash']);
  // Decode
	$vl_c_erreur="";
  if(!$mime->Decode($parameters, $decoded)) {
		$vl_c_erreur='MIME message erreur de décodage: '.$mime->error.' à  la position '.$mime->error_position.EOL;
		echo $vl_c_erreur;
		echo $courriel;
	}
	else {
	 	$vf_c_echo='MIME message décodé avec succès.'."\n";
		$vf_c_echo.= (count($decoded)==1 ? '1 message trouvé.' : count($decoded).' messages trouvés.')."\n";
   	if($mime->Analyze($decoded[0], $results)){
			$vf_c_encoding=$results['Encoding'];
			$vf_c_echo.="Encoding -> $vf_c_encoding"."\n";
			header("Content-type: text/plain; charset=".$vf_c_encoding);
			header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
			header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
			echo $vf_c_echo;
			var_dump($decoded[0]);
			echo "*********************************************************************************************************"."\n";
			//var_dump($results);
			echo "*********************************************************************************************************"."\n";
			$index=0;
			$tableau_parties=fa_arrayFromEmailParts($decoded[0]['Parts'],$index);
			var_dump($tableau_parties);
		}
	}
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
