<?php
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
require_once("_graal_fonctions_diverses.php");
require_once("_graal_fonctions_mysql.php");
$nb_dec=2;
$prop_obsolete="css_0001";
$vl_c_genreacteur=fa_recup_param('genreacteur','aucun');
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','aucun');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','aucun');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_recherche=fa_recup_param('vl_c_recherche','aucun');
$vl_e_typedate=fa_recup_param('vl_e_typedate','aucun');
$vl_e_type=fa_recup_param('vl_e_type','aucun');
$vl_e_etat=fa_recup_param('vl_e_etat','aucun');
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','-1'));
$vl_c_sortie=fa_recup_param('sortie','normale');
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$vl_c_nature=fa_recup_param('nature','1');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
$sql_condition=" where 1=1 ";
if ($vl_e_act_cleunik==-1){
	switch ($vl_e_etat){
		case "0":
			//	liste de clés pour panier échéancier
	        $vl_c_var=fa_recup_param('var','vs_tempo_panier_echeancier');
	        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
	        unset($_SESSION["$vl_c_var"]);
	        $vl_e_i=-1;
	        $vl_echeance_cleunik="";
	        foreach($vl_t_listecles as $vl_raf) {
	          $vl_e_i++;
	          $vl_echeance_cleunik.=$vl_t_listecles[$vl_e_i].',';
	        }
	        if ($vl_echeance_cleunik!="") {
	          $vl_echeance_cleunik=substr($vl_echeance_cleunik, 0, -1);
	          $sql_condition.=" and a1.echeance_cleunik IN($vl_echeance_cleunik)";
	        }
	        unset($vl_t_listecles,$vl_raf);
			break;
		case "1":
		case "2":
		case "3":
		case "4":
		case "6":
			$sql_condition.=" AND a1.etat=$vl_e_etat";
			break;
		case "5":
			break;
		case "7":
			$sql_condition.=" AND a1.etat in (1,2)";
			break;
	}
	$sql_condition_date_fac="";
	$sql_condition_date_avo="";
	switch ($vl_e_typedate){
		case '1'://	Date de réglement
			$sql_condition_date_cde.=" AND a1.date_paiement between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			$sql_condition_date_fac.=" AND a1.date_paiement between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			$sql_condition_date_avo.=" AND a1.date_paiement between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
		case '2':// Echéance
			$sql_condition_date_cde.=" AND a1.date_echeance between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			$sql_condition_date_fac.=" AND a1.date_echeance between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			$sql_condition_date_avo.=" AND a1.date_echeance between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
		case '3':// Date de facture
			$sql_condition_date_cde.=" AND a5.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			$sql_condition_date_fac.=" AND a5.date_fact between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			$sql_condition_date_avo.=" AND a5.date_avoi between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
	}
	switch ($vl_e_type){
		case '1'://	Recherche sur N° de document
			$sql_condition.=" AND a5.code like '$vl_c_recherche%'";
			break;
		case '2':	// = Montant dû
		  $vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_du=$vl_valeur";
			break;
		case '3':// = Montant à régler
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND (a1.montant_du-a1.montant_paye)=$vl_valeur";
			break;
		case '4':// = Montant réglé
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_paye=$vl_valeur";
			break;
		case '5':// Nom commercial ou raison social de l'acteur
			$sql_condition.="AND (a6.nomcommercial like '$vl_c_recherche%' or a6.raisonsoc like '$vl_c_recherche%')";
			break;
		case '6':	// <= Montant dû
		  $vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_du<=$vl_valeur AND a1.montant_du<>0";
			break;
		case '7':// <= Montant à régler
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND (a1.montant_du-a1.montant_paye)<=$vl_valeur AND (a1.montant_du-a1.montant_paye)<>0";
			break;
		case '8':// <= Montant réglé
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_paye<=$vl_valeur AND a1.montant_paye<>0";
			break;
		case '9':	// >= Montant dû
		  $vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_du>=$vl_valeur";
			break;
		case '10':// >= Montant à régler
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND (a1.montant_du-a1.montant_paye)>=$vl_valeur";
			break;
		case '11':// >= Montant réglé
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_paye>=$vl_valeur";
			break;
	}
} else {
	$sql_condition.=" AND a5.act_cleunik=$vl_e_act_cleunik";
	$vl_c_genreacteur="tousss";
}
$sql_req_base="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base.="a5.date_fact,"._graalsql_date('a5.date_fact')." as `date_fact_clair`,";
$sql_req_base.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base.="a1.libelle,a1.montant_du,a1.montant_paye,a1.devise_du,a1.devise_paye,";
$sql_req_base.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base.="a5.code as code_document,";
$sql_req_base.="a5.action_cleunik as action_cleunik,";
$sql_req_base.="a5.act_cleunik as act_cleunik,";
$sql_req_base.="a6.actif as actif,";
$sql_req_base.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_cli="(select sum((a7.montant_paye*a7.coef)) from `_treso_reglement_cli_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_cli.=" 'ai14' as properties_document,'_faccli_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_cli.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_cli.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_cli.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_cli.=" join _faccli_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_cli.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";

$sql_req_base_cdecli="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base_cdecli.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base_cdecli.="a5.dateheurecreation,"._graalsql_date('a5.dateheurecreation')." as `date_fact_clair`,";
$sql_req_base_cdecli.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base_cdecli.="a1.libelle,a1.montant_du,a1.montant_paye,a1.devise_du,a1.devise_paye,";
$sql_req_base_cdecli.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base_cdecli.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base_cdecli.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base_cdecli.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base_cdecli.="a5.code as code_document,";
$sql_req_base_cdecli.="a5.action_cleunik as action_cleunik,";
$sql_req_base_cdecli.="a5.act_cleunik as act_cleunik,";
$sql_req_base_cdecli.="a6.actif as actif,";
$sql_req_base_cdecli.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_cdecli="(select sum((a7.montant_paye*a7.coef*-1)) from `_treso_reglement_cli_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_cdecli.=" 'ai14' as properties_document,'_cdecli_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_cdecli.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_cdecli.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_cdecli.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_cdecli.=" join _cdecli_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_cdecli.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";

$sql_req_base_avocli="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base_avocli.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base_avocli.="a5.date_avoi,"._graalsql_date('a5.date_avoi')." as `date_fact_clair`,";
$sql_req_base_avocli.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base_avocli.="a1.libelle,a1.montant_du*-1,a1.montant_paye*-1,a1.devise_du,a1.devise_paye,";
$sql_req_base_avocli.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base_avocli.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base_avocli.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base_avocli.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base_avocli.="a5.code as code_document,";
$sql_req_base_avocli.="a5.action_cleunik as action_cleunik,";
$sql_req_base_avocli.="a5.act_cleunik as act_cleunik,";
$sql_req_base_avocli.="a6.actif as actif,";
$sql_req_base_avocli.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_avocli="(select sum((a7.montant_paye*a7.coef*-1)) from `_treso_reglement_cli_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_avocli.=" 'ai14' as properties_document,'_avocli_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_avocli.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_avocli.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_avocli.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_avocli.=" join _avocli_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_avocli.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";


$sql_req_fou="(select sum((a7.montant_paye*a7.coef)) from `_treso_reglement_fou_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_fou.=" 'ah06' as properties_document,'_facfou_echeancier' as fichier_echeance FROM _echeancier a1";
$sql_req_fou.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_fou.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_fou.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_fou.=" join _facfou_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_fou.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";

$sql_req_base_avofou="SELECT a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,";
$sql_req_base_avofou.="a1.date_paiement,a1.date_echeance,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
$sql_req_base_avofou.="a5.date_avoi,"._graalsql_date('a5.date_avoi')." as `date_fact_clair`,";
$sql_req_base_avofou.=_graalsql_date('a1.date_echeance')." as `date_echeance_clair`,";
$sql_req_base_avofou.="a1.libelle,a1.montant_du*-1,a1.montant_paye*-1,a1.devise_du,a1.devise_paye,";
$sql_req_base_avofou.="a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat,";
$sql_req_base_avofou.="a2.choix_valeur_texte_01 as devise_du_clair,";
$sql_req_base_avofou.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req_base_avofou.="a4.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req_base_avofou.="a5.code as code_document,";
$sql_req_base_avofou.="a5.action_cleunik as action_cleunik,";
$sql_req_base_avofou.="a5.act_cleunik as act_cleunik,";
$sql_req_base_avofou.="a6.actif as actif,";
$sql_req_base_avofou.="case a6.nomcommercial when '' then a6.raisonsoc else a6.nomcommercial END as nomcommercial,";

$sql_req_avofou="(select sum((a7.montant_paye*a7.coef*-1)) from `_treso_reglement_fou_detail` a7 where a7.echeance_cleunik=a1.echeance_cleunik group by echeance_cleunik) as montant_regle_treso,";
$sql_req_avofou.=" 'ah06' as properties_document,'_avofou_echeancier' as fichier_echeance FROM _echeancier a1 ";
$sql_req_avofou.=" left join _choix a2 on a2.choix_cleunik=a1.devise_du";
$sql_req_avofou.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req_avofou.=" left join _choix a4 on a4.choix_cleunik=a1.mode_paiement";
$sql_req_avofou.=" join _avofou_entetes a5 on a5.action_cleunik=a1.action_cleunik";
$sql_req_avofou.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";
$avec_les_commandes_clients=true;
switch ($vl_e_etat){
	case "0":
			$sql_req=$sql_req_base.$sql_req_cli.$sql_condition_faccli.$sql_condition.$sql_condition_date_fac;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base_avocli.$sql_req_avocli.$sql_condition_avocli.$sql_condition.$sql_condition_date_avo;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base.$sql_req_fou.$sql_condition_facfou.$sql_condition.$sql_condition_date_fac;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base_avofou.$sql_req_avofou.$sql_condition_avofou.$sql_condition.$sql_condition_date_avo;
				$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base_cdecli.$sql_req_cdecli.$sql_condition_cdecli.$sql_condition.$sql_condition_date_cde;
		//die($sql_req);
		break;
	default:
	switch ($vl_c_genreacteur){
	  case "tousss":
			//$sql_req=$sql_req_base.$sql_req_cli.$sql_condition.$sql_condition_date_fac." UNION ALL ".$sql_req_base.$sql_req_fou.$sql_condition.$sql_condition_date_fac;

			$sql_req=$sql_req_base.$sql_req_cli.$sql_condition.$sql_condition_date_fac." UNION ALL ".$sql_req_base_avocli.$sql_req_avocli.$sql_condition.$sql_condition_date_avo;
			$sql_req.=" UNION ALL ";
			$sql_req.=$sql_req_base.$sql_req_fou.$sql_condition.$sql_condition_date_fac." UNION ALL ".$sql_req_base_avofou.$sql_req_avofou.$sql_condition.$sql_condition_date_avo;
			break;  //  Tous les acteurs
	  case "110003"://  clients
	  		switch ($vl_c_nature){
	  			case "1":	//	factures avoirs
	  			case "5":	//	factures avoirs
	  			case "8":	//	factures avoirs
	  			case "7":	//	factures avoirs
	  			case "10":	//	factures avoirs
	  				$sql_req=$sql_req_base.$sql_req_cli.$sql_condition.$sql_condition_date_fac." UNION ALL ".$sql_req_base_avocli.$sql_req_avocli.$sql_condition.$sql_condition_date_avo;
	  				$avec_les_commandes_clients=false;
	  				break;
	  			case "2":	//	commandes
	  			case "C8":	//	commandes
	  				$sql_req=$sql_req_base_cdecli.$sql_req_cdecli.$sql_condition_cdecli.$sql_condition.$sql_condition_date_cde;
	  				break;
	  		}

			break;
	  case "110004"://  fournisseurs
			$sql_req=$sql_req_base.$sql_req_fou.$sql_condition.$sql_condition_date_fac." UNION ALL ".$sql_req_base_avofou.$sql_req_avofou.$sql_condition.$sql_condition_date_avo;
			break;
		default:
			$sql_req="SELECT 1=2;";
			break;
	}
	break;
}
session_write_close();
switch ($vl_c_sortie) {
	case "sql":
		header('Content-type: text/plain; charset=utf-8');
		echo $sql_req;
		break;
	case "normale":
		header('Content-type: text/xml; charset=utf-8');
		$result = _graal_requete_bd($sql_req);
		$act_cleunik=-1;
		$i=0;
		echo("<donnees>");
		while ($row = mysql_fetch_assoc($result)){
			switch (fa_ent_xml($row[fichier_echeance])) {
				case "_cdecli_echeancier":$prop_type="";$vl_coeff=1;$vl_b_afficher=true;break;
		    	case "_avocli_echeancier":$prop_type="ah19";$vl_coeff=1;$vl_b_afficher=true;break;
		    	case "_faccli_echeancier":$prop_type="";$vl_coeff=1;$vl_b_afficher=pf_verif_reglement_sur_commande_client($row['action_cleunik']);break;
		    	case "_facfou_echeancier":$prop_type="";$vl_coeff=1;$vl_b_afficher=true;break;
		    	case "_avofou_echeancier":$prop_type="ah19";$vl_coeff=1;$vl_b_afficher=true;break;
		    }
		    if ($vl_b_afficher==false){
		    	$complement_information=" Réglé sur commande";
		    	$vl_b_réglé_sur_commande=true;
		    	if ($avec_les_commandes_clients==true){
		    		$vl_b_afficher=true;
		    	}
		    } else {
		    	$complement_information="";
		    	$vl_b_réglé_sur_commande=false;
		    }

		    if ($vl_b_afficher==true){
				$montant_du=$row['montant_du']*$vl_coeff;
				$val_montant_du=$row['montant_du']*1000*$vl_coeff;
				if ($vl_b_réglé_sur_commande==true){
					$montant_paye=$row['montant_du']*$vl_coeff;
					$montant_regle_treso=$row['montant_du']*$vl_coeff;
					$val_montant_paye=$row['montant_du']*1000*$vl_coeff;
					$val_montant_regle_treso=$row['montant_du']*1000*$vl_coeff;
					$montant_restant=0;
					$val_montant_restant=$montant_restant*1000;
					$val_montant_restant=$val_montant_du-$val_montant_paye;
				} else {
					$montant_paye=$row['montant_paye']*$vl_coeff;
					$montant_regle_treso=$row['montant_regle_treso']*$vl_coeff;
					$val_montant_paye=$row['montant_paye']*1000*$vl_coeff;
					$val_montant_regle_treso=$row['montant_regle_treso']*1000*$vl_coeff;
					$montant_restant=($row['montant_du']-$row['montant_regle_treso'])*$vl_coeff;
					$val_montant_restant=$montant_restant*1000;
					$val_montant_restant=$val_montant_du-$val_montant_paye;
				}

				//if ($montant_regle_treso<>$montant_paye) {
				if ($montant_regle_treso<>$montant_du) {

					switch ($row[etat]){
						case 1:$etat="Totalement dûe";$properties_paye="ad14";break;
						case 2:$etat="Partiellement dûe";$properties_paye="ad14";break;
						case 3:$etat="Totalement réglée";$properties_paye="";break;
						case 4:$etat="Situation bizarre !!!";$properties_paye="ad14";break;
						case 5:$etat="Situation bizarre ???";$properties_paye="ad14";break;
						case 6:$etat="Soldée";$properties_paye="";break;
					}



				} else {
					if ($montant_paye<>0) {
						$properties_paye="";
					} else {
						$properties_paye="";
					}
				}


				//$montant_restant=fa_reel($row['montant_du']-$row['montant_paye'],$nb_dec)*$vl_coeff;


		    		switch ($row[etat]){
						case 1:$etat="Totalement dûe";break;
						case 2:$etat="Partiellement dûe";break;
						case 3:$etat="Totalement réglée";$val_montant_restant=0;$montant_restant=0;break;
						case 4:$etat="Situation bizarre !!!";break;
						case 5:$etat="Situation bizarre ???";break;
						case 6:$etat="Soldée";$val_montant_restant=0;$montant_restant=0;break;
					}


				if ($montant_du==0.00){$montant_du="";}
				if ($montant_paye==0.00){$montant_paye="";}
				if ($montant_regle_treso==0.00){$montant_regle_treso="";}
				if ($montant_restant==0.00){
					$montant_restant="";
					$properties_restant="";
				} else {
					$properties_restant="fond_rouge";
				}
				if ($act_cleunik==-1){$act_cleunik=$row[act_cleunik];}
				if ($act_cleunik==$row[act_cleunik] && $vl_e_etat==0){
					$renvoie_ligne=true;
				} else {
					if ($vl_e_etat==0){
						$renvoie_ligne=false;
					} else {
						$renvoie_ligne=true;
					}
				}
		    } else {
		    	$renvoie_ligne=false;
		    }
			if ($renvoie_ligne==true){
				$i++;
			  echo("<quoi ");

			    echo(' fichier_echeance="'.fa_ent_xml($row[fichier_echeance]).'"');
			    echo(' prop_type="'.$prop_type.'"');
				echo(' echeance_cleunik="'.fa_ent_xml($row[echeance_cleunik]).'"');
			    echo(' commercial_cleunik="'.fa_ent_xml($row[commercial_cleunik]).'"');
			    echo(' pc_cleunik="'.fa_ent_xml($row[pc_cleunik]).'"');
			    echo(' noligne="'.fa_ent_xml($row[noligne]).'"');
			    echo(' date_paiement="'.fa_ent_xml($row[date_paiement]).'"');
			    echo(' date_echeance="'.fa_ent_xml($row[date_echeance]).'"');
					echo(' date_paiement_clair="'.fa_ent_xml($row[date_paiement_clair]).'"');
			    echo(' date_echeance_clair="'.fa_ent_xml($row[date_echeance_clair]).'"');
			    echo(' libelle="'.fa_ent_xml($row[libelle]).'"');
			    echo(' montant_du="'.fa_reel($montant_du,$nb_dec).'"');
					printf(' val_montant_du ="%011u"',$val_montant_du);
			    echo(' montant_paye="'.$montant_paye.$complement_information.'"');
			    //echo(' montant_paye="'."AAA".$montant_paye.'"');
					printf(' val_montant_paye ="%011u"',$val_montant_paye);
			    echo(' devise_du="'.fa_ent_xml($row[devise_du_clair]).'"');
			    echo(' devise_paye="'.fa_ent_xml($row[devise_paye_clair]).'"');
			    echo(' taux_de_change="'.fa_ent_xml($row[taux_de_change]).'"');
			    echo(' mode_paiement="'.fa_ent_xml($row[mode_paiement_clair]).'"');
			    echo(' blocnotebrut="'.fa_ent_xml($row[blocnotebrut]).'"');
			    echo(' dateheurecreation="'.fa_ent_xml($row[dateheurecreation]).'"');
			    echo(' dateheuremodif="'.fa_ent_xml($row[dateheuremodif]).'"');
					switch ($row[etat]){
						case 1:$etat="Totalement dûe";break;
						case 2:$etat="Partiellement dûe";break;
						case 3:$etat="Totalement réglée";break;
						case 4:$etat="Situation bizarre !!!";break;
						case 5:$etat="Situation bizarre ???";break;
						case 6:$etat="Soldée";break;
					}
			    echo(' etat="'.$etat.'"');
					echo(' code_document="'.fa_ent_xml($row[code_document]).'"');
					echo(' nomcommercial="'.fa_ent_xml($row[nomcommercial]).'"');
					echo(' properties_document="'.fa_ent_xml($row[properties_document]).'"');
					echo(' date_fact="'.fa_ent_xml($row[date_fact]).'"');
					echo(' date_fact_clair="'.fa_ent_xml($row[date_fact_clair]).'"');
					echo(' montant_restant="'.fa_reel($montant_restant,$nb_dec).'"');
					printf(' val_montant_restant ="%011u"',$val_montant_restant);
					echo(' properties_restant="'.$properties_restant.'"');
					echo(' action_cleunik="'.fa_ent_xml($row[action_cleunik]).'"');
					echo(' act_cleunik="'.fa_ent_xml($row[act_cleunik]).'"');
					echo(' properties_paye="'.$properties_paye.'"');
					if ($montant_regle_treso==""){
						echo(' montant_regle_treso="'.$montant_regle_treso.'"');
					} else {
						echo(' montant_regle_treso="'.fa_reel($montant_regle_treso,$nb_dec).'"');
					}
					printf(' val_montant_regle_treso ="%011u"',$val_montant_regle_treso);
					if ($row['actif']==1) {
			    	echo(' properties_acteur=""');
			  	} else {
			    	echo(' properties_acteur="'.$prop_obsolete.'"');
			  	}
					$total_montant_restant+=$val_montant_restant;
					$total_montant_regle_treso+=$val_montant_regle_treso;
					$total_montant_du+=$val_montant_du;
					$total_montant_paye+=$val_montant_paye;
			  echo("/>");
			}
		}
		if ($i!=0){
			echo("<quoi ");
					$total_montant_restant=$total_montant_restant/1000;
					$total_montant_regle_treso=$total_montant_regle_treso/1000;
					$total_montant_du=$total_montant_du/1000;
					$total_montant_paye=$total_montant_paye/1000;
			    echo(' libelle="Totaux"');
			    echo(' montant_du="'.fa_reel($total_montant_du).'"');
					printf(' val_montant_du ="%011u"',$total_montant_du);
			    echo(' montant_paye="'.fa_reel($total_montant_paye).'"');
					printf(' val_montant_paye ="%011u"',$total_montant_paye);
					echo(' montant_restant="'.fa_reel($total_montant_restant).'"');
					printf(' val_montant_restant ="%011u"',$total_montant_restant);
					echo(' montant_regle_treso="'.fa_reel($total_montant_regle_treso).'"');
					printf(' val_montant_regle_treso ="%011u"',$total_montant_regle_treso);
			  echo("/>");
		}
		echo("</donnees>");
		_graal_libere_requete_bd($result);
		break;
	case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		switch ($vl_c_type) {
			case "ventes":$vl_c_id_fenetre="Fen_01081";break;
			case "achats":$vl_c_id_fenetre="Fen_01082";break;
		}
		_graal_requete_charge_varlib("Div_00553",$vl_e_uti_cleunik);
		$vl_c_brb_001=fa_recup_dico("brb_001");
		$vl_c_brb_002=fa_recup_dico("brb_002");
		$vl_c_brb_003=fa_recup_dico("brb_003");
		$vl_c_brb_004=fa_recup_dico("brb_004");
		$vl_c_brb_005=fa_recup_dico("brb_005");
		$vl_c_brb_006=fa_recup_dico("brb_006");
		$vl_c_brb_007=fa_recup_dico("brb_007");
		$vl_c_brb_008=fa_recup_dico("brb_008");
		$vl_c_brb_009=fa_recup_dico("brb_009");
		$vl_c_brb_010=fa_recup_dico("brb_010");
		$vl_c_brb_011=fa_recup_dico("brb_011");
		$vl_c_brb_012=fa_recup_dico("brb_012");
		$vl_c_brb_013=fa_recup_dico("brb_013");
		$vl_c_brb_014=fa_recup_dico("brb_014");
		$vl_c_brb_015=fa_recup_dico("brb_015");
		$vl_c_brb_016=fa_recup_dico("brb_016");
		$vl_c_brb_017=fa_recup_dico("brb_017");



		$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_bsq_107"));
		$result = _graal_requete_bd($sql_req);

				$worksheet->write(0, 0, utf8_decode("$vl_c_brb_001"));
				$worksheet->write(0, 1, utf8_decode("$vl_c_brb_002"));
				$worksheet->write(0, 2, utf8_decode("$vl_c_brb_003"));
				$worksheet->write(0, 3, utf8_decode("$vl_c_brb_004"));
				$worksheet->write(0, 4, utf8_decode("$vl_c_brb_010"));
				$worksheet->write(0, 5, utf8_decode("$vl_c_brb_011"));

				$worksheet->write(0, 6, utf8_decode("$vl_c_brb_005"));
				$worksheet->write(0, 7, utf8_decode("$vl_c_brb_006"));
				$worksheet->write(0, 8, utf8_decode("$vl_c_brb_007"));
				$worksheet->write(0, 9, utf8_decode("$vl_c_brb_008"));
				$worksheet->write(0,10, utf8_decode("$vl_c_brb_009"));
				$worksheet->write(0,11, utf8_decode("$vl_c_brb_012"));

				$worksheet->write(0,12, utf8_decode("$vl_c_brb_013"));
				$worksheet->write(0,13, utf8_decode("Date de facture"));

				$vl_e_noligne=1;
/*
 * <treecols>
      <treecol id="tc_date_paiement_clair" label="$vl_c_brb_001" tooltiptext="$vl_c_brb_001" sort="?date_paiement"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_date_echeance_clair" label="$vl_c_brb_002" tooltiptext="$vl_c_brb_002" sort="?date_echeance"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_montant_du" label="$vl_c_brb_003" tooltiptext="$vl_c_brb_003" sort="?val_montant_du" class="droite"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_montant_paye" label="$vl_c_brb_004" tooltiptext="$vl_c_brb_004" sort="?val_montant_paye" class="droite"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_montant_regle_treso" label="$vl_c_brb_010" tooltiptext="$vl_c_brb_010" sort="?val_montant_regle_treso" class="droite"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_montant_restant" label="$vl_c_brb_011" tooltiptext="$vl_c_brb_011" sort="?val_montant_restant" class="droite"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_devise_du" label="$vl_c_brb_005" tooltiptext="$vl_c_brb_005" sort="?devise_du"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_devise_paye" label="$vl_c_brb_006" tooltiptext="$vl_c_brb_006" sort="?devise_paye"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_mode_paiement" label="$vl_c_brb_007" tooltiptext="$vl_c_brb_007" sort="?mode_paiement"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_blocnotebrut" label="$vl_c_brb_008" tooltiptext="$vl_c_brb_008" sort="?blocnotebrut"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_etat" label="$vl_c_brb_009" tooltiptext="$vl_c_brb_009" sort="?etat"/><splitter class="tree-splitter" resizeafter="grow"/>
			<treecol id="tc_code_document" label="$vl_c_brb_012" tooltiptext="$vl_c_brb_012" sort="?code_document"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_nomcommercial" label="$vl_c_brb_013" tooltiptext="$vl_c_brb_013" sort="?nomcommercial"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="tc_date_fact_clair" label="Date de facture" tooltiptext="Date de facture" sort="?date_fact"/><splitter class="tree-splitter" resizeafter="grow"/>
    </treecols>

    <treerow>
			<treecell label="?date_paiement_clair"/>
            <treecell label="?date_echeance_clair"/>
            <treecell label="?montant_du"/>
            <treecell label="?montant_paye"/>
			<treecell properties="?properties_paye" label="?montant_regle_treso"/>
            <treecell properties="?properties_restant" label="?montant_restant"/>
            <treecell label="?devise_du"/>
            <treecell label="?devise_paye"/>
            <treecell properties="?prop_type" label="?mode_paiement"/>
            <treecell label="?blocnotebrut"/>
            <treecell label="?etat"/>
			<treecell properties="?properties_document" label="?code_document"/>
            <treecell properties="?properties_acteur" label="?nomcommercial"/>
            <treecell label="?date_fact_clair"/>
          </treerow>
 */

		$act_cleunik=-1;
		$i=0;
		while ($row = mysql_fetch_assoc($result)){
			switch (fa_ent_xml($row[fichier_echeance])) {
				case "_cdecli_echeancier":$prop_type="";$vl_coeff=1;$vl_b_afficher=true;break;
		    	case "_avocli_echeancier":$prop_type="ah19";$vl_coeff=1;$vl_b_afficher=true;break;
		    	case "_faccli_echeancier":$prop_type="";$vl_coeff=1;$vl_b_afficher=pf_verif_reglement_sur_commande_client($row['action_cleunik']);break;
		    	case "_facfou_echeancier":$prop_type="";$vl_coeff=1;$vl_b_afficher=true;break;
		    	case "_avofou_echeancier":$prop_type="ah19";$vl_coeff=1;$vl_b_afficher=true;break;
		    }
		    if ($vl_b_afficher==false){
		    	$complement_information=" Réglé sur commande";
		    	$vl_b_réglé_sur_commande=true;
		    	if ($avec_les_commandes_clients==true){
		    		$vl_b_afficher=true;
		    	}
		    } else {
		    	$complement_information="";
		    	$vl_b_réglé_sur_commande=false;
		    }
		    if ($vl_b_afficher==true){
				$montant_du=$row['montant_du']*$vl_coeff;
				$val_montant_du=$row['montant_du']*1000*$vl_coeff;
				if ($vl_b_réglé_sur_commande==true){
					$montant_paye=$row['montant_du']*$vl_coeff;
					$montant_regle_treso=$row['montant_du']*$vl_coeff;
					$val_montant_paye=$row['montant_du']*1000*$vl_coeff;
					$val_montant_regle_treso=$row['montant_du']*1000*$vl_coeff;
					$montant_restant=0;
					$val_montant_restant=$montant_restant*1000;
					$val_montant_restant=$val_montant_du-$val_montant_paye;
				} else {
					$montant_paye=$row['montant_paye']*$vl_coeff;
					$montant_regle_treso=$row['montant_regle_treso']*$vl_coeff;
					$val_montant_paye=$row['montant_paye']*1000*$vl_coeff;
					$val_montant_regle_treso=$row['montant_regle_treso']*1000*$vl_coeff;
					$montant_restant=($row['montant_du']-$row['montant_regle_treso'])*$vl_coeff;
					$val_montant_restant=$montant_restant*1000;
					$val_montant_restant=$val_montant_du-$val_montant_paye;
				}
				if ($montant_regle_treso<>$montant_du) {
					switch ($row[etat]){
						case 1:$etat="Totalement dûe";$properties_paye="ad14";break;
						case 2:$etat="Partiellement dûe";$properties_paye="ad14";break;
						case 3:$etat="Totalement réglée";$properties_paye="";break;
						case 4:$etat="Situation bizarre !!!";$properties_paye="ad14";break;
						case 5:$etat="Situation bizarre ???";$properties_paye="ad14";break;
						case 6:$etat="Soldée";$properties_paye="";break;
					}
				} else {
					if ($montant_paye<>0) {
						$properties_paye="";
					} else {
						$properties_paye="";
					}
				}
		    		switch ($row[etat]){
						case 1:$etat="Totalement dûe";break;
						case 2:$etat="Partiellement dûe";break;
						case 3:$etat="Totalement réglée";$val_montant_restant=0;$montant_restant=0;break;
						case 4:$etat="Situation bizarre !!!";break;
						case 5:$etat="Situation bizarre ???";break;
						case 6:$etat="Soldée";$val_montant_restant=0;$montant_restant=0;break;
					}
				if ($montant_du==0.00){$montant_du="";}
				if ($montant_paye==0.00){$montant_paye="";}
				if ($montant_regle_treso==0.00){$montant_regle_treso="";}
				if ($montant_restant==0.00){
					$montant_restant="";
					$properties_restant="";
				} else {
					$properties_restant="fond_rouge";
				}
				if ($act_cleunik==-1){$act_cleunik=$row[act_cleunik];}
				if ($act_cleunik==$row[act_cleunik] && $vl_e_etat==0){
					$renvoie_ligne=true;
				} else {
					if ($vl_e_etat==0){
						$renvoie_ligne=false;
					} else {
						$renvoie_ligne=true;
					}
				}
		    } else {
		    	$renvoie_ligne=false;
		    }
			if ($renvoie_ligne==true){
				$i++;
				$j=0;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_paiement_clair']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_echeance_clair']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode(fa_reel($montant_du,$nb_dec)));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($montant_paye.$complement_information));$j++;
				if ($montant_regle_treso==""){
					$worksheet->write($vl_e_noligne, $j, utf8_decode($montant_regle_treso));$j++;
				} else {
					$worksheet->write($vl_e_noligne, $j, fa_reel($montant_regle_treso,$nb_dec));$j++;
				}
				$worksheet->write($vl_e_noligne, $j, utf8_decode(fa_reel($montant_restant)));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['devise_du_clair']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['devise_paye_clair']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['mode_paiement_clair']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['blocnotebrut']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($etat));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['code_document']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['nomcommercial']));$j++;
				$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_fact_clair']));$j++;
				$total_montant_restant+=$val_montant_restant;
				$total_montant_regle_treso+=$val_montant_regle_treso;
				$total_montant_du+=$val_montant_du;
				$total_montant_paye+=$val_montant_paye;
			}
			$vl_e_noligne++;
		}
		if ($i!=0){
			$j=0;
			$worksheet->write($vl_e_noligne, $j, "Totaux");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode(fa_reel($total_montant_du)));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode(fa_reel($total_montant_paye)));$j++;
			$worksheet->write($vl_e_noligne, $j, fa_reel($total_montant_regle_treso));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode(fa_reel($total_montant_restant)));$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
			$worksheet->write($vl_e_noligne, $j, "");$j++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
		break;
	case "graphique":
		header('Content-type: text/xml; charset=utf-8');
		$uuid=_graal_requete_uuid();
		$sql_req_ins="insert into _temp_stat_01 (cleunik_reference,c_uuid,dateheure,montant) values ";
		$vl_e_i=-1;
		$result = _graal_requete_bd($sql_req);
		while ($row = mysql_fetch_assoc($result)){
			$vl_e_i++;
			$date_echeance=fa_nt($row['date_echeance']);
			$montant_restant=fa_nn($row['montant_du']-$row['montant_paye'],$nb_dec);
			if ($vl_e_i!=0){$sql_req_ins.=",";}
			$sql_req_ins.="(1,'$uuid',$date_echeance,$montant_restant)";
		}
		_graal_libere_requete_bd($result);
		$vf_c_echo=_graal_exec_requete($sql_req_ins);
//echo $sql_req_ins;
//echo $vf_c_echo;
		$sql_req="Select @rang:=@rang+1 AS z00,sum(a1.montant) AS z01";
		switch ($ml_art_04) {
		  case 1: $sql_req.=",DATE_FORMAT(a1.dateheure,GET_FORMAT(DATE,'EUR')) as z02,a1.dateheure as z03";break;
		  case 2: $sql_req.=",concat(WEEK(a1.dateheure),'-',Year(a1.dateheure)) as z02,concat(year(a1.dateheure),'-',week(a1.dateheure)) as z03";break;
		  case 3: $sql_req.=",DATE_FORMAT(a1.dateheure,'%m-%Y') as z02,DATE_FORMAT(a1.dateheure,'%Y-%m') as z03";break;
		  case 4: $sql_req.=",concat(quarter(a1.dateheure),'-',Year(a1.dateheure)) as z02,concat(year(a1.dateheure),'-',quarter(a1.dateheure)) as z03";break;
		  case 5: $sql_req.=",Year(a1.dateheure) as z02,Year(a1.dateheure) as z03";break;
		}
		$sql_req.=" from _temp_stat_01 a1";
		$sql_req.=" where a1.c_uuid='$uuid'";
		$sql_req.=" group by z03 order by z03 desc";

		//echo $sql_req;

		_graal_requete_bd("SET @rang=0;");
		$result = _graal_requete_bd($sql_req);
		$vl_e_nombre_types=mysql_num_rows($result);
		echo('<donnees>');
		if ($vl_e_nombre_types!=0) {
			while ($row = mysql_fetch_assoc($result)) {
				if ($row['z01']!=0){
					echo('<quoi ');
			    echo(' z00="'.fa_ent_xml($row['z00']).'"');
					$z01_trie=fa_ent_xml($row['z01'])*1000;
					printf(' z01_tri="%011u"',$z01_trie);
			    echo(' z01="'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'"');
			    echo(' periode="'.fa_ent_xml($row['z02']).'"');
			    echo(' z03="'.fa_ent_xml($row['z03']).'"');
			    echo('/>');
				}
		  }
		} else {
		    echo('<quoi ');
		    echo(' z00="0"');
				$z01_trie=0;
				printf(' z01_tri="%011u"',$z01_trie);
		    echo(' z01="'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'"');
		    echo(' periode="y\'a pas!!!"');
		    echo(' z03="y\'a pas!!!"');
		     echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);

		$sql_req="delete from _temp_stat_01 where c_uuid='$uuid';";
		$vf_c_echo=_graal_exec_requete($sql_req);
		//echo $sql_req;
		break;
}
_graal_ferme_connexion();
function pf_verif_reglement_sur_commande_client($vv_action_cleunik){
	/*
	$sql_req=<<<EOT
	SELECT f3.montant_paye FROM _graal_act f1 left join _echeancier f3 on f3.action_cleunik=f1.action_cleunik_droite where f1.action_cleunik_gauche in(SELECT f1.action_cleunik_droite as action_liv FROM _graal_act f1 where f1.action_cleunik_gauche=70002266 and f1.choix_cleunik_droite=-117
union
SELECT f1.action_cleunik_gauche as action_liv FROM _graal_act f1 where f1.action_cleunik_droite=$vv_action_cleunik and f1.choix_cleunik_gauche=-117) and f1.choix_cleunik_droite=-115
union
SELECT f3.montant_paye FROM _graal_act f1 left join _echeancier f3 on f3.action_cleunik=f1.action_cleunik_gauche where f1.action_cleunik_droite in(SELECT f1.action_cleunik_droite as action_liv FROM _graal_act f1 where f1.action_cleunik_gauche=70002266 and f1.choix_cleunik_droite=-117
union
SELECT f1.action_cleunik_gauche as action_liv FROM _graal_act f1 where f1.action_cleunik_droite=$vv_action_cleunik and f1.choix_cleunik_gauche=-117) and f1.choix_cleunik_gauche=-115
EOT;
*/
$sql_req=<<<EOT
	SELECT f3.montant_paye FROM _graal_act f1 left join _echeancier f3 on f3.action_cleunik=f1.action_cleunik_droite where f1.action_cleunik_gauche in(SELECT f1.action_cleunik_droite as action_liv FROM _graal_act f1 where f1.action_cleunik_gauche=$vv_action_cleunik and f1.choix_cleunik_droite=-117
union
SELECT f1.action_cleunik_gauche as action_liv FROM _graal_act f1 where f1.action_cleunik_droite=$vv_action_cleunik and f1.choix_cleunik_gauche=-117) and f1.choix_cleunik_droite=-115
union
SELECT f3.montant_paye FROM _graal_act f1 left join _echeancier f3 on f3.action_cleunik=f1.action_cleunik_gauche where f1.action_cleunik_droite in(SELECT f1.action_cleunik_droite as action_liv FROM _graal_act f1 where f1.action_cleunik_gauche=$vv_action_cleunik and f1.choix_cleunik_droite=-117
union
SELECT f1.action_cleunik_gauche as action_liv FROM _graal_act f1 where f1.action_cleunik_droite=$vv_action_cleunik and f1.choix_cleunik_gauche=-117) and f1.choix_cleunik_gauche=-115
EOT;

	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
		$montant_paye=fa_nn_zero($row['montant_paye']);
	if ($montant_paye!=0){
		//echo "Payé sur commande";
		$vl_b_afficher=false;
	} else {
		$vl_b_afficher=true;
	}
	_graal_libere_requete_bd($result);
	/*
	echo "**";
	echo $sql_req;
	*/
	//echo $montant_paye;
	return $vl_b_afficher;
}

?>