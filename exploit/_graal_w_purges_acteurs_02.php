<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_w_purges_acteurs_01";
fa_acces_script();
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_genreacteur=fa_recup_param('genreacteur','');
$sql_req="";
switch ($vl_c_genreacteur){
  case "tousss"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0";break;  //  Tous les acteurs
  case "110001"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur;";break;  //  prospects clients
  case "110002"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur;";break;  //  prospects fournisseurs
  case "110003"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur;";break;  //  clients
  case "110004"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur;";break;  //  fournisseurs
  case "110005"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur;";break;  //  autres acteurs
  case "110006"                       : $sql_req.=" DELETE FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur;";break;  //  acteurs indéterminés
  case "toutesactions"                : $sql_req.=" DELETE FROM _actions where action_cleunik<>0;";break;  //  Toutes les actions
  case "tousarticles"                 : $sql_req.=" DELETE FROM _article where art_cleunik<>0;";break;  //  Tous les articles
  case "tousutilisateurs"             : $sql_req.=" DELETE FROM _utilisateur where uti_cleunik<>0;";break;  //  Tous les utilisateurs
  case "toutesconnexions"             : $sql_req.=" TRUNCATE _uti_connexions;";break;  //  Connexions
  case "toutesactions_commerciales"   : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110108,-110109,-110110,-110111,-110112,-110113,-110114,-110115,-110116,-110117,-110133,-110134) and action_cleunik<>0;";break;  //  Toutes les actions commerciales
  case "toutesactions_offcli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110114) and action_cleunik<>0;";break;  //  Offres
  case "toutesactions_demfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110115) and action_cleunik<>0;";break;  //  Demandes
  case "toutesactions_cdecli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110108) and action_cleunik<>0;";break;  //  Commandes clients
  case "toutesactions_cdefou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110109) and action_cleunik<>0;";break;  //  Commandes fournisseur
  case "toutesactions_livcli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110110) and action_cleunik<>0;";break;  //  Bons de livraison client
  case "toutesactions_recfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110111) and action_cleunik<>0;";break;  //  bons de réception fournisseur
  case "toutesactions_faccli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110112) and action_cleunik<>0;";break;  //  Factures clients
  case "toutesactions_avocli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110116,-110117) and action_cleunik<>0;";break;  //  Avoirs clients+ avoirs financiers clients
  case "toutesactions_facfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110113) and action_cleunik<>0;";break;  //  Factures fournisseur
  case "toutesactions_retcli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110133) and action_cleunik<>0;";break;  //  Retours clients
  case "toutesactions_retfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110134) and action_cleunik<>0;";break;  //  Retours fournisseurs
  case "toutesactions_fab"            : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110119) and action_cleunik<>0;";break;  //  Fabrications
  case "tousmousto"                   : $sql_req.=" TRUNCATE _mouvements_stock;";break;  //  Mouvements de stock
  case "courrielsrecusenregistres"    : $sql_req.=" UPDATE _courriel_recus_brut set integre= 5,courriel=NULL WHERE integre=1;";break;  //  courriels enregistrés
  case "courrielsrecussupprimes"      : $sql_req.=" UPDATE _courriel_recus_brut set integre= 5,courriel=NULL WHERE integre=3;";break;  //  courriels supprimés
  case "toutesactions_remban"		: $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110127) and action_cleunik<>0;";break;  //  Remises en banque
  case "reglements_clients"			: $sql_req.=" TRUNCATE _treso_reglement_cli;";break;  //  Réglements clients
  case "reglements_fournisseurs"	: $sql_req.=" TRUNCATE _treso_reglement_fou;";break;  //  Réglements fournisseurs

}
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
 /*
  * Il va falloir vérifier les rattachements des documents ... et purger les documents orphelins
  */
 
session_write_close();
$nombre=_graal_requete_nombre_affecte($sql_req);
$vf_c_echo="$nombre suppressions.".EOL;
switch ($vl_c_genreacteur){
  case "tousss": 
    $sql_req="DELETE FROM _act_interlo where int_cleunik <>0;";
    $nombre=_graal_requete_nombre_affecte($sql_req);
    $vf_c_echo.="$nombre suppressions.".EOL;
    break;
  case "tousmousto": 
    $sql_req="UPDATE _art_stock set dateheure_dermvt=null,qte_stock=0,cumul_entrees=0,cumul_sorties=0;";
    $nombre=_graal_requete_nombre_affecte($sql_req);
    break;
	case "toutesactions_commerciales"   :
  case "toutesactions_offcli"         :
  case "toutesactions_demfou"         :
  case "toutesactions_cdecli"         :
  case "toutesactions_cdefou"         :
  case "toutesactions_livcli"         :
  case "toutesactions_recfou"         :
  case "toutesactions_faccli"         :
  case "toutesactions_avocli"         :
  case "toutesactions_facfou"         :
  case "toutesactions_retcli"         :
  case "toutesactions_retfou"         :
  case "toutesactions_fab"            :	
	$sql_req="delete f2 FROM _documents f2 left join _documents_rattachement f1 using(doc_cleunik) left join _actions f3 on f1.rat_cleunik=f3.action_cleunik where f1.portee=2048 and f3.action_cleunik is null and (select count(*) from _documents_rattachement f4 where f4.doc_cleunik=f1.doc_cleunik)=1";
    $nombre=_graal_requete_nombre_affecte($sql_req);
    break;
  default:
}
echo $vf_c_echo;
?>
