<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_c_quoi=fa_recup_param('vl_c_quoi','');
$vl_c_zone=fa_recup_param('vl_c_zone','');
$vl_c_recherche=fa_recup_param('vl_c_recherche','');
$vl_e_type=intval(fa_recup_param('vl_e_type','1'));
$uti_cleunik=intval(fa_recup_param('uti_cleunik','0'));
$vl_e_langue=intval(fa_recup_param('vl_e_langue','120131'));  //  français par défaut
$vl_e_limit=intval(fa_recup_param('vl_e_limit','0'));
$vl_c_liste=fa_recup_telquel('vl_c_liste_objets','');
switch ($vl_c_quoi) {
  case 'approx':
    switch ($vl_e_type) {
      case 1: 
        switch ($vl_c_zone) {
          case '1': $zone_recherche="_objets_libelle.descriptif";break;//  descriptif
          case '2': $zone_recherche="_objets.titre";break;//  Identifiant
        }
        $sql_req="SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif,_objets.prefixe as prefixe,_objets.source_principal as source,choix_valeur_texte_01 as langue_enclair,concat_ws(' ',prenom, patronyme) as qui,_objets.type_objet as type_objet_clair FROM _objets left join _objets_libelle using(fen_cleunik),_choix, _utilisateur WHERE _utilisateur.uti_cleunik=_objets_libelle.uti_cleunik and choix_cleunik=_objets_libelle.langue and $zone_recherche like '$vl_c_recherche%'  and _objets_libelle.langue=$vl_e_langue and _objets_libelle.uti_cleunik=$uti_cleunik ORDER BY titre";
        if ($vl_e_limit!=0) {$sql_req.=" limit $vl_e_limit;";}
        break;
      case 2: 
        switch ($vl_c_zone) {
          case '1': $zone_recherche="_elements_libelle.descriptif";break;//  descriptif
          case '2': $zone_recherche="_elements.titre";break;//  Identifiant
        }
        $sql_req = "SELECT _elements.fen_cleunik as fen_cleunik,_elements.ele_cleunik as ele_cleunik,_elements.titre AS titre,_elements_libelle.descriptif AS descriptif,_elements_libelle.commentaire AS commentaire,_elements.type_objet as type_objet,choix_valeur_texte_01 as langue_enclair,concat_ws(' ',prenom, patronyme) as qui FROM _elements left join _elements_libelle using(ele_cleunik),_choix, _utilisateur WHERE _utilisateur.uti_cleunik=_elements_libelle.uti_cleunik and choix_cleunik=_elements_libelle.langue and $zone_recherche like '$vl_c_recherche%'  and _elements_libelle.langue=$vl_e_langue and _elements_libelle.uti_cleunik=$uti_cleunik ORDER BY titre";
        if ($vl_e_limit!=0) {$sql_req.=" limit $vl_e_limit;";}
        break;
    }
    break;
  case 'liste':
    $sql_req = "SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif,_objets.prefixe as prefixe,_objets.source_principal as source FROM _objets left join _objets_libelle using(fen_cleunik) WHERE (_objets_libelle.langue=$vl_e_langue or _objets_libelle.langue is null)  and _objets.titre in($vl_c_liste) ORDER BY titre";
    break;  
  
  default:
    $sql_req = "SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif,_objets.prefixe as prefixe,_objets.source_principal as source FROM _objets,_objets_libelle WHERE _objets.fen_cleunik=_objets_libelle.fen_cleunik and _objets_libelle.langue=$vl_e_langue and _objets.type_objet=$vl_e_type ORDER BY titre";
    $sql_req = "SELECT _objets.fen_cleunik as fen_cleunik,_objets.titre AS titre,_objets_libelle.descriptif AS descriptif,_objets.prefixe as prefixe,_objets.source_principal as source FROM _objets left join _objets_libelle using(fen_cleunik) WHERE (_objets_libelle.langue=$vl_e_langue or _objets_libelle.langue is null)  and _objets.type_objet=$vl_e_type ORDER BY titre";
    break;  
}
//echo $sql_req;
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
while ($row = mysql_fetch_assoc($result)){
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:fen_cleunik NC:parseType="Integer">'.fa_ent_xml($row['fen_cleunik']).'</row:fen_cleunik>');
  echo('<row:titre>'.fa_ent_xml($row['titre']).'</row:titre>');
  echo('<row:descriptif>'.fa_ent_xml($row['descriptif']).'</row:descriptif>');
  echo('<row:prefixe>'.fa_ent_xml($row['prefixe']).'</row:prefixe>');
  echo('<row:source>'.fa_ent_xml($row['source']).'</row:source>');
  switch ($row['type_objet_clair']) {
    case '1':$type_objet_clair="Fenêtre";break;
    case '2':$type_objet_clair="Traitement";break;
    case '3':$type_objet_clair="Dictionnaire";break;
    case '4':$type_objet_clair="Composante de fenêtre";break;
    default:$type_objet_clair=$row['type_objet_clair'];break;
  }
  echo('<row:type_objet_clair>'.fa_ent_xml($type_objet_clair).'</row:type_objet_clair>');
  echo('<row:langue_enclair>'.fa_ent_xml($row['langue_enclair']).'</row:langue_enclair>');
  echo('<row:qui>'.fa_ent_xml($row['qui']).'</row:qui>');

  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
