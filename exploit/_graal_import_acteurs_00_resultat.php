<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_documents.php");
set_time_limit(6000);
$vl_c_modele=fa_recup_param('vl_c_modele','0');
$vl_c_sep=fa_recup_param('separateur','1');
$vl_c_nom_fichier=fa_recup_param('vl_c_nom_fichier','??');
$vl_c_hash=fa_recup_param('hash','');
$vl_c_ged=intval(fa_recup_param('ged','2'));
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_genreacteur=intval(fa_recup_param('vl_e_genreacteur','0'));
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
//session_write_close();

switch ($vl_c_sep) {
  case '1':$sep=';';break;
  case '2':$sep=',';break;
  default:$sep=',';break;
}
//  On attend une première ligne avec le descriptif des colonnes
//  On attend trois colonnes
$name=$_FILES['filename']['name'];
$size=$_FILES['filename']['size'];
$tmp=$_FILES['filename']['tmp_name'];
$type=$_FILES['fichier']['type'];
$error=$_FILES['fichier']['error'];
$row=0;
$sep_ret='|';
$vf_c_echo='';

$vf_e_imp_cleunik=_graal_requete_max("imp_cleunik","_w_import_acteurs");
if (!$handle = fopen($tmp, "r")) {
  $retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
} else {
	//	insertion dans la GED, le cas échéant
	if ($vl_c_ged==1){
		//  Vérification que le hash du document ne soit pas déjà présent
    $sql_req = "select count(*) FROM _documents WHERE hash = '$vl_c_hash';";
    if ($res = _graal_requete_bd($sql_req)) {
      $ligne = mysql_fetch_row($res);
      $nombre_doc=$ligne[0];
	  _graal_libere_requete_bd($res);
      if ($nombre_doc==0){
				$type=fa_mime_type_buffer(file_get_contents($tmp));
				$type=addslashes($type);
				$vl_c_nom_fichier=addslashes($vl_c_nom_fichier);
				$contenu_fichier=addslashes(file_get_contents($tmp));
				if ($contenu_fichier===false) {
					die('-1'.$sep_ret."Impossible de lire le fichier (vl_c_datas)".$sep_ret);
				}
				$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
			  $typedoc=3;   //  Un document d'entreprise
			  $vf_c_retour=fa_insere_document($vf_e_doc_cleunik,"Import fichier adresses de courriel $vl_c_nom_fichier",$typedoc,$size,$tmp,"entrep",0,"","","","");
			  $sql_req00="INSERT INTO _w_import_acteurs (imp_cleunik,doc_cleunik,description,blocnotebrut,dateheurecreation,typeimport,hash,genreimport) VALUES ($vf_e_imp_cleunik,$vf_e_doc_cleunik,'".addslashes("Import fichier $vl_c_nom_fichier ")."','".addslashes("Taille $size")."',now(),$vl_c_modele,'$vl_c_hash',$vl_e_genreacteur)";
          	$result_00=_graal_requete_bd($sql_req00);
			$retour=$vf_e_imp_cleunik.$sep_ret."ok".$sep_ret;
			die($retour);
				 
      } else {
      	$sql_req = "select count(*) FROM _w_import_acteurs WHERE hash = '$vl_c_hash';";
		if ($res = _graal_requete_bd($sql_req)) {
	      $ligne = mysql_fetch_row($res);
	      $nombre_doc=$ligne[0];
		  _graal_libere_requete_bd($res);
	      if ($nombre_doc==0){
			$sql_req = "select doc_cleunik FROM _documents WHERE hash = '$vl_c_hash';";
    		if ($res = _graal_requete_bd($sql_req)) {
	      		$ligne = mysql_fetch_row($res);
	      		$vf_e_doc_cleunik=$ligne[0];
		  		_graal_libere_requete_bd($res);
				$sql_req00="INSERT INTO _w_import_acteurs (imp_cleunik,doc_cleunik,description,blocnotebrut,dateheurecreation,typeimport,hash,genreimport) VALUES ($vf_e_imp_cleunik,$vf_e_doc_cleunik,'".addslashes("Import fichier $vl_c_nom_fichier ")."','".addslashes("Taille $size")."',now(),$vl_c_modele,'$vl_c_hash',$vl_e_genreacteur)";
	      		$result_00=_graal_requete_bd($sql_req00);
				$retour=$vf_e_imp_cleunik.$sep_ret."ok".$sep_ret;
				die($retour);
			}
		  }
      }
    }
    }
	if ($vf_c_echo!='ok') {
		$retour='-1'.$sep_ret.$vf_c_echo.$sep_ret;
		die($retour);
	}
	}
}
echo $retour;
?>
