<?php
include("_graal_header_txt.inc.php");

$query = $HTTP_RAW_POST_DATA;
if ($query=='') die('Error: SQL command must be provided');

$command = strtolower(substr($query,0,strpos($query,' ')));
if (strpos('select,insert,update,delete,show',$command)===false) die('Error: Only SELECT/INSERT/UPDATE/DELETE is allowed');

$connection = mysql_connect($sql_serveur,$sql_user,$sql_passwd) or die('Error: Could not connect to server - ' . mysql_error());
$result = mysql_query("SET CHARACTER SET 'utf8';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$result = mysql_query("SET collation_connection = 'utf8_general_ci';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
//$sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . mysql_error());
mysql_select_db($sql_bdd,$connection) or die('Error: Could not select database - ' . $sql_bdd);
$result = mysql_query($query,$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);

switch ($command) {
    case 'insert': $newkey = mysql_insert_id(); echo "OK:$newkey"; break;
    case 'update': echo "OK"; break;
    case 'delete': echo "OK"; break;
    case 'select' or 'show': 
        echo "data={\n";
        echo "\trows:{\n";

        $i = 0;
        while ($line = mysql_fetch_array($result, MYSQL_ASSOC)) 
        {
            if ($i>0) { echo ",\n"; }
            echo "\t\t$i:[";
            $j = 0;
            foreach ($line as $field)
            {
                if ($j>0) { echo ","; }
                //echo is_null($field)?"null":"'.fa_ent_xml($field).'";
                if(is_null($field)) {echo "null";} else {echo '"'.fa_ent_xml($field).'"';}
                $j++;
            }
            echo "]";
            $i++;
        }
        echo "\n";
        echo "\t}\n";
        echo "}";

        mysql_free_result($result);
        break;

    default:
        echo "Error: SQL command not understood";
        mysql_free_result($result);
        break;
}

mysql_close($connection);

?>
