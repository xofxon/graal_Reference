<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_url_absolue.php");
include("_graal_fonctions_rss.php");
$vl_c_url_absolue=fa_url_absolue();

$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_rss_01";
//fa_acces_script();	Désactivé ici car trop d'origines possibles -> traité au cas pas cas
/*
****************************************************************************************
**********  Fenêtre de gestion des flux RSS générés par GRAAL  ********
****************************************************************************************
*/
define('EOL', "\r\n");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_mini=intval(fa_recup_session('borne_mini','0'));
$vl_e_maxi=intval(fa_recup_session('borne_maxi','0'));
$vf_e_doc_cleunik=intval(fa_recup_param('vf_e_doc_cleunik','0'));
$vf_c_action=fa_recup_param('vf_c_action','0');
$vf_c_titre=fa_recup_param('vf_c_titre','');
$vf_c_descriptif_sommaire=fa_recup_param('vf_c_descriptif_sommaire','');
$vf_c_nb_affichages=intval(fa_recup_param('vf_c_nb_affichages','10'));
$vf_c_genre=intval(fa_recup_param('vf_c_genre','1'));
$vf_c_type=intval(fa_recup_param('vf_c_type','1'));
$vf_c_niveau=intval(fa_recup_param('vf_c_niveau','1'));
$vf_c_uti_cleunik_connexion=intval(fa_recup_param('vf_c_uti_cleunik','1'));
$detail_rss=intval(fa_recup_param('detail_rss','-999999'));
$vf_c_echo='';
$typedoc=7;
/*
le 29 septembre 2010
  typedoc    1 -> Liens,
             2 -> Notes,
             3 -> Documents,
             4 -> Dossier,
             5 -> courriels envoyés,
             6 -> modèles de courriels texte,
             7 -> Flux RSS,
             8 -> requêtes personnelles,
             9 -> images des articles, logos de l'entreprise
            10 -> modèles de courriels HTML,
            11 -> modèles de notes,
            12 -> modèles de notification de lecture,
            13 -> pièces jointes,
            14 -> menus arbres personalisés
            15 -> menus pages personalisés
           101 -> modèles textes entêtes offres clients,
           102 -> modèles textes pied offres clients,
           111 -> modèles textes entêtes commandes clients,
           112 -> modèles textes pied commandes clients,
           121 -> modèles textes entêtes livraison clients,
           122 -> modèles textes pied livraison clients,
           131 -> modèles textes entêtes facture clients,
           132 -> modèles textes pied facture clients,
           141 -> modèles textes entêtes demandes fournisseur,
           142 -> modèles textes pied demandes fournisseur,
           151 -> modèles textes entêtes commandes fournisseur,
           152 -> modèles textes pied commandes fournisseur,
           153 -> modèles formulaires de fiches palettes,
           154 -> fichiers pdf de filigranne de documents,
           900 -> Conditions générales de vente
           901 -> Bloc de désinscription pour emailing html
           902 -> Bloc de désinscription pour emailing texte
           903 -> Bloc de sondage pour emailing html
           904 -> Bloc de sondage pour emailing texte
*/
$droits_proprio=15;
$droits_groupe=0;
$droits_lambda=0;
switch (TRUE) {
  case $vf_c_action=='verifier_droits_acces': //  Vérification que l'utilisateur a bien accès au document
		$sql_req = "select droits_proprio from _droits_doc where doc_cleunik=$vf_e_doc_cleunik AND uti_cleunik=$vl_e_uti_cleunik";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    $vf_c_echo=$row['droits_proprio'];
    break;
  case $vf_c_action=='supprimer': //  Suppression d'un document
  	fa_acces_script();
	  /*
		$sql_req="SELECT f1.descriptif_sommaire,f1.titre,f1.emplacement,f2.nb_affiche from _documents f1 inner join _documents_rss f2 using(doc_cleunik) where f1.doc_cleunik=$vf_e_doc_cleunik;";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$vf_c_nb_affichages=$row['nb_affiche'];
		$vl_c_nom=$row['emplacement'];
		$xml = fa_rss_cree_entete_01();
	  $xml .=$row['descriptif_sommaire'];
	  $xml .=$row['titre'];
		_graal_libere_requete_bd($result);
		if (file_exists($vl_c_nom)) {
			if (unlink($vl_c_nom)=== FALSE){
	      echo "Impossible d'effectuer la suppression initiale du fichier ($fichier_ori)";
				exit;
			}
		}
		*/
		/*
		 * suppression des actions
		 *
		 * permet de créer un fichier RSS vide donc même s'il est toujours appelé, il est inutilisable
		 */
		$sql_req = "DELETE FROM _documents_rss_actions WHERE doc_cleunik = $vf_e_doc_cleunik";
		$xml = fa_rss_cree_corpus($vf_e_doc_cleunik);
    $sql_req = "DELETE FROM _documents WHERE doc_cleunik = $vf_e_doc_cleunik";
		$res = _graal_requete_bd($sql_req);
	  if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
    break;
  case $vf_c_action=='ajouter_action'://	Ajout d'une action
		$vf_e_ordre=_graal_requete_max_particuliere("ordre","_documents_rss");
		$sql_req="UPDATE _document_rss set ordre=$vf_e_ordre;";
    $res=_graal_exec_requete($sql_req);
		$c_uuid=md5(uniqid(rand(), true));
		$sql_req = "INSERT INTO _documents_rss_actions set doc_cleunik=$vf_e_doc_cleunik,action_cleunik=$detail_rss,ordre=$vf_e_ordre,dateheurecreation=now(),etat=1,c_uuid='$c_uuid';";
    $res=_graal_exec_requete($sql_req);
		//echo $sql_req;
	  if($res === false) {
	  	echo 'Erreur';
		} else {
			$xml = fa_rss_cree_corpus($vf_e_doc_cleunik);
			$sql_req="UPDATE _documents set document='".addslashes($xml)."' where doc_cleunik=$vf_e_doc_cleunik;";
			$res=_graal_exec_requete($sql_req);
			if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
		}
  	break;
  case $vf_c_action=='ajouter': //  Ajout d'un flux
	  fa_acces_script();
	  $vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
		$vl_c_nom=md5(uniqid(rand(), true)).".xml";
		$vl_c_emplacement_prive=$vl_c_url_absolue."rss/$vl_c_nom";
		$vl_c_emplacement_publi="http://xsoftware.fr/rss/$vl_c_nom";
		$vf_c_emplacement=$vl_c_nom;
		/*
		 * On crée le flux rss vide
		 */
		$xml = fa_rss_cree_entete_01($vl_c_url_absolue,$vf_c_emplacement,$vf_c_titre,$vf_c_descriptif_sommaire);
	  $xml .=$vf_c_descriptif_sommaire;
	  $xml .=$vf_c_titre;
		$xml .='</channel></rss>';
		fa_rss_ecrire_flux($vl_c_nom,$xml,$vf_c_type);
	  $sql_req = "INSERT INTO _documents set doc_cleunik=$vf_e_doc_cleunik,typedoc=$typedoc,emplacement= '$vf_c_emplacement',titre='$vf_c_titre',dateheurecreation = now(),descriptif_sommaire = '$vf_c_descriptif_sommaire',document='".addslashes($xml)."';";
		$res = _graal_requete_bd($sql_req);
	  if($res === false) {
	  	echo 'Erreur';
		} else {
	    $sql_req = "INSERT INTO _droits_doc set doc_cleunik=$vf_e_doc_cleunik,uti_cleunik=$vl_e_uti_cleunik,droits_proprio=$droits_proprio,droits_groupe=$droits_groupe,droits_lambda=$droits_lambda;";
	    $vf_c_echo=_graal_exec_requete($sql_req);
	    $sql_req = "INSERT INTO _documents_rattachement set doc_cleunik=$vf_e_doc_cleunik,rat_cleunik=$vl_e_uti_cleunik,portee=$vl_e_utilis;";
	    $vf_c_echo=_graal_exec_requete($sql_req);
			$sql_req = "INSERT INTO _documents_rss set doc_cleunik=$vf_e_doc_cleunik,nom='$vl_c_nom',nb_affiche=$vf_c_nb_affichages,dateheurecreation=now(),typeacces=$vf_c_type,genre=$vf_c_genre,niveauacces=$vf_c_niveau,emplacement_prive='$vl_c_emplacement_prive',emplacement_publi='$vl_c_emplacement_publi',uti_cleunik=$vf_c_uti_cleunik_connexion;";
	    $vf_c_echo=_graal_exec_requete($sql_req);
		}
	  break;
  case $vf_c_action=='modifier':  //  Modification d'un document
	  fa_acces_script();
		$xml = fa_rss_cree_corpus($vf_e_doc_cleunik);
	  $sql_req = "update _documents set document='".addslashes($xml)."' titre = '$vf_c_titre',descriptif_sommaire='$vf_c_descriptif_sommaire',dateheuremodif=now() where doc_cleunik=$vf_e_doc_cleunik";
	  $res = _graal_requete_bd($sql_req);
	  if($res === false) {
	  	echo 'Erreur';
		} else {
			$sql_req = "UPDATE _documents_rss set nb_affiche=$vf_c_nb_affichages,dateheuremodif=now(),typeacces=$vf_c_type,genre=$vf_c_genre,niveauacces=$vf_c_niveau,uti_cleunik=$vf_c_uti_cleunik_connexion WHERE doc_cleunik=$vf_e_doc_cleunik;";
			$res = _graal_requete_bd($sql_req);
		  if($res === false) {echo 'Erreur';} else {$vf_c_echo='ok';}
		}
		break;
}
//  Traitement de la reqûete
_graal_ferme_connexion();
echo $vf_c_echo;

?>
