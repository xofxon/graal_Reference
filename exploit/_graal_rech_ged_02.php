<?php
require("_graal_fonctions_diverses.php");
include("_graal_var_portee.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_t_listecles=fa_recup_param('vl_t_listecles','');

$vl_e_portee_cleunik=intval(fa_recup_param('vl_e_portee_cleunik','0'));
$vl_c_sortie=fa_recup_param('sortie','rdf');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_c_qui=fa_recup_param('vl_c_qui','888888');
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
switch ($vl_c_actifs) {
  case '3': // Panier ou requête
    /*
    $sql_req = "SELECT panier_requete_selection as req,panier_resultat,panier_type FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    if ($row['panier_type']==1) {
      $vl_act_cleunik=$row['panier_resultat'];
      _graal_libere_requete_bd($result);
    } else {
      $sql_req = $row['req'];
      _graal_libere_requete_bd($result);
      $result = _graal_requete_bd($sql_req);
      $vl_e_panier="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_e_panier.=$row[0].',';
      }
    }
    $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur,codealphanum15 as code,mnemotechnique as mnemotechnique,actif as actif FROM `_acteurs`,`_choix` WHERE _choix.choix_cleunik=_acteurs.typeacteur and act_cleunik IN($vl_act_cleunik)";
  */
    break;
  case '1': 
  case '2': 
  case '0': 
    switch ($vl_c_type) {
      case '0': //  Liste de clés
      /*
        $vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_act_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_act_cleunik!="") {
          $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
        }
        $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur,codealphanum15 as code,mnemotechnique as mnemotechnique,actif as actif FROM `_acteurs`,`_choix` WHERE _choix.choix_cleunik=_acteurs.typeacteur and act_cleunik IN($vl_act_cleunik)";
      */
        break;
      case '1': //  recherche orthographique 
        switch ($vl_c_qui) {
          case '777777': //images de tous les articles ( le reste est géré dans _graal_rech_ged_01.php)
            $sql_req = "SELECT unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_documents.tailledoc as tailledoc  FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_articl and  _documents_rattachement.rat_cleunik=$vl_e_portee_cleunik and typedoc=9";
            break;
          case 'images_articles': //images de tous les articles ( le reste est géré dans _graal_rech_ged_01.php)
            $sql_req = "SELECT unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_documents.tailledoc as tailledoc,_article.description as article_description FROM `_documents` ,`_documents_rattachement`,`_article` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_articl and typedoc=9 and _documents_rattachement.rat_cleunik=_article.art_cleunik";
            break;
          case 'unlogoentrep': //logos de l'entreprise ( le reste est géré dans _graal_rech_ged_01.php)
            $sql_req = "SELECT unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_documents.tailledoc as tailledoc  FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_entrep and  _documents_rattachement.rat_cleunik=$vl_e_portee_cleunik and typedoc=9";
            break;
        }
        switch ($vl_c_zone) {
          case '1': //  titre
            $sql_req.="  and _documents.titre like '$vl_c_recherche%'";
            break;
          case '2': //  Descriptif sommaire
            $sql_req.=" and _documents.descriptif_sommaire like '$vl_c_recherche%'";
            break;
          case '3': //  emplacement
            $sql_req.="  and _documents.emplacement like '$vl_c_recherche%'";
            break;
          case '4': //  origine
            $sql_req.=" and _documents.origine like '$vl_c_recherche%'";
            break;
          }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" ORDER BY `titre` ASC";break;//  titre
          case '2': $sql_req.=" ORDER BY `descriptif_sommaire` ASC";break;//  descriptif sommaire
          case '3': $sql_req.=" ORDER BY `emplacement` ASC";break;//  Emplacement
          case '4': $sql_req.=" ORDER BY `origine` ASC";break;//  origine
        }
        break;
      case '2' :  //  recherche phonétique
        break;
    }
   break;    
}
switch ($vl_c_qui) {
  case '888888': //  Favoris, ou liste, pas de limit
    break;
  default:
    switch ($vl_e_critere_cleunik) {
      case 0: //  pas de gestion du critère
        $sql_req.= " LIMIT 0, 100";
        break;
      default:
        //  no limit
    }
    break;
}
//echo $sql_req;
switch ($vl_c_sortie) {
  case "das":
    include("_graal_das_ged_02.php");
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
