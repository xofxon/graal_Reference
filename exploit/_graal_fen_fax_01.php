<?php
include("_graal_header_xul.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_cryptage.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_intel_cleunik=intval(fa_recup_param('vl_e_intel_cleunik','-1'));
$vl_e_action_cleunik=intval(fa_recup_param('action_cleunik','-1'));
$vl_action_cleunik_liee=intval(fa_recup_param('vl_action_cleunik_liee','-1'));
$vl_c_type_fax=fa_recup_param('type','texte');
$vl_c_genre=fa_recup_param('genre','normal');
$vl_e_int_cleunik_recvoc=intval(fa_recup_param('vl_e_int_cleunik_recvoc','-1'));
$vl_doc_cleunik=intval(fa_recup_param('vl_doc_cleunik','-99999'));
$vl_c_nomdoc=fa_recup_param('vl_c_nomdoc','???');
switch ($vl_c_genre) {
  case "reponse":
    break;
  case "transfert":
    break;
  case "normal":
    break;
  case "renvoi":
    break;
}
switch ($vl_c_type_fax) {
  case "texte"	:$vl_c_id_fenetre="Fen_01026";$vl_c_cache_pj="true";$vl_c_cache_message="false";$vl_e_typedoc="6";break;//Envoi de fax texte format texte brut
  case "doc" 	:$vl_c_id_fenetre="Fen_01027";$vl_c_cache_pj="false";$vl_c_cache_message="true";$vl_e_typedoc="10";break;//Envoi de documents par fax
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_b_ajout=$vl_tb_droits[1];
$vl_b_modif=$vl_tb_droits[2];
$vl_b_suppr=$vl_tb_droits[3];
$vl_b_impri=$vl_tb_droits[4];
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_brz_101=fa_recup_dico("brz_101");
$vl_c_brz_102=fa_recup_dico("brz_102");
$vl_c_brz_103=fa_recup_dico("brz_103");
$vl_c_brz_104=fa_recup_dico("brz_104");
$vl_c_brz_105=fa_recup_dico("brz_105");
$vl_c_brz_106=fa_recup_dico("brz_106");
$vl_c_brz_107=fa_recup_dico("brz_107");
$vl_c_brz_108=fa_recup_dico("brz_108");
$vl_c_brz_109=fa_recup_dico("brz_109");
$vl_c_brz_110=fa_recup_dico("brz_110");



$vl_c_dico_00007=fa_recup_dico("dico_00007");
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_dico_00129=fa_recup_dico("dico_00129");
$vl_c_dico_00149=fa_recup_dico("dico_00149");
//  On recherche l'interlocuteur à partir du numéro de fax
if ($vl_e_intel_cleunik!=-1){
  $sql_req="SELECT concat_ws(' ',prenom,patronyme) as qui,_act_interlo_fax.intel_05 as nofax,_act_interlo_fax.int_cleunik as int_cleunik,_act_interlo.act_cleunik as act_cleunik FROM _act_interlo_fax,_act_interlo where _act_interlo.int_cleunik=_act_interlo_fax.int_cleunik and _act_interlo_fax.intel_cleunik=$vl_e_intel_cleunik;"; 
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_e_int_cleunik=$row['int_cleunik'];
  $vl_e_act_cleunik=$row['act_cleunik'];
  $vl_c_qui=fa_ent_xml($row['qui']);
  $vl_c_nofax=$row['nofax'];
  _graal_libere_requete_bd($result);
}
//  On recherche l'action d'origine
$vl_sujet="";
$vl_c_message_text_b64="";
$vl_c_message_html_b64="_graal_page_blanche_01.php";

//  On recherche tous les comptes possibles pour l'utilisateur  
$vl_compte="<hbox>";
$sql_req = "SELECT _uti_cpt_bal.uticptbal_cleunik as cleunik,_uti_cpt_bal.titre as titre,_uti_cpt_bal.compte AS compte FROM _uti_cpt_bal,_droits_cpt_bal where _droits_cpt_bal.uti_cleunik=$vl_e_uti_cleunik and _droits_cpt_bal.uticptbal_cleunik=_uti_cpt_bal.uticptbal_cleunik and _uti_cpt_bal.genre = 2 order by titre;";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_compte.="<label value='$vl_c_boj_105' />";
}
else {
  $vl_b_envoi=false;
  $vl_compte.="<label value='$vl_c_boj_106'/><menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_emetteur'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)) {
  	$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
		$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
      $vl_b_envoi=true;
      $vl_compte.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre'])). "' _graal_cleunik='".$row['cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' selected='true'/>";
  }
  $vl_compte.="</menupopup></menulist>";
  if ($vl_b_envoi==true) {
    $vl_bouton_envoi="<button width='40' flex='1' id='bt_enregistrer' label='$vl_c_brz_104' crop='end' dir='normal' oncommand='pf_validation();' tabindex='5'/>";
  }
}
$vl_compte.="</hbox>";
_graal_libere_requete_bd($sql_result);
include("_graal_header_winxul.inc.php");
include("_graal_header_textfied.inc.php");
echo <<<END
<window context="graal_cp00" _graal_act_cleunik="$vl_e_act_cleunik" _graal_int_cleunik="$vl_e_int_cleunik" title="$vl_c_bak_102" id="_graal_courriel_01" onload="fa_aa(this);pf_etat_fen('ini')" onunload="pf_onunload();" $c_xmlns>
$vl_c_graal_cp00
<popup id="graal_cp_li_pj"><menuitem label="$vl_c_brz_108" oncommand="pf_supprime_ligne('li_pj');"/></popup>
END;
include("js/_graal_03.js.php");
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include_once("js/_graal_05_dates.js.php");
include("js/_graal_fax_01.js.php");
include("js/_graal_fax_01_complement.js");
echo <<<END
  
      <hbox flex="1"> 
      <vbox id="messagepanel" flex="1">
        <vbox>
$vl_compte
<groupbox >
<hbox>
        <vbox flex="1">
               <hbox flex="1">
          <toolbarbutton id="bt_panier_dest_a" class="al02" onclick="pf_ouvre_panier_fax()" />
         <label value="$vl_c_brz_101"/> 
        <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
          minlength="2"
          maxrows="50"
          ref="urn:suggest:values"
          label="?label"
          properties="?prop"
          issuggest="?issuggest"
          _graal_cleunik=""
          id="dest_a"
          tabindex="1"
        />
        <toolbarbutton id="bt_dest_a" class="ad02" label="$vl_c_brz_102" oncommand="pf_sel_fax();" tabindex="2"/>
        
		</hbox>
        <textbox id="tb_fax_destinataire" _graal_intel_cleunik="" readonly="true"/>            
        </vbox>        
          
       


</hbox>
</groupbox>

          <hbox flex="1">
          <label value="$vl_c_brz_105"/>
          <textbox flex="1" id="tb_sujet"   tabindex="3"/>
          </hbox>
		  <vbox id="vb_pj" collapsed="$vl_c_cache_pj" flex="1">
    <hbox flex="1">
      <toolbarbutton observes="broadcaster_01" class="al02" tooltiptext="$vl_c_brz_106" id="tb_ouvre_fichier_disque" oncommand="pf_ouvre_fichier('disque');"/>
      <toolbarbutton observes="broadcaster_01" class="ai03" tooltiptext="$vl_c_brz_107" id="tb_ouvre_fichier_ged" oncommand="pf_ouvre_fichier('ged');"/>
      <hbox flex="1">
        <textbox flex="7" observes="broadcaster_01" id="tb_emplacement"   maxlenght="260"/>
      </hbox> 
    </hbox>
    <listbox context="graal_cp_li_pj" id="li_pj">
      <listhead >
        <listheader label="$vl_c_bak_134" />
      </listhead>
      <listcols >
        <listcol flex="1"/>
      </listcols>
    </listbox>
  </vbox>   
$vl_modeles
        </vbox>
		<textbox id="tb_message" multiline="true" wrap="off" flex="1" value="" tabindex="4" collapsed="$vl_c_cache_message"/>
	<spacer flex="1"/>	
      <vbox>  
      <deck id="dk_02" selectedIndex="0" flex="1">
        <_graal_deck value="Deck boutons de validation">
          <button flex="1" id="bt_raf" label="$vl_c_brz_103" crop="end" dir="normal" oncommand="pf_raf();" tabindex="5"/>
          $vl_bouton_envoi
          <button flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
		  <button flex="1" id="bt_raz" label="$vl_c_dico_00129" crop="end" dir="normal" oncommand="pf_etat_fen('annuler');" />
		  <button id="bt_info_fen" class="ab19" label="$vl_c_dico_00149"  crop="end" dir="normal" oncommand="fa_infos_fenetre('$vl_c_win_id')" />
        </_graal_deck>
        <_graal_deck value="Deck boutons retour validation">
          <button width="40" flex="1" id="bt_validation_ok" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="fa_gid('dk_02').selectedIndex=0" />
        </_graal_deck>
      </deck>
	  </vbox>
   </vbox>
   </hbox>
 </window>
END;
?>
