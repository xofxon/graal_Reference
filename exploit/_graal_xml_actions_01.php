<?php
include("_graal_header_xml.inc.php");
$vl_action_cleunik=intval(fa_recup_param(vl_e_action_cleunik,'-1'));
session_write_close();
$sql_req="SELECT gestion_duree,action_cleunik as `action_cleunik`,choix_cleunik as `choix_cleunik`,date(dateheuredebut) as `datedebut`,";
$sql_req.=_graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,date(dateheurefin) as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,";
$sql_req.=" dateheurecreation as `dateheurecreation`,dateheuremodif as `dateheuremodif`,blocnote_brut as `blocnote_brut`,blocnote_riche as `blocnote_riche`,";
$sql_req.=" position as `position`,description as `description`,c_uuid as `c_uuid`,action_type as `action_type`,lieu as `lieu`,confidentialite as `confidentialite`,";
$sql_req.=" priorite as `priorite`,statut as `statut`,dateheureprevue as `dateheureprevue`,realisation as `realisation`,sujet as `sujet`,reference as `reference`,";
$sql_req.=" (SELECT count(*) FROM _actions_choix_fixes where action_cleunik=$vl_action_cleunik) as nombre_criteres,";
$sql_req.=" (SELECT count(*) FROM _graal where action_cleunik=$vl_action_cleunik) as nombre_graal,";
$sql_req.=" (SELECT count(*) FROM _graal_act where action_cleunik_gauche=$vl_action_cleunik or action_cleunik_droite=$vl_action_cleunik) as nombre_graal_act,";
$sql_req.=" (SELECT count(*) FROM _documents_rattachement where portee = 2048 and rat_cleunik=$vl_action_cleunik) as nombre_rattachements,";
$sql_req.=" (SELECT count(*) FROM _actions_commentaires where action_cleunik=$vl_action_cleunik) as nombre_commentaires";

$sql_req.=" FROM _actions where action_cleunik=$vl_action_cleunik;";


$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
$row = mysql_fetch_assoc($result);
echo('<Description>');
//echo $sql_req;
// parseType = indication pour le type des donn√©es, utile pour le tri sur la colonne
echo('<action_cleunik data="'.fa_ent_xml($row['action_cleunik']).'"/>');
echo('<genre data="'.fa_ent_xml($row['choix_cleunik']).'"/>');
$dd=$row['datedebut'];if ($dd=='0000-00-00') {$dd='1961-01-23';}
$df=$row['datefin'];if ($df=='0000-00-00') {$df=$dd;}
$hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
$hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
echo('<datedebut data="'.fa_ent_xml($dd).'"/>');
echo('<datefin data="'.fa_ent_xml($df).'"/>');
echo('<heuredebut data="'.fa_ent_xml($hd).'"/>');
echo('<heurefin data="'.fa_ent_xml($hf).'"/>');
echo('<dateheurecreation data="'.fa_ent_xml($row['dateheurecreation']).'"/>');
echo('<dateheuremodif data="'.fa_ent_xml($row['dateheuremodif']).'"/>');
echo('<blocnote_brut data="'.fa_ent_xml($row['blocnote_brut']).'"/>');
echo('<blocnote_riche data="'.fa_ent_xml($row['blocnote_riche']).'"/>');
echo('<position data="'.fa_ent_xml($row['position']).'"/>');
echo('<description data="'.fa_ent_xml($row['description']).'"/>');
echo('<c_uuid data="'.fa_ent_xml($row['c_uuid']).'"/>');
echo('<action_type data="'.fa_ent_xml($row['action_type']).'"/>');
echo('<lieu data="'.fa_ent_xml($row['lieu']).'"/>');
echo('<confidentialite data="'.fa_ent_xml($row['confidentialite']).'"/>');
echo('<priorite data="'.fa_ent_xml($row['priorite']).'"/>');
echo('<statut data="'.fa_ent_xml($row['statut']).'"/>');
echo('<dateheureprevue data="'.fa_ent_xml($row['dateheureprevue']).'"/>');
echo('<realisation data="'.fa_ent_xml($row['realisation']).'"/>');
echo('<sujet data="'.fa_ent_xml($row['sujet']).'"/>');
echo('<reference data="'.fa_ent_xml($row['reference']).'"/>');
echo('<duree data="'.fa_ent_xml($row['gestion_duree']).'"/>');
if ($row['nombre_criteres']==0) {
	echo('<nombre_criteres data=""/>');
} else {
	echo('<nombre_criteres data=" ('.fa_ent_xml($row['nombre_criteres']).')"/>');
}
if ($row['nombre_graal']==0) {
	echo('<nombre_graal data=""/>');
	echo('<nombre_graal_brut data="0"/>');
} else {
	echo('<nombre_graal data=" ('.fa_ent_xml($row['nombre_graal']).')"/>');
	echo('<nombre_graal_brut data="'.fa_ent_xml($row['nombre_graal']).'"/>');
}
if ($row['nombre_graal_act']==0) {
	echo('<nombre_graal_act data=""/>');
} else {
	echo('<nombre_graal_act data=" ('.fa_ent_xml($row['nombre_graal_act']).')"/>');
}
if ($row['nombre_rattachements']==0) {
	echo('<nombre_rattachements data=""/>');
} else {
	echo('<nombre_rattachements data=" ('.fa_ent_xml($row['nombre_rattachements']).')"/>');
}
if ($row['nombre_commentaires']==0) {
	echo('<nombre_commentaires data=""/>');
} else {
	echo('<nombre_commentaires data="'.fa_ent_xml($row['nombre_commentaires']).'"/>');
}
_graal_libere_requete_bd($result);
echo('</Description>');
_graal_ferme_connexion();
?>
