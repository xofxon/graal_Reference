<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$date_deb=fa_recup_param('date_deb','20610123');
$date_fin=fa_recup_param('date_fin','19610123');
$ml_art_01=intval(fa_recup_param('ml_art_01',1));
$ml_art_02=intval(fa_recup_param('ml_art_02',2));
$ml_art_03=intval(fa_recup_param('ml_art_03',4));
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$nombre=intval(fa_recup_param('nombre',0));
switch ($ml_art_03) {
  case  1: $fic_cial="offcli";$coeff="1";break;
  case  2: $fic_cial="cdecli";$coeff="1";break;
  case  3: $fic_cial="livcli";$coeff="1";break;
  case  4: $fic_cial="faccli";$coeff="case f4.choix_cleunik WHEN -110112 THEN 1 ELSE -1 END";break; //  Factures et avoirs (-110116,-110117) regroupés
  case  5: $fic_cial="demfou";$coeff="1";break;
  case  6: $fic_cial="cdefou";$coeff="1";break;
  case  7: $fic_cial="recfou";$coeff="1";break;
  case  8: $fic_cial="facfou";$coeff="1";break;
  case  9: $fic_cial="faccli";$coeff="1";break;
  case 10: $fic_cial="faccli";$coeff="1";break;
}
switch ($ml_art_04) {
  case 1: //  Regroupement par article
    switch ($ml_art_02) {
      case 1: $sql_req="Select @rang:=@rang+1 AS z00,sum(f5.qte*($coeff)) as z01";break;
      case 2: $sql_req="Select @rang:=@rang+1 AS z00,sum(f5.qte*f1.pu*($coeff)) as z01";break;
      case 3: $sql_req="Select @rang:=@rang+1 AS z00,count(*) as z01";break;
      case 4: $sql_req="Select @rang:=@rang+1 AS z00,sum((f5.qte*f1.pu*($coeff))*(1-(f1.remise_taux/100))) as z01";break;
    }
    $sql_req.=",f1.art_cleunik as z02,f2.code as z03,f2.description as z04";
    $sql_req.=" from _".$fic_cial."_lignes f1,_article f2,_".$fic_cial."_entetes f3,_actions f4,_".$fic_cial."_lignes_qte f5 where f4.action_cleunik=f3.action_cleunik and f1.commercial_cleunik=f3.commercial_cleunik and f1.art_cleunik=f2.art_cleunik and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
    break;
}
switch ($ml_art_03) {
  case  1: break;
  case  2: break;
  case  3: break;
  case  4: $sql_req.=" and f4.choix_cleunik in(-110112,-110116,-110117)";break; 
  case  5: break;
  case  6: break;
  case  7: break;
  case  8: break;
  case  9: $sql_req.=" and f4.choix_cleunik in(-110112)";break;
  case 10: $sql_req.=" and f4.choix_cleunik in(-110116,-110117)";break;
}
$sql_req.=" group by z02,z03,z04";
switch ($ml_art_01) {
  case 1: $sql_req.=" order by z01 desc";break;
  case 2: $sql_req.=" order by z01 asc";break;
}
if ($nombre!=0) {$sql_req.=" limit $nombre;";}
_graal_requete_bd("SET @rang=0;");
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
$vl_e_nombre_types=mysql_num_rows($result);
if ($vl_e_nombre_types!=0) { 
  while ($row = mysql_fetch_assoc($result)){
    echo('<RDF:li>'.EOL);
    echo('<RDF:Description>');
    echo('<row:z00 NC:parseType="Integer">'.fa_ent_xml($row['z00']).'</row:z00>');
    echo('<row:z01_tri>'.fa_ent_xml($row['z01']).'</row:z01_tri>');
    echo('<row:z01>'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'</row:z01>');
    echo('<row:z02>'.fa_ent_xml($row['z02']).'</row:z02>');
    echo('<row:z03>'.fa_ent_xml($row['z03']).'</row:z03>');
    echo('<row:z04>'.fa_ent_xml($row['z04']).'</row:z04>');
    //echo('<row:z99>'.fa_ent_xml($sql_req).'</row:z99>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
  }
} else {
    echo('<RDF:li>'.EOL);
    echo('<RDF:Description>');
    echo('<row:z00>0</row:z00>');
    echo('<row:z01>0</row:z01>');
    echo('<row:z01_tri>0</row:z01_tri>');
    echo('<row:z02>pas de données</row:z02>');
    echo('<row:z03>pas de données</row:z03>');
    echo('<row:z04>pas de données</row:z04>');
    //echo('<row:z99>'.fa_ent_xml($sql_req).'</row:z99>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
