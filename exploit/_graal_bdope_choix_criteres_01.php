<?php 
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_choix_criteres_acteurs";
$t_origines_ok[1]="_graal_fen_choix_criteres_actions";
$t_origines_ok[2]="_graal_fen_choix_criteres_articles";
$t_origines_ok[3]="_graal_fen_choix_criteres_ged";
$t_origines_ok[4]="_graal_fen_choix_criteres_interlocuteurs";
$t_origines_ok[5]="_graal_fen_critere_01";
$t_origines_ok[6]="_graal_fen_critere_02";
$t_origines_ok[7]="_graal_fen_critere_03";
$t_origines_ok[8]="_graal_fen_critere_04";
$t_origines_ok[9]="_graal_fen_requeteur_acteurs_01";
$t_origines_ok[10]="_import_apisoft_fen_assocations_devises";
$t_origines_ok[11]="_import_apisoft_fen_assocations_orimou";
$t_origines_ok[12]="_import_apisoft_fen_assocations_pays";
fa_acces_script();
$vl_e_mini=intval(fa_recup_session('borne_mini','0'));
$vl_e_maxi=intval(fa_recup_session('borne_maxi','0'));
$vl_c_action=fa_recup_param('vl_c_action','??????');
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_choix_valeur_texte_01=fa_recup_param('vl_c_choix_valeur_texte_01','');
$vl_c_choix_valeur_texte_02=fa_recup_param('vl_c_choix_valeur_texte_02','');
$vl_c_choix_actif=fa_recup_param('vl_c_choix_actif','');
$vl_c_portee=fa_recup_param('vl_c_portee','0');
$vl_c_code=fa_recup_param('vl_c_code','');
$vl_c_choix_couleur=fa_recup_param('vl_c_choix_couleur','');
$vf_c_echo='';
switch (TRUE) {
  case $vl_c_action=='??????':
    exit;
    break;    
  case $vl_c_action=='supprimer': 
    $sql_req = "DELETE FROM _choix WHERE _choix.choix_cleunik = $vl_e_choix_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vl_c_action=="supprimer_en_masse":
    $vl_c_var=fa_recup_param('var','vs_tempo_panier_choix');
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$var"]);
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      if ($vl_t_listecles[$vl_e_i]>0) {$vl_choix_cleunik.=$vl_t_listecles[$vl_e_i].',';}
    }
    if ($vl_choix_cleunik!="") {
      $vl_choix_cleunik=substr($vl_choix_cleunik, 0, -1);
      $sql_req = "DELETE FROM _choix WHERE _choix.choix_cleunik in($vl_choix_cleunik);";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if ($vf_c_echo=='ok') {$vf_c_echo="Tous les choix inutilisés ont été supprimés.";}
    } else {$vf_c_echo='Aucune suppression ...';}
    break;
  case $vl_c_action=='ajouter':
    $vl_e_choix_cleunik=_graal_requete_max("choix_cleunik","_choix");
    $sql_req = "INSERT INTO _choix set choix_cleunik=$vl_e_choix_cleunik,critere_cleunik=$vl_e_critere_cleunik,choix_valeur_texte_01='$vl_c_choix_valeur_texte_01',choix_actif=$vl_c_choix_actif,choix_portee=$vl_c_portee";
    if ($vl_e_critere_cleunik!=98) {
      $sql_req.= ",choix_valeur_texte_02='$vl_c_choix_valeur_texte_02'";
    } else {
      $result = _graal_requete_bd("select max(choix_valeur_texte_02*1)*2 as nombremax from _choix where critere_cleunik=98");
      $row = mysql_fetch_assoc($result);
      $sql_req.= ",choix_valeur_texte_02='".fa_ent_xml($row['nombremax'])."'";
      _graal_libere_requete_bd($result);
    }
    if ($vl_c_code!='') {$sql_req.=",choix_code='$vl_c_code'";}
    $vf_c_echo=_graal_exec_requete($sql_req);
    switch ($vl_e_critere_cleunik) {
      case 128: 
        $sql_req="insert into _uni_par_con select $vl_e_choix_cleunik,a2.choix_cleunik,0,1 from _choix a2 where a2.critere_cleunik=108";_graal_exec_requete($sql_req);//  Un nouveau conditionnement : on ajoute toutes les unités de stock
        $sql_req="insert into _univente_par_con select $vl_e_choix_cleunik,a2.choix_cleunik,0,1 from _choix a2 where a2.critere_cleunik=109";_graal_exec_requete($sql_req);//  Un nouveau conditionnement : on ajoute toutes les unités de ventes
        break; 
      case 108: $sql_req="insert into _uni_par_con select a2.choix_cleunik,$vl_e_choix_cleunik,0,1 from _choix a2 where a2.critere_cleunik=128";_graal_exec_requete($sql_req);//  Une nouvelle unité de stock : on ajoute tous les conditionnements
        break; 
      case 109: $sql_req="insert into _univente_par_con select a2.choix_cleunik,$vl_e_choix_cleunik,0,1 from _choix a2 where a2.critere_cleunik=128";_graal_exec_requete($sql_req);//  Une nouvelle unité de vente : on ajoute tous les conditionnements
        break; 
    }
	switch ($vl_e_cleunik_critere){
	  case 94 : //Genres d'actions
	  case 123: //Priorités d'actions
	  	case 122: //Confidentialité des actions
	  case 124: //Statuts d'actions
	  case 129: //Statuts de lignes d'actions commerciales
		$sql_req="insert into _choix_couleur set choix_cleunik=$vl_e_choix_cleunik,uti_cleunik=0,choix_couleur='$vl_c_choix_couleur'";
		_graal_exec_requete($sql_req);
		include('_graal_affec_param_css_actions.php');
	  	break;
	}
    break;
  case $vl_c_action=='modifier':
    if ($vl_e_critere_cleunik!=98) {
      $sql_req = "update _choix set critere_cleunik=$vl_e_critere_cleunik,choix_valeur_texte_01='$vl_c_choix_valeur_texte_01',choix_valeur_texte_02='$vl_c_choix_valeur_texte_02',choix_actif=$vl_c_choix_actif,choix_portee=$vl_c_portee";
    } else {
      // cas particulier des genres d'adresses : choix_valeur_texte_02 est détourné
      $sql_req = "update _choix set critere_cleunik=$vl_e_critere_cleunik,choix_valeur_texte_01='$vl_c_choix_valeur_texte_01',choix_actif=$vl_c_choix_actif,choix_portee=$vl_c_portee";
    }
    if ($vl_c_code!='') {$sql_req.=",choix_code='$vl_c_code'";}
    $sql_req .= " WHERE _choix.choix_cleunik = $vl_e_choix_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    //echo $sql_req;
    //echo $vl_e_critere_cleunik;
    switch ($vl_e_critere_cleunik){
	  case 94 : //Genres d'actions
	  	case 122: //Confidentialité des actions
	  case 123: //Priorités d'actions
	  case 124: //Statuts d'actions
	  case 129: //Statuts de lignes d'actions commerciales
		$sql_req="replace into _choix_couleur set choix_cleunik=$vl_e_choix_cleunik,uti_cleunik=0,choix_couleur='$vl_c_choix_couleur'";
		_graal_exec_requete($sql_req);
		include('_graal_affec_param_css_actions.php');
		//echo $sql_req;
	  	break;
	}
    break;
    break;
} 
_graal_ferme_connexion();
echo $vf_c_echo;       
?>
