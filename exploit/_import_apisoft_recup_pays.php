<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(60);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','fournisseur');
$vl_e_traitement=fa_recup_param('vl_e_traitement','0');
switch ($vl_e_traitement){  
  case 1: //  Récupération des pays clients (Adresses de factures et adresses de livraison) 
    $sql_req = "SELECT distinct(FacPays) as pays FROM $vl_c_base_origine.$vl_c_fic_tiers where FacPays not in (select c_pays from _w_transferts_apisoft_corres_pays) union SELECT distinct(LivPays) as pays FROM $vl_c_base_origine.$vl_c_fic_tiers where LivPays not in (select c_pays from _w_transferts_apisoft_corres_pays)";
    break;
  case 2: //  Récupération des pays des fournisseurs
    $sql_req = "SELECT distinct(Pays) as pays FROM $vl_c_base_origine.$vl_c_fic_tiers where FacPays not in (select c_pays from _w_transferts_apisoft_corres_pays)";
    break;
  case 3: //  Récupération des pays des fournisseurs
    $sql_req = "SELECT distinct(Pays) as pays FROM $vl_c_base_origine.$vl_c_fic_tiers where Pays not in (select c_pays from _w_transferts_apisoft_corres_pays) union SELECT distinct(Pays_Liv) as pays FROM $vl_c_base_origine.$vl_c_fic_tiers where Pays_Liv not in (select c_pays from _w_transferts_apisoft_corres_pays)";
    break;
}    
$result = _graal_requete_bd($sql_req);
$vf_c_echo='Rien de nouveau à importer. Vérifiez tout de même les associations.';
while ($row = mysql_fetch_assoc($result)){
  $sql_req_ins = "INSERT INTO $vl_c_base_destination._w_transferts_apisoft_corres_pays set";
  $sql_req_ins .=" c_pays='".addslashes($row['pays'])."'";
  $sql_req_ins .=",pays_appli=60000";//  On fait une correspondance avec critère cleunik 60 (pays norme ISO) choix_cleunik 60000 (France)
  $result_ins = _graal_requete_bd($sql_req_ins);
  if($result_ins === false){$vf_c_echo=mysql_error($cnx) . $sql_req_ins;} else $vf_c_echo='Importation terminée. Vérifiez les associations.';
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($vf_c_echo);
?>
