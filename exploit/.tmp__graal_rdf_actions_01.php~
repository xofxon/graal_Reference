<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_c_lesquelles=fa_recup_param('vl_c_lesquelles','toutes');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_quelleplage=fa_recup_param('vl_c_quelleplage','debut');
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','150'));
$vl_e_genre=intval(fa_recup_param('vl_e_genre','-1'));
$vl_e_statut=intval(fa_recup_param('vl_e_statut','-1'));
$vl_e_act_cleunik=intval(fa_recup_param('act_cleunik','-1'));
$vl_e_int_cleunik=intval(fa_recup_param('int_cleunik','-1'));
$vl_e_operat=intval(fa_recup_param('vl_operat','1'));
$vl_e_operat_genre=intval(fa_recup_param('vl_operat_genre','1'));
$vl_e_zone=intval(fa_recup_param('vl_zone','1'));
$vl_e_type_recherche=intval(fa_recup_param('vl_type_recherche','1'));
/* Beaucoup trop long dans une base avec de nombreuses actions ou un gros fichier _graal  
$sql_req = "SELECT action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,f4.choix_valeur_texte_01 as statut,f5.qui_interlo as `qui_interlo`,_actions.sujet as `sujet`,_actions.reference as `reference` FROM _actions left join _vue_graal_principaux f5 using(action_cleunik),_choix f2,_choix f3,_choix f4 where f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut and (_actions.description like '$vl_c_recherche%' or _actions.description is null)";
*/
switch ($vl_e_zone) {
  case 1: //description
    switch ($vl_e_type_recherche) {
      case 1: //  Orthographe
        if ($vl_c_recherche=='%') {
          $sql_req ="SELECT action_cleunik FROM _actions where 1=1";
        } else {
          $sql_req ="SELECT action_cleunik FROM _actions where (_actions.description like '$vl_c_recherche%')";
        }      
        break;
      case 2: //  Poids des mots
        $sql_req ="SELECT f5.action_cleunik,MATCH(f5.description) AGAINST ('$vl_c_recherche') as score FROM _actions,_actions_texte f5 where _actions.action_cleunik=f5.action_cleunik and MATCH(f5.description) AGAINST ('$vl_c_recherche')";
        break;
    }
    break;
  case 2: //sujet
    switch ($vl_e_type_recherche) {
      case 1: //  Orthographe
      case 2: //  Poids des mots
        if ($vl_c_recherche=='%') {
          $sql_req ="SELECT action_cleunik FROM _actions where 1=1";
        } else {
          $sql_req ="SELECT action_cleunik FROM _actions where (_actions.sujet like '$vl_c_recherche%')";
        }      
        break;
    }
    break;
}
switch ($vl_c_lesquelles) {
  case 'toutes': //toutes
  case 'toutes_principales':  //  Toutes avec mention de l'acteur ou de l'interlocuteur principal
  case 'acteurs': //acteurs
  case 'interlo': //acteurs
    $sql_req.= " AND ((dateheuredebut between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (dateheurefin between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'))";
    if ($vl_e_genre!=-1) {
      //if ($vl_e_genre==-110112) {$vl_e_genre='-110112,-110116,-110117';} //  Factures clients,avoirs "classiques" et avoirs "financiers"
      if ($vl_e_genre==-110116) {$vl_e_genre='-110116,-110117';} //  avoirs "classiques" et avoirs "financiers"
      if ($vl_e_genre==-110117) {$vl_e_genre='-110116,-110117';} //  avoirs "classiques" et avoirs "financiers"
      switch ($vl_e_operat_genre) {
        case 1 : $sql_req.=" AND _actions.choix_cleunik in($vl_e_genre)";break;
        case 2 : $sql_req.=" AND _actions.choix_cleunik not in($vl_e_genre)";break;
      }
    }
    if ($vl_e_statut!=-1) {
      switch ($vl_e_operat) {
        case 1 : $operat="=";break;
        case 2 : $operat="<>";break;
      }
      $sql_req.=" AND _actions.statut$operat$vl_e_statut";
    }
    break; 
  case 'favorites':$sql_req.= " AND _actions.action_cleunik IN (SELECT _actions_favorites.action_cleunik from _actions_favorites where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;  //  Favoris
  //case 'avecpj':$sql_req.= " AND _actions.action_cleunik IN (SELECT _courriel_pj_action.action_cleunik from _courriel_pj_action where doc_cleunik=$vl_e_genre)";break;  //  Avec des pièces jointes
  case 'avecpj':$sql_req="SELECT action_cleunik FROM _actions left join _courriel_pj_action using (action_cleunik) where _courriel_pj_action.doc_cleunik=$vl_e_genre";break;//  Avec des pièces jointes
  case 'avecar':$sql_req.= " AND _actions.action_cleunik IN (SELECT _courriel_re.action_cleunik from _courriel_re where etat_ar=1)";break;  //  Avec des pièces jointes
  case 'selection'://  Sélection de clé uniques d'actions
    $vl_c_var=fa_recup_param('var','vs_tempo_panier_action');
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$vl_c_var"]);
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $vl_action_cleunik.=$vl_t_listecles[$vl_e_i].',';
    }
    if ($vl_action_cleunik!="") {$vl_action_cleunik=substr($vl_action_cleunik, 0, -1);}
    $sql_req.= " AND _actions.action_cleunik IN ($vl_action_cleunik)";
    break;  
}
switch ($vl_c_lesquelles) {
  case 'acteurs': //acteurs
    $sql_req.= " AND _actions.action_cleunik IN (SELECT _graal.action_cleunik from _graal where act_cleunik=$vl_e_act_cleunik)";break;  //  Acteurs
    break; 
  case 'interlo': //interlocuteurs acteurs
    $sql_req.= " AND _actions.action_cleunik IN (SELECT _graal.action_cleunik from _graal where int_cleunik=$vl_e_int_cleunik)";break;  //  Acteurs
    break; 
}

switch ($vl_c_quelleplage) { 
  case "debut":$sql_req.=" order by _actions.dateheuredebut DESC,_actions.dateheurefin DESC";break;
  case "fin":$sql_req.=" order by _actions.dateheurefin DESC";break;
} 

switch ($vl_c_lesquelles) {
  case 'favorites': //  Favoris, pas de limit
  case 'avecpj':  //  Avec pièces jointes, no limit
  case 'selection'://  Sélection de clé uniques d'actions, no limit
    break;
  default:
    if ($vl_e_limit!=0) {$sql_req.= " LIMIT 0,$vl_e_limit";}
    
    break;
}
//echo $sql_req;
$result = _graal_requete_bd($sql_req);
$sql_req_init=$sql_req;
$vl_c_in="";
while ($row = mysql_fetch_assoc($result)){
  $vl_c_in.=$row['action_cleunik'].",";
}
_graal_libere_requete_bd($result);
echo(fa_xcree_entete_rdf());
if (strlen($vl_c_in)!=0) {
  $vl_c_in=substr($vl_c_in,0,-1);
  $qui_dat=array();$qui_cle=array();
  $sql_req="select action_cleunik,qui_interlo as `qui_interlo` from _vue_graal_principaux where action_cleunik in($vl_c_in);";
  $result = _graal_requete_bd($sql_req);
  while ($row = mysql_fetch_assoc($result)) {
    array_push ($qui_dat, fa_ent_xml($row['qui_interlo']));
    array_push ($qui_cle, $row['action_cleunik']);
  }
  _graal_libere_requete_bd($result);
  switch ($vl_e_zone) {
    case 1: //description
      switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
          $sql_req_finale ="SELECT _actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,f4.choix_valeur_texte_01 as statut,_actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,(select count(*) from _courriel_pj_action where _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4 where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          break;
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT _actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,_actions.description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,f4.choix_valeur_texte_01 as statut,_actions.sujet as `sujet`,_actions.reference as `reference`,MATCH(f5.description) AGAINST ('$vl_c_recherche') as `score`,(select count(*) from _courriel_pj_action where _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4,_actions_texte f5 where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut and _actions.action_cleunik=f5.action_cleunik";
          break;
      }
      break;
    case 2: //sujet
      switch ($vl_e_type_recherche) {
        case 1: //  Orthographe
        case 2: //  Poids des mots
          $sql_req_finale ="SELECT _actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,_actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,f4.choix_valeur_texte_01 as statut,_actions.sujet as `sujet`,_actions.reference as `reference`,''as `score`,(select count(*) from _courriel_pj_action where _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nb_pj FROM _actions, _choix f2,_choix f3,_choix f4 where _actions.action_cleunik in ($vl_c_in) and f2.choix_cleunik=_actions.choix_cleunik and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut";
          break;
      }
      break;
  }
  switch ($vl_c_quelleplage) { 
    case "debut":$sql_req_finale.=" order by score DESC,_actions.dateheuredebut DESC,_actions.dateheurefin DESC";break;
    case "fin":$sql_req_finale.=" order by score DESC,_actions.dateheurefin DESC";break;
  } 
  $result = _graal_requete_bd($sql_req_finale);
  
/* 
    echo('<RDF:li>'.EOL);
    echo('<RDF:Description>');
    echo('<row:zone>'.$vl_e_zone.'</row:zone>');
    echo('<row:recherche>'.$vl_e_type_recherche.'</row:recherche>');
    echo('<row:vl_e_genre>'.$vl_e_genre.'</row:vl_e_genre>');
    echo('<row:vl_e_statut>'.$vl_e_statut.'</row:vl_e_statut>');
    
    echo('<row:requete_initiale>'.fa_ent_xml($sql_req_init).'</row:requete_initiale>');
    echo('<row:requete_finale>'.fa_ent_xml($sql_req_finale).'</row:requete_finale>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
*/
  while ($row = mysql_fetch_assoc($result)) {
    echo('<RDF:li>'.EOL);
    echo('<RDF:Description>');
    // parseType = indication pour le type des données, utile pour le tri sur la colonne
    echo('<row:action_cleunik NC:parseType="Integer">'.fa_ent_xml($row['action_cleunik']).'</row:action_cleunik>');
    echo('<row:description>'.fa_ent_xml($row['description']).'</row:description>');
    echo('<row:choix_cleunik>'.fa_ent_xml($row['choix_cleunik']).'</row:choix_cleunik>');
    echo('<row:dateheuredebut>'.fa_ent_xml($row['dateheuredebut']).'</row:dateheuredebut>');
    echo('<row:dateheurefin>'.fa_ent_xml($row['dateheurefin']).'</row:dateheurefin>');
    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
    $hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
    echo('<row:datedebut>'.$dd.'</row:datedebut>');
    echo('<row:datefin>'.$df.'</row:datefin>');
    echo('<row:heuredebut>'.$hd.'</row:heuredebut>');
    echo('<row:heurefin>'.$hf.'</row:heurefin>');
    echo('<row:genre>'.fa_ent_xml($row['genre']).'</row:genre>');
    echo('<row:priorite>'.fa_ent_xml($row['priorite']).'</row:priorite>');
    echo('<row:statut>'.fa_ent_xml($row['statut']).'</row:statut>');
    echo('<row:sujet>'.fa_ent_xml($row['sujet']).'</row:sujet>');
    echo('<row:reference>'.fa_ent_xml($row['reference']).'</row:reference>');
    echo('<row:poidsdesmots>'.fa_ent_xml($row['score']).'</row:poidsdesmots>');
    $vl_e_trouve=array_search($row['action_cleunik'], $qui_cle);if ($vl_e_trouve===false) {$vl_c_qui="";} else {$vl_c_qui=$qui_dat[$vl_e_trouve];}
    echo('<row:qui>'.$vl_c_qui.'</row:qui>');
    if($row['nb_pj']!=0) {$vl_c_prop_pj="al14";} else {$vl_c_prop_pj="";}
    echo('<row:prop_pj>'.$vl_c_prop_pj.'</row:prop_pj>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
  }
_graal_libere_requete_bd($result);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_ferme_connexion();
?>
