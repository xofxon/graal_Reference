<?php
// Auteur : Communauté PEAR
// Mise en exemple par Alexandre TRANCHANT
//La variable $mail est-elle une adresse e-mail syntaxiquement valide ?
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
require("_graal_fonctions_mail.php");
header('Content-type: text/html; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past

$vl_t_listecles=fa_recup_param('vl_t_listecles','');   //  clefs
$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
$vl_t_listemail=fa_recup_param('vl_t_listemail','');   //  adresses à vérifier
$vl_t_listemail=unserialize(stripslashes($vl_t_listemail));
$vl_type_sortie=fa_recup_param('vl_type_sortie',"");
$vl_t_nom_dest=fa_recup_session("$vl_c_var",'');
$vl_modif=fa_recup_param('vl_modif','oui');
switch ($vl_type_sortie) {
	case "texte":define('EOL', "\r\n");break;
	case "":define('EOL', "<br>");break;
}
$vl_e_i=-1;
foreach($vl_t_listemail as $vl_raf) {
  $vl_e_i++;
  $mail=base64_decode($vl_t_listemail[$vl_e_i]);
  $intweb_cleunik=$vl_t_listecles[$vl_e_i];
  echo "1° vérification : syntaxe de l'adresse".EOL;
/*
  if(!ff_verifie($mail)){
    echo 'Attention, syntaxiquement, "'. $mail.'" n\'est pas une adresse e-mail valide'.EOL;
  }
  echo 'Vérification 1 ok'.EOL;
*/
  /*
  $retour=check_mail($mail);
  if ($retour[0]==true) {
    echo 'Vérification 2 syntaxe ok'.EOL;
  } else {
    echo 'Vérification 2 syntaxe pas ok'.EOL;
  }  
  if ($retour[1]==true) {
    echo 'Vérification 2 MX ok'.EOL;
  } else {
    echo 'Vérification 2 MX pas ok'.EOL;
  }  
  */
/*
  if ($retour[2]==true) {
    echo 'Vérification 2 A ok'.EOL;
  } else {
    echo 'Vérification 2 A pas ok'.EOL;
  }  
  if ($retour[3]==true) {
    echo 'Vérification 3 NAME ok'.EOL;
  } else {
    echo 'Vérification 3 NAME pas ok'.EOL;
  }
*/
  $retour=verif_email($mail,true);
	if ($vl_modif=="oui") {
	  $sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification='".addslashes($retour[1])."' where intweb_cleunik=$intweb_cleunik;";
  	$result_01=_graal_requete_bd($sql_req_01);
	}
  //echo $retour[0].EOL;
  echo $retour[1].EOL;  
}
function top_chrono() { 
  $chrono= microtime(); 
  $chrono= explode(" ",$chrono); 
  $chrono= $chrono[1] + $chrono[0]; 
  return ($chrono); 
}
?>

