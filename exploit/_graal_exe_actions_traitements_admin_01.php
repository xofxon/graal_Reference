<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
header('Content-type: text/html; charset=utf-8');
include_once("_graal_fonctions_documents_ciaux.php");
include_once("_graal_fonctions_echeances.php");
set_time_limit(6000);
define('EOL', "\r\n");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_actions_admin_01";
fa_acces_script();
$vl_c_type=fa_recup_param('type','');
$nombre=0;
echo <<<EOT
<script language="JavaScript">
function pf_descendre_bas_de_page(){
	var vl_c_hauteur=document.body.offsetHeight;
        window.scrollTo(0,vl_c_hauteur);
        setTimeout("pf_descendre_bas_de_page()",15000);  
    }
    setTimeout("pf_descendre_bas_de_page()",15000);  
</script>
EOT;
session_write_close();
$affiche=true;
switch ($vl_c_type) {
  case '1': //  MAJ des montants des factures clients
	echo ("Le traitement peut être assez long ... patience ...");flush();
	fa_maj_prepa_compta("faccli","montants",-4,-4,"",2000);
    $vf_c_echo="Fin de la mise à jour.".EOL;
    break;
  case '2': //  MAJ des montants des commandes clients
	echo ("Le traitement peut être assez long ... patience ...");flush();
	fa_maj_prepa_compta("cdecli","montants",-4,-4,"",2000);
    $vf_c_echo="Fin de la mise à jour.".EOL;
    break;
  case '3': //  MAJ des montants des avoirs clients
	echo ("Le traitement peut être assez long ... patience ...");flush();
	fa_maj_prepa_compta("avocli","montants",-4,-4,"",2000);
    $vf_c_echo="Fin de la mise à jour.".EOL;
    break;
  case '4': //  MAJ des montants des factures fournisseur
	echo ("Le traitement peut être assez long ... patience ...");flush();
	fa_maj_prepa_compta("facfou","montants",-4,-4,"",2000);
    $vf_c_echo="Fin de la mise à jour.".EOL;
    break;
  case '5': //  MAJ des montants des commandes fournisseurs
	echo ("Le traitement peut être assez long ... patience ...");flush();
	fa_maj_prepa_compta("cdefou","montants",-4,-4,"",2000);
    $vf_c_echo="Fin de la mise à jour.".EOL;
    break;
  case '6': //  MAJ des montants des avoirs fournisseurs
	echo ("Le traitement peut être assez long ... patience ...");flush();
	fa_maj_prepa_compta("avofou","montants",-4,-4,"",2000);
    $vf_c_echo="Fin de la mise à jour.".EOL;
    break;
/*
  case '2': //  MAJ niveau 3 ancienne NAF à partir niveau 4 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=24 and a2.cleunikcriterefils=24 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '3': //  MAJ niveau 2 ancienne NAF à partir niveau 3 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=23 and a2.cleunikcriterefils=23 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '4': //  MAJ niveau 1 ancienne NAF à partir niveau 2 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=22 and a2.cleunikcriterefils=22 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '5': //  MAJ de la commune INSEE en fonction de la ville récupérée sur adresse
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.choix_cleunik,a2.critere_cleunik,a3.typeacteur,0 from _act_adresses a1 left join _choix a2 on a1.adr_ville=a2.choix_valeur_texte_02 left join _acteurs a3 on a1.act_cleunik=a3.act_cleunik where a2.critere_cleunik=65 and a1.choix_cleunik=60000;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '6': //  MAJ du département INSEE en fonction du code postal récupéré sur adresse
	echo ("Le traitement peut être assez long ... patience ...");
	$nombre=0;
	$sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.choix_cleunik,a2.critere_cleunik,a3.typeacteur,0 from _act_adresses a1,_choix a2,_acteurs a3 where a2.critere_cleunik=62 and a1.choix_cleunik=60000 and substring(a1.adr_cp,1,2)<>'97' and SUBSTRING(a2.choix_code,4,3)= concat('0',substring(a1.adr_cp,1,2)) and a1.act_cleunik=a3.act_cleunik;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
	$sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.choix_cleunik,a2.critere_cleunik,a3.typeacteur,0 from _act_adresses a1,_choix a2,_acteurs a3 where a2.critere_cleunik=62 and a1.choix_cleunik=60000 and substring(a1.adr_cp,1,2)='97' and SUBSTRING(a2.choix_code,4,3)= substring(a1.adr_cp,1,3) and a1.act_cleunik=a3.act_cleunik;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '7':// MAJ Région INSEE en fonction du critère département
	echo ("Le traitement peut être assez long ... patience ...");
	$nombre=0;
	$sql_maj="insert ignore into _act_choix_fixes select f1.act_cleunik,f3.choix_cleunik,61,f1.typeacteur,0 from _act_choix_fixes f1 join _choix f2 on f1.choix_cleunik=f2.choix_cleunik join _choix f3 on f3.choix_code=substring(f2.choix_code,1,2) where f1.critere_cleunik=62 and f3.critere_cleunik=61;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;    
*/
  
}
echo $vf_c_echo;
?>
