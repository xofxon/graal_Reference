<?php
include("_graal_header_xml.inc.php");
$nb_dec=2;
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','-1'));
$sql_condition=" where 1=1 ";
if ($vl_e_act_cleunik==-1){
	
} else {
	$sql_req = "SELECT pc_cleunik as pc_cleunik FROM _act_compta where act_cleunik=$vl_e_act_cleunik";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$pc_cleunik=$row['pc_cleunik'];
	_graal_libere_requete_bd($result);
	$sql_condition.=" AND a1.pc_cleunik=$pc_cleunik";
	$vl_c_genreacteur="tousss";
}
$sql_req="SELECT a1.reglement_cleunik,a1.journal_cleunik,a1.pc_cleunik,a1.mode_paiement,a1.piece,";
$sql_req.="a1.ref_piece,a1.dateheurecreation,a1.dateheuremodif,a1.dateheurereglemen,"._graalsql_date('a1.dateheurereglemen')." as `date_reglement_clair`,";
$sql_req.="(a1.montant_paye*a1.coef) as montant_paye,(a1.montant_pointe*a1.coef) as montant_pointe,a1.devise_paye,a1.coef,a1.acompte,a1.transfert,";
$sql_req.="a1.impaye,a1.remboursement,a1.option_remise,a1.accepte,a1.banque,a1.domiciliation,a1.etablissement,a1.guichet,a1.compte,a1.cle,a1.type_ecart,a1.blocnotebrut,";
$sql_req.="a2.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req.="a3.choix_valeur_texte_01 as devise_paye_clair";
$sql_req.=" FROM _treso_reglement_cli a1 ";
$sql_req.=" left join _choix a2 on a2.choix_cleunik=a1.mode_paiement";
$sql_req.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req.=" $sql_condition";
//echo $sql_req;
$result = _graal_requete_bd($sql_req);
echo("<donnees>");
while ($row = mysql_fetch_assoc($result)){
  echo("<quoi ");
	$montant_pointe=fa_reel(fa_ent_xml($row['montant_pointe']),$nb_dec);
	$montant_paye=fa_reel(fa_ent_xml($row['montant_paye']),$nb_dec);
	$val_montant_pointe=$row['montant_pointe']*1000;
	$val_montant_paye=$row['montant_paye']*1000;
	if ($montant_pointe==0){$montant_pointe="";}
	if ($montant_paye==0){$montant_paye="";}
    echo(' reglement_cleunik="'.fa_ent_xml($row[reglement_cleunik]).'"');
    echo(' journal_cleunik="'.fa_ent_xml($row[journal_cleunik]).'"');
    echo(' pc_cleunik="'.fa_ent_xml($row[pc_cleunik]).'"');
    echo(' mode_paiement_clair="'.fa_ent_xml($row[mode_paiement_clair]).'"');
    echo(' piece="'.fa_ent_xml($row[piece]).'"');
    echo(' ref_piece="'.fa_ent_xml($row[ref_piece]).'"');
    echo(' dateheurecreation="'.fa_ent_xml($row[dateheurecreation]).'"');
    echo(' dateheuremodif="'.fa_ent_xml($row[dateheuremodif]).'"');
    echo(' dateheurereglemen="'.fa_ent_xml($row[dateheurereglemen]).'"');
		echo(' date_reglement_clair="'.fa_ent_xml($row[date_reglement_clair]).'"');
		
    echo(' montant_paye="'.$montant_paye.'"');
    echo(' montant_pointe="'.$montant_pointe.'"');
		printf(' val_montant_paye ="%011u"',$val_montant_paye);
		printf(' val_montant_pointe ="%011u"',$val_montant_pointe);
    echo(' devise_paye_clair="'.fa_ent_xml($row[devise_paye_clair]).'"');
    echo(' coef="'.fa_ent_xml($row[coef]).'"');
    echo(' acompte="'.fa_ent_xml($row[acompte]).'"');
    echo(' transfert="'.fa_ent_xml($row[transfert]).'"');
    echo(' impaye="'.fa_ent_xml($row[impaye]).'"');
    echo(' remboursement="'.fa_ent_xml($row[remboursement]).'"');
    echo(' option_remise="'.fa_ent_xml($row[option_remise]).'"');
    echo(' accepte="'.fa_ent_xml($row[accepte]).'"');
    echo(' banque="'.fa_ent_xml($row[banque]).'"');
    echo(' domiciliation="'.fa_ent_xml($row[domiciliation]).'"');
    echo(' etablissement="'.fa_ent_xml($row[etablissement]).'"');
    echo(' guichet="'.fa_ent_xml($row[guichet]).'"');
    echo(' compte="'.fa_ent_xml($row[compte]).'"');
    echo(' cle="'.fa_ent_xml($row[cle]).'"');
    echo(' type_ecart="'.fa_ent_xml($row[type_ecart]).'"');
    echo(' blocnotebrut="'.fa_ent_xml($row[blocnotebrut]).'"');
		$genre="";
		if ($row[coef]==-1){$genre="Avoir ";}
		echo(' genre="'.$genre.'"');
		
  echo("/>");
}
echo("</donnees>");
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
