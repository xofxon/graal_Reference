<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','ines_epac.articles');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_frla');
session_write_close();
$sql_req = "SELECT distinct(ART_UNIT) as ART_UNIT FROM $vl_c_base_origine where ART_UNIT not in (select choix_valeur_texte_01 from $vl_c_base_destination._choix where critere_cleunik=109)";
//echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=109";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  //$sql_req_01 .=",choix_code='".addslashes($row['Nom'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row["ART_UNIT"])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=null";
  $i++;
  echo $sql_req_01.EOL;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) {$vf_c_echo.=mysql_error($cnx) . $sql_req_01.EOL;} else {$vf_c_echo.='ok';}
}

_graal_libere_requete_bd($result);
$sql_req = "SELECT distinct(concat(ART_TYPE,'')) as ART_TYPE FROM $vl_c_base_origine where concat(ART_TYPE,'') not in (select choix_valeur_texte_01 from $vl_c_base_destination._choix where critere_cleunik=10040)";
//echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=10040";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  //$sql_req_01 .=",choix_code='".addslashes($row['Nom'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row["ART_TYPE"])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=null";
  $i++;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) {$vf_c_echo.=mysql_error($cnx) . $sql_req_01.EOL;} else {$vf_c_echo.='ok';}
}
_graal_libere_requete_bd($result);

//die("Fin prématurée");
$type_cod=array();$type_cle=array();$type_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as choix_valeur_texte_01 from _choix where critere_cleunik=10040"; //  On recherche les types d'articls
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($type_cod, $row['code']);
  array_push ($type_cle, $row['cleunik']);
  array_push ($type_tex, $row['choix_valeur_texte_01']);
}
_graal_libere_requete_bd($result);
$univente_cod=array();$univente_cle=array();$univente_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as choix_valeur_texte_01 from _choix where critere_cleunik=109"; //  On recherche les unités de ventes
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($univente_cod, $row['code']);
  array_push ($univente_cle, $row['cleunik']);
  array_push ($univente_tex, $row['choix_valeur_texte_01']);
}
_graal_libere_requete_bd($result);

$sql_req = "SELECT Numéro,ART_NB,ART_REF,ART_TYPE,ART_PDS,ART_LAIZE,ART_STOCK,ART_DES,ART_PLAN,ART_REM,ART_MINI,ART_MAXI,ART_QTE_ECO,ART_FOUR,";
$sql_req.=" ART_FOUR_BIS,ART_CHECK,ART_UNIT,ART_DATE_INV,ART_DATE_IN,ART_DATE_OUT,ART_ZONE,ART_BARCODE,ART_VAL_CODE,ART_CURRENCY,ART_TVA,ART_TARIF1,ART_TARIF2,";
$sql_req.=" ART_PHOTO,ART_COMMISSION,ART_REM_LANGUE,ART_TARIF1_CURRENCY,ART_TARIF2_CURRENCY,ART_PUBLIC,ART_ETAT,ART_QUAL,ART_PDS_UNIT,ART_LAIZE_UNIT,ART_COEF,";
$sql_req.=" ART_UNIT_GESTION,ART_STOCK_AVANT_INV,ART_ZONE_STOCK,ART_DELAI_RECEPTION,ART_DELAI_EXPEDITION,ART_PA,ART_DATE,ART_DATE_MOD,ART_NB_PARENT,ART_GESTION_LOT,ART_URL"; 
$sql_req.=" FROM ines_epac.articles";
$o_article=new _graal_import();
$o_choix=new _graal_import();
$o_vente=new _graal_import();
$o_dimen=new _graal_import();
$o_article->req="INSERT INTO $vl_c_base_destination._article (art_cleunik,code,mnemotechnique,description,blocnotebrut,dateheurecreation,dateheuremodif,types_gestion,actif,nbdec_prix,pr_generique) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._art_choix_fixes (art_cleunik,choix_cleunik,critere_cleunik,uti_cleunik) VALUES ";
$o_vente->req="INSERT INTO $vl_c_base_destination._art_ventes (art_cleunik,unite_vente) VALUES ";
$o_dimen->req="INSERT INTO $vl_c_base_destination._art_dimensions (art_cleunik,capacite,unite_capacite,poids_brut,poids_net,unite_poids,tare,longueur,largeur,epaisseur,unite_longueur) VALUES ";

$vf_e_art_cleunik=_graal_requete_max("art_cleunik","$vl_c_base_destination._article");
$i=0;$i1=500;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
//  Ajout dans la table des articles
  $vf_e_art_cleunik++;
  $i++;
  $code=fa_nt($row['ART_REF']);
  $mnemotechnique=sprintf("%d",$row['ART_NB']);
  $description=fa_nt($row['ART_DES']);
  $blocnotebrut=fa_nt($row['ART_REM']);
  $dateheurecreation=$row['ART_DATE'];
  $dateheuremodif=$row['ART_DATE_MOD'];
  $unite_longueur=-90;	//	Millimètres
  $types_gestion=2; //  Achats + Ventes
  $nbdec_prix=2;
  $unite_stock=-14;
  $unite_achat=-36;
  $unite_condi=-37;
  $actif=1;
  $vl_e_trouve=array_search($row['ART_UNIT'], $univente_tex);if ($vl_e_trouve===false) {$unite_vente=-35;} else {$unite_vente=$univente_cle[$vl_e_trouve];}
  
  
  $o_article->dat.="($vf_e_art_cleunik,$code,'$mnemotechnique',$description,$blocnotebrut,'$dateheurecreation','$dateheuremodif',$types_gestion,$actif,$nbdec_prix,0),";
  //$o_achat->dat.="($vf_e_art_cleunik,$der_pa,$pamp,'$dateheure_der_achat',$unite_achat),";
  $o_vente->dat.="($vf_e_art_cleunik,$unite_vente),";
  $o_dimen->dat.="($vf_e_art_cleunik,$capacite,-55,$poids_brut,$poids_net,$unite_poids,$tare,$longueur,$largeur,$epaisseur,$unite_longueur),";
  
  //exit($o_dimen->req.$o_dimen->dat);
  //  famille
  $type_art=sprintf("%d",$row['ART_TYPE']);
  //echo "cherche $type_art".EOL;
  $vl_e_trouve=array_search($type_art, $type_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$type_cle[$vl_e_trouve];}
  if ($vl_e_choix_cleunik!=0) {$o_choix->dat.="($vf_e_art_cleunik,$vl_e_choix_cleunik,10040,0),";}
  //  type
  if ($i % $i1==0){
    $o_article->execute();
    $o_vente->execute();
    $o_choix->execute();
    //$o_dimen->execute();
  }
}
//echo $o_article->req.$o_article->dat.EOL;
$o_article->execute();
$o_vente->execute();
$o_choix->execute();
//$o_dimen->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo("$i articles importés.");
?>
