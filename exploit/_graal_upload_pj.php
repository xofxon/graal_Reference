<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_graal_fonctions_documents.php");
$vl_c_nom_fichier=fa_recup_param('vl_c_nom_fichier','??');
set_time_limit(6000);
$name=$_FILES['filename']['name'];
$size=$_FILES['filename']['size'];
$tmp=$_FILES['filename']['tmp_name'];
$type=$_FILES['filename']['type'];  //  Pas fiable : regarde, a priori, l'extension !!
$type=addslashes(fa_mime_type_buffer(file_get_contents($tmp)));
$error=$_FILES['filename']['error'];
$hash=hash_file('sha1', $tmp);
$vl_c_data = addslashes($vl_c_data);
$vl_c_nom_fichier=addslashes($vl_c_nom_fichier);
$doc_cleunik=0;
$sql_req = "select doc_cleunik as cleunik FROM _documents WHERE hash = '$hash'";
if ($res = _graal_requete_bd($sql_req)) {
  $ligne = mysql_fetch_row($res);
  $doc_cleunik=$ligne[0];
  _graal_libere_requete_bd($res);
}
if ($doc_cleunik==0) {
	$doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
	$typedoc="13";
	$size=filesize($tmp);
	$vf_c_retour=fa_insere_document($doc_cleunik,$vl_c_nom_fichier,$typedoc,$size,$tmp,"","","","","","","");
}
unlink($tmp);
echo $doc_cleunik;
?>
