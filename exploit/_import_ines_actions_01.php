<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','ines_epac');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_epac');

session_write_close(); 


$vl_e_critere_cleunik=94;
$vl_e_val_defaut=-110100;

include("_import_ines_sp_array_tiers.php");
include("_import_ines_sp_array_tiers_contacts.php");

$vf_e_typeacteur=110006;
$sql_req = "SELECT distinct(visite_type) as visite_type FROM $vl_c_base_origine.historiques where visite_type not in (select choix_valeur_texte_01 from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=$vl_e_critere_cleunik";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  //$sql_req_01 .=",choix_code='".addslashes($row['Nom'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row["visite_type"])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=1024";
  $i++;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) {$vf_c_echo.=mysql_error($cnx) . $sql_req_01.EOL;} else {$vf_c_echo.='ok';}
}
echo $vf_c_echo.EOL;
_graal_libere_requete_bd($result);

/*
 * Tableau des types d'actions chez EPAC
 */
$t01_cod=array();$t01_cle=array();$t01_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=$vl_e_critere_cleunik";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t01_cod, $row['code']);
  array_push ($t01_cle, $row['cleunik']);
  array_push ($t01_tex, $row['text']);
}
_graal_libere_requete_bd($result);



$sql_req ="SELECT Numéro,CL_REF,VISITE_REF,VISITE_CONTACT,VISITE_DATE_SAISIE,VISITE_DATE,VISITE_DATE_FIN,";
$sql_req.=" VISITE_TYPE,VISITE_PROG_POUR,VISITE_OBJET,VISITE_REM,VISITE_AUTEUR,VISITE_OPPORT,VISITE_ASSISTANT,VISITE_MAIL_DEST,";
$sql_req.=" VISITE_MAIL_CC,VISITE_MAIL_CCI FROM $vl_c_base_origine.historiques order by Numéro";

//$sql_req.=" limit 5;";
$result = _graal_requete_bd($sql_req);
//echo $sql_req.EOL;
$o_actions=new _graal_import();
$o_graal=new _graal_import();
$o_actions->req="INSERT INTO $vl_c_base_destination._actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurefin,dateheurecreation,description,c_uuid,sujet) VALUES ";
$o_graal->req="INSERT INTO $vl_c_base_destination._graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ";
$sql_req_02="";
$sql_req_03="";
$i=0;$b=500;
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_action_cleunik=$row['VISITE_REF'];
  $vf_e_act_cleunik=-1;
  $vf_e_int_cleunik=-1;
  if ($row['VISITE_CONTACT']!=0){
	$code_interlo=sprintf("%d",$row['VISITE_CONTACT']);
	$vl_e_trouve_interlo=array_search($code_interlo, $int_cod);
	//die ("Trouvé ".$row['Code']);
	if ($vl_e_trouve_interlo===false) {
		//echo $code_interlo." interlocuteur pas trouvé".EOL;flush();
	} else {
		$vf_e_act_cleunik=$act_cle[$vl_e_trouve_interlo];
		$vf_e_int_cleunik=$int_cle[$vl_e_trouve_interlo];
		//echo $code_interlo." interlocuteur trouvé".EOL;flush();
	}
  } else {
  	$code_acteur=sprintf("%d",$row['CL_REF']);
	$vl_e_trouve_acteur=array_search($code_acteur, $acteur_cod);
  	if ($vl_e_trouve_acteur===false) {
		//echo $code_acteur." acteur pas trouvé".EOL;flush();
	} else {
		$vf_e_act_cleunik=$act_cle[$vl_e_trouve_acteur];
		$vf_e_int_cleunik=0;
		//echo $code_acteur." acteur trouvé".EOL;flush();
	}
  }
  	//echo "cherche ".$row["VISITE_TYPE"].EOL;flush();
  	$vl_e_trouve_choix=array_search($row["VISITE_TYPE"], $t01_tex);if ($vl_e_trouve_choix===false) {$choix_cleunik=$vl_e_val_defaut;} else {$choix_cleunik=$t01_cle[$vl_e_trouve_choix];}
  	$dateheuredebut=fa_nt($row['VISITE_DATE']);
  	if (fa_nn_blanc($row['VISITE_DATE_FIN'])=="") {
  		$dateheurefin=fa_nt($row['VISITE_DATE']);
  	} else {
  		$dateheurefin=fa_nt($row['VISITE_DATE_FIN']);
  	}
  	$dateheurecreation=fa_nt($row['VISITE_DATE_SAISIE']);
  	switch ($row["VISITE_TYPE"]){
  		case "Mail envoyé":
  			$description=fa_nt("");
  			break;
  		default:
  			$description=fa_nt($row['VISITE_OBJET'].EOL.$row['VISITE_REM']);
  			break;
  	}
  	$c_uuid=_graal_requete_uuid();
  	//$c_uuid=md5(uniqid(rand(), true));
  	$sujet=fa_nt($row['VISITE_OBJET']);
  	
  	$o_actions->dat.="($vf_e_action_cleunik,$choix_cleunik,$dateheuredebut,$dateheurefin,$dateheurecreation,$description,'$c_uuid',$sujet),";
  	//echo $o_actions->dat.EOL;flush();
  	$i++;
  if ($vf_e_act_cleunik!=-1){
  	$o_graal->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,$vf_e_action_cleunik,-110402,8192,2),";
  	
  }
	
  if ($i % $b==0){
	    $o_actions->execute();
	    $o_graal->execute();
	  }
	  
}
//echo $o_actions->req.$o_actions->dat.EOL;
//echo $o_graal->req.$o_graal->dat.EOL;
$o_actions->execute();
$o_graal->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($vf_c_echo);
?>
