<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$genreaction=fa_recup_param("genreaction","??");
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik",-1));
include("_graal_req_docial_recap_montants.inc.php");
$result = _graal_requete_bd($sql_req_ht_marchandise);
echo(fa_xcree_entete_rdf());
/*
echo('<RDF:li><RDF:Description>');
echo('<row:genre_ligne>'.fa_ent_xml($sql_req_ht_marchandise).'</row:genre_ligne>');
echo('</RDF:Description>'.EOL);
echo('</RDF:li>'.EOL);
*/
$base_ht=0;
$total_base_brute=0;
$total_remise=0;
$total_ht=0;
$total_taxe=0;
$total_ttc=0;
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
    echo('<RDF:li><RDF:Description>');
    echo('<row:genre_ligne>'.fa_ent_xml($row['genre_ligne']).'</row:genre_ligne>');
    echo('<row:denomination_taxe>'.fa_ent_xml($row['denomination_taxe']).'</row:denomination_taxe>');
    echo('<row:taux_taxe>'.fa_ent_xml($row['taux_taxe']).'</row:taux_taxe>');
    echo('<row:base_brute>'.fa_ent_xml($row['htbrutremise']).'</row:base_brute>');
    echo('<row:remise>'.fa_ent_xml($row['montantremise_pied']).'</row:remise>');
    echo('<row:base_taxe>'.fa_ent_xml($row['montant_avec_remise_pied']).'</row:base_taxe>');
    echo('<row:montant_taxe>'.fa_ent_xml($row['montant_taxe']).'</row:montant_taxe>');
    echo('<row:ttc>'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'</row:ttc>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
    $total_base_brute=$row['htbrutremise'];
    $total_remise=$row['montantremise_pied'];
    $base_ht+=$row['montant_avec_remise_pied'];
    $total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
  }
} 
_graal_libere_requete_bd($result);
//  Port
$sql_req_port=str_replace("*base_ht*",$base_ht,$sql_req_port);
$result = _graal_requete_bd($sql_req_port);
/*
echo('<RDF:li><RDF:Description>');
echo('<row:genre_ligne>'.fa_ent_xml($sql_req_port).'</row:genre_ligne>');
echo('</RDF:Description>'.EOL);
echo('</RDF:li>'.EOL);
*/
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
    echo('<RDF:li><RDF:Description>');
    echo('<row:genre_ligne>'.fa_ent_xml($row['genre_ligne']).'</row:genre_ligne>');
    echo('<row:denomination_taxe>'.fa_ent_xml($row['denomination_taxe']).'</row:denomination_taxe>');
    echo('<row:taux_taxe>'.fa_ent_xml($row['taux_taxe']).'</row:taux_taxe>');
    echo('<row:base_brute>'.fa_ent_xml($row['htbrutremise']).'</row:base_brute>');
    echo('<row:remise>'.fa_ent_xml($row['montantremise_pied']).'</row:remise>');
    echo('<row:base_taxe>'.fa_ent_xml($row['montant_avec_remise_pied']).'</row:base_taxe>');
    echo('<row:montant_taxe>'.fa_ent_xml($row['montant_taxe']).'</row:montant_taxe>');
    echo('<row:ttc>'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'</row:ttc>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
    $total_base_brute=$row['htbrutremise'];
    $total_remise=$row['montantremise_pied'];
    $total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
  }
} 
_graal_libere_requete_bd($result);
//  Frais
$sql_req_frais=str_replace("*base_ht*",$base_ht,$sql_req_frais);
/*
echo('<RDF:li><RDF:Description>');
echo('<row:genre_ligne>'.fa_ent_xml($sql_req_frais).'</row:genre_ligne>');
echo('</RDF:Description>'.EOL);
echo('</RDF:li>'.EOL);
*/
$result = _graal_requete_bd($sql_req_frais);
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
    echo('<RDF:li><RDF:Description>');
    echo('<row:genre_ligne>'.fa_ent_xml($row['genre_ligne']).'</row:genre_ligne>');
    echo('<row:denomination_taxe>'.fa_ent_xml($row['denomination_taxe']).'</row:denomination_taxe>');
    echo('<row:taux_taxe>'.fa_ent_xml($row['taux_taxe']).'</row:taux_taxe>');
    echo('<row:base_taxe>'.fa_ent_xml($row['montant_avec_remise_pied']).'</row:base_taxe>');
    echo('<row:montant_taxe>'.fa_ent_xml($row['montant_taxe']).'</row:montant_taxe>');
    echo('<row:ttc>'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'</row:ttc>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
    $total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
  }
} 
_graal_libere_requete_bd($result);
echo('<RDF:li><RDF:Description>');
echo('<row:genre_ligne>'."Totaux".'</row:genre_ligne>');
echo('<row:base_brute>'.$total_base_brute.'</row:base_brute>');
echo('<row:remise>'.$total_remise.'</row:remise>');
echo('<row:base_taxe>'.$total_ht.'</row:base_taxe>');
echo('<row:montant_taxe>'.$total_taxe.'</row:montant_taxe>');
echo('<row:ttc>'.$total_ttc.'</row:ttc>');
echo('</RDF:Description>'.EOL);
echo('</RDF:li>'.EOL);
//  Acompte
$result = _graal_requete_bd($sql_req_acompte);
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
    $netapayer=$total_ttc-$row['montant_avec_remise_pied'];
    echo('<RDF:li><RDF:Description>');
    echo('<row:genre_ligne>'.fa_ent_xml($row['genre_ligne']).'</row:genre_ligne>');
    echo('<row:ttc>'.$row['montant_avec_remise_pied'].'</row:ttc>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
    echo('<RDF:li><RDF:Description>');
    echo('<row:genre_ligne>'."Net Ã  payer".'</row:genre_ligne>');
    echo('<row:ttc>'.$netapayer.'</row:ttc>');
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
  }
} 
_graal_libere_requete_bd($result);
// fin du fichier RDF
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_ferme_connexion();
?>
