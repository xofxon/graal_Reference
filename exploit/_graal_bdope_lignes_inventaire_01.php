<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_lignes_inventaire_01";
fa_acces_script();
define('EOL', "\r\n");
$vf_c_echo="";
$vl_e_mini=intval(fa_recup_session("borne_mini","000000000000"));
$vl_e_maxi=intval(fa_recup_session("borne_maxi","999999999999"));
$vl_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_int_cleunik =intval(fa_recup_session('vs_int_cleunik','0'));
$vl_tableau_cle=fa_recup_param("vl_tableau_cle","");
$vl_tableau_qte=fa_recup_param("vl_tableau_qte","");
$vl_tabqte = unserialize(stripslashes($vl_tableau_qte));
$vl_tabcle = unserialize(stripslashes($vl_tableau_cle));

$vl_inv_cleunik=intval(fa_recup_param("vl_inv_cleunik",""));
$vl_choix_depot=-15;  //  Dépot par défaut
$vl_choix_empla=-16;  //  Emplacement par défaut
$vl_unite_mvt=fa_recup_param("vl_unite_mvt","");
$vl_genre_mvt=-41; 
$vl_type_mvt=3;// 3 -> Inventaire, 1 -> Entrée, 2 -> Sortie

$sql_req="SELECT dateheureinventaire as `dateheureinventaire` FROM _inventaire where inv_cleunik=$vl_e_inv_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_date_mvt=$row['dateheureinventaire'];
_graal_libere_requete_bd($result);

$vl_b_transaction_ok=true;
$vl_e_i=-1;
foreach($vl_tabcle as $vl_art_inventaire) {
  $vl_e_i++;
  $vl_art_cleunik=$vl_tabcle[$vl_e_i];
  $vl_qte_mvt=fa_floatval($vl_tabqte[$vl_e_i]);

  //  Recherche infos article
  $sql_req = "SELECT qte_stock,unite_stock,nb_decimales_qte,dateheure_dermvt FROM _art_stock where art_cleunik=$vl_art_cleunik";
  $result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($result) == 0) {
    $vl_gestion=2;$vl_unite_stock=-14;$vl_nb_decimales_qte=2;
    $sql_req="INSERT INTO _art_stock set art_cleunik=$vl_art_cleunik,gestion=$vl_gestion,unite_stock=$vl_unite_stock,nb_decimales_qte=$vl_nb_decimales_qte ;";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
    $vl_qte_pre=0;
    $vl_unite_mvt=$vl_unite_stock;
    $vl_dateheure_dermvt_old="";
  }  
  else {
    $row=mysql_fetch_assoc($result);
    $vl_qte_pre=fa_ent_xml($row['qte_stock']);
    $vl_unite_mvt=fa_ent_xml($row['unite_stock']);
    $vl_nb_decimales_qte=fa_ent_xml($row['nb_decimales_qte']);
    $vl_dateheure_dermvt_old=fa_ent_xml($row['dateheure_dermvt']);
    _graal_libere_requete_bd($result);
  }
  
  $sql_req = "SELECT n1.actif as actif,n1.art_cleunik,n3.pr as pr,n3.nbdec_pr as nbdec_pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven,n5.tarif_reference FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.art_cleunik=$vl_art_cleunik";
  $result = _graal_requete_bd($sql_req);
  $row=mysql_fetch_assoc($result);
  if ($row['derpa']==0) {
    $derpa=""; } else 
  {
    $derpa=fa_reel(fa_ent_xml($row['derpa']),4);
  }
  $val_derpa=$row['derpa']*1000;
  if ($row['pamp']==0) {
    $pamp=""; } else 
  {
    $pamp=fa_reel(fa_ent_xml($row['pamp']),4);
  }
  $val_pamp=$row['pamp']*1000;
  if ($row['pr']==0) {
    $pr=""; } else 
  {
    $pr=fa_reel(fa_ent_xml($row['pr']),4);
  }
  $val_pr=$row['pr']*1000;
  switch (fa_ent_xml($row['tarif_reference'])) {
    case "-4":  //  Rien
      $vl_pu_mvt=0;
      break;
    case "-1":  //  Dernier prix d'achat
      $vl_pu_mvt=$derpa;
      break;
    case "-3":  //  PAMP
      $vl_pu_mvt=$pamp;
      break;
    case "-2":  //  Prix de revient
      $vl_pu_mvt=$pr;
      break;
  }
  $vl_qte_pos=$vl_qte_mvt;break;//  Inventaire
  $vl_e_coeff=1;
  //  Insertion mouvement de stock
  $vl_mvt_cleunik=_graal_requete_max_particuliere("mvt_cleunik","_mouvements_stock");
  $sql_req = "INSERT INTO _mouvements_stock set mvt_cleunik=$vl_mvt_cleunik,art_cleunik=$vl_art_cleunik,uti_cleunik=$vl_uti_cleunik,int_cleunik=$vl_int_cleunik,dateheuremvt='$vl_date_mvt',dateheuresaisie=now(),choix_depot=$vl_choix_depot,choix_empla=$vl_choix_empla,qte_mvt=$vl_qte_mvt,qte_pos=$vl_qte_pos,unite_mvt=$vl_unite_mvt,genre_mvt=$vl_genre_mvt,type_mvt=$vl_type_mvt,pu_mvt=$vl_pu_mvt,blocnotebrut='$vl_blocnotebrut';";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
  
  
  //  Recherche de toutes les écritures, postérieures à celle qui vient d'être saisie
  $sql_req="select type_mvt,mvt_cleunik,qte_pos from _mouvements_stock where art_cleunik=$vl_art_cleunik and dateheuremvt > '$vl_date_mvt' and choix_depot=$vl_choix_depot and choix_empla=$vl_choix_empla order by dateheuremvt asc";
  $result = _graal_requete_bd($sql_req);
  while ($row = mysql_fetch_assoc($result)) {
    switch ($row['type_mvt']) {
      case 1://  Entrée
      case 2://  Sortie
        $sql_req_01="UPDATE _mouvements_stock set qte_pos=qte_pos+($vl_qte_mvt*$vl_e_coeff) where mvt_cleunik=".$row['mvt_cleunik'];
        $vf_c_echo=_graal_exec_requete($sql_req_01);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur ajout ".$sql_req_01.EOL;}
        break;
      case 3:$vl_b_maj_stock_sur_article=false;break 2;//  Inventaire -> on arrête le parcours (2 indique le nombre de structures imbriquées que l'on quitte
    }
  }
  _graal_libere_requete_bd($result);
  //  Recherche dernier mouvement de stock
  $sql_req="select qte_pos from _mouvements_stock where art_cleunik=$vl_art_cleunik and choix_depot=$vl_choix_depot and choix_empla=$vl_choix_empla order by dateheuremvt desc limit 1";
  // select * from _mouvements_stock where art_cleunik=10000821 and dateheuremvt <= '2003-12-31 13:00:17' order by dateheuremvt desc limit 1
  //  Récupération du stock à cet instant pour qu'il serve de base au nouvel enregistrement
  $result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($result) == 0) {
    $vl_qte_pos=0;
  }  
  else {
    $row=mysql_fetch_assoc($result);
    $vl_qte_pos=fa_ent_xml($row['qte_pos']);
    _graal_libere_requete_bd($result);
  }
  //  Mise à jour information article
  $sql_req="UPDATE _art_stock set qte_inven=$vl_qte_mvt,dateheure_invent='$vl_date_mvt',qte_stock=$vl_qte_pos where art_cleunik=$vl_art_cleunik;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur ajout ".$sql_req.EOL;}
  //  Mise à jour information ligne d'inventaire
  $sql_req="UPDATE _inventaire_lignes set qte_inven=$vl_qte_mvt,etat=1,mvt_cleunik=$vl_mvt_cleunik where art_cleunik=$vl_art_cleunik and inv_cleunik=$vl_inv_cleunik;";
  $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
}
if ($vl_b_transaction_ok==false) {echo 'La transaction d\'inventaire a échoué.'.$vl_c_mess_err;} else {echo 'La transaction d\'inventaire a été correctement enregistrée.';}
?>
