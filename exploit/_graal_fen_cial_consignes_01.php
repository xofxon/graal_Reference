<?php
include("_graal_header_xul.inc.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$vl_e_uti_cleunik =intval(fa_recup_session("vs_uti_cleunik","0"));
$commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik","0"));
$act_cleunik=intval(fa_recup_param("act_cleunik","0"));
$action_consi_cleunik=intval(fa_recup_param("action_consi_cleunik","0"));
$vl_c_genreaction=fa_recup_param('genreaction','generique');
switch ($vl_c_genreaction) {
  case "offcli";$vl_c_fic_consig="_offcli_consignes";$vl_c_fic_entete="_offcli_entetes";$vl_c_id_fenetre="Fen_00687";break;
  case "cdecli";$vl_c_fic_consig="_cdecli_consignes";$vl_c_fic_entete="_cdecli_entetes";$vl_c_id_fenetre="Fen_00688";break;
  case "livcli";$vl_c_fic_consig="_livcli_consignes";$vl_c_fic_entete="_livcli_entetes";$vl_c_id_fenetre="Fen_00689";break;
  case "faccli";$vl_c_fic_consig="_faccli_consignes";$vl_c_fic_entete="_faccli_entetes";$vl_c_id_fenetre="Fen_00690";break;
  case "avocli";$vl_c_fic_consig="_avocli_consignes";$vl_c_fic_entete="_avocli_entetes";$vl_c_id_fenetre="Fen_00690";break;
  case "avofin";$vl_c_fic_consig="_avocli_consignes";$vl_c_fic_entete="_avocli_entetes";$vl_c_id_fenetre="Fen_00690";break;
  case "demfou";$vl_c_fic_consig="_demfou_consignes";$vl_c_fic_entete="_demfou_entetes";$vl_c_id_fenetre="Fen_00691";break;
  case "cdefou";$vl_c_fic_consig="_cdefou_consignes";$vl_c_fic_entete="_cdefou_entetes";$vl_c_id_fenetre="Fen_00692";break;
  case "recfou";$vl_c_fic_consig="_recfou_consignes";$vl_c_fic_entete="_recfou_entetes";$vl_c_id_fenetre="Fen_00693";break;
  case "facfou";$vl_c_fic_consig="_facfou_consignes";$vl_c_fic_entete="_facfou_entetes";$vl_c_id_fenetre="Fen_00694";break;
  default:fa_redirige("acces_interdit");break;
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_b_acces=$vl_tb_droits[0];if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bph_100=fa_recup_dico("bph_100");
$vl_c_bph_101=fa_recup_dico("bph_101");
$vl_c_bph_102=fa_recup_dico("bph_102");
$vl_c_bph_103=fa_recup_dico("bph_103");
$vl_c_bph_104=fa_recup_dico("bph_104");
$vl_c_bph_105=fa_recup_dico("bph_105");
$vl_c_bph_106=fa_recup_dico("bph_106");
$vl_c_bph_107=fa_recup_dico("bph_107");

$vl_c_bph_108=fa_recup_dico("bph_108");
$vl_c_bph_109=fa_recup_dico("bph_109");
$vl_c_bph_110=fa_recup_dico("bph_110");
$vl_c_bph_111=fa_recup_dico("bph_111");
$vl_c_bph_112=fa_recup_dico("bph_112");


$vl_c_dico_00002=fa_recup_dico('dico_00002');
$vl_c_dico_00003=fa_recup_dico('dico_00003');
$vl_c_dico_00004=fa_recup_dico('dico_00004');
$vl_c_dico_00007=fa_recup_dico('dico_00007');
$vl_c_dico_00010=fa_recup_dico('dico_00010');
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_cons=_graal_requete_acteur($act_cleunik);
$sql_req="SELECT a1.code as code,a2.raisonsoc as raisonsoc from $vl_c_fic_entete a1 left join _acteurs a2 using(act_cleunik) where commercial_cleunik=$commercial_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_qui=fa_ent_xml($row['code']);
$vl_c_acteur=fa_ent_xml($row['raisonsoc']);
_graal_libere_requete_bd($result);
$vl_c_codart="";
$vl_c_desart="";
$vl_c_qte="";
$vl_c_qte_colis="-1";
if ($action_consi_cleunik==0) {
  $vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));
  $selection_article=fa_ent_xml($vl_c_xml->selection_article->attributes());
$vl_c_boutons=<<<EOT
  <hbox> 
    <button width="40" flex="1" id="bt_ajouter" label="$vl_c_dico_00002" crop="end" dir="normal" oncommand="pf_validation('enregistrer')" />
    <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
EOT;
$bloc_article=<<<EOT
  <hbox>
  <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex="1" id="selart_consigne_ml_zone" class="normal" oncommand="pf_param_choix_selart_consigne();" value="$selection_article">
    <menupopup>
      <menuitem label="$vl_c_bph_105" value="1"/>
      <menuitem label="$vl_c_bph_106" value="2"/>
      <menuitem label="$vl_c_bph_107" value="3"/>
    </menupopup>
  </menulist>

  <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
    minlength="1"
    maxrows="50"
    ref="urn:suggest:values"
    label="?label"
    properties="?prop"
    issuggest="?issuggest"
     
    
    _graal_cleunik=""
    id="selart_consigne"
  />
  <button id="bt_dest_a" class="ad02 pseudo_tbb" oncommand="pf_sel_article_pour_consigne();"/>
  </hbox>
EOT;

} else {
$sql_req="SELECT a1.code as `code`,a1.description as `description`,a2.qte,a2.qte_colis as qte_colis FROM $vl_c_fic_consig a2 left join _article a1 using (art_cleunik) where action_consi_cleunik=$action_consi_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
$vl_c_codart=fa_ent_xml($row['code']);
$vl_c_desart=fa_ent_xml($row['description']);
$vl_c_qte=$row['qte'];
$vl_c_qte_colis=$row['qte_colis'];
$vl_c_boutons=<<<EOT
  <hbox> 
    <button width="40" flex="1" id="bt_modifier" label="$vl_c_dico_00003" crop="end" dir="normal" oncommand="pf_validation('modifier')" />
    <button width="40" flex="1" id="bt_supprimer" label="$vl_c_dico_00004" crop="end" dir="normal" oncommand="pf_validation('supprimer')" />
    <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
  </hbox>
EOT;
$bloc_article="";
}
include("_graal_header_winxul.inc.php");
include("_graal_header_textfied.inc.php"); 
echo <<<END
<window context="graal_cp00" title="$vl_c_bph_100" id="_win_fen_cial_consignes" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_cial_consignes_01.js.php");
echo <<<END
  <groupbox >
  <label value="$vl_c_bph_101"/>
  <textbox id="tb_qui_action" value="$vl_c_qui ($vl_c_acteur)" disabled="true" />
  <label value="$vl_c_bph_102"/>
  <textbox id="tb_qui_droite" value="$vl_c_cons" _graal_act_cleunik="$act_cleunik" disabled="true" />
  $bloc_article
  <vbox>
      <hbox>
        <label control="la_taux" value="$vl_c_bph_103"/>
        
        <textbox disabled="true" flex="1" id="tb_art_code" _graal_cleunik="" value="$vl_c_codart"/>
        <textbox disabled="true" flex="4" id="tb_art_description" value="$vl_c_desart"/>
      </hbox>
  </vbox>
  <hbox>
    <label control="la_qte" value="$vl_c_bph_104"/>
    <textbox flex="1" id="tb_qte" type="number" hidespinbuttons="true" decimalplaces="2"   value="$vl_c_qte"/>
  </hbox>
  <hbox>
    <label control="la_qte_colis" value="$vl_c_bph_110"/>
    <textbox flex="1" id="tb_qte_colis" type="number" hidespinbuttons="true" decimalplaces="0"   value="$vl_c_qte_colis" min="-1"/>
  </hbox>

  $vl_c_boutons
  </groupbox>
</window>
END;
?>
