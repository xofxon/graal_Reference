<?php
header('Content-type: text/xml; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
require("_graal_fonctions_mail.php");
$result = _graal_requete_bd($sql_req);
$prop_obsolete="css_0001";
echo(fa_xcree_entete_rdf());
/*
switch ($vl_e_masse) {
  case 4:
    echo('<RDF:Description>');
    echo('<row:nc>'.fa_ent_xml($sql_req).'</row:nc>');
    echo('</RDF:Description>');
    break;
}
*/
while ($row = mysql_fetch_assoc($result)){
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  // parseType = indication pour le type des données, utile pour le tri sur la colonne
  echo('<row:act_cleunik NC:parseType="Integer">'.fa_ent_xml($row['act_cleunik']).'</row:act_cleunik>');
  echo('<row:int_cleunik NC:parseType="Integer">'.fa_ent_xml($row['int_cleunik']).'</row:int_cleunik>');
  echo('<row:intweb_cleunik NC:parseType="Integer">'.fa_ent_xml($row['intweb_cleunik']).'</row:intweb_cleunik>');
  if ($row['cr_verification']=="." ){
    echo('<row:cr_verification></row:cr_verification>');
  } else {
    echo('<row:cr_verification>'.fa_ent_xml($row['cr_verification']).'</row:cr_verification>');
  }
  echo('<row:tri_cr_verification>'.fa_ent_xml($row['cr_verification']).'</row:tri_cr_verification>');
  echo('<row:cr_verification>'.fa_ent_xml($row['cr_verification']).'</row:cr_verification>');
  echo('<row:val_dateheureverification>'.fa_ent_xml($row['dateheureverification']).'</row:val_dateheureverification>');
  if ($row['dateheureverification']==0) {
    echo('<row:dateheureverification></row:dateheureverification>');
  } else {
    echo('<row:dateheureverification>'.fa_ent_xml($row['dateheureverification']).'</row:dateheureverification>');
  }
  echo('<row:raisonsoc>'.fa_ent_xml($row['raisonsoc']).'</row:raisonsoc>');
  echo('<row:nc>'.fa_ent_xml($row['nc']).'</row:nc>');
  echo('<row:civilite>'.fa_ent_xml($row['civilite']).'</row:civilite>');
  echo('<row:qui>'.fa_ent_xml($row['qui']).'</row:qui>');
  echo('<row:prenom>'.fa_ent_xml($row['prenom']).'</row:prenom>');
  echo('<row:nom>'.fa_ent_xml($row['nom']).'</row:nom>');
  echo('<row:refweb>'.fa_ent_xml($row['refweb']).'</row:refweb>');
  echo('<row:genreweb>'.fa_ent_xml($row['genreweb']).'</row:genreweb>');
  echo('<row:portee>'.fa_ent_xml($row['portee']).'</row:portee>');
  echo('<row:typeacteur>'.fa_ent_xml($row['typeacteur']).'</row:typeacteur>');
  switch ($row['mail_veuxpasdemail']) {
    case 1 : echo('<row:veuxpasdemail>'."ak16".'</row:veuxpasdemail>');break;
    case 2 : echo('<row:veuxpasdemail>'."ak17".'</row:veuxpasdemail>');break;
    case 3 : echo('<row:veuxpasdemail>'."ak18".'</row:veuxpasdemail>');break;
    default : echo('<row:veuxpasdemail>'.$row['mail_veuxpasdemail'].'</row:veuxpasdemail>');break;
  } 
  switch ($row['mail_valide']) {
    case 1 : echo('<row:valide>'."af16".'</row:valide>');echo('<row:prop_mail></row:prop_mail>');break;
    case 2 : echo('<row:valide>'."ae15".'</row:valide>');echo('<row:prop_mail>'.$prop_obsolete.'</row:prop_mail>');break;
    case 3 : echo('<row:valide>'."af15".'</row:valide>');echo('<row:prop_mail></row:prop_mail>');break;
  } 
  if ($row['act_actif'] ==1) {
    echo('<row:prop_act></row:prop_act>');
  } else {
    echo('<row:prop_act>'.$prop_obsolete.'</row:prop_act>');
  }
  if ($row['int_actif'] ==1) {
    echo('<row:prop_int></row:prop_int>');
  } else {
    echo('<row:prop_int>'.$prop_obsolete.'</row:prop_int>');
  }
  switch ($vl_e_masse) {
    case 0:break; //  Raf
    case 3: //  Contrôle syntaxe courriel
      $vl_c_mailacontroler=$row['refweb'];
      if(!ff_verifie($vl_c_mailacontroler)){ $vl_c_syntaxe_courriel="Attention, syntaxiquement, $vl_c_mailacontroler n'est pas une adresse e-mail valide.";
      } else {
        $vl_c_syntaxe_courriel="Syntaxiquement, $vl_c_mailacontroler est une adresse e-mail valide.";
        //$vl_c_syntaxe_courriel="Ok";
      }
      echo('<row:controle_01>'.fa_ent_xml($vl_c_syntaxe_courriel).'</row:controle_01>');
      break;
    case 4: //  Contrôle existence, utilisabilité

      $vl_c_mailacontroler=$row['refweb'];
      $retour=verif_email($vl_c_mailacontroler,false);
      $sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification='".addslashes($retour[1])."' where intweb_cleunik=".$row['intweb_cleunik'].";";
      $result_01=_graal_requete_bd($sql_req_01);
      $vl_c_syntaxe_courriel=$retour[1];
      echo('<row:controle_01>'.fa_ent_xml($vl_c_syntaxe_courriel).'</row:controle_01>');
      if ($retour[0]==false) {
        
        //echo('<row:controle_01>'.fa_ent_xml($vl_c_syntaxe_courriel).'</row:controle_01>');
        echo('<row:prop_controle_01>ad14</row:prop_controle_01>');
      } else {
        //echo('<row:controle_01></row:controle_01>');
        echo('<row:prop_controle_01>ad13</row:prop_controle_01>');
      }

      /*
      $retour=check_mail($mail);
      if ($retour[1]==true) {
        //echo 'Vérification 2 MX ok'.EOL;
        $retour=verif_email($mail,false);
        $vl_c_syntaxe_courriel=$retour[1];

      } else {
        $vl_c_syntaxe_courriel="Attention, vérification MX pas ok";
      }
      */  
      
      break;

    default:
      break;
  }
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
