<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
$vl_c_quelsdocs=fa_recup_param('quelsdocs','?');
$vl_c_nom_fichier=fa_recup_param('vl_c_nom_fichier','??');
set_time_limit(6000);
$name=$_FILES['filename']['name'];
$size=$_FILES['filename']['size'];
$tmp=$_FILES['filename']['tmp_name'];
$type=$_FILES['filename']['type'];  //  Pas fiable : regarde, a priori, l'extension !!
$error=$_FILES['filename']['error'];
switch ($vl_c_quelsdocs){
  case "appli"   : 
  	$vf_e_ficones_cleunik=_graal_requete_min("ficones_cleunik","_ficones");
  	break;
  case "client"  : 
  	$vf_e_ficones_cleunik=_graal_requete_max("ficones_cleunik","_ficones");
  	break;
  default :
  	fa_redirige("acces_bizar");
  	break;
}
$vl_c_nom_fichier=addslashes($vl_c_nom_fichier);
	$hash=hash_file('sha1', $tmp);
		$sql_req = "INSERT INTO _ficones set ficones_cleunik=$vf_e_ficones_cleunik,ficones_cheminorigine='$vl_c_nom_fichier',ficones_image='".addslashes(file_get_contents($tmp))."',ficones_hash='$hash';";
		//echo $sql_req;
		$retour=_graal_exec_requete($sql_req);
	  if ($retour=='ok') {
	  $vf_c_retour= $vf_e_ficones_cleunik."|ok|";
	} else {
	  $vf_c_retour= "0|$retour|";
	}	
echo $vf_c_retour;
_graal_ferme_connexion();
function _graal_requete_min($_vl_c_nomcolonne,$vl_c_nomtable) {
  $sql_cle = "select min($_vl_c_nomcolonne) as mincleunik from $vl_c_nomtable where $_vl_c_nomcolonne < 0";
  if ($res = _graal_requete_bd($sql_cle)) {
    if($ligne = mysql_fetch_row($res)) {
        $vl_e_doc_cleunik=$ligne[0];
        if (is_null($vl_e_doc_cleunik)) {
          $vl_e_doc_cleunik=$vl_e_mini-1;
        }
        else
          $vl_e_doc_cleunik=$vl_e_doc_cleunik-1;
    }
    else
      $vl_e_doc_cleunik=$vl_e_mini-1;
   }
   return($vl_e_doc_cleunik);
}


?>
