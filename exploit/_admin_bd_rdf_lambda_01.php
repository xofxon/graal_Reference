<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$query=fa_recup_telquel('vl_c_requete','select now()');
if ($query=='') die('Error: SQL command must be provided');
$command = strtolower(substr($query,0,strpos($query,' ')));
if (strpos('select,show,describe',$command)===false) die('Error: Only SELECT/SHOW/DESCRIBE is allowed');
$connection = mysql_connect($sql_serveur,$sql_user,$sql_passwd) or die('Error: Could not connect to server - ' . mysql_error());
$result = mysql_query("SET CHARACTER SET 'utf8';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
$result = mysql_query("SET collation_connection = 'utf8_general_ci';",$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
//mysql_select_db($vl_c_sql_bdd,$connection) or die('Error: Could not select database - ' . $vl_c_sql_bdd);
$result = mysql_query($query,$connection) or die('Error: Query failed - ' . mysql_error().'<br>'.$query);
switch ($command) {
  case 'select' or 'show' or 'describe': 
    $nfields = mysql_num_fields($result);
    echo(fa_xcree_entete_rdf());
    while ($line = mysql_fetch_array($result, MYSQL_ASSOC)){
      echo('<RDF:li><RDF:Description>'.EOL);
      $j = 0;
      foreach ($line as $field){
        $fieldname = mysql_field_name($result, $j);
        $quote="/'/";
        $toto=preg_replace($quote,'_',$fieldname);
        $fieldname=fa_ent_xml_cabal($toto);
        echo('<row:'.fa_ent_xml_cabal($fieldname).'>');
        if(is_null($field)) {echo "null";} else {echo fa_ent_xml($field);}
        echo('</row:'.fa_ent_xml_cabal($fieldname).'>');
        $j++;
      }
      echo(EOL.'</RDF:Description></RDF:li>'.EOL);
    }
    mysql_free_result($result);
    break;

  default:
      echo "Error: SQL command not understood";
      mysql_free_result($result);
      break;
}

mysql_close($connection);
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);

?>
