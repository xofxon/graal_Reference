<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
include("_import_class_exceptions.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_actions_01";
$t_origines_ok[1]="_graal_fen_actions_03";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_t_actions=fa_recup_param("vl_t_actions","");
$vl_t_panier_choix_cleunik=fa_recup_param("vl_t_panier_choix_cleunik","");
$vl_t_panier_critere_cleunik=fa_recup_param("vl_t_panier_critere_cleunik","");
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_e_genreacteur=intval(fa_recup_param('genreacteur','0'));
$vl_c_param_01=intval(fa_recup_param('param_01','0'));
$vl_c_param_02=intval(fa_recup_param('param_02','0'));
$vl_t_actions=unserialize(stripslashes($vl_t_actions));
$vl_c_mess_aucun='Aucune action n\'a été effectuée dans la base de données.';
switch (TRUE){
  case $vf_c_action=="kilometres_confidentialite";
    $vl_b_transaction_ok=true;
    $sql_condition=pf_recup_clef();
    $vl_e_confidentialite=intval(fa_recup_param('nouvelle_confidentialite','-22'));
    if ($sql_condition!="") {
      $sql_req = "UPDATE _actions SET confidentialite=$vl_e_confidentialite WHERE action_cleunik in($sql_condition);";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur sql ".$vf_c_echo;}
      if ($vl_b_transaction_ok==false) {echo 'Le changement de confidentialité a échoué.'.$vl_c_mess_err;} else {echo 'Le changement de confidentialité a été correctement effectuée.';}
    } else {echo $vl_c_mess_aucun;}
    break;
	
case $vf_c_action=="kilometres_priorite";
    $vl_b_transaction_ok=true;
    $sql_condition=pf_recup_clef();
    $vl_e_priorite=intval(fa_recup_param('nouvelle_priorite','-22'));
    if ($sql_condition!="") {
      $sql_req = "UPDATE _actions SET priorite=$vl_e_priorite WHERE action_cleunik in($sql_condition);";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur sql ".$vf_c_echo;}
      if ($vl_b_transaction_ok==false) {echo 'Le changement de priorité a échoué.'.$vl_c_mess_err;} else {echo 'Le changement de priorité a été correctement effectuée.';}
    } else {echo $vl_c_mess_aucun;}
    break;
  case $vf_c_action=="kilometres_statut";
    $vl_b_transaction_ok=true;
    $sql_condition=pf_recup_clef();
    $vl_e_statut=intval(fa_recup_param('nouveau_statut','-23'));
    if ($sql_condition!="") {
      $sql_req = "UPDATE _actions SET statut=$vl_e_statut WHERE action_cleunik in($sql_condition);";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur sql ".$vf_c_echo;}
      if ($vl_b_transaction_ok==false) {echo 'Le changement de statut a échoué.'.$vl_c_mess_err;} else {echo 'Le changement de statut a été correctement effectuée.';}
    } else {echo $vl_c_mess_aucun;}
    break;
  case $vf_c_action=="kilometres_supprimer";
    $vl_b_transaction_ok=true;
    $sql_condition=pf_recup_clef();
    if ($sql_condition!="") {
      $sql_req = "DELETE FROM _actions WHERE action_cleunik in($sql_condition);";    
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$vf_c_echo;}
      //  On en profite pour "purger" les corps de messages de courriels envoyés. Voir si ce n'est pas trop pénalisant car on le fait à chaque suppression au kilomètre, même si cela ne concerne pas les courriels envoyés...
      //	Beaucoup trop long !!!!!
			//$sql_req = "DELETE FROM _courriel_en_mes WHERE courriel_en_mes_cleunik not in(select distinct courriel_en_mes_cleunik from _courriel_en);";
			// Nouvelles requêtes au 11 janvier 2009
$sql_req = "DELETE f1 
FROM _courriel_en_mes f1
INNER JOIN _courriel_en f2
USING ( courriel_en_mes_cleunik )
WHERE f1.courriel_en_mes_cleunik IS NULL;";			
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
      $sql_req = "DELETE f1 
FROM _courriel_re_mes f1
INNER JOIN _courriel_re f2
USING ( courriel_re_mes_cleunik )
WHERE f1.courriel_re_mes_cleunik IS NULL;";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
      //	suppression des pièces jointes qui n'étaient rattachées qu'à une seule action
      $sql_req="delete f2 FROM _documents f2 left join _documents_rattachement f1 using(doc_cleunik) left join _actions f3 on f1.rat_cleunik=f3.action_cleunik where f1.portee=65536 and f3.action_cleunik is null and (select count(*) from _documents_rattachement f4 where f4.doc_cleunik=f1.doc_cleunik)<=1;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    	// Suppression des rattachements de pièces jointes orphelins d'actions   
    $sql_req="delete f1 FROM _documents_rattachement f1 left join _actions f3 on f1.rat_cleunik=f3.action_cleunik where f1.portee=65536 and f3.action_cleunik is null;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
      if ($vl_b_transaction_ok==false) {echo 'La suppression des actions a échoué.'.$vl_c_mess_err;} else {echo 'La suppression des actions a été correctement effectuée.';}
    } else {echo $vl_c_mess_aucun;}
    break;
  case $vf_c_action=="choix_ajo";
    $i1=500;
    $o_choix=new _graal_import();
    $o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      $o_choix->dat.="($vl_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik,$vl_e_genreacteur),";
      if ($i % $i1==0){$o_choix->execute();}
    }
    $o_choix->execute();
    echo ("$i choix ajoutés");
    break;
		
	case $vf_c_action=="kilometres_choix";
		$vl_t_panier_choix_cleunik=unserialize(stripslashes($vl_t_panier_choix_cleunik));
		$vl_t_panier_critere_cleunik=unserialize(stripslashes($vl_t_panier_critere_cleunik));
		switch ($vl_c_param_01){
    	case 1://	Choix entreprise
    		$uti_cleunik=0;
    		break;
			case 2://	Choix personnel (pas encore géré au 04-06-2009)
				break;
    }
    switch ($vl_c_param_02){
			case 1://	Supprimer
				$vl_e_i=-1;
		  	$sql_condition_action="";
			  foreach($vl_t_actions as $vl_raf) {
			    $vl_e_i++;
			    $vl_action_cleunik=$vl_t_actions[$vl_e_i];
			    if ($vl_e_i==0) {$sql_condition_action.= "$vl_action_cleunik";} else {$sql_condition_action.= ",$vl_action_cleunik";}
			  }
				$vl_e_i=-1;
		  	$sql_condition_choix_cleunik="";
			  foreach($vl_t_panier_choix_cleunik as $vl_raf) {
			    $vl_e_i++;
			    $vl_choix_cleunik=$vl_t_panier_choix_cleunik[$vl_e_i];
			    if ($vl_e_i==0) {$sql_condition_choix_cleunik.= "$vl_choix_cleunik";} else {$sql_condition_choix_cleunik.= ",$vl_choix_cleunik";}
			  }
				$vl_e_i=-1;
		  	$sql_condition_critere_cleunik="";
			  foreach($vl_t_panier_critere_cleunik as $vl_raf) {
			    $vl_e_i++;
			    $vl_critere_cleunik=$vl_t_panier_critere_cleunik[$vl_e_i];
			    if ($vl_e_i==0) {$sql_condition_critere_cleunik.= "$vl_critere_cleunik";} else {$sql_condition_critere_cleunik.= ",$vl_critere_cleunik";}
			  }
				$sql_req = "DELETE FROM _actions_choix_fixes WHERE action_cleunik in($sql_condition_action) and choix_cleunik in($sql_condition_choix_cleunik) and critere_cleunik in($sql_condition_critere_cleunik) and uti_cleunik=$uti_cleunik;";
				$vf_c_echo=_graal_exec_requete($sql_req);
				if($vf_c_echo!='ok') {
					$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;
					echo "Problème lors de la suppression des choix";
				} else {
					echo "Choix correctement supprimés.";
				}
				break;
    	case 2://	ajouter
				$i1=500;
		    $o_choix=new _graal_import();
		    $o_choix->req="INSERT INTO _actions_choix_fixes (action_cleunik,choix_cleunik,critere_cleunik,uti_cleunik) VALUES ";
		    $vl_b_transaction_ok=true;
				$vl_e_i=-1;
			  foreach($vl_t_actions as $vl_raf) {
			    $vl_e_i++;
			    $vl_action_cleunik=$vl_t_actions[$vl_e_i];
					$vl_e_j=-1;
				  foreach($vl_t_panier_choix_cleunik as $vl_raf01) {
				    $vl_e_j++;
				    $vl_choix_cleunik=$vl_t_panier_choix_cleunik[$vl_e_j];
						$vl_critere_cleunik=$vl_t_panier_critere_cleunik[$vl_e_j];
						$o_choix->dat.="($vl_action_cleunik,$vl_choix_cleunik,$vl_critere_cleunik,$uti_cleunik),";
				  }
					if ($vl_e_i % $i1==0){$o_choix->execute();}
			  }
				$o_choix->execute();
		    $vl_e_i++;
				echo ("Choix ajoutés sur $vl_e_i action(s).");
    		break;

    }
    break;		
		
		
		
  case $vf_c_action=="choix_sup";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "DELETE FROM _act_choix_fixes WHERE act_cleunik in($sql_condition) and choix_cleunik=$vl_e_choix_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des choix a échoué.'.$vl_c_mess_err;} else {echo 'La supression des choix a été correctement effectuée.';}
    break;
  case $vf_c_action=="critere_sup";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "DELETE FROM _act_choix_fixes WHERE act_cleunik in($sql_condition) and critere_cleunik=$vl_e_critere_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des critères a échoué.'.$vl_c_mess_err;} else {echo 'La supression des critères a été correctement effectuée.';}
    break;
 	case "kilometres_recus_en_erreur":
		$vl_b_transaction_ok=true;
    $sql_condition=pf_recup_clef();
    $vl_e_statut=intval(fa_recup_param('nouveau_statut','-23'));
    if ($sql_condition!="") {
      $sql_req = "UPDATE _actions SET choix_cleunik=-110104 WHERE action_cleunik in($sql_condition) and choix_cleunik=-110102;";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur sql ".$vf_c_echo;}
      if ($vl_b_transaction_ok==false) {echo 'Le changement de genre (reçus en erreur) a échoué.'.$vl_c_mess_err;} else {echo 'Le changement de genre a été correctement effectuée.';}
    } else {echo $vl_c_mess_aucun;}
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
function pf_recup_clef() {
  global $vl_t_actions;
  global $vl_c_mes_exception;
  $vl_e_i=-1;
  $sql_condition="";
  foreach($vl_t_actions as $vl_raf) {
    $vl_e_i++;
    $vl_action_cleunik=$vl_t_actions[$vl_e_i];
	if($vl_action_cleunik!=""){
    	if ($vl_e_i==0) {$sql_condition.= "$vl_action_cleunik";} else {$sql_condition.= ",$vl_action_cleunik";};
	}
  }
  return $sql_condition;
}
?>
