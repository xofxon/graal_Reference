<?php
include("_graal_header_xml.inc.php");
$nb_dec=2;
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','-1'));
$vl_c_genreacteur=fa_recup_param('genreacteur','tousss');
switch ($vl_c_genreacteur){
  case "110003": $fichier_01="_treso_reglement_cli";break;  //  clients
  case "110004": $fichier_01="_treso_reglement_fou";break;  //  fournisseurs
}
$prop_obsolete="css_0001";
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','aucun');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','aucun');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_recherche=fa_recup_param('vl_c_recherche','aucun');
$vl_e_typedate=fa_recup_param('vl_e_typedate','aucun');
$vl_e_type=intval(fa_recup_param('vl_e_type','aucun'));
$vl_e_etat=intval(fa_recup_param('vl_e_etat','aucun'));
$vl_e_journal_cleunik=intval(fa_recup_param('vl_e_journal','aucun'));
$sql_condition=" where 1=1 ";
if ($vl_e_act_cleunik==-1){
	/*
	 * au 20 mars 2009 pas géré
	 * 
	*/
	switch ($vl_e_etat){
		case 1:
		case 2:
		case 3:
		case 4:
		case 6:
		case 5:
		case 7:
			break;
	}
	if ($vl_e_journal_cleunik!=-2){
		$sql_condition.=" AND a1.journal_cleunik=$vl_e_journal_cleunik";	
	}
	switch ($vl_e_typedate){
		case '1'://	Date de réglement
			$sql_condition.=" AND a1.dateheurereglemen between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
		case '2':// Echéance au 20 mars 2009 pas géré
			$sql_condition.=" AND xx.date_echeance between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
		case '3':// Date de facture au 20 mars 2009 pas géré
			$sql_condition.=" AND xx.date_fact between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
		case '4':// Date de saisie du réglement
			$sql_condition.=" AND a1.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'";
			break;
	}
	switch ($vl_e_type){
		case '1'://	Recherche sur N° de document
			$sql_condition.=" AND a5.code like '$vl_c_recherche%'";
			break;
		case '2':	// = Montant dû
		  $vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_du=$vl_valeur";
			break;
		case '3':// = Montant à régler 
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND (a1.montant_du-a1.montant_paye)=$vl_valeur";
			break;
		case '4':// = Montant réglé, montant payé
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			if ($vl_valeur!=0) {$sql_condition.=" AND a1.montant_paye=$vl_valeur";}
			break;
		case '5':// Nom commercial ou raison social de l'acteur 
			$sql_condition.="AND (a6.nomcommercial like '$vl_c_recherche%' or a6.raisonsoc like '$vl_c_recherche%')";
			break;
		case '6':	// <= Montant dû
		  $vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_du<=$vl_valeur AND a1.montant_du<>0";
			break;
		case '7':// <= Montant à régler 
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND (a1.montant_du-a1.montant_paye)<=$vl_valeur AND (a1.montant_du-a1.montant_paye)<>0";
			break;
		case '8':// <= Montant réglé
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_paye<=$vl_valeur AND a1.montant_paye<>0";
			break;
		case '9':	// >= Montant dû
		  $vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_du>=$vl_valeur";
			break;
		case '10':// >= Montant à régler 
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND (a1.montant_du-a1.montant_paye)>=$vl_valeur";
			break;
		case '11':// >= Montant réglé
			$vl_valeur=fa_floatval(fa_recup_param("vl_c_recherche",0));
			$sql_condition.=" AND a1.montant_paye>=$vl_valeur";
			break;
		case '12':// Numéro de pièce
			$sql_condition.=" AND a1.piece like '$vl_c_recherche%'";
			break;								
		case '13':// Référence de la pièce
			$sql_condition.=" AND a1.ref_piece like '$vl_c_recherche%'";
			break;								

										
	}	
} else {
	$sql_req = "SELECT pc_cleunik as pc_cleunik FROM _act_compta where act_cleunik=$vl_e_act_cleunik";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$pc_cleunik=$row['pc_cleunik'];
	_graal_libere_requete_bd($result);
	$sql_condition.=" AND a1.pc_cleunik=$pc_cleunik";
}
$sql_req="SELECT a1.reglement_cleunik,a1.journal_cleunik,a1.pc_cleunik,a1.mode_paiement,a1.piece,";
$sql_req.="a1.ref_piece,a1.dateheurecreation,"._graalsql_date('a1.dateheurecreation')." as `date_creation_clair`,a1.dateheuremodif,a1.dateheurereglemen,"._graalsql_date('a1.dateheurereglemen')." as `date_reglement_clair`,";
$sql_req.="(a1.montant_paye*a1.coef) as montant_paye,(a1.montant_pointe*a1.coef) as montant_pointe,a1.devise_paye,a1.coef,a1.acompte,a1.transfert,";
$sql_req.="a1.impaye,a1.remboursement,a1.option_remise,a1.accepte,a1.banque,a1.domiciliation,a1.etablissement,a1.guichet,a1.compte,a1.cle,a1.type_ecart,a1.blocnotebrut,";
$sql_req.="a2.choix_valeur_texte_01 as mode_paiement_clair,";
$sql_req.="a3.choix_valeur_texte_01 as devise_paye_clair,";
$sql_req.="a4.nom as journal_clair";
$sql_req.=" FROM $fichier_01 a1 ";
$sql_req.=" left join _choix a2 on a2.choix_cleunik=a1.mode_paiement";
$sql_req.=" left join _choix a3 on a3.choix_cleunik=a1.devise_paye";
$sql_req.=" left join _treso_journal a4 using(journal_cleunik)";
$sql_req.=" $sql_condition";
//echo $sql_req;
$result = _graal_requete_bd($sql_req);
echo("<donnees>");
while ($row = mysql_fetch_assoc($result)){
  echo("<quoi ");
	$montant_pointe=fa_reel(fa_ent_xml($row['montant_pointe']),$nb_dec);
	$montant_paye=fa_reel(fa_ent_xml($row['montant_paye']),$nb_dec);
	$val_montant_pointe=$row['montant_pointe']*1000;
	$val_montant_paye=$row['montant_paye']*1000;
	if ($montant_pointe==0){$montant_pointe="";}
	if ($montant_paye==0){$montant_paye="";}
    echo(' reglement_cleunik="'.fa_ent_xml($row[reglement_cleunik]).'"');
    echo(' journal_cleunik="'.fa_ent_xml($row[journal_cleunik]).'"');
    echo(' pc_cleunik="'.fa_ent_xml($row[pc_cleunik]).'"');
    echo(' mode_paiement_clair="'.fa_ent_xml($row[mode_paiement_clair]).'"');
    echo(' piece="'.fa_ent_xml($row[piece]).'"');
    echo(' ref_piece="'.fa_ent_xml($row[ref_piece]).'"');
    echo(' dateheurecreation="'.fa_ent_xml($row[dateheurecreation]).'"');
    echo(' dateheuremodif="'.fa_ent_xml($row[dateheuremodif]).'"');
    echo(' dateheurereglemen="'.fa_ent_xml($row[dateheurereglemen]).'"');
		echo(' date_reglement_clair="'.fa_ent_xml($row[date_reglement_clair]).'"');
		echo(' date_creation_clair="'.fa_ent_xml($row[date_creation_clair]).'"');
    echo(' montant_paye="'.$montant_paye.'"');
    echo(' montant_pointe="'.$montant_pointe.'"');
		printf(' val_montant_paye ="%011u"',$val_montant_paye);
		printf(' val_montant_pointe ="%011u"',$val_montant_pointe);
    echo(' devise_paye_clair="'.fa_ent_xml($row[devise_paye_clair]).'"');
    echo(' coef="'.fa_ent_xml($row[coef]).'"');
    echo(' acompte="'.fa_ent_xml($row[acompte]).'"');
    echo(' transfert="'.fa_ent_xml($row[transfert]).'"');
    echo(' impaye="'.fa_ent_xml($row[impaye]).'"');
    echo(' remboursement="'.fa_ent_xml($row[remboursement]).'"');
    echo(' option_remise="'.fa_ent_xml($row[option_remise]).'"');
    echo(' accepte="'.fa_ent_xml($row[accepte]).'"');
    echo(' banque="'.fa_ent_xml($row[banque]).'"');
    echo(' domiciliation="'.fa_ent_xml($row[domiciliation]).'"');
    echo(' etablissement="'.fa_ent_xml($row[etablissement]).'"');
    echo(' guichet="'.fa_ent_xml($row[guichet]).'"');
    echo(' compte="'.fa_ent_xml($row[compte]).'"');
    echo(' cle="'.fa_ent_xml($row[cle]).'"');
    echo(' type_ecart="'.fa_ent_xml($row[type_ecart]).'"');
    echo(' blocnotebrut="'.fa_ent_xml($row[blocnotebrut]).'"');
		$genre="";
		if ($row[coef]==-1){$genre="Avoir ";}
		echo(' genre="'.$genre.'"');
		echo(' journal_clair="'.fa_ent_xml($row[journal_clair]).'"');
  echo("/>");
}
echo("</donnees>");
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
