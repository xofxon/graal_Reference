<?php
include("_graal_header_txt.inc.php");
define('EOL', "\r\n");
$vl_e_obj_cleunik_ori=intval(fa_recup_param('vl_e_obj_cleunik_ori','0'));
$vl_e_obj_cleunik_des=intval(fa_recup_param('vl_e_obj_cleunik_des','0'));
$vl_type=fa_recup_param("vl_type",'unseul');
$vl_c_prefixe=fa_recup_param("vl_c_prefixe",'_x_x_x_x_');
$vl_c_type_objet=fa_recup_param("vl_c_type_objet",'_x_x_x_x_');
switch ($vl_type) {
  case "unseul":
    $sql_req = "SELECT _elements.ele_cleunik as ori_ele_cleunik,_elements.titre as titre,_elements.type_objet as type_objet FROM _elements WHERE _elements.fen_cleunik=$vl_e_obj_cleunik_ori and _elements.titre not in (select _elements.titre from _elements where fen_cleunik=$vl_e_obj_cleunik_des)";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)){
      $vl_e_ele_cleunik=_graal_requete_max("ele_cleunik","_elements");
      $vl_e_ori_ele_cleunik=$row['ori_ele_cleunik'];
      $sql_req_ins = "INSERT INTO _elements set fen_cleunik=$vl_e_obj_cleunik_des,ele_cleunik=$vl_e_ele_cleunik,titre='".$row['titre']."',type_objet=".$row['type_objet'];
      $result_ins = _graal_requete_bd($sql_req_ins);
      if($result_ins === false){
        $vf_c_echo=mysql_error($cnx) . $sql_req_ins;
        $vf_c_echo=$sql_req_ins;
      } else {
        $vf_c_echo='ok';
      }
      $sql_req_ins = "insert into _elements_libelle select $vl_e_ele_cleunik,alias01.descriptif,alias01.commentaire,alias01.langue,alias01.uti_cleunik from _elements_libelle alias01 where ele_cleunik=$vl_e_ori_ele_cleunik";
      $result_ins = _graal_requete_bd($sql_req_ins);
      if($result_ins === false){
        $vf_c_echo=mysql_error($cnx) . $sql_req_ins;
        $vf_c_echo=$sql_req_ins;
      } else {
        $vf_c_echo='ok';
      }
    }
    _graal_libere_requete_bd($result);
    break;
  case "tous":
    $sql_req01 = "SELECT _objets.fen_cleunik as fen_cleunik FROM _objets WHERE _objets.fen_cleunik<>$vl_e_obj_cleunik_ori and _objets.prefixe='$vl_c_prefixe' and _objets.type_objet=$vl_c_type_objet";      
    $sql_result01 = _graal_requete_bd($sql_req01);
    if (mysql_num_rows($sql_result01) != 0){
      while ($row01 = mysql_fetch_assoc($sql_result01)) {
        $vl_e_obj_cleunik_des=$row01['fen_cleunik'];
        $sql_req = "SELECT _elements.ele_cleunik as ori_ele_cleunik,_elements.titre as titre,_elements.type_objet as type_objet FROM _elements WHERE _elements.fen_cleunik=$vl_e_obj_cleunik_ori and _elements.titre not in (select _elements.titre from _elements where fen_cleunik=$vl_e_obj_cleunik_des)";
        $result = _graal_requete_bd($sql_req);
        while ($row = mysql_fetch_assoc($result)){
          $vl_e_ele_cleunik=_graal_requete_max("ele_cleunik","_elements");
          $vl_e_ori_ele_cleunik=$row['ori_ele_cleunik'];
          $sql_req_ins = "INSERT INTO _elements set fen_cleunik=$vl_e_obj_cleunik_des,ele_cleunik=$vl_e_ele_cleunik,titre='".$row['titre']."',type_objet=".$row['type_objet'];
          $result_ins = _graal_requete_bd($sql_req_ins);
          if($result_ins === false){
            $vf_c_echo=mysql_error($cnx) . $sql_req_ins;
            $vf_c_echo=$sql_req_ins;
          } else {
            $vf_c_echo='ok';
          }
          $sql_req_ins = "insert into _elements_libelle select $vl_e_ele_cleunik,alias01.descriptif,alias01.commentaire,alias01.langue,alias01.uti_cleunik from _elements_libelle alias01 where ele_cleunik=$vl_e_ori_ele_cleunik";
          $result_ins = _graal_requete_bd($sql_req_ins);
          if($result_ins === false){
            $vf_c_echo=mysql_error($cnx) . $sql_req_ins;
            $vf_c_echo=$sql_req_ins;
          } else {
            $vf_c_echo='ok';
          }
        }
        _graal_libere_requete_bd($result);
      }
    _graal_libere_requete_bd($sql_result01);
    }
    break;
}
_graal_ferme_connexion();
?>
