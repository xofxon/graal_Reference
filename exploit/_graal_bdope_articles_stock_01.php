<?php
include("_graal_header_txt.inc.php");
$vf_c_echo="";
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","-1"));
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_gestion=intval(fa_recup_param("vl_gestion",2));
$vl_pu_reference=fa_floatval(fa_recup_param("vl_pu_reference",0));
$vl_unite_stock=intval(fa_recup_param("vl_unite_stock","-14"));
$vl_qte_mini=fa_floatval(fa_recup_param("vl_qte_mini",0));
$vl_qte_maxi=fa_floatval(fa_recup_param("vl_qte_maxi",0));
$vl_qte_securite=fa_floatval(fa_recup_param("vl_qte_securite",0));
$vl_qte_alerte=fa_floatval(fa_recup_param("vl_qte_alerte",0));
$vl_nb_decimales_qte=intval(fa_recup_param("vl_nb_decimales_qte",2));
$vl_unite_condi=intval(fa_recup_param("vl_unite_condi","-37"));
$vl_nb_stock_in_condi=fa_floatval(fa_recup_param("vl_nb_stock_in_condi",0));


$vl_qte_mini=fa_reel($vl_qte_mini,$vl_nb_decimales_qte,".","");
$vl_qte_maxi=fa_reel($vl_qte_maxi,$vl_nb_decimales_qte,".","");
$vl_qte_securite=fa_reel($vl_qte_securite,$vl_nb_decimales_qte,".","");
$vl_qte_alerte=fa_reel($vl_qte_alerte,$vl_nb_decimales_qte,".","");
$vl_nb_stock_in_condi=fa_reel($vl_nb_stock_in_condi,$vl_nb_decimales_qte,".","");

switch ($vf_c_action)
{
  case "supprimer":
    $sql_req = "DELETE FROM _art_stock WHERE _art_stock.art_cleunik = $vl_e_art_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_e_art_cleunik;} else {$vf_c_echo=-1;}
    break;    
  case "ajouter":
  case "modifier":
    //  Gestion du stock
    //  Toujours commencer par la tentative d'ajout qui plantera s'il y a un doublon alors qu'un update ne plante pas si l'enregistrment n'existe pas
    $sql_req="INSERT INTO _art_stock set art_cleunik=$vl_e_art_cleunik,pu_reference=$vl_pu_reference,gestion=$vl_gestion,unite_stock=$vl_unite_stock,qte_mini=$vl_qte_mini,qte_maxi=$vl_qte_maxi,qte_securite=$vl_qte_securite,qte_alerte=$vl_qte_alerte,nb_decimales_qte=$vl_nb_decimales_qte,unite_condi=$vl_unite_condi,nb_stock_in_condi=$vl_nb_stock_in_condi;";    
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') 
    {
    $vf_c_echo=$vl_e_art_cleunik;
    } 
    else {
      $sql_req="UPDATE _art_stock set pu_reference=$vl_pu_reference,gestion=$vl_gestion,unite_stock=$vl_unite_stock,qte_mini=$vl_qte_mini,qte_maxi=$vl_qte_maxi,qte_securite=$vl_qte_securite,qte_alerte=$vl_qte_alerte,nb_decimales_qte=$vl_nb_decimales_qte,unite_condi=$vl_unite_condi,nb_stock_in_condi=$vl_nb_stock_in_condi WHERE _art_stock.art_cleunik = $vl_e_art_cleunik;";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo=='ok') {$vf_c_echo=$vl_e_art_cleunik;} else {$vf_c_echo=-1;}
    }
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
