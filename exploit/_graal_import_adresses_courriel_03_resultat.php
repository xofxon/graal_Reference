<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
set_time_limit(6000);
$vl_c_mailing=intval(fa_recup_param('veuxpasdemail','2'));
$vl_c_valide=intval(fa_recup_param('valide','1'));
$vl_c_description=fa_recup_param('description','');
$vl_c_modele="3";
$sep_ret='|';
$o_import=new _graal_import();
$o_import->req="INSERT INTO _w_import_courriel_ligne (imp_cleunik,lig_cleunik,refweb,nom,prenom,valide,emailing) VALUES ";
$retour='1'.$sep_ret."C'est tout bon.".$sep_ret;
$vf_e_imp_cleunik=_graal_requete_max("imp_cleunik","_w_import_courriel_entete");
$vf_e_lig_cleunik=_graal_requete_max("lig_cleunik","_w_import_courriel_ligne");
switch ($vl_c_modele) {
  case "1": //  Modèle 3 colonnes : prénom,nom,courriel
    break;
  case "2": //  Modèle 2 colonnes : courriel, valide (1 ou 2)
    break;
  case "3": //  Modèle 3 colonnes : courriel, valide (1 ou 2 ou 3), emailing autorisé 1,2,3
  	$vl_c_var=fa_recup_param('var','vs_tempo_panier_refweb');
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$vl_c_var"]);
		$sql_req_02="";
    $i=0;$i1=500;
    $sql_req00="INSERT INTO _w_import_courriel_entete (imp_cleunik,description,blocnotebrut,dateheurecreation,typeimport,hash) VALUES ($vf_e_imp_cleunik,'".addslashes("Récupération adresses $vl_c_description ")."',NULL,now(),$vl_c_modele,NULL)";
    $result_00=_graal_requete_bd($sql_req00);
    if($result_00 === false) {$vf_c_echo='Erreur 00 ->'.mysql_error($cnx).$sql_req_02;}
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $i++;
      $vl_c_refweb=addslashes(str_replace(' ', '', base64_decode($vl_t_listecles[$vl_e_i])));
      $vf_e_lig_cleunik++;
      $o_import->dat.="($vf_e_imp_cleunik,$vf_e_lig_cleunik,'$vl_c_refweb',NULL,NULL,$vl_c_valide,$vl_c_mailing),";
      if ($i % $i1==0){
        $o_import->execute();
      }
    }
    $o_import->execute();
		$retour=$vf_e_imp_cleunik.$sep_ret."Enregistré $i adresses courriels ...".$sep_ret;
    break;
  case "4": //  Modèle 5 colonnes : prénom,nom,courriel, valide (1 ou 2 ou 3), emailing autorisé 1,2,3
    break;
}
echo $retour;
?>
