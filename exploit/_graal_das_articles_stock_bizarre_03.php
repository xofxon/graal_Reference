<?php
include("_graal_header_xml.inc.php");
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));  
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));
$vl_e_qte_nulle=intval(fa_recup_param("vl_e_qte_nulle",'3'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','inventaire.xls');
session_write_close();
$sql_req="SELECT f2.art_cleunik,f2.code,f0.qte_stock as stock_depot_emplacement,f2.mnemotechnique,f2.description,f2.actif,";
$sql_req.= " (select f1.qte_pos from _mouvements_stock f1 where f1.art_cleunik=f0.art_cleunik and f1.choix_depot=f0.choix_depot and f1.choix_empla=f1.choix_empla order by dateheuremvt desc, mvt_cleunik desc limit 1) as stock_dernier_mouvement,";
$sql_req.= " f3.choix_valeur_texte_01 as 'depot',f4.choix_valeur_texte_01 as 'emplacement',";
$sql_req.= " (select f1.mvt_cleunik from _mouvements_stock f1 where f1.art_cleunik=f0.art_cleunik and f1.choix_depot=f0.choix_depot and f1.choix_empla=f1.choix_empla order by dateheuremvt desc, mvt_cleunik desc limit 1) as mvt_cleunik"; 
$sql_req.= " from _article f2 left join _art_dep_emp f0 on f0.art_cleunik=f2.art_cleunik ";
$sql_req.= " left join _choix f3 on f3.choix_cleunik=f0.choix_depot ";
$sql_req.= " left join _choix f4 on f4.choix_cleunik=f0.choix_empla ";
$sql_req.= " where f0.art_cleunik is null and f2.art_cleunik<>0";
switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND f2.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND f2.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND f2.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND f2.types_gestion & 4";break;        
  case 'fabrication': $sql_req.= " AND f2.types_gestion & 8";break;        
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND f2.actif=1";break;// Actifs
  case 2: $sql_req.= " AND f2.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_validite) {
  case '': break;
  default: $sql_req.=" and (f2.dateheurevalidite >= '$vl_c_validite' or f2.dateheurevalidite is null)";break;  
}
/*
switch ($vl_e_qte_nulle) {
  case 1: $sql_req.= " AND f2.qte_stock=0";break;// Nulle
  case 2: $sql_req.= " AND f2.qte_stock<>0";break;// Non nulle
  case 3: break;// Tous
  case 4: $sql_req.= " AND f.qte_stock<0";break;// NÃ©gatives
}
*/
$sql_req.= " order by 2;";
//$sql_req.= " LIMIT 0, $vl_e_limit";
$nb_dec=2;
switch ($vl_c_sortie) {
  case "das":
    $result = _graal_requete_bd($sql_req);
	echo('<donnees>');
	while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		  if ($row['stock_dernier_mouvement']==0) {
		    $qte_stock=""; } else 
		  {
		    $qte_stock=fa_reel(fa_ent_xml($row['stock_dernier_mouvement']),$nb_dec);
		  }
		  $val_qte_stock=$row['stock_dernier_mouvement']*1000;
		  if ($row['stock_depot_emplacement']==0) {
		    $qte_stock_mvt=""; } else 
		  {
		    $qte_stock_mvt=fa_reel(fa_ent_xml($row['stock_depot_emplacement']),$nb_dec);
		  }
		  $val_qte_stock_mvt=$row['stock_depot_emplacement']*1000;
		  echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		  echo(' code="'.fa_ent_xml($row['code']).'"');
		  echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
		  echo(' description="'.fa_ent_xml($row['description']).'"');
		  echo(' depot="'.fa_ent_xml($row['depot']).'"');
		  echo(' emplacement="'.fa_ent_xml($row['emplacement']).'"');
		  echo(' qte_stock="'.$qte_stock.'"');
		  printf(' val_qte_stock="%011u"',$val_qte_stock);
		  echo(' qte_stock_mvt="'.$qte_stock_mvt.'"');
		  //printf(' val_qte_stock_mvt="%011u"',$val_qte_stock_mvt);
		  echo(' val_qte_stock_mvt="'.$val_qte_stock_mvt.'"');
		  if ($row['actif']==1) {
		    echo(' properties=""');
		  } else {
		    echo(' properties="css_0001"');
		  }
		  echo('/>');
	}
	echo('</donnees>');
	_graal_libere_requete_bd($result);
	
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
_graal_ferme_connexion();
?>
