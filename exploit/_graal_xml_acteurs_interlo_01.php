<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$prop_obsolete="css_0001";
$vl_c_liste_act_cleunik=intval(fa_recup_param('vl_c_liste_act_cleunik',10000429));
$xml='';
$xml .=fa_xcree_entete_xml().EOL;
$xml .='<dossier label=" Les interlocuteurs" properties="ai04" id="root">'.EOL;
/*
0 -> Acteurs
1 -> Interlocuteurs
2 -> Téléphones
3 -> Fax
4 -> Courriels
5 -> Identifiants de messagerie instantannée
*/
$sql_req_00="SELECT act_cleunik as act_cleunik,raisonsoc as raisonsoc,nomcommercial FROM _acteurs where act_cleunik in($vl_c_liste_act_cleunik) order by raisonsoc";
$result_00=_graal_requete_bd($sql_req_00);
while ($row_00 = mysql_fetch_assoc($result_00)){
	if ($row_00['raisonsoc']=="") {
		$nom_acteur=$row_00['nomcommercial'];
	} else {
		$nom_acteur=$row_00['raisonsoc'];
	}
  $xml .='<item _graal_genre="0" _graal_cleunik="'.$row_00['act_cleunik'].'" _graal_int_cleunik="'.$row_00['act_cleunik'].'" label="' .fa_ent_xml($nom_acteur). '" properties="ai04" url="">'.EOL;
  //  Attention ne jamais afficher l'interlocuteur 0, interlocuteur par défaut de l'applicatif
  $sql_req_01 = "SELECT _act_interlo.int_cleunik as int_cleunik,_choix.choix_valeur_texte_01 as civilite, concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui,_act_interlo.actif as actif from _act_interlo,_choix where _act_interlo.act_cleunik =".$row_00['act_cleunik']." and _choix.choix_cleunik = _act_interlo.choix_cleunik and _act_interlo.int_cleunik <> 0 ORDER BY `patronyme`"; 
  $result_01 = _graal_requete_bd($sql_req_01);
  while ($row_01 = mysql_fetch_assoc($result_01)) {
    if ($row_01['actif']==1) {$prop_interlo_actif='';} else {$prop_interlo_actif=$prop_obsolete;}
    $sql_req_02 = "SELECT _act_interlo_choix_fixes.choix_cleunik AS choix_cleunik,_choix.critere_cleunik AS critere_cleunik,case _criteres.critere_codechoixpertinent WHEN 1 THEN _choix.choix_code ELSE '' END AS choix_code,_choix.choix_valeur_texte_01 AS choix_valeur_texte_01,_criteres.critere_denomination AS critere_denomination FROM _choix, _act_interlo_choix_fixes, _criteres  WHERE _choix.choix_cleunik = _act_interlo_choix_fixes.choix_cleunik  AND _criteres.critere_cleunik = _act_interlo_choix_fixes.critere_cleunik AND _act_interlo_choix_fixes.int_cleunik = $row_01[int_cleunik] and _act_interlo_choix_fixes.critere_cleunik=92";
    $result_02 = _graal_requete_bd($sql_req_02);
    $row_02 = mysql_fetch_assoc($result_02);
    $xml .='<item _graal_genre="1" _graal_cleunik="'.$row_01['int_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'" label="' .fa_ent_xml($row_01['civilite']).' ' .fa_ent_xml($row_01['qui']). '(' .fa_ent_xml($row_02['choix_valeur_texte_01']).')'. '" properties="ai04 '.$prop_interlo_actif.'" >'.EOL;
    _graal_libere_requete_bd($result_02);
    //  Recherche des téléphones de l'interlocuteur
    $sql_req_02 = "SELECT _act_interlo_tel.intel_cleunik as intel_cleunik, _act_interlo_tel.telformate as notel, _choixtel.choix_valeur_texte_01 as genretel,_choixprefixe.choix_code as prefixe from _act_interlo_tel,_choix _choixtel,_choix _choixprefixe where _act_interlo_tel.int_cleunik=$row_01[int_cleunik] and _choixtel.choix_cleunik = _act_interlo_tel.choix_cleunik and _choixprefixe.choix_cleunik = _act_interlo_tel.prefixe_choix_cleunik"; 
    $result_02 = _graal_requete_bd($sql_req_02);
    while ($row_02 = mysql_fetch_assoc($result_02)) {
      $xml .='<item _graal_genre="2" _graal_cleunik="'.$row_02['intel_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'" label="(' .fa_ent_xml($row_02['prefixe']).') ' .fa_ent_xml($row_02['notel']).' (' .fa_ent_xml($row_02['genretel']). ')" properties="ai05" ></item>'.EOL;
    }
    _graal_libere_requete_bd($result_02);
    //  Recherche des fax
    $sql_req_02 = "SELECT _act_interlo_fax.intel_cleunik as intel_cleunik, _act_interlo_fax.telformate as notel, _choixtel.choix_valeur_texte_01 as genretel,_choixprefixe.choix_code as prefixe from _act_interlo_fax,_choix _choixtel,_choix _choixprefixe  where _act_interlo_fax.int_cleunik=$row_01[int_cleunik] and _choixtel.choix_cleunik = _act_interlo_fax.choix_cleunik and _choixprefixe.choix_cleunik = _act_interlo_fax.prefixe_choix_cleunik"; 
    $result_02 = _graal_requete_bd($sql_req_02);
    while ($row_02 = mysql_fetch_assoc($result_02)) {
      $xml .='<item _graal_genre="3" _graal_cleunik="'.$row_02['intel_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'"  label="(' .fa_ent_xml($row_02['prefixe']).') ' .fa_ent_xml($row_02['notel']).' (' .fa_ent_xml($row_02['genretel']). ')" properties="al03" ></item>'.EOL;
    }
    _graal_libere_requete_bd($result_02);
    //  Recherche des courriels
    //  Les conditions sont à affiner (afficher les valides et autorisés et les autres distinctement)
    //  Utiliser un style "barré" pur les interdits
    $sql_req_02 = "SELECT _act_interlo_mail.intweb_cleunik as intweb_cleunik, _act_interlo_mail.refweb as courriel, _act_interlo_mail.valide as valide, _choixweb.choix_valeur_texte_01 as genreweb from _act_interlo_mail,_choix _choixweb where _act_interlo_mail.int_cleunik=$row_01[int_cleunik] and _choixweb.choix_cleunik = _act_interlo_mail.choix_cleunik"; 
    $result_02 = _graal_requete_bd($sql_req_02);
    while ($row_02 = mysql_fetch_assoc($result_02)) {
      if ($row_02['valide']==2) {
        $xml .='<item _graal_valide="'.$row_02['valide'].'" _graal_genre="4" _graal_cleunik="'.$row_02['intweb_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'" label="' .fa_ent_xml($row_02['courriel']).' (' .fa_ent_xml($row_02['genreweb']). ')" properties="ag18 '.$prop_obsolete.'" ></item>'.EOL;
      } else {
        $xml .='<item _graal_valide="'.$row_02['valide'].'" _graal_genre="4" _graal_cleunik="'.$row_02['intweb_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'" label="' .fa_ent_xml($row_02['courriel']).' (' .fa_ent_xml($row_02['genreweb']). ')" properties="ag18" ></item>'.EOL;
      }
    }
    _graal_libere_requete_bd($result_02);
    //  Recherche des identifiants de messagerie instantannée
    //  Utiliser un style "barré" pur les interdits
    $sql_req_02 = "SELECT mesinst_cleunik as mesinst_cleunik, mesinst as mesinst, valide as valide, choix_valeur_texte_01 as type from _act_interlo_mesinst,_choix where int_cleunik=$row_01[int_cleunik] and choix_cleunik = choix_cleunik_type"; 
    $result_02 = _graal_requete_bd($sql_req_02);
    while ($row_02 = mysql_fetch_assoc($result_02)) {
      if ($row_02['valide']==2) {
        $xml .='<item _graal_valide="'.$row_02['valide'].'" _graal_genre="5" _graal_cleunik="'.$row_02['mesinst_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'" label="' .fa_ent_xml($row_02['mesinst']).' (' .fa_ent_xml($row_02['mesinst']). ')" properties="xx03 '.$prop_obsolete.'" ></item>'.EOL;
      } else {
        $xml .='<item _graal_valide="'.$row_02['valide'].'" _graal_genre="5" _graal_cleunik="'.$row_02['mesinst_cleunik'].'" _graal_int_cleunik="'.$row_01['int_cleunik'].'" label="' .fa_ent_xml($row_02['mesinst']).' (' .fa_ent_xml($row_02['mesinst']). ')" properties="xx03" ></item>'.EOL;
      }
    }
    _graal_libere_requete_bd($result_02);
    $xml .='</item>'.EOL;
  }
}
 _graal_libere_requete_bd($result_00);
$xml .='</item>'.EOL;
$xml .='</dossier>'.EOL;
_graal_libere_requete_bd($result_01);
_graal_ferme_connexion();
echo($xml);
?>
