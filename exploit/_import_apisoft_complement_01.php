<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_prospect');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_qui=fa_recup_param('qui','');
$vl_c_quoi=fa_recup_param('quoi','');
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik',''));
include("_import_class_data_km.php");
$com_cod=array();$com_cle=array();
$o_ch=new _graal_import();
$o_choix=new _graal_import();
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$o_ch->req="INSERT INTO $vl_c_base_destination._choix (critere_cleunik,choix_cleunik,choix_code,choix_valeur_texte_01,choix_actif,choix_portee) VALUES ";
$vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
switch ($vl_c_qui) {
  case "prospect":
    $sql_req = "SELECT distinct(`$vl_c_quoi`) as complement FROM $vl_c_base_origine.tiers where `$vl_c_quoi` <> '' and `$vl_c_quoi` not in (select choix_valeur_texte_01 from $vl_c_base_destination._choix where critere_cleunik=$vl_e_critere_cleunik)";
    break;
}
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  //  Ajout dans la table des choix
  $vf_e_choix_cleunik++;
  $choix_code=addslashes($row['complement']);
  $choix_valeur_texte_01=addslashes($row['complement']);
  $o_ch->dat.="($vl_e_critere_cleunik,$vf_e_choix_cleunik,'$choix_code','$choix_valeur_texte_01',1,127),";
}
_graal_libere_requete_bd($result);
$o_ch->execute();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=$vl_e_critere_cleunik"; //  On recherche les critères origine
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($com_cod, $row['code']);
  array_push ($com_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
switch ($vl_c_qui) {
  case "prospect":
    $sql_req = "SELECT `$vl_c_quoi` as complement,CODE as code,act_cleunik as act_cleunik FROM $vl_c_base_origine.tiers,$vl_c_base_destination._acteurs where code=codealphanum15 and `$vl_c_quoi` <> '';";
    break;
}
$result = _graal_requete_bd($sql_req);
$i=0;$i1=500;
while ($row = mysql_fetch_assoc($result)){
  //  Ajout dans la table des choix des acteurs
  $i++;
  $vl_e_trouve_com=array_search($row['complement'], $com_cod);if ($vl_e_trouve_com===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$com_cle[$vl_e_trouve_com];}
  if ($vl_e_choix_cleunik!=0) {
    $act_cleunik=$row['act_cleunik'];
    $o_choix->dat.="($act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik,110001),";
  }
  if ($i % $i1==0){
    $o_choix->execute();
  }
}
$o_choix->execute();
_graal_libere_requete_bd($result);
echo ("Ajouté $i $vl_c_quoi");
?>
