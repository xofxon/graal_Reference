<?php
include("_graal_header_xul.inc.php");
include("_graal_var_portee.php");
include("_graal_fonctions_cryptage.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_intweb_cleunik=intval(fa_recup_param('vl_e_intweb_cleunik','-1'));
$vl_e_action_cleunik=intval(fa_recup_param('action_cleunik','-1'));
$vl_action_cleunik_liee=intval(fa_recup_param('vl_action_cleunik_liee','-1'));
$vl_c_type_courriel=fa_recup_param('type','texte');
$vl_c_genre=fa_recup_param('genre','normal');
$vl_e_int_cleunik_recvoc=intval(fa_recup_param('vl_e_int_cleunik_recvoc','-1'));
$vl_doc_cleunik=intval(fa_recup_param('vl_doc_cleunik','-99999'));
$vl_c_nomdoc=fa_recup_param('vl_c_nomdoc','???');
switch ($vl_c_genre) {
  case "reponse":
    break;
  case "transfert":
    break;
  case "normal":
    break;
  case "renvoi":
    break;
  case "formulaire":
    break;
  case "brouillon":
    break;


}
switch ($vl_c_type_courriel) {
  case "texte":$vl_c_id_fenetre="Fen_00066";$vl_e_typedoc="6";break;//Envoi de courriels format texte brut
  case "html" :$vl_c_id_fenetre="Fen_00513";$vl_e_typedoc="10";break;//Envoi de courriels format html
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_b_ajout=$vl_tb_droits[1];
$vl_b_modif=$vl_tb_droits[2];
$vl_b_suppr=$vl_tb_droits[3];
$vl_b_impri=$vl_tb_droits[4];
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bak_100=fa_recup_dico("bak_100");
$vl_c_bak_101=fa_recup_dico("bak_101");
$vl_c_bak_102=fa_recup_dico("bak_102");
$vl_c_bak_103=fa_recup_dico("bak_103");
$vl_c_bak_104=fa_recup_dico("bak_104");
$vl_c_bak_105=fa_recup_dico("bak_105");
$vl_c_bak_106=fa_recup_dico("bak_106");
$vl_c_bak_107=fa_recup_dico("bak_107");
$vl_c_bak_108=fa_recup_dico("bak_108");
$vl_c_bak_109=fa_recup_dico("bak_109");
$vl_c_bak_110=fa_recup_dico("bak_110");
$vl_c_bak_111=fa_recup_dico("bak_111");
$vl_c_bak_112=fa_recup_dico("bak_112");
$vl_c_bak_113=fa_recup_dico("bak_113");
$vl_c_bak_114=fa_recup_dico("bak_114");
$vl_c_bak_115=fa_recup_dico("bak_115");
$vl_c_bak_116=fa_recup_dico("bak_116");
$vl_c_bak_117=fa_recup_dico("bak_117");
$vl_c_bak_118=fa_recup_dico("bak_118");
$vl_c_bak_119=fa_recup_dico("bak_119");
$vl_c_bak_120=fa_recup_dico("bak_120");
$vl_c_bak_121=fa_recup_dico("bak_121");
$vl_c_bak_122=fa_recup_dico("bak_122");
$vl_c_bak_123=fa_recup_dico("bak_123");
$vl_c_bak_124=fa_recup_dico("bak_124");
$vl_c_bak_125=fa_recup_dico("bak_125");
$vl_c_bak_126=fa_recup_dico("bak_126");
$vl_c_bak_127=fa_recup_dico("bak_127");
$vl_c_bak_128=fa_recup_dico("bak_128");
$vl_c_bak_129=fa_recup_dico("bak_129");
$vl_c_bak_130=fa_recup_dico("bak_130");
$vl_c_bak_131=fa_recup_dico("bak_131");
$vl_c_bak_132=fa_recup_dico("bak_132");
$vl_c_bak_133=fa_recup_dico("bak_133");
$vl_c_bak_134=fa_recup_dico("bak_134");
$vl_c_bak_135=fa_recup_dico("bak_135");
$vl_c_bak_136=fa_recup_dico("bak_136");
$vl_c_bak_137=fa_recup_dico("bak_137");
$vl_c_bak_138=fa_recup_dico("bak_138");
$vl_c_bak_139=fa_recup_dico("bak_139");
$vl_c_bak_140=fa_recup_dico("bak_140");
$vl_c_bak_141=fa_recup_dico("bak_141");
$vl_c_bak_142=fa_recup_dico("bak_142");
$vl_c_bak_143=fa_recup_dico("bak_143");
$vl_c_bak_144=fa_recup_dico("bak_144");
$vl_c_bak_145=fa_recup_dico_js("bak_145");
$vl_c_bak_146=fa_recup_dico_js("bak_146");
$vl_c_bak_147=fa_recup_dico_js("bak_147");
$vl_c_bak_148=fa_recup_dico_js("bak_148");
$vl_c_bak_149=fa_recup_dico_js("bak_149");
$vl_c_bak_150=fa_recup_dico_js("bak_150");
$vl_c_bak_151=fa_recup_dico_js("bak_151");
$vl_c_bak_152=fa_recup_dico_js("bak_152");
$vl_c_bak_153=fa_recup_dico("bak_153");
$vl_c_bak_154=fa_recup_dico("bak_154");
$vl_c_bak_155=fa_recup_dico("bak_155");
$vl_c_bak_156=fa_recup_dico("bak_156");$vl_c_bak_156="Voir ?";
$vl_c_bak_157=fa_recup_dico("bak_157");$vl_c_bak_157="Enregistrer le brouillon";
$vl_c_dico_00007=fa_recup_dico("dico_00007");
$vl_c_dico_00013=fa_recup_dico("dico_00013");
$vl_c_dico_00014=fa_recup_dico("dico_00014");
$vl_c_dico_00129=fa_recup_dico("dico_00129");
//  On recherche l'interlocuteur à partir de l'adresse courriel
if ($vl_e_intweb_cleunik!=-1){
  $sql_req="SELECT concat_ws(' ',prenom,patronyme) as qui,_act_interlo_mail.refweb as refweb,_act_interlo_mail.int_cleunik as int_cleunik,_act_interlo.act_cleunik as act_cleunik FROM _act_interlo_mail,_act_interlo where _act_interlo.int_cleunik=_act_interlo_mail.int_cleunik and _act_interlo_mail.intweb_cleunik=$vl_e_intweb_cleunik;";
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_e_int_cleunik=$row['int_cleunik'];
  $vl_e_act_cleunik=$row['act_cleunik'];
  $vl_c_qui=fa_ent_xml($row['qui']);
  $vl_c_refweb=$row['refweb'];
  _graal_libere_requete_bd($result);
}
/*
//  On recherche l'adresse courriel à partir de l'interlocuteur (ce ne sera peut-être pas la bonne adresse !!!)
if ($vl_e_int_cleunik_recvoc!=-1){
  $sql_req="SELECT concat_ws(' ',prenom,patronyme) as qui,_act_interlo_mail.refweb as refweb,_act_interlo_mail.int_cleunik as int_cleunik,_act_interlo.act_cleunik as act_cleunik FROM _act_interlo_mail,_act_interlo where _act_interlo.int_cleunik=_act_interlo_mail.int_cleunik and _act_interlo_mail.int_cleunik=$vl_e_int_cleunik_recvoc;";
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_e_int_cleunik=$row['int_cleunik'];
  $vl_e_act_cleunik=$row['act_cleunik'];
  $vl_c_qui=fa_ent_xml($row['qui']);
  $vl_c_refweb=$row['refweb'];
  _graal_libere_requete_bd($result);
}
*/
//  On recherche l'action d'origine
$vl_sujet="";
$vl_c_message_text_b64="";
$vl_c_message_html_b64="_graal_page_blanche_01.php";

if ($vl_e_action_cleunik!=-1){
	switch ($vl_c_genre) {
	  case "reponse":
	  case "transfert":
		  $sql_req="SELECT _courriel_re.type,_courriel_re.mel_id,_courriel_re.datas_vrac,_courriel_re.sujet,_courriel_re.header,message_html,message_text,expediteurs as expediteurs FROM _courriel_re,_courriel_re_mes where _courriel_re.action_cleunik=$vl_e_action_cleunik and _courriel_re_mes.courriel_re_mes_cleunik=_courriel_re.courriel_re_mes_cleunik;";
			break;
	  case "renvoi":
	  case "brouillon":
		  $sql_req="SELECT _courriel_en.type,_courriel_en.mel_id,_courriel_en.datas_vrac,_courriel_en.sujet,'' as header,message as message_html,message_texte as message_text,destinataires as expediteurs FROM _courriel_en left join _courriel_en_mes using (courriel_en_mes_cleunik) where _courriel_en.action_cleunik=$vl_e_action_cleunik;";
			break;
	  case "formulaire":
	  	$sql_req="SELECT sujet,description FROM _actions where action_cleunik=$vl_e_action_cleunik;";
			break;
	}

  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_mel_id=$row['mel_id'];
  $vl_c_expediteurs=$row['expediteurs'];
  $vl_datas_vrac=$row['datas_vrac'];
  $vl_c_xml=simplexml_load_string($vl_datas_vrac);

	if (isset($vl_c_xml->nom_images_integrees_nombre[0][0])){$vl_nb_images=$vl_c_xml->nom_images_integrees_nombre[0]->attributes();}
	if (isset($vl_c_xml->nom_cou_destinataires_re[0])){$vl_c_destinataires_re=$vl_c_xml->nom_cou_destinataires_re[0]->attributes();}
	/*
	 * en cas de réception de message vocal, le destinataire n'est pas forcément pertinent !!
	 * On n'en tient donc pas compte
	*/
	if ($vl_e_int_cleunik_recvoc!=-1){
		$vl_c_destinataires_re="";
	}
	switch ($vl_c_genre) {
	  case "reponse":
	  case "transfert":
		 	$vl_c_message_text_b64_brut=$row['message_text'];
			$vl_c_message_html=$row['message_html'];
			break;
	  case "renvoi":
	  case "brouillon":
	    	$vl_c_message_text_b64_brut="";
			$vl_c_message_html="";
			break;
	  case "formulaire":
	  		$vl_c_formulaire=fa_ent_xml($row['description']);
			break;

	}
  $vl_c_message_head_b64_brut=$row['header'];


	if ($vl_nb_images!=0) {
	  $vl_e_i=0;
	  for($vl_e_j=0;$vl_e_j<$vl_nb_images;$vl_e_j++){
	    $vl_c_id=$vl_c_xml->nom_images_integrees[$vl_e_j]->attributes();
	    $sql_req="SELECT image,mime FROM _courriel_images where hash='$vl_c_id';";
	    $result=_graal_requete_bd($sql_req);
	    if($ligne=mysql_fetch_row($result)) {
	      $vl_e_i++;
	      $vl_t_id[$vl_e_i]=$vl_c_id;
	      $vl_t_init[$vl_e_i]=$genre.'data:'.$ligne[1].';base64,'.$ligne[0];
	    } else {
	      $vl_e_i++;
	      $vl_t_id[$vl_e_i]="Pas trouvé $vl_c_id";
	      $vl_t_init[$vl_e_i]="Pas trouvé $vl_c_id";
	    }
			_graal_libere_requete_bd($result);
	  }
	  //  Il faut décoder le message, remplacer les id puis ré-encoder le message
	  $posgenre=strpos($vl_c_message_html,'base64,')+7;
	  $genre=substr($vl_c_message_html,0,$posgenre);
	  $vl_c_adecoder=substr($vl_c_message_html,$posgenre,strlen($vl_c_message_html)-$posgenre);
	  $vl_c_message_html=base64_decode($vl_c_adecoder);
	  $vl_c_message_html=str_replace($vl_t_id,$vl_t_init,$vl_c_message_html);
	  $vl_c_message_html_b64=$genre.base64_encode($vl_c_message_html);
	} else {
	  $vl_c_message_html_b64=$vl_c_message_html;
	}


  switch ($vl_c_genre) {
    case "reponse":

      $vl_sujet=$vl_c_bak_143.fa_remplace_quotes_js($row['sujet']);
      $vl_int_cleunik=-2;
      $sql_req_01="SELECT int_cleunik FROM _graal where action_cleunik=$vl_e_action_cleunik and choix_cleunik in (-110400,-110431) and portee=$vl_e_interl and principal=2;";
      //$titi=$sql_req_01;
			$result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_int_cleunik=$row_01['int_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      if ($vl_c_destinataires_re!="") {$vl_c_expediteurs=$vl_c_destinataires_re;$vl_int_cleunik=-2;}
      if ($vl_int_cleunik!=-2) {
        if ($vl_e_int_cleunik_recvoc==-1){
					$sql_req_01="SELECT f1.intweb_cleunik as web_cleunik FROM _act_interlo_mail f1 where refweb='$vl_c_expediteurs' and f1.int_cleunik=$vl_int_cleunik;";
				} else {
					$sql_req_01="SELECT f1.intweb_cleunik as web_cleunik FROM _act_interlo_mail f1 where int_cleunik=$vl_int_cleunik and valide=1 and infofavori=1;";
				}
      } else {
        if ($vl_e_int_cleunik_recvoc==-1){
					$sql_req_01="SELECT f1.intweb_cleunik as web_cleunik FROM _act_interlo_mail f1 where refweb='$vl_c_expediteurs';";
				} else {
					$sql_req_01="SELECT f1.intweb_cleunik as web_cleunik FROM _act_interlo_mail f1 where int_cleunik=$vl_int_cleunik and valide=1 and infofavori=1;";
				}
      }
			//$toto=$sql_req_01;
      $result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_e_intweb_cleunik=$row_01['web_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      break;
    case "renvoi":
      break;
    case "brouillon":
      //  Recherche de l'émetteur initial
      $vl_int_cleunik_initial=-2;
      $sql_req_01="SELECT int_cleunik FROM _graal where action_cleunik=$vl_e_action_cleunik and choix_cleunik=-110401 and portee=$vl_e_interl and principal=2;";
      $result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_int_cleunik_initial=$row_01['int_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      $sql_req_01="SELECT f1.intweb_cleunik as web_cleunik FROM _act_interlo_mail f1 where int_cleunik=$vl_int_cleunik_initial and valide=1 and infofavori=1;";
      $result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_e_intweb_cleunik=$row_01['web_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      break;
      case "transfert":
      $vl_sujet_ini=fa_remplace_quotes_js($row['sujet']);
      $vl_from=fa_remplace_quotes(fa_ent_xml($row['expediteurs']));
      //  Recherche de l'émetteur initial
      $vl_int_cleunik_initial=-2;
      $sql_req_01="SELECT int_cleunik FROM _graal where action_cleunik=$vl_e_action_cleunik and choix_cleunik=-110400 and portee=$vl_e_interl and principal=2;";
      $result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_int_cleunik_initial=$row_01['int_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      $vl_sujet=$vl_c_bak_144.fa_remplace_quotes_js($row['sujet']);
      break;
    case "formulaire":
      $vl_sujet_ini=fa_remplace_quotes_js($row['sujet']);
      $vl_from=fa_remplace_quotes(fa_ent_xml($row['expediteurs']));
      //  Recherche de l'émetteur initial
      $vl_int_cleunik_initial=-2;
      $sql_req_01="SELECT int_cleunik FROM _graal where action_cleunik=$vl_e_action_cleunik and choix_cleunik=-110429 and portee=$vl_e_interl and principal=2;";
      $result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_int_cleunik_initial=$row_01['int_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      $vl_sujet="Réponse à ".fa_remplace_quotes_js($row['sujet']);
      $sql_req_01="SELECT f1.intweb_cleunik as web_cleunik FROM _act_interlo_mail f1 where int_cleunik=$vl_int_cleunik_initial and valide=1 and infofavori=1;";
      $result_01=_graal_requete_bd($sql_req_01);
      if (mysql_num_rows($result_01) != 0) {
        $row_01 = mysql_fetch_assoc($result_01);
        $vl_e_intweb_cleunik=$row_01['web_cleunik'];
      }
      _graal_libere_requete_bd($result_01);
      break;
  }
  _graal_libere_requete_bd($result);
}
//  On recherche tous les comptes possibles pour l'utilisateur
$vl_compte="<hbox>";
$sql_req = "SELECT _uti_cpt_bal.uticptbal_cleunik as cleunik,_uti_cpt_bal.titre as titre,_uti_cpt_bal.compte AS compte FROM _uti_cpt_bal,_droits_cpt_bal where _droits_cpt_bal.uti_cleunik=$vl_e_uti_cleunik and _droits_cpt_bal.uticptbal_cleunik=_uti_cpt_bal.uticptbal_cleunik and _uti_cpt_bal.genre = 1 order by titre;";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_compte.="<label value='$vl_c_boj_105' />";
}
else {
  $vl_b_envoi=false;
  $vl_compte.="<label value='$vl_c_boj_106'/><menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_emetteur'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)) {
  	$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
		$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
    $vl_c_smtp=$vl_c_xml->smtp[0]->attributes();
    if ($vl_c_smtp!="") {
      $vl_b_envoi=true;
      $vl_compte.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre'])). "' _graal_cleunik='".$row['cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' selected='true'/>";
    }
  }
  $vl_compte.="</menupopup></menulist>";
  if ($vl_b_envoi==true) {
    $vl_bouton_envoi="<button width='40' flex='1' id='bt_enregistrer' label='$vl_c_bak_101' crop='end' dir='normal' oncommand='pf_validation(\"enregistrer\")' tabindex='5'/>";
  }
}
$vl_compte.="</hbox>";
_graal_libere_requete_bd($sql_result);
//  On recherche tous les modèles
$vl_modeles="<hbox>";
$sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.descriptif_sommaire AS descriptif_sommaire,_documents.origine FROM _droits_doc, _documents WHERE _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc=$vl_e_typedoc";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_modeles.="<label value='$vl_c_bak_111' />";
}
else {
  $vl_modeles.="<label value='$vl_c_bak_112'/>";
  switch ($vl_c_type_courriel) {
    case "texte":
      break;
    case "html":
      $vl_modeles.="<toolbarbutton tooltiptext='$vl_c_bak_153' id='bt_selectionne_note' class='ai02' onclick='pf_ouvre_selection_note();' />";
      break;
  }
  $vl_modeles.="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' id='ml_modeles' flex='1' oncommand='pf_top_model(\"\");'><menupopup><menuitem label='$vl_c_bak_116' _graal_cleunik='0' selected='true'/>";
  while ($row = mysql_fetch_assoc($sql_result)){
    $vl_modeles.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")". "' _graal_origine='".$row['origine']. "' _graal_cleunik='".$row['doc_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")"."' _graal_sujet='".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire']))."'/>";
  }
  $vl_modeles.="</menupopup></menulist>";
}
$vl_modeles.="</hbox>";
_graal_libere_requete_bd($sql_result);
include("_graal_header_winxul.inc.php");
include("_graal_header_textfied.inc.php");
echo <<<END
<window context="graal_cp00" _graal_act_cleunik="$vl_e_act_cleunik" _graal_int_cleunik="$vl_e_int_cleunik" title="$vl_c_bak_102" id="_graal_courriel_01" onload="fa_aa(this);pf_etat_fen('ini')" $c_xmlns>
$vl_c_graal_cp00
<popup id="graal_cp_dest"><menuitem label="$vl_c_bak_141" oncommand="pf_supprime_ligne('li_dest_a');"/></popup>
<popup id="graal_cp_dest_cc"><menuitem label="$vl_c_bak_141" oncommand="pf_supprime_ligne('li_dest_cc');"/></popup>
<popup id="graal_cp_dest_cci"><menuitem label="$vl_c_bak_141" oncommand="pf_supprime_ligne('li_dest_cci');"/></popup>
<popup id="graal_cp_li_pj">
<menuitem label="$vl_c_bak_141" oncommand="pf_supprime_ligne('li_pj');"/>
<menuitem class="menuitem-iconic aa04" label="$vl_c_bak_156" oncommand="pf_voir_pj();" />

</popup>
END;
include("js/_graal_03.js.php");
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include_once("js/_graal_03.js.php");
include_once("js/_graal_05_dates.js.php");
include_once("js/_graal_07_ged.js.php");
include("js/_graal_courriel_01.js.php");
include("js/_graal_courriel_01_complement.js");
echo <<<END
  <tabbox id="tabbox_01" flex="1" orient="vertical" class="overflow_01">
    <tabs>
       <tab id="tab_edition" label="$vl_c_bak_103" selected="true"/>
       <tab id="tab_complement" label="$vl_c_bak_104"/>
    </tabs>
    <tabpanels flex="1">
		<tabpanel id="tabpanel_edition" flex="1">
      <hbox flex="1">
      <vbox id="messagepanel" flex="1">
        <vbox>
$vl_compte
<groupbox >
<hbox>
  <tabbox flex="1"  orient="horizontal" >
    <tabs  orient="vertical" class="tabs-left">
       <tab label="$vl_c_bak_107" id="tab_dest_a" linkedpanel="tabpanel_dest_a" class="tab-left" />
       <tab label="$vl_c_bak_108" id="tab_dest_cc" linkedpanel="tabpanel_dest_cc" class="tab-left" />
       <tab label="$vl_c_bak_109" id="tab_dest_cci" linkedpanel="tabpanel_dest_cci" class="tab-left" />
       <tab label="$vl_c_bak_138" id="tab_pj" linkedpanel="tabpanel_pj" class="tab-left" />
    </tabs>
    <tabpanels flex="1" >
       <tabpanel id="tabpabnel_dest_a" >
        <vbox flex="1">
               <hbox flex="1">
          <toolbarbutton id="bt_panier_dest_a" class="al02" onclick="pf_ouvre_panier_courriel(this.id)" />

        <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
          minlength="2"
          maxrows="50"
          ref="urn:suggest:values"
          label="?label"
          properties="?prop"
          issuggest="?issuggest"


          _graal_cleunik=""
          id="dest_a"
          tabindex="1"
        />
        <toolbarbutton id="bt_dest_a" class="ad02" label="$vl_c_bak_139" oncommand="pf_sel_courriel(this.id);" tabindex="2"/>
        </hbox>
                          <listbox rows="4" id="li_dest_a" context="graal_cp_dest">
                    <listhead >
                      <listheader label="$vl_c_bak_132" />
                      <listheader label="$vl_c_bak_133" />
                    </listhead>
                    <listcols >
              	     <listcol flex="1"/>
                     <listcol flex="1"/>
                    </listcols>
                  </listbox>

        </vbox>


      </tabpanel>
       <tabpanel id="tabpabnel_dest_cc" >
        <vbox flex="1">
               <hbox flex="1">
        <toolbarbutton id="bt_panier_dest_cc" class="al02" onclick="pf_ouvre_panier_courriel(this.id)" />

        <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
          minlength="2"
          maxrows="50"
          ref="urn:suggest:values"
          label="?label"
          properties="?prop"
          issuggest="?issuggest"


          _graal_cleunik=""
          id="dest_cc"
          champsuivant="bt_dest_cc"
        />
        <toolbarbutton id="bt_dest_cc" class="ad02" label="$vl_c_bak_139" onclick="pf_sel_courriel(this.id)" />
        </hbox>
                          <listbox rows="4" context="graal_cp_dest_cc" id="li_dest_cc">
                    <listhead >
                      <listheader label="$vl_c_bak_132" />
                      <listheader label="$vl_c_bak_133" />
                    </listhead>
                    <listcols >
              	     <listcol flex="1"/>
                     <listcol flex="1"/>
                    </listcols>
                  </listbox>

        </vbox>
        </tabpanel>



       <tabpanel id="tabpabnel_dest_cci" >
        <vbox flex="1">
               <hbox flex="1">
        <toolbarbutton id="bt_panier_dest_cci" class="al02" onclick="pf_ouvre_panier_courriel(this.id)" />
        <textbox flex="1" type="autosuggest" autosuggestsearch="" autosuggestparam="recherche" autosuggestlimit="limit" limit="50"
          minlength="2"
          maxrows="50"
          ref="urn:suggest:values"
          label="?label"
          properties="?prop"
          issuggest="?issuggest"


          _graal_cleunik=""
          id="dest_cci"
          champsuivant="bt_dest_cci"
        />
        <toolbarbutton id="bt_dest_cci" class="ad02" label="$vl_c_bak_139" onclick="pf_sel_courriel(this.id)" />
        </hbox>
                          <listbox rows="4" context="graal_cp_dest_cci" id="li_dest_cci">
                    <listhead >
                      <listheader label="$vl_c_bak_132" />
                      <listheader label="$vl_c_bak_133" />
                    </listhead>
                    <listcols >
              	     <listcol flex="1"/>
                     <listcol flex="1"/>
                    </listcols>
                  </listbox>

        </vbox>
        </tabpanel>
<tabpanel id="tabpanel_pj" >
  <vbox flex="1">
    <hbox flex="1">
      <toolbarbutton observes="broadcaster_01" class="al02" tooltiptext="$vl_c_bak_135" id="tb_ouvre_fichier_disque" oncommand="pf_ouvre_fichier('disque');"/>
      <toolbarbutton observes="broadcaster_01" class="ai03" tooltiptext="$vl_c_bak_136" id="tb_ouvre_fichier_ged" oncommand="pf_ouvre_fichier('ged');"/>
      <toolbarbutton observes="broadcaster_01" class="al14" tooltiptext="$vl_c_bak_137" id="tb_ouvre_fichier_pj" oncommand="pf_ouvre_panier_pj();"/>
      <hbox flex="1">
        <textbox flex="7" observes="broadcaster_01" id="tb_emplacement"   maxlenght="260"/>
      </hbox>
    </hbox>
    <listbox rows="4" context="graal_cp_li_pj" id="li_pj">
      <listhead >
        <listheader label="$vl_c_bak_134" />
      </listhead>
      <listcols >
        <listcol flex="1"/>
      </listcols>
    </listbox>
  </vbox>
</tabpanel>

    </tabpanels>
  </tabbox>

</hbox>
</groupbox>

          <hbox flex="1">
          <label value="$vl_c_bak_110"/>
          <textbox flex="1" id="tb_sujet"   tabindex="3"/>
          </hbox>
$vl_modeles
        </vbox>
        <deck id="dk_01" selectedIndex="0" flex="1">
        <_graal_deck value="Deck n° 1 du message">
END;
switch ($vl_c_type_courriel) {
  case "texte":
    echo('<textbox id="tb_message" multiline="true" wrap="off" flex="1" value="" tabindex="4"/>');
    break;
  case "html":
    include("js/_graal_editeur_wysiwyg.js.php");
    echo('<vbox flex="1">');
    include("_graal_inc_baroutils_01.php");
    include("_graal_inc_baroutils_02.php");
    echo('<deck id="workarea" flex="1">');
		echo('<html:iframe onload="event.stopPropagation();" id="content" flex="2" src="'.$vl_c_message_html_b64.'" />');
		echo('<textbox multiline="true" id="tb_source"/>');
    echo('</deck>');
    echo('</vbox>');
    break;
}
echo <<<END
          </_graal_deck>
          <_graal_deck value="Deck n° 2 pour erreur">
            <vbox flex="1">
              <textbox id="tb_cr" multiline="true" wrap="on" flex="1" value="$vl_c_formulaire"  />
              <button label="$vl_c_bak_115"  oncommand="fa_gid('dk_01').selectedIndex=0;" />
            </vbox>
          </_graal_deck>
          <_graal_deck value="Deck n° 3 RAF invisible">
            <vbox flex="1">
              <html:iframe onload="event.stopPropagation();" id="faux_content" src="$vl_c_message_text_b64_brut" />
              <html:iframe onload="event.stopPropagation();" id="faux_entete" src="$vl_c_message_head_b64_brut" />
            </vbox>
          </_graal_deck>

        </deck>
        <vbox><hbox>
      <deck id="dk_02" selectedIndex="0" flex="1">
        <_graal_deck value="Deck boutons de validation">
          <button flex="1" id="bt_raf" label="$vl_c_bak_155" crop="end" dir="normal" oncommand="pf_raf();" tabindex="5"/>
          $vl_bouton_envoi
          <button width='40' flex='1' id='bt_enregistrer' label='$vl_c_bak_157' crop='end' dir='normal' oncommand='pf_validation("brouillon")' tabindex='5'/>
          <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
					<button width="40" flex="1" id="bt_raz" label="$vl_c_dico_00129" crop="end" dir="normal" oncommand="pf_etat_fen('annuler');" />
        </_graal_deck>
        <_graal_deck value="Deck boutons retour validation">
          <button width="40" flex="1" id="bt_validation_ok" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="fa_gid('dk_02').selectedIndex=0" />
        </_graal_deck>
      </deck>
   </hbox></vbox>
   </vbox>

    </hbox>
  </tabpanel>
<!--  Début Complément-->
  	<tabpanel id="tabpanel_complement" >
      <vbox flex="0">
        <hbox flex="0">
          <hbox>
            <groupbox>
              <caption><label value="$vl_c_bak_117" /></caption>
              <radiogroup id='rdg_unpardestinataire' >
                <radio id='ra_unpardestinataire_oui' label="$vl_c_dico_00013" value='1' dir="reverse"/>
                <radio id='ra_unpardestinataire_non' label="$vl_c_dico_00014" value='2' />
               </radiogroup>
            </groupbox>
            <groupbox>
              <caption><label value="$vl_c_bak_118" /></caption>
              <radiogroup id='rdg_uneactionpardestinataire' >
                <radio id='ra_uneactionpardestinataire_oui' label="$vl_c_dico_00013" value='1' dir="reverse"/>
                <radio id='ra_uneactionpardestinataire_non' label="$vl_c_dico_00014" value='2' />
               </radiogroup>
            </groupbox>
          </hbox>
        </hbox>

        <hbox flex="0">
          <hbox>
            <groupbox>
              <caption><label value="$vl_c_bak_119" /></caption>
              <radiogroup id='rdg_priorite' >
                <radio id='ra_priorite_0' label="$vl_c_bak_130" value='0' dir="reverse"/>
                <radio id='ra_priorite_1' label="$vl_c_bak_121" value='1' />
                <radio id='ra_priorite_2' label="$vl_c_bak_122" value='2' />
                <radio id='ra_priorite_3' label="$vl_c_bak_123" value='3' />
                <radio id='ra_priorite_4' label="$vl_c_bak_124" value='4' />
                <radio id='ra_priorite_5' label="$vl_c_bak_125" value='5' />
               </radiogroup>
            </groupbox>
            <groupbox>
              <caption><label value="$vl_c_bak_120" /></caption>
              <radiogroup id='rdg_sensitivite' >
                <radio id='ra_sensitivite_0' label="$vl_c_bak_131" value='0' dir="reverse"/>
                <radio id='ra_sensitivite_1' label="$vl_c_bak_126" value='1' />
                <radio id='ra_sensitivite_2' label="$vl_c_bak_127" value='2' />
                <radio id='ra_sensitivite_2' label="$vl_c_bak_128" value='2' />
                <radio id='ra_sensitivite_2' label="$vl_c_bak_129" value='2' />
               </radiogroup>
            </groupbox>
            <groupbox>
              <caption><label value="$vl_c_bak_140" /></caption>
              <radiogroup id='rdg_integre_pj_sipossible' >
                <radio id='ra_integre_pj_sipossible_1' label="$vl_c_dico_00013" value='1' />
                <radio id='ra_integre_pj_sipossible_2' label="$vl_c_dico_00014" value='2' dir="reverse"/>
               </radiogroup>
            </groupbox>

          </hbox>
        </hbox>
        <hbox flex="0">
          <hbox>
            <groupbox>
              <caption><label value="$vl_c_bak_142" /></caption>
              <radiogroup id='rdg_confirmation_lecture' >
                <radio id='ra_confirmation_lecture_1' label="$vl_c_dico_00013" value='1' />
                <radio id='ra_confirmation_lecture_2' label="$vl_c_dico_00014" value='2' dir="reverse"/>
               </radiogroup>
            </groupbox>

          </hbox>
        </hbox>

      </vbox>
      <vbox flex="1">
      </vbox>
		</tabpanel>
<!--  Fin Onglet compléments -->
    </tabpanels>
  </tabbox>
 </window>
END;
?>
