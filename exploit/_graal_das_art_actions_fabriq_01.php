<?php
include("_graal_header_xml.inc.php");
$vl_e_art_cleunik=intval(fa_recup_param('vl_art_cleunik','10281'));
$vl_c_quelleplage=fa_recup_param('vl_c_quelleplage','debut');
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','20000101');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','20610123');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$nb_dec_qte=0;
$nb_dec_pu=2;
// execution de la requÃ¨te SQL
$sql_req="select f3.code as code,f2.reference as reference,f2.sujet as sujet,f2.action_cleunik as action_cleunik,"._graalsql_date('f2.dateheuredebut')." as datedebut,"._graalsql_time('f2.dateheuredebut')." as heuredebut,f2.dateheuredebut as dateheuredebut,"._graalsql_date('f2.dateheurefin')." as datefin,"._graalsql_time('f2.dateheurefin')." as heurefin,f2.dateheurefin as dateheurefin,f1.fab_ligne_cleunik as fab_ligne_cleunik,f1.fab_cleunik as fab_cleunik,f1.qte_lancee as qte_lancee,f1.qte_fabriq as qte_fabriq,f1.pu as pu from _fab_lignes f1 left join _fab_entetes f3 using(fab_cleunik) left join _actions f2 using(action_cleunik) where f1.art_cleunik=$vl_e_art_cleunik";
$sql_req.= " AND ((f2.dateheuredebut between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (f2.dateheurefin between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'))";
switch ($vl_c_quelleplage) { 
  case "debut":$sql_req.=" order by f2.dateheuredebut DESC,f2.dateheurefin DESC";break;
  case "fin":$sql_req.=" order by f2.dateheurefin DESC";break;
} 
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  if ($row['qte_lancee']==0) {$qte_lancee="";} else {$qte_lancee=fa_reel(fa_ent_xml($row['qte_lancee']),$nb_dec_qte);}
  if ($row['qte_fabriq']==0) {$qte_fabriq="";} else {$qte_fabriq=fa_reel(fa_ent_xml($row['qte_fabriq']),$nb_dec_qte);}
  if ($row['pu']==0) {$pu="";} else {$pu=fa_reel(fa_ent_xml($row['pu']),$nb_dec_pu);}
  echo(' code="'.fa_ent_xml($row['code']).'"');
  echo(' reference="'.fa_ent_xml($row['reference']).'"');
  echo(' sujet="'.fa_ent_xml($row['sujet']).'"');
  echo(' action_cleunik="'.fa_ent_xml($row['action_cleunik']).'"');
  echo(' dateheuredebut="'.fa_ent_xml($row['dateheuredebut']).'"');
  echo(' dateheurefin="'.fa_ent_xml($row['dateheurefin']).'"');
  echo(' datedebut="'.fa_ent_xml($row['datedebut']).'"');
  echo(' datefin="'.fa_ent_xml($row['datefin']).'"');
  echo(' heuredebut="'.fa_ent_xml($row['heuredebut']).'"');
  echo(' heurefin="'.fa_ent_xml($row['heurefin']).'"');
  echo(' fab_ligne_cleunik="'.fa_ent_xml($row['fab_ligne_cleunik']).'"');
  echo(' fab_cleunik="'.fa_ent_xml($row['fab_cleunik']).'"');
  echo(' qte_lancee="'.$qte_lancee.'"');
  echo(' qte_fabriq="'.$qte_fabriq.'"');
  echo(' pu="'.$pu.'"');
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
?>
