<?php
include("_graal_header_txt.inc.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
define('EOL', "\r\n");
$vl_c_var=fa_recup_param('var','vs_tempo_panier_cle_recep');
$vl_c_action=fa_recup_param('vl_c_action','0');
$vl_t_listecles=fa_recup_session("$vl_c_var",'');
$sess_id=session_id();
unset($_SESSION["$vl_c_var"]);
$vl_e_i=-1;
foreach($vl_t_listecles as $vl_raf) {
  $vl_e_i++;
  $vl_liste.=$vl_t_listecles[$vl_e_i].',';
}
if ($vl_liste!="") {
  $vl_liste=substr($vl_liste, 0, -1);
}
error_reporting(E_ALL ^ E_WARNING ^ E_NOTICE); //  On désactive temporairement les warnings parce que parfois le iconv_mime_decode renvoie une erreur
// execution de la requète SQL
if ($vl_liste=="" ) {exit;}
$sql_req="select courriel_brut_cleunik,courriel,hash,integre,idpop,sequence from _courriel_recus_brut where courriel_brut_cleunik in ($vl_liste)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  switch ($vl_c_action) {
    case "0":
      break;
    case "1":   // remplacement des CR "orphelins" par CRFL
      $definition_00=str_replace("\r\n", "\r", $row['courriel']);
      $definition_01=str_replace("\r", "\r\n", $definition_00);
      $mime=new mime_parser_class;
      $mime->mbox = 0;
      $mime->decode_bodies=1;
      $mime->ignore_syntax_errors = 1;
      //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
      $path="mail/".$sess_id."_".$row['hash'];
      $handle_file=fopen($path, 'wb');
      fwrite($handle_file, $definition_01);
      fclose($handle_file);
      $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$row['hash'],'sess_id'=>$sess_id,);
      //$parameters=array('Data'=>$definition_01);
      $definition="";
      $vl_c_erreur="";
      if(!$mime->Decode($parameters, $decoded)) {
    		$vl_c_erreur='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position.EOL;
    		echo $vl_c_erreur.EOL;
    	} else {
    	 	echo "OK !!!".EOL;
    	 	// Attention bien conserver le hzsh initial pour ne pas se récupérer une nouvelle fois la daube !!
        $sql_req_01 = "update _courriel_recus_brut set integre=2,courriel='".addslashes($definition_01)."' WHERE courriel_brut_cleunik =".$row['courriel_brut_cleunik'];
        $vf_c_echo=_graal_exec_requete($sql_req_01);
      }
      break;
  }
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
