<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
require("_graal_fonctions_mail.php");
include("_graal_var_portee.php");
include("_graal_fonctions_documents.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
define('EOL', "\r\n");
$sess_id=session_id();
$vl_c_id_fenetre="Div_00492";//Réception des courriels
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_boe_001=fa_recup_dico("boe_001");
$vl_c_boe_002=fa_recup_dico("boe_002");
$vl_c_boe_003=fa_recup_dico("boe_003");
$vl_c_boe_004=fa_recup_dico("boe_004");
$vl_c_boe_005=fa_recup_dico("boe_005");
$vl_c_boe_006=fa_recup_dico("boe_006");
$vl_c_boe_007=fa_recup_dico("boe_007");
$vl_prop_retour_pasbon="ad19";
$vl_prop_retour_lu="ag06";
$vl_prop_vocal="xx06";
$vl_prop_fax="al03";
$vl_prop_fax_ar_emis="al07";
$vl_courriel_brut_cleunik=intval(fa_recup_param('vl_courriel_brut_cleunik','0'));
$vl_action_cleunik=intval(fa_recup_param('vl_action_cleunik','0'));
$vl_courriel_re_mes_cleunik=intval(fa_recup_param('vl_courriel_re_mes_cleunik','0'));
$vl_tb_reg_00008=_graal_requete_regle("Reg_00008"); //  Relier automatiquement les pièces jointes reçues aux interlocuteurs émetteurs
$vl_tb_reg_00009=_graal_requete_regle("Reg_00009"); //  Relier automatiquement les pièces jointes reçues aux acteurs émetteurs
$vl_affiche_html=intval(fa_recup_param('vl_affiche_html','2'));
$param_generaux_graal_102=intval(fa_recup_session('vs_param_generaux_graal_102',2));//	enregistrement des pj sur courriels d'erreurs
$vl_affiche_html=1; // pour éviter la perte du https !!!!!

$vl_genre=fa_recup_param('vl_genre','xul');
switch ($vl_genre) {
  case "xul":
  case "html":
	case "maj_corps_texte_action":
	case "voir_corps_texte_action":
    $vl_liste=$vl_courriel_brut_cleunik;
    break;
  case "action":
    $vl_c_var=fa_recup_param('var','vs_tempo_panier_cle_courriels_action');
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$vl_c_var"]);
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $vl_liste.=$vl_t_listecles[$vl_e_i].',';
    }
    if ($vl_liste!="") {$vl_liste=substr($vl_liste, 0, -1);}
    $vf_c_echo="Courriel(s) enregistré(s) ";

}
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
if ($vl_liste=="") {exit;}
$sql_req_00="select courriel,hash,courriel_brut_cleunik from _courriel_recus_brut where courriel_brut_cleunik in($vl_liste) order by courriel_brut_cleunik asc;";
$result_00 = _graal_requete_bd($sql_req_00);
$vf_e_nb_ar=0;
$vf_e_cleunik_ar="";
while ($row = mysql_fetch_assoc($result_00)) {
  $mime=new mime_parser_class;
  $mime->mbox = 0;
  $mime->decode_bodies = 1;
  $mime->ignore_syntax_errors = 1;
  $courriel=$row['courriel'];
  $cbc=$row['courriel_brut_cleunik'];
  //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
  $path="mail/".$sess_id."_".$row['hash'];
  $handle_file=fopen($path, 'wb');
  fwrite($handle_file, $row['courriel']);
  fclose($handle_file);
  $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$row['hash'],'sess_id'=>$sess_id,);
  //$parameters=array('Data'=>$row['courriel'],'SaveBody'=>'mail','Hash'=>$row['hash'],);
  $vl_c_erreur="";
  $treeitem="";
  $base_html="";
  $vl_c_z25="";
  $vl_e_nb_pieces_jointes=0;$vl_e_nb_pieces_integrees=0;
  if(!$mime->Decode($parameters, $decoded)) {
  	$vl_c_erreur='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position.EOL;
  }
  else {
    $nb_parties=count($decoded[0]['Parts']);
    $vl_type_content=explode(';',$decoded[0]['Headers']['content-type:']);

/*
    $vl_charset=$vl_type_content[1];
    $vl_char=explode('"',$vl_charset);
    $vl_charron=trim($vl_char[1]);
*/

    $vl_charset=$vl_type_content[1];
    $vl_char=explode('charset=',$vl_charset);
    if(trim($vl_char[1]=="")) {
      $vl_charset=$vl_type_content[1];
      $vl_char=explode('"',$vl_charset);
    }
    $vl_charron=trim($vl_char[1]);

    if (strncasecmp($vl_charron , "--------" ,8)==0) {$vl_charron="";};


    $vl_charron=str_replace("'","",$vl_charron);
    $vl_charron=str_replace('"',"",$vl_charron);
    if ($vl_charron=="") {$vl_charron=trim($decoded[0]["DecodedHeaders"][0][0][0]["Encoding"]);}
    if (trim($vl_charron)=="") {$vl_charron="utf-8";}
    /*
		 /*
		 * On recherche si on est en présence d'un message vocal, d'un fax
		 * au 7 mars 2009, gestion des messages vocaux en provenance d'OVH
		 * au 8 mars 2009, gestion des fax en provenance d'OVH
		 * au 15 août 2009, gestion des fax en provenance de la machine fax RICOH Baronnat
		 * au 29 décembre 2009, gestion des messages vocaux en provenance de keyyo
		 */
		$vl_c_special="";
		//Recherche message vocal OVH
		if ($decoded[0]["Headers"]["x-ovh-from:"]!=null) {
			$vl_c_special="1";
		}
		// Recherche Fax OVH
		if ($decoded[0]["Headers"]["x-ovh-fax-from:"]!=null) {
			$vl_c_special="2";
		}
		// Recherche Fax en provenance de la machine fax RICOH Baronnat (plus opérationnel depuis le 1° septembre 2010)
		$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
		$vl_e_trouve_fax=preg_match("/Fax Message NO./i", $vl_chaine_sujet_fax);
		if ($vl_e_trouve_fax==true){
			$vl_c_special="2";
		}
		//	Recherche message vocal keyyo
		if ($decoded[0]["Headers"]["return-path:"]=="<voicemail@keyyo.fr>") {
			$vl_c_special="3";
		}
  		if ($decoded[0]["Headers"]["return-path:"]=="<fax2mail@keyyo.fr>") {
			$vl_c_special="2";
		}
		//	Recherche accusé de réception emission de fax via keyyo
	 	if ($decoded[0]["Headers"]["return-path:"]=="<keyyofax@keyyo.fr>") {
			$vl_c_special="4";
		}
	  //Recherche Fax en provenance du télécopieur Baronnat (depuis le 1° septembre 2010)
		if ($decoded[0]["Headers"]["x-mailer:"]=="Network Scanner System") {
			$vl_c_special="2";
		}
		switch ($nb_parties) {
      case 0:
        if ($decoded[0]['body']!=null) {
          $vl_c_body=$decoded[0]['Body'];
          //echo "Pas null";
        } else {
          //echo "Null";
          $vl_c_body=file_get_contents($decoded[0]['BodyFile']);
        }
        switch ($vl_type_content[0]) {
          case "text/plain":
            $deb_texte="data:".$vl_type_content[0].";charset=".$vl_charron.";base64,";
            $base_texte=$vl_c_body;
            break;
          case "text/html":
            $deb_texte="data:text/plain;base64,";
            $base_texte="Impossible de visualiser le courriel autrement qu'en texte !!!!".EOL."Pas normal !!!".EOL;
            $deb_html="data:".$decoded[0]['Headers']['content-type:'].";base64,";
            $base_html=$vl_c_body;
            break;
          default:
            $deb_texte="data:text/plain;base64,"; // !!!!
            $base_texte=$vl_c_body;
            break;

        }
        break;
      default:
        $index = 0;
        $t_pj=array();$t_pj_nom=array();$t_pj_mime=array();
        $t_id=array();$t_da=array();$vl_t_image_hash=array();$vl_t_image_mime=array();$vl_t_image_data=array();$t_image_pref=array();
        $result = fa_arrayFromEmailParts($decoded[0]['Parts'],$index);
        $nb_parties=count($result);
				$base_texte="";
				$vl_c_frame_voc="";
				$info_special="";
        for($vl_part = 0; $vl_part < $nb_parties; $vl_part++) {
          $vl_coid=$result[$vl_part]['coid'];
          $vl_special=$result[$vl_part]['special'];
          if ($result[$vl_part]['content']!=null) {
            $vl_char=explode('=',$result[$vl_part]['char']);$vl_charron=" ".$vl_char[1];
            switch ($result[$vl_part]['type']) {
              case "text/plain":
                $deb_texte="data:".trim($result[$vl_part]['type']).";".trim($result[$vl_part]['char']).";base64,";
								//	on a vu des courriels avec plusieurs parties texte !!
                $base_texte.=$result[$vl_part]['content'];
                if ($vl_charron=="") {$vl_char=explode('=',$result[$vl_part]['char']);$vl_charron=trim($vl_char[1]);}
                break;
              case "text/html":
                $deb_html="data:".trim($result[$vl_part]['type']).";".trim($result[$vl_part]['char']).";base64,";
                $base_html=$result[$vl_part]['content'];
                if ($vl_charron=="") {$vl_char=explode('=',$result[$vl_part]['char']);$vl_charron=trim($vl_char[1]);}
                break;
              case "application/pdf":
								//$info_special.="incorporé ??";
								break;
							default:
                $deb_texte="data:text/plain;base64,";
                $base_texte=$result[$vl_part]['content'];
                break;
            }
          } else {
            //  On teste d'abord si c'est un fichier incorporé.
            if ($vl_coid != null) {
              $vl_e_nb_pieces_integrees++;
              $t_id[$vl_e_nb_pieces_integrees]="cid:".$vl_coid;
              $t_da[$vl_e_nb_pieces_integrees]="data:".trim($result[$vl_part]['type']).";base64,".$result[$vl_part]['inco'];
              $t_image_mime[$vl_e_nb_pieces_integrees]=trim($result[$vl_part]['type']);
              $t_image_data[$vl_e_nb_pieces_integrees]=$result[$vl_part]['inco'];
              $t_image_pref[$vl_e_nb_pieces_integrees]="data:".trim($result[$vl_part]['type']).";base64,";
            } else {
              if ($vl_special!=null) {
                switch ($vl_special) {
                  case "message/disposition-notification":if ($vl_c_z25!=$vl_prop_retour_pasbon) {$vl_c_z25=$vl_prop_retour_lu;}break;
                  case "message/delivery-status":$vl_c_z25=$vl_prop_retour_pasbon;break;
                  case "message/rfc822":$vl_c_z25=$vl_prop_retour_pasbon;break;
                  case "text/rfc822-headers":if ($vl_c_z25!=$vl_prop_retour_pasbon) {$vl_c_z25=$vl_prop_retour_lu;}break;
                }
             } else {
                $vl_e_nb_pieces_jointes++;
                $t_pj[$vl_e_nb_pieces_jointes]=$result[$vl_part]['file'];
                $t_pj_nom[$vl_e_nb_pieces_jointes]=utf8_encode($result[$vl_part]['originalFileName']);
                $t_pj_mime[$vl_e_nb_pieces_jointes]=$result[$vl_part]['type'];
                $treeitem.="<treeitem><treerow><treecell label='".fa_remplace_quotes(fa_ent_xml($result[$vl_part]['originalFileName']))."' /><treecell label='$vl_part' /><treecell label='".int2taille($result[$vl_part]['taille'])."' /></treerow></treeitem>";

								switch ($vl_c_special){
									case "1":	//	répondeur OVH ou plus généralement fichier MP3
										$vl_c_z25=$vl_prop_vocal;
										$url_absolue=ff_url_absolue("oui");
										$path=$url_absolue.$t_pj[$vl_e_nb_pieces_jointes];
										$lecteur=$url_absolue."dewplayer.swf?son=$path";
								$vl_c_recvoc=<<<EOT
		<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Message téléphonique</title>
	</head>
	<body>
	<p align="justify">
	Ecouter
<object type="application/x-shockwave-flash"
data="$lecteur"
width="200" height="20"> <param name="movie" value="$lecteur" pluginspage='http://www.macromedia.com/go/getflashplayer'/>
</object>
</p>
	</body>
</html>
EOT;
$vl_c_recvoc="data:text/html;charset=utf-8;base64,".base64_encode($vl_c_recvoc);
$vl_c_frame_voc="<iframe flex='10' id='ifram_recvoc' src='$vl_c_recvoc' />";
										break;
									case "4":	//accusé de réception de fax émis
										$vl_c_z25=$vl_prop_fax_ar_emis;
										// Fax OVH ou keyyo
										if ($t_pj_mime[$vl_e_nb_pieces_jointes]=="application/pdf"){
											$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_05.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]' />";
										}
										// Fax Ricoh Baronnat
										if ($t_pj_mime[$vl_e_nb_pieces_jointes]=="image/tiff"){

$vl_c_rotation=<<<EOT
			<hbox >
			<spacer flex="1"/>
			<button label="Retourner à 90°" class="" tooltiptext="Retourner à 90°" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=90&#38;');"/>
			<button label="Retourner à 180°" class="" tooltiptext="Retourner à 180°" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=180&#38;');"/>
			<button label="Retourner à -90°" class="" tooltiptext="Retourner à -90°" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=-90&#38;');"/>
			<button label="Remettre à l'initial" class="" tooltiptext="Remettre à l'initial" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=0&#38;');"/>
			<spacer flex="1"/>
			</hbox>
EOT;
											$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=0&#38;' />";
										}
										break;
									case "2":	//fax recu
										$vl_c_z25=$vl_prop_fax;
										// Fax OVH ou keyyov ou nouveau baronnat
										if ($t_pj_mime[$vl_e_nb_pieces_jointes]=="application/pdf"){
											$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_05.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]' />";
										}
										// Fax Ricoh Baronnat
										if ($t_pj_mime[$vl_e_nb_pieces_jointes]=="image/tiff"){

$vl_c_rotation=<<<EOT
			<hbox >
			<spacer flex="1"/>
			<button label="Retourner à 90°" class="" tooltiptext="Retourner à 90°" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=90&#38;');"/>
			<button label="Retourner à 180°" class="" tooltiptext="Retourner à 180°" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=180&#38;');"/>
			<button label="Retourner à -90°" class="" tooltiptext="Retourner à -90°" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=-90&#38;');"/>
			<button label="Remettre à l'initial" class="" tooltiptext="Remettre à l'initial" oncommand="fa_att_set('ifram_recvoc','src','_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=0&#38;');"/>
			<spacer flex="1"/>
			</hbox>
EOT;
											$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_06.php?vl_c_fichier=$t_pj[$vl_e_nb_pieces_jointes]&#38;vl_e_angle_rotation=0&#38;' />";
										}
										break;
									case "3":	//répondeur keyyo ou plus généralement fichier wav que l'on convertira en mp3 ou en ogg selon le serveur qui le supportera
										$vl_c_z25=$vl_prop_vocal;
										$url_absolue=ff_url_absolue("non");
										$path=$url_absolue.$t_pj[$vl_e_nb_pieces_jointes];
										$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_08.php?vl_c_fichier=$path' />";
										break;
									default:
										break;
								}
             }
            }
          }
        }
        break;
    }
    $ancienne_base_html=$base_html;
    switch ($vl_e_nb_pieces_integrees) {
      case 0:break;
      case 1:
      default:
        $base_html=str_replace($t_id,$t_da,$base_html);
        break;
    }

    if ($base_html=="") {
      $base_html=$base_texte;
      $deb_html=$deb_texte;
      $vl_b_cache_html="true";
      $vl_b_select_html="false";
      $vl_b_select_text="true";
    }
    else {
      $vl_b_cache_html="false";
      $vl_b_select_html="true";
      $vl_b_select_text="false";
    }
    $b64_html=$deb_html.base64_encode($base_html);

    $b64_html_sans_images=preg_replace('#<img (.+?)>#i', '', $base_html);
    $b64_html_sans_images=$deb_html.base64_encode($b64_html_sans_images);
    $b64_html=fa_remplace_quotes(fa_ent_xml($b64_html));
    $b64_text=$deb_texte.base64_encode($base_texte);
    $b64_text=fa_remplace_quotes(fa_ent_xml($b64_text));
    ob_start();
    var_dump($decoded[0]["Headers"]);
    $a=ob_get_contents();
    ob_end_clean();
    if ($deb_texte=="") {
      $deb_texte="data:text/plain;base64,";
    }
    $b64_ente=$deb_texte.base64_encode($a);
    $b64_ente=fa_remplace_quotes(fa_ent_xml($b64_ente));
    if ($vl_affiche_html==2) {
//      $b64_html="";
      $vl_c_oncommand="pf_sel_html()";
    } else {
      $vl_c_oncommand="";
    }

  }
  switch ($vl_genre) {
  	case "voir_corps_texte_action":
			echo $b64_text;
			break;
  	case "maj_corps_texte_action":
      $sql_req_01 = "UPDATE _courriel_re_mes set message_text='$b64_text' where courriel_re_mes_cleunik=$vl_courriel_re_mes_cleunik;";
    	_graal_exec_requete($sql_req_01);
			echo "ok";
			break;
		case "xul":
header('Content-type: application/vnd.mozilla.xul+xml');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
$vl_charron=str_replace("'","",$vl_charron);
$vl_charron=str_replace('"',"",$vl_charron);
$vl_charron=trim($vl_charron);
$old_vl_charron=$vl_charron;
//  Traitement des cas particuliers
switch (trim(strtolower($vl_charron))) {
  case "":
  case "windows-1250":
    $vl_charron="utf-8";
    break;
}
$vl_c_sujet="";
if (trim($vl_charron)=="") {
  $vl_c_sujet=$decoded[0]["Headers"]["subject:"];
  $vl_c_sujet=fa_ent_xml($vl_c_sujet);
} else {
  if (trim($decoded[0]["Headers"]["subject:"])!="") {
    $vl_encodage=mb_detect_encoding($decoded[0]["Headers"]["subject:"]);
    if (strtolower($vl_encodage)!="utf-8") {
      $vl_c_sujet=iconv_mime_decode($decoded[0]["Headers"]["subject:"],2, $vl_charron); //  Valeur 2 -> continue à essayer de décode même s'il y a des erreurs ...
    } else {
      $vl_c_sujet=$decoded[0]["Headers"]["subject:"];
    }
    $vl_c_sujet=fa_ent_xml($vl_c_sujet);
  }/*
  if (substr($decoded[0]["Headers"]["subject:"], 0, 2)=="=?") {
    $vl_c_sujet=iconv_mime_decode($decoded[0]["Headers"]["subject:"],0, $vl_charron);
  } else {
    $vl_c_sujet=utf8_encode($decoded[0]["Headers"]["subject:"]);
  }
  */
}
if (strtolower($vl_charron)!="utf-8") {
  $vl_c_boe_001=utf8_decode($vl_c_boe_001);
  $vl_c_boe_002=utf8_decode($vl_c_boe_002);
  $vl_c_boe_003=utf8_decode($vl_c_boe_003);
  $vl_c_boe_004=utf8_decode($vl_c_boe_004);
  $vl_c_boe_005=utf8_decode($vl_c_boe_005);
  $vl_c_boe_006=utf8_decode($vl_c_boe_006);
  $vl_c_boe_007=utf8_decode($vl_c_boe_007);
}
if ($vl_e_nb_pieces_jointes!=0){ $vl_c_tab_pj="<tab id='tab_mail_pj' linkedpanel='tabpanel_mail_pj' label='$vl_c_boe_005' />";}
echo '<?xml version="1.0" encoding="'.$vl_charron.'"?>';
echo '<?xml-stylesheet href="chrome://global/skin/" type="text/css"?>';
echo '<?xml-stylesheet href="css/_new_graal.css.php" type="text/css"?>';
echo('<window class="transparent" id="_graal_xul_courriel_01" '.$c_xmlns.'>');
include_once("js/_graal_01.js.php");
include("js/_graal_xul_courriel_01.js.php");
echo <<<END
<vbox id="courriel_01" class="overflow_01" flex="1">
<caption><hbox><label value="$vl_c_boe_001" class='gras'/><label value="$vl_c_sujet" class='gras vert' /></hbox></caption>
  <tabbox id="tabbox_01" flex="1" orient="vertical" class="overflow_01">
    <tabs>
       <tab id="tab_mail_text" linkedpanel="tabpanel_mail_text" label="$vl_c_boe_002" selected="$vl_b_select_text"/>
       <tab id="tab_mail_html" class="ad13" linkedpanel="tabpanel_mail_html" label="$vl_c_boe_004 (sans images externes)" collapsed="$vl_b_cache_html" selected="$vl_b_select_html" oncommand="$vl_c_oncommand"/>
       <tab id="tab_mail_html" class="ae06" linkedpanel="tabpanel_mail_html_avec_images" label="$vl_c_boe_004 (avec images externes ... Attention ...)" collapsed="$vl_b_cache_html" selected="$vl_b_select_html" new_oncommand="alert('tutu');" oncommand="fa_att_set('mail_html_avec_images','src','$b64_html');"/>
       $vl_c_tab_pj
       <tab id="tab_mail_ente" linkedpanel="tabpanel_mail_ente" label="$vl_c_boe_003"/>
    </tabs>
    <tabpanels flex="1">
  		<tabpanel id="tabpanel_mail_text" flex="1">
        <vbox flex="1">
				<iframe flex="1" src="$b64_text" />
				$vl_c_rotation
				$vl_c_frame_voc
				</vbox>
      </tabpanel>

  		<tabpanel id="tabpanel_mail_html" flex="1" collapsed="$vl_b_cache_html">
END;
if ($vl_affiche_html==2) {
  echo ("<iframe flex='10' id='mail_html' src='_graal_page_blanche_01.php' />'");
} else {
  echo ("<iframe flex='10' id='mail_html' src='$b64_html_sans_images' />");
}
echo("</tabpanel>");
echo('<tabpanel id="tabpanel_mail_html" flex="1" collapsed="$vl_b_cache_html">');
END;
if ($vl_affiche_html==2) {
  echo ("<iframe flex='10' id='mail_html_avec_images' src='_graal_page_blanche_01.php' />'");
} else {
  echo ("<iframe flex='10' id='mail_html_avec_images' src='' />");
}
echo("</tabpanel>");


if ($vl_e_nb_pieces_jointes!=0) {
echo <<<END
  		<tabpanel id="tabpanel_mail_pj" flex="1">
		<popup id="graal_pj"><menuitem label="$vl_c_boe_006" oncommand="pf_voir_pj();"/><menuitem label="$vl_c_boe_007" oncommand="pf_sel_pj();"/></popup>
        <tree id="t_arbredespj" flex="1" hidecolumnpicker="true" seltype="single" context="graal_pj" >
      <treecols>
	     <treecol id="td_nomfichier"  flex="10" hideheader="true"/>
	     <treecol id="td_numerofichier"  flex="1" hidden="true" hideheader="true"/>
	     <treecol id="td_taille"  flex="1" hideheader="true"/>
      </treecols>
      <treechildren>
        $treeitem
      </treechildren>
    </tree>
      </tabpanel>
END;
}
echo <<<END
    <tabpanel id="tabpanel_mail_ente" flex="1">
        <iframe flex="10" src="$b64_ente" />
    </tabpanel>
    </tabpanels>
  </tabbox>
</vbox>
</window>
END;
    exit;
    break;
  case "html":
    echo $b64_html;
    exit;
    break;
  case "action":
    $datas_vrac="";
    $datas_vrac_pj="";
    $datas_vrac_images="";
    $vl_c_z08="";
    $vl_c_idmes=addslashes($decoded[0]["Headers"]["message-id:"]);
		$vl_c_z02=addslashes(fa_sujet($decoded));	//tentative de standardisation de décodage du sujet le 4/4/2009
    /*
		if (substr($decoded[0]["Headers"]["subject:"], 0, 2)=="=?") {
      $vl_c_z02=addslashes(iconv_mime_decode($decoded[0]["Headers"]["subject:"],0, "UTF-8"));
    } else {
      $vl_c_z02=addslashes(utf8_encode($decoded[0]["Headers"]["subject:"]));
    }
    */
    $vl_c_z03=$decoded[0]["Headers"]["return-path:"];
    $vl_b_z03=is_array($vl_c_z03);
    if ($vl_b_z03) {
      $vl_c_z03_temp="";
      for($vl_part = 0; $vl_part < count($vl_c_z03); $vl_part++) {
        $vl_c_z03_temp.=$vl_c_z03[$vl_part].";";
      }
      $vl_c_z03=$vl_c_z03_temp;
    }
		$vl_c_z04=$decoded[0]["Headers"]["date:"];
		$vl_c_z05=iconv_mime_decode($decoded[0]["Headers"]["from:"],0, "UTF-8");
    $vl_c_z06=iconv_mime_decode($decoded[0]["Headers"]["to:"],0, "UTF-8");
		$vl_c_z07=$decoded[0]["Headers"]["message-id:"];
		$vl_c_z07=fa_ent_xml_cabal_01($vl_c_z07);
		$vl_c_z08=$decoded[0]["Headers"]["in-reply-to:"];
    if (($timestamp = strtotime($vl_c_z04)) === false) {
      if (strtolower(substr($vl_c_z04,-2))=="ut") {
        $vl_c_z04=substr($vl_c_z04,0,strlen($vl_c_z04)-2)."UTC";
        if (($timestamp = strtotime($vl_c_z04)) === false) {
          $vl_c_z09="19610123060000";
        } else {
          $vl_c_z09=date('YmdHis', $timestamp);
        }
      }  else {
        $vl_c_z09="now()";
      }
    } else {
      $vl_c_z09=date('YmdHis', $timestamp);
    }
    preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z05 , $regs);
    $vl_c_z10 = addslashes($regs[0]); //  Expéditeur
    $vl_c_zle="";
    if ($decoded[0]["Headers"]["disposition-notification-to:"]!=null) {
      $vl_c_zle=iconv_mime_decode($decoded[0]["Headers"]["disposition-notification-to:"],0, "UTF-8");
    }
    $vl_c_z26="";
    if ($decoded[0]["Headers"]["reply-to:"]!=null) {
      $vl_c_z26=$decoded[0]["Headers"]["reply-to:"];
      preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z26 , $regs);
      $vl_c_z26 = $regs[0]; //  Adresse de réponse
      if ($vl_c_z26==$vl_c_z10) {$vl_c_z26="";}
    }
    if( $decoded[0]["Headers"]["cc:"]!=null) {
      $vl_c_zcc=$decoded[0]["Headers"]["cc:"];
    }
		$vl_c_special="";
		//Recherche message vocal OVH
		if ($decoded[0]["Headers"]["x-ovh-from:"]!=null) {
			$vl_c_z10=$decoded[0]["Headers"]["x-ovh-from:"];
			$vl_c_special="1";
			$vl_c_z26="";
		}
		//	Recherche message vocal keyyo
  		if ($decoded[0]["Headers"]["return-path:"]=="<voicemail@keyyo.fr>") {
			$vl_c_special="3";
			$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
			$vl_chaine_sujet_fax = preg_match_all( '`<(.*)>`Us' , $vl_chaine_sujet_fax, $mots);
			foreach($mots[1] as $val) {
    			$vl_c_z10="0".substr($val,3);
			}
			$vl_c_z26="";
		}
		// Recherche Fax OVH
		if ($decoded[0]["Headers"]["x-ovh-fax-from:"]!=null) {
			$vl_c_z10=$decoded[0]["Headers"]["x-ovh-fax-from:"];
			$vl_c_special="2";
			$vl_c_z26="";
		}
		//Recherche Fax en provenance du télécopieur Baronnat depuis le 1° septembre 2010
		if ($decoded[0]["Headers"]["x-mailer:"]=="Network Scanner System") {
			$vl_c_z10="";
			$vl_c_special="2";
			$vl_c_z26="";
		}

  		if ($decoded[0]["Headers"]["return-path:"]=="<fax2mail@keyyo.fr>") {
			$vl_c_special="2";
			$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
			$position_prem = strlen('Fax en provenance de ');
			$position_dern = strpos($vl_chaine_sujet_fax, ' reçu sur le');
			$longueur=$position_dern-$position_prem;
			$vl_c_z10=trim(substr($vl_chaine_sujet_fax,$position_prem,$longueur));
			$vl_c_z26="";
		}
		//	Recherche accusé de réception emission de fax via keyyo
	 	if ($decoded[0]["Headers"]["return-path:"]=="<keyyofax@keyyo.fr>") {
			$vl_c_special="4";
			$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
			$position_prem = strlen('Fax à destination du ');
			$position_dern = strpos($vl_chaine_sujet_fax, ' correctement envoyé');
			$longueur=$position_dern-$position_prem;
			$vl_c_z10=trim(substr($vl_chaine_sujet_fax,$position_prem,$longueur));
			$vl_c_z26="";
		}
		// Recherche Fax en provenance de la machine fax RICOH Baronnat (avant 1° septembre 2010)
		$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
		$vl_e_trouve_fax=preg_match("/Fax Message NO./i", $vl_chaine_sujet_fax);
		if ($vl_e_trouve_fax==true){
			$vl_c_special="2";
			$vl_e_trouve_exp=preg_match("/From \"/i", $vl_chaine_sujet_fax);
			if ($vl_e_trouve_exp==true){
				$trouve_moi  = '"';
				$pos=0;
				$position_prem = strpos($vl_chaine_sujet_fax, $trouve_moi,$pos);
				$position_dern = strpos($vl_chaine_sujet_fax, $trouve_moi,$position_prem+1);
				$longueur=$position_dern-$position_prem-1;
				$vl_c_z10=trim(substr($vl_chaine_sujet_fax,$position_prem+1,$longueur));
				$vl_c_z26="";
			}
		}
    $vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
    switch ($vl_c_z25) {
      case $vl_prop_retour_pasbon		:$choix_cleunik_action=-110104;$choix_cleunik_graal=-110400;break;
      case $vl_prop_retour_lu			:$choix_cleunik_action=-110120;$choix_cleunik_graal=-110400;break;
      case $vl_prop_vocal				:$choix_cleunik_action=-110125;$choix_cleunik_graal=-110431;break;
	  case $vl_prop_fax					:$choix_cleunik_action=-110126;$choix_cleunik_graal=-110432;break;
	  case $vl_prop_fax_ar_emis			:$choix_cleunik_action=-110128;$choix_cleunik_graal=-110433;break;
	default								:$choix_cleunik_action=-110102;$choix_cleunik_graal=-110400;break;
    }
		/*
		 * plantage si tableau alors que dans _graal_das_courriel_recept cela passe !!!! remplacé le 3/7/2009
		 */
		$a='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
		$b='';
    $sql_req_01 = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=$choix_cleunik_action,dateheurecreation=now(),dateheuredebut=$vl_c_z09,dateheurefin=$vl_c_z09,c_uuid=(select uuid()),action_type=1,sujet='$vl_c_z02';";
    if(_graal_exec_requete($sql_req_01)=='ok') {
    	/*
    	 * on va rattacher les expéditeurs
    	 */
		switch ($vl_c_special) {
	    	case "":
					$sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intweb_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_mail f1,_acteurs f2,_act_interlo f3,_choix f4 where refweb='$vl_c_z10' and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
					break;
				case "1":		//	Message téléphonique répondeur OVH
				case "3":		//	Message téléphonique keyyo
					$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_z10);
		 			$sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intel_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_tel f1,_acteurs f2,_act_interlo f3,_choix f4 where intel_06=$vl_c_chaine_nette and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
					break;
				case "2":		//	Fax ovh, ricoh, keyyo
				case "4":		//	Accusé de réception de fax émis
					$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_z10);
		 			$sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intel_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_fax f1,_acteurs f2,_act_interlo f3,_choix f4 where intel_06=$vl_c_chaine_nette and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
					break;
	    }
      $result_01=_graal_requete_bd($sql_req_01);
      $vl_c_z11="";$vl_nb_trouve=0;$vl_b_actif=0;
      $vl_e_nb_int_rattaches=0;
      $t_int_cleunik_rattachement=array();
      $t_act_cleunik_rattachement=array();
      while ($row_01 = mysql_fetch_assoc($result_01)) {
        $vl_nb_trouve++;
        if ($row_01['actif_acteur']==1) {
          if ($row_01['actif_interlo']==1) {
	          $vl_b_actif++;
            $vl_act_cleunik=$row_01['act_cleunik'];
            $vl_int_cleunik=$row_01['int_cleunik'];
            $sql_req_02="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=$choix_cleunik_graal,portee=$vl_e_interl,principal=2;";
            _graal_exec_requete($sql_req_02);
            $vl_e_nb_int_rattaches++;
            $t_int_cleunik_rattachement[$vl_e_nb_int_rattaches]=$vl_int_cleunik;
            $t_act_cleunik_rattachement[$vl_e_nb_int_rattaches]=$vl_act_cleunik;
          }
        }
      }
      _graal_libere_requete_bd($result_01);
			if ($vl_nb_trouve!=0) {
      	if ($vl_b_actif==0) {
	      	//	On refait la requête, mais sans tester sur les actifs
					$result_01=_graal_requete_bd($sql_req_01);
			    $vl_c_z11="";$vl_nb_trouve=0;$vl_b_actif=0;
			    while ($row_01 = mysql_fetch_assoc($result_01)) {
			    	$vl_nb_trouve++;
	          $vl_b_actif++;
            $vl_act_cleunik=$row_01['act_cleunik'];
            $vl_int_cleunik=$row_01['int_cleunik'];
            $sql_req_02="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=$choix_cleunik_graal,portee=$vl_e_interl,principal=2;";
            _graal_exec_requete($sql_req_02);
            $vl_e_nb_int_rattaches++;
            $t_int_cleunik_rattachement[$vl_e_nb_int_rattaches]=$vl_int_cleunik;
            $t_act_cleunik_rattachement[$vl_e_nb_int_rattaches]=$vl_act_cleunik;
	        }
				}
			}

	preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z06 , $regs);
    $vl_c_adresse_destinataire = $regs[0]; //  Adresse de destinataires
	$sql_req_01="SELECT int_cleunik as int_cleunik,act_cleunik as act_cleunik FROM _act_interlo_mail where refweb='$vl_c_adresse_destinataire';";
	$result_01=_graal_requete_bd($sql_req_01);
	while ($row_01 = mysql_fetch_assoc($result_01)) {
        $vl_act_cleunik=$row_01['act_cleunik'];
        $vl_int_cleunik=$row_01['int_cleunik'];
        $sql_req_02="INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110401,portee=$vl_e_interl,principal=1;";
        _graal_exec_requete($sql_req_02);
    }
      //  Récupération des images intégrées
      $datas_vrac_image='<nom_images_integrees_nombre data="'.$vl_e_nb_pieces_integrees.'"/>';
      if($vl_e_nb_pieces_integrees!=0) {
        for($i = 1; $i < $vl_e_nb_pieces_integrees+1; $i++) {
          $ctx = hash_init('sha1');
          hash_update($ctx, $t_image_data[$i]);
          $vl_t_image_hash[$i]=hash_final($ctx);
          $sql_req="SELECT hash FROM _courriel_images where hash='$vl_t_image_hash[$i]';";
          $result=_graal_requete_bd($sql_req);
          if($ligne=mysql_fetch_row($result)) {
          } else {
            $sql_req="INSERT INTO _courriel_images set hash='$vl_t_image_hash[$i]',image='$t_image_data[$i]',mime='".addslashes($t_image_mime[$i])."';";
            _graal_exec_requete($sql_req);
          }
          $datas_vrac_image.='<nom_images_integrees data="'.fa_ent_xml($vl_t_image_hash[$i]).'"/>';
          //$datas_vrac_image.='<nom_images_id data="'.fa_ent_xml($t_id[$i]).'"/>';
          //$datas_vrac_image.='<nom_images_pref data="'.fa_ent_xml($t_image_pref[$i]).'"/>';
        }
        $ancienne_base_html=str_replace($t_id,$vl_t_image_hash,$ancienne_base_html);
      }
      $b64_html=$deb_html.base64_encode($ancienne_base_html);
      $b64_html=fa_remplace_quotes(fa_ent_xml($b64_html));
      //  Recherche du message dans la base
      $ctx = hash_init('sha1');
      hash_update($ctx, "$b64_text$ancienne_base_html");
      $hash=hash_final($ctx);
      $sql_req_01="SELECT courriel_re_mes_cleunik as cleunik FROM _courriel_re_mes where hash='$hash';";
      $result_01=_graal_requete_bd($sql_req_01);
      if($ligne=mysql_fetch_row($result_01)) {
        $vl_courriel_re_mes_cleunik=$ligne[0];
      } else {
        $vl_courriel_re_mes_cleunik=_graal_requete_max("courriel_re_mes_cleunik","_courriel_re_mes");
        $sql_req_02="INSERT INTO _courriel_re_mes set courriel_re_mes_cleunik=$vl_courriel_re_mes_cleunik,hash='$hash',message_html='$b64_html',message_text='$b64_text';";
        _graal_exec_requete($sql_req_02);
      }
      _graal_libere_requete_bd($result_01);
      //  Récupération des pièces jointes
      if ($choix_cleunik_action==-110104 && $param_generaux_graal_102==2) {
      	$vl_e_nb_pieces_jointes=0;	// règle de gestion : pas d'enregistrement des pj pour les messages d'erreurs
      }
      $datas_vrac_pj='<pj_nombre data="'.$vl_e_nb_pieces_jointes.'"/>';
      if ($vl_e_nb_pieces_jointes!=0) {
        for($i = 1; $i < $vl_e_nb_pieces_jointes+1; $i++) {
          $ctx = hash_init('sha1');
          hash_update($ctx, file_get_contents($t_pj[$i]));
          $vl_hash=hash_final($ctx);
          $sql_req="SELECT doc_cleunik from _documents where hash='$vl_hash';";
          $result=_graal_requete_bd($sql_req);
          $datas_vrac_pj.='<nom_pj data="'.fa_remplace_quotes(fa_ent_xml($t_pj_nom[$i])).'"/>';
          if($ligne=mysql_fetch_row($result)) {
            $doc_cleunik=$ligne[0];
          } else {
            $vl_nom=addslashes($t_pj_nom[$i]);
            $vl_pj=addslashes(file_get_contents($t_pj[$i]));
            $vl_mime=addslashes($pj_mime[$i]);
			$size=filesize($t_pj[$i]);
            $doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
			$vf_c_retour=fa_insere_document($doc_cleunik,$vl_nom,"13",$size,$t_pj[$i],"","","","","","","");
          }
          $datas_vrac_pj.='<cleunik_pj data="'.fa_ent_xml($doc_cleunik).'"/>';
          $sql_req_02 = "INSERT INTO _documents_rattachement set doc_cleunik=$doc_cleunik,rat_cleunik=$vl_action_cleunik,portee=$vl_e_piejoi;";
          _graal_exec_requete($sql_req_02);
          //  Rattachement des pièces jointes aux interlocuteurs émetteurs du courriel si la règle est activée
          //$_SESSION['vl_e_nb_int_rattaches']=$vl_e_nb_int_rattaches;
          //$_SESSION['vl_tb_reg_00008']=$vl_tb_reg_00008[0];
          if (($vl_e_nb_int_rattaches!=0) && ($vl_tb_reg_00008[0]==1)) {
            for($j = 1; $j < $vl_e_nb_int_rattaches+1; $j++) {
              $sql_req_02 = "INSERT INTO _documents_rattachement set doc_cleunik=$doc_cleunik,rat_cleunik=".$t_int_cleunik_rattachement[$j].",portee=$vl_e_interl;";
              _graal_exec_requete($sql_req_02);
            }
          }
          //  Rattachement des pièces jointes aux acteurs émetteurs du courriel si la règle est activée
          if (($vl_e_nb_int_rattaches!=0) && ($vl_tb_reg_00009[0]==1)) {
            for($j = 1; $j< $vl_e_nb_int_rattaches+1; $j++) {
              $sql_req_02 = "INSERT INTO _documents_rattachement set doc_cleunik=$doc_cleunik,rat_cleunik=".$t_act_cleunik_rattachement[$j].",portee=$vl_e_acteur;";
              _graal_exec_requete($sql_req_02);
            }
          }
        }
      }
      if ($ancienne_base_html=="") {$vl_c_type_courriel=1;} else {$vl_c_type_courriel=2;}
      $datas_vrac="";
      $datas_vrac.=fa_xcree_entete_xml();
      $datas_vrac.='<parametres>';
      $datas_vrac.='<nom_cou_destinataires_le data="'.fa_ent_xml($vl_c_zle).'" />';
      $datas_vrac.='<nom_cou_destinataires_re data="'.fa_ent_xml($vl_c_z26).'" />';
      $datas_vrac.='<nom_cou_destinataires_cc data="'.fa_ent_xml($vl_c_zcc).'" />';
      $datas_vrac.=$datas_vrac_image;
      $datas_vrac.=$datas_vrac_pj;
      $datas_vrac.='<nom_cou_destinataires data="'.fa_ent_xml($vl_c_z06).'" />';
      $datas_vrac.='<int_type_courriel data="'.$vl_c_type_courriel.'"/>';
      $datas_vrac.='</parametres>';
      $datas_vrac=addslashes($datas_vrac);
      $sql_req="INSERT INTO _courriel_re set action_cleunik=$vl_action_cleunik,courriel_re_mes_cleunik=$vl_courriel_re_mes_cleunik,sujet='$vl_c_z02',header='$b64_ente',expediteurs='$vl_c_z10',type=$vl_c_type_courriel,datas_vrac='$datas_vrac',mel_id='$vl_c_idmes',reponse=''";
      if ($vl_c_zle!="") {
      	$sql_req.=",etat_ar=1;";
				$vf_e_cleunik_ar.=$vl_action_cleunik.";";
				$vf_e_nb_ar++;
			} else {
				$sql_req.=";";
			}
      _graal_exec_requete($sql_req);
		  if ($vl_c_z08!="") {
        $sql_req="select action_cleunik from _courriel_en where mel_id='$vl_c_z08';";
        $result=_graal_requete_bd($sql_req);
        if($ligne=mysql_fetch_row($result)) {
          _graal_libere_requete_bd($result);
          $action_cleunik_gauche=$ligne[0];
          $action_cleunik_droite=$vl_action_cleunik;
          $choix_cleunik_droite=-48;
          $choix_cleunik_gauche=-49;
          $sql_req = "INSERT INTO _graal_act set action_cleunik_gauche=$action_cleunik_gauche,action_cleunik_droite=$action_cleunik_droite,choix_cleunik_gauche=$choix_cleunik_gauche,choix_cleunik_droite=$choix_cleunik_droite";
          _graal_exec_requete($sql_req);
        }
      }
      $sql_req_maj = "update _courriel_recus_brut set integre=1,action_cleunik=$vl_action_cleunik WHERE courriel_brut_cleunik=$cbc;";
      _graal_exec_requete($sql_req_maj);
      $vf_c_echo.=".";

    } else {
    	//$vf_c_echo.=$sql_req_01;
    }
    break;
  }
}
_graal_libere_requete_bd($result_00);
if ($vf_c_echo!="") {echo $vf_c_echo."|".$vf_e_nb_ar."|".$vf_e_cleunik_ar."|";}
function ff_url_absolue($vv_securise) {
	/*
	 * Penser à changer dans fa_url_absolue
	*/
switch ($vv_securise){
	case "oui":
		$protocol=fa_recup_session('protocol','https:');
		break;
	case "non":
		$protocol='http:';
		break;
}
switch ($_SERVER["HTTP_HOST"]){
  case "demo.christophe-charron.org":
  case "baronnat.christophe-charron.org":
  case "christophe-charron.org":
	case "87.98.161.16":
    $vl_c_url_absolue="$protocol://87.98.161.16/ovh_xsoftware/clients/graal/exploit/";
    break;
    $vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/exploit/";
    break;
  case "localhost":
    $vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/graal/exploit/";
    break;

	case "totem.xsoftware.fr":				// Sous-domaine Totem signalétique		07/11/2008
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/ba4a0658-ffa8-102b-966a-001cc01a9a40/graal/exploit/";
		break;
	case "legoff.xsoftware.fr":				// Sous-domaine Dominique Legoff			13/11/2008
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/eb3c1e86-0205-102c-966a-001cc01a9a40/graal/exploit/";
		break;
	case "paire.xsoftware.fr":				// Sous-domaine Domaine Paire					13/11/2008
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/b9df091e-09a1-4d37-85dc-546348528f6c/graal/exploit/";
		break;
	case "xof.xsoftware.fr":					// Sous-domaine xof										13/11/2008
	case "xofbacasable.xsoftware.fr":					// Sous-domaine xof bac à sable										29/06/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/1lb30974e-5497-1029-moii-001109b5c1d9/graal/exploit/";
		break;
	case "reference.xsoftware.fr":		// Sous-domaine base de référence			13/11/2008
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/3e6c99e7-c5f3-4d2c-b0db-d40d72a26fc5/graal/exploit/";
		break;
	case "baronnat.xsoftware.fr":			// Sous-domaine Baronnat							13/11/2008
	case "baronnatbacasable.xsoftware.fr":					// Sous-domaine baronnat bac à sable										29/06/2009
			$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/19c08ea0-5497-1029-9c29-001109b5c1d9/graal/exploit/";
		break;
	case "cafe.xsoftware.fr":					// Sous-domaine C-A-F-E								13/11/2008
	case "cafebacasable.xsoftware.fr":					// Sous-domaine C-A-F-E bac à sable										29/06/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/3d64dde4-a872-102b-a0f7-001cc01a9a40/graal/exploit/";
		break;
	case "cafeemailing.xsoftware.fr":					// Sous-domaine C-A-F-E	emailing							24/06/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/bb511f2a-81b0-4065-a668-d19218a9ebbb/graal/exploit/";
		break;
	case "lacavedepaulette.xsoftware.fr":	// Sous-domaine LA cave de Paulette		14/11/2008
	case "lacavedepaulettebacasable.xsoftware.fr":					// Sous-domaine LA cave de Paulette bac à sable										29/06/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/43c2c5f5-caaf-402e-9d9f-82523a0ba435/graal/exploit/";
		break;
	case "test01.xsoftware.fr":						// Sous-domaine test01								14/11/2008
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/e38966b5-8e83-4d94-9cfd-b0f3cb9daf1e/graal/exploit/";
		break;
	case "rss.xsoftware.fr":					// Sous-domaine rss										28/04/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/graal/exploit/";
		break;
	case "sma.xsoftware.fr":						// Sous-domaine Scott MArlin								09/10/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/bfa70b61-9637-419b-b098-413a04af185a/graal/exploit/";
		break;
	case "vertsra.xsoftware.fr":						// Sous-domaine Les verts de Rhône Alpes								09/10/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/1d77122d-1a09-4b15-8451-cda927a3b2b9/graal/exploit/";
		break;
	case "frla.xsoftware.fr":						// Sous-domaine France Lampes								05/11/2009
	case "frlabacasable.xsoftware.fr":						// Sous-domaine France Lampes								24/12/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/3be61be4-2cc9-420c-b37d-1dcb9f292fd8/graal/exploit/";
		break;
	case "foudretech.xsoftware.fr":						// Sous-domaine foudretech								17/12/2009
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/37fd8f9b-80f8-44c1-ba91-75d0b78746f4/graal/exploit/";
		break;
	case "egdiffusion.xsoftware.fr":
	case "egdbacasable.xsoftware.fr":						// Sous-domaine EG diffusion								21/01/2010
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/2c760b07-4c7a-402f-b015-d2ca450b9b0c/graal/exploit/";
		break;
	case "solber.xsoftware.fr":
	case "solberbacasable.xsoftware.fr":						// Sous-domaine Solber									10/02/2010
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/34fdfa1b-a8f5-4a92-bf9e-3f13c5ef21f6/graal/exploit/";
		break;
	case "incom.xsoftware.fr":
	case "incombacasable.xsoftware.fr":						// Sous-domaine Incom Création									10/02/2010
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/eaad5a63-2a65-4c62-adbc-0a175ac66f74/graal/exploit/";
		break;
	case "epac.xsoftware.fr":
	case "epacbacasable.xsoftware.fr":						// Sous-domaine EPAC									23/02/2010
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/f375c9f3-c7db-4def-888d-4d8dfc8b0113/graal/exploit/";
		break;
	case "quidnovi.xsoftware.fr":
	case "quidnovibacasable.xsoftware.fr":						// Sous-domaine Quid Novi Architecture									23/02/2010
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/bf398e9d-7de5-47dc-a864-4cac844da0f0/graal/exploit/";
		break;
	case "ajccom.xsoftware.fr":
	case "ajccombacasable.xsoftware.fr":						// Sous-domaine Ajccom									23/02/2010
		$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/bfdb3199-c228-48b9-b889-809f6cf706b9/graal/exploit/";
		break;
	case "demo0061.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/b0445325-d2b8-45bc-8f98-6d62cf929e31/graal/exploit/";break;
	case "demo0062.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/68df2dee-4012-4354-b0a3-4ff507b0f86b/graal/exploit/";break;
	case "demo0063.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/9912aae1-37ee-480c-b96d-4c41cf07c438/graal/exploit/";break;
	case "demo0064.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/f4278c09-ff03-4ff3-8007-3879b39403bf/graal/exploit/";break;
	case "demo0065.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/1cbe9902-ee62-4b81-8c87-52eabc921a1a/graal/exploit/";break;
	case "demo0066.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/e5929d28-5f61-4d08-a422-47b6ef974326/graal/exploit/";break;
	case "demo0067.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/d24711fb-e3df-4703-9cb1-661c3ecc08fa/graal/exploit/";break;
	case "demo0068.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/d311c8d9-93e3-45f5-86c0-3d144a18de92/graal/exploit/";break;
	case "demo0069.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/f081f297-f182-423d-be10-2ad62622f123/graal/exploit/";break;
	case "demo0070.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/aee755f7-7fd7-4767-aaa9-88caac8283bd/graal/exploit/";break;
	case "demo0071.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/4787e318-53ec-41dc-b98d-70520f5d6810/graal/exploit/";break;
	case "demo0072.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/18cd7145-c8eb-440d-9055-5505136988b4/graal/exploit/";break;
	case "demo0073.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/c31c8278-493e-4165-b334-e2e4225e6de2/graal/exploit/";break;
	case "demo0074.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/04a614a1-4f10-4f9d-a81f-d9bcbdf347cf/graal/exploit/";break;
	case "demo0075.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/241a8e70-9964-4656-9a08-f0f6a36cec1f/graal/exploit/";break;
	case "demo0076.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/8f0434f9-52ae-4604-bcb0-dbaade33ba02/graal/exploit/";break;
	case "demo0077.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/fc3540c4-da57-4181-8905-ff304f3d72c1/graal/exploit/";break;
	case "demo0078.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/1ef51b8b-a51d-4cec-985b-860a733455d3/graal/exploit/";break;
	case "demo0079.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/e8d0c3bf-b6e1-4ca5-8d40-d01b6a8f32f5/graal/exploit/";break;
	case "demo0080.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/bacf952b-25d8-4f74-be53-6e0e98842560/graal/exploit/";break;
	case "demo0081.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/139cc728-f37d-494e-abba-2ec6570f3831/graal/exploit/";break;
	case "demo0082.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/a80a91bd-9fcd-4e2c-aa6e-e1383fc42743/graal/exploit/";break;
	case "demo0083.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/e836925c-1f3b-4fef-9276-dc3a4859ec70/graal/exploit/";break;
	case "demo0084.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/4d4ab245-6f5f-4e4f-bdb9-6f02110bea42/graal/exploit/";break;
	case "demo0085.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/17203d73-2439-483d-aacf-bed23d78cab9/graal/exploit/";break;
	case "demo0086.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/412ab87d-7f98-4444-a9cb-bc7ac0cf6811/graal/exploit/";break;
	case "demo0087.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/cb95e9b8-7d6a-41ce-a7c7-47af75226043/graal/exploit/";break;
	case "demo0088.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/b17b4c0c-ad2e-4b57-8c9f-86cf52ee2194/graal/exploit/";break;
	case "demo0089.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/2a413004-3d96-4af3-96ae-22e97e9489de/graal/exploit/";break;
	case "demo0090.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/fbf4dbfa-d541-49b4-be01-f2e529247971/graal/exploit/";break;
	case "demo0091.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/0dc9f59f-9563-4dd3-a579-243f362ce877/graal/exploit/";break;
	case "demo0092.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/848ead0c-88b8-4da5-8b06-1c72399354df/graal/exploit/";break;
	case "demo0093.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/01a873fd-2b79-49c9-aa8b-7251b274a8d1/graal/exploit/";break;
	case "demo0094.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/dd08eed5-902e-4b0e-9ce9-de38f2c8f0ee/graal/exploit/";break;
	case "demo0095.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/7ee1e5e4-cde7-4aff-821b-efb42ef072d0/graal/exploit/";break;
	case "demo0096.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/1658fbf7-11d9-4725-83d0-e0675f3b03d2/graal/exploit/";break;
	case "demo0097.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/66722baf-46b9-4e4c-a93e-e96a729daff7/graal/exploit/";break;
	case "demo0098.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/62f02e8f-ddf7-4c76-bdca-e02feef515d5/graal/exploit/";break;
	case "demo0099.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/c2980064-4348-4d4a-911c-0489488f00f1/graal/exploit/";break;
	case "demo0100.xsoftware.fr":$vl_c_url_absolue="$protocol//".$_SERVER["HTTP_HOST"]."/ec2ff576-6abc-4416-9aaa-440da039200b/graal/exploit/";break;
  default:
}
return $vl_c_url_absolue;
/*
1cbe9902-ee62-4b81-8c87-52eabc921a1a : demo0065
e5929d28-5f61-4d08-a422-47b6ef974326 : demo0066
d24711fb-e3df-4703-9cb1-661c3ecc08fa : demo0067
d311c8d9-93e3-45f5-86c0-3d144a18de92 : demo0068
f081f297-f182-423d-be10-2ad62622f123 : demo0069
aee755f7-7fd7-4767-aaa9-88caac8283bd : demo0070
4787e318-53ec-41dc-b98d-70520f5d6810 : demo0071
18cd7145-c8eb-440d-9055-5505136988b4 : demo0072
c31c8278-493e-4165-b334-e2e4225e6de2 : demo0073
04a614a1-4f10-4f9d-a81f-d9bcbdf347cf : demo0074
241a8e70-9964-4656-9a08-f0f6a36cec1f : demo0075
8f0434f9-52ae-4604-bcb0-dbaade33ba02 : demo0076
fc3540c4-da57-4181-8905-ff304f3d72c1 : demo0077
1ef51b8b-a51d-4cec-985b-860a733455d3 : demo0078
e8d0c3bf-b6e1-4ca5-8d40-d01b6a8f32f5 : demo0079
bacf952b-25d8-4f74-be53-6e0e98842560 : demo0080
139cc728-f37d-494e-abba-2ec6570f3831 : demo0081
a80a91bd-9fcd-4e2c-aa6e-e1383fc42743 : demo0082
e836925c-1f3b-4fef-9276-dc3a4859ec70 : demo0083
4d4ab245-6f5f-4e4f-bdb9-6f02110bea42 : demo0084
17203d73-2439-483d-aacf-bed23d78cab9 : demo0085
412ab87d-7f98-4444-a9cb-bc7ac0cf6811 : demo0086
cb95e9b8-7d6a-41ce-a7c7-47af75226043 : demo0087
b17b4c0c-ad2e-4b57-8c9f-86cf52ee2194 : demo0088
2a413004-3d96-4af3-96ae-22e97e9489de : demo0089
fbf4dbfa-d541-49b4-be01-f2e529247971 : demo0090

0dc9f59f-9563-4dd3-a579-243f362ce877 : demo0091
848ead0c-88b8-4da5-8b06-1c72399354df : demo0092
01a873fd-2b79-49c9-aa8b-7251b274a8d1 : demo0093
dd08eed5-902e-4b0e-9ce9-de38f2c8f0ee : demo0094
7ee1e5e4-cde7-4aff-821b-efb42ef072d0 : demo0095
1658fbf7-11d9-4725-83d0-e0675f3b03d2 : demo0096
66722baf-46b9-4e4c-a93e-e96a729daff7 : demo0097
62f02e8f-ddf7-4c76-bdca-e02feef515d5 : demo0098
c2980064-4348-4d4a-911c-0489488f00f1 : demo0099
ec2ff576-6abc-4416-9aaa-440da039200b : demo0100
*/

}
?>
