<?php
include("_graal_header_txt.inc.php");
set_time_limit(6000);
define('EOL', "\r\n");
$vl_c_type=fa_recup_param('type','');
$nombre=0;
switch ($vl_c_type) {
  case '1': //  Mise à jour de la date de dernier mouvement de stocks d'après le fichier des mouvements de stock
    $sql_maj="update _art_stock set dateheure_dermvt=NULL;";
    _graal_exec_requete($sql_maj);
    $sql_req="select distinct(art_cleunik) from _mouvements_stock order by art_cleunik";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vl_art_cleunik=$row['art_cleunik'];
      $sql_req_01="select dateheuremvt from _mouvements_stock where art_cleunik=$vl_art_cleunik and type_mvt in(1,2) order by art_cleunik asc,dateheuremvt desc limit 1;";
      $result_01 = _graal_requete_bd($sql_req_01);
      while ($row_01 = mysql_fetch_assoc($result_01)) {
        $dateheure_dermvt=$row_01['dateheuremvt'];
        $sql_maj="update _art_stock set dateheure_dermvt='$dateheure_dermvt' where art_cleunik=$vl_art_cleunik;";
        $nombre++;
        _graal_exec_requete($sql_maj);
      }
      _graal_libere_requete_bd($result_01);
    }
    _graal_libere_requete_bd($result);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '2': //  Mise à jour du prix de revient des articles à partir du dernier prix d'achat
    $sql_req="update _art_fabs,_art_achats set pr=_art_achats.der_pa where _art_fabs.art_cleunik=_art_achats.art_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_req);
    $vf_c_echo="$nombre mises à jour.".EOL;
  case '3': //  Mise à jour de la date de dernier inventaire d'après le fichier des mouvements de stock
    $sql_maj="update _art_stock set dateheure_invent=NULL,qte_inven=0;";
    _graal_exec_requete($sql_maj);
    $sql_req="select distinct(art_cleunik) from _mouvements_stock order by art_cleunik";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vl_art_cleunik=$row['art_cleunik'];
      $sql_req_01="select dateheuremvt,qte_mvt from _mouvements_stock where art_cleunik=$vl_art_cleunik and type_mvt in(3) order by art_cleunik asc,dateheuremvt desc limit 1;";
      $result_01 = _graal_requete_bd($sql_req_01);
      while ($row_01 = mysql_fetch_assoc($result_01)) {
        $dateheure_invent=$row_01['dateheuremvt'];
        $qte_inven=$row_01['qte_mvt'];
        $sql_maj="update _art_stock set dateheure_invent='$dateheure_invent',qte_inven=$qte_inven where art_cleunik=$vl_art_cleunik;";
        $nombre++;
        _graal_exec_requete($sql_maj);
      }
      _graal_libere_requete_bd($result_01);
    }
    _graal_libere_requete_bd($result);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '4'://MAJ cumuls entrées/sorties de stock
    $sql_req="update _art_stock set cumul_entrees=(select sum(qte_mvt)from _mouvements_stock where type_mvt=1 and _mouvements_stock.art_cleunik=_art_stock.art_cleunik);";
    $nombre+=_graal_requete_nombre_affecte($sql_req);
    $sql_req="update _art_stock set cumul_sorties=(select sum(qte_mvt)from _mouvements_stock where type_mvt=2 and _mouvements_stock.art_cleunik=_art_stock.art_cleunik);";
    $nombre+=_graal_requete_nombre_affecte($sql_req);
    $vf_c_echo="$nombre mises à jour.".EOL;

  
}
echo $vf_c_echo;
?>
