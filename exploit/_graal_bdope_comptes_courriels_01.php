<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_cryptage.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_comptes_courriels";
$t_origines_ok[1]="_graal_fen_modif_idcon_02";
$t_origines_ok[2]="_graal_fen_comptes_fax";
$t_origines_ok[3]="_graal_fen_comptes_sms";
fa_acces_script();
$vl_e_mini=intval(fa_recup_session('borne_mini','0'));
$vl_e_maxi=intval(fa_recup_session('borne_maxi','0'));
$vf_c_action=fa_recup_param('vl_c_action','??????');
$vl_e_uti_cleunik=intval(fa_recup_param('vl_e_uti_cleunik','0'));
$vl_e_uticptbal_cleunik=intval(fa_recup_param('vl_e_uticptbal_cleunik','0'));
$vl_c_titre=fa_recup_param('vl_c_titre','Compte courriel à définir');
$vl_c_smtp=fa_recup_param('vl_c_serveursmtp','');
$vl_c_emetteur=fa_recup_param('vl_c_courrielemetteur','');
$vl_c_nomemetteur=fa_recup_param('vl_c_nomemetteur','');
$vl_c_sendmail_from=fa_recup_param('vl_c_sendfrom','');
$vl_c_adressereponses=fa_recup_param('vl_c_courrielreponse','');
$vl_c_cheminretour=fa_recup_param('vl_c_courrielretour','');
$vl_c_adresseerreurs=fa_recup_param('vl_c_courrielerreurs','');
$vl_c_adresseconfirmationlecture=fa_recup_param('vl_c_courrielconfirmationlecture','');
$vl_c_serveurpop3=fa_recup_param('vl_c_serveurpop3','');
$vl_c_utilisateurpop3=fa_recup_param('vl_c_utilisateurpop3','');
$vl_c_motdepassepop3=fa_recup_param('vl_c_motdepassepop3','');
$vl_c_port_smtp=fa_recup_param('vl_c_port_smtp','25');
$vl_c_type_compte=fa_recup_param('vl_c_type_compte','');
$vl_c_port_pop=fa_recup_param('vl_c_port_pop','');
$vl_c_pop_ssl=fa_recup_param('vl_c_pop_ssl','');
$vl_e_genre=intval(fa_recup_param('vl_e_genre','1'));
$vl_c_adresse_cr_fax=fa_recup_param('vl_c_adresse_cr_fax','');

$vl_c_motdepasse=fa_recup_param('vl_c_motdepasse','');
$vl_c_id=fa_recup_param('vl_c_id','');
$vl_c_qualite=fa_recup_param('vl_c_qualite','');

$mess01="666 Modification interdite !!";
$mess02="Modification réalisée avec succès.";
$mess03="La modification a échoué!!!.";

switch (TRUE) {
  case $vf_c_action=='??????':
  case $vf_c_action=='supprimer':
    break;    
  case $vf_c_action=='ajouter':
    break;
  case $vf_c_action=='modifier':
		$sql_req = "SELECT _uti_cpt_bal.titre as titre,_uti_cpt_bal.compte AS compte FROM _uti_cpt_bal where uticptbal_cleunik=$vl_e_uticptbal_cleunik";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
		$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
		switch ($vl_e_genre){
			case 1://	comptes courriel
				$vl_c_motdepassepop3=$vl_c_xml->motdepassepop3[0]->attributes();
				break;
			case 2://	comptes fax
				$vl_c_motdepasse=$vl_c_xml->motdepasse[0]->attributes();
				break;
			case 3://	comptes sms
				break;
		}
		
    break;
  case $vf_c_action=='changer_mot_de_passe':
		$vl_c_motdepasse_neo_01=fa_recup_param('vl_c_motdepasse_neo_01','&&&&&&&&&');
		$sql_req = "SELECT _uti_cpt_bal.titre as titre,_uti_cpt_bal.compte AS compte FROM _uti_cpt_bal where uticptbal_cleunik=$vl_e_uticptbal_cleunik";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
		$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
		switch ($vl_e_genre){
			case 1://	comptes courriel
				if ($vl_c_motdepassepop3==$vl_c_xml->motdepassepop3[0]->attributes()) {
					$vl_c_titre=$vl_c_xml->titre[0]->attributes();
					$vl_c_smtp=$vl_c_xml->smtp[0]->attributes();
					$vl_c_emetteur=$vl_c_xml->nomemetteur[0]->attributes();
					$vl_c_nomemetteur=$vl_c_xml->emetteur[0]->attributes();
					$vl_c_sendmail_from=$vl_c_xml->from[0]->attributes();
					$vl_c_adressereponses=$vl_c_xml->adressereponse[0]->attributes();
					$vl_c_cheminretour=$vl_c_xml->cheminretour[0]->attributes();
					$vl_c_adresseerreurs=$vl_c_xml->adresseerreurs[0]->attributes();
					$vl_c_adresseconfirmationlecture=$vl_c_xml->adresseconfirmationlecture[0]->attributes();
					$vl_c_serveurpop3=$vl_c_xml->serveurpop3[0]->attributes();
					$vl_c_utilisateurpop3=$vl_c_xml->utilisateurpop3[0]->attributes();
					$vl_c_port_smtp=$vl_c_xml->port_smtp[0]->attributes();
					$vl_c_type_compte=$vl_c_xml->type_compte[0]->attributes();
					$vl_c_port_pop=$vl_c_xml->port_pop[0]->attributes();
					$vl_c_pop_ssl=$vl_c_xml->pop_ssl[0]->attributes();
					$vl_c_motdepassepop3=$vl_c_motdepasse_neo_01;
				} else {
					die("$mess01");
				}
				break;
			case 2://	comptes fax
				if ($vl_c_motdepassepop3==$vl_c_xml->motdepasse[0]->attributes()) {
					$vl_c_titre=$vl_c_xml->titre[0]->attributes();
					$vl_c_id=$vl_c_xml->id[0]->attributes();
					$vl_c_qualite=$vl_c_xml->qualite[0]->attributes();
					$vl_c_type_compte=$vl_c_xml->type_compte[0]->attributes();
					$vl_c_adresse_cr_fax=$vl_c_xml->adresse_cr_fax[0]->attributes();
					$vl_c_motdepasse=$vl_c_motdepasse_neo_01;
				} else {
					die("$mess01");
				}

				break;
			case 3://	comptes sms
				break;
		}
    break;
}
$vl_c_comptexml="";
$vl_c_comptexml.=fa_xcree_entete_xml();
$vl_c_comptexml.='<parametres>';
switch ($vl_e_genre){
	case 1://	comptes courriel
		$vl_c_comptexml.='<titre data="'.fa_ent_xml($vl_c_titre).'"/>';
		$vl_c_comptexml.='<smtp data="'.fa_ent_xml($vl_c_smtp).'"/>';
		$vl_c_comptexml.='<nomemetteur data="'.fa_ent_xml($vl_c_nomemetteur).'"/>';
		$vl_c_comptexml.='<emetteur data="'.fa_ent_xml($vl_c_emetteur).'"/>';
		$vl_c_comptexml.='<from data="'.fa_ent_xml($vl_c_sendmail_from).'"/>';
		$vl_c_comptexml.='<adressereponse data="'.fa_ent_xml($vl_c_adressereponses).'"/>';
		$vl_c_comptexml.='<cheminretour data="'.fa_ent_xml($vl_c_cheminretour).'"/>';
		$vl_c_comptexml.='<adresseerreurs data="'.fa_ent_xml($vl_c_adresseerreurs).'"/>';
		$vl_c_comptexml.='<adresseconfirmationlecture data="'.fa_ent_xml($vl_c_adresseconfirmationlecture).'"/>';
		$vl_c_comptexml.='<serveurpop3 data="'.fa_ent_xml($vl_c_serveurpop3).'"/>';
		$vl_c_comptexml.='<utilisateurpop3 data="'.fa_ent_xml($vl_c_utilisateurpop3).'"/>';
		$vl_c_comptexml.='<motdepassepop3 data="'.fa_ent_xml($vl_c_motdepassepop3).'"/>';
		$vl_c_comptexml.='<port_smtp data="'.fa_ent_xml($vl_c_port_smtp).'"/>';
		$vl_c_comptexml.='<type_compte data="'.fa_ent_xml($vl_c_type_compte).'"/>';
		$vl_c_comptexml.='<port_pop data="'.fa_ent_xml($vl_c_port_pop).'"/>';
		$vl_c_comptexml.='<pop_ssl data="'.fa_ent_xml($vl_c_pop_ssl).'"/>';
		break;
	case 2://	comptes fax
		$vl_c_comptexml.='<titre data="'.fa_ent_xml($vl_c_titre).'"/>';
		$vl_c_comptexml.='<id data="'.fa_ent_xml($vl_c_id).'"/>';
		$vl_c_comptexml.='<motdepasse data="'.fa_ent_xml($vl_c_motdepasse).'"/>';
		$vl_c_comptexml.='<type_compte data="'.fa_ent_xml($vl_c_type_compte).'"/>';
		$vl_c_comptexml.='<qualite data="'.fa_ent_xml($vl_c_qualite).'"/>';
		$vl_c_comptexml.='<adresse_cr_fax data="'.fa_ent_xml($vl_c_adresse_cr_fax).'"/>';
		break;
	case 3://	comptes sms
		break;
}
$vl_c_comptexml.='</parametres>';
$vl_c_comptexml_chiffre=addslashes(fa_mcrypte("info_compte_courriel",$vl_c_comptexml,"chiffrer"));
$vf_c_echo='';
switch (TRUE) {
  case $vf_c_action=='??????':
    echo $vf_c_action;
    exit;
    break;    
  case $vf_c_action=='supprimer':
    $sql_req = "DELETE FROM _uti_cpt_bal WHERE _uti_cpt_bal.uticptbal_cleunik = $vl_e_uticptbal_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='ajouter':
    $cleunik=_graal_requete_max("uticptbal_cleunik","_uti_cpt_bal");
    $sql_req = "INSERT INTO _uti_cpt_bal set uticptbal_cleunik=$cleunik,uti_cleunik=$vl_e_uti_cleunik,dateheurecreation=now(),titre='$vl_c_titre',compte='$vl_c_comptexml_chiffre',genre=$vl_e_genre;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    $sql_req = "INSERT INTO _droits_cpt_bal set uticptbal_cleunik=$cleunik,uti_cleunik=$vl_e_uti_cleunik,droits_proprio=31;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='modifier':
    $sql_req = "update _uti_cpt_bal set dateheuremodif=now(),titre='$vl_c_titre',compte='$vl_c_comptexml_chiffre' WHERE _uti_cpt_bal.uticptbal_cleunik = $vl_e_uticptbal_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=='changer_mot_de_passe':
    $sql_req = "update _uti_cpt_bal set dateheuremodif=now(),titre='$vl_c_titre',compte='$vl_c_comptexml_chiffre' WHERE _uti_cpt_bal.uticptbal_cleunik = $vl_e_uticptbal_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
		if($vf_c_echo=='ok') {$vf_c_echo=$mess02;} else {$vf_c_echo=$mess03;}
    break;
} 
_graal_ferme_connexion();
echo $vf_c_echo;       
?>
