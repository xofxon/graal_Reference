<?php
include("_graal_header_xul.inc.php");
$vl_c_genre=fa_recup_param('genre','');
//  Saisie d'inventaire, sann gestion des dépôts et emplacements
switch ($vl_c_genre) {
  case "saisie": 
    $vl_c_id_fenetre="Fen_00247";
    break;  //  Saisie
  case "visual":
    $vl_c_id_fenetre="Fen_00635";
    break;  //  Visualisation
  default: fa_redirige("acces_interdit");
}
$vl_c_win_id="_graal_fenetre_01";
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bby_100=fa_recup_dico("bby_100");
$vl_c_bby_101=fa_recup_dico("bby_101");
$vl_c_bby_102=fa_recup_dico("bby_102");
$vl_c_bby_103=fa_recup_dico("bby_103");
$vl_c_bby_104=fa_recup_dico("bby_104");
$vl_c_bby_104="Déjà validées";
$vl_c_bby_105=fa_recup_dico("bby_105");
$vl_c_bby_106=fa_recup_dico("bby_106");
$vl_c_bby_107=fa_recup_dico("bby_107");
$vl_c_bby_108=fa_recup_dico("bby_108");
$vl_c_bby_109=fa_recup_dico("bby_109");
$vl_c_bby_110=fa_recup_dico("bby_110");
$vl_c_bby_110="Sauvegardées en attente de validation";
$vl_c_bby_113="Imprimer";
$vl_c_bby_151=fa_recup_dico("bby_151");
$vl_c_bby_152=fa_recup_dico("bby_152");
$vl_c_bby_153=fa_recup_dico("bby_153");
$vl_c_bby_154=fa_recup_dico("bby_154");
$vl_c_bby_155=fa_recup_dico("bby_155");
$vl_c_bby_156=fa_recup_dico("bby_156");


$vl_c_bbx_110="Description";
$vl_c_bbx_111="Code";
$vl_c_bbx_112="Id mnémotechnique";
$vl_c_bbx_113="Etat";
$vl_c_bbx_114="Base de valorisation théorique";
$vl_c_bbx_115="Tarif de référence théorique";
$vl_c_bbx_116="Ouvrir l'article";
$vl_c_bbx_117="Rafraîchir";
$vl_c_bbx_118="Inventaire";
$vl_c_bbx_119="Sélectionner les articles";
$vl_c_bbx_120="Critère de tri";
$vl_c_bbx_121="Code choix";
$vl_c_bbx_122="Désignation choix";
$vl_c_bbx_123="Capacité unitaire";
$vl_c_bbx_124="Unité de capacité";
$vl_c_bbx_125="Capacité inventoriée";
$vl_c_dico_00027=fa_recup_dico('dico_00027');
switch ($vl_c_genre) {
  case "saisie": 
    $vl_c_action="pf_alimente_frame();";
    $vl_c_bouton='<button id="bt_sel_util" label="'.$vl_c_bby_105.'" crop="end" dir="normal" oncommand="'.$vl_c_action.'"/>';
    $vl_c_bouton_01="";
    break;  //  Saisie
  case "visual":
    $vl_c_action="pf_affiche(fa_value_get('ml_affichage_lignes'));";
    $vl_c_action_01="pf_pdf(fa_value_get('ml_affichage_lignes'));";
    $vl_c_bouton="";
    $vl_c_bouton_01='<button id="bt_sel_util_01" label="'.$vl_c_bby_105.'" crop="end" dir="normal" oncommand="'.$vl_c_action.'"/>';
    $vl_c_bouton_01.='<button tooltiptext ="'.$vl_c_bby_113.'" id="bt_pdf" label="'.$vl_c_bby_113.'" crop="end" dir="normal" oncommand="'.$vl_c_action_01.'" />';
    break;  //  Visualisation
  default: fa_redirige("acces_interdit");
}
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" id="$vl_c_id_fenetre" _graal_id_fenetre="$vl_c_id_fenetre" title="$vl_c_bby_100" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_inventaire_02.js.php");
echo <<<END
<vbox flex="1">
<hbox>
END;
//  On recherche tous les inventaires possibles        
$sql_req = "SELECT inv_cleunik,description,etat,"._graalsql_date('_inventaire.dateheurecreation')." as `dateheureinventaire`,critere_cleunik FROM _inventaire order by etat DESC, description ASC;";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0) 
{
$vl_b_envoi_possible=false;
echo <<<END
<label value="$vl_c_dico_00027" />
END;
}
else {$vl_b_envoi_possible=true;
echo <<<END
<menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex="1" id="ml_inventaire">
  <menupopup>
END;
while ($row = mysql_fetch_assoc($sql_result)){
  if ($row['etat']==1) {
    echo("<menuitem value='" .$row['inv_cleunik']. "' label='".$row['description']." (".$row['dateheureinventaire']. ")' disabled='true' _graal_date_inventaire='".$row['dateheureinventaire']."' _graal_critere_cleunik='".$row['critere_cleunik']."' />");
  }
  else{
    echo("<menuitem value='" .$row['inv_cleunik']. "' label='".$row['description']." (".$row['dateheureinventaire']. ")' selected='true' _graal_date_inventaire='".$row['dateheureinventaire']."' _graal_critere_cleunik='".$row['critere_cleunik']."' />");
    }
  }
echo <<<END
  </menupopup>
</menulist>
    <groupbox>
    <caption><label value="$vl_c_bby_101" /></caption>
    <radiogroup id="rdg_etat" flex="1" value="2">
       <vbox>
        <hbox flex="1">
        <radio label="$vl_c_bby_102" value="1" />
        <spacer flex="1"/>
        <radio label="$vl_c_bby_103" selected="true" value="2" />
        <spacer flex="1"/>
        <radio label="$vl_c_bby_104" value="3" />
        </hbox>
       </vbox>
       <vbox>
         <hbox>
         <radio label="$vl_c_bby_110" value="4" />
         </hbox>
      </vbox>
     </radiogroup>
  </groupbox>
    <groupbox>
    <caption><label value="$vl_c_bby_151" /></caption>
    <radiogroup id="rdg_inactifs" flex="1" value="2">
       <vbox>
        <hbox flex="1">
          <radio id="ra_inactif_oui" label="Oui" value="1" />
          <spacer flex="1"/>
          <radio id="ra_inactif_non" label="Non" selected="true" value="2" />
        </hbox>
      </vbox>
      <vbox>
        <hbox> 
          <radio id="ra_inactif_tous" label="Tous" value="3" />
        </hbox>
      </vbox>

     </radiogroup>
  </groupbox>
    <groupbox>
    <caption><label value="$vl_c_bby_153" /></caption>
    <radiogroup id="rdg_critere" flex="1" value="2">
       <hbox flex="1">
       <radio id="ra_critere_oui" label="Oui" value="1" />
       <radio id="ra_critere_non" label="Non" value="2" selected="true"/>
       </hbox>
     </radiogroup>
  </groupbox>

  <vbox flex="2">
    <label flex="1" value="$vl_c_bby_106"/>
    <menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex="1" id="bbo_ml_zone" value="1"> 
      <menupopup>
        <menuitem label="$vl_c_bby_107" selected="true" value="1"/>
        <menuitem label="$vl_c_bby_108" value="2"/>
        <menuitem label="$vl_c_bby_109" value="3"/>
        <menuitem label="$vl_c_bby_152" value="4"/>
      </menupopup>
    </menulist>
  </vbox>
  $vl_c_bouton
END;
}
_graal_libere_requete_bd($sql_result);
_graal_ferme_connexion();
echo <<<END
  </hbox>
  <vbox flex="100">
    <deck id="dk_01" flex="1">
      <_graal_deck flex="1">
        <iframe flex="100" onload="event.stopPropagation();" id="iframe_lignes_inventaires" src=""/>
      </_graal_deck>
      <_graal_deck >
        <vbox flex="1">
          <hbox>
            <label value="$vl_c_bby_154"/>
            <menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' observes="broadcaster_01"  id='ml_affichage_lignes' _graal_nombre='2' flex="1">
              <menupopup>
                <menuitem value='0' label="$vl_c_bby_155" selected='true'/>
                <menuitem value='1' label="$vl_c_bby_156"/>
              </menupopup>
            </menulist>
            $vl_c_bouton_01
          </hbox>
          <deck id="dk_02" flex="1">
            <hbox >
              <tree id="arbre_lignes_inventaire_01" flex="1" enableColumnDrag="true" flags="" ref="*" querytype="xml" datasources="" context='pop_art'>
                <treecols>
                  <treecol collapsed="true" id="tc_inv_cleunik" label="raf_invisible" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol collapsed="true" id="tc_art_cleunik" label="raf_invisible" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_description" label="$vl_c_bbx_110" sort="?description" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_code" label="$vl_c_bbx_111" sort="?code"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_mnemotechnique" label="$vl_c_bbx_112" sort="?mnemotechnique"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_etat" label="$vl_c_bbx_113" sort="?etat"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_choix_code" label="$vl_c_bbx_121" sort="?choix_code"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_choix_valeur_texte_01" label="$vl_c_bbx_122" sort="?choix_valeur_texte_01"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_tarif_reference" label="$vl_c_bbx_114" class="droite" sort="?val_tarif_reference_theorique"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_qte_inven" label="$vl_c_bbx_118" class="droite" sort="?val_qte_inven"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_tr" label="$vl_c_bbx_115" sort="?tr" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_val_tarif_reference" sort="?val_tarif_reference_theorique" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_val_qte_inven" sort="?val_qte_inven" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
          
                </treecols>
                <template><query expr="*"/><action>
                  <treechildren>
                    <treeitem uri="?" seltype="single">
                      <treerow>
                        <treecell label="?inv_cleunik"/>
                        <treecell label="?art_cleunik"/>
                        <treecell properties="?properties" label="?description"/>
                        <treecell properties="?properties" label="?code"/>
                        <treecell properties="?properties" label="?mnemotechnique"/>
                        <treecell properties="?properties" label="?etat"/>
                        <treecell properties="?properties" label="?choix_code"/>
                        <treecell properties="?properties" label="?choix_valeur_texte_01"/>
                        <treecell properties="?properties" label="?tarif_reference_theorique"/>
                        <treecell properties="?properties" label="?qte_inven"/>
                        <treecell properties="?properties" label="?tr"/>
                        <treecell properties="?properties" label="?val_tarif_reference_theorique"/>
                        <treecell properties="?properties" label="?val_qte_inven"/>
                      </treerow>
                    </treeitem>
                  </treechildren>
                </action></template>
              </tree>
            </hbox>
            <hbox flex="4">
              <tree id="arbre_lignes_inventaire_02" flex="1" enableColumnDrag="true" flags="" ref="*" querytype="xml" datasources="" context='pop_art'>
                <treecols>
                  <treecol collapsed="true" id="tc_inv_cleunik" label="raf_invisible" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol collapsed="true" id="tc_art_cleunik" label="raf_invisible" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_description" label="$vl_c_bbx_110" sort="?description" ignoreincolumnpicker="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_code" label="$vl_c_bbx_111" sort="?code"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_mnemotechnique" label="$vl_c_bbx_112" sort="?mnemotechnique"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_etat" label="$vl_c_bbx_113" sort="?etat"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_choix_code" label="$vl_c_bbx_121" sort="?choix_code"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_choix_valeur_texte_01" label="$vl_c_bbx_122" sort="?choix_valeur_texte_01"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_tarif_reference" label="$vl_c_bbx_114" class="droite" sort="?val_tarif_reference_theorique"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_qte_inven" label="$vl_c_bbx_118" class="droite" sort="?val_qte_inven"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_capacite" label="$vl_c_bbx_123" class="droite" sort="?capacite"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_unite_capacite" label="$vl_c_bbx_124" sort="?unite_capacite"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_inventaire_capacite" label="$vl_c_bbx_125" class="droite" sort="?inventaire_capacite"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_tr" label="$vl_c_bbx_115" sort="?tr" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_val_tarif_reference" sort="?val_tarif_reference_theorique" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                  <treecol id="tc_val_qte_inven" sort="?val_qte_inven" ignoreincolumnpicker="true" hidden="true"/><splitter class="tree-splitter" resizeafter="grow"/>
                </treecols>
                <template><query expr="*"/><action>
                  <treechildren>
                    <treeitem uri="?" seltype="single">
                      <treerow>
                        <treecell label="?inv_cleunik"/>
                        <treecell label="?art_cleunik"/>
                        <treecell properties="?properties" label="?description"/>
                        <treecell properties="?properties" label="?code"/>
                        <treecell properties="?properties" label="?mnemotechnique"/>
                        <treecell properties="?properties" label="?etat"/>
                        <treecell properties="?properties" label="?choix_code"/>
                        <treecell properties="?properties" label="?choix_valeur_texte_01"/>
                        <treecell properties="?properties" label="?tarif_reference_theorique"/>
                        <treecell properties="?properties" label="?qte_inven"/>
                        
                        <treecell properties="?properties" label="?capacite"/>
                        <treecell properties="?properties" label="?unite_capacite"/>
                        <treecell properties="?properties" label="?inventaire_capacite"/>
                        
                        <treecell properties="?properties" label="?tr"/>
                        <treecell properties="?properties" label="?val_tarif_reference_theorique"/>
                        <treecell properties="?properties" label="?val_qte_inven"/>
                      </treerow>
                    </treeitem>
                  </treechildren>
                </action></template>
              </tree>
            </hbox>
          </deck>
        </vbox>
    </_graal_deck>
    </deck>
  </vbox>
  </vbox>
 </window>
END;
?>
