<?php
header('Content-type: text/xml; charset=utf-8');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
require_once("_graal_fonctions_mysql.php");
include("_graal_fonctions_documents.php");
include("_graal_var_portee.php");
$result = _graal_requete_bd($sql_req);
$prop_obsolete="css_0001";
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	if ($row['actif']==1) {$prop_ged_actif='';} else {$prop_ged_actif=$prop_obsolete;}
	if ($vl_c_selection=="oui") {
		switch ($row['typedoc']) {
    	case 3  ://  documents
    	case 13  ://  Pièces jointes
    		$ok=fa_verif_droit($row['doc_cleunik']);
    		break;
			default :
				$ok=true;
				break;
  	}
	} else {
		$ok=true;
	}
	if ($ok==true) {
		switch ($row['typedoc']) {
    	case 3  ://  documents
    	case 13  ://  Pièces jointes
    		$ok=fa_verif_droit($row['doc_cleunik']);
				if ($ok==true){
					$prop_droits="";
				} else {
					$prop_droits="cb08";
				}
    		break;
			default :
				$prop_droits="";
				break;
  	}
		echo('<quoi ');
	  echo(' prop_actif="'.$prop_ged_actif.'"');
	  echo(' doc_cleunik="'.fa_ent_xml($row['doc_cleunik']).'"');
	  echo(' emplacement="'.fa_ent_xml($row['emplacement']).'"');
	  echo(' titre="'.fa_ent_xml($row['titre']).'"');
	  echo(' typedoc="'.fa_ent_xml($row['typedoc']).'"');
	  echo(' descriptif_sommaire="'.fa_ent_xml($row['descriptif_sommaire']).'"');
	  echo(' origine="'.fa_ent_xml($row['origine']).'"');
	  if (fa_ent_xml($row['rattachement'])==0 && $row['portee']==$vl_e_acteur){
	  	$row['portee']=1;
	  }
	  echo(' portee="'.fa_ent_xml($row['portee']).'"');
	  echo(' rattachement="'.fa_ent_xml($row['rattachement']).'"');
	  echo(' dateheurecreation="'.fa_ent_xml($row['dateheurecreation']).'"');
	  echo(' dateheuremodif="'.fa_ent_xml($row['dateheuremodif']).'"');
	  echo(' dateheurecreation_brut="'.fa_ent_xml($row['dateheurecreation']).'"');
		echo(' prop_droits="'.$prop_droits.'"');
	  if (fa_ent_xml($row['ut_dateheuremodif'])!="") {
	    echo(' dateheuremodif_brut="'.fa_ent_xml($row['dateheuremodif']).'"');
	  } else {
	    echo(' dateheuremodif_brut="'.fa_ent_xml($row['dateheurecreation']).'"');
	  }
	//  le 8 mai 2008 : typedoc -> //  1 -> Liens 2 -> Notes, 3-> Documents, 4-> Dossier, 5 -> courriels envoyés, 6 -> modèles de courriels texte,7->Flux RSS, 8 -> requêtes personnelles,9 -> images,10 -> modèles de courriels HTML, 11 -> modèles de notes,12 -> modèles de notification de lecture, 13 -> Pièces jointes de courriels
	  switch ($row['typedoc']) {
	    case 1  : echo(' properties="ah05"');break;  //  liens
	    case 2  : echo(' properties="ai02"');break;  //  notes
	    case 3  : echo(' properties="ai03"');break;  //  documents
	    case 13  : echo(' properties="al14"');break;  //  Pièces jointes
	    default : echo(' properties=""');break;
	  }

	  switch ($vl_c_qui) {
	    case "liaisons":
	      switch ($row['portee']) {
	        case $vl_e_entrep: //  Entreprise
	          $vl_c_infos01="Entreprise ->".fa_ent_xml($row['qui_quoi']);
	          break;
	        case $vl_e_articl: //  article
	          $vl_c_infos01="Article ->".fa_ent_xml($row['qui_quoi']);
	          break;
	        case $vl_e_action: //  action
	        case $vl_e_faxfax: //  action fax émis
	          $vl_c_infos01="Action ->".fa_ent_xml($row['qui_quoi']);
	          break;
	        case $vl_e_interl:  //interlocuteur
	          $vl_c_infos01="Interlocuteur ->".fa_ent_xml($row['qui_quoi']);
	          break;
	        case $vl_e_acteur: //  Acteur
	          $vl_c_infos01="Acteur ->".fa_ent_xml($row['qui_quoi']);
	          break;
	        case $vl_e_utilis: //  Utilisateur
	          $vl_c_infos01=fa_ent_xml($row['qui_quoi']);
	          break;
	        default:
	          $vl_c_infos01=fa_ent_xml($row['qui_quoi']);
	          break;
	      }
	      break;
	    case '555555': //toutes les actions
	    case '666666': //tous les interlocuteurs
	    case '777777': //GED de tous les articles sauf les images (géré dans _graal_rech_ged_02.php)
	    case '999999': //tous les acteurs
	    case '999998': //Entreprise
	    case '888888':  //  Favoris
	    case 'notfav':  //  Mes notes favorites
	    case 'docfav':  //  Mes documents favoris
	    case 'notmoi':
	    case 'docmoi':
	    case 'notnos':
	    case 'docnos':
	    case 'noteux':
	    case 'doceux':
	    case 'docs':
	      break;
	    case 'notaction':
	    case 'docaction':
	    case "docpj":
	      $vl_c_infos01=fa_ent_xml($row['choix_valeur_texte_01']);
	      if ($row['sujet']!="") {
	        $vl_c_infos01.=" (".fa_ent_xml($row['sujet']).")";
	      }
	      if ($row['description']!="") {
	        $vl_c_infos01.=" [".fa_ent_xml($row['description'])."]";
	      }
	      break;
	    case 'notarticl':
	    case 'docarticl':
	      $vl_c_infos01=fa_ent_xml($row['mnemotechnique'])." (".fa_ent_xml($row['description'])."]";
	      break;
	    case 'notact':
	    case 'notclient':
	    case 'notprocli':
	    case 'notfourni':
	    case 'notprofou':
	    case 'notautact':
	    case 'notactind':
	    case 'notentrep':
	    case 'docact':
	    case 'docclient':
	    case 'docprocli':
	    case 'docfourni':
	    case 'docprofou':
	    case 'docautact':
	    case 'docactind':
	    case 'docentrep':
	      if ($row['raisonsoc']!=$row['nomcommercial']) {
	        $vl_c_infos01=fa_ent_xml($row['choix_valeur_texte_01'])." (".fa_ent_xml($row['raisonsoc'])."[".fa_ent_xml($row['nomcommercial'])."]".")";
	      } else {
	        $vl_c_infos01=fa_ent_xml($row['choix_valeur_texte_01'])." (".fa_ent_xml($row['raisonsoc']).")";
	      }
	      break;
	    case 'notinterl':
	    case 'notintclient':
	    case 'notintprocli':
	    case 'notintfourni':
	    case 'notintprofou':
	    case 'notintautact':
	    case 'notintactind':
	    case 'docinterl':
	    case 'docintclient':
	    case 'docintprocli':
	    case 'docintfourni':
	    case 'docintprofou':
	    case 'docintautact':
	    case 'docintactind':
	      $vl_c_infos01=fa_ent_xml($row['choix_valeur_texte_01'])."{".fa_ent_xml($row['prenom']).fa_ent_xml($row['patronyme'])."}"."(".fa_ent_xml($row['raisonsoc'])."[".fa_ent_xml($row['nomcommercial'])."]".")";
	      break;
	  }
	  echo(' infos_01="'.$vl_c_infos01.'"');
		echo('/>');
	}
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
