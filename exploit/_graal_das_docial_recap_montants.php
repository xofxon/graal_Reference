<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$genreaction=fa_recup_param("genreaction","??");
$genreregroupement="initial";
$vl_commercial_cleunik=intval(fa_recup_param("vl_commercial_cleunik",-1));
$vl_action_cleunik=intval(fa_recup_param("vl_action_cleunik",-1));
$vl_sortie=fa_recup_param("vl_sortie","das");
session_write_close();
include("_graal_req_docial_recap_montants.inc.php");
//die($sql_req_ht_marchandise);
$base_ht=0;
$total_base_brute=0;
$total_remise=0;
$total_ht=0;
$total_taxe=0;
$total_ttc=0;
$no_ordre_tt=-1;
$no_ordre_ht=10;
$no_ordre_pa=20;
$no_ordre_tv=25;
$no_ordre_po=30;
$no_ordre_fr=40;
//$genreaction="cdecli";//	depuis le 16 mai 2010, on force pour enregistrer systémétiquement le montant

switch ($genreaction){
	case "offcli":
		$fic_entete="_offcli_entetes";
		$fic_lignes="_offcli_lignes";
		$fic_ligqte="_offcli_lignes_qte";
		$choix_cleunik=-110114;
		break;
	case "cdecli":
		$fic_entete="_cdecli_entetes";
		$fic_lignes="_cdecli_lignes";
		$fic_ligqte="_cdecli_lignes_qte";
		$choix_cleunik=-110108;
		break;
	case "livcli":
		$fic_entete="_livcli_entetes";
		$fic_lignes="_livcli_lignes";
		$fic_ligqte="_livcli_lignes_qte";
		$choix_cleunik=-110110;
		break;
	case "demfou":
		$fic_entete="_demfou_entetes";
		$fic_lignes="_demfou_lignes";
		$fic_ligqte="_demfou_lignes_qte";
		$choix_cleunik=-110115;
		break;
	case "cdefou":
		$fic_entete="_cdefou_entetes";
		$fic_lignes="_cdefou_lignes";
		$fic_ligqte="_cdefou_lignes_qte";
		$choix_cleunik=-110109;
		break;
	case "recfou":
		$fic_entete="_recfou_entetes";
		$fic_lignes="_recfou_lignes";
		$fic_ligqte="_recfou_lignes_qte";
		$choix_cleunik=-110111;
		break;
	case "retcli":
		$fic_entete="_retcli_entetes";
		$fic_lignes="_retcli_lignes";
		$fic_ligqte="_retcli_lignes_qte";
		$choix_cleunik=-110133;
		break;
	case "retfou":
		$fic_entete="_retfou_entetes";
		$fic_lignes="_retfou_lignes";
		$fic_ligqte="_retfou_lignes_qte";
		$choix_cleunik=-110134;
		break;
		break;
	case "faccli":
		$fic_entete="_faccli_entetes";
		$fic_lignes="_faccli_lignes";
		$fic_ligqte="_faccli_lignes_qte";
		$choix_cleunik=-110112;
		break;
	case "avocli":
		$fic_entete="_avocli_entetes";
		$fic_lignes="_avocli_lignes";
		$fic_ligqte="_avocli_lignes_qte";
		$choix_cleunik=-110116;
		break;
	case "avofin":
		$fic_entete="_avocli_entetes";
		$fic_lignes="_avocli_lignes";
		$fic_ligqte="_avocli_lignes_qte";
		$choix_cleunik=-110117;
		break;
	case "avofou":
		$fic_entete="_avofou_entetes";
		$fic_lignes="_avofou_lignes";
		$fic_ligqte="_avofou_lignes_qte";
		$choix_cleunik=-110137;
		break;
	case "avofif":
		$fic_entete="_avofou_entetes";
		$fic_lignes="_avofou_lignes";
		$fic_ligqte="_avofou_lignes_qte";
		$choix_cleunik=-110138;
		break;
	case "facfou":
		$fic_entete="_facfou_entetes";
		$fic_lignes="_facfou_lignes";
		$fic_ligqte="_facfou_lignes_qte";
		$choix_cleunik=-110113;
		break;
}
$vl_choix_cleunik=$choix_cleunik;

$sql_req = "DELETE FROM _docciaux_montants where action_cleunik=$vl_action_cleunik;";
$vf_c_echo=_graal_exec_requete($sql_req);
/*
$sql_req="SELECT choix_cleunik from _actions where action_cleunik=$vl_action_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_choix_cleunik=$row['choix_cleunik'];
_graal_libere_requete_bd($result);
*/
//echo $sql_req;
echo('<donnees>');
$result = _graal_requete_bd($sql_req_ht_marchandise);
switch ($vl_sortie){
	case "sql":
		echo $sql_req_ht_marchandise.EOL;
		break;
}
//die($sql_req_ht_marchandise);
//echo '<req data="'.$sql_req_ht_marchandise.'"/>';
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
		echo('<quoi ');
    echo(' genre_ligne="'.fa_ent_xml($row['genre_ligne']).'"');
    echo(' denomination_taxe="'.fa_ent_xml($row['denomination_taxe']).'"');
    echo(' taux_taxe="'.fa_ent_xml($row['taux_taxe']).'"');
    echo(' base_brute="'.fa_ent_xml($row['htbrutremise']).'"');
    echo(' remise="'.fa_ent_xml($row['montantremise_pied']).'"');
    echo(' base_taxe="'.fa_ent_xml($row['montant_avec_remise_pied']).'"');
    echo(' montant_taxe="'.fa_ent_xml($row['montant_taxe']).'"');
    echo(' ttc="'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'"');
  	echo('/>');
	  $total_base_brute+=$row['htbrutremise'];
    $total_remise+=$row['montantremise_pied'];
    $base_ht+=$row['montant_avec_remise_pied'];
    $total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
    $vl_catcompta_cleunik=$row['catcompta_cleunik'];
	$vl_taxes_cleunik=$row['taxes_cleunik'];
	$vl_pc_cleunik=$row['pc_cleunik'];
			$no_ordre_tt++;
			//	Insertion HT marchandise
			$vl_ht=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set commercial_cleunik=$vl_commercial_cleunik,action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=1,montant=$vl_ht,ordre=$no_ordre_ht;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			//echo($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.="-2".$sql_req.EOL;}
  }
}
_graal_libere_requete_bd($result);
//  Port
$sql_req_port=str_replace("*base_ht*",$base_ht,$sql_req_port);
$result = _graal_requete_bd($sql_req_port);
//echo $sql_req_port;
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
		echo('<quoi ');
    echo(' genre_ligne="'.fa_ent_xml($row['genre_ligne']).'"');
    echo(' denomination_taxe="'.fa_ent_xml($row['denomination_taxe']).'"');
    echo(' taux_taxe="'.fa_ent_xml($row['taux_taxe']).'"');
    //echo(' base_brute="'.fa_ent_xml($row['htbrutremise']).'"');
    //echo(' remise="'.fa_ent_xml($row['montantremise_pied']).'"');
    echo(' base_taxe="'.fa_ent_xml($row['montant_avec_remise_pied']).'"');
    echo(' montant_taxe="'.fa_ent_xml($row['montant_taxe']).'"');
    echo(' ttc="'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'"');
  	echo('/>');
	$total_base_brute+=$row['htbrutremise'];
    $total_remise+=$row['montantremise_pied'];
    $total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
  			$no_ordre_po++;
			//	Insertion Port
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_port=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set commercial_cleunik=$vl_commercial_cleunik,action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=2,montant=$vl_port,ordre=$no_ordre_po;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok'){$vf_c_retour.=-4;}
  }
}
_graal_libere_requete_bd($result);
//  Frais
$sql_req_frais=str_replace("*base_ht*",$base_ht,$sql_req_frais);
$result = _graal_requete_bd($sql_req_frais);
//echo $sql_req_frais;
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
		echo('<quoi ');
    echo(' genre_ligne="'.fa_ent_xml($row['genre_ligne']).'"');
    echo(' denomination_taxe="'.fa_ent_xml($row['denomination_taxe']).'"');
    echo(' taux_taxe="'.fa_ent_xml($row['taux_taxe']).'"');
    echo(' base_taxe="'.fa_ent_xml($row['montant_avec_remise_pied']).'"');
    echo(' montant_taxe="'.fa_ent_xml($row['montant_taxe']).'"');
    echo(' ttc="'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'"');
  	echo('/>');
    $total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
			$no_ordre_fr++;
			//	Insertion Frais
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_frais=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set commercial_cleunik=$vl_commercial_cleunik,action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=2,montant=$vl_frais,ordre=$no_ordre_fr;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.=-8;}
  }
}
_graal_libere_requete_bd($result);
//echo $sql_req_parafiscale;
/*
 * suppression du test car si dom-tom calcul de la taxe parafiscale même si pas de TVA
 */
//if ($total_taxe!=0.0){
//	Taxe parafiscale
$result = _graal_requete_bd($sql_req_parafiscale);
//die($sql_req_parafiscale);
//echo $sql_req_parafiscale;
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
		echo('<quoi ');
    echo(' genre_ligne="'.fa_ent_xml($row['genre_ligne']).'"');
    echo(' denomination_taxe="'.fa_ent_xml($row['denomination_taxe']).'"');
    echo(' taux_taxe="'.fa_ent_xml($row['taux_taxe']).'"');
    echo(' base_taxe="'.fa_ent_xml($row['montant_avec_remise_pied']).'"');
    echo(' montant_taxe="'.fa_ent_xml($row['montant_taxe']).'"');
    echo(' ttc="'.fa_ent_xml($row['montant_taxe']+$row['montant_avec_remise_pied']).'"');
  	echo('/>');
    //$total_base_brute+=$row['montant_avec_remise_pied'];
  	$total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
			$no_ordre_pa++;
			//	Insertion taxe parafiscale
			$vl_catcompta_cleunik=$row['catcompta_cleunik'];
			$vl_taxes_cleunik=$row['taxes_cleunik'];
			$vl_pc_cleunik=$row['pc_cleunik'];
			$vl_parafiscale=$row['montant_avec_remise_pied'];
			$sql_req = "INSERT INTO _docciaux_montants set commercial_cleunik=$vl_commercial_cleunik,action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=$vl_pc_cleunik,type=2,montant=$vl_parafiscale,ordre=$no_ordre_pa;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.=-9;}
  }
}
_graal_libere_requete_bd($result);
//}
		$result = _graal_requete_bd($sql_req_tva_montant);
		while ($row = mysql_fetch_assoc($result)) {
		  if ($row['tva']!=0){
				$no_ordre_tv++;
				//	Insertion TVA
				$vl_catcompta_cleunik=$row['catcompta_cleunik'];
				$vl_taxes_cleunik=$row['taxes_cleunik'];
				$vl_tva=$row['tva'];
				$sql_req = "INSERT INTO _docciaux_montants set commercial_cleunik=$vl_commercial_cleunik,action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=$vl_taxes_cleunik,pc_cleunik=-1,type=2,montant=$vl_tva,ordre=$no_ordre_tv;";
				$vf_c_echo=_graal_exec_requete($sql_req);

				if($vf_c_echo!='ok') {$vf_c_retour.=-3;}
		  }
		}
		_graal_libere_requete_bd($result);
		$req_acteur="select a1.catcompta_cleunik as catcompta_acteur,a2.pc_cleunik as pc_cleunik_acteur from $fic_entete a1 left join _act_compta a2 on a1.act_cleunik=a2.act_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik;";
		$result_01 = _graal_requete_bd($req_acteur);
		$toto="$req_acteur".EOL;
		while ($row_01 = mysql_fetch_assoc($result_01)) {
			$vl_pc_cleunik=$row_01['pc_cleunik_acteur'];
			$vl_catcompta_cleunik=$row_01['catcompta_acteur'];
			$sql_req = "INSERT INTO _docciaux_montants set commercial_cleunik=$vl_commercial_cleunik,action_cleunik=$vl_action_cleunik,choix_cleunik=$vl_choix_cleunik,catcompta_cleunik=$vl_catcompta_cleunik,taxes_cleunik=-1,pc_cleunik=$vl_pc_cleunik,type=0,montant=$total_ttc,ordre=0;";
			$vf_c_echo=_graal_exec_requete($sql_req);
			$toto.=$sql_req.EOL;
			if($vf_c_echo!='ok') {$vf_c_retour.="-1".$sql_req.EOL;}
		}
		_graal_libere_requete_bd($result_01);
//echo $vf_c_retour;
//echo $toto;
echo('<quoi ');
//echo(' requete="'.fa_ent_xml($sql_req_ht_marchandise).'"');
echo(' genre_ligne="'."Totaux".'"');
echo(' base_brute="'.$total_base_brute.'"');
if ($total_remise==0){
	echo(' remise=""');
} else {
	echo(' remise="'.$total_remise.'"');
}
echo(' base_taxe="'.$total_ht.'"');
echo(' montant_taxe="'.round($total_taxe,2).'"');
echo(' ttc="'.round($total_ttc,2).'"');
echo('/>');
//  Acompte
$result = _graal_requete_bd($sql_req_acompte);
while ($row = mysql_fetch_assoc($result)) {
  if ($row['montant_avec_remise_pied']!=0){
    $netapayer=$total_ttc-$row['montant_avec_remise_pied'];
		echo('<quoi ');
    echo(' genre_ligne="'.fa_ent_xml($row['genre_ligne']).'"');
    echo(' ttc="'.$row['montant_avec_remise_pied'].'"');
  	echo('/>');
		echo('<quoi ');
    echo(' genre_ligne="'."Net à payer".'"');
    echo(' ttc="'.$netapayer.'"');
  	echo('/>');
  }
}
_graal_libere_requete_bd($result);
echo('</donnees>');
_graal_ferme_connexion();
?>
