<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_e_traitement=fa_recup_param('vl_e_traitement','1');
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
switch ($vl_e_traitement) { 
	case 8: //  Récupération des conditionnements dans les articles
    $vf_e_critere_cleunik=$vl_e_critere_cleunik;
	$sql_req = "SELECT distinct(conditionnement) as 'conditionnement' FROM $vl_c_base_origine.article where conditionnement not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by conditionnement order by conditionnement";
    $result = _graal_requete_bd($sql_req);
    $vf_c_echo='ok';
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['conditionnement'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['conditionnement'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    //echo $sql_req;
    break; 
  case 6: //  Récupération des familles dans les articles
    $vf_e_critere_cleunik=$vl_e_critere_cleunik;
    $sql_req = "SELECT distinct(f1.Famille) as 'famille',ifnull(f2.nom,f1.famille) as 'nomfamille' FROM $vl_c_base_origine.article f1 left join $vl_c_base_origine.famillearticle f2 on f1.Famille=f2.Code where famille not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) and famille <> '' group by famille order by famille";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['famille'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['nomfamille'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    //echo $sql_req;
    break;
   case 7: //  Récupération des types dans les articles
    $vf_e_critere_cleunik=$vl_e_critere_cleunik;
    $sql_req = "SELECT distinct(Type) as 'type' FROM $vl_c_base_origine.article where type not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by type order by type";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['type'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['type'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    break;
  case 1: //  Récupération des millesimes dans les articles
    $vf_e_critere_cleunik=1000;
    $sql_req = "SELECT distinct(Millesime) as 'millesime' FROM $vl_c_base_origine.article where millesime not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by millesime order by millesime";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['millesime'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['millesime'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    break;
  case 2: //  Récupération des couleurs dans les articles
    $vf_e_critere_cleunik=1001;
    $sql_req = "SELECT distinct(Couleur) as 'Couleur' FROM $vl_c_base_origine.article where Couleur not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by Couleur order by Couleur";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['Couleur'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['Couleur'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    break;
  case 3: //  Récupération des Types de vins dans les articles
    $vf_e_critere_cleunik=1002;
    $sql_req = "SELECT distinct(Typedevin) as 'Typedevin' FROM $vl_c_base_origine.article where Typedevin not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by Typedevin order by Typedevin";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)){
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['Typedevin'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['Typedevin'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    break;
  case 4: //  Récupération des Conditionnements dans les articles
    $vf_e_critere_cleunik=128;
    $sql_req = "SELECT distinct(Conditionnement) as 'Conditionnement' FROM $vl_c_base_origine.article where Conditionnement not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by Conditionnement order by Conditionnement";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['Conditionnement'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['Conditionnement'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    break;
  case 5: //  Récupération des Contenants dans les articles
    $vf_e_critere_cleunik=1004;
    $sql_req = "SELECT distinct(Contenant) as 'Contenant' FROM $vl_c_base_origine.article where Contenant not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=$vf_e_critere_cleunik) group by Contenant order by Contenant";
    $result = _graal_requete_bd($sql_req);
    while ($row = mysql_fetch_assoc($result)) {
      $vf_e_choix_cleunik=_graal_requete_max_choix_gestion();
      $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
      $sql_req_01 .=" critere_cleunik=$vf_e_critere_cleunik";
      $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
      $sql_req_01 .=",choix_code='".addslashes($row['Contenant'])."'";
      $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row['Contenant'])."'";
      $sql_req_01 .=",choix_actif=1";
      $result_01 = _graal_requete_bd($sql_req_01);
      if($result_01 === false) { $vf_c_echo=mysql_error($cnx) . $sql_req_01;} else {$vf_c_echo='ok';}
    }
    _graal_libere_requete_bd($result);
    break;
}
_graal_ferme_connexion();
echo($vf_c_echo);
?>
