<?php
include_once("_graal_var_portee.php");
$vl_c_id_vbox=fa_recup_param('vl_c_id_vbox','aai_acteurs_01');
_graal_requete_charge_varlib($vl_c_id_inc_interlocuteurs_01,$vl_e_uti_cleunik);
$vl_c_bdq_001=fa_recup_dico("bdq_001");
$vl_c_bdq_002=fa_recup_dico("bdq_002");
$vl_c_bdq_003=fa_recup_dico("bdq_003");
$vl_c_bdq_004=fa_recup_dico("bdq_004");
$vl_c_bdq_005=fa_recup_dico("bdq_005");
$vl_c_bdq_006=fa_recup_dico("bdq_006");
$vl_c_bdq_007=fa_recup_dico("bdq_007");
switch ($vl_c_id_arbre_inc_interlocuteurs_01) {
  case 'arbre_des_interlocuteurs':
    $vl_c_complement_nom="";
    break;
  case 'arbre_des_interlocuteurs_panier':
    $vl_c_complement_nom="_panier";
    break;
}
$vl_c_bloc_arbre_criteres_debut="";
$vl_c_bloc_arbre_criteres_corpus="";
$vl_c_bloc_arbre_criteres_fin="";
if ($vl_c_bloc_arbre_criteres==true){
	$vl_c_dico_00044=fa_recup_dico("dico_00044");
	switch ($vl_c_genreacteur) {
	  case "tousss": $vl_e_portee=$vl_e_acteur;break;  //  Tous les acteurs
	  case "110001": $vl_e_portee=$vl_e_procli;break;  //  prospects clients
	  case "110002": $vl_e_portee=$vl_e_profou;break;  //  prospects fournisseurs
	  case "110003": $vl_e_portee=$vl_e_client;break;  //  clients
	  case "110004": $vl_e_portee=$vl_e_fourni;break;  //  fournisseurs
	  case "110005": $vl_e_portee=$vl_e_autrac;break;  //  autres acteurs
	  case "110006": $vl_e_portee=$vl_e_actind;break;  //  acteurs indéterminés
	  case "110006_dupliq":$vl_e_portee=$vl_e_interl;break;
	}
	$sql_req_criteres="select f2.critere_denomination,f2.critere_cleunik,f1.* from _choix f1 left join _criteres f2 using (critere_cleunik) where f2.critere_cleunik<>0 and (critere_portee & $vl_e_portee and critere_portee & $vl_e_interl) order by f2.critere_cleunik,f1.choix_valeur_texte_01";
	$xml="";
	$vl_e_critere_cleunik=0;
  $res_uti=_graal_requete_bd($sql_req_criteres);
  while ($row_uti = mysql_fetch_assoc($res_uti)){
  	$critere_denomination=fa_ent_xml($row_uti['critere_denomination']);
		$choix_valeur_texte_01=fa_ent_xml($row_uti['choix_valeur_texte_01']);
		$choix_cleunik_action=fa_ent_xml($row_uti['choix_cleunik']);
  	if ($vl_e_critere_cleunik!=$row_uti['critere_cleunik']){
			$critere_cleunik_action=fa_ent_xml($row_uti['critere_cleunik']);
  		if ($vl_e_critere_cleunik!=0){
  			$xml.="</treechildren></treeitem>";
  		}
  		$xml.="<treeitem  container='true' old_open='true'><treerow><treecell label='$critere_denomination' _graal_choix_cleunik='0' _graal_critere_cleunik='$critere_cleunik_action'/></treerow><treechildren>";
  		$vl_e_critere_cleunik=$row_uti['critere_cleunik'];
  	}
		$xml .="<treeitem><treerow><treecell label='$choix_valeur_texte_01' _graal_choix_cleunik='$choix_cleunik_action' _graal_critere_cleunik='$critere_cleunik_action'/></treerow></treeitem>";
    /*
		if ($row_uti['critere_actif']==2) {$prop="pa obsolete";} else {$prop="pa";}
	  $xml .='<item label=" ' .fa_ent_xml($row_uti['denomination']). '" properties="'.$prop.'" url="_graal_fen_choix_criteres_actions.php?critere_cleunik='.$row_uti['cleunik'].'&#38;per='.$row_uti['critere_codechoixpertinent'].'"/>'.EOL;
	  */
  }
	_graal_libere_requete_bd($res_uti);
	$xml.="</treechildren></treeitem>";
	$xml .='</treechildren></tree>';
	
	$vl_c_bloc_arbre_criteres_debut="<hbox flex='1'>";
	$vl_c_bloc_arbre_criteres_corpus=<<<EOT
		<vbox >
		<radiogroup id='rdg_cherche_choix' value="3">
                <vbox flex="1">
								<hbox>
                  <radio observes="broadcaster_01" id='ra_cherche_choix_oui' label="Avec" value='1' />
                  <radio observes="broadcaster_01" id='ra_cherche_choix_non' label="Sans" value='2'/>
									<radio observes="broadcaster_01" id='ra_cherche_choix_ns' label="Ignoré" value='3' />
                </hbox>
								<hbox>
                  
                </hbox>
							</vbox>
              </radiogroup>
EOT;
	$vl_c_bloc_arbre_criteres_corpus.="<tree id='tb_choix_interlocuteurs' hidecolumnpicker='true' seltype='multiple' flex='1' ><treecols><treecol ignoreincolumnpicker='true' class='colname' flex='2' primary='true' hideheader='true'/></treecols><treechildren id='treeitems'>$xml</vbox><splitter/>";
	$vl_c_bloc_arbre_criteres_fin="</hbox>";
}
echo <<<END
$vl_c_bloc_arbre_criteres_debut
$vl_c_bloc_arbre_criteres_corpus
    <vbox id="$vl_c_id_vbox_inc_interlocuteurs_01" flex="1" class="overflow_01">
   <tree id="$vl_c_id_arbre_inc_interlocuteurs_01" enableColumnDrag="true" flex="1" flags="" ref="*" querytype="xml" datasources="" seltype="single" onselect="pf_sel_ligne(this);">
     <treecols>
      <treecol hidden="true" id="act_cleunik" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="typeacteur" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol hidden="true" id="int_cleunik" ignoreincolumnpicker="true" /><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="portee$vl_c_complement_nom" sort="?portee" hidden="false" label="$vl_c_bdq_001"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="raisonsoc$vl_c_complement_nom" sort="?raisonsoc" label="$vl_c_bdq_002"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="nc$vl_c_complement_nom" sort="?nc" label="$vl_c_bdq_003"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="civilite$vl_c_complement_nom" sort="?civilite" label="$vl_c_bdq_004"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="qui$vl_c_complement_nom" sort="?qui" label="$vl_c_bdq_005"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="codealphanum15$vl_c_complement_nom" sort="?codealphanum15" label="$vl_c_bdq_006"/><splitter class="tree-splitter" resizeafter="grow"/>
      <treecol id="mnemotechnique$vl_c_complement_nom" sort="?mnemotechnique" label="$vl_c_bdq_007"/><splitter class="tree-splitter" resizeafter="grow"/>
     </treecols>
     <template><query expr="*"/><action>
       <treechildren>
         <treeitem container="true" uri="?" seltype="single">
           <treerow>
             <treecell label="?act_cleunik"/>
             <treecell label="?typeacteur"/>
             <treecell label="?int_cleunik"/>
             <treecell label="?portee" properties="?properties"/>
             <treecell label="?raisonsoc" properties="?properties"/>
             <treecell label="?nc" properties="?properties"/>
             <treecell label="?civilite" properties="?properties"/>
             <treecell label="?qui" properties="?properties"/>
             <treecell label="?codealphanum15" properties="?properties"/>
             <treecell label="?mnemotechnique" properties="?properties"/>
           </treerow>
         </treeitem>
       </treechildren>
     </action></template>
   </tree>
  </vbox>
$vl_c_bloc_arbre_criteres_fin
END;
?>
