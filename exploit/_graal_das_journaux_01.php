<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_type=fa_recup_param("type","ventes");
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_type_dates=intval(fa_recup_param("selection_date","0"));
$vl_c_sortie=fa_recup_param("sortie","das");
$vl_c_format_date=fa_recup_param("vl_c_format_date","1");
$vl_c_nature_export=fa_recup_param("vl_c_nature_export","raf");
$vl_c_genre=fa_recup_param("genre","1");
switch ($vl_c_type_dates){
	case 0:
		$quelle_date_fact="f2.date_fact";
		$quelle_date_avoi="f2.date_avoi";
	break;
}
switch ($vl_c_type){
	case "ventes":$fichier_01="_docciaux_montants";$fichier_02="_faccli_entetes";$fichier_04="_avocli_entetes";$compte="compte_vente";
		$sql_req = "SELECT f2.code as facture,$quelle_date_fact as date_de_facture,"._graalsql_date("$quelle_date_fact")." as `date_de_facture_jj`,f3.raisonsoc as raison_sociale,";
		$sql_req.= " (case when f1.type=0 then f1.montant else 0 end) as debit,";
		$sql_req.= " (case when f1.type>0 then f1.montant else 0 end) as credit,";
		$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.intitule else f6.intitule end) as intitule_compta,";
		$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.code else f6.code end) as compte_compta,";
		$sql_req.= " f1.commercial_cleunik as raf01, f1.ordre as raf02";
		$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 using (action_cleunik) ";
		$sql_req.= " left join _acteurs f3 using(act_cleunik) left join _param_pc f4 on f1.pc_cleunik=f4.pc_cleunik ";
		$sql_req.= " left join _param_taxes f5 on f5.taxes_cleunik=f1.taxes_cleunik ";
		$sql_req.= " left join _param_pc f6 on f5.$compte=f6.pc_cleunik ";
		$sql_req.= " left join _echeancier f7 on f7.action_cleunik=f1.action_cleunik ";
		$sql_req.= " where 1=1 and f1.montant<>0 and ( $quelle_date_fact between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
		$sql_req.= " and f7.montant_du is not null";
		$sql_req.=" UNION ";
		switch ($vl_c_genre){
			case "1":	//	avoirs négatifs au débit
				$sql_req.= "SELECT f2.code as facture,$quelle_date_avoi as date_de_facture,"._graalsql_date("$quelle_date_avoi")." as `date_de_facture_jj`,f3.raisonsoc as raison_sociale,";
				$sql_req.= " (case when f1.type=0 then (f1.montant*-1) else 0 end) as debit,";
				$sql_req.= " (case when f1.type>0 then (f1.montant*-1) else 0 end) as credit,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.intitule else f6.intitule end) as intitule_compta,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.code else f6.code end) as compte_compta, ";
				$sql_req.= " f1.commercial_cleunik as raf01, f1.ordre as raf02";
				$sql_req.= " FROM $fichier_01 f1 left join $fichier_04 f2 using (action_cleunik) ";
				$sql_req.= " left join _acteurs f3 using(act_cleunik) left join _param_pc f4 on f1.pc_cleunik=f4.pc_cleunik ";
				$sql_req.= " left join _param_taxes f5 on f5.taxes_cleunik=f1.taxes_cleunik ";
				$sql_req.= " left join _param_pc f6 on f5.$compte=f6.pc_cleunik ";
				$sql_req.= " left join _echeancier f7 on f7.action_cleunik=f1.action_cleunik ";
				$sql_req.= " where 1=1 and f1.montant<>0 and ( $quelle_date_avoi between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
				$sql_req.= " and f7.montant_du is not null";
				break;
			case "2":	//	Avoirs positifs au crédit
				$sql_req.= "SELECT f2.code as facture,$quelle_date_avoi as date_de_facture,"._graalsql_date("$quelle_date_avoi")." as `date_de_facture_jj`,f3.raisonsoc as raison_sociale,";
				$sql_req.= " (case when f1.type>0 then (f1.montant) else 0 end) as debit,";
				$sql_req.= " (case when f1.type=0 then (f1.montant) else 0 end) as credit,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.intitule else f6.intitule end) as intitule_compta,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.code else f6.code end) as compte_compta, ";
				$sql_req.= " f1.commercial_cleunik as raf01, f1.ordre as raf02";
				$sql_req.= " FROM $fichier_01 f1 left join $fichier_04 f2 using (action_cleunik) ";
				$sql_req.= " left join _acteurs f3 using(act_cleunik) left join _param_pc f4 on f1.pc_cleunik=f4.pc_cleunik ";
				$sql_req.= " left join _param_taxes f5 on f5.taxes_cleunik=f1.taxes_cleunik ";
				$sql_req.= " left join _param_pc f6 on f5.$compte=f6.pc_cleunik ";
				$sql_req.= " left join _echeancier f7 on f7.action_cleunik=f1.action_cleunik ";
				$sql_req.= " where 1=1 and f1.montant<>0 and ( $quelle_date_avoi between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
				$sql_req.= " and f7.montant_du is not null";
				break;
		}

		$sql_req.= " order by facture,raf01,raf02";
		break;
	case "achats":$fichier_01="_docciaux_montants";$fichier_02="_facfou_entetes";$fichier_04="_avofou_entetes";$compte="compte_achat";
		$sql_req = "SELECT f2.code as facture,$quelle_date_fact as date_de_facture,"._graalsql_date("$quelle_date_fact")." as `date_de_facture_jj`,f3.raisonsoc as raison_sociale,";
		$sql_req.= " (case when f1.type=0 then f1.montant else 0 end) as credit,";
		$sql_req.= " (case when f1.type>0 then f1.montant else 0 end) as debit,";
		$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.intitule else f6.intitule end) as intitule_compta,";
		$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.code else f6.code end) as compte_compta,";
		$sql_req.= " f1.commercial_cleunik as raf01, f1.ordre as raf02";
		$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 using (action_cleunik) ";
		$sql_req.= " left join _acteurs f3 using(act_cleunik) left join _param_pc f4 on f1.pc_cleunik=f4.pc_cleunik ";
		$sql_req.= " left join _param_taxes f5 on f5.taxes_cleunik=f1.taxes_cleunik ";
		$sql_req.= " left join _param_pc f6 on f5.$compte=f6.pc_cleunik ";
		$sql_req.= " where 1=1 and f1.montant<>0 and ( $quelle_date_fact between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
		$sql_req.=" UNION ";
		switch ($vl_c_genre){
			case "1":	//	avoirs négatifs au débit
				$sql_req.= "SELECT f2.code as facture,$quelle_date_avoi as date_de_facture,"._graalsql_date("$quelle_date_avoi")." as `date_de_facture_jj`,f3.raisonsoc as raison_sociale,";
				$sql_req.= " (case when f1.type=0 then (f1.montant*-1) else 0 end) as debit,";
				$sql_req.= " (case when f1.type>0 then (f1.montant*-1) else 0 end) as credit,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.intitule else f6.intitule end) as intitule_compta,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.code else f6.code end) as compte_compta, ";
				$sql_req.= " f1.commercial_cleunik as raf01, f1.ordre as raf02";
				$sql_req.= " FROM $fichier_01 f1 left join $fichier_04 f2 using (action_cleunik) ";
				$sql_req.= " left join _acteurs f3 using(act_cleunik) left join _param_pc f4 on f1.pc_cleunik=f4.pc_cleunik ";
				$sql_req.= " left join _param_taxes f5 on f5.taxes_cleunik=f1.taxes_cleunik ";
				$sql_req.= " left join _param_pc f6 on f5.$compte=f6.pc_cleunik ";
				$sql_req.= " where 1=1 and f1.montant<>0 and ( $quelle_date_avoi between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
				break;
			case "2":	//	Avoirs positifs au crédit
				$sql_req.= "SELECT f2.code as facture,$quelle_date_avoi as date_de_facture,"._graalsql_date("$quelle_date_avoi")." as `date_de_facture_jj`,f3.raisonsoc as raison_sociale,";
				$sql_req.= " (case when f1.type>0 then (f1.montant) else 0 end) as debit,";
				$sql_req.= " (case when f1.type=0 then (f1.montant) else 0 end) as credit,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.intitule else f6.intitule end) as intitule_compta,";
				$sql_req.= " (case when f1.pc_cleunik<>-1 then f4.code else f6.code end) as compte_compta, ";
				$sql_req.= " f1.commercial_cleunik as raf01, f1.ordre as raf02";
				$sql_req.= " FROM $fichier_01 f1 left join $fichier_04 f2 using (action_cleunik) ";
				$sql_req.= " left join _acteurs f3 using(act_cleunik) left join _param_pc f4 on f1.pc_cleunik=f4.pc_cleunik ";
				$sql_req.= " left join _param_taxes f5 on f5.taxes_cleunik=f1.taxes_cleunik ";
				$sql_req.= " left join _param_pc f6 on f5.$compte=f6.pc_cleunik ";
				$sql_req.= " where 1=1 and f1.montant<>0 and ( $quelle_date_avoi between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
				break;
		}
		$sql_req.= " order by facture,raf01,raf02";
		break;
}
switch ($vl_c_sortie) {
 	case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
		exit();
		break;
	case "das":
    	$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		    echo(' facture="'.fa_ent_xml($row['facture']).'"');
			switch ($vl_c_format_date){
				case "2":
					echo(' date_de_facture="'.fa_ent_xml($row['date_de_facture']).'"');
					break;
				case "1":
					$jj=substr($row['date_de_facture_jj'],0,2);
					$mm=substr($row['date_de_facture_jj'],3,2);
					$aa=substr($row['date_de_facture_jj'],6,4);
					$date=$jj."/".$mm."/".$aa;
					//echo(' date_de_facture="'.fa_ent_xml($row['date_de_facture_jj']).'"');
					echo(' date_de_facture="'.$date.'"');
					break;
			}
		  	echo(' raison_sociale="'.fa_ent_xml($row['raison_sociale']).'"');
		 	$debit=fa_reel(fa_ent_xml($row['debit']),2);
		 	$val_debit=fa_ent_xml($row['debit'])*1000;
		 	if ($debit==0){$debit="";}
		  	echo(' debit="'.$debit.'"');
		  	printf(' val_debit="%011u"',$val_debit);
		  	$credit=fa_reel(fa_ent_xml($row['credit']),2);
		 	$val_credit=fa_ent_xml($row['credit'])*1000;
			if ($credit==0){$credit="";}
		  	echo(' credit="'.$credit.'"');
		  	printf(' val_credit="%011u"',$val_credit);
		  	echo(' intitule_compta="'.fa_ent_xml($row['intitule_compta']).'"');
		  	echo(' compte_compta="'.fa_ent_xml($row['compte_compta']).'"');
		   echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
		break;
	case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		switch ($vl_c_type) {
			case "ventes":$vl_c_id_fenetre="Fen_01081";break;
			case "achats":$vl_c_id_fenetre="Fen_01082";break;
		}
		_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
		$vl_c_bsq_101=fa_recup_dico("bsq_101");
		$vl_c_bsq_102=fa_recup_dico("bsq_102");
		$vl_c_bsq_103=fa_recup_dico("bsq_103");
		$vl_c_bsq_104=fa_recup_dico("bsq_104");
		$vl_c_bsq_105=fa_recup_dico("bsq_105");
		$vl_c_bsq_106=fa_recup_dico("bsq_106");
		$vl_c_bsq_107=fa_recup_dico("bsq_107");
		$vl_c_bsq_108=fa_recup_dico("bsq_108");$vl_c_bsq_108="Type";



		$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_bsq_107"));
		$result = _graal_requete_bd($sql_req);
		switch ($vl_c_nature_export){
			case "raf":
				$worksheet->write(0, 0, utf8_decode("$vl_c_bsq_101"));
				$worksheet->write(0, 1, utf8_decode("$vl_c_bsq_102"));
				$worksheet->write(0, 2, utf8_decode("$vl_c_bsq_103"));
				$worksheet->write(0, 3, utf8_decode("$vl_c_bsq_104"));
				$worksheet->write(0, 4, utf8_decode("$vl_c_bsq_105"));
				$worksheet->write(0, 5, utf8_decode("$vl_c_bsq_106"));
				$vl_e_noligne=1;
				break;
			case "ventes-01":
			case "achats-01":
				/*
				$worksheet->write(0, 0, utf8_decode("$vl_c_bsq_108"));
				$worksheet->write(0, 1, utf8_decode("$vl_c_bsq_101"));
				$worksheet->write(0, 2, utf8_decode("$vl_c_bsq_102"));
				$worksheet->write(0, 3, utf8_decode("$vl_c_bsq_103"));
				$worksheet->write(0, 4, utf8_decode("$vl_c_bsq_104"));
				$worksheet->write(0, 5, utf8_decode("$vl_c_bsq_105"));
				$worksheet->write(0, 6, utf8_decode("$vl_c_bsq_106"));
				*/
				$vl_e_noligne=0;
				break;
		}
		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			switch ($vl_c_nature_export){
				case "raf":
					break;
				case "ventes-01":
					$worksheet->write($vl_e_noligne, $j, "2");$j++;
					break;
				case "achats-01":
					$worksheet->write($vl_e_noligne, $j, "1");$j++;
					break;
			}
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['facture']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['compte_compta']));$j++;
			switch ($vl_c_format_date){
				case "2":
					$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_de_facture']));$j++;
					break;
				case "1":
					$jj=substr($row['date_de_facture_jj'],0,2);
					$mm=substr($row['date_de_facture_jj'],3,2);
					$aa=substr($row['date_de_facture_jj'],6,4);
					$date=$jj."/".$mm."/".$aa;
					$worksheet->write($vl_e_noligne, $j, utf8_decode($date));$j++;
					//$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_de_facture_jj']));$j++;
					break;
			}
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['intitule_compta']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['debit']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['credit']));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    break;

    case "excel_02":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		switch ($vl_c_type) {
			case "ventes":$vl_c_id_fenetre="Fen_01081";break;
			case "achats":$vl_c_id_fenetre="Fen_01082";break;
		}
		_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
		$vl_c_bsq_101=fa_recup_dico("bsq_101");
		$vl_c_bsq_102=fa_recup_dico("bsq_102");
		$vl_c_bsq_103=fa_recup_dico("bsq_103");
		$vl_c_bsq_104=fa_recup_dico("bsq_104");
		$vl_c_bsq_105=fa_recup_dico("bsq_105");
		$vl_c_bsq_106=fa_recup_dico("bsq_106");
		$vl_c_bsq_107=fa_recup_dico("bsq_107");
		$vl_c_bsq_108=fa_recup_dico("bsq_108");$vl_c_bsq_108="Type";



		$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_bsq_107"));
		$result = _graal_requete_bd($sql_req);
		switch ($vl_c_nature_export){
			case "raf":
				$worksheet->write(0, 0, utf8_decode("$vl_c_bsq_101"));
				$worksheet->write(0, 1, utf8_decode("$vl_c_bsq_102"));
				$worksheet->write(0, 2, utf8_decode("$vl_c_bsq_103"));
				$worksheet->write(0, 3, utf8_decode("$vl_c_bsq_104"));
				$worksheet->write(0, 4, utf8_decode("$vl_c_bsq_105"));
				$worksheet->write(0, 5, utf8_decode("$vl_c_bsq_106"));
				$vl_e_noligne=1;
				break;
			case "ventes-01":
			case "achats-01":
				/*
				$worksheet->write(0, 0, utf8_decode("$vl_c_bsq_108"));
				$worksheet->write(0, 1, utf8_decode("$vl_c_bsq_101"));
				$worksheet->write(0, 2, utf8_decode("$vl_c_bsq_102"));
				$worksheet->write(0, 3, utf8_decode("$vl_c_bsq_103"));
				$worksheet->write(0, 4, utf8_decode("$vl_c_bsq_104"));
				$worksheet->write(0, 5, utf8_decode("$vl_c_bsq_105"));
				$worksheet->write(0, 6, utf8_decode("$vl_c_bsq_106"));
				*/
				$vl_e_noligne=0;
				break;
		}
		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			switch ($vl_c_nature_export){
				case "raf":
					break;
				case "ventes-01":
					$worksheet->write($vl_e_noligne, $j, "2");$j++;
					break;
				case "achats-01":
					$worksheet->write($vl_e_noligne, $j, "1");$j++;
					break;
			}
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['facture']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['compte_compta']));$j++;
			switch ($vl_c_format_date){
				case "2":
					$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_de_facture']));$j++;
					break;
				case "1":
					$jj=substr($row['date_de_facture_jj'],0,2);
					$mm=substr($row['date_de_facture_jj'],3,2);
					$aa=substr($row['date_de_facture_jj'],6,4);
					$date=$jj."/".$mm."/".$aa;
					$worksheet->write($vl_e_noligne, $j, utf8_decode($date));$j++;
					//$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_de_facture_jj']));$j++;
					break;
			}
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['raison_sociale']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['debit']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['credit']));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    break;


}
?>
