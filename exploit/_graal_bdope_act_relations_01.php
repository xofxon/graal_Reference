<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_act_relation_01";
$t_origines_ok[1]="_graal_fen_act_relation_02";
$t_origines_ok[2]="_graal_fen_act_relation_03";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
//IMPORTANT IMPORTANT IMPORTANT IMPORTANT
//Bien penser à utiliser intval pour convertir les données numériques
//Bien penser à utiliser intval pour convertir les données numériques
//Bien penser à utiliser intval pour convertir les données numériques
$vl_act_cleunik_gauche=intval(fa_recup_param("vl_act_cleunik_gauche",""));
$vl_choix_cleunik_gauche=intval(fa_recup_param("vl_choix_cleunik_gauche",""));
$vl_choix_cleunik_droite=intval(fa_recup_param("vl_choix_cleunik_droite",""));
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_act_cleunik_droite=intval(fa_recup_param("vl_act_cleunik_droite",""));
$vl_act_ancienne=intval(fa_recup_param("vl_act_ancienne",""));
$vl_act_nouvelle=intval(fa_recup_param("vl_act_nouvelle",""));
$vl_t_act_droite=fa_recup_param("vl_t_act_droite","");
$vl_t_act_gauche=fa_recup_param("vl_t_act_gauche","");
$vl_t_cho_droite=fa_recup_param("vl_t_cho_droite","");
$vl_t_cho_gauche=fa_recup_param("vl_t_cho_gauche","");
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _acteurs_relations WHERE act_cleunik_gauche=$vl_act_cleunik_gauche AND choix_cleunik_gauche=$vl_choix_cleunik_gauche AND choix_cleunik_droite=$vl_choix_cleunik_droite AND act_cleunik_droite=$vl_act_cleunik_droite";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="";} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="ajouter":
    $sql_req = "INSERT INTO _acteurs_relations set act_cleunik_gauche=$vl_act_cleunik_gauche,choix_cleunik_gauche=$vl_choix_cleunik_gauche,choix_cleunik_droite=$vl_choix_cleunik_droite,blocnotebrut='$vl_blocnotebrut',act_cleunik_droite=$vl_act_cleunik_droite";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="";} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _acteurs_relations set blocnotebrut='$vl_blocnotebrut' WHERE act_cleunik_gauche=$vl_act_cleunik_gauche AND choix_cleunik_gauche=$vl_choix_cleunik_gauche AND choix_cleunik_droite=$vl_choix_cleunik_droite AND act_cleunik_droite=$vl_act_cleunik_droite";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="";} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="kilometres_supprimer";
    $vl_t_act_droite=unserialize(stripslashes($vl_t_act_droite));
    $vl_t_act_gauche=unserialize(stripslashes($vl_t_act_gauche));
    $vl_t_cho_droite=unserialize(stripslashes($vl_t_cho_droite));
    $vl_t_cho_gauche=unserialize(stripslashes($vl_t_cho_gauche));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_t_act_droite as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik_droite=$vl_t_act_droite[$vl_e_i];
      $vl_act_cleunik_gauche=$vl_t_act_gauche[$vl_e_i];
      $vl_choix_cleunik_droite=$vl_t_cho_droite[$vl_e_i];
      $vl_choix_cleunik_gauche=$vl_t_cho_gauche[$vl_e_i];
      $sql_req = "DELETE FROM _acteurs_relations WHERE act_cleunik_gauche=$vl_act_cleunik_gauche AND choix_cleunik_gauche=$vl_choix_cleunik_gauche AND choix_cleunik_droite=$vl_choix_cleunik_droite AND act_cleunik_droite=$vl_act_cleunik_droite";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    }
    if ($vl_b_transaction_ok==false) {echo 'La suppression des relations a échoué.'.$vl_c_mess_err;} else {echo 'La suppression des relations a été correctement effectuée.';}
    break;
  case $vf_c_action=="kilometres_remplacer";
    $vl_t_act_droite=unserialize(stripslashes($vl_t_act_droite));
    $vl_t_act_gauche=unserialize(stripslashes($vl_t_act_gauche));
    $vl_t_cho_droite=unserialize(stripslashes($vl_t_cho_droite));
    $vl_t_cho_gauche=unserialize(stripslashes($vl_t_cho_gauche));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_t_act_droite as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik_droite=$vl_t_act_droite[$vl_e_i];
      $vl_act_cleunik_gauche=$vl_t_act_gauche[$vl_e_i];
      $vl_choix_cleunik_droite=$vl_t_cho_droite[$vl_e_i];
      $vl_choix_cleunik_gauche=$vl_t_cho_gauche[$vl_e_i];
      if ($vl_act_ancienne==$vl_act_cleunik_gauche) {
        $sql_req = "UPDATE _acteurs_relations SET act_cleunik_gauche=$vl_act_nouvelle WHERE act_cleunik_gauche=$vl_act_cleunik_gauche AND choix_cleunik_gauche=$vl_choix_cleunik_gauche AND choix_cleunik_droite=$vl_choix_cleunik_droite AND act_cleunik_droite=$vl_act_cleunik_droite";
      }
      if ($vl_act_ancienne==$vl_act_cleunik_droite) {
        $sql_req = "UPDATE _acteurs_relations SET act_cleunik_droite=$vl_act_nouvelle WHERE act_cleunik_gauche=$vl_act_cleunik_gauche AND choix_cleunik_gauche=$vl_choix_cleunik_gauche AND choix_cleunik_droite=$vl_choix_cleunik_droite AND act_cleunik_droite=$vl_act_cleunik_droite";
      }

      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    }
    if ($vl_b_transaction_ok==false) {echo 'Le remplacement des relations a échoué.'.$vl_c_mess_err;} else {echo 'Le remplacement des relations a été correctement effectué.';}
    break;

  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
//echo $sql_req;
?>
