<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
include_once("_graal_fonctions_documents_ciaux.php");
include_once("_graal_fonctions_echeances.php");
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','ines_epac');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_epac');

session_write_close(); 


$vl_e_critere_cleunik=94;
$vl_e_val_defaut=-110100;

include("_import_ines_sp_array_tiers.php");
include("_import_ines_sp_array_tiers_contacts.php");

$vf_e_typeacteur=110006;
$sql_req = "SELECT distinct(CL_REF) as CL_REF";
$sql_req.= " FROM $vl_c_base_origine.factures";
$vl_e_i=0;
echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
	$code_acteur=sprintf("%d",$row['CL_REF']);
	$vl_e_trouve_acteur=array_search($code_acteur, $acteur_cod);
  	if ($vl_e_trouve_acteur===false) {
		echo $code_acteur." acteur pas trouvé".EOL;flush();
	} else {
		$vl_e_i++;
	}
}
echo $vf_c_echo.EOL;
_graal_libere_requete_bd($result);
echo ("Fin test 01 $vl_e_i trouvés");

$acteur_cod=array();$acteur_cle=array();
$sql_req="select act_cleunik as cleunik,codealphanum15 as code from $vl_c_base_destination._acteurs where typeacteur=110003;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($acteur_cod, $row['code']);
  array_push ($acteur_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$sql_req = "SELECT distinct(CL_REF) as CL_REF";
$sql_req.= " FROM $vl_c_base_origine.factures";
$vl_e_i=0;
echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
	$code_acteur=sprintf("%d",$row['CL_REF']);
	$vl_e_trouve_acteur=array_search($code_acteur, $acteur_cod);
  	if ($vl_e_trouve_acteur===false) {
		echo $code_acteur." acteur pas trouvé".EOL;flush();
		$autres.="'".$code_acteur."',";
	} else {
		$vl_e_i++;
		//echo $code_acteur." acteur trouvé".EOL;flush();
	}
}
echo $vf_c_echo.EOL;
_graal_libere_requete_bd($result);
echo ("Fin test 02 $vl_e_i trouvés".EOL);

$sql_req="select distinct(FL_REF) from $vl_c_base_origine.factures where FL_REF not in (select code from $vl_c_base_destination._article)";


$art_cod=array();$art_cle=array();
$sql_req="select art_cleunik,code from $vl_c_base_destination._article where code in(select distinct(FL_REF) from $vl_c_base_origine.factures)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);



$vl_e_i=0;
if (trim($autres)!=""){
	$autres=substr($autres, 0, -1);
	$sql_req="select act_cleunik as cleunik,codealphanum15 as code from $vl_c_base_destination._acteurs where codealphanum15 in($autres);";
	echo $sql_req.EOL;
	$result = _graal_requete_bd($sql_req);
	while ($row = mysql_fetch_assoc($result)) {
	  $sql_req_01 = "UPDATE $vl_c_base_destination._acteurs set typeacteur=110003 where act_cleunik=".$row['cleunik'];
	  $vf_c_echo=_graal_exec_requete($sql_req_01);
	  $vl_e_i++;
	}
	_graal_libere_requete_bd($result);
	$sql_req="update $vl_c_base_destination._act_choix_fixes f1 left join $vl_c_base_destination._acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.typeacteur=f2.typeacteur where f1.typeacteur<>f2.typeacteur;";
	$vf_c_echo=_graal_exec_requete($sql_req);
	echo ("Fin conversion acteurs $vl_e_i transformés");
}
$sql_req = "insert into _act_compta SELECT  f1.act_cleunik,f3.compte,f3.tvaintracommunautaire,f3.catcompta_cleunik,f3.encours_autorise,f3.tarif_cleunik,f3.remise_taux,";
$sql_req.= " f3.remise_type,f3.remise_genr,f3.escompte_taux,f3.escompte_type,f3.remise_natu,f3.reg_cleunik,f3.pc_cleunik,f3.assujetti_tpf,f3.montant_port,f3.seuil_franco,f3.commande_mini";
$sql_req.= " FROM _act_compta f3,_acteurs f1 left join _act_compta f2 on f1.act_cleunik=f2.act_cleunik  ";
$sql_req.= " where f3.act_cleunik=0 and f1.typeacteur=110003 and f2.act_cleunik is null;";    
$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}

$sql_req = "update _act_compta set remise_taux=1 where remise_taux is null;";
$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
$sql_req = "update _act_compta set escompte_taux=1 where escompte_taux is null;";
$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}

$sql_req = "SELECT distinct(fa_etat) as fa_etat FROM $vl_c_base_origine.factures where fa_etat not in (select choix_valeur_texte_01 from $vl_c_base_destination._choix where critere_cleunik=124)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_01 = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_01 .=" critere_cleunik=124";
  $sql_req_01 .=",choix_cleunik=$vf_e_choix_cleunik";
  //$sql_req_01 .=",choix_code='".addslashes($row['Nom'])."'";
  $sql_req_01 .=",choix_valeur_texte_01='".addslashes($row["fa_etat"])."'";
  $sql_req_01 .=",choix_actif=1";
  $sql_req_01 .=",choix_portee=1024";
  $i++;
  $result_01 = _graal_requete_bd($sql_req_01);
  if($result_01 === false) {$vf_c_echo.=mysql_error($cnx) . $sql_req_01.EOL;} else {$vf_c_echo.='ok';}
}
echo $vf_c_echo.EOL;
_graal_libere_requete_bd($result);


/*
 * Tableau des statuts des factures chez EPAC
 */
$t01_cod=array();$t01_cle=array();$t01_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=124";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t01_cod, $row['code']);
  array_push ($t01_cle, $row['cleunik']);
  array_push ($t01_tex, $row['text']);
}
_graal_libere_requete_bd($result);
$reg_cod=array();$reg_cle=array();
$sql_req="select reg_cleunik,description from $vl_c_base_destination._modereg;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($reg_des,$row['description']);
  array_push ($reg_cle, $row['reg_cleunik']);
}
_graal_libere_requete_bd($result);

$univen_cod=array();$univen_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_valeur_texte_01 as code from _choix where critere_cleunik=109"; //  On recherche les critères unité de vente
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($univen_cod, $row['code']);
  array_push ($univen_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
include("_import_ines_sp_array_tiers.php");
/*
var_dump($acteur_cod);
var_dump($acteur_cle);
*/

$sql_req_import = "SELECT Numéro,FA_REF,FL_INDEX,CL_REF,CL_NOM,FA_DATE,FA_EDITION,FA_DATE_REGLE,FA_ETAT,FA_CONDITION,FL_REF,FL_DESIGNATION,FL_PV,FL_TVA,FL_QTE,FL_UNIT,FL_REMISE ";
$sql_req_import.= " FROM $vl_c_base_origine.factures order by FA_REF";
//$sql_req_import.=" limit 5;";
$result_import = _graal_requete_bd($sql_req_import);
echo $sql_req_import.EOL;
$o_actions=new _graal_import();
$o_graal=new _graal_import();

$art_cod=array();$art_cle=array();$art_ind=array();$art_mne=array();$art_des=array();$art_ven=array();$art_tva=array();$art_tpf=array();$art_con=array();
$sql_req="select concat(a2.catcompta_cleunik,'-',a2.art_cleunik) as con,a2.art_cleunik as art_cleunik,code,indice,mnemotechnique,description,a2.pc_cleunik_vente,a2.taxes_cleunik,a2.tpf_cleunik ";
$sql_req.=" from _article left join _art_compta a2 on _article.art_cleunik=a2.art_cleunik;";
//echo $sql_req.EOL;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
  array_push ($art_ind, $row['indice']);
  array_push ($art_mne, $row['mnemotechnique']);
  array_push ($art_des, $row['description']);
  array_push ($art_ven, $row['pc_cleunik_vente']);
  array_push ($art_tva, $row['taxes_cleunik']);
  array_push ($art_tpf, $row['tpf_cleunik']);
  array_push ($art_con, $row['con']);
}
_graal_libere_requete_bd($result);
//var_dump($art_cod);
$o_lignes->req="INSERT INTO $vl_c_base_destination._faccli_lignes (commercial_ligne_cleunik,commercial_cleunik,ligne_cleunik,art_cleunik,code_interne,indice_interne,
mnemotechnique_interne,description_interne,typeligne,pu,pu_portee,pu_type,nbdec_pu,tarif_cleunik,remise_taux,remise_type,remise_genr,poidsbrut,tare,poidsnet,devise_taux,pr,blocnotebrut,
blocnoteriche,devise,longueur,largeur,epaisseur,unite_longueur,pc_cleunik,taxes_cleunik,tpf_cleunik,catcompta_cleunik) VALUES ";
$o_lignes_qte->req="INSERT INTO $vl_c_base_destination._faccli_lignes_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,unite_condi,qte_condi,nb_stock_in_condi,qte_deja)  VALUES ";
$commercial_ligne_cleunik=_graal_requete_max("commercial_ligne_cleunik","$vl_c_base_destination._faccli_lignes");
$ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$vl_c_base_destination._faccli__lignes_qte");


$sql_req_02="";
$sql_req_03="";
$i=0;$b=500;
$vf_e_action_cleunik=_graal_requete_max_particuliere("action_cleunik","_actions");
echo "dernier numéro action $vf_e_action_cleunik".EOL;flush();
$sujet_precedent="";





while ($row = mysql_fetch_assoc($result_import)) {
  
  $vf_e_act_cleunik=-1;
  $vf_e_int_cleunik=0;
  	$code_acteur=sprintf("%d",$row['CL_REF']);
	$vl_e_trouve_acteur=array_search($code_acteur, $acteur_cod);
  	if ($vl_e_trouve_acteur===false) {
		//echo $code_acteur." acteur pas trouvé".EOL;flush();
	} else {
		
		$sujet=fa_nt($row['FA_REF']);
		$FA_CONDITION=fa_nt($row['FA_CONDITION']);
	  	$FL_TVA=fa_nn_blanc($row['FL_TVA']);
	  	$FL_REF=fa_nn_blanc($row['FL_REF']);
	  	$FL_DESIGNATION=fa_nt($row['FL_DESIGNATION']);
	  	$FL_PV=fa_nn($row['FL_PV']);
	  	$FL_QTE=fa_nn($row['FL_QTE']);
	  	$FL_UNIT=fa_nn_blanc($row['FL_UNIT']);
		if ($sujet_precedent!=$sujet) {
			$vf_e_action_cleunik++;
			$ligne_cleunik=0;
	  		$vl_action_cleunik=$vf_e_action_cleunik;
			$vf_e_act_cleunik=$acteur_cle[$vl_e_trouve_acteur];
			$vf_e_int_cleunik=0;
			//echo $code_acteur." acteur trouvé clé unique $vf_e_act_cleunik indice $vl_e_trouve_acteur".EOL;flush();
			//echo $code_acteur." acteur trouvé".EOL;flush();
	  	//echo "cherche ".$row["VISITE_TYPE"].EOL;flush();
	  	$vl_e_trouve_choix=array_search($row["FA_ETAT"], $t01_tex);if ($vl_e_trouve_choix===false) {$choix_cleunik=-23;} else {$choix_cleunik=$t01_cle[$vl_e_trouve_choix];}
	  	$dateheuredebut=fa_nt($row['FA_DATE']);
	  	$dateheurefin=fa_nt($row['FA_DATE']);
	  	$dateheurecreation=fa_nt($row['FA_DATE']);
	  	$c_uuid=_graal_requete_uuid();
	  	
	  	$sujet_precedent=$sujet;
	  	$reference=fa_nt($row['FA_REF']);
	  	
	  	$o_actions->dat.="($vf_e_action_cleunik,-110112,$dateheuredebut,$dateheurefin,$dateheurecreation,$reference,'$c_uuid',$sujet,$choix_cleunik)";
	  	//echo $o_actions->dat.EOL;flush();
	  	$i++;
	  	$o_graal->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,$vf_e_action_cleunik,-110411,8192,2)";
	  	$vl_e_act_cleunik=$vf_e_act_cleunik;
	  	
			$sql_req = "SELECT f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu FROM _act_compta f1 left join _acteurs f2 using (act_cleunik) where f1.act_cleunik=$vl_e_act_cleunik";//  Recherche compte comptable
	        echo $sql_req.EOL;flush();
			$result = _graal_requete_bd($sql_req);
	        $row = mysql_fetch_assoc($result);
	        if (mysql_num_rows($result)==0) {
	        	
	          $vf_c_retour="-10 pas trouvé compta";
	          _graal_libere_requete_bd($result);
	          echo $vf_c_retour.EOL."***********************".EOL;flush();
	          exit;
	        } else {
	          $catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
	          $pc_cleunik=fa_nn($row['pc_cleunik']);
	          $remise_natu=fa_nn($row['remise_natu']);
	          _graal_libere_requete_bd($result);
	          if (($catcompta_cleunik==-1)||(is_null($row['catcompta_cleunik']))) {$catcompta_cleunik=10000006;echo "problème compta sur acteur".EOL;flush();}
	          //if ((($pc_cleunik==-1)||(is_null($row['pc_cleunik'])))&&($vs_enval==true)) {die(-12);}
	          if (($remise_natu==0)||(is_null($row['remise_natu']))||($remise_natu=="")) {$remise_natu=1;}
	        }
	    
	    $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.codealphanum15 as codealphanum15,_acteurs.raisonsoc as raisonsoc,_acteurs.nomcommercial as nomcommercial,_acteurs.siret as siret,_acteurs.blocnotebrut as blocnotebrut,_acteurs.blocnotertf as blocnotertf,_acteurs.dateheuremodif as dateheuremodif,_acteurs.dateheurevalidite as dateheurevalidite,_acteurs.dateheurecreation as dateheurecreation,_acteurs.typeacteur as typeacteur, _acteurs.c_uuid as uuid,_acteurs.mnemotechnique as mnemotechnique,_acteurs.modegestion as modegestion,_act_compta.tvaintracommunautaire as tvaintracommunautaire,_act_compta.encours_autorise as encours_autorise,_act_compta.catcompta_cleunik,_act_compta.tarif_cleunik as tarif_cleunik,_act_compta.remise_taux as remise_taux,_act_compta.remise_type as remise_type,_act_compta.remise_genr as remise_genr,escompte_taux as escompte_taux,escompte_type as escompte_type,_act_compta.remise_natu as remise_natu,_act_compta.reg_cleunik as reg_cleunik,pc_cleunik as pc_cleunik,_acteurs.actif as actif,_acteurs.devise as devise,_param_pc.code as nature_comptable,_param_pc.intitule,_act_compta.assujetti_tpf FROM _acteurs left join _act_compta using(act_cleunik) left join _param_pc using(pc_cleunik) where _acteurs.act_cleunik=$vl_e_act_cleunik";
	    //echo $sql_req.EOL;flush();
	    $result = _graal_requete_bd($sql_req);
	    $row = mysql_fetch_assoc($result);
	    $typeacteur=fa_nn($row['typeacteur']);
	    $nature_comptable=fa_nn($row['nature_comptable']);
	    $devise=fa_nn($row['devise']);
	    $tarif_cleunik=fa_nn($row['tarif_cleunik']);
	    $remise_taux=fa_nn($row['remise_taux']);
	    $remise_type=fa_nn($row['remise_type']);
	    $remise_genr=fa_nn($row['remise_genr']);
	    $escompte_taux=fa_nn($row['escompte_taux']);
	    $escompte_type=fa_nn($row['escompte_type']);
	    $remise_natu=fa_nn($row['remise_natu']);
	    //$catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
	    switch ($FL_TVA){
	    	case 3:$catcompta_cleunik=10000002;break;
	    	default:$catcompta_cleunik=10000006;break;
	    }
	    //$reg_cleunik=fa_nn($row['reg_cleunik']);
		$vl_e_trouve_reg=array_search($FA_CONDITION, $reg_des);if ($vl_e_trouve_reg===false) {$reg_cleunik=-1;} else {$reg_cleunik=$reg_cle[$vl_e_trouve_reg];}
	    $assujetti_tpf=fa_nn($row['assujetti_tpf']);
	    $frais_type=2;
	    $port_type=2;
	    $acompte_type=2;
	    $adr_nom=fa_nt($row['nomcommercial']);
	    if ($adr_nom=="''"){
	    	$adr_nom=fa_nt($row['raisonsoc']);
	    }
	    _graal_libere_requete_bd($result);
			$typpor=-93;
			//if ($param_generaux_graal_024==-1) {$typpor=-93;} else {$typpor=$param_generaux_graal_024;}
			if($typeacteur=="110003"&&$nature_comptable!="") {
	          $vf_e_choix_cleunik_doc=-110112;$vf_e_choix_cleunik_graal=-110411;$num_cleunik=4;
	          $table_entete="_faccli_entetes";
	          $table_adress="_faccli_adresses";
	          $table_repres="_faccli_representants";
	          $table_transp="_faccli_transporteurs";
				$blocnotebrut_entete="";
				$blocnotebrut_pied="";
				$fact_type="1";
				$compta_etat="1";
				$fact_genr="1";
				//echo "pret pour facture".EOL;flush();
	        } else {
	          echo "boom 1->typeacteur '$typeacteur' naturecomptable '$nature_comptable'".EOL;flush();
	          exit;
	        }
	    
	    
	    
	    $req_entete="INSERT INTO $table_entete (action_cleunik,commercial_cleunik,code,dateheurecreation,dateheuremodif,act_cleunik,devise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,catcompta_cleunik,reg_cleunik,frais_type,port_type,acompte_type,blocnotebrut_entete,blocnotebrut_pied,typpor,date_fact,fact_type,fact_genr,compta_etat,assujetti_tpf) VALUES ";
	    $req_graal="INSERT INTO _graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ";
	    $req_adresse="INSERT INTO $table_adress (adr_cleunik,commercial_cleunik,adr_nom,adr_complementnom,adr_ligne1,adr_ligne2,adr_ligne3,adr_cp,adr_ville,choix_cleunik,adr_latitude,adr_longitude,adr_typecoordonnees,adr_type) VALUES ";
	    $req_rep="INSERT INTO $table_repres (action_rep_cleunik,commercial_cleunik,action_rep_cleunik_reference,act_cleunik_rep,commission_typ,commission_taux,commission_fixe,commission_regle) VALUES ";
	    $req_transporteur="INSERT INTO $table_transp (action_trans_cleunik,commercial_cleunik,act_cleunik_trans) VALUES ";
	    $o_actions->req="INSERT INTO $vl_c_base_destination._actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurefin,dateheurecreation,reference,c_uuid,sujet,statut) VALUES ";
		$o_graal->req="INSERT INTO $vl_c_base_destination._graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ";
	    $vf_c_retour="";
	    //  Début de la transaction
	    //$deb_trans=_graal_requete_bd("START TRANSACTION;");
	    $result = _graal_exec_requete($o_actions->req.$o_actions->dat);
	    echo $result.EOL;flush();
	    $result = _graal_exec_requete($o_graal->req.$o_graal->dat);
	    $o_actions->req="";$o_actions->dat="";
	    $o_graal->req="";$o_graal->dat="";
	      //  Ajout entête
	      $vl_commercial_cleunik=_graal_requete_max("commercial_cleunik","$table_entete");
	      $req_entete.="($vl_action_cleunik,$vl_commercial_cleunik,$sujet,$dateheuredebut,$dateheuredebut,$vl_e_act_cleunik,$devise,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$escompte_taux,$escompte_type,$remise_natu,$catcompta_cleunik,$reg_cleunik,$frais_type,$port_type,$acompte_type,'$blocnotebrut_entete','$blocnotebrut_pied',$typpor,$dateheuredebut,$fact_type,$fact_genr,$compta_etat,$assujetti_tpf)";
		    
	      $vf_c_echo=_graal_exec_requete($req_entete);
	      if($vf_c_echo=='ok') {
	        //  Ajout relation acteur principal
	        $cond_graal="($vl_e_act_cleunik,0,$vl_action_cleunik,$vf_e_choix_cleunik_graal,8192,2)";
	        if(_graal_exec_requete($req_graal.$cond_graal)!="ok")  {$vf_c_retour=-3;}
			    
			//  Recherche de l'adresse de livraison : on prend la première que l'on trouve même s'il y en a plusieurs
	        $sql_req="Select * from _act_adresses where act_cleunik=$vl_e_act_cleunik and adr_typecoordonnees&2";
	        $result = _graal_requete_bd($sql_req);
	        if (mysql_num_rows($result)!=0) {
	          $row = mysql_fetch_assoc($result);
	          $vl_adr_cleunik=_graal_requete_max("adr_cleunik","$table_adress");
	          $adr_complementnom=fa_nt($row['adr_complementnom']);
	          $adr_ligne1=fa_nt($row['adr_ligne1']);
	          $adr_ligne2=fa_nt($row['adr_ligne2']);
	          $adr_ligne3=fa_nt($row['adr_ligne3']);
	          $adr_cp=fa_nt($row['adr_cp']);
	          $adr_ville=fa_nt($row['adr_ville']);
	          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
	          $adr_latitude=fa_nn($row['adr_latitude']);
	          $adr_longitude=fa_nn($row['adr_longitude']);
			  $adr_type=fa_nn($row['adr_type']);
	          $adr_typecoordonnees=1;
	          $cond_adresse="($vl_adr_cleunik,$vl_commercial_cleunik,$adr_nom,$adr_complementnom,$adr_ligne1,$adr_ligne2,$adr_ligne3,$adr_cp,$adr_ville,$vl_pays_cleunik,$adr_latitude,$adr_longitude,$adr_typecoordonnees,$adr_type)";
	          if(_graal_exec_requete($req_adresse.$cond_adresse)!="ok") {$vf_c_retour=-5;}
	        }
	        _graal_libere_requete_bd($result);
			    
	        //  Recherche de l'adresse de facturation  : on prend la première que l'on trouve même s'il y en a plusieurs
	        $sql_req="Select * from _act_adresses where act_cleunik=$vl_e_act_cleunik and adr_typecoordonnees&1";
	        $result = _graal_requete_bd($sql_req);
	        if (mysql_num_rows($result)!=0) {
	          $row = mysql_fetch_assoc($result);
	          $vl_adr_cleunik=_graal_requete_max("adr_cleunik","$table_adress");
	          $adr_complementnom=fa_nt($row['adr_complementnom']);
	          $adr_ligne1=fa_nt($row['adr_ligne1']);
	          $adr_ligne2=fa_nt($row['adr_ligne2']);
	          $adr_ligne3=fa_nt($row['adr_ligne3']);
	          $adr_cp=fa_nt($row['adr_cp']);
	          $adr_ville=fa_nt($row['adr_ville']);
	          $vl_pays_cleunik=fa_nn($row['choix_cleunik']);
	          $adr_latitude=fa_nn($row['adr_latitude']);
	          $adr_longitude=fa_nn($row['adr_longitude']);
			  $adr_type=fa_nn($row['adr_type']);
	          $adr_typecoordonnees=2;
	          $cond_adresse="($vl_adr_cleunik,$vl_commercial_cleunik,$adr_nom,$adr_complementnom,$adr_ligne1,$adr_ligne2,$adr_ligne3,$adr_cp,$adr_ville,$vl_pays_cleunik,$adr_latitude,$adr_longitude,$adr_typecoordonnees,$adr_type)";
	          if (_graal_exec_requete($req_adresse.$cond_adresse)!="ok") {$vf_c_retour=-6;}
	        }
	        _graal_libere_requete_bd($result);
	      $sql_req="select act_cleunik_gauche as act_cleunik,ifnull(commission_typ,1) as commission_typ,ifnull(commission_taux,0) as commission_taux,ifnull(commission_fixe,0) as commission_fixe,commission_regle from _acteurs_representants where act_cleunik_droite=$vl_e_act_cleunik union select act_cleunik_droite as act_cleunik,ifnull(commission_typ,1) as commission_typ,ifnull(commission_taux,0) as commission_taux,ifnull(commission_fixe,0) as commission_fixe,commission_regle from _acteurs_representants where act_cleunik_gauche=$vl_e_act_cleunik;";
	            $result = _graal_requete_bd($sql_req);
	            while ($row = mysql_fetch_assoc($result)) {
	              $vl_action_rep_cleunik=_graal_requete_max("action_rep_cleunik","$table_repres");
	              $act_cleunik_rep=$row['act_cleunik'];
	              $commission_typ=$row['commission_typ'];
	              $commission_taux=$row['commission_taux'];
	              $commission_fixe=$row['commission_fixe'];
	              $commission_regle=$row['commission_regle'];
	              $cond_rep="($vl_action_rep_cleunik,$vl_commercial_cleunik,$vl_action_rep_cleunik,$act_cleunik_rep,$commission_typ,$commission_taux,$commission_fixe,$commission_regle)";
	              if(_graal_exec_requete($req_rep.$cond_rep)!="ok")  {$vf_c_retour=-13;}
	              $cond_graal="($act_cleunik_rep,0,$vl_action_cleunik,-110427,8192,1)";
	              if(_graal_exec_requete($req_graal.$cond_graal)!="ok")  {$vf_c_retour=-7;}
	            }
		      } else {
		      	echo $vf_c_echo.EOL;flush();
		      }
		}
		/*
		 * Traitement des lignes
		 */
	$commercial_ligne_cleunik++;
    $ligne_qte_cleunik++;
    $i++;
    $commercial_cleunik=$vl_commercial_cleunik;
    //$devise=$doc_dev[$vl_e_trouve];
    $dateheure_demande=$dateheuredebut;
    $dateheure_confirm=$dateheuredebut;
    $ligne_cleunik++;
    $ligne_qte_cleunik++;
    $vl_e_trouve=array_search($FL_REF, $art_cod);
    if ($vl_e_trouve===false) {
      $art_cleunik=0;
    } else {
      $art_cleunik=$art_cle[$vl_e_trouve];
    }
  	$concat=$catcompta_cleunik."-".$art_cleunik;
  	//echo "article $FL_REF cherche $concat.EOL";flush();
  	$vl_e_trouve=array_search($concat, $art_con);
    if ($vl_e_trouve===false) {
      $art_cleunik=0;
      $code_interne="'".addslashes($FL_REF)."'";
      $indice_interne="' '";
      $mnemotechnique_interne="'".addslashes($FL_REF)."'";
      $description_interne=$FL_DESIGNATION;
      $pc_cleunik=-1;
      $taxes_cleunik=-1;
      $tpf_cleunik=-1;
      
      //echo "pas trouvé article".EOL;
    } else {
      //echo "trouvé article".EOL;
      $art_cleunik=$art_cle[$vl_e_trouve];
      $code_interne="'".addslashes($art_cod[$vl_e_trouve])."'";
      $indice_interne="'".addslashes($art_ind[$vl_e_trouve])."'";
      $mnemotechnique_interne="'".addslashes($art_mne[$vl_e_trouve])."'";
      $description_interne="'".addslashes($art_des[$vl_e_trouve])."'";
      $pc_cleunik=$art_ven[$vl_e_trouve];
      $taxes_cleunik=$art_tva[$vl_e_trouve];
      $tpf_cleunik=$art_tpf[$vl_e_trouve];
      //echo "trouvé article taxe $taxes_cleunik".EOL;
    }
    $typeligne="-";
    $qte=$FL_QTE;
    $qte_deja=0;
    $qte_nbdec=2;
    $qte_unite_defaut=-36;
    $vl_e_trouve_univen=array_search($FL_UNIT, $univen_cod);if ($vl_e_trouve_univen===false) {$qte_unite=$qte_unite_defaut;} else {$qte_unite=$univen_cle[$vl_e_trouve_univen];}
    $pu=$FL_PV;
    $pu_portee=1;
    $pu_type=1;
    $nbdec_pu=2;
    $tarif_defaut=-33;
    $tarif_cleunik=$tarif_defaut;
    $remise_taux=0;
    $remise_type=1;
    $remise_genr=1;
    $poidsbrut=0;
    $tare=0;
    $poidsnet=0;
    $devise_taux=1;
    $pr=0;
    $statut=1;
    $unite_condi=-37;
    $qte_condi=0;
    $nb_stock_in_condi=1;
    $blocnotebrut=$FL_DESIGNATION;
    $blocnoteriche='';
    
    $statut=-39;
    $longueur=0;
    $largeur=0;
    $epaisseur=0;
    $unite_longueur=-90;	//	Millimètres
    $o_lignes->dat="($commercial_ligne_cleunik,$commercial_cleunik,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,$description_interne,
    '$typeligne',$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,$blocnotebrut,'$blocnoteriche',
    $devise,$longueur,$largeur,$epaisseur,$unite_longueur,$pc_cleunik,$taxes_cleunik,$tpf_cleunik,$catcompta_cleunik)";
    $o_lignes_qte->dat="($commercial_ligne_cleunik,$ligne_cleunik,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,$dateheure_demande,$dateheure_confirm,$statut,$unite_condi,$qte_condi,$nb_stock_in_condi,$qte_deja)";
    $result = _graal_exec_requete($o_lignes->req.$o_lignes->dat);
	//echo $o_lignes->req.$o_lignes->dat;  
    echo $result.EOL;flush();
	    $result = _graal_exec_requete($o_lignes_qte->req.$o_lignes_qte->dat);
	    echo $result.EOL;flush();
	    $o_lignes->dat="";
	    $o_lignes_qte->dat="";
		
		
		
	}
  	
	  
}
_graal_libere_requete_bd($result_import);
echo "Calcul échéances".EOL;flush();
fa_calcule_echeance_kilometres("faccli");
echo "début Calcul montants".EOL;flush();
  	fa_maj_prepa_compta("faccli","montants",-4,-4,"",2000);
  	echo "fin Calcul montants".EOL;flush();
  	
_graal_ferme_connexion();
echo($vf_c_echo);
?>
