<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_echeances.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_modes_reglements_01";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_reg_cleunik=intval(fa_recup_param("vl_reg_cleunik",-1));
$vl_nbjour=intval(fa_recup_param("vl_nbjour",0));
$vl_jour=intval(fa_recup_param("vl_jour",0));
$vl_mode_paiement=intval(fa_recup_param("vl_mode_paiement",-91));
$vl_type_paiement=intval(fa_recup_param("vl_type_paiement",-92));
$vl_moisentier=intval(fa_recup_param("vl_moisentier",2));
$vl_actif=intval(fa_recup_param("vl_actif",1));
$vl_codealphanum15=fa_recup_param("vl_codealphanum15","");
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_description=fa_recup_param("vl_description","");
$vl_dat_fac=fa_recup_param('vl_dat_fac','');
$vl_base=intval(fa_recup_param("vl_base",1));
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _modereg WHERE reg_cleunik = $vl_reg_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_reg_cleunik;} else {$vf_c_echo=-2;}
    break;
  case $vf_c_action=="ajouter":
    $vl_reg_cleunik=_graal_requete_max("reg_cleunik","_modereg");
    $sql_req = "INSERT INTO _modereg set reg_cleunik=$vl_reg_cleunik,codealphanum15='$vl_codealphanum15',dateheurecreation=now(),blocnotebrut='$vl_blocnotebrut',description='$vl_description',actif=$vl_actif;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $sql_req = "INSERT INTO _modereg_det set reg_cleunik=$vl_reg_cleunik,noligne=1,pourcentage=100,jour=$vl_jour,nbjour=$vl_nbjour,mode_paiement=$vl_mode_paiement,type_paiement=$vl_type_paiement,moisentier=$vl_moisentier,base=$vl_base;";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo=='ok') {
        $vf_c_echo=$vl_e_reg_cleunik;
      } else {
        $vf_c_echo=-2;
      }
    } else {
      $vf_c_echo=-2;
    }
    break;
  case $vf_c_action=="modifier":
    $sql_req = "update _modereg,_modereg_det set codealphanum15='$vl_codealphanum15',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut',description='$vl_description',actif=$vl_actif,jour=$vl_jour,nbjour=$vl_nbjour,mode_paiement=$vl_mode_paiement,type_paiement=$vl_type_paiement,moisentier=$vl_moisentier,base=$vl_base where _modereg_det.reg_cleunik=$vl_reg_cleunik and _modereg.reg_cleunik=$vl_reg_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_reg_cleunik;}  else {$vf_c_echo="-2";}
    break;
  case "verifier":
  	$vf_c_echo="Echeance pour $vl_dat_fac : ".date("d-m-Y",fa_calcul_echeance($vl_reg_cleunik,$vl_dat_fac));
  	break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
