<?php
switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retcli":
  case "retfou":
  case "relfou":	//	en fait, au 30 janvier 2010, pas géré car édition pas chiffrée
  	/*
  	 * Problème découvert le 17 novembre avec les remises lignes et _vue_".$genreaction."_ht_00

    $fichier_01="_".$genreaction."_entetes";
    $fichier_02="_vue_".$genreaction."_ht_00";
    $fichier_03="_vue_".$genreaction."_ht_00_inter";
    */
  	$fichier_01="_".$genreaction."_entetes";
    $fichier_02="_vue_".$genreaction."_ht_03";
    $fichier_03="_vue_".$genreaction."_ht_00_inter";
    $fichier_04="_".$genreaction."_lignes";
    $fichier_05="_".$genreaction."_lignes_qte";
    break;
  case "avocli":
	case "avofin":
		/*
  	 * Problème découvert le 17 novembre avec les remises lignes et _vue_".$genreaction."_ht_00

    $fichier_01="_avocli_entetes";
    $fichier_02="_vue_avocli_ht_00";
    $fichier_03="_vue_avocli_ht_00_inter";
    */
	$fichier_01="_avocli_entetes";
    $fichier_02="_vue_avocli_ht_03";
    $fichier_03="_vue_avocli_ht_00_inter";
    $fichier_04="_avocli_lignes";
    $fichier_05="_avocli_lignes_qte";
    break;
  case "avofou":
	case "avofif":
		/*
  	 * Problème découvert le 17 novembre avec les remises lignes et _vue_".$genreaction."_ht_00

    $fichier_01="_avocli_entetes";
    $fichier_02="_vue_avocli_ht_00";
    $fichier_03="_vue_avocli_ht_00_inter";
    */
	$fichier_01="_avofou_entetes";
    $fichier_02="_vue_avofou_ht_03";
    $fichier_03="_vue_avofou_ht_00_inter";
    $fichier_04="_avofou_lignes";
    $fichier_05="_avofou_lignes_qte";
    break;
  default:
    $fichier_01="foireux";
    $fichier_02="foireux";
    break;  //  Toutes les actions génériques
}
switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "retcli":
  case "avocli":
  case "avofin":
  	$comptes_port=" a2.compte_vente_port AS pc_cleunik,a2.taxes_vente_port AS taxes_cleunik ";
  	$jointur_port=" a2.taxes_vente_port ";
  	$comptes_dive=" a2.compte_vente_divers AS pc_cleunik,a2.taxes_vente_divers AS taxes_cleunik ";
  	$jointur_dive="a2.taxes_vente_divers ";
  	$tparafiscale=" a3.compte_vente AS pc_cleunik ";
  	break;
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retfou":
  case "relfou":
  case "avofou":
  case "avofif":
  	$comptes_port=" a2.compte_achat_port AS pc_cleunik,a2.taxes_achat_port AS taxes_cleunik ";
  	$jointur_port=" a2.taxes_achat_port ";
  	$comptes_dive=" a2.compte_achat_divers AS pc_cleunik,a2.taxes_achat_divers AS taxes_cleunik ";
  	$jointur_dive="a2.taxes_achat_divers ";
  	$tparafiscale=" a3.compte_achat AS pc_cleunik ";
    break;


}

switch ($genreregroupement) {
	case "initial":
		$regroupement_01=" group by a1.taxes_cleunik,a1.commercial_cleunik,a2.total_doc ";
		$regroupement_02=" group by a1.taxes_cleunik,a1.commercial_cleunik,a1.nombredelignes,a2.total_doc ";
		break;
	case "compta_ht":
		$regroupement_01=" group by a1.pc_cleunik";
		$regroupement_02=" group by a1.pc_cleunik";
		break;
	case "compta_tva":
		$regroupement_01=" group by a1.taxes_cleunik";
		$regroupement_02=" group by a1.taxes_cleunik";
		break;

}
$sql_req_ht_marchandise = <<<EOT
select a1.commercial_cleunik AS commercial_cleunik,round(sum(a1.htbrutremise)*100/a2.total_doc,2) as pourcentage,round(a2.total_doc,2) as total_doc,round(sum(a1.htbrutremise),2) AS htbrutremise,round((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end),2) AS montantremise_pied,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,a4.denomination as denomination_taxe,round(a4.taux,1) as taux_taxe,round(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*(a4.taux/100),5) AS montant_taxe,0 as nombredelignes,'Marchandises' as genre_ligne from $fichier_02 a1 left join $fichier_03 a2 using(commercial_cleunik) left join $fichier_01 a3 using(commercial_cleunik) left join _param_taxes a4 on a1.taxes_cleunik=a4.taxes_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik and a3.remise_genr=2 $regroupement_01
 union all
 select a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,round(sum(a1.htbrutremise),2) AS htbrutremise,round((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end),2) AS montantremise_pied,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,a1.pc_cleunik AS pc_cleunik,a1.taxes_cleunik AS taxes_cleunik,a4.denomination as denomination_taxe,round(a4.taux,1) as taux_taxe,round(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*(a4.taux/100),5) AS montant_taxe,a1.nombredelignes as nombredelignes,'Marchandises' as genre_ligne from $fichier_02 a1 left join $fichier_03 a2 using(commercial_cleunik) left join $fichier_01 a3 using(commercial_cleunik) left join _param_taxes a4 on a1.taxes_cleunik=a4.taxes_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik and a3.remise_genr=1 $regroupement_02;
EOT;
$sql_req_port = <<<EOT
select a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,0 AS htbrutremise,0 AS montantremise_pied,(case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(*base_ht**a1.port_taux/100,2) end) else round(a1.port_taux,2) end) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,$comptes_port,a4.denomination as denomination_taxe,round(a4.taux,1) as taux_taxe,round((case a1.port_type when 1 then (case a1.port_taux when 0 then 0 else round(*base_ht**a1.port_taux/100,2) end) else round(a1.port_taux,2) end)*(a4.taux/100),5) as montant_taxe,0 as nombredelignes,"Port" as genre_ligne from $fichier_01 a1 left join _param_categories_compta a2 using (catcompta_cleunik) left join _param_taxes a4 on $jointur_port=a4.taxes_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik
EOT;
$sql_req_frais = <<<EOT
select a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,0 AS htbrutremise,0 AS montantremise_pied,(case a1.frais_type when 1 then (case a1.frais_taux when 0 then 0 else round(*base_ht**a1.frais_taux/100,2) end) else round(a1.frais_taux,2) end) as montant_avec_remise_pied,a1.catcompta_cleunik AS catcompta_cleunik,$comptes_dive,a4.denomination as denomination_taxe,round(a4.taux,1) as taux_taxe,round((case a1.frais_type when 1 then (case a1.frais_taux when 0 then 0 else round(*base_ht**a1.frais_taux/100,2) end) else round(a1.frais_taux,2) end)*(a4.taux/100),5) as montant_taxe,0 as nombredelignes,"Frais" as genre_ligne from $fichier_01 a1 left join _param_categories_compta a2 using (catcompta_cleunik) left join _param_taxes a4 on $jointur_dive =a4.taxes_cleunik where a1.commercial_cleunik=$vl_commercial_cleunik
EOT;
$sql_req_acompte = <<<EOT
select a1.commercial_cleunik AS commercial_cleunik,0 as pourcentage,0 as total_doc,0 AS htbrutremise,0 AS montantremise_pied,(case a1.acompte_type when 1 then (case a1.acompte_taux when 0 then 0 else round($base_ht*a1.acompte_taux/100,2) end) else round(a1.acompte_taux,2) end) as montant_avec_remise_pied,-1 AS catcompta_cleunik,-1 AS pc_cleunik,-1 AS taxes_cleunik,'' as denomination_taxe,0 as taux_taxe,0 as montant_taxe,0 as nombredelignes,"Acompte" as genre_ligne from $fichier_01 a1 where a1.commercial_cleunik=$vl_commercial_cleunik
EOT;
$sql_req_parafiscale ="select '1° taxe parafiscale' as genre_ligne,a1.commercial_cleunik,a1.tpf_cleunik,round((sum(a2.qte)*a3.valeur_base),2) as montant_avec_remise_pied,round(((sum(a2.qte)*a3.valeur_base) *(a4.taux/100)),5) as montant_taxe,";
$sql_req_parafiscale.="a3.denomination as denomination_taxe,round(a4.taux,1) as taux_taxe,a3.taxes_cleunik,";
$sql_req_parafiscale.="$tparafiscale,a5.catcompta_cleunik AS catcompta_cleunik";
$sql_req_parafiscale.=" from $fichier_04 a1 left join $fichier_05 a2 using(commercial_ligne_cleunik) left join _param_tpf a3 using(tpf_cleunik) ";
$sql_req_parafiscale.=" left join _param_taxes a4 on a3.taxes_cleunik=a4.taxes_cleunik left join $fichier_01 a5 on a5.commercial_cleunik=a1.commercial_cleunik";
$sql_req_parafiscale.=" where a1.commercial_cleunik=$vl_commercial_cleunik and a1.tpf_cleunik<>-1 and a5.assujetti_tpf=1 and a1.coef_facture <> 0 ";
$sql_req_parafiscale.=" group by a1.tpf_cleunik";
$sql_req_parafiscale.=" UNION ALL ";
$sql_req_parafiscale.="select '2° taxe parafiscale' as genre_ligne,a1.commercial_cleunik,a1.tpf_cleunik_01,round((sum(a2.qte)*a3.valeur_base),2) as montant_avec_remise_pied,round(((sum(a2.qte)*a3.valeur_base) *(a4.taux/100)),5) as montant_taxe,";
$sql_req_parafiscale.="a3.denomination as denomination_taxe,round(a4.taux,1) as taux_taxe,a3.taxes_cleunik,";
$sql_req_parafiscale.="$tparafiscale,a5.catcompta_cleunik AS catcompta_cleunik";
$sql_req_parafiscale.=" from $fichier_04 a1 left join $fichier_05 a2 using(commercial_ligne_cleunik) left join _param_tpf a3 on a3.tpf_cleunik=a1.tpf_cleunik_01 ";
$sql_req_parafiscale.=" left join _param_taxes a4 on a3.taxes_cleunik=a4.taxes_cleunik left join $fichier_01 a5 on a5.commercial_cleunik=a1.commercial_cleunik";
$sql_req_parafiscale.=" where a1.commercial_cleunik=$vl_commercial_cleunik and a1.tpf_cleunik_01<>-1 and a5.assujetti_tpf=1 and a1.coef_facture <> 0 ";
$sql_req_parafiscale.=" group by a1.tpf_cleunik_01";

$sql_req_tva ="select sum(a1.montant) as base,round(sum(a1.montant)*a2.taux/100,2) as tva,a2.taux,a1.taxes_cleunik,a1.catcompta_cleunik";
$sql_req_tva.=" from _docciaux_montants a1 left join _param_taxes a2 using(taxes_cleunik) ";
$sql_req_tva.=" where a1.action_cleunik=$vl_action_cleunik and a1.taxes_cleunik<>-1 and a1.pc_cleunik<> -1 group by a1.taxes_cleunik";
$sql_req_tva_montant ="select sum(a1.montant) as base,round(sum(a1.montant)*a2.taux/100,2) as tva,a2.taux,a1.taxes_cleunik,a1.catcompta_cleunik";
$sql_req_tva_montant.=" from _docciaux_montants a1 left join _param_taxes a2 using(taxes_cleunik) ";
$sql_req_tva_montant.=" where a1.action_cleunik=$vl_action_cleunik and a1.taxes_cleunik<>-1 and a1.pc_cleunik<> -1 group by a1.taxes_cleunik";
?>
