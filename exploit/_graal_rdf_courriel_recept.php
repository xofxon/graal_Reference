<?php
include("_graal_header_xml.inc.php");
require("_graal_fonctions_mail.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
$vl_e_integre=fa_recup_param('vl_e_integre','2');
$vl_e_quel_statut=intval(fa_recup_param('vl_e_quel_statut','2'));
$uticptbal_cleunik=intval(fa_recup_param('uticptbal_cleunik',0));
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_type_date=intval(fa_recup_param('type_date','1'));
$vl_e_marque=intval(fa_recup_param('vl_e_marque','1'));
$vl_e_courriel_brut_cleunik=intval(fa_recup_param('vl_e_courriel_brut_cleunik','0'));
$vl_tb_reg_00002=_graal_requete_regle("Reg_00002"); //  Règle qui détermine si on doit Inclure les acteurs / interlocuteurs inactifs en réception de courriel
$vl_b_integre_inactifs=$vl_tb_reg_00002[0];
$sess_id=session_id();
set_time_limit(6000);
error_reporting(E_ALL ^ E_WARNING ^ E_NOTICE); //  On désactive temporairement les warnings parce que parfois le iconv_mime_decode renvoie une erreur
define('EOL', "\r\n");
$liste_ref=array();$liste_gen=array();
$sql_req="SELECT refweb,genre from _courriel_re_listes;"; //  On recherche la liste 
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($liste_ref, $row['refweb']);
  array_push ($liste_gen, $row['genre']);
}
_graal_libere_requete_bd($result);
// execution de la requète SQL
switch ($vl_e_integre) {
  case '0'      : $limit=" limit 1"  ;break; //  La dernière récupération
  case '-3'     : $limit=" limit 3"  ;break; //  Les 3 dernières récupération
  case '-5'     : $limit=" limit 5"  ;break; //  Les 5 dernières récupération  
  case '-10'    : $limit=" limit 10" ;break; //  Les 10 dernières récupération
  case 'toutes' : $limit=""   ;break; //  Pas de limites
  case 'dates'  : $limit=""   ;break; //  Pas de limites
  case 'cle'    : $limit=""   ;break; //  Pas de limites
} 
switch ($vl_e_quel_statut) {
  case 0  : $vl_c_integre="1,2,3,4" ;break;
  case 1  : $vl_c_integre="1"       ;break;
  case 2  : $vl_c_integre="2"       ;break;
  case 3  : $vl_c_integre="3"       ;break;
  case 4  : $vl_c_integre="4"       ;break;
}
switch ($vl_e_marque) {
  case 1 : $vl_c_marque =" and marquage =1 ";break;      // courriels marqués 
  case 2 : $vl_c_marque =" and marquage is NULL ";break;   // courriels pas marqués
  case 3 : $vl_c_marque ="";break;                      // Tous les courriels

}
$sql_req="select courriel_brut_cleunik,courriel,hash,integre,idpop,sequence,marquage,dateheurereception,"._graalsql_date('dateheurereception')." as date_recep,"._graalsql_time('dateheurereception')." as heur_recep from _courriel_recus_brut"; 
switch ($vl_e_integre) {
  case '0'  : case '-3' : case '-5' : case '-10' : 
    $sql_req_00="select sequence from _courriel_recus_brut where uticptbal_cleunik =$uticptbal_cleunik and integre in($vl_c_integre) group by sequence order by sequence desc $limit;"; //  On recherche la liste 
    $result = _graal_requete_bd($sql_req_00);
    $sequence="-1,";
    while ($row = mysql_fetch_assoc($result)) {
      $sequence.=$row['sequence'].",";
    }
    _graal_libere_requete_bd($result);
    if (strlen($sequence)!=0) {$sequence=substr($sequence,0,-1);}
    $sql_con=" where sequence in($sequence) and integre in($vl_c_integre) and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by courriel_brut_cleunik asc;";
    break;
  case 'toutes' : 
    $sql_con=" where integre in($vl_c_integre) and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by courriel_brut_cleunik asc;";
    break;
  case 'cle' : 
    $sql_con=" where courriel_brut_cleunik=$vl_e_courriel_brut_cleunik;";
    break;
  case '1': case '2': case '3': case '4': case '1,2,3,4':
    $sql_con=" where integre in($vl_c_integre) and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by courriel_brut_cleunik desc;";
    break;
  case 'dates':
    switch ($vl_e_type_date) {
      case 1: //  Date de réception
        $sql_con=" where integre in($vl_c_integre) and (dateheurereception between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by dateheurereception desc,courriel_brut_cleunik asc;";
        break;
      case 2: //  Date d'émission du message
        $sql_con=" where integre in($vl_c_integre) and (dateheuremessage between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by dateheuremessage desc;";
        break;
    }
    break;
} 
$result = _graal_requete_bd($sql_req.$sql_con);
$num_rows = mysql_num_rows($result);
//echo $sql_req.$sql_con;
//exit;
$vl_prop_r="ak17";
$vl_prop_v="ak16";
$vl_prop_o="ak18";
$vl_prop_reponse="ah11";
$vl_prop_retour_pasbon="ad19";
$vl_prop_retour_lu="ag06";
$vl_prop_demande_confirmation="al12";
$vl_prop_demande_confirmation="af06";
$vl_prop_adresse_inconnue="ab19";
$vl_prop_tropdacteurs="ah02";
$vl_prop_attention="cb07";
echo(fa_xcree_entete_rdf()); 
/*
echo('<RDF:li>'.EOL);
echo('<RDF:Description>');
echo('<row:int>'.fa_ent_xml($vl_e_integre).'</row:int>');
echo('<row:req>'.fa_ent_xml($sql_req.$sql_con).'</row:req>');
echo('<row:req_00>'.fa_ent_xml($sql_req_00).'</row:req_00>');
echo('<row:nombre>'.fa_ent_xml($num_rows).'</row:nombre>');
echo('</RDF:Description>'.EOL);
echo('</RDF:li>'.EOL);
_graal_libere_requete_bd($result);
*/
$numerolecture=10;
while ($row = mysql_fetch_assoc($result)) {
  $numerolecture++;
  $mime=NULL;
  $mime=new mime_parser_class;
  $mime->mbox = 0;
  $mime->decode_bodies = 1;
  $mime->ignore_syntax_errors = 1;
  //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
  $path="mail/".$sess_id."_".$row['hash'];
  $handle_file=fopen($path, 'wb');
  fwrite($handle_file, $row['courriel']);
  fclose($handle_file);
  $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$row['hash'],'sess_id'=>$sess_id,);
//  $parameters=array('Data'=>$row['courriel'],'SaveBody'=>'mail','Hash'=>$row['hash'],);
  
  
  $vl_c_z00="";
  $vl_c_z00=$num_rows;
  $vl_c_z01=$row['courriel_brut_cleunik'];
  $vl_c_z02="";
  $vl_c_z03="";
  $vl_c_z04="";
  $vl_c_z05="";
  $vl_c_z06="";
  $vl_c_z07="";
  $vl_c_z08="";
  $vl_c_z09="";
  $vl_c_z10="";
  $vl_c_z11="";
  $vl_c_z12="";
  $vl_c_z13="";
  $vl_c_z14="";
  $vl_c_z15=$row['integre'];
  $vl_c_z16=$row['sequence'];
  $vl_c_z17=0;
  $vl_c_z18="";
  $vl_c_z19="";
  $vl_c_z20=0;
  switch ($row['integre']) {
    case 1:$vl_c_z21="af08";break;// Traité : basculé dans les actions
    case 2:$vl_c_z21="ac02";break;// en attente de traitement
    case 3:$vl_c_z21="ac03";break;// supprimé (mais encore complètement dans les courriels reçus)
    case 4:$vl_c_z21="ag12";break;// en anomalie
    case 5:$vl_c_z21="ac03";break;// supprimé (courriel mis à null) ne dravrait jamais être affiché ici
  }
  $vl_c_z22=0;
  $vl_c_z23=0;
  $vl_c_z24=0;
  $vl_c_z25="";
  $vl_c_z26="";
  $vl_c_z27=0;
  $vl_c_z28=0;
  $vl_c_z29=0;
  $vl_c_z30=0;
  $vl_c_z31="";
  $vl_c_z32="";
  $vl_c_z33="";
  if ($row['marquage']==1) {$vl_c_z34="true";} else {$vl_c_z34="false";} 
  $vl_c_z35=$row['date_recep']." ".$row['heur_recep'];
  $vl_c_z36="";
  $vl_c_z37=$row['dateheurereception'];
  $vl_c_z38="";
  unset($decoded[0]);
  $retour=$mime->Decode($parameters, $decoded);
  if(!$retour) {
		$vl_c_z00='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position;
    $vl_c_z02='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position;
		$vl_c_z14="ag12";
		$vl_c_z21="ag12";
//      Ne pas faire cette mise à jour car ensuite c'est le binz pour récupérer !!!
//		$sql_req_maj = "update _courriel_recus_brut set integre= 4 WHERE courriel_brut_cleunik=".$row['courriel_brut_cleunik'].";";
//    _graal_exec_requete($sql_req_maj);
	 } else {
    $vl_type_content=explode(';',$decoded[0]['Headers']['content-type:']);
    $vl_encodage="";
    $vl_encodage=$decoded[0]["DecodedHeaders"]["subject:"][0][0]["Encoding"];
    if ($vl_encodage!="") {
      //  Attention bien conserver les 2 lignes suivantes !!
      $vl_c_z02=iconv($vl_encodage,"utf-8",$decoded[0]["DecodedHeaders"]["subject:"][0][0]["Value"]); //  C'est le moins pire des 2
      //$vl_c_z02=iconv_mime_decode($decoded[0]["DecodedHeaders"]["subject:"][0][0]["Value"],0,$vl_encodage); //  C'est le plus pire des 2
    } else {
        $vl_encodage=mb_detect_encoding($decoded[0]["Headers"]["subject:"]);
        $vl_c_z02=iconv_mime_decode($decoded[0]["Headers"]["subject:"],1,$vl_encodage);
        $vl_c_z02=mb_decode_mimeheader($decoded[0]["Headers"]["subject:"]);
    }
    $vl_c_z02=str_replace("\r\n", "",$vl_c_z02);
    $vl_c_z02=str_replace("\t", "",$vl_c_z02);
    $vl_c_z02=preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_z02); //  Suppression des caractères non imprimables (http://www.phpinfo.net/page/archives/regex/)
    $vl_c_z03=$decoded[0]["Headers"]["return-path:"];
    $vl_b_z03=is_array($vl_c_z03);
    if ($vl_b_z03) {
      $vl_c_z03_temp="";
      for($vl_part = 0; $vl_part < count($vl_c_z03); $vl_part++) {
        $vl_c_z03_temp.=$vl_c_z03[$vl_part].";";
      }
      $vl_c_z03=$vl_c_z03_temp;
    }
//    $vl_c_z03=$vl_encodage;
    $vl_c_z04=$decoded[0]["Headers"]["date:"];
		$vl_c_z05=iconv_mime_decode($decoded[0]["Headers"]["from:"],0, "UTF-8");
    $vl_c_z06=iconv_mime_decode($decoded[0]["Headers"]["to:"],0, "UTF-8");
		$vl_c_z07=$decoded[0]["Headers"]["message-id:"];
		$vl_c_z07=fa_ent_xml_cabal_01($vl_c_z07);
		$vl_c_z08=$decoded[0]["Headers"]["in-reply-to:"];
		if ($vl_c_z08!="") {$vl_c_z36=$vl_prop_reponse;}
		if ($decoded[0]["Headers"]["reply-to:"]!=null) {$vl_c_z26=$decoded[0]["Headers"]["reply-to:"];} else {$vl_c_z26="";}
    if (($timestamp = strtotime($vl_c_z04)) === false) {
      if (strtolower(substr($vl_c_z04,-2))=="ut") {
        $vl_c_z04=substr($vl_c_z04,0,strlen($vl_c_z04)-2)."UTC";
        if (($timestamp = strtotime($vl_c_z04)) === false) { 
          $vl_c_z09="19610123060000";
        } else {
          $vl_c_z09=date('YmdHis', $timestamp);
          $vl_c_z04=date('d-m-Y H:i:s', $timestamp);
        }
      }  else {
        $vl_c_z09="19700101000001";
        $vl_c_z04=date('d-m-Y H:i:s', 1);
      }
    } else {
      $vl_c_z09=date('YmdHis', $timestamp);
      $vl_c_z04=date('d-m-Y H:i:s', $timestamp);
    }
    preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z05 , $regs);
    $vl_c_z10 = $regs[0]; //  Expéditeur
    $sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intweb_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_mail f1,_acteurs f2,_act_interlo f3,_choix f4 where refweb='$vl_c_z10' and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
    $result_01=_graal_requete_bd($sql_req_01);
    $vl_c_z11="";$vl_nb_trouve=0;$vl_b_actif=0;
    while ($row_01 = mysql_fetch_assoc($result_01)) {
      $vl_nb_trouve++;
      if ($row_01['actif_acteur']==1) {
        if ($row_01['actif_interlo']==1) {
          $vl_b_actif++;
          $vl_c_z11.=$row_01['qui']."(".$row_01['raisonsoc']."[".$row_01['choix_valeur_texte_01']."])"."++";
          $vl_c_z20=$row_01['web_cleunik'];
          $vl_c_z22=$row_01['typeacteur'];
          $vl_c_z23=$row_01['act_cleunik'];
          $vl_c_z24=$row_01['int_cleunik'];
          switch ($row_01['typeacteur']) {
            case 110000 : $vl_c_z12="be06";break;
            case 110003 : $vl_c_z12="bd09";break;
            case 110001 : $vl_c_z12="be01";break;
            case 110004 : $vl_c_z12="be02";break;
            case 110002 : $vl_c_z12="be03";break;
            case 110005 : $vl_c_z12="be04";break;
            case 110006 : $vl_c_z12="be05";break;
          } 
        }
      }
    }
    _graal_libere_requete_bd($result_01);
    if ($vl_nb_trouve!=0) {
      if ($vl_b_actif!=0) {
        if ($vl_b_actif!=1) {
          $vl_c_z12=$vl_prop_tropdacteurs;
        }
      } else {
        $vl_c_z12=$vl_prop_adresse_inconnue." ai15";
      }
    } else {
      $vl_c_z12=$vl_prop_adresse_inconnue;
    }
    if ($vl_c_z26!="") {preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z26 , $regs);}
    $vl_c_z26 = $regs[0]; //  Adresse de réponse
    if ($vl_c_z26==$vl_c_z10) {$vl_c_z26="";}
    if ($vl_c_z26!="") {
      $sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intweb_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_mail f1,_acteurs f2,_act_interlo f3,_choix f4 where refweb='$vl_c_z26' and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
      $result_01=_graal_requete_bd($sql_req_01);
      $vl_c_z31="";$vl_nb_trouve=0;$vl_b_actif=0;
      while ($row_01 = mysql_fetch_assoc($result_01)) {
        $vl_nb_trouve++;
        if ($row_01['actif_acteur']==1) {
          if ($row_01['actif_interlo']==1) {
            $vl_b_actif++;
            $vl_c_z31.=$row_01['qui']."(".$row_01['raisonsoc']."[".$row_01['choix_valeur_texte_01']."])".EOL;
            $vl_c_z27=$row_01['web_cleunik'];
            $vl_c_z28=$row_01['typeacteur'];
            $vl_c_z29=$row_01['act_cleunik'];
            $vl_c_z30=$row_01['int_cleunik'];
            switch ($row_01['typeacteur']) {
              case 110000 : $vl_c_z32="be06";break;
              case 110003 : $vl_c_z32="bd09";break;
              case 110001 : $vl_c_z32="be01";break;
              case 110004 : $vl_c_z32="be02";break;
              case 110002 : $vl_c_z32="be03";break;
              case 110005 : $vl_c_z32="be04";break;
              case 110006 : $vl_c_z32="be05";break;
            } 
          }
        }
      }
      _graal_libere_requete_bd($result_01);
      if ($vl_nb_trouve!=0) {
        if ($vl_b_actif!=0) {
          if ($vl_b_actif!=1) {
            $vl_c_z32=$vl_prop_adresse_inconnue;
          }
        } else {
          $vl_c_z32=$vl_prop_adresse_inconnue." ai15";
        }
      } else {
        $vl_c_z32=$vl_prop_adresse_inconnue;
      }
    }
    ereg("^(.+)@(.+)\.(.+)$", $vl_c_z10, $regs);
    $vl_c_z13=$regs[2].".".$regs[3];		
    ereg("^(.+)@(.+)\.(.+)$", $vl_c_z26, $regs);
    $vl_c_z33=$regs[2].".".$regs[3];		

    $vl_c_z14="";
    //  Recherche adresse
    $vl_e_trouve_adresse=array_search($vl_c_z10,$liste_ref);
    if ($vl_e_trouve_adresse===false) {} else {
      switch ($liste_gen[$vl_e_trouve_adresse]) {
        case 1 : $vl_c_z14=$vl_prop_v;break;
        case 2 : $vl_c_z14=$vl_prop_o;break;
        case 3 : $vl_c_z14=$vl_prop_r;break;
      } 
    }
    if ($vl_c_z14=="") {
      //  Recherche domaine
      $vl_e_trouve_domaine=array_search($vl_c_z13,$liste_ref);
      if ($vl_e_trouve_domaine===false) {} else {
        switch ($liste_gen[$vl_e_trouve_domaine]) {
          case 1 : $vl_c_z14=$vl_prop_v;break;
          case 2 : $vl_c_z14=$vl_prop_o;break;
          case 3 : $vl_c_z14=$vl_prop_r;break;
        } 
      }
    }
    $vl_c_15=$decoded[0]["Headers"]["disposition-notification-to:"];  //  Expéditeur veut être prévenu
    if ($vl_c_15!="") {$vl_c_z25=$vl_prop_demande_confirmation;} 
    $nb_parties=count($decoded[0]['Parts']);
    switch ($nb_parties) {
      case 0:
        $vl_c_z17="";
        $vl_c_z18="";
        $vl_type_content=explode(';',$decoded[0]['Headers']['content-type:']);
        switch ($vl_type_content[0]) {
          case "text/plain":
            break;
          case "text/html":
            $vl_c_z19="am05";
            break;
        }
        break;
      default :
        $index = 0;
        $vl_e_nb_pieces_jointes=0;
        $vl_e_nb_pieces_integrees=0;
        $vl_e_taille_pj=0;
        unset($tableau_parties);
        $tableau_parties=fa_arrayFromEmailParts($decoded[0]['Parts'],$index);
        $nb_parties=count($tableau_parties);
        $vl_b_attention=false;
        $attention_a_quoi="";
        for($vl_part = 0; $vl_part < $nb_parties; $vl_part++) {
          $vl_coid=$tableau_parties[$vl_part]['coid'];
          $vl_special=$tableau_parties[$vl_part]['special'];
          if ($tableau_parties[$vl_part]['attention']!=null) {
            $vl_b_attention=true;
            $attention_a_quoi.=$tableau_parties[$vl_part]['attention'];
          }
          if ($tableau_parties[$vl_part]['content']!=null) {
            switch ($tableau_parties[$vl_part]['type']) {
              case "text/plain":
                break;
              case "text/html":
                $vl_c_z19="am05";
                break;
              default:
                break;
            }
          } else {
            //  On teste d'abord si c'est un fichier incorporé.
            if ($vl_coid != null) {
              $vl_e_nb_pieces_integrees++;
            } else {
              if ($vl_special!=null) {
                switch ($vl_special) {
                  case "message/disposition-notification":if ($vl_c_z25!=$vl_prop_retour_pasbon) {$vl_c_z25=$vl_prop_retour_lu;}break;
                  case "message/delivery-status":$vl_c_z25=$vl_prop_retour_pasbon;break;
                  case "message/rfc822":$vl_c_z25=$vl_prop_retour_pasbon;break;
                  case "text/rfc822-headers":if ($vl_c_z25!=$vl_prop_retour_pasbon) {$vl_c_z25=$vl_prop_retour_lu;}break;
                }
             } else {
              $vl_e_nb_pieces_jointes++;
              $vl_e_taille_pj+=$tableau_parties[$vl_part]['taille'];
             }   
             
            }
          }
        }
        if ($vl_e_nb_pieces_jointes!=0) {
          $vl_c_z17=$vl_e_nb_pieces_jointes." (".int2taille($vl_e_taille_pj).")";
          $vl_c_z18="al14";
          if ($vl_e_taille_pj==0) { //  On a des pièces jointes et une taille 0 !!! ca a du être supprimé par un antivirus !!
            $vl_c_z18=$vl_prop_attention;
            $vl_c_z17="!! Virus-Virus-Virus !!";
            $vl_c_z38="1";
            }      
        } else {
          $vl_c_z17="";$vl_c_z18="";
        }
        if ($vl_b_attention==true) {
          $vl_c_z18=$vl_prop_attention;
          $vl_c_z17="??? Virus-Virus-Virus ??? $attention_a_quoi";
          $vl_c_z38="1";
        }
        break;
    }
  }  
/*
  if ($vl_nb_trouve!=0) {
    if ($vl_b_actif!=0) {
      if ($vl_b_actif==1) {
        } else {
        $vl_c_z12=$vl_prop_adresse_inconnue;
      }
    } else {
      $vl_c_z12=$vl_prop_adresse_inconnue." ai15";
    }
  } else {
    $vl_c_z12=$vl_prop_adresse_inconnue;
  }
*/
  //  On teste le chemin de retour, preuve dans google que c'est bien un courriel reçu et pas un courriel envoyé
	//$vl_c_z03="ok";
  if ($vl_c_z03!="") {
    if (($vl_c_z25==$vl_prop_retour_lu) or ($vl_c_z25==$vl_prop_retour_pasbon)) {$vl_c_z36="";}
    echo('<RDF:li>'.EOL);
    echo('<RDF:Description>');
    echo('<row:z00>'.fa_ent_xml($vl_c_z00).'</row:z00>');
    echo('<row:z01 NC:parseType="Integer">'.fa_ent_xml($vl_c_z01).'</row:z01>');
    echo('<row:z02>'.fa_ent_xml($vl_c_z02).'</row:z02>');   //  Sujet
    echo('<row:z03>'.fa_ent_xml($vl_c_z03).'</row:z03>');   //  Chemin de retour
    echo('<row:z04>'.fa_ent_xml($vl_c_z04).'</row:z04>');
    echo('<row:z05>'.fa_ent_xml($vl_c_z05).'</row:z05>');
    echo('<row:z06>'.fa_ent_xml($vl_c_z06).'</row:z06>');
    echo('<row:z07>'.fa_ent_xml($vl_c_z07).'</row:z07>');
    echo('<row:z08>'.fa_ent_xml($vl_c_z08).'</row:z08>'); //  en réponse à 
    echo('<row:z09>'.fa_ent_xml($vl_c_z09).'</row:z09>'); //  Date en clair
    echo('<row:z10>'.fa_ent_xml($vl_c_z10).'</row:z10>'); //  adresse courriel de l'expéditeur
    echo('<row:z11>'.fa_ent_xml($vl_c_z11).'</row:z11>'); //  Qui en clair
    echo('<row:z12>'.$vl_c_z12.'</row:z12>');
    echo('<row:z13>'.fa_ent_xml($vl_c_z13).'</row:z13>'); //  Domaine
    echo('<row:z14>'.$vl_c_z14.'</row:z14>'); //  Avertissement d'après listes
    echo('<row:z15>'.$vl_c_z15.'</row:z15>'); //  Integré
    echo('<row:z16>'.$vl_c_z16.'</row:z16>'); //  Séquence
    echo('<row:z17>'.$vl_c_z17.'</row:z17>');  //  Nombre de pièces jointes
    echo('<row:z18>'.$vl_c_z18.'</row:z18>');  //  Propertie -> trombonne symbolisant les pièces-jointes ou attention pièces jointes mais taille 0 -> probabilité virus 
    echo('<row:z19>'.$vl_c_z19.'</row:z19>');  //  Propertie -> Présence partie HTML
    echo('<row:z20>'.$vl_c_z20.'</row:z20>');  //  web_cleunik de l'expéditeur
    echo('<row:z21>'.$vl_c_z21.'</row:z21>');  //  Propertie -> état du courriel : supprimé, à traiter, purgé ...
    echo('<row:z22>'.$vl_c_z22.'</row:z22>'); //  Type acteur de l'expéditeur
    echo('<row:z23>'.$vl_c_z23.'</row:z23>'); //  act_cleunik de l'expéditeur
    echo('<row:z24>'.$vl_c_z24.'</row:z24>'); //  int_cleunik de l'expéditeur
    echo('<row:z25>'.$vl_c_z25.'</row:z25>'); //  Propertie pour signaler un type de courriel particulier : notification de lecture, erreur dans la délivrance du courriel
    echo('<row:z26>'.fa_ent_xml($vl_c_z26).'</row:z26>'); //  Adresse de réponse
    echo('<row:z27>'.$vl_c_z27.'</row:z27>');  //  web_cleunik de l'adresse de réponse
    echo('<row:z28>'.$vl_c_z28.'</row:z28>'); //  Type acteur de l'adresse de réponse
    echo('<row:z29>'.$vl_c_z29.'</row:z29>'); //  act_cleunik de l'adresse de réponse
    echo('<row:z30>'.$vl_c_z30.'</row:z30>'); //  int_cleunik de l'adresse de réponse
    echo('<row:z31>'.fa_ent_xml($vl_c_z31).'</row:z31>'); //  Qui adresse de réponse en clair
    echo('<row:z32>'.$vl_c_z32.'</row:z32>'); //  Propriété type acteur adresse de réponse
    echo('<row:z33>'.fa_ent_xml($vl_c_z33).'</row:z33>'); //  Domaine de réponse
    echo('<row:z34>'.$vl_c_z34.'</row:z34>'); //  MArquage
    echo('<row:z35>'.$vl_c_z35.'</row:z35>'); //  Date et heure de réception du courriel en clair
    echo('<row:z36>'.$vl_c_z36.'</row:z36>'); //  Propriété de réponse 
    echo('<row:z37>'.$vl_c_z37.'</row:z37>'); //  Date et heure de réception du courriel pour tri
    echo('<row:z38>'.$vl_c_z38.'</row:z38>'); //  Pas vide si suscpect cad si pj <> 0 et taille pj = 0
    echo('</RDF:Description>'.EOL);
    echo('</RDF:li>'.EOL);
  } else {
    //  a priori, ce sont des courriels envoyés
    //  On change leur état 
		$sql_req_maj = "update _courriel_recus_brut set integre= 6 WHERE courriel_brut_cleunik=".$row['courriel_brut_cleunik'].";";
    _graal_exec_requete($sql_req_maj);
  }
}
// fin du fichier RDF
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
// fermeture du curseur et de la connexion
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
