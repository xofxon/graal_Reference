<?php 
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_modif_idcon_01";
$t_origines_ok[1]="_graal_fen_utilisateurs_01";
fa_acces_script();
$vl_c_admin=fa_recup_param('admin','niet');
$vl_e_mini=intval(fa_recup_session('borne_mini','0'));
$vl_e_maxi=intval(fa_recup_session('borne_maxi','0'));
$vl_c_action=fa_recup_param('vl_c_action','??????');
$vl_e_uti_cleunik=intval(fa_recup_param('vl_e_uti_cleunik','0'));
$vl_c_prenom=fa_recup_param('vl_c_prenom','');
$vl_c_patronyme=fa_recup_param('vl_c_patronyme','');
$vl_c_codealphanum15=fa_recup_param('vl_c_codealphanum15','');
$vl_c_motdepasse=fa_recup_param('vl_c_motdepasse','');
$vl_c_identifiant=fa_recup_param('vl_c_identifiant','');
$vl_c_blocnotebrut=fa_recup_param('vl_c_blocnotebrut','');
$vl_e_langue_cleunik=intval(fa_recup_param('vl_e_langue_cleunik','0'));
$vl_e_int_cleunik=intval(fa_recup_param('vl_e_int_cleunik',0));
$vl_c_actif=intval(fa_recup_param('vl_c_actif','1'));
$vl_c_genre=intval(fa_recup_param('vl_c_genre','2'));
$vl_c_motdepasse_neo_01=fa_recup_param('vl_c_motdepasse_neo_01','');
$vf_c_echo='';
$vl_c_window_background_color=fa_recup_param('vl_c_window_background_color','#dfd9f5');
$vl_c_focus_background_color=fa_recup_param('vl_c_focus_background_color','#80FF80');
$vl_c_focus_color=fa_recup_param('vl_c_focus_color','#80FF80');
$mess01="666 Modification interdite !!";
$mess02="Modification réalisée avec succès.";
$mess03="La modification a échoué!!!.";
$vl_selection_article=intval(fa_recup_param('vl_selection_article','1'));
$vl_selection_acteur=intval(fa_recup_param('vl_selection_acteur','1'));
$vl_selection_interlocuteur=intval(fa_recup_param('vl_selection_interlocuteur','3'));
$vl_c_activite_background_color=fa_recup_param('vl_c_activite_background_color','#80FF80');
$vl_police_generale=fa_recup_param('vl_police_generale','Verdana, Geneva, sans-serif');
$vl_c_table_ligne_selectionnee_color=fa_recup_param('vl_c_table_ligne_selectionnee_color','#ffe0e0');	
$vl_c_table_ligne_impaire_color=fa_recup_param('vl_c_table_ligne_impaire_color','#ffffc0');
$vl_c_table_ligne_paire_color=fa_recup_param('vl_c_table_ligne_paire_color','#ff6060');	
$vl_selection_telephone=intval(fa_recup_param('vl_selection_telephone','1'));
$vl_selection_fax=intval(fa_recup_param('vl_selection_fax','1'));
$vl_selection_courriel=intval(fa_recup_param('vl_selection_courriel','1'));
$vl_selection_postale=intval(fa_recup_param('vl_selection_postale','1'));
$vl_selection_geophysique=intval(fa_recup_param('vl_selection_geophysique','1'));
$vl_selection_site=intval(fa_recup_param('vl_selection_site','1'));
$vl_selection_note=intval(fa_recup_param('vl_selection_note','1'));
$vl_selection_document=intval(fa_recup_param('vl_selection_document','1'));
$vl_selection_pseudodocument=intval(fa_recup_param('vl_selection_pseudodocument','1'));
$vl_page_accueil=fa_recup_param('vl_page_accueil',0);
$vl_selart_nbcaracrech=intval(fa_recup_param("vl_selart_nbcaracrech",3));
$vl_selact_nbcaracrech=intval(fa_recup_param("vl_selact_nbcaracrech",3));
$vl_selint_nbcaracrech=intval(fa_recup_param("vl_selint_nbcaracrech",3));
$vl_seltel_nbcaracrech=intval(fa_recup_param("vl_seltel_nbcaracrech",3));
$vl_selfax_nbcaracrech=intval(fa_recup_param("vl_selfax_nbcaracrech",3));
$vl_selmel_nbcaracrech=intval(fa_recup_param("vl_selmel_nbcaracrech",3));
$vl_selpos_nbcaracrech=intval(fa_recup_param("vl_selpos_nbcaracrech",3));
$vl_selgeo_nbcaracrech=intval(fa_recup_param("vl_selgeo_nbcaracrech",3));
$vl_selweb_nbcaracrech=intval(fa_recup_param("vl_selweb_nbcaracrech",3));
$vl_selnot_nbcaracrech=intval(fa_recup_param("vl_selnot_nbcaracrech",3));
$vl_seldoc_nbcaracrech=intval(fa_recup_param("vl_seldoc_nbcaracrech",3));
$vl_sellie_nbcaracrech=intval(fa_recup_param("vl_sellie_nbcaracrech",3));
$vl_selaction_nbcaracrech=intval(fa_recup_param("vl_selaction_nbcaracrech",4));
$vl_modele_recherche_articles=intval(fa_recup_param("vl_modele_recherche_articles",1));
$vl_selection_action=intval(fa_recup_param('vl_selection_action','1'));
$vl_selection_action_fenetre=intval(fa_recup_param('vl_selection_action_fenetre','1'));

if ($vl_c_admin=='niet' && $vl_c_action=='modifier'){
	$sql_req = "SELECT param_environ as param_environ from _utilisateurs where uti_cleunik=$vl_e_uti_cleunik";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	if (is_null($row['param_environ'])==false) {
		$vl_c_xml=simplexml_load_string($row['param_environ']);
		if (isset($vl_c_xml->gesdoc_ml_zone)){$gesdoc_ml_zone=$vl_c_xml->gesdoc_ml_zone->attributes();}else{$gesdoc_ml_zone='1';}
		if (isset($vl_c_xml->gesacteurs_ml_zone)){$gesacteurs_ml_zone=$vl_c_xml->gesacteurs_ml_zone->attributes();}else{$gesacteurs_ml_zone='1';}
		if (isset($vl_c_xml->gesinterlo_ml_zone)){$gesinterlo_ml_zone=$vl_c_xml->gesinterlo_ml_zone->attributes();}else{$gesinterlo_ml_zone='1';}
		if (isset($vl_c_xml->gesactions_ml_zone)){$gesactions_ml_zone=$vl_c_xml->gesactions_ml_zone->attributes();}else{$gesactions_ml_zone='1';}
		if (isset($vl_c_xml->aut_crypte_docs)){$aut_crypte_docs=$vl_c_xml->aut_crypte_docs->attributes();}else{$aut_crypte_docs='2';}
	}
	_graal_libere_requete_bd($result);
} else {
	$gesdoc_ml_zone=fa_recup_param("gesdoc_ml_zone",1);
	$gesacteurs_ml_zone=fa_recup_param("gesacteurs_ml_zone",1);
	$gesinterlo_ml_zone=fa_recup_param("gesinterlo_ml_zone",1);
	$gesactions_ml_zone=fa_recup_param("gesactions_ml_zone",1);
	
	$aut_crypte_docs=intval(fa_recup_param('aut_crypte_docs','2'));
}
$param_environ_admin="";
$param_environ_admin.='<gesdoc_ml_zone data="'.fa_ent_xml($gesdoc_ml_zone).'"/>';
$param_environ_admin.='<gesacteurs_ml_zone data="'.fa_ent_xml($gesacteurs_ml_zone).'"/>';
$param_environ_admin.='<gesinterlo_ml_zone data="'.fa_ent_xml($gesinterlo_ml_zone).'"/>';
$param_environ_admin.='<gesactions_ml_zone data="'.fa_ent_xml($gesactions_ml_zone).'"/>';
$param_environ_admin.='<aut_crypte_docs data="'.fa_ent_xml($aut_crypte_docs).'"/>';
$aut_admin=intval(fa_recup_param('aut_admin','2'));


$param_environ="";
$param_environ.=fa_xcree_entete_xml();
$param_environ.='<parametres>';
$param_environ.='<selection_article data="'.fa_ent_xml($vl_selection_article).'"/>';
$param_environ.='<selection_acteur data="'.fa_ent_xml($vl_selection_acteur).'"/>';
$param_environ.='<focus_background_color data="'.fa_ent_xml($vl_c_focus_background_color).'"/>';
$param_environ.='<focus_color data="'.fa_ent_xml($vl_c_focus_color).'"/>';
$param_environ.='<window_background_color data="'.fa_ent_xml($vl_c_window_background_color).'"/>';
$param_environ.='<selection_interlocuteur data="'.fa_ent_xml($vl_selection_interlocuteur).'"/>';

$param_environ.='<police_generale data="'.fa_ent_xml($vl_police_generale).'"/>';
$param_environ.='<table_ligne_selectionnee_color data="'.fa_ent_xml($vl_c_table_ligne_selectionnee_color).'"/>';
$param_environ.='<table_ligne_impaire_color data="'.fa_ent_xml($vl_c_table_ligne_impaire_color).'"/>';
$param_environ.='<table_ligne_paire_color data="'.fa_ent_xml($vl_c_table_ligne_paire_color).'"/>';
$param_environ.='<selection_telephone data="'.fa_ent_xml($vl_selection_telephone).'"/>';
$param_environ.='<selection_fax data="'.fa_ent_xml($vl_selection_fax).'"/>';
$param_environ.='<selection_courriel data="'.fa_ent_xml($vl_selection_courriel).'"/>';
$param_environ.='<selection_postale data="'.fa_ent_xml($vl_selection_postale).'"/>';
$param_environ.='<selection_geophysique data="'.fa_ent_xml($vl_selection_geophysique).'"/>';
$param_environ.='<selection_site data="'.fa_ent_xml($vl_selection_site).'"/>';
$param_environ.='<selection_note data="'.fa_ent_xml($vl_selection_note).'"/>';
$param_environ.='<selection_document data="'.fa_ent_xml($vl_selection_document).'"/>';
$param_environ.='<selection_pseudodocument data="'.fa_ent_xml($vl_selection_pseudodocument).'"/>';
$param_environ.='<activite_background_color data="'.fa_ent_xml($vl_c_activite_background_color).'"/>';
$param_environ.='<page_accueil data="'.fa_ent_xml($vl_page_accueil).'"/>';

$param_environ.='<vl_selart_nbcaracrech data="'.fa_ent_xml($vl_selart_nbcaracrech).'"/>';
$param_environ.='<vl_selact_nbcaracrech data="'.fa_ent_xml($vl_selact_nbcaracrech).'"/>';
$param_environ.='<vl_selint_nbcaracrech data="'.fa_ent_xml($vl_selint_nbcaracrech).'"/>';
$param_environ.='<vl_seltel_nbcaracrech data="'.fa_ent_xml($vl_seltel_nbcaracrech).'"/>';
$param_environ.='<vl_selfax_nbcaracrech data="'.fa_ent_xml($vl_selfax_nbcaracrech).'"/>';
$param_environ.='<vl_selmel_nbcaracrech data="'.fa_ent_xml($vl_selmel_nbcaracrech).'"/>';
$param_environ.='<vl_selpos_nbcaracrech data="'.fa_ent_xml($vl_selpos_nbcaracrech).'"/>';
$param_environ.='<vl_selgeo_nbcaracrech data="'.fa_ent_xml($vl_selgeo_nbcaracrech).'"/>';
$param_environ.='<vl_selweb_nbcaracrech data="'.fa_ent_xml($vl_selweb_nbcaracrech).'"/>';
$param_environ.='<vl_selnot_nbcaracrech data="'.fa_ent_xml($vl_selnot_nbcaracrech).'"/>';
$param_environ.='<vl_seldoc_nbcaracrech data="'.fa_ent_xml($vl_seldoc_nbcaracrech).'"/>';
$param_environ.='<vl_sellie_nbcaracrech data="'.fa_ent_xml($vl_sellie_nbcaracrech).'"/>';
$param_environ.='<vl_modele_recherche_articles data="'.fa_ent_xml($vl_modele_recherche_articles).'"/>';
$param_environ.='<vl_selaction_nbcaracrech data="'.fa_ent_xml($vl_selaction_nbcaracrech).'"/>';
$param_environ.='<vl_selection_action data="'.fa_ent_xml($vl_selection_action).'"/>';
$param_environ.='<vl_selection_action_fenetre data="'.fa_ent_xml($vl_selection_action_fenetre).'"/>';
$param_environ.=$param_environ_admin;

$param_environ.='</parametres>';
switch (TRUE) {
  case $vl_c_action=='??????':
    exit;
    break;    
  case $vl_c_action=='modif_id':
    $sql_req = "SELECT sha1('$vl_c_motdepasse') as ancien_pwd,motdepasse as actuel_pwd FROM _utilisateur WHERE _utilisateur.uti_cleunik = $vl_e_uti_cleunik;";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    if ($row['ancien_pwd']!=$row['actuel_pwd']) {
      $vf_c_echo=$mess01;
      _graal_libere_requete_bd($result);
    } else {
      _graal_libere_requete_bd($result);
      $sql_req = "update _utilisateur set identifiant='$vl_c_identifiant',motdepasse=sha1('$vl_c_motdepasse_neo_01') WHERE _utilisateur.uti_cleunik = $vl_e_uti_cleunik;";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo=='ok') {$vf_c_echo=$mess02;} else {$vf_c_echo=$mess03;}
    }
    break;
  case $vl_c_action=='ajouter':
  $sql_cle = "select max(uti_cleunik) as maxcleunik from _utilisateur";
  if ($res = _graal_requete_bd($sql_cle)){
    if($ligne = mysql_fetch_row($res)){
      $cleunik=$ligne[0];
      if (is_null($cleunik)){
        $cleunik=1;
      } else {
        $cleunik=$cleunik*2;
      }
    }
    else {
      $cleunik=1;
    }
   } else {
    echo (mysql_error($cnx) . $sql_cle);
   } 
  $sql_cle = "select max(borne_maxi) as max from _utilisateur";
  
  if ($res = _graal_requete_bd($sql_cle))
   {
    if($ligne = mysql_fetch_row($res))
    {
        $min=$ligne[0];
        if (is_null($min))
        {
          $min=0;
        }
        else
          $min=$min+1;
    }
    else
      $min=1;
   }
    else
   {
    echo (mysql_error($cnx) . $sql_cle);
   } 
   $max=$min+9999999;

$vl_e_uti_cleunik=$cleunik;
  {
      $sql_req = "INSERT INTO _utilisateur set uti_cleunik=$vl_e_uti_cleunik,prenom='$vl_c_prenom',patronyme='$vl_c_patronyme',codealphanum15='$vl_c_codealphanum15',blocnotebrut='$vl_c_blocnotebrut',identifiant='$vl_c_identifiant',motdepasse=sha1('$vl_c_motdepasse'),c_uuid=(select uuid()),langue_appli=$vl_e_langue_cleunik,borne_mini=$min,borne_maxi=$max,int_cleunik=$vl_e_int_cleunik,actif=$vl_c_actif,param_environ='$param_environ',genre=$vl_c_genre;";
      $vf_c_echo=_graal_exec_requete($sql_req);
      //	Gestion des droits d'administration
      $vl_e_duf_cleunik=_graal_requete_max("duf_cleunik","_droits_uti_fen");
    $sql_req = "INSERT INTO _droits_uti_fen set fen_cleunik=10000053,uti_cleunik=$vl_e_uti_cleunik,duf_cleunik=$vl_e_duf_cleunik,duf_acces=$aut_admin,duf_ajout=0,duf_modif=0,duf_suppr=0;";
    $vf_c_echo=_graal_exec_requete($sql_req);
      
  }
  break;
  case $vl_c_action=='supprimer':
    if ($vl_e_uti_cleunik==0) {exit;} 
    $sql_req = "DELETE FROM _utilisateur WHERE uti_cleunik = $vl_e_uti_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vl_c_action=='modifier':
    $sql_req = "update _utilisateur set prenom='$vl_c_prenom',patronyme='$vl_c_patronyme',codealphanum15='$vl_c_codealphanum15',blocnotebrut='$vl_c_blocnotebrut',langue_appli=$vl_e_langue_cleunik,int_cleunik=$vl_e_int_cleunik,actif=$vl_c_actif,param_environ='$param_environ',genre=$vl_c_genre WHERE _utilisateur.uti_cleunik = $vl_e_uti_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);

    $sql_req = "SELECT duf_cleunik FROM _droits_uti_fen where uti_cleunik=$vl_e_uti_cleunik and fen_cleunik=10000053;";
	$result = _graal_requete_bd($sql_req);
	if (mysql_num_rows($result) == 0) {
		$vl_e_duf_cleunik=_graal_requete_max("duf_cleunik","_droits_uti_fen");
    	$sql_req = "INSERT INTO _droits_uti_fen set fen_cleunik=10000053,uti_cleunik=$vl_e_uti_cleunik,duf_cleunik=$vl_e_duf_cleunik,duf_acces=$aut_admin,duf_ajout=0,duf_modif=0,duf_suppr=0;";
    	$vf_c_echo=_graal_exec_requete($sql_req);
	} else {
		$row = mysql_fetch_assoc($result);
		$vl_e_duf_cleunik=$row['duf_cleunik'];
		$sql_req = "update _droits_uti_fen set duf_acces=$aut_admin WHERE duf_cleunik=$vl_e_duf_cleunik;";
    	$vf_c_echo=_graal_exec_requete($sql_req);
	}
    break;
} 
_graal_ferme_connexion();
echo $vf_c_echo;       
?>
