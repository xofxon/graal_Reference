<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_doc_proprietes_01";
fa_acces_script();
$vf_c_echo="";
define('EOL', "\r\n");
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_doc_cleunik=intval(fa_recup_param('vl_doc_cleunik',''));
$vl_c_genrecritere=fa_recup_param('genrecritere','');
$vl_e_typedoc=intval(fa_recup_param('typedoc',''));
$vl_critere_cleunik=intval(fa_recup_param('vl_critere_cleunik',''));
$t1=fa_recup_param('t1','');
$t2=fa_recup_param('t2','');
switch ($vl_c_genrecritere) {
  case "entreprise":$vl_e_uti_cleunik=0;break;
  case "moi":$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));break;
}
$t1=utf8_encode(base64_decode($t1));
$t2=utf8_encode(base64_decode($t2));
$pieces = explode("|", $t1);
$donnee = explode("|", $t2);
$vl_e_i=count($pieces);
$vl_e_j = 0;
while ($vl_e_j < $vl_e_i):
  $valeur=addslashes($pieces[$vl_e_j]);
  $datass=addslashes($donnee[$vl_e_j]);
  $sql_req="SELECT choix_cleunik from _choix where critere_cleunik=$vl_critere_cleunik and choix_code='$valeur' and choix_valeur_texte_01='$datass'";
  $result = _graal_requete_bd($sql_req);
  if (mysql_num_rows($result) == 0) {
    $vl_choix_cleunik=_graal_requete_max("choix_cleunik","_choix");
    $sql_req_01 = "INSERT INTO _choix set choix_cleunik=$vl_choix_cleunik,critere_cleunik=$vl_critere_cleunik,choix_code='$valeur',choix_valeur_texte_01='$datass',choix_valeur_texte_02='$datass',choix_actif=1;";
    $vf_c_echo=_graal_exec_requete($sql_req_01);
  } else {
    $row = mysql_fetch_assoc($result);
    $vl_choix_cleunik=fa_ent_xml($row['choix_cleunik']);
  }
  $sql_req_02 .="($vl_doc_cleunik,$vl_choix_cleunik,$vl_critere_cleunik,$vl_e_typedoc,$vl_e_uti_cleunik),";
  _graal_libere_requete_bd($result);
  $vl_e_j++;
endwhile;
if ($sql_req_02!="") {
  $sql_req_02=substr($sql_req_02, 0, -1);
  $sql_req="REPLACE INTO _documents_choix_fixes (doc_cleunik,choix_cleunik,critere_cleunik,typedoc,uti_cleunik) VALUES ";
  $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
  if($result_02 === false) {$vf_c_echo='Erreur 02 ->'.mysql_error($cnx) . $sql_req_02;} else {$vf_c_echo='Données correctement enregistrées.';}
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
