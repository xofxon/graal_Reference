<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_c_var=fa_recup_param('var','vs_tempo_courriel_destinataires');   //  courriels
$vl_t_cou_dest=fa_recup_session("$vl_c_var",'');
unset($_SESSION["$var"]);
$vl_e_intweb_cleunik="";
$vl_e_i=-1;
	foreach($vl_t_cou_dest as $vl_raf) {
      $vl_e_i++;
      $vl_e_intweb_cleunik.="'".$vl_t_cou_dest[$vl_e_i]."'".',';
    }
    if ($vl_e_intweb_cleunik!="") {$vl_e_intweb_cleunik=substr($vl_e_intweb_cleunik, 0, -1);}
// execution de la requète SQL
$vl_e_action_cleunik=fa_recup_param("vl_e_action_cleunik","-1");
//  Première étape: on récupère les emails
switch ($vl_e_action_cleunik) {
  case "-1":
    $sql_req="SELECT distinct(refweb) FROM _vue_courriels_01 where intweb_cleunik in($vl_e_intweb_cleunik);";
    break;
  default:
    $sql_req="SELECT distinct(refweb) FROM _vue_courriels_01 where intweb_cleunik in($vl_e_intweb_cleunik) and intweb_cleunik not in(select intweb from _emailing_cleweb where action_cleunik=$vl_e_action_cleunik);";
    break;
}
$result = _graal_requete_bd($sql_req);
$vl_e_nombre=mysql_num_rows($result);
$sql_condition="";
$vl_e_i=-1;
while ($row = mysql_fetch_assoc($result)) {
  $vl_e_i++;
  $refweb=addslashes($row['refweb']);
  if ($vl_e_i==0) {$sql_condition.= "'$refweb'";} else {$sql_condition.= ",'$refweb'";};
}
_graal_libere_requete_bd($result);
switch ($vl_e_action_cleunik) {
  case "-1":
    $sql_req="SELECT * FROM _vue_courriels_01 where refweb in($sql_condition) and intweb_cleunik in($vl_e_intweb_cleunik);";
    break;
  default:
    $sql_req="SELECT * FROM _vue_courriels_01 where intweb_cleunik in($vl_e_intweb_cleunik) and refweb not in(select refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik);";
    break;
}
$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
$vl_e_nombre=mysql_num_rows($result);
//$i=0;
//echo('<nombre data="'.$vl_e_nombre.'"/>');
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' intweb_cleunik="'.fa_ent_xml($row['intweb_cleunik']).'"');
  echo(' int_cleunik="'.fa_ent_xml($row['int_cleunik']).'"');
  echo(' refweb="'.fa_ent_xml($row['refweb']).'"');
  echo(' prenom_nom="'.fa_ent_xml($row['prenom_nom']).'"');
  echo(' prenom="'.fa_ent_xml($row['prenom']).'"');
  echo(' patronyme="'.fa_ent_xml($row['patronyme']).'"');
  echo(' civilite="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
