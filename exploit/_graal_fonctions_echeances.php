<?php
function fa_brik_menulist_journaux($vv_flex="1",$vv_id="ml_journal",$vv_observer="broadcaster_01",$vv_cleunik,$vv_tous){
	if (trim($vv_cleunik)!="") {
    $condition=" where journal_cleunik=$vv_cleunik ";
  } else {
    $condition="";
  }
  switch ($vv_tous){
  	case "tous":break;
  	case "":break;
  	default:$condition=" where journal_cleunik not in($vv_tous)";break;
  }
  if ($vv_tous=="tous"){
  	$vv_brik.="<menuitem value='Aucun journal !!!' _graal_cleunik='-2' label='Tous les journaux' selected='true'/>";
  }
  $sql_req = "SELECT a1.journal_cleunik as journal_cleunik,a1.nom AS nom FROM _treso_journal a1 $condition order by nom;";
  $sql_result = _graal_requete_bd($sql_req);
  $vl_e_nombre_types=mysql_num_rows($sql_result);
  if ($vl_e_nombre_types == 0){
  	$vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id' observer='$vv_observer' _graal_nombre='$vl_e_nombre_types'><menupopup>";
    $vv_brik.="<menuitem value='Aucun journal !!!' _graal_cleunik='-1' label='Aucun journal ' selected='true'/>";
    return "";
  } else {
  	if (trim($vv_observer)!="") {
    	$vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id' observer='$vv_observer' _graal_nombre='$vl_e_nombre_types'><menupopup>";
  	} else {
    	$vv_brik="<menulist sizetopopup='none' class='menuitem-iconic' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='$vv_flex' id='$vv_id' _graal_nombre='$vl_e_nombre_types'><menupopup>";
  	}
    while ($row = mysql_fetch_assoc($sql_result)){
      $classe="";
      $vv_brik.="<menuitem class='.$classe.' value='" .fa_remplace_quotes(fa_ent_xml($row['nom'])). "' _graal_cleunik='".$row['journal_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['nom']))."' selected='true'/>";
    }
  }
  $vv_brik.="</menupopup></menulist>";
  _graal_libere_requete_bd($sql_result);
  return $vv_brik;
}
function fa_calcule_echeance_kilometres($vl_qui){
	switch ($vl_qui){
		case "cdecli":$fichier_01="_cdecli_entetes";$date="a1.dateheurecreation as date_doc";break;
		case "faccli":$fichier_01="_faccli_entetes";$date="a1.date_fact as date_doc";break;
		case "avocli":$fichier_01="_avocli_entetes";$date="a1.date_avoi as date_doc";break;
		case "avofin":$fichier_01="_avocli_entetes";$date="a1.date_avoi as date_doc";break;
		case "facfou":$fichier_01="_facfou_entetes";$date="a1.date_fact as date_doc";break;
		case "avofou":$fichier_01="_avofou_entetes";$date="a1.date_avoi as date_doc";break;
		case "avofif":$fichier_01="_avofif_entetes";$date="a1.date_avoi as date_doc";break;
	}
	$sql_req_finale="select a1.commercial_cleunik,a2.pc_cleunik,$date,a1.reg_cleunik,a3.mode_paiement,a1.devise,a1.action_cleunik"; 
	$sql_req_finale.=" from $fichier_01 a1";
	$sql_req_finale.=" left join _act_compta a2 on a1.act_cleunik=a2.act_cleunik ";
	$sql_req_finale.=" left join _modereg_det a3 on a1.reg_cleunik=a3.reg_cleunik";
	$sql_req_finale.=" LEFT JOIN _echeancier a4 on a4.action_cleunik=a1.action_cleunik WHERE a4.action_cleunik IS NULL";
	//echo $sql_req_finale.EOL;
	$result = _graal_requete_bd($sql_req_finale);
	while ($row = mysql_fetch_assoc($result)) {
    $vl_echeance_cleunik=_graal_requete_max("echeance_cleunik","_echeancier");
		$vl_commercial_cleunik=fa_nn($row['commercial_cleunik']);
		$vl_action_cleunik=fa_nn($row['action_cleunik']);
		$vl_pc_cleunik=fa_nn($row['pc_cleunik']);
		$vl_devise_du=fa_nn($row['devise']);
		$vl_devise_paye=$vl_devise_du;
		$vl_date_echeance=date("Y-m-d",fa_calcul_echeance($row['reg_cleunik'],$row['date_doc']));
		$vl_noligne=1;
		$vl_taux_de_change=1;
		$vl_etat=1;
		$vl_mode_paiement=fa_nn($row['mode_paiement']);			
    $sql_req = "INSERT INTO _echeancier set action_cleunik=$vl_action_cleunik,echeance_cleunik=$vl_echeance_cleunik,commercial_cleunik=$vl_commercial_cleunik,pc_cleunik=$vl_pc_cleunik,noligne=$vl_noligne,date_echeance='$vl_date_echeance',devise_du=$vl_devise_du,devise_paye=$vl_devise_paye,taux_de_change=$vl_taux_de_change,mode_paiement=$vl_mode_paiement,dateheurecreation=now(),etat=$vl_etat";
		//echo $sql_req.EOL;
		$vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_echeance_cleunik;} else {$vf_c_echo=-1;}
	}
}
function fa_calcul_echeance($reg_cleunik,$datedoc){
	$sql_req="SELECT c1.codealphanum15,c1.description,c1.blocnotebrut,c1.actif,c2.jour,c2.nbjour,c2.mode_paiement,c2.type_paiement,c2.moisentier,c2.base FROM _modereg c1,_modereg_det c2 where c1.reg_cleunik=$reg_cleunik and c1.reg_cleunik=c2.reg_cleunik;";
	$result = _graal_requete_bd($sql_req);
	$row = mysql_fetch_assoc($result);
	$moisentier=$row['moisentier'];
	$nbjour=$row['nbjour'];
	$jour=$row['jour'];
	$base=$row['base'];
	_graal_libere_requete_bd($result);
	if ($moisentier==1) {
		if ($base==1) {
			return fa_CalculTraite_fdm($datedoc,$nbjour , $jour);
		} else {
			return fa_CalculTraite_fdm_bis($datedoc,$nbjour , $jour);
		}
	} else {
		//return fa_CalculTraite_net($datedoc,$nbjour , $jour);
		return fa_CalculTraite_net_bis($datedoc,$nbjour , $jour);
	}
}
function fa_CalculTraite_fdm($DateDepart, $DelaisReglement, $JourReglement){
	// Calcule la date d'une traite (échéance)
	// Ex : $TimeStamp = CalculTraite('1961-01-23', 90, 15);
	// $Date = date("d/m/Y", $TimeStamp);
	// Date de départ
	$TableDate = explode('-', $DateDepart);
	$Jour = $TableDate[2];
	$Mois = $TableDate[1];
	$Annee = $TableDate[0];
	// Nb de jour a avancer, qu'on calcule plutôt en mois si on peux
	if (($DelaisReglement % 30 == 0) and $DelaisReglement>=30){
		$NbMois = $DelaisReglement / 30;
		$DelaisReglement = 0;
	} else {
		$NbMois = 0;	
	}
	// On controle le Nb de jour maxi dans le mois
	$NbJourMois = date("t", mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement, $Annee));
	if ($JourReglement>$NbJourMois or empty($JourReglement)) {
		$JourReglement = $NbJourMois;
	}
	$d = 0;
	// On avance la date jusqu'au bon jour (exemple : le 15) en plus du délais (30J, 60J...)
	while (date("d", $TimeStamp) != $JourReglement){
		$TimeStamp = mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement+$d, $Annee);
		// On re-controle le Nb de jour maxi dans le mois
		$NbJourMois = date("t", $TimeStamp);
		if ($JourReglement>$NbJourMois) {
			$JourReglement = $NbJourMois;
		}
		$d++;
		if ($d > 31) break; // Sécurité contre une boucle infinie
	}
	return $TimeStamp;
}
function fa_CalculTraite_fdm_bis($DateDepart, $DelaisReglement, $JourReglement){
	// Calcule la date d'une traite (échéance)
	// Ex : $TimeStamp = CalculTraite('1961-01-23', 90, 15);
	// $Date = date("d/m/Y", $TimeStamp);
	// Date de départ
	$TableDate = explode('-', $DateDepart);
	$Jour = $TableDate[2];
	$Mois = $TableDate[1];
	$Annee = $TableDate[0];
	$Jour = date("t", mktime(0, 0, 0, $Mois, 1, $Annee));
	
	$NbMois = 0;
	if ($JourReglement==0){
		$TimeStamp = mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement+$d, $Annee);
		// On re-controle le Nb de jour maxi dans le mois
		$NbJourMois = date("t", $TimeStamp);
		if ($JourReglement>$NbJourMois) {
			$JourReglement = $NbJourMois;
		}
		return $TimeStamp;
	}
	// On controle le Nb de jour maxi dans le mois
	$NbJourMois = date("t", mktime(0, 0, 0, $Mois+$NbMois, $jour+$DelaisReglement, $Annee));
	if ($JourReglement>$NbJourMois or empty($JourReglement)) {
		$JourReglement = $NbJourMois;
	}
	$d = 0;
	// On avance la date jusqu'au bon jour (exemple : le 15) en plus du délais (30J, 60J...)
	while (date("d", $TimeStamp) != $JourReglement){
		$TimeStamp = mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement+$d, $Annee);
		// On re-controle le Nb de jour maxi dans le mois
		$NbJourMois = date("t", $TimeStamp);
		if ($JourReglement>$NbJourMois) {
			$JourReglement = $NbJourMois;
		}
		$d++;
		if ($d > 31) break; // Sécurité contre une boucle infinie
	}
	return $TimeStamp;
}
function fa_CalculTraite_net($DateDepart, $DelaisReglement, $JourReglement){
	// Calcule la date d'une traite (échéance)
		// Ex : $TimeStamp = CalculTraite('1961-01-23', 90, 15);
	// $Date = date("d/m/Y", $TimeStamp);
	// Date de départ
	$TableDate = explode('-', $DateDepart);
	$Jour = $TableDate[2];
	$Mois = $TableDate[1];
	$Annee = $TableDate[0];
	if (($DelaisReglement==0) and ($JourReglement==0)) {
		return mktime(0, 0, 0, $Mois, $Jour, $Annee);
	}
	// Nb de jour a avancer, qu'on calcule plutôt en mois si on peux
	if (($DelaisReglement % 30 == 0) and $DelaisReglement>=30){
		$NbMois = $DelaisReglement / 30;
		$NbMois--;
		$DelaisReglement = 0;
	} else {
		$NbMois = 0;	
	}
	// On controle le Nb de jour maxi dans le mois
	$NbJourMois = date("t", mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement, $Annee));
	$JourReglement = 0;
	/*
	if ($JourReglement>$NbJourMois or empty($JourReglement)) {
		$JourReglement = $NbJourMois;
	}
	*/
	$d = 0;
	// On avance la date jusqu'au bon jour (exemple : le 15) en plus du délais (30J, 60J...)
	while (date("d", $TimeStamp) != $JourReglement){
		$TimeStamp = mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement+$d, $Annee);
		// On re-controle le Nb de jour maxi dans le mois
		$NbJourMois = date("t", $TimeStamp);
		if ($JourReglement>$NbJourMois) {
			$JourReglement = $NbJourMois;
		}
		$d++;
		if ($d > 31) break; // Sécurité contre une boucle infinie
	}
	return $TimeStamp;
}
function fa_CalculTraite_net_bis($DateDepart, $DelaisReglement, $JourReglement){
	// Calcule la date d'une traite (échéance)
		// Ex : $TimeStamp = CalculTraite('1961-01-23', 90, 15);
	// $Date = date("d/m/Y", $TimeStamp);
	// Date de départ
	$TableDate = explode('-', $DateDepart);
	$Jour = $TableDate[2];
	$Mois = $TableDate[1];
	$Annee = $TableDate[0];
	return mktime(0, 0, 0, $Mois, $Jour+$DelaisReglement,  $Annee);
	$dans10jours = date("d/m/Y", mktime(0, 0, 0, $Mois, $Jour+$DelaisReglement,  $Annee));
	if (($DelaisReglement==0) and ($JourReglement==0)) {
		return mktime(0, 0, 0, $Mois, $Jour, $Annee);
	}
		$NbMois = 0;	
	// On controle le Nb de jour maxi dans le mois
	$JourReglement = 0;
	$d = 0;
	// On avance la date jusqu'au bon jour (exemple : le 15) en plus du délais (30J, 60J...)
	while (date("d", $TimeStamp) != $JourReglement){
		$TimeStamp = mktime(0, 0, 0, $Mois+$NbMois, $Jour+$DelaisReglement+$d, $Annee);
		// On re-controle le Nb de jour maxi dans le mois
		$NbJourMois = date("t", $TimeStamp);
		if ($JourReglement>$NbJourMois) {
			$JourReglement = $NbJourMois;
		}
		$d++;
		if ($d > 31) break; // Sécurité contre une boucle infinie
	}
	return $TimeStamp;
}
?>