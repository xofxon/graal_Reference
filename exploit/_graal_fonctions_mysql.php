<?php
session_start();
include("_graal_infos_con_mysql.inc.php");
//  Les infos nécessaires au login sont dans le fichier _graal_infos_con_mysql.inc.php
//$sql_cnx="0";
// SI L'UTILISATEUR ENTRE UN LOGIN OU MOT DE PASSE ERRONNE, DIRECTION VERS LA PAGE :
$url_erreur="http://www.mysql.fr/";
function _graalsql_date($vv_colonne) {
  $vl_c_format_date='EUR';
  return "DATE_FORMAT($vv_colonne, GET_FORMAT(DATE, '$vl_c_format_date'))";
}
function _graalsql_datetime($vv_colonne) {
  $vl_c_format_date='EUR';
  return "concat(DATE_FORMAT($vv_colonne, GET_FORMAT(DATE, '$vl_c_format_date')),' à ',DATE_FORMAT($vv_colonne, GET_FORMAT(TIME, '$vl_c_format_date')))";
}
function _graalsql_time($vv_colonne) {
  $vl_c_format_date='EUR';
  $vl_c_format_date='ISO';
  return "DATE_FORMAT($vv_colonne, GET_FORMAT(TIME, '$vl_c_format_date'))";
}
function _graal_connect_bd() {
  global $sql_serveur,$sql_user,$sql_passwd,$sql_bdd;
  global $sql_cnx;
  global $sql_set_character,$sql_set_collation;


/*
  	$sql_cnx = mysql_connect($sql_serveur, $sql_user, $sql_passwd);
	  // a priori, le @ précédent la fonction permet de supprimer le message d'échec éventuel et donc de bien pouvoir pointer sur la page d'erreur.
	  if (!$sql_cnx) {
	  	//die($sql_cnx);
			//die($sql_serveur.$sql_user.$sql_passwd);
	  		fa_redirige("deconnexion_intempestive");
		}
 */

//
  if (!isset($_SESSION["vs_id_sql_connexion"])) {
  	$sql_cnx = mysql_connect($sql_serveur, $sql_user, $sql_passwd);
	  // a priori, le @ précédent la fonction permet de supprimer le message d'échec éventuel et donc de bien pouvoir pointer sur la page d'erreur.
	  if (!$sql_cnx) {
	  	//die($sql_cnx);
			//die($sql_serveur.$sql_user.$sql_passwd);
	  		fa_redirige("deconnexion_intempestive");
		}
  } else {

  	$sql_cnx=unserialize($_SESSION["vs_id_sql_connexion"]);
  	//$sql_cnx=$_SESSION["vs_id_sql_connexion"];
  	//mysql_select_db($sql_bdd,$sql_cnx) or die("1 Connexion impossible : $sql_cnx $sql_bdd" . mysql_error());
  	//mysql_select_db($sql_bdd,$_SESSION["vs_id_sql_connexion"]) or die("1 Connexion impossible : $sql_cnx $sql_bdd"." ".$_SESSION["vs_id_sql_connexion"]." ". $_SESSION["vs_base_en_clair"] . mysql_error());
  	mysql_query("select actif from _utilisateur where 'a'='b'",$sql_cnx) or die(" 2 Connexion impossible : $sql_cnx" . mysql_error());
  	//echo $sql_cnx;
  }


  //  Primordial d'indiquer cela !!! voir http://dev.mysql.com/doc/refman/5.0/fr/charset-connection.html
  //  Modifié cette gestion depuis que je me suis aperçu, le 27 février 2008, que les requêtes de type "SET" représentaient 5% des requêtes.
  //  Sur mon serveur dédié, le mysql est normalement paramètré de base avec ces paramètres, qui sont donc inutiles (je pense et à vérifier)
  //_graal_requete_bd("SET CHARACTER SET 'utf8';");
  //_graal_requete_bd("SET collation_connection = 'utf8_general_ci';");


  if ($sql_set_character!="") {_graal_requete_bd("$sql_set_character");}
  if ($sql_set_collation!="") {_graal_requete_bd("$sql_set_collation");}


  //mysql_select_db($sql_bdd,$sql_cnx) or die("La base de données " . $sql_bdd ." est introuvable !!-> " . mysql_error());
  mysql_select_db($sql_bdd,$sql_cnx) or fa_redirige("deconnexion_intempestive");
  //mysql_select_db($sql_bdd,$sql_cnx) or die('Connexion impossible : ' . mysql_error());
}
function _graal_exec_requete($sql_req) {
  global $sql_cnx;
  //$sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . mysql_error());
  $sql_result=mysql_query($sql_req,$sql_cnx);
  if($sql_result === false) {
  	$vl_c_retour="Erreur ".mysql_errno($sql_cnx).". La requête a échoué. -> " . mysql_error($sql_cnx) . $sql_req;
  	/*
  		if (mysql_errno($sql_cnx)==2006){
  			_graal_connect_bd();
  			$sql_result=mysql_query($sql_req,$sql_cnx);
	  		if($sql_result === false) {
		  		$vl_c_retour="Aie Aie Aie Erreur ".mysql_errno($sql_cnx).". La requête a échoué. -> " . mysql_error($sql_cnx) . $sql_req;
		 	} else {
		  		$vl_c_retour='ok';
		  	}
  		}
  	*/
  } else {
  	$vl_c_retour='ok';
  }
  return $vl_c_retour;
}
function _graal_exec_requete_debug($sql_req) {
  global $sql_cnx;
  $EOL="\r\n";
  //$sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . mysql_error());
  $sql_result=mysql_query($sql_req,$sql_cnx);
  if($sql_result === false) {$vl_c_retour="La requête a échoué. -> " . mysql_error($sql_cnx);} else {$vl_c_retour='ok';}
  $_SESSION['req_debug']=$sql_req;
  $_SESSION['res_debug']=$vl_c_retour;
  return $vl_c_retour;
}

function _graal_ferme_connexion() {
  /*
   * le 26 janvier 2010, désactivé la fermeture de la connexion
   */
	/*
	global $sql_cnx;
	if (!isset($_SESSION["vs_id_sql_connexion"])) {
		mysql_close($sql_cnx);
	}
	*/
}
function _graal_libere_requete_bd($sql_result) {
  mysql_free_result($sql_result);
}
function _graal_requete_bd($sql_req) {
  global $sql_cnx;
  //$sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . $sql_req. "->".mysql_error());
  $sql_result=mysql_query($sql_req,$sql_cnx);
  if($sql_result === false) {
    $vl_c_retour="La requête a échoué. -> " . mysql_error($sql_cnx);
    $sql_result=mysql_query("select actif from _utilisateur where 'a'='b'",$sql_cnx);
  } else {
    $vl_c_retour='ok';
  }
  return $sql_result;
}
function _graal_requete_bd_brute($sql_req) {
  global $sql_cnx;
//  $sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . $sql_req. "->".mysql_error());
  $sql_result=mysql_query($sql_req,$sql_cnx);
  if($sql_result === false) {
    $vl_c_retour="La requête a échoué. -> " . mysql_error($sql_cnx);
  } else {
    $vl_c_retour='ok';
  }
  return $sql_result;
}
function _graal_requete_bd_debug($sql_req) {
  global $sql_cnx;
  //$sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . $sql_req. "->".mysql_error());
  $sql_result=mysql_query($sql_req,$sql_cnx);
  $_SESSION['req_debug']=$sql_req;
  if($sql_result === false) {
    $vl_c_retour="La requête a échoué. -> " . mysql_error($sql_cnx);
  } else {
    $vl_c_retour='ok';
  }
  $_SESSION['res_debug']=$vl_c_retour;
  return $sql_result;
}
function _graal_requete_bd_silencieuse($sql_req) {
  global $sql_cnx;
  $sql_result=mysql_query($sql_req,$sql_cnx);
  return $sql_result;
}
function _graal_requete_acteur($vl_e_act_cleunik) {
  $sql_req="SELECT raisonsoc as qui,nomcommercial as quiqui FROM _acteurs where _acteurs.act_cleunik=$vl_e_act_cleunik;";
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
	if ($row['qui']=="") {
		$vl_c_qui=fa_ent_xml($row['quiqui']);
	} else {
	  $vl_c_qui=fa_ent_xml($row['qui']);
	}
  _graal_libere_requete_bd($result);
  return $vl_c_qui;
}
function _graal_requete_action($vl_e_action_cleunik) {
  $sql_req="SELECT description as description FROM _actions where _actions.action_cleunik=$vl_e_action_cleunik;";
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_c_description=fa_ent_xml($row['description']);
  _graal_libere_requete_bd($result);
  return $vl_c_description;
}

function _graal_requete_article($vl_e_art_cleunik) {
  $sql_req="SELECT code,mnemotechnique,description,nbdec_prix FROM _article where art_cleunik=$vl_e_art_cleunik;";
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_c_code=fa_ent_xml($row['code']);
  $vl_c_mnemotechnique=fa_ent_xml($row['mnemotechnique']);
  $vl_c_description=fa_ent_xml($row['description']);
  $vl_c_nbdec_prix=fa_ent_xml($row['nbdec_prix']);
  _graal_libere_requete_bd($result);
  return array($vl_c_code,$vl_c_mnemotechnique,$vl_c_description,$vl_c_nbdec_prix);
}
function _graal_requete_interlo($vl_e_int_cleunik) {
//  On recherche les informations sur l'acteur et l'interlocuteur
  $sql_req="SELECT concat_ws(' ',raisonsoc,'(',prenom,patronyme,')') as qui,_act_interlo.act_cleunik as act_cleunik FROM _act_interlo, _acteurs where _acteurs.act_cleunik=_act_interlo.act_cleunik and _act_interlo.int_cleunik=$vl_e_int_cleunik;";
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_c_qui=fa_ent_xml($row['qui']);
  $vl_e_act_cleunik=$row['act_cleunik'];
  _graal_libere_requete_bd($result);
  return array($vl_c_qui,$vl_e_act_cleunik);
}

function _graal_requete_charge_libobj($vl_c_id_fenetre,$vl_e_uti_cleunik) {
  global $sql_cnx;
  //  Pour l'instant, le 21 aout 2006, on ne gère pas les libellés propres à l'utilisateur
  $vl_e_langue=$_SESSION["langue_appli"];
  $vl_c_requete="SELECT _objets.titre as titre,_objets_libelle.descriptif AS descriptif FROM _objets, _objets_libelle WHERE _objets_libelle.langue =$vl_e_langue AND _objets_libelle.fen_cleunik = _objets.fen_cleunik AND _objets.titre = '$vl_c_id_fenetre'";
  $sql_result=mysql_query($vl_c_requete,$sql_cnx) or die("La requête a échouée. -> " . mysql_error());
  while ($row = mysql_fetch_assoc($sql_result))
    {
      $_SESSION[$row['titre']]=$row['descriptif'];
    }
   _graal_libere_requete_bd($sql_result);
}
function _graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik) {
  global $sql_cnx;
	// Le 22 novembre 2008, on gère les libellés propre à l'utilisateur
	if (isset($_SESSION["varlib"])) {$vl_e_langue=$_SESSION["langue_appli"];} else {$vl_e_langue=120131;}

	if (!isset($_SESSION["varlib".$vl_c_id_fenetre."_".$vl_e_uti_cleunik])){
		$_SESSION["varlib".$vl_c_id_fenetre."_".$vl_e_uti_cleunik]=array();

 	if ($vl_e_uti_cleunik=="") {
		// a priori, uniquement lors de l'identification
$vl_c_requete = <<<EOT
SELECT _elements.titre AS titre,_elements_libelle.descriptif AS descriptif,_elements_libelle.uti_cleunik FROM _elements, _elements_libelle, _objets WHERE _elements.ele_cleunik = _elements_libelle.ele_cleunik AND _elements_libelle.langue =$vl_e_langue AND _elements.fen_cleunik = _objets.fen_cleunik AND _objets.titre = '$vl_c_id_fenetre' order by titre
EOT;
 	} else {
$vl_c_requete = <<<EOT
SELECT _elements.titre AS titre,_elements_libelle.descriptif AS descriptif,_elements_libelle.uti_cleunik FROM _elements, _elements_libelle, _objets WHERE _elements.ele_cleunik = _elements_libelle.ele_cleunik AND _elements_libelle.langue =$vl_e_langue AND _elements.fen_cleunik = _objets.fen_cleunik AND _objets.titre = '$vl_c_id_fenetre' and _elements_libelle.uti_cleunik=0 and _elements.ele_cleunik not in (select _elements_libelle.ele_cleunik from _elements_libelle where uti_cleunik = $vl_e_uti_cleunik )
union
SELECT _elements.titre AS titre,_elements_libelle.descriptif AS descriptif,_elements_libelle.uti_cleunik FROM _elements, _elements_libelle, _objets WHERE _elements.ele_cleunik = _elements_libelle.ele_cleunik AND _elements_libelle.langue =$vl_e_langue AND _elements.fen_cleunik = _objets.fen_cleunik AND _objets.titre = '$vl_c_id_fenetre' and _elements_libelle.uti_cleunik=$vl_e_uti_cleunik order by titre
;
EOT;
}
  $sql_result=mysql_query($vl_c_requete,$sql_cnx) or die("La requête a échoué. -> " . mysql_error());
  while ($row = mysql_fetch_assoc($sql_result)){
		$_SESSION["varlib".$vl_c_id_fenetre."_".$vl_e_uti_cleunik][$row['titre']]=$row['descriptif'];
  }
  _graal_libere_requete_bd($sql_result);
}
	foreach($_SESSION["varlib".$vl_c_id_fenetre."_".$vl_e_uti_cleunik] as $cle => $valeur) {
		$_SESSION[$cle]=$valeur;
	}
}
function _graal_requete_droits_fenetre($vv_id_fenetre,$vl_e_uti_cleunik) {
  global $sql_cnx;
	if (!isset($_SESSION["droits_fenetre".$vv_id_fenetre."_".$vl_e_uti_cleunik])) {
		$vs_envaa=fa_recup_session('vs_envaa','0');	//	Nombre d'utilisateurs
		if ($vs_envaa==1){
			$_SESSION["droits_fenetre".$vv_id_fenetre."_".$vl_e_uti_cleunik]=array(1,1,1,1,1 );
		} else {
		  $vl_c_requete="SELECT _droits_uti_fen.duf_acces as duf_acces,_droits_uti_fen.duf_ajout as duf_ajout,_droits_uti_fen.duf_modif as duf_modif,_droits_uti_fen.duf_suppr as duf_suppr,_droits_uti_fen.duf_impri as duf_impri from _droits_uti_fen,_objets where _droits_uti_fen.uti_cleunik=$vl_e_uti_cleunik and _droits_uti_fen.fen_cleunik=_objets.fen_cleunik and _objets.titre='$vv_id_fenetre'";
		  $sql_result = mysql_query($vl_c_requete,$sql_cnx);
		  if (!$sql_result) {
		      $vv_c_cr="Impossible d'exécuter la requête ($vl_c_requete) dans la base : " . mysql_error();
		      die($vv_c_cr);
		      exit;
		  }
		  if (mysql_num_rows($sql_result) == 0) {
		      $vv_c_cr="Aucune ligne trouvée, rien à afficher.";
		      //  On fixe une règle de gestion qui sera à affiner :
		      //    si on ne trouve pas d'enregistrement de gestion des droits, c'est qu'on n'a aucun droit d'accès
		      return array(0,0,0,0,0 );
		      ////    si on ne trouve pas d'enregistrement de gestion des droits, on estime qu'il a les droits en consultation
		      //return array(1,0,0,0,0 );
		      //return($vv_c_cr);
		  }
		  $row = mysql_fetch_assoc($sql_result);

		  $vv_c_cr="C'est tout bon ...";
			$_SESSION["droits_fenetre".$vv_id_fenetre."_".$vl_e_uti_cleunik]=array($row['duf_acces'], $row['duf_ajout'], $row['duf_modif'],$row['duf_suppr'], $row['duf_impri'] );
		  _graal_libere_requete_bd($sql_result);
		}
	}
	return $_SESSION["droits_fenetre".$vv_id_fenetre."_".$vl_e_uti_cleunik];
}
function _graal_requete_regle($vv_id_regle) {
  global $sql_cnx;
  //$vl_c_requete="SELECT _objets.fen_acces as fen_acces from _objets where _objets.titre='$vv_id_regle'";
  if (isset($_SESSION["langue_appli"])) {$vl_e_langue=$_SESSION["langue_appli"];} else {$vl_e_langue=120131;}
  $vl_c_requete="SELECT _objets.fen_acces as fen_acces ,_objets_libelle.descriptif AS descriptif FROM _objets_libelle, _objets WHERE  _objets_libelle.langue=$vl_e_langue AND _objets_libelle.fen_cleunik = _objets.fen_cleunik AND _objets.titre = '$vv_id_regle'";
  $sql_result = mysql_query($vl_c_requete,$sql_cnx);
  if (!$sql_result) {
      $vv_c_cr="Impossible d'exécuter la requête ($vl_c_requete) dans la base : " . mysql_error();
      die($vv_c_cr);
      exit;
  }
  if (mysql_num_rows($sql_result) == 0) {
      $vv_c_cr="Aucune ligne trouvée, rien à afficher.";
      return array(0,0,0,0,0,'' );
  }
  $row = mysql_fetch_assoc($sql_result);
  $vv_c_cr="C'est tout bon ...";
  return array($row['fen_acces'], 0, 0,0, 0,$row['descriptif']);
  _graal_libere_requete_bd($sql_result);
    //return($vv_c_cr);
}
function _graal_requete_max($_vl_c_nomcolonne,$vl_c_nomtable) {
  $vl_e_mini=intval(fa_recup_session('borne_mini','0'));
  $vl_e_maxi=intval(fa_recup_session('borne_maxi','0'));
  $sql_cle = "select max($_vl_c_nomcolonne) as maxcleunik from $vl_c_nomtable where $_vl_c_nomcolonne between $vl_e_mini and $vl_e_maxi";
  if ($res = _graal_requete_bd($sql_cle)) {
    if($ligne = mysql_fetch_row($res)) {
        $vl_e_doc_cleunik=$ligne[0];
        if (is_null($vl_e_doc_cleunik)) {
          $vl_e_doc_cleunik=$vl_e_mini+1;
        }
        else
          $vl_e_doc_cleunik=$vl_e_doc_cleunik+1;
    }
    else
      $vl_e_doc_cleunik=$vl_e_mini+1;
   }
   return($vl_e_doc_cleunik);
}
function _graal_requete_max_choix_gestion() {
  $vl_e_mini=0;
  $vl_e_maxi=9999999;
  $sql_cle = "select max(choix_cleunik) as maxcleunik from _choix where choix_cleunik between $vl_e_mini and $vl_e_maxi";
  if ($res = _graal_requete_bd($sql_cle)) {
    if($ligne = mysql_fetch_row($res)) {
        $vl_e_doc_cleunik=$ligne[0];
        if (is_null($vl_e_doc_cleunik)) {
          $vl_e_doc_cleunik=$vl_e_mini+1;
        }
        else
          $vl_e_doc_cleunik=$vl_e_doc_cleunik+1;
    }
    else
      $vl_e_doc_cleunik=$vl_e_mini+1;
   }
   return($vl_e_doc_cleunik);
}
function _graal_requete_max_particuliere($_vl_c_nomcolonne,$vl_c_nomtable,$vl_e_mini=0,$vl_e_maxi=999999999999) {
  $sql_cle = "select max($_vl_c_nomcolonne) as maxcleunik from $vl_c_nomtable where $_vl_c_nomcolonne between $vl_e_mini and $vl_e_maxi";
  if ($res = _graal_requete_bd($sql_cle)) {
    if($ligne = mysql_fetch_row($res)) {
        $vl_e_doc_cleunik=$ligne[0];
        if (is_null($vl_e_doc_cleunik)) {
          $vl_e_doc_cleunik=$vl_e_mini+1;
        }
        else
          $vl_e_doc_cleunik=$vl_e_doc_cleunik+1;
    }
    else
      $vl_e_doc_cleunik=$vl_e_mini+1;
   }
   return($vl_e_doc_cleunik);
}
function _graal_requete_nombre_affecte($sql_req) {
  global $sql_cnx;
  $sql_result=mysql_query($sql_req,$sql_cnx);
  return mysql_affected_rows();
}
function _graal_requete_ob($sql_req) {
  global $sql_cnx;
  $sql_result=mysql_query($sql_req,$sql_cnx) or die("La requête a échoué. -> " . mysql_error());
  return mysql_fetch_object($sql_result);
}
function _graal_requete_trace_fenetre($vv_id_fenetre) {
      $sql_cle = "select max(uticonnexions_cleunik) as maxcleunik from _uti_connexions";
      if ($res = _graal_requete_bd($sql_cle)) {
        if($ligne = mysql_fetch_row($res)) {
            $vf_e_cleunik=$ligne[0];
            if (is_null($vf_e_cleunik)) {
              $vf_e_cleunik=1;
            }
            else
              $vf_e_cleunik+=1;
        }
        else
          $vf_e_cleunik=1;
       }
        else
          echo (mysql_error($cnx) . $sql_cle);
      $vl_c_infosconnexion="";
      $vl_c_infosconnexion.=fa_xcree_entete_xml();
      $vl_c_infosconnexion.='<parametres>';
      $vl_c_infosconnexion.='<ip_brute data="'.fa_ent_xml($_SERVER["REMOTE_ADDR"]).'"/>';
      $vl_c_infosconnexion.='<gethostbyadress data="'.fa_ent_xml(gethostbyaddr($_SERVER["REMOTE_ADDR"])).'"/>';
      $vl_c_infosconnexion.='<navigateur data="'.fa_ent_xml($_SERVER["HTTP_USER_AGENT"]).'"/>';
      $vl_c_infosconnexion.='<typedeserveur data="'.fa_ent_xml($_SERVER["SERVER_SIGNATURE"]).'"/>';
      //$vl_c_infosconnexion.='<origine data="'.fa_ent_xml($_SERVER["HTTP_REFERER"]).'"/>';
      $vl_c_infosconnexion.='</parametres>';
      $sql_req = "INSERT INTO _uti_connexions set uti_cleunik=". $_SESSION['vs_uti_cleunik'].",uticonnexions_cleunik=$vf_e_cleunik,dateheuredebutconnexion = now(),infos_ip = '".gethostbyaddr($_SERVER["REMOTE_ADDR"])."',infos_connexion='".$vl_c_infosconnexion."',infos_fenetres='".$vv_id_fenetre."'";
      {
       $res = _graal_requete_bd($sql_req);
          if($res === false)
             echo 'Erreur';
          else
             $vf_c_echo='ok';
      }
}
function _graal_requete_uuid() {
  global $sql_cnx;
  $sql_result=mysql_query("SELECT UUID() as uuid",$sql_cnx) or die("La requête a échouée. -> " . mysql_error());
  while ($row = mysql_fetch_assoc($sql_result)) {
    $vl_c_uuid=$row['uuid'];
    _graal_libere_requete_bd($sql_result);
    return($vl_c_uuid);
  }
}
_graal_connect_bd();
?>
