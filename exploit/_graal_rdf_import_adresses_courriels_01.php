<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_mail.php");
define('EOL', "\r\n");
$vl_e_imp_cleunik=intval(fa_recup_param('vl_e_imp_cleunik','0'));
$vl_e_verification_syntaxe=intval(fa_recup_param('vl_e_verification_syntaxe','1'));
$sql_req="select _w_import_courriel_ligne.imp_cleunik as z01,_w_import_courriel_ligne.lig_cleunik as z02,_w_import_courriel_ligne.refweb as z03,_w_import_courriel_ligne.prenom as z04,_w_import_courriel_ligne.nom as z05,(select count(*) from _act_interlo_mail where _act_interlo_mail.refweb=_w_import_courriel_ligne.refweb) as z06,_w_import_courriel_ligne.valide as z07,(select count(*) from _w_import_courriel_ligne f2 where f2.refweb=_w_import_courriel_ligne.refweb and f2.imp_cleunik=$vl_e_imp_cleunik) as z08,_w_import_courriel_ligne.emailing as z09 from _w_import_courriel_ligne where _w_import_courriel_ligne.imp_cleunik=$vl_e_imp_cleunik;";
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
while ($row = mysql_fetch_assoc($result)){
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>'.EOL);
  echo('<row:imp_cleunik NC:parseType="Integer">'.fa_ent_xml($row['z01']).'</row:imp_cleunik>');
  echo('<row:lig_cleunik NC:parseType="Integer">'.fa_ent_xml($row['z02']).'</row:lig_cleunik>');
  if ($row['z06']!=0) {
    echo('<row:nombre_deja>'.fa_ent_xml($row['z06']).'</row:nombre_deja>');
    echo('<row:val_nombre_deja NC:parseType="Integer">'.fa_ent_xml($row['z06']).'</row:val_nombre_deja>');
  } else {
    echo('<row:nombre_deja></row:nombre_deja>');
    echo('<row:val_nombre_deja NC:parseType="Integer">0</row:val_nombre_deja>');
  }
  echo('<row:refweb>'.fa_ent_xml($row['z03']).'</row:refweb>');
  echo('<row:prenom>'.fa_ent_xml($row['z04']).'</row:prenom>');
  echo('<row:nom>'.fa_ent_xml($row['z05']).'</row:nom>');
  echo('<row:valide>'.fa_ent_xml($row['z07']).'</row:valide>');
  switch ($row['z07']) {
    case 1:$vl_c_prop_valide='am01';break;
    case 2:$vl_c_prop_valide='am02';break;
    case 3:$vl_c_prop_valide='am03';break;
  }

  echo('<row:prop_valide>'.$vl_c_prop_valide.'</row:prop_valide>');  
  echo('<row:emailing>'.fa_ent_xml($row['z09']).'</row:emailing>');
  switch ($row['z09']) {
    case 1:$vl_c_prop_emailing='am01';break;
    case 2:$vl_c_prop_emailing='am02';break;
    case 3:$vl_c_prop_emailing='am03';break;
  }
  echo('<row:prop_emailing>'.$vl_c_prop_emailing.'</row:prop_emailing>');  

  if ($row['z08']!=1) {
    echo('<row:nombre_doublon>'.fa_ent_xml($row['z08']).'</row:nombre_doublon>');
    echo('<row:nombre_doublon_bis>'.fa_ent_xml($row['z08'])."-".fa_ent_xml($row['z03']).'</row:nombre_doublon_bis>');
  } else {
    echo('<row:nombre_doublon>'."".'</row:nombre_doublon>');
    echo('<row:nombre_doublon_bis>'."0".'</row:nombre_doublon_bis>');
  }
  if ($vl_e_verification_syntaxe==1) {
    //$vl_c_mailacontroler=$row['z03'];
    $vl_c_mailacontroler=str_replace(' ', '', $row['z03']);
    if(!ff_verifie($vl_c_mailacontroler)){ 
      $vl_c_syntaxe_courriel="Attention, syntaxiquement, '$vl_c_mailacontroler' n'est pas une adresse e-mail valide.";
    } else {
      $vl_c_syntaxe_courriel="Syntaxiquement, '$vl_c_mailacontroler' est une adresse e-mail valide.";
      $vl_c_syntaxe_courriel="Ok";
    }
    echo('<row:controle_01>'.fa_ent_xml($vl_c_syntaxe_courriel).'</row:controle_01>');
  }
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
