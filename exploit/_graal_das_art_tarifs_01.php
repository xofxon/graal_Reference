<?php
include("_graal_header_xml.inc.php");
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","10000113"));
$vl_actif=intval(fa_recup_param("actif",3));
$vl_e_type_tarifs=intval(fa_recup_param("vl_e_type_tarifs",'-1'));
$vl_e_tarif_cleunik=intval(fa_recup_param("vl_e_tarif_cleunik",'-1'));
define('EOL', "\r\n");
$sql_req ="SELECT _acteurs.act_cleunik as act_cleunik,tar_cleunik,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference,";
$sql_req.=" choix_code,choix_valeur_texte_01,nomcommercial,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,quantite_basse,quantite_haute, ";
$sql_req.=" "._graalsql_date('_art_tarifs.dateheure_dermaj')." as datemaj ";
$sql_req.=" FROM _article,_art_tarifs,_choix,_acteurs where choix_cleunik=tarif_cleunik and _art_tarifs.art_cleunik=$vl_e_art_cleunik and _article.art_cleunik=$vl_e_art_cleunik ";
$sql_req.=" and _acteurs.act_cleunik=_art_tarifs.act_cleunik and type=$vl_e_type_tarifs";
if ($vl_e_tarif_cleunik!=-20){
	$sql_req.=" and tarif_cleunik=$vl_e_tarif_cleunik";
}
switch ($vl_actif) {
  case 1 : $sql_req.= " and _art_tarifs.actif=1";break;
  case 2 : $sql_req.= " and _art_tarifs.actif=2";break;
  case 3 : break;
}
$sql_req.=" order by quantite_haute asc,choix_valeur_texte_01;";
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
//echo $sql_req.EOL;
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
    echo(' tar_cleunik_type="'.fa_ent_xml($row['tar_cleunik']).'"');
    echo(' act_cleunik_particulier="'.fa_ent_xml($row['act_cleunik']).'"');
    echo(' code_type="'.fa_ent_xml($row['choix_code']).'"');
    echo(' designation_type="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
    echo(' tarif_type="'.fa_ent_xml($row['pu_reference']).'"');
    echo(' nomacteur_particulier="'.fa_ent_xml($row['nomcommercial']).'"');
    if ($row['actif']==1) {
      echo(' properties=""');
    } else {
      echo(' properties="css_0001"');
    }
    $datevalidite=fa_ent_xml($row['datevalidite']);
    if ($datevalidite=="00.00.0000"){$datevalidite="";}
    echo(' datevalidite="'.$datevalidite.'"');
    $datemaj=fa_ent_xml($row['datemaj']);
    if ($datemaj=="00.00.0000"){$datemaj="";}
    echo(' datemaj="'.$datemaj.'"');
    $borne_basse=fa_reel(fa_ent_xml($row['quantite_basse']),0);
 	$val_borne_basse=fa_ent_xml($row['quantite_basse'])*1000;
 	if ($borne_basse==0){$borne_basse="";}
  	echo(' borne_basse="'.$borne_basse.'"');
  	printf(' val_borne_basse="%011u"',$val_borne_basse);
  	$borne_haute=fa_reel(fa_ent_xml($row['quantite_haute']),0);
  	if ($borne_haute==0){$borne_haute="";}
 	$val_borne_haute=fa_ent_xml($row['quantite_haute'])*1000;
  	echo(' borne_haute="'.$borne_haute.'"');
  	printf(' val_borne_haute="%011u"',$val_borne_haute);
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
