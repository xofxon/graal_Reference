<?php
include("_graal_header_txt.inc.php");
define('EOL', "\r\n");
$t_origines_ok=array();
$t_origines_ok[0]="???";
//fa_acces_script();
$vf_c_echo="";
$vl_echeance_cleunik=intval(fa_recup_param('echeance_cleunik','-1'));
$vf_c_action=fa_recup_param("vf_c_action","??????");
//IMPORTANT IMPORTANT IMPORTANT IMPORTANT
//Bien penser à utiliser intval pour convertir les données numériques
//Bien penser à utiliser intval pour convertir les données numériques
//Bien penser à utiliser intval pour convertir les données numériques
$vl_commercial_cleunik=fa_recup_param("vl_commercial_cleunik","");
$vl_pc_cleunik=fa_recup_param("vl_pc_cleunik","");
$vl_noligne=fa_recup_param("vl_noligne","");
$vl_date_paiement=fa_recup_param("vl_date_paiement","");
$vl_date_echeance=fa_recup_param("vl_date_echeance","");
$vl_libelle=fa_recup_param("vl_libelle","");
$vl_montant_du=fa_recup_param("vl_montant_du","");
$vl_montant_paye=fa_recup_param("vl_montant_paye","");
$vl_devise_du=fa_recup_param("vl_devise_du","");
$vl_devise_paye=fa_recup_param("vl_devise_paye","");
$vl_taux_de_change=fa_recup_param("vl_taux_de_change","");
$vl_mode_paiement=fa_recup_param("vl_mode_paiement","");
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_dateheurecreation=fa_recup_param("vl_dateheurecreation","");
$vl_dateheuremodif=fa_recup_param("vl_dateheuremodif","");
$vl_etat=fa_recup_param("vl_etat","");
switch (TRUE) {
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _echeancier WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_echeance_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _echeancier set pc_cleunik='$vl_pc_cleunik',noligne='$vl_noligne',date_paiement='$vl_date_paiement',date_echeance='$vl_date_echeance',libelle='$vl_libelle',montant_du='$vl_montant_du',montant_paye='$vl_montant_paye',devise_du='$vl_devise_du',devise_paye='$vl_devise_paye',taux_de_change='$vl_taux_de_change',mode_paiement='$vl_mode_paiement',blocnotebrut='$vl_blocnotebrut',dateheurecreation='$vl_dateheurecreation',dateheuremodif='$vl_dateheuremodif',etat='$vl_etat' WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_echeance_cleunik;} else {$vf_c_echo=-1;}
    break;
	case $vf_c_action=="solder":
    $sql_req = "UPDATE _echeancier set blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),etat=6 WHERE echeance_cleunik = $vl_echeance_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="ok";} else {$vf_c_echo=-1;}
    break;	
	case $vf_c_action=="kilometres_solder":
		$vl_t_echeance=fa_recup_param("vl_t_echeance","");
		$vl_t_fic_eche=fa_recup_param("vl_t_fic_eche","");
		$vl_t_echeance=unserialize(stripslashes($vl_t_echeance));
		$vl_t_fic_eche=unserialize(stripslashes($vl_t_fic_eche));
		/*
		var_dump($vl_t_fic_eche);
		var_dump($vl_t_echeance);
		die(toto);
		*/
		$vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_echeance as $vl_raf) {
      $vl_e_i++;
      $vl_echeance_cleunik=$vl_t_echeance[$vl_e_i];
      $fichier=$vl_t_fic_eche[$vl_e_i];
	    $sql_req = "UPDATE _echeancier set blocnotebrut='$vl_blocnotebrut',dateheuremodif=now(),etat=6 WHERE echeance_cleunik = $vl_echeance_cleunik;";
	    //echo $sql_req.EOL;
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="ok";} else {$vf_c_retour.=-1;}
    }
    
    break;			
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
