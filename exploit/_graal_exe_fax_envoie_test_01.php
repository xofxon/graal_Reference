<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_cryptage.php");
require_once('tcpdf/tcpdf.php');
require_once("PHPMailer/class.phpmailer.php");
define('EOL', "\n");
$vl_e_compte=intval(fa_recup_param('vl_e_compte','0'));
$vl_e_fax_dest=fa_recup_param('vl_c_fax_dest','');
$vl_e_fax_dest=trim($vl_e_fax_dest);

$sql_req = "SELECT compte AS compte FROM _uti_cpt_bal where uticptbal_cleunik=$vl_e_compte";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
$vl_c_id=$vl_c_xml->id[0]->attributes();
$vl_c_qualite=$vl_c_xml->qualite[0]->attributes();
$vl_c_type_compte=$vl_c_xml->type_compte[0]->attributes();
$vl_c_motdepasse=$vl_c_xml->motdepasse[0]->attributes();
$vl_c_adresse_cr_fax=$vl_c_xml->adresse_cr_fax[0]->attributes();
switch ($vl_c_qualite){
	case 1 :$vl_c_qualite_clair="normal";break;
	case 2 :$vl_c_qualite_clair="hight";break;
	case 3 :$vl_c_qualite_clair="best";break;
}
$vl_c_destinataire="$vl_e_fax_dest@ecofax.fr";
//$vl_c_destinataire="christophe.charron@gmail.com";
$vl_c_corpus="password:$vl_c_motdepasse".EOL."quality:$vl_c_qualite_clair".EOL;
$sess_id=session_id();
$vl_c_message="Ceci est un fax de test, envoyé par XsOFt-graal";
$vl_c_uuid=_graal_requete_uuid();
$nom_fichier="fax_test".$vl_c_uuid.".pdf";
$path_pj="mail/$nom_fichier";
// Confection du pdf
$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
// set document information
$pdf->SetCreator(PDF_CREATOR);
//set margins
$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
//set auto page breaks
$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
//set image scale factor
$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO); 
//initialize document
$pdf->AliasNbPages();
$pdf->setPrintHeader(false);
$pdf->setPrintFooter(false);  //  Définir ce que l'on mettra dans le pied
// add a page
$pdf->AddPage();
$length = $pdf->GetStringWidth( $vl_c_message );
$pdf->MultiCell($length, 4, $vl_c_message);
$pdf->Output("$path_pj",'F');
$mime=fa_mime_type_buffer(file_get_contents($path_pj));
unset($pdf);
$vl_c_uuid=_graal_requete_uuid();
$mail = new PHPmailer();
$mail->IsSMTP();
$mail->CharSet = 'utf-8';
$mail->IsHTML(false);
//$mail->Host='christophe-charron.org';	//	Plante ... Pourquoi ?
$mail->From="$vl_c_adresse_cr_fax";
//$mail->AddCC("techos@christophe-charron.org","Service Technique");	//	On envoie une copie au destinataire de réponse !!!!!!!!!!!!!!!!!!!! A SUPPRIMER EN PROD ON PASSE LE MOT DE PASSE 
$mail->AddAddress("$vl_c_destinataire");
$mail->Subject="$vl_c_id";
$mail->Body="$vl_c_corpus";
$mail->AddAttachment("$path_pj","$nom_fichier","base64",$mime);
if(!$mail->Send()){
  echo $mail->ErrorInfo; 
}
else{	  
  echo 'Fax envoyé avec succès. ';
}
$mail->SmtpClose();
unset($mail);
?>
