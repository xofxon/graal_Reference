<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_prospect');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vf_e_typeacteur=110001;
$vl_e_critere_cleunik=94;
$vl_e_val_defaut=-110100;
$prospect_cod=array();$prospect_cle=array();
$sql_req="select act_cleunik,codealphanum15 from _acteurs where typeacteur=$vf_e_typeacteur;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($prospect_cod, $row['codealphanum15']);
  array_push ($prospect_cle, $row['act_cleunik']);
}
_graal_libere_requete_bd($result);  
$cri01_cod=array();$cri01_cle=array();
$sql_req="select choix_cleunik,choix_code from _choix where critere_cleunik=$vl_e_critere_cleunik;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($cri01_cod, $row['choix_code']);
  array_push ($cri01_cle, $row['choix_cleunik']);
}
_graal_libere_requete_bd($result);  
$sql_req = "SELECT IdInt as `IdInt`,Code as `Code`,Description as `Description`,date(DateP) as `DateP`,Time(HeureP) as `HeureP`,DureeP as `DureeP`,Date(DateR) as `DateR`,Time(HeureR) as `HeureR`,TempPasse as `TempPasse`,ParMinute as `ParMinute`,CoutUnit as `CoutUnit`,Total as `Total`,Executant as `Executant`,Auteur as `Auteur`,OperationCours as `OperationCours`,CodeTiers as `CodeTiers`,TypeDocument as `TypeDocument`,Chemin as `Chemin`,Commentaire as `Commentaire`,Reponse as `Reponse`,Prevenir as `Prevenir`,DelaiAvant as `DelaiAvant`,TypeDelai as `TypeDelai`,`Appel émis le` as `Appel émis le`,`Appel recu le` as `Appel recu le`,`Rappel prévu le` as `Rappel prévu le`,`RAPP SEM` as `RAPP SEM`,`Envoyé le` as `Envoyé le` FROM $vl_c_base_origine.action order by IdInt ;";
$result = _graal_requete_bd($sql_req);

$sql_req="INSERT INTO $vl_c_base_destination._actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurefin,dateheurecreation,description,c_uuid) VALUES ";
$sql_req_graal="INSERT INTO $vl_c_base_destination._graal (act_cleunik,int_cleunik,action_cleunik,choix_cleunik,portee,principal) VALUES ";
$sql_req_02="";
$sql_req_03="";
$i=0;$b=200;
while ($row = mysql_fetch_assoc($result)) {
  $vf_e_action_cleunik=$row['IdInt'];
  $vl_e_trouve=array_search($row['Code'], $cri01_cod);
  if ($vl_e_trouve===false) {$vl_e_choix_cleunik=$vl_e_val_defaut;} else {$vl_e_choix_cleunik=$cri01_cle[$vl_e_trouve];}
  $vl_uuid=_graal_requete_uuid();
  $i++;
  $sql_req_02 .="($vf_e_action_cleunik,$vl_e_choix_cleunik,'".$row['DateP'].' '.$row['HeureP']."','".$row['DateR'].' '.$row['HeureR']."','".$row['DateP'].' '.$row['HeureP']."','".addslashes($row['Commentaire'])."','$vl_uuid'),";

  $vl_e_trouve=array_search($row['CodeTiers'], $prospect_cod);
  if ($vl_e_trouve===false) {$vl_e_act_cleunik=0;} else {$vl_e_act_cleunik=$prospect_cle[$vl_e_trouve];}
  $sql_req_03 .="($vl_e_act_cleunik,0,$vf_e_action_cleunik,-110402,8192,2),";
  if ($i % $b==0){
    $sql_req_02=substr($sql_req_02, 0, -1);
    $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
    if($result_02 === false) {$vf_c_echo='Erreur 02 ->'.mysql_error($cnx) . $sql_req_02;} else {$vf_c_echo='ok';}
    $sql_req_02="";

    $sql_req_03=substr($sql_req_03, 0, -1);
    $result_03 = _graal_requete_bd($sql_req_graal.$sql_req_03);
    if($result_03 === false) {$vf_c_echo='Erreur 03 ->'.mysql_error($cnx) . $sql_req_03;} else {$vf_c_echo='ok';}
    $sql_req_03="";

  }
}
if ($sql_req_02!="") {
  $sql_req_02=substr($sql_req_02, 0, -1);
  $result_02 = _graal_requete_bd($sql_req.$sql_req_02);
  if($result_02 === false) {$vf_c_echo='Erreur 02 ->'.mysql_error($cnx) . $sql_req_02;} else {$vf_c_echo='ok';}
  $sql_req_03=substr($sql_req_03, 0, -1);
  $result_03 = _graal_requete_bd($sql_req_graal.$sql_req_03);
  if($result_03 === false) {$vf_c_echo='Erreur 03 ->'.mysql_error($cnx) . $sql_req_03;} else {$vf_c_echo='ok';}
  $sql_req_03="";
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo($vf_c_echo);
?>
