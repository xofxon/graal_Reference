<?php
include("_graal_var_portee.php");
$vl_e_portee=$vl_e_articl;
$vl_c_bdl_102=fa_recup_dico_js("bdl_102");
switch ("$vl_c_type") {
  case '1': //  Normal
  case '6': //  Avec gestion Critères traitements de masse
    $pf_alimente_table="function pf_alimente_table() {fa_approximatif_bbo();}";
    $pf_aa_init_01="fa_ael('bbo_ml_qui','ValueChange',po_change_menu);po_change_menu();";

    break;
  case '2': //  Choix
  case '3': //  Critère
$pf_alimente_table=<<<EOT
function pf_alimente_table(){
  var vl_c_toto="";
  var vl_e_panier='&vl_e_panier=&';
  vl_c_toto=vf_c_script_das_article+'?vl_c_recherche='+fa_enc('%')+"&vl_c_zone=1&vl_c_type=1&vl_c_qui=tous&vl_e_actif=0&raf_random='"+Math.random();
  vl_c_toto+="&vl_e_choix_cleunik="+fa_att_get("_graal_ove_bdx_datas","_graal_choix_cleunik");
  vl_c_toto+="&vl_e_critere_cleunik="+fa_att_get("_graal_ove_bdx_datas","_graal_critere_cleunik")+"&vl_c_t01="+fa_att_get("_graal_ove_bdx_datas","_graal_quoi")+"&";
  if (fa_gid("cb_actifs_oui").checked==true){vl_c_toto+="vl_e_actif=1&";}
  if (fa_gid("cb_actifs_non").checked==true){vl_c_toto+="vl_e_inactif=2&";}
  vl_c_url_alimente_table=vl_c_toto+"sortie=das&"+vl_e_panier;
  vf_c_recup_requete=vl_c_toto+"sortie=sql&"+vl_e_panier;
  fa_ds("arbre_des_articles","");fa_ds("arbre_des_articles",vl_c_url_alimente_table);
}
EOT;
$pf_aa_init_01="";
  break;
	
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_t_panier=[];
const vf_c_script_bdope_fen="_graal_bdope_traitements_articles_01.php";
const vf_c_script_das_article='_graal_das_articles_01.php';
const vf_c_script_var='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_article';
const vf_c_script_bdope_panier='_graal_bdope_paniers_01.php';
const cf_fen_choix_critere="_graal_fen_sel_choix_criteres.php?vl_e_domaine=$vl_e_articl&genrecritere=";
const vf_c_script_bdope_fen_criteres="_graal_bdope_art_criteres_01.php?";

function pf_renvoie() {
	
	var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_article=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_articles_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_article[i]=fa_cell_get("arbre_des_articles_panier",vl_t_tableau[i],"art_cleunik_panier");
    }
		if (window.opener!=null) {
      try {
        window.opener.pf_retour_selection_articles(vl_t_article);
				window.close();
        //setTimeout(close, 0);
      } catch(e) {
         alert(e)
      }
    }
  } else {
  	alert("Vous n'avez rien sélectionné du panier.");
		return;
  }
}
function pf_aa_init() {
  fa_att_set("arbre_des_articles",'seltype','multiple');
  fa_att_set("arbre_des_articles",'context','pop_selections');
  fa_att_set("arbre_des_articles",'onselect','');
  fa_att_set("arbre_des_articles",'onclick','');
  fa_att_set("arbre_des_articles_panier",'seltype','multiple');
  fa_att_set("arbre_des_articles_panier",'context','pop_panier');
  fa_att_set("arbre_des_articles_panier",'onselect','');
  fa_att_set("arbre_des_articles_panier",'onclick','');
  $pf_aa_init_01
  pf_alimente_table();
}
$pf_alimente_table
function pf_article_active() {
  var vl_t_article=[];
  vl_t_article=pf_tab_articles();
  vl_e_nb_sel=vl_t_article.length;
  if (vl_e_nb_sel!=0) {
    if (confirm("$vl_c_bdl_102("+vl_e_nb_sel+")")!=true) {return};
    vl_c_donnees="vf_c_action=kilometres_activer&";
    vl_c_donnees+="vl_t_article="+fa_enc(fa_jsarray2php_00(vl_t_article))+"&";
    fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
  }
}
function pf_article_desactive() {
  var vl_t_article=[];
  vl_t_article=pf_tab_articles();
  vl_e_nb_sel=vl_t_article.length;
  if (vl_e_nb_sel!=0) {
    if (confirm("$vl_c_bdl_102("+vl_e_nb_sel+")")!=true) {return};
    vl_c_donnees="vf_c_action=kilometres_desactiver&";
    vl_c_donnees+="vl_t_article="+fa_enc(fa_jsarray2php_00(vl_t_article))+"&";
    fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
  }
}
function pf_article_duplique_compta_reference(){
 var vl_t_article=[];
  vl_t_article=pf_tab_articles();
  vl_e_nb_sel=vl_t_article.length;
  if (vl_e_nb_sel!=0) {
    if (confirm("$vl_c_bdl_102("+vl_e_nb_sel+")")!=true) {return};
    vl_c_donnees="vf_c_action=dupliquer_compta_reference&";
    vl_c_donnees+="vl_t_article="+fa_enc(fa_jsarray2php_00(vl_t_article))+"&";
    fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
  }
}
function pf_article_ouvre() {
  var i=fa_cui("arbre_des_articles");if(i==-1){return;}
  var vl_e_art_cleunik=fa_cell_get("arbre_des_articles",i,"art_cleunik");
	fa_ouvre_article('genre=tousss&vl_e_art_cleunik='+vl_e_art_cleunik+"&","");
}
function pf_critere_action(vv_quoi) {
  var vl_t_article=[];
  vl_t_article=pf_tab_articles();
  var vl_c_donnees="";
  if (vl_t_article.length==0) {return;}
  switch (vv_quoi) {
    case 'sup':
      vl_c_donnees="vf_c_action=critere_sup&vl_e_critere_cleunik=$vl_e_critere_cleunik&";
      vl_c_donnees+="vl_t_article="+fa_enc(fa_jsarray2php_00(vl_t_article))+"&";
      fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
      break;
  }
}
function pf_choix_action(vv_quoi) {
  var vl_t_article=[];
  vl_t_article=pf_tab_articles();
  var vl_c_donnees="";
  if (vl_t_article.length==0) {return;}
  switch (vv_quoi) {
    case 'sup':
      vl_c_donnees="vf_c_action=choix_sup&vl_e_choix_cleunik=$vl_e_choix_cleunik&";
      break;
    case 'ajo':
      vl_c_donnees="vf_c_action=choix_ajo&vl_e_choix_cleunik=$vl_e_choix_cleunik&vl_e_critere_cleunik=$vl_e_critere_cleunik&";
      break;
  }
  vl_c_donnees+="vl_t_article="+fa_enc(fa_jsarray2php_00(vl_t_article))+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_enleve_choix_critere() {
	if (!confirm("Confirmez-vous la suppression de ce choix de critère pour les articles sélectionnés ?")){return;}
	pf_valide_criteres('suppression');
    fa_cache_oui("bt_sup_choix");
}
function pf_ouvre_choix_critere(vv_quoi) {
  fa_att_set("_graal_ajout_ove_bdc_datas","_graal_critere_qui",vv_quoi);
  fa_ouvre(cf_fen_choix_critere+vv_quoi+"&",800,400);
}
function pf_ouvre_choix_critere_recup(vv_critere_cleunik,vv_choix_cleunik,vv_c_critere_denomination,vv_c_choix_valeur_texte_01) {
fa_cache_non("vb_criteres_panier");
  fa_cache_non("bt_sup_choix");
  fa_att_set("_graal_ajout_ove_bdc_datas","_graal_choix_cleunik",vv_choix_cleunik);
  fa_att_set("_graal_ajout_ove_bdc_datas","_graal_critere_cleunik",vv_critere_cleunik);
	fa_value_set("tb_ajout_critere_denomination",vv_c_critere_denomination);
  fa_value_set("tb_ajout_choix_valeur_texte_01",vv_c_choix_valeur_texte_01);
}
function pf_panier_ajoute() {
  var vl_t_article=pf_tab_articles();
  if (vl_t_article.length==0) {return;}
  var vl_t_panier=[];
  vl_t_panier=vf_t_panier;
  vf_t_panier=vl_t_panier.concat(vl_t_article);
  fa_remove_attribute("bt_voir_panier","collapsed");
  fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
}
function pf_panier_enleve() {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_articles_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_panier=[];
    var vl_t_article=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_article[i]=fa_cell_get("arbre_des_articles_panier",vl_t_tableau[i],"art_cleunik_panier");
    }
    var j=0;k=-1;
    for(i=0;i<vf_t_panier.length;i++) {
      if (vl_t_article.indexOf(vf_t_panier[i])==-1) { 
        k++;
        vl_t_panier[k]=vf_t_panier[i];
      }  
    }
    vf_t_panier=vl_t_panier;
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
  }
}
function pf_tab_articles(){
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_article=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_articles");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_article[i]=fa_cell_get("arbre_des_articles",vl_t_tableau[i],"art_cleunik");
    }
  }
  return vl_t_article;
} 
function pf_tableau_donnees_fin(stream) {
  fa_das("arbre_des_articles_panier",vf_c_script_das_article+'?vl_c_type=0&vl_e_actif=0&raf_random='+Math.random()+'&')
}
function pf_recup_requete(vv_export) {
  vf_c_export=vv_export;
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_articles_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_acteur=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_acteur[i]=fa_cell_get("arbre_des_articles_panier",vl_t_tableau[i],"art_cleunik_panier");
    }
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vl_t_acteur),pf_recup_requete_01);
  }
}
function pf_recup_requete_01() {
  fa_xmlhttprequest_txt(vf_c_script_das_article,'sortie=sql&vl_c_type=0&vl_c_qui=888888&raf_random='+Math.random()+'&',pf_recup_requete_fin);
}
function pf_recup_requete_fin(stream) {
  var vl_datas = stream;
  switch (vf_c_export) {
    case "ods":fa_exporte_requete_vers_ods(vl_datas);break;
    case "rdf":fa_exporte_requete_vers_rdf(vl_datas);break;
    case "htm":fa_exporte_requete_vers_htm(vl_datas);break;
    case "xml":fa_exporte_requete_vers_xml(vl_datas);break;
    case "xls":fa_exporte_requete_vers_xls(vl_datas);break;
    }
}

function pf_validation_fin(stream) {
  var vl_datas = stream;
  alert(vl_datas);
  fa_approximatif_bbo();
}

function pf_valide_criteres(vv_quoi) {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_articles_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_article=[];
    var vl_te_choix_cleunik=[];
    var vl_te_critere_cleunik=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_article[i]=fa_cell_get("arbre_des_articles_panier",vl_t_tableau[i],"art_cleunik_panier");
      vl_te_choix_cleunik[i]=fa_att_get("_graal_ajout_ove_bdc_datas","_graal_choix_cleunik");
      vl_te_critere_cleunik[i]=fa_att_get("_graal_ajout_ove_bdc_datas","_graal_critere_cleunik");
    }
    var vl_c_donnees="genrecritere="+fa_enc(fa_att_get("_graal_ajout_ove_bdc_datas","_graal_critere_qui"))+"&";
    vl_c_donnees+="vl_te_art_cleunik="+fa_enc(fa_jsarray2php_00(vl_t_article))+"&";
    vl_c_donnees+="vl_te_choix_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_choix_cleunik))+"&";
    vl_c_donnees+="vl_te_critere_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_critere_cleunik))+"&";
    switch (vv_quoi) {
    	case "ajout":
    		vl_c_donnees+="vf_c_action=enregistrer_kilometre_bis&";
    		break;
    	case "suppression":
    		vl_c_donnees+="vf_c_action=supprimer_kilometre&";
    		break;
    }
	fa_grise_fenetre("","oui");
    fa_xmlhttprequest_txt(vf_c_script_bdope_fen_criteres,vl_c_donnees,pf_valide_criteres_fin);
  }
}
function pf_valide_criteres_fin(stream) {
  alert(stream);
  fa_vide_arbre("arbre_des_articles_panier");
  vf_t_panier=[];
  pf_voir_deck(0);
  pf_alimente_table();
  fa_grise_fenetre("","non");
}


function pf_valide_danspanier() {
  var vl_e_nb=fa_cl("arbre_des_articles_panier");
  if (vl_e_nb==0) {return;}
  var vl_c_liste=""
  for(i=0;i<vl_e_nb;i++) { 
    vl_c_liste+=fa_cell_get("arbre_des_articles_panier",i,"art_cleunik_panier")+","
  }
  vl_c_liste=vl_c_liste.substring(0,vl_c_liste.length-1)
  var vl_c_titrepanier=prompt("Titre du nouveau panier : ");
  if (vl_c_titrepanier==null) {alert("Création du panier abandonnée.");return}
  vl_c_donnees="";
  vl_c_donnees+="vl_uti_cleunik=$vl_e_uti_cleunik&";
  vl_c_donnees+="vl_panier_titre="+fa_enc(vl_c_titrepanier)+"&";
  vl_c_donnees+="vl_panier_portee=$vl_e_portee&";
  vl_c_donnees+="vl_panier_type=1&";
  vl_c_donnees+="vl_actif=1&";
  vl_c_donnees+="vl_panier_resultat="+vl_c_liste+"&";
  vl_c_donnees+="vl_c_action=ajouter_panier&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_panier,vl_c_donnees,pf_valide_danspanier_fin);
}
function pf_valide_danspanier_fin(stream) {
  var vl_datas = stream;
  alert(vl_datas);
}
function pf_valide_requete() {
  vf_titre_requete=prompt("Donnez un titre à votre requête ...");
  if(vf_titre_requete==null) {alert("Requête abandonnée.");return;}
  fa_xmlhttprequest_txt(vf_c_recup_requete,'',pf_valide_requete_01);
}
function pf_valide_requete_01(stream) {
  var vl_c_requete=stream,vl_c_donnees="";
  vl_c_donnees+="vl_uti_cleunik=$vl_e_uti_cleunik&";
  vl_c_donnees+="vl_blocnote_brut="+fa_enc(fa_value_get("tb_enclair")+" : "+fa_value_get("tb_critere_denomination")+" ("+fa_value_get("tb_choix_valeur_texte_01")+")")+"&";
  vl_c_donnees+="vl_panier_portee=$vl_e_portee&";
  vl_c_donnees+="vl_panier_type=2&";
  vl_c_donnees+="vl_panier_requete_selection="+vl_c_requete+"&";
  vl_c_donnees+="vl_panier_titre="+fa_enc(vf_titre_requete)+"&";
  vl_c_donnees+="vl_c_action=ajouter&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_panier,vl_c_donnees,pf_valide_danspanier_fin);
}
function pf_voir_deck(vv_lequel) {
  fa_gid("deck_articles").selectedIndex=vv_lequel;
}

]]></script>
END;
?>
