<?php
$vl_c_code_pays='';$vl_e_max_info=0;
switch ($vl_e_genreiban) {
  case "121500": $vl_c_code_pays='FR';$vl_e_max_info=27;break;
  case "121625": $vl_c_code_pays='LT';$vl_e_max_info=20;break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_iban_01.php?";
const vf_c_script_edite="_graal_xml_act_iban_01.php?";
var vf_c_action;
var vf_e_iban_cleunik;
function pf_aa_init() {
  vf_e_iban_cleunik="$vl_e_iban_cleunik";
  switch (vf_e_iban_cleunik) {
    case "-1":  //  création
      pf_etat_fen("ajouter");
      break;
    default:
      pf_etat_fen("ini");
      pf_selectionne_iban();
      break;
  }
}
function pf_affiche_datas(stream) {
  var vl_c_datas = stream;
  fa_value_set("tb_bic",fa_xml_get(vl_c_datas,'iban_bic'));
  fa_value_set("tb_z01",fa_xml_get(vl_c_datas,'z01'));
  fa_value_set("tb_z02",fa_xml_get(vl_c_datas,'z02'));
  fa_value_set("tb_z03",fa_xml_get(vl_c_datas,'z03'));
  fa_value_set("tb_z04",fa_xml_get(vl_c_datas,'z04'));
  fa_value_set("tb_z05",fa_xml_get(vl_c_datas,'z05'));
  fa_value_set("tb_z06",fa_xml_get(vl_c_datas,'z06'));
  fa_value_set("tb_z07",fa_xml_get(vl_c_datas,'z07'));
  fa_value_set("tb_z08",fa_xml_get(vl_c_datas,'z08'));
  fa_value_set("tb_z09",fa_xml_get(vl_c_datas,'z09'));
  fa_value_set("tb_z10",fa_xml_get(vl_c_datas,'z10'));
  fa_value_set("tb_info",fa_xml_get(vl_c_datas,'iban_info'));
}
function pf_alimente_defaut() {}
function pf_etat_fen(vv_quoi) {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_sortir");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_bic");
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_bic");
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      switch (vf_e_iban_cleunik)      {
        case "-1":  //  création
          pf_etat_fen("ajouter");
          break;
        default:
          pf_etat_fen("ini");
          pf_selectionne_rib();
          break    
      }
      break;
    case "sortir":
      window.close();
      break;
    default:
      break;
  }
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
  switch ("$vl_c_genreacteur") {
    case "110001": window.opener.pf_affiche_donnees_iban_cli();break;
    case "110003": window.opener.pf_affiche_donnees_iban_cli();break;
    case "110004": window.opener.pf_affiche_donnees_iban_fou();break;
  }
  if (vl_datas!="-1") {
    switch (vf_c_action){
      case "ajouter":
        break;
      case "modifier":
        break;
      case "supprimer":
        alert("IBAN supprimé.")
        break;
    }
    pf_etat_fen("sortir");
  }
  else {alert(vl_datas);pf_etat_fen("annuler");}
}
function pf_gere_suivant(vv_qui) {
  var vl_c_valeur=vv_qui.value;
  fa_gid("tb_info").value=fa_gid("tb_z01").value+fa_gid("tb_z02").value+fa_gid("tb_z03").value+fa_gid("tb_z04").value+fa_gid("tb_z05").value+fa_gid("tb_z06").value+fa_gid("tb_z07").value+fa_gid("tb_z08").value+fa_gid("tb_z09").value+fa_gid("tb_z10").value
  if (vv_qui.getAttribute("maxlength")==vl_c_valeur.length) {
    if (vv_qui.getAttribute("_graal_suivant")!='') {fa_focusdonne(vv_qui.getAttribute("_graal_suivant"));}
  }
}
function pf_raz_fiche() {
  fa_value_set("tb_info","");
  fa_value_set("tb_bic","");
  fa_value_set("tb_z01","");
  fa_value_set("tb_z02","");
  fa_value_set("tb_z03","");
  fa_value_set("tb_z04","");
  fa_value_set("tb_z05","");
  fa_value_set("tb_z06","");
  fa_value_set("tb_z07","");
  fa_value_set("tb_z08","");
  fa_value_set("tb_z09","");
  fa_value_set("tb_z10","");
}
function pf_selectionne_iban() {
  var s ="vl_e_iban_cleunik="+vf_e_iban_cleunik+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var vl_c_donnees ="";
  vl_c_donnees+="vl_iban_cleunik="+fa_enc(vf_e_iban_cleunik)+"&";
  vl_c_donnees+="vl_bic="+fa_enc(fa_value_get("tb_bic"))+"&";
  vl_c_donnees+="vl_info="+fa_enc(fa_value_get("tb_info"))+"&";
  vl_c_donnees+="vl_papi="+fa_enc(fa_gid("tb_z01").value+' '+fa_gid("tb_z02").value+' '+fa_gid("tb_z03").value+' '+fa_gid("tb_z04").value+' '+fa_gid("tb_z05").value+' '+fa_gid("tb_z06").value+' '+fa_gid("tb_z07").value+' '+fa_gid("tb_z08").value+' '+fa_gid("tb_z09").value+' '+fa_gid("tb_z10").value)+"&";
  vl_c_donnees+="vl_act_cleunik=$vl_e_act_cleunik&";
  vl_c_donnees+="vl_pays=$vl_e_genreiban&";
  switch(vv_quoi) {
    case "enregistrer":
      if (pf_verification()!=true) {return;}
      if (vf_e_iban_cleunik!=-1) {
        vl_c_donnees+="vf_c_action=modifier&";
        vf_c_action="modifier"; }
      else { 
        vl_c_donnees+="vf_c_action=ajouter&";
        vf_c_action="ajouter"; }
      break;
    case "supprimer":
        Check = confirm("Confirmez-vous la suppression de cet IBAN ?");
        if(Check == false) return;
        vl_c_donnees+="vf_c_action=supprimer&"
        vf_c_action="supprimer";
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}

function pf_verif_iban(acodepays, aRIB){
/*
    *
    * Récupéré ici :http://www.parodie.com/monetique/rib_iban.htm
    * Author & Copyright 2001 : Laurent PELE (laurent@pele.org , http://www.pele.org)
    * It is not allowed for anybody to modify this source code or remove author name or copyright statement.
    * You can only reproduce it on your local hard drive, this softwarecan not be diffuse on network
*/    
	var lcodepays, lRIB, lConcat, lNb, lIBAN, lCodeNum, lCodeStr, li, lRetenue, lCle, lNbInterm, lStrInterm;
	lRIB=litnombreIBAN(aRIB);
	lcodepays=litnombreIBAN(acodepays);
	if ((acodepays.length!=2) || (lcodepays.length!=4))	{
		alert("Le code pays n'a pas 2 lettres");
		return "";
	}
	lConcat=lRIB+lcodepays+"00";
	// découpage par bloc de 9 chiffres pour calculer le modulo (pb de précision)
	li=0;
	lRetenue="";
	while (li<eval(lConcat.length))	{
		lStrInterm=lRetenue+lConcat.substring(li, li+9);
		lNbInterm=parseFloat(lStrInterm);
		lCle=lStrInterm % 97;
		lRetenue=""+lCle;
		li=li+9;
	}
	lCodeNum=98-(lCle % 97);
	if (lCodeNum<10){lCodeStr="0"+lCodeNum;}else{lCodeStr=""+lCodeNum;}
	lIBAN=acodepays+lCodeStr+aRIB;
	return lIBAN;
}

function litnombreIBAN(aChaineNombre){
	// retire les espaces les points et autres caractères différents des nombres
	// pour les lettres A à Z, remplacement par un nombre :
	// A remplacé par 10 ... Z remplacé par 35
	var li=0;
	var lNb;
	var lChaine=""+aChaineNombre;
	var lChaineRes="";
	while (li<eval(lChaine.length))	{
		if (lChaine.charCodeAt(li)<48 || lChaine.charCodeAt(li)>57)		{
			if (lChaine.charCodeAt(li)>=65 || lChaine.charCodeAt(li)<=90)			{
				lNb=lChaine.charCodeAt(li)-55;
				lChar=""+lNb;
				lChaineRes=lChaineRes+lChar;
			}
			else {
				if (lChaine.charCodeAt(li)>=97 || lChaine.charCodeAt(li)<=122) {
					lNb=lChaine.charCodeAt(li)-87;
					lChar=""+lNb;
					lChaineRes=lChaineRes+lChar;
				}
				else {	
					// on retire le caractère indésirable
				}
			}
		}
		else {
			lChaineRes=lChaineRes+lChaine.substring(li,li+1);
		}
		li++;
	}
	return lChaineRes;
}
function pf_verification() {
  //  On recalcule la clé en fonction du pays et des données entrées. C'est une vérification minimale !!
  var vl_c_chaine=fa_value_get("tb_info");
  var vl_c_extrait=vl_c_chaine.substring(4,$vl_e_max_info);
  var vl_c_iban=pf_verif_iban("$vl_c_code_pays", vl_c_extrait);
  if (vl_c_chaine==vl_c_iban) {return true;} else {alert('IBAN incorrect : '+vl_c_iban+'<>'+vl_c_chaine); return false;}
}
]]></script>
END;
?>
