<?php
$vl_c_bsk_106_js=fa_recup_dico_js("bsk_106");
$vl_c_bsk_108_js=fa_recup_dico_js("bsk_108");
$vl_c_bsk_109_js=fa_recup_dico_js("bsk_109");
$vl_c_bsk_111_js=fa_recup_dico_js("bsk_111");$vl_c_bsk_111_js="Confirmez-vous la re-comptabilisation de ces factures ?";
if ("$vl_c_visu"=="oui") {
$pf_sel_ligne_visu=<<<EOT
	vl_c_genre="$vl_c_genreaction"
	vl_c_donnees="vf_e_action_cleunik="+fa_enc(vf_e_action_cleunik)+"&vf_c_action=modifier&genreaction="+fa_enc(vl_c_genre)+"&";
    fa_att_set("graal_iframe_visu_action","src",vf_c_script_fen_action+vl_c_donnees);
EOT;
} else {
	$pf_sel_ligne_visu="";
}

switch ($vl_c_destination){
	case "edition":	//	Edition de factures
		$param_bp00="vl_commercial_cleunik=-2&vl_genre_adresse=2&vl_c_fichier_seul=oui&vl_e_action_cleunik=";
		switch ($vl_c_genreaction){
			case "faccli":
				$param_generaux_graal_009=intval(fa_recup_session('vs_param_generaux_graal_009','0'));
				switch ($param_generaux_graal_009) {
				  case 1:$vf_c_script_modele_faccli="_graal_pdf_faccli_01.php?$param_bp00";break;  //  Modele 1
				  case 2:$vf_c_script_modele_faccli="_graal_pdf_faccli_02.php?$param_bp00";break;  //  Modele 2
				  case 3:$vf_c_script_modele_faccli="_graal_pdf_faccli_03.php?$param_bp00";break;  //  Modele 3
				  case 4:$vf_c_script_modele_faccli="_graal_pdf_faccli_04.php?$param_bp00";break;  //  Modele 4
				  case 5:$vf_c_script_modele_faccli="_graal_pdf_faccli_05.php?$param_bp00";break;  //  Modele 5
				  case 6:$vf_c_script_modele_faccli="_graal_pdf_faccli_06.php?$param_bp00";break;  //  Modele 5
				}
				break;
			case "avocli":
				$param_generaux_graal_029=intval(fa_recup_session('vs_param_generaux_graal_029','0'));
				switch ($param_generaux_graal_029) {
				  case 1:$vf_c_script_modele_avocli="_graal_pdf_avocli_01.php?$param_bp00";break;  //  Modele 1
				  case 2:$vf_c_script_modele_avocli="_graal_pdf_avocli_02.php?$param_bp00";break;  //  Modele 2
				  case 3:$vf_c_script_modele_avocli="_graal_pdf_avocli_03.php?$param_bp00";break;  //  Modele 2
				  case 4:$vf_c_script_modele_avocli="_graal_pdf_avocli_04.php?$param_bp00";break;  //  Modele 3
				  case 5:$vf_c_script_modele_faccli="_graal_pdf_avocli_05.php?$param_bp00";break;  //  Modele 5
				  case 6:$vf_c_script_modele_faccli="_graal_pdf_avocli_06.php?$param_bp00";break;  //  Modele 6
				}
				break;
			case "facfou":
			case "avofou":
				break;	
		}
		break;
}		
switch ($vl_c_destination){
	case "edition":	//	Edition de factures
		$pf_validation=<<<EOT
function pf_validation(){
	var nombre=vf_t_panier.length;
	var pasdeprogression=100/nombre;
	if (nombre==0){alert("$vl_c_bsk_108_js");return;}
	if (!confirm("$vl_c_bsk_106_js")){return;}
	fa_cache_oui("bt_enregistrer");
	fa_cache_non("pm_evolution_01");
	fa_grise_fenetre("","oui");
	var pasdeprogression=100/nombre;
	for(i=0;i<nombre;i++) {
      	progression=parseInt(fa_value_get("pm_evolution_01")) + pasdeprogression;
      	fa_value_set("pm_evolution_01",progression);
  		var http = new XMLHttpRequest();
 		http.open("GET","$vf_c_script_modele_faccli"+vf_t_panier[i]+"raf_random="+Math.random()+"&",false);
  		http.send("");
  		vf_t_doc_faccli_retour.push(http.responseText);
	}
	fa_cache_oui("pm_evolution_01");
	fa_value_set("pm_evolution_01",0);
	fa_cache_non("bt_enregistrer");
	var http = new XMLHttpRequest();
 	http.open("GET","_graal_cree_variable_session_tempo.php?var=vs_concat_pdf&vl_t_listecles="+fa_enc(fa_jsarray2php_00(vf_t_doc_faccli_retour)),false);
  	http.send("");
	fa_ouvre("_graal_exe_concat_pdf.php?var=vs_concat_pdf");
	fa_grise_fenetre("","non");
}
EOT;
		break;
	case "compta":	//	Comptabilisation de factures
	case "decompta":	//	dé-Comptabilisation de factures
		$pf_validation=<<<EOT
function pf_validation(vv_quoi){
	var nombre=vf_t_panier.length;
	var pasdeprogression=100/nombre;
	if (nombre==0){alert("$vl_c_bsk_108_js");return;}
	switch (vv_quoi){
		case "compta":
		case "decompta":
			if (!confirm("$vl_c_bsk_106_js")){return;}
			break;
		case "recompta":
			if (!confirm("$vl_c_bsk_111_js")){return;}
			break;
	}
	fa_cache_oui("bt_enregistrer");
	fa_cache_oui("bt_recomptabilise");
	fa_grise_fenetre("","oui");
	var vl_c_donnees="";
	switch (vv_quoi){
		case "compta":vl_c_donnees="quoi=compta_seule&";break;
		case "decompta":vl_c_donnees="quoi=enleve&";break;
		case "recompta":vl_c_donnees="quoi=compta_seule&";break;
	}
	vl_c_donnees+="vl_tab_action_cleunik="+fa_enc(fa_jsarray2php_00(vf_t_panier))+"&";
	vl_c_donnees+="vl_commercial_cleunik=-3&";
	vl_c_donnees+="genreaction=$vl_c_genreaction&";
	fa_xmlhttprequest_txt("_graal_exe_docial_comptabilise.php?",vl_c_donnees,pf_validation_fin);
}
function pf_validation_fin(stream){
	vf_t_panier=[];
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
    pf_approximatif_bem();
    alert("$vl_c_bsk_109_js")
    fa_cache_non("bt_enregistrer");
    fa_cache_non("bt_recomptabilise");
}
EOT;
		break;		
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_var='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_action';
const vf_c_script_das_action='_graal_das_actions_01.php?';
var vf_t_panier=[],vf_t_doc_faccli_retour=[];
const vf_c_script_fen_action='_graal_fen_actions_02.php?';
var vf_e_action_cleunik=-1,vf_e_choix_cleunik;
const lstn_grise = { 
	willRebuild : function(event){},
	didRebuild  : function(event){pf_grise_fenetre_non();} 
};
function pf_aa_init_bem(vv_choix_date){
  fa05_sel_date(vv_choix_date,'bem_tb_deb','bem_tb_fin');
  //fa_att_set("ml_genre_action_rech","oncommand","pf_approximatif_bem()");
  fa_att_set("arbre_actions_01","context","pop_selections");
  fa_att_set("arbre_des_actions_panier",'context',"pop_panier");
  fa_check("me_tb_deb_21");
	fa_badl("arbre_actions_01",lstn_grise);
	fa_badl("arbre_des_actions_panier",lstn_grise);
	fa_ael("bem_tb_limit","input",pf_approximatif_bem);
      fa_grise_oui('ml_genre_action_rech');
      pf_approximatif_bem();
}
function pf_action_ouvre(vv_qui){
  var rowIndex = fa_cui(vv_qui);if(rowIndex == -1){return;}
  var vl_e_action_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_action_cleunik");
  var vl_e_choix_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_choix_cleunik");
  vl_c_genre="$vl_c_genreaction";
  vl_c_donnees="vf_e_action_cleunik="+fa_enc(vl_e_action_cleunik)+"&vf_c_action=modifier&genreaction="+fa_enc(vl_c_genre)+"&";
  fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
}
function pf_approximatif_bem() {
	var vl_c_statuts=fa_mlget_check("ml_statut_action_rech");
	var vl_c_priorit=fa_mlget_check("ml_priori_action_rech");
	var vl_c_genress=fa_mlget_check("ml_genre_action_rech");
	var vl_c_concerne_qui="&vl_c_concerne_qui="+fa_mlget("bem_ml_concerne_qui","value")+'&';
	var vl_c_spec="";
	switch (fa_value_get("ml_action_spec")){
		case "-1":
			vl_c_spec="&spec=-1&spec_quoi="+fa_mlget("ml_action_spec","_graal_cleunik")
			break;
		case "-2":
			vl_c_spec="&spec=-2&spec_quoi="+fa_mlget("ml_action_spec","_graal_cleunik")
			break;
		default:
			break;
	}
	var vl_c_datedeb=fa_value_get("bem_tb_deb");
	var vl_c_datefin=fa_value_get("bem_tb_fin");
	vl_c_datedeb=vl_c_datedeb.replace("-", "", "gi");
	vl_c_datefin=vl_c_datefin.replace("-", "", "gi");
      var vl_c_script="",vl_c_date="",vl_c_url_alimente_table="";
      if ( fa_value_get("bem_tb_rechapproxima") == "" ) {return;}
      vl_c_url_alimente_table=vf_c_script_das_action+vl_c_concerne_qui+'&vl_c_particularisme=$vl_c_particularisme&vl_c_lesquelles=toutes_principales&raf_random='+Math.random()+'&vl_c_quelleplage=debut&vl_c_dateheuredebut='+fa_enc(vl_c_datedeb)+'&vl_c_dateheurefin='+fa_enc(vl_c_datefin)+"&vl_e_limit="+fa_value_get("bem_tb_limit")+'&vl_c_recherche='+fa_enc(fa_value_get("bem_tb_rechapproxima"))+'&vl_e_genre='+vl_c_genress+'&vl_e_statut='+vl_c_statuts+'&vl_operat='+fa_mlget("bem_ml_operat","value")+'&vl_operat_genre='+fa_mlget("bem_ml_operat_genre","value")+"&vl_zone="+fa_mlget("bem_ml_zone","value")+"&vl_type_recherche="+fa_mlget("bem_ml_type_recherche","value")+"&vl_e_priorite="+vl_c_priorit+"&vl_operat_priorite="+fa_mlget("bem_ml_operat_priori","value")+'&';
	vl_c_url_alimente_table+=vl_c_spec;
	vl_c_url_alimente_table+="&vl_operat_confiden="+fa_mlget("bem_ml_operat_confid","value")+'&vl_e_confiden='+fa_mlget_check("ml_confid_action_rech");
	pf_grise_fenetre_oui();
  fa_das("arbre_actions_01",vl_c_url_alimente_table);
}
function pf_dblclick_arbre_actions_bem(){
  if($vl_b_modif==false) {return};
  var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
  vf_e_action_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik");
  vf_e_choix_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_choix_cleunik");
  pf_etat_fen_bem("modifier");
}
function pf_etat_fen_bem(vv_quoi){
  var vl_c_donnees="";
  switch(vv_quoi) {
    case "sortir":
      window.close();
      break;   
  }
}
function pf_grise_fenetre_non(){
	fa_grise_non("bem_tb_limit");
	fa_grise_non("bem_ml_operat_genre");
	fa_grise_non("ml_genre_action_rech");
	fa_grise_non("ml_statut_action_rech");
	fa_grise_non("bem_ml_operat");
	fa_grise_non("bem_ml_actif");
	fa_grise_non("bem_ml_zone");
	fa_grise_non("bem_tb_rechapproxima");fa_ro_non("bem_tb_rechapproxima");
	fa_grise_non("bem_ml_type_recherche");
	fa_grise_non("bem_tb_deb");
	fa_grise_non("bem_tb_fin");
	fa_grise_non("bem_tb_limit");
	fa_grise_non("bem_tb_rafraichir");
	fa_grise_fenetre("","non");
}
function pf_grise_fenetre_oui(){
	fa_grise_oui("bem_tb_limit");
	fa_grise_oui("bem_ml_operat_genre");
	fa_grise_oui("ml_genre_action_rech");
	fa_grise_oui("ml_statut_action_rech");
	fa_grise_oui("bem_ml_operat");
	fa_grise_oui("bem_ml_actif");
	fa_grise_oui("bem_ml_zone");
	fa_grise_oui("bem_tb_rechapproxima");fa_ro_oui("bem_tb_rechapproxima");
	fa_grise_oui("bem_ml_type_recherche");
	fa_grise_oui("bem_tb_deb");
	fa_grise_oui("bem_tb_fin");
	fa_grise_oui("bem_tb_limit");
	fa_grise_oui("bem_tb_rafraichir");
	fa_grise_fenetre("","oui");
}
function pf_onunload(){
	fa_brl("arbre_actions_01",lstn_grise);
	fa_gid("bem_tb_limit").removeEventListener("input",pf_approximatif_bem, false);
}
function pf_ouvre_acteur(vv_qui,vv_quoi) {
  vl_c_param="&vl_c_proc_retour=pf_ouvre_acteur_recup_livcli&";
  fa_ouvre(c_script_recherche_acteurs+vl_c_param+"vl_e_genreacteur="+vv_qui+"&",800,600);
}
function pf_panier_ajoute() {
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  var vl_t_panier=[];
  vl_t_panier=vf_t_panier;
  vf_t_panier=vl_t_panier.concat(vl_t_action);
  fa_remove_attribute("bt_voir_panier","collapsed");
  fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
}
function pf_panier_enleve() {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_actions_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_panier=[];
    var vl_t_action=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_action[i]=fa_cell_get("arbre_des_actions_panier",vl_t_tableau[i],"tc_action_cleunik");
    }
    var j=0;k=-1;
    for(i=0;i<vf_t_panier.length;i++) {
      if (vl_t_action.indexOf(vf_t_panier[i])==-1) { 
        k++;
        vl_t_panier[k]=vf_t_panier[i];
      }  
    }
    vf_t_panier=vl_t_panier
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
  }
}
function pf_tab_actions(){
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_action=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_actions_01");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_action[i]=fa_cell_get("arbre_actions_01",vl_t_tableau[i],"tc_action_cleunik");
    }
  }
  return vl_t_action;
} 
function pf_tableau_donnees_fin(stream) {
  fa_das("arbre_des_actions_panier",vf_c_script_das_action+'vl_c_lesquelles=selection&raf_random='+Math.random())
}
function pf_sel_ligne_bem()  {
  vf_e_action_cleunik=-1;
  var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
  vf_e_action_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik");
	vf_e_choix_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_choix_cleunik");
	$pf_sel_ligne_visu
}
$pf_validation
function pf_voir_action(){
  var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
	var vl_c_donnees="vf_e_action_cleunik="+fa_enc(fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik"))+"&vf_c_action=modifier&genreaction=jenesaispas&";
	fa_att_set("graal_iframe_visu_action","src",vf_c_script_fen_action+vl_c_donnees);
}
]]></script>
END;
?>
