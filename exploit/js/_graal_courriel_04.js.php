<?php
$vl_c_bqe_109js=fa_recup_dico_js("bqe_109");
$vl_c_bqe_110js=fa_recup_dico_js("bqe_110");
$vl_c_bqe_111js=fa_recup_dico_js("bqe_111");
$vl_c_bqe_112js=fa_recup_dico_js("bqe_112");
$vl_c_bqe_113js=fa_recup_dico_js("bqe_113");
$vl_c_bqe_114js=fa_recup_dico_js("bqe_114");
$vl_c_bqe_115js=fa_recup_dico_js("bqe_115");
$vl_c_bqe_116js=fa_recup_dico_js("bqe_116");
if ($vl_b_importation_possible==true){
$proc_validation=<<<EOT
function pf_upload_courriel(vv_quelle_ligne) {
	fa_gid("bt_explications").label="$vl_c_bqe_110js ("+(vf_ligne_pj_a_lire+1)+'/'+vf_nombre_pj+")";
	var item1 = fa_gid("li_courriels").getItemAtIndex(vv_quelle_ligne);
	var vl_c_nomfic=item1.childNodes[0].getAttribute('label');
	var vl_nombre_fichier=parseInt(item1.childNodes[3].getAttribute('label'));
 	vf_nombre_pj_lues++;
  if (vl_nombre_fichier==0) {
		fa03_fichier_lit_et_envoie(c_upload_courriel+vf_compte_cleunik+"raf="+Math.random()+"&vl_e_sequence_envoi="+vf_t_sequence[1]+"&",pf_upload_courriel_suite,vl_c_nomfic);
	} else {
		var vl_t_sequence=[];
		vl_t_sequence[0]=-1;
		vl_t_sequence[1]=vf_t_sequence[1];
		pf_upload_courriel_suite("-1"+"|"+vf_t_sequence[1]);
	}
}
function pf_upload_courriel_suite(vv_data) {
	var tableau_retour=vv_data.split('|');
	switch (tableau_retour[0]) {
		case "-1":
			break;
		default:
			var item1 = fa_gid("li_courriels").getItemAtIndex(vf_ligne_pj_a_lire);
			vf_t_cleunik.push(tableau_retour[0]);
			vf_t_sequence[1]=tableau_retour[1];
			item1.childNodes[1].setAttribute('label',"$vl_c_bqe_111js "+tableau_retour[1]);
			item1.childNodes[3].setAttribute('label',vv_data);
	}
	if (vf_nombre_pj_lues!=vf_nombre_pj) {
		vf_ligne_pj_a_lire++;
		pf_upload_courriel(vf_ligne_pj_a_lire);
	} else {
		pf_validation_fin(vf_t_sequence[1]);
	}
}
function pf_verifie_hash_fin() {
	alert("$vl_c_bqe_113js");
	fa_cache_non("boite_enregistrer");
	fa_grise_fenetre("","non");
}
function pf_validation(){
	fa_grise_fenetre("","oui");
	vf_nombre_pj=fa_gid("li_courriels").getRowCount();
	vf_compte_cleunik=fa_mlget('ml_emetteur');
  vf_t_cleunik=[];
	vf_t_sequence=[];
	vf_t_sequence[0]=-1;
	vf_t_sequence[1]=0;
	vf_nombre_pj_lues=0;
	vf_ligne_pj_a_lire=0;
	if (vf_nombre_pj!=0) {
		pf_upload_courriel(vf_ligne_pj_a_lire);
	} else {
		pf_upload_courriel_fin();
	}
}
function pf_validation_fin(vv_sequence) {
	fa_grise_fenetre("","non");
	if (vv_sequence!=0) {
		if (confirm("$vl_c_bqe_114js")==true) {
			fa_ouvre(c_fen_traitement_courriels+vv_sequence);
		}
	} else {
		alert("$vl_c_bqe_115js");
	}
}
EOT;
$script_validation=<<<EOT
const c_upload_courriel="_graal_exe_courriel_import_recus.php?vl_e_graal_cleunik=";
const c_fen_traitement_courriels="_graal_fen_courriel_02.php?vl_e_sequence=";
EOT;
}

echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
*********************************************************************
**********  Fenêtre de gestion d'importation des fichiers de courriels  ********
*********************************************************************
*/
const c_script_verif_hash="_graal_bdope_courriel_recept_01.php?vl_c_hash=";
$script_validation
var vf_compte_cleunik=0;
var vf_nombre_pj=0,vf_t_cleunik=[],vf_nombre_pj_lues=0,vf_ligne_pj_a_lire=0,vf_t_sequence=[];
function pf_etat_fen(vv_quoi){
  switch(vv_quoi) {
    case "ini":
      fa_focusdonne('tb_ouvre_fichiers_disque');
      break;
    case "sortir":
      window.close();
      break;   
  }
}
function pf_ouvre_fichiers(){
	var vv_t_tableau_nom=[];
	vv_t_tableau_nom=fa03_sel_fichiers_plusieurs("$vl_c_bqe_116js","*.eml");
	fa_grise_fenetre("","oui");
	var vl_e_nb_sel=vv_t_tableau_nom.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
    	var hash=fa03_fichier_sha1(vv_t_tableau_nom[i]);
      var row = fa_crexul('listitem');
      var cell_01 = fa_crexul('listcell');
      var cell_02 = fa_crexul('listcell');
			var cell_03 = fa_crexul('listcell');
			var cell_04 = fa_crexul('listcell');
      cell_01.setAttribute('label', vv_t_tableau_nom[i]);
      cell_02.setAttribute('label', "$vl_c_bqe_109js");
      cell_03.setAttribute('label', hash);
      cell_04.setAttribute('label',-1);
      row.appendChild(cell_01);
      row.appendChild(cell_02);
      row.appendChild(cell_03);
			row.appendChild(cell_04);
      fa_gid("li_courriels").appendChild( row );
    }
  }
	vf_nombre_pj=fa_gid("li_courriels").getRowCount();
  vf_t_cleunik=[];
	vf_nombre_pj_lues=0;
	vf_ligne_pj_a_lire=0;
	if (vf_nombre_pj!=0) {
		pf_verifie_hash(vf_ligne_pj_a_lire);
	} else {
		pf_verifie_hash_fin();
	}
}
function pf_verifie_hash(vv_quelle_ligne) {
	fa_gid("bt_explications").label="$vl_c_bqe_112js ("+(vf_ligne_pj_a_lire+1)+'/'+vf_nombre_pj+")";
	var item1 = fa_gid("li_courriels").getItemAtIndex(vv_quelle_ligne);
	var vl_c_veri=item1.childNodes[1].getAttribute('label');
	var vl_c_hash=item1.childNodes[2].getAttribute('label');
 	vf_nombre_pj_lues++;
  if (vl_c_veri=="$vl_c_bqe_109js") {
		fa_xmlhttprequest_txt(c_script_verif_hash+vl_c_hash+"&raf="+Math.random()+"&","",pf_verifie_hash_suite);
	} else {
		pf_verifie_hash_suite(-1);
	}
}
function pf_verifie_hash_suite(vv_data) {
	switch (vv_data) {
		case -1:
			break;
		default:
			var item1 = fa_gid("li_courriels").getItemAtIndex(vf_ligne_pj_a_lire);
			item1.childNodes[1].setAttribute('label','Vérifié');
			item1.childNodes[3].setAttribute('label',vv_data);
			vf_t_cleunik.push(vv_data);
	}
	if (vf_nombre_pj_lues!=vf_nombre_pj) {
		vf_ligne_pj_a_lire++;
		pf_verifie_hash(vf_ligne_pj_a_lire);
	} else {
		pf_verifie_hash_fin();
	}
}
$proc_validation
]]></script>
END;
?>
