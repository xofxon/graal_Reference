<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_act_cleunik=intval(fa_recup_param("vl_act_cleunik","10000113"));
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","-1"));
$vl_actif=intval(fa_recup_param("vl_e_actif",3));
$vl_limit=intval(fa_recup_param("vl_e_limit",-1));
$vl_c_genre=fa_recup_param('genre','0');  //  1 ventes, 2 achats
$vl_c_sortie=fa_recup_param("sortie","das");
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','tarifs_fournisseurs.xls');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');

session_write_close();

$art_cod=array();$art_cle=array();
$sql_req="select distinct(code),art_cleunik from _art_acteur where act_cleunik=$vl_e_act_cleunik;";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($art_cod, $row['code']);
  array_push ($art_cle, $row['art_cleunik']);
}
_graal_libere_requete_bd($result);
/*
 *
 * Le 17 décembre 2009 je sais que la requete suivant n'affiche pas les tarifs pour lesquels il n'y a pas de libellés !!
 *
 */
/*
$sql_req = "SELECT _article.art_cleunik as art_cleunik,round(quantite_basse,0),round(quantite_haute,0),tar_cleunik,";
$sql_req.= " case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference, choix_code,choix_valeur_texte_01,";
$sql_req.= " _article.code,mnemotechnique,_article.description,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,";
$sql_req.= _graalsql_date('dateheure_dermaj')." as date_dermaj,";
$sql_req.= " _art_acteur.code as code_fournisseur FROM _art_tarifs,_choix,_article,_art_acteur where choix_cleunik=tarif_cleunik and _art_tarifs.act_cleunik=$vl_e_act_cleunik";
$sql_req.= " and _article.art_cleunik=_art_tarifs.art_cleunik and _art_acteur.art_cleunik=_art_tarifs.art_cleunik and type=2";
*/
$sql_req = "SELECT _article.art_cleunik as art_cleunik,round(quantite_basse,0),round(quantite_haute,0),tar_cleunik,_article.actif as actif,";
$sql_req.= " case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference,";
$sql_req.= " choix_code,choix_valeur_texte_01,code,mnemotechnique,description,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif as tarif_actif, ";
$sql_req.= _graalsql_date('dateheure_dermaj')." as date_dermaj";
$sql_req.= " FROM _art_tarifs,_choix,_article where choix_cleunik=tarif_cleunik and act_cleunik=$vl_e_act_cleunik and _article.art_cleunik=_art_tarifs.art_cleunik and type=2 ";
if ($vl_e_art_cleunik==-1){
	switch ($vl_c_zone) {
          case '1': $sql_req.=" and _article.description like '$vl_c_recherche%'";break;//  Description courte
          case '2': $sql_req.=" and _article.code like '$vl_c_recherche%'";break;//  Code
          case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%'";break;//  Mnémotechnique
        }
}
switch ($vl_actif) {
  case 1 : $sql_req.= " and _art_tarifs.actif=1 and _article.actif=1";break;
  case 2 : $sql_req.= " and (_art_tarifs.actif=2 or _article.actif=2)";break;
  case 3 : break;
}
//$sql_req.=" group by _art_acteur.code order by choix_valeur_texte_01 ";
$sql_req.=" group by _article.art_cleunik order by choix_valeur_texte_01 ";
if ($vl_limit!=-1){
	$sql_req.=" LIMIT $vl_limit";
}
$result = _graal_requete_bd($sql_req);
switch ($vl_c_sortie) {
	case "das":
		echo('<donnees>');
		//echo $sql_req;
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		    echo(' tar_cleunik_particulier_achat="'.fa_ent_xml($row['tar_cleunik']).'"');
		    echo(' art_cleunik_particulier_achat="'.fa_ent_xml($row['art_cleunik']).'"');
		    echo(' code_particulier_achat="'.fa_ent_xml($row['choix_code']).'"');
		    echo(' designation_particulier_achat="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
		    echo(' tarif_particulier_achat="'.fa_ent_xml($row['pu_reference']).'"');
		    echo(' code_article_interne_achat="'.fa_ent_xml($row['code']).'"');
		    echo(' desi_article_interne_achat="'.fa_ent_xml($row['description']).'"');
		    echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
		    if (($row['actif']==1) && ($row['tarif_actif']==1)) {
		      echo(' properties=""');
		    } else {
		      echo(' properties="css_0001"');
		    }
		    echo(' datevalidite="'.fa_ent_xml($row['datevalidite']).'"');
		    $borne_basse=fa_reel(fa_ent_xml($row['quantite_basse']),0);
		 	$val_borne_basse=fa_ent_xml($row['quantite_basse'])*1000;
		  	echo(' borne_basse="'.$borne_basse.'"');
		  	printf(' val_borne_basse="%011u"',$val_borne_basse);
		  	$borne_haute=fa_reel(fa_ent_xml($row['quantite_haute']),0);
		 	$val_borne_haute=fa_ent_xml($row['quantite_haute'])*1000;
		  	echo(' borne_haute="'.$borne_haute.'"');
		  	printf(' val_borne_haute="%011u"',$val_borne_haute);
		  	echo(' date_dermaj="'.fa_ent_xml($row['date_dermaj']).'"');
			$vl_e_trouve=array_search($row['art_cleunik'], $art_cle);if ($vl_e_trouve===false) {$code_fournisseur="";} else {$code_fournisseur=$art_cod[$vl_e_trouve];}
		  	echo(' code_fournisseur="'.fa_ent_xml($code_fournisseur).'"');
		  	echo('/>');
		}
		echo('</donnees>');
		break;
	case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		switch ($vl_c_genre) {
		  case "1": $id_inc_tarifs_particuliers_fournis="Div_00xxx";break;  //  Tarifs de vente
		  case "2": $id_inc_tarifs_particuliers_fournis="Div_00445";break;  //  Tarifs d'achats
		  default: fa_redirige("acces_interdit");break;
		}
		_graal_requete_charge_varlib($id_inc_tarifs_particuliers_fournis,$vl_e_uti_cleunik);
		$vl_c_bfn_001=fa_recup_dico("bfn_001");
		$vl_c_bfn_002=fa_recup_dico("bfn_002");
		$vl_c_bfn_003=fa_recup_dico("bfn_003");
		$vl_c_bfn_004=fa_recup_dico("bfn_004");
		$vl_c_bfn_005=fa_recup_dico("bfn_005");
		$vl_c_bfn_006=fa_recup_dico("bfn_006");
		$vl_c_bfn_007=fa_recup_dico("bfn_007");
		$vl_c_bfn_008=fa_recup_dico("bfn_008");
		$vl_c_bfn_009=fa_recup_dico("bfn_009");
		$vl_c_bfn_010=fa_recup_dico("bfn_010");
		$vl_c_bfn_011=fa_recup_dico("bfn_011");
		$vl_c_bfn_012=fa_recup_dico("bfn_012");
		$vl_c_bfn_013=fa_recup_dico("bfn_013");
		$vl_c_bfn_014=fa_recup_dico("bfn_014");
		$vl_c_bfn_015=fa_recup_dico("bfn_015");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_bsq_107"));

		/*
		$heading  =& $workbook->addformat(array(
     'bold'    => 1,    // on met le texte en gras
     'color'   => 'black', // de couleur noire
     'size'    => 12,    // de taille 12
     'merge'   => 1,    // avec une marge
     'fg_color'    => 0x33 // coloration du fond des cellules
  ));


 $headings = array('Nom', 'Prénom', 'société', 'Email', 'Pays'); //définition du texte pour chaque célulles
 $worksheet->write_row('A1', $headings, $heading); //On intègre notre texte et les le format de cellule.
 // le premier paramètre correspond à la cellule où l'on souhaite commencer à intégrer les différent paramètre.

		*/
		# Create a "text wrap" format
$format2 =& $workbook->addformat();
//$format2->set_text_wrap("@");
$format2->set_num_format("@");
$format2->set_align('left');


$f_change =& $workbook->addformat();
$f_change->set_align('left');
$f_change->set_num_format('[Green]0.0%;[Red]-0.0%;0.0%');

		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("tc_tar_cleunik_particulier_achat"));
		$worksheet->write(0, 1, utf8_decode("tc_code_tarif_particulier_achat"));
		$worksheet->write(0, 2, utf8_decode("tc_art_cleunik_particulier_achat"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bfn_005"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bfn_006"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_bfn_007"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_bfn_008"));
		$worksheet->write(0, 7, utf8_decode("$vl_c_bfn_009"));
		$worksheet->write(0, 8, utf8_decode("$vl_c_bfn_010"));
		$worksheet->write(0, 9, utf8_decode("$vl_c_bfn_013"));
		$worksheet->write(0,10, utf8_decode("$vl_c_bfn_014"));
		$worksheet->write(0,11, utf8_decode("$vl_c_bfn_013"));
		$worksheet->write(0,12, utf8_decode("$vl_c_bfn_014"));
		$worksheet->write(0,13, utf8_decode("$vl_c_bfn_011"));
		$worksheet->write(0,14, utf8_decode("$vl_c_bfn_012"));
		$worksheet->write(0,15, utf8_decode("$vl_c_bfn_015"));
		$worksheet->write(0,16, utf8_decode("$vl_c_bfn_016"."(orignal)"));
		$vl_e_noligne=1;
		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['tar_cleunik']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['choix_code']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['art_cleunik']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['choix_valeur_texte_01']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['pu_reference']));$j++;

		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['datevalidite']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['mnemotechnique']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_basse']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_haute']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_basse']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_haute']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_dermaj']));$j++;
		    $worksheet->write($vl_e_noligne, $j, 0);$j++;
		    $vl_e_trouve=array_search($row['art_cleunik'], $art_cle);if ($vl_e_trouve===false) {$code_fournisseur="";} else {$code_fournisseur=$art_cod[$vl_e_trouve];}
		    $worksheet->write($vl_e_noligne, $j, " ".utf8_decode($code_fournisseur),$format2);$j++;
		    $worksheet->write($vl_e_noligne, $j, " ".utf8_decode($code_fournisseur),$format2);$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    	break;
    case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
	    break;
}

_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
