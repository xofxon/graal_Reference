<?php
include("_graal_var_portee.php");
$vl_e_portee=$vl_e_action;
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_das_action='_graal_das_actions_01.php?var=vs_tempo_panier_action&';
const vf_c_script_fen_action='_graal_fen_actions_02.php?';
const vf_c_script_sel_tel='_graal_fen_rech_tel_01.php?action=emitel&genreacteur=';
const vf_c_script_var='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_action';
const vf_c_script_bdope_fen="_graal_bdope_traitements_actions_01.php";
const vf_c_script_bdope_panier='_graal_bdope_paniers_01.php';
var vf_e_action_cleunik=-1,vf_e_choix_cleunik,vf_c_recup_requete;
var vf_t_panier=[];
const lstn_grise = {
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre("","non");}
};
function pf_aa_init_bem(vv_choix_date){
  fa05_sel_date(vv_choix_date,'bem_tb_deb','bem_tb_fin');
  fa_att_set("ml_genre_action_rech","oncommand","pf_approximatif_bem()");
  fa_check("me_tb_deb_21");
  fa_att_set("arbre_actions_01",'onselect',"pf_sel_ligne_bem(this.id);");
  fa_att_set("arbre_actions_01",'ondblclick',"pf_action_ouvre(this.id)");
  fa_att_set("arbre_actions_01",'context',"pop_selections");
  fa_att_set("arbre_actions_01",'select',"multiple");
  fa_att_set("arbre_des_actions_panier",'onselect',"pf_sel_ligne_bem(this.id);");
  fa_att_set("arbre_des_actions_panier",'ondblclick',"pf_action_ouvre(this.id)");
  fa_att_set("arbre_des_actions_panier",'context',"pop_panier");
  fa_att_set("arbre_des_actions_panier",'select',"multiple");
	fa_badl("arbre_actions_01",lstn_grise);
	fa_badl("arbre_des_actions_panier",lstn_grise);
  pf_approximatif_bem();
}
function pf_approximatif_bem() {
	var vl_c_statuts=fa_mlget_check("ml_statut_action_rech");
	var vl_c_priorit=fa_mlget_check("ml_priori_action_rech");
	var vl_c_genress=fa_mlget_check("ml_genre_action_rech");
	var vl_c_datedeb=fa_value_get("bem_tb_deb");
	var vl_c_datefin=fa_value_get("bem_tb_fin");
	vl_c_datedeb=vl_c_datedeb.replace("-", "", "gi");
	vl_c_datefin=vl_c_datefin.replace("-", "", "gi");
	var vl_c_concerne_qui="&vl_c_concerne_qui="+fa_mlget("bem_ml_concerne_qui","value")+'&';
	switch ($vl_c_type) {
    case 1:	//	normal
		var vl_c_script="",vl_c_date="",vl_c_url_alimente_table="";
		if ( fa_value_get("bem_tb_rechapproxima") == "" ) {return;}
		vl_c_url_alimente_table=vf_c_script_das_action+vl_c_concerne_qui+'vl_c_lesquelles=toutes&raf_random='+Math.random();
		vl_c_url_alimente_table+='&vl_c_quelleplage=debut&vl_c_dateheuredebut='+fa_enc(vl_c_datedeb)+'&vl_c_dateheurefin='+fa_enc(vl_c_datefin);
		vl_c_url_alimente_table+="&vl_e_limit="+fa_value_get("bem_tb_limit")+'&vl_c_recherche='+fa_enc(fa_value_get("bem_tb_rechapproxima"));
		vl_c_url_alimente_table+='&vl_e_genre='+vl_c_genress+'&vl_e_statut='+vl_c_statuts+'&'+"vl_operat="+fa_mlget("bem_ml_operat","value");
		vl_c_url_alimente_table+='&vl_operat_genre='+fa_mlget("bem_ml_operat_genre","value")+"&vl_zone="+fa_mlget("bem_ml_zone","value");
		vl_c_url_alimente_table+="&vl_type_recherche="+fa_mlget("bem_ml_type_recherche","value")+"&vl_e_priorite="+vl_c_priorit;
		vl_c_url_alimente_table+="&vl_operat_priorite="+fa_mlget("bem_ml_operat_priori","value")+'&';
		vl_c_url_alimente_table+="&vl_operat_confiden="+fa_mlget("bem_ml_operat_confid","value")+'&vl_e_confiden='+fa_mlget_check("ml_confid_action_rech");
		fa_grise_fenetre("","oui");
		fa_das("arbre_actions_01",vl_c_url_alimente_table);
		break;
    case 2:	//	Choix
    case 3:	//	Critère
    	vl_c_url_alimente_table=vf_c_script_das_action+'vl_c_lesquelles=toutes&raf_random='+Math.random();
		vl_c_url_alimente_table+="&vl_e_action_choix_cleunik="+fa_att_get("_graal_ove_bdx_datas","_graal_choix_cleunik");
		vl_c_url_alimente_table+="&vl_e_action_critere_cleunik="+fa_att_get("_graal_ove_bdx_datas","_graal_critere_cleunik");
		switch (fa_att_get("_graal_ove_bdx_datas","_graal_quoi")){
			case "in"	:vl_c_url_alimente_table+="&vl_e_action_choix=1&";break;
			case "notin":vl_c_url_alimente_table+="&vl_e_action_choix=2&";break;
		}
		vf_c_recup_requete=vl_c_url_alimente_table+"&sortie=requete&vl_e_limit=0&";
		fa_grise_fenetre("","oui");
		fa_das("arbre_actions_01",vl_c_url_alimente_table);
		break;
	case 4://	Normal+critères
		  var vl_c_script="",vl_c_date="",vl_c_url_alimente_table="";
		  if ( fa_value_get("bem_tb_rechapproxima") == "" ) {return;}
		  var vl_e_action_choix_cleunik="";
		  var vl_e_action_critere_cleunik="";
		  var vl_arbre=fa_gid('tb_choix_actions');
		  if(vl_arbre.currentIndex>=0) {
				var vl_t_tableau=fa_lignes_selectionnees("tb_choix_actions");
				var vl_e_nb_sel=vl_t_tableau.length;
			  	if (vl_e_nb_sel!=0) {
			    	for(i=0;i<vl_e_nb_sel;i++) {
			    		var selected  = vl_arbre.contentView.getItemAtIndex(vl_t_tableau[i]);
						if (i!=0) {
							vl_e_action_choix_cleunik+=",";
							vl_e_action_critere_cleunik+=",";
						}
	    				vl_e_action_choix_cleunik+= selected.firstChild.childNodes[0].getAttribute("_graal_choix_cleunik");
	    				//alert(vl_e_action_choix_cleunik)
						vl_e_action_critere_cleunik+= selected.firstChild.childNodes[0].getAttribute("_graal_critere_cleunik");
			    	}
				}
				vl_e_action_choix=fa_value_get("rdg_cherche_choix");
		  } else {
		  	vl_e_action_choix_cleunik=0;
				vl_e_action_choix=0;
				vl_e_action_critere_cleunik=0;
		  }
		  vl_c_url_alimente_table=vf_c_script_das_action+'vl_c_lesquelles=toutes&raf_random='+Math.random();
		vl_c_url_alimente_table+='&vl_c_quelleplage=debut&vl_c_dateheuredebut='+fa_enc(vl_c_datedeb);
		vl_c_url_alimente_table+='&vl_c_dateheurefin='+fa_enc(vl_c_datefin)+"&vl_e_limit="+fa_value_get("bem_tb_limit");
		vl_c_url_alimente_table+='&vl_c_recherche='+fa_enc(fa_value_get("bem_tb_rechapproxima"))+'&vl_e_genre='+fa_mlget("ml_genre_action_rech");
		vl_c_url_alimente_table+='&vl_e_statut='+vl_c_statuts+'&'+"vl_operat="+fa_mlget("bem_ml_operat","value");
		vl_c_url_alimente_table+='&vl_operat_genre='+fa_mlget("bem_ml_operat_genre","value")+"&vl_zone="+fa_mlget("bem_ml_zone","value");
		vl_c_url_alimente_table+="&vl_type_recherche="+fa_mlget("bem_ml_type_recherche","value");
		vl_c_url_alimente_table+="&vl_e_action_choix="+vl_e_action_choix;
		vl_c_url_alimente_table+="&vl_e_action_choix_cleunik="+vl_e_action_choix_cleunik;
		vl_c_url_alimente_table+="&vl_e_action_critere_cleunik="+vl_e_action_critere_cleunik;
		vl_c_url_alimente_table+="&vl_e_priorite="+vl_c_priorit+"&vl_operat_priorite="+fa_mlget("bem_ml_operat_priori","value")+'&'+vl_c_concerne_qui;
		vl_c_url_alimente_table+="&vl_operat_confiden="+fa_mlget("bem_ml_operat_confid","value")+'&vl_e_confiden='+fa_mlget_check("ml_confid_action_rech");
		fa_grise_fenetre("","oui");
		fa_das("arbre_actions_01",vl_c_url_alimente_table);
      break;
  }
}
function pf_action_change_confidentialite(){
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  fa_grise_fenetre("","oui");
  var vl_c_donnees="vf_c_action=kilometres_confidentialite&";
  vl_c_donnees+="vl_t_actions="+fa_enc(fa_jsarray2php_00(vl_t_action))+"&";
  vl_c_donnees+="nouvelle_confidentialite="+fa_mlget("ml_confidentialite_action")+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}

function pf_action_change_priorite(){
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  fa_grise_fenetre("","oui");
  var vl_c_donnees="vf_c_action=kilometres_priorite&";
  vl_c_donnees+="vl_t_actions="+fa_enc(fa_jsarray2php_00(vl_t_action))+"&";
  vl_c_donnees+="nouvelle_priorite="+fa_mlget("ml_priorite_action")+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_actions_change_recus_en_erreur(){
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  fa_grise_fenetre("","oui");
  var vl_c_donnees="vf_c_action=kilometres_recus_en_erreur&";
  vl_c_donnees+="vl_t_actions="+fa_enc(fa_jsarray2php_00(vl_t_action))+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_action_change_statut(){
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  fa_grise_fenetre("","oui");
  var vl_c_donnees="vf_c_action=kilometres_statut&";
  vl_c_donnees+="vl_t_actions="+fa_enc(fa_jsarray2php_00(vl_t_action))+"&";
  vl_c_donnees+="nouveau_statut="+fa_mlget("ml_statut_action")+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_actions_choix(vv_param_01,vv_param_02){
  var vl_arbre=fa_gid('tb_choix_actions');
	var vl_t_panier_choix_cleunik=[];
	var vl_t_panier_critere_cleunik=[];
	var vl_e_action_choix_cleunik,vl_e_action_critere_cleunik;
	if(vl_arbre.currentIndex>=0) {
		var vl_t_tableau=fa_lignes_selectionnees("tb_choix_actions");
		var vl_e_nb_sel=vl_t_tableau.length;
	  if (vl_e_nb_sel!=0) {
	  	var k=-1;
	    for(i=0;i<vl_e_nb_sel;i++) {
	    	var selected  = vl_arbre.contentView.getItemAtIndex(vl_t_tableau[i]);
				vl_e_action_choix_cleunik= selected.firstChild.childNodes[0].getAttribute("_graal_choix_cleunik");
				vl_e_action_critere_cleunik= selected.firstChild.childNodes[0].getAttribute("_graal_critere_cleunik");
				if (vl_e_action_choix_cleunik!=0){
					k++;
					vl_t_panier_choix_cleunik[k]=vl_e_action_choix_cleunik;
					vl_t_panier_critere_cleunik[k]=vl_e_action_critere_cleunik;
				}
	    }
		} else {
			return;
		}
	} else {
		return;
	}
	if (vl_t_panier_choix_cleunik.length==0){return;}
	var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  fa_grise_fenetre("","oui");
  var vl_c_donnees="vf_c_action=kilometres_choix&";
  vl_c_donnees+="vl_t_actions="+fa_enc(fa_jsarray2php_00(vl_t_action))+"&";
	vl_c_donnees+="vl_t_panier_choix_cleunik="+fa_enc(fa_jsarray2php_00(vl_t_panier_choix_cleunik))+"&";
	vl_c_donnees+="vl_t_panier_critere_cleunik="+fa_enc(fa_jsarray2php_00(vl_t_panier_critere_cleunik))+"&";
  vl_c_donnees+="param_01="+vv_param_01+"&";
  vl_c_donnees+="param_02="+vv_param_02+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_action_ouvre(vv_qui){
  var rowIndex = fa_cui(vv_qui);if(rowIndex == -1){return;}
  var vl_e_action_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_action_cleunik");
  var vl_e_choix_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_choix_cleunik");
  switch (vl_e_choix_cleunik) {
    case "-110114" : vl_c_genre="offcli";break;
    case "-110115" : vl_c_genre="demfou";break;
    case "-110108" : vl_c_genre="cdecli";break;
    case "-110109" : vl_c_genre="cdefou";break;
    case "-110110" : vl_c_genre="livcli";break;
    case "-110111" : vl_c_genre="recfou";break;
    case "-110112" : vl_c_genre="faccli";break;
    case "-110113" : vl_c_genre="facfou";break;
    case "-110116" : vl_c_genre="avocli";break;
    case "-110117" : vl_c_genre="avocli";break;
    case "-110118" : vl_c_genre="chat";break;
    case "-110103" : vl_c_genre="emimail";break;
    case "-110102" : vl_c_genre="recmail";break;
    case "-110120" : vl_c_genre="recmail_lecture";break;
    case "-110104" : vl_c_genre="recmail_erreur";break;
	case "-110123" : vl_c_genre="formul";break;
	case "-110124" : vl_c_genre="desins_mail";break;
	case "-110125" : vl_c_genre="recvoc";break;
	case "-110126" : vl_c_genre="recfax";break;
	case "-110127" : vl_c_genre="remban";break;
	case "-110128" : vl_c_genre="emifax";break;
	case "-110129" : vl_c_genre="emisms";break;
	case "-110130" : vl_c_genre="post_it";break;
	case "-110131" : vl_c_genre="bordex";break;
	case "-110132" : vl_c_genre="emailing_track";break;
	case "-110133" : vl_c_genre="retcli";break;
    case "-110134" : vl_c_genre="retfou";break;
    case "-110135" : vl_c_genre="relfou";break;
    case "-110137" : vl_c_genre="avofou";break;
    case "-110138" : vl_c_genre="avofif";break;
    case "-110139" : vl_c_genre="alertes";break;
    default : vl_c_genre="$vl_c_genreaction";
  }
  vl_c_donnees="vf_e_action_cleunik="+fa_enc(vl_e_action_cleunik)+"&vf_c_action=modifier&genreaction="+fa_enc(vl_c_genre)+"&";
  fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600)
}
function pf_actions_supprime() {
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  if(!confirm("Confirmez-vous la suppression de cet ensemble d\'actions?")) {return;}
  fa_grise_fenetre("","oui");
  var vl_c_donnees="vf_c_action=kilometres_supprimer&";
  vl_c_donnees+="vl_t_actions="+fa_enc(fa_jsarray2php_00(vl_t_action))+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_deselectionne_choix_tous_confidentialite(){
	var k=fa_gid("ml_confid_action_rech").selectedIndex;
	fa_gid("ml_confid_action_rech").selectedIndex=0;
	fa_gid("ml_confid_action_rech").selectedItem.removeAttribute("checked");
	fa_gid("ml_confid_action_rech").selectedIndex=k;
}
function pf_deselectionne_choix_tous_genres(){
	var k=fa_gid("ml_genre_action_rech").selectedIndex;
	fa_gid("ml_genre_action_rech").selectedIndex=0;
	fa_gid("ml_genre_action_rech").selectedItem.removeAttribute("checked");
	fa_gid("ml_genre_action_rech").selectedIndex=k;
}
function pf_deselectionne_choix_tous_priorite(){
	var k=fa_gid("ml_priori_action_rech").selectedIndex;
	fa_gid("ml_priori_action_rech").selectedIndex=0;
	fa_gid("ml_priori_action_rech").selectedItem.removeAttribute("checked");
	fa_gid("ml_priori_action_rech").selectedIndex=k;
}
function pf_deselectionne_choix_tous_statuts(){
	var k=fa_gid("ml_statut_action_rech").selectedIndex;
	fa_gid("ml_statut_action_rech").selectedIndex=0;
	fa_gid("ml_statut_action_rech").selectedItem.removeAttribute("checked");
	fa_gid("ml_statut_action_rech").selectedIndex=k;
}
function pf_etat_fen_bem(vv_quoi){
  var vl_c_donnees="";
  switch(vv_quoi) {
    case "modifier":
      break;
    case "sortir":
      window.close();
      break;
  }
}
function pf_onunload(){
	fa_brl("arbre_actions_01",lstn_grise);
	fa_brl("arbre_des_actions_panier",lstn_grise);
}
function pf_panier_ajoute() {
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  var vl_t_panier=[];
  vl_t_panier=vf_t_panier;
  vf_t_panier=vl_t_panier.concat(vl_t_action);
  fa_remove_attribute("bt_voir_panier","collapsed")
  fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
}
function pf_panier_enleve() {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_actions_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_panier=[];
    var vl_t_action=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_action[i]=fa_cell_get("arbre_des_actions_panier",vl_t_tableau[i],"tc_action_cleunik");
    }
    var j=0;k=-1;
    for(i=0;i<vf_t_panier.length;i++) {
      if (vl_t_action.indexOf(vf_t_panier[i])==-1) {
        k++;
        vl_t_panier[k]=vf_t_panier[i];
      }
    }
    vf_t_panier=vl_t_panier
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
  }
}


function pf_sel_ligne_bem(vv_qui)  {
  vf_e_action_cleunik=-1;
  var rowIndex = fa_cui(vv_qui);if(rowIndex == -1){return;}
  vf_e_action_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_action_cleunik")
}
function pf_sel_arbre_choix_critere(vv_arbre){
	/*
  try {
  	if(vv_arbre.currentIndex<0) {return;}
    var selected  = vv_arbre.contentView.getItemAtIndex(vv_arbre.currentIndex);
    var vl_e_choix_clenik = selected.firstChild.childNodes[0].getAttribute("_graal_cleunik");
		alert(vl_e_choix_clenik);
	} catch (e) {
      alert(e);
   }
   */
}
function pf_tab_actions(){
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_action=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_actions_01");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_action[i]=fa_cell_get("arbre_actions_01",vl_t_tableau[i],"tc_action_cleunik");
    }
  }
  return vl_t_action;
}
function pf_tableau_donnees_fin(stream) {
  fa_das("arbre_des_actions_panier",vf_c_script_das_action+'vl_c_lesquelles=selection&raf_random='+Math.random())
}
function pf_validation_fin(stream) {
	fa_grise_fenetre("","non");
	var vl_datas = stream;
  alert(vl_datas);
  pf_approximatif_bem();
}
function pf_valide_danspanier() {
  var vl_e_nb=fa_cl("arbre_des_actions_panier");
  if (vl_e_nb==0) {return;}
  var vl_c_titrepanier=prompt("Titre du nouveau panier : ");
  if (vl_c_titrepanier==null) {alert("Création du panier abandonnée.");return;}
  var vl_c_liste=""
  for(i=0;i<vl_e_nb;i++) {
    vl_c_liste+=fa_cell_get("arbre_des_actions_panier",i,"tc_action_cleunik")+","
  }
  vl_c_liste=vl_c_liste.substring(0,vl_c_liste.length-1);
  vl_c_donnees="";
  vl_c_donnees+="vl_uti_cleunik=$vl_e_uti_cleunik&";
  vl_c_donnees+="vl_panier_titre="+fa_enc(vl_c_titrepanier)+"&";
  vl_c_donnees+="vl_panier_portee=$vl_e_portee&";
  vl_c_donnees+="vl_panier_type=1&";
  vl_c_donnees+="vl_actif=1&";
  vl_c_donnees+="vl_panier_resultat="+vl_c_liste+"&";
  vl_c_donnees+="vl_c_action=ajouter_panier&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_panier,vl_c_donnees,pf_valide_danspanier_fin);
}
function pf_valide_danspanier_fin(stream) {
  var vl_datas = stream;
  alert(vl_datas);
}
function pf_valide_requete() {
  vf_titre_requete=prompt("Donnez un titre à votre requête ...");
  if(vf_titre_requete==null) {alert("Requête abandonnée.");return;}
  fa_xmlhttprequest_txt(vf_c_recup_requete,'',pf_valide_requete_01);
}
function pf_valide_requete_01(stream) {
  var vl_c_requete=stream,vl_c_donnees="";
  vl_c_donnees+="vl_uti_cleunik=$vl_e_uti_cleunik&";
  vl_c_donnees+="vl_blocnote_brut="+fa_enc(fa_value_get("tb_enclair")+" : "+fa_value_get("tb_critere_denomination")+" ("+fa_value_get("tb_choix_valeur_texte_01")+")")+"&";
  vl_c_donnees+="vl_panier_portee=$vl_e_portee&";
  vl_c_donnees+="vl_panier_type=2&";
  vl_c_donnees+="vl_panier_requete_selection="+vl_c_requete+"&";
  vl_c_donnees+="vl_panier_titre="+fa_enc(vf_titre_requete)+"&";
  vl_c_donnees+="vl_c_action=ajouter&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_panier,vl_c_donnees,pf_valide_danspanier_fin);
}
function pf_voir_deck(vv_lequel) {
  fa_gid("deck_actions").selectedIndex=vv_lequel;
}

]]></script>
END;
?>
