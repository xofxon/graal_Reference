<?php
switch ($vl_e_type) {
  case 110000:  // tarifs entreprise
    switch ($vl_c_genre) {
      case 1 : // Ventes
        $vf_c_arbre_art_tarif="arbre_tarif_type_vente";$vf_c_script_das_art_tarif="_graal_das_art_tarifs_type_ventes.php?vl_art_cleunik=$vl_e_art_cleunik&";$pf_affiche_fenetre_mere="if (window.opener!=null) {try {window.opener.pf_affiche_donnees_tarif_type_vente();} catch(e){}}";break;
      case 2 : // Achats
        $vf_c_arbre_art_tarif="arbre_tarif_type_achat";$vf_c_script_das_art_tarif="_graal_das_art_tarifs_type_achats.php?vl_art_cleunik=$vl_e_art_cleunik&";$pf_affiche_fenetre_mere="if (window.opener!=null) {try {window.opener.pf_affiche_donnees_tarif_type_achat();} catch(e){}}";break;  
    }
    break;
  case 110004:  // tarifs particuliers fournisseur
    $vf_c_arbre_art_tarif="arbre_tarif_particulier_achat";
    $vf_c_script_das_art_tarif="_graal_das_art_tarifs_particulier_achats.php?";
    switch ($vl_c_origine) {
      case 'article':
        $vf_c_script_das_art_tarif.="vl_art_cleunik=$vl_e_art_cleunik&raf_random=";
        break;
      case 'acteur':  // clients
        $vf_c_script_das_art_tarif.="vl_act_cleunik=$vl_e_act_cleunik&raf_random=";
        break;
    }
    $pf_affiche_fenetre_mere="if (window.opener!=null) {try {window.opener.pf_affiche_donnees_tarif_particulier_achat();} catch(e){}}";
    break;
  case 110003:  // tarifs particuliers clients
    $vf_c_arbre_art_tarif="arbre_tarif_particulier_vente";
    $vf_c_script_das_art_tarif="_graal_das_art_tarifs_particulier_ventes.php?";
    switch ($vl_c_origine) {
      case 'article':
        $vf_c_script_das_art_tarif.="vl_art_cleunik=$vl_e_art_cleunik&raf_random=";
        break;
      case 'acteur':  // clients
        $vf_c_script_das_art_tarif.="vl_act_cleunik=$vl_e_act_cleunik&raf_random=";
        break;
    }
    $pf_affiche_fenetre_mere="if (window.opener!=null) {try {window.opener.pf_affiche_donnees_tarif_particulier_vente();} catch(e){}}";
    break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_art_tarif_01.php?vl_type=$vl_e_type&vl_genre=$vl_c_genre";
const vf_c_script_recherche_acteurs="_graal_rech_acteurs_01.php?";
const vf_c_script_xml_art_tarif="_graal_xml_art_tarif_01.php?vl_e_tar_cleunik=$vl_e_tar_cleunik&";
const c_script_fen_cademploi="_graal_fen_cademploitarifs.php?vl_e_tar_cleunik=$vl_e_tar_cleunik&";
var vf_c_action,vf_c_url_alimente_table;
var vf_e_act_cleunik,vf_e_art_cleunik;
function pf_aa_init() {
  fa_sep("tb_prix_unitaire");
  fa_sep("tb_nb_dec");
  fa_cache_oui("portee");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  fa_value_set("dp_dateheurevalidite",c_date_defaut_deb);
  vf_e_act_cleunik=$vl_e_act_cleunik;
  vf_e_art_cleunik=$vl_e_art_cleunik;
  pf_affiche_donnees_art_tarif();
  if ($vl_e_tar_cleunik!=0) {
    fa_xmlhttprequest_xml(vf_c_script_xml_art_tarif,"",pf_affiche_donnees);
  }
  else {
    fa_att_set('ra_actif_oui','selected', 'true');
    fa_value_set("rdg_tarif_actif",1);
    fa_value_set("tb_nb_dec","$vl_c_nbdec_prix");
		fa_att_set("tb_prix_unitaire","decimalplaces","$vl_c_nbdec_prix");
		fa_value_set("tb_unite_quantite",1);
    if ($vl_e_act_cleunik==0) {
      fa_focusdonne("ml_tarif");
      return;
    }
    if ($vl_e_act_cleunik!=-1) {
      fa_focusdonne("bbo_tb_rechapproxima");
      fa_approximatif_bbo();
    }
    else
    {
      fa_focusdonne("aai_tb_rechapproxima");
      pf_approximatif_acteur();
    }
  }
  
}
function pf_affiche_donnees(stream){
var vl_c_datas;
vl_c_datas=stream;
pf_raz_fiche();

fa_value_set('tb_nb_dec',fa_xml_get(vl_c_datas,'nb_dec'));
fa_att_set("tb_prix_unitaire","decimalplaces",fa_xml_get(vl_c_datas,'nb_dec'));
fa_value_set('tb_prix_unitaire',fa_xml_get(vl_c_datas,'pu_reference'));
if (fa_xml_get(vl_c_datas,'actif')==1) {
  fa_att_set('ra_actif_oui','selected', 'true');
  fa_value_set("rdg_tarif_actif",1);
} else {
  fa_att_set('ra_actif_non','selected', 'true');
  fa_value_set("rdg_tarif_actif",2);
}
fa_value_set("dp_dateheurevalidite",fa_xml_get(vl_c_datas,'dateheure_validite'));
fa_value_set("tb_unite_quantite",fa_xml_get(vl_c_datas,'unite_quantite'));
fa_mlsel("ml_tarif",fa_xml_get(vl_c_datas,'tarif_cleunik'));
fa_value_set("tb_quantite_basse",fa_xml_get(vl_c_datas,'quantite_basse'));
fa_value_set("tb_quantite_haute",fa_xml_get(vl_c_datas,'quantite_haute'));
}
function pf_affiche_donnees_art_tarif(){
  fa_das("$vf_c_arbre_art_tarif","$vf_c_script_das_art_tarif"+Math.random()+"&");
}
function pf_approximatif(){
  if ($vl_e_act_cleunik!=-1) {fa_approximatif_bbo();} else {pf_approximatif_acteur();}
}
function pf_approximatif_acteur(){
  if ( fa_value_get("aai_tb_rechapproxima") == "" ) {return;}
  var item=fa_gid("bao_ml_actif").selectedItem; 
  vf_c_url_alimente_table=vf_c_script_recherche_acteurs+'sortie=das&vl_c_limit='+fa_enc(fa_value_get("bao_tb_limit"))+'&vl_c_recherche='+fa_enc(fa_value_get("aai_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("aai_ml_zone")+'&vl_c_type='+fa_value_get("aai_ml_type")+'&vl_c_qui='+fa_value_get("bao_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bao_ml_actif")+'&vl_e_panier='+item.getAttribute("_graal_cleunik")+"&";
  fa_das("arbre_des_acteurs",vf_c_url_alimente_table);
}
function pf_casdemploinomenclatures() {
  fa_ouvre(c_script_fen_cademploi,1000,300);
}
function pf_change_decimal_pu(vv_valeur){
	fa_att_set("tb_prix_unitaire","decimalplaces",vv_valeur);
}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "sortir":
      window.close();
      break;
  }
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=="-1"){alert(vl_datas);}
  $pf_affiche_fenetre_mere
  if (vf_c_action=="suppression") {
    pf_etat_fen('sortir');
  } else {
    pf_affiche_donnees_art_tarif();
  }
}
function pf_raz_fiche(){
  fa_att_set('ra_actif_oui','selected', 'false');
  fa_att_set('ra_actif_non','selected', 'false');  
  fa_value_set("tb_blocnotebrut",'');
  fa_value_set("tb_nb_dec",$vl_c_nbdec_prix);
	fa_value_set("tb_unite_quantite",1);
fa_value_set("tb_quantite_basse",0);
fa_value_set("tb_quantite_haute",0);
}
function pf_sel_ligne(){
  var i=fa_cui("arbre_des_acteurs");if(i==-1){return;}
  vf_e_act_cleunik=fa_cell_get("arbre_des_acteurs",i,"act_cleunik");  //  Clé unique acteur
  fa_value_set("tb_acteur",fa_cell_get("arbre_des_acteurs",i,"qui")+' ('+fa_cell_get("arbre_des_acteurs",i,"raisonsoc")+')');
}
function pf_sel_arbre_articles(){
  var rowIndex=fa_cui("arbre_des_articles");if(rowIndex == -1){return;}
  vf_e_art_cleunik=fa_cell_get("arbre_des_articles",rowIndex,"art_cleunik");  //  Clé unique article
  fa_value_set("tb_code_art",fa_cell_get("arbre_des_articles",rowIndex,"code"));
  fa_value_set("tb_code_mnemotechnique",fa_cell_get("arbre_des_articles",rowIndex,"mnemotech"));
  fa_value_set("tb_code_description",fa_cell_get("arbre_des_articles",rowIndex,"description"));
}
function pf_validation(vv_quoi){
  var vl_c_donnees;
  switch (vv_quoi) {
    case 'enregistrer':
      if (vf_e_act_cleunik=='-1') {alert("Sélectionnez un acteur !!");return;}
      if (vf_e_art_cleunik=='-1') {alert("Sélectionnez un article !!");return;}
      vl_c_donnees="";
      vl_c_donnees+="vl_act_cleunik="+vf_e_act_cleunik+"&";
      vl_c_donnees+="vl_art_cleunik="+vf_e_art_cleunik+"&";
      vl_c_donnees+="vl_tar_cleunik="+$vl_e_tar_cleunik+"&";
      vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_value_get("tb_blocnotebrut"))+"&";
      vl_c_donnees+="vl_prix_unitaire="+fa_enc(fa_value_get("tb_prix_unitaire"))+"&";
      vl_c_donnees+="vl_dateheurevalidite="+fa_enc(fa_value_get("dp_dateheurevalidite"))+"&";
      vl_c_donnees+="vl_tarif="+fa_enc(fa_mlget("ml_tarif"))+"&";
      vl_c_donnees+="vl_actif="+fa_enc(fa_value_get("rdg_tarif_actif"))+"&";
      vl_c_donnees+="vl_nb_dec="+fa_enc(fa_value_get("tb_nb_dec"))+"&";
	  vl_c_donnees+="vl_unite_quantite="+fa_enc(fa_value_get('tb_unite_quantite'))+"&";
	  vl_c_donnees+="vl_quantite_basse="+fa_enc(fa_value_get("tb_quantite_basse"))+"&";
      vl_c_donnees+="vl_quantite_haute="+fa_enc(fa_value_get("tb_quantite_haute"))+"&";
      if ($vl_e_tar_cleunik==0) {vl_c_donnees+="vf_c_action=ajouter&";} else {vl_c_donnees+="vf_c_action=modifier&";} 
      break;
    case 'supprimer':
      if(confirm("Confirmez-vous la suppression de ce tarif ?") == false) return;
      vl_c_donnees="";
      vl_c_donnees+="vl_tar_cleunik="+$vl_e_tar_cleunik+"&";
      vl_c_donnees+="vf_c_action=supprimer&";
      vf_c_action="suppression";
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
