<?php
include("_graal_var_portee.php");
switch ($vl_c_id_arbre_inc_interlocuteurs_01) {
  case 'arbre_des_interlocuteurs':
    $vl_c_complement_nom="";
    break;
  case 'arbre_des_interlocuteurs_panier':
    $vl_c_complement_nom="_panier";
    break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const c_script_xml_commentaire='_graal_xml_documents_commentaires_01.php?';
const c_script_bdope_document='_graal_bdope_documents_commentaires_01.php?';
const c_script_int='_graal_rech_interlo_01.php?sortie=das';
var vf_e_commentaire_cleunik,vf_c_url_alimente_table;
function pf_aa_init() {
  fa_att_set("arbre_des_interlocuteurs",'context','pop_selections');
END;
$donne_focus="fa_focusdonne('tb_commentaire');";
if ($vl_c_genreacteur!='moimoi') {
echo <<<END
  fa_ael('bbj_ml_qui','ValueChange',po_change_menu);
  po_change_menu();
  pf_approximatif();
END;
	$donne_focus="fa_focusdonne('bbj_tb_rechapproxima');";
}
echo <<<END
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  fa_grise_groupe_oui('broadcaster_01');
  vf_e_commentaire_cleunik=$vl_commentaire_cleunik;
  switch ($vl_commentaire_cleunik) {
    case -1:
      pf_etat_fen("ajouter");
      fa_value_set('tb_dat_deb',"$vl_c_datedebut");
      fa_value_set('tb_heu_deb',"$vl_c_heuredebut");
      break;
    default:
      fa_xmlhttprequest_xml(c_script_xml_commentaire,"vl_commentaire_cleunik=$vl_commentaire_cleunik&",pf_affiche_donnees_commentaires);
  }
}
function pf_affiche_donnees_commentaires(stream) {
  var vl_c_datas=stream;
  pf_etat_fen("selectionner");
  pf_raz_fiche();
  fa_value_set('tb_commentaire',fa_xml_get(vl_c_datas,'commentaire'));
  fa_value_set('tb_interlo',fa_xml_get(vl_c_datas,'qui'));
  fa_value_set('tb_dat_deb',fa_xml_get(vl_c_datas,'date'));
  fa_value_set('tb_heu_deb',fa_xml_get(vl_c_datas,'heure'));
  fa_att_set("tb_interlo","int_cleunik",fa_xml_get(vl_c_datas,'int_cleunik'));
  fa_att_set("tb_interlo","act_cleunik",fa_xml_get(vl_c_datas,'act_cleunik'));

}
function pf_alimente_table() {
  switch (fa_value_get("bbj_ml_qui")) {
    case "000000": case "110000": case "110001": case "110003": case "110002": case "110004": case "110005": case "110006":
      fa_cache_oui("portee");break;
    case "999999": case "888888":
      fa_cache_non("portee");break;
  }
  fa_das("arbre_des_interlocuteurs",vf_c_url_alimente_table);
}
function pf_approximatif() {
  switch (fa_value_get("bbj_ml_qui")) {
    case "000000": case "110000": case "110001": case "110003": case "110002": case "110004": case "110005": case "110006": case "999999":
      if ( fa_value_get("bbj_tb_rechapproxima") == "" ) {return;};
      var item=fa_gid("bbj_ml_actif").selectedItem;
      vf_c_url_alimente_table=c_script_int+'&listecles=&vl_c_recherche='+fa_enc(fa_value_get("bbj_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bbj_ml_zone")+'&vl_c_type='+fa_value_get("bbj_ml_type")+'&vl_c_qui='+fa_value_get("bbj_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bbj_ml_actif")+'&vl_e_panier='+item.getAttribute("_graal_cleunik")+"&";
      break;
    case "888888":
      vf_c_url_alimente_table=c_script_int+'&listecles=&vl_c_recherche='+fa_enc(fa_value_get("bbj_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bbj_ml_zone")+'&vl_c_type='+fa_value_get("bbj_ml_type")+'&vl_c_qui='+fa_value_get("bbj_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs=4&';
      break;
  }
  pf_alimente_table();
}

function pf_etat_fen(vv_quoi) {
  vf_c_action=vv_quoi;
  var vl_portee;
  switch(vv_quoi) {
    case "ini":
      break;
    case "selectionner":
      fa_grise_non("bt_modifier");fa_grise_non("bt_supprimer");fa_grise_non("bt_annuler");
      fa_grise_oui("bt_detailler");fa_grise_oui("bt_ajouter");fa_grise_oui("bt_enregistrer");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_modifier");fa_grise_oui("bt_supprimer");fa_grise_oui("bt_detailler");fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_enregistrer");fa_grise_non("bt_annuler");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne('tb_commentaire');
      break;
    case "ajouter":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_enregistrer");
      fa_grise_non("bt_annuler");
      pf_raz_fiche();
      fa_grise_groupe_non('broadcaster_01');
      $donne_focus
      break;
    case "annuler":
      pf_aa_init();
      break;
    case "sortir":
      window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
      break;   
    default:
      break;
}
  }
function pf_fin_requete(stream) {
  window.opener.pf_affiche_iframe_commentaires();
  var vl_datas = stream;
  if (vl_datas!="-1") {
    switch (vf_c_action) {
      case "suppression":
        alert("Commentaire supprimé.");
        pf_etat_fen("sortir");
        break;
      default:
        pf_raz_fiche();
    }
  } 
  else {alert(vl_datas);}
}
function pf_maintenant(vv_qui) {
  var ladate_deb=new Date();
  var vl_c_date=ladate_deb.getDate()+"/"+(ladate_deb.getMonth()+1)+"/"+ladate_deb.getFullYear();
  var vl_c_heur=ladate_deb.getHours()+":"+fa_padleft('0', 2,ladate_deb.getMinutes().toString())+":"+fa_padleft('0', 2,ladate_deb.getSeconds().toString());
  switch (vv_qui) {
    case "tb_debut_maintenant" :
      fa_value_set('tb_dat_deb',vl_c_date);
      fa_value_set('tb_heu_deb',vl_c_heur);
      break;
  }
}

function pf_raz_fiche() {
  vf_e_commentaire_cleunik=$vl_commentaire_cleunik;
  fa_value_set('tb_commentaire',"");
  fa_value_set("tb_interlo","");
  fa_att_set("tb_interlo","int_cleunik",-1);
  fa_att_set("tb_interlo","act_cleunik",-1);
//  fa_value_set('tb_dat_deb',"");
  fa_value_set('tb_heu_deb',"");

}
function pf_sel_ligne(vv_qui) {
  var i=fa_cui("$vl_c_id_arbre_inc_interlocuteurs_01");if(i==-1){return;}
  fa_value_set("tb_interlo",fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"civilite$vl_c_complement_nom")+" "+fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"qui$vl_c_complement_nom"));
  fa_att_set("tb_interlo","int_cleunik",fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"int_cleunik$vl_c_complement_nom"));
  fa_att_set("tb_interlo","act_cleunik",fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"act_cleunik$vl_c_complement_nom"));
}

function pf_validation(vv_quoi) {
  var vl_c_donnees="";
  vl_c_donnees+="vl_doc_cleunik=$vl_doc_cleunik&";
  vl_c_donnees+="vl_commentaire_cleunik="+vf_e_commentaire_cleunik+"&";
  vl_c_donnees+="vl_act_cleunik="+fa_att_get("tb_interlo","act_cleunik")+"&";
  vl_c_donnees+="vl_int_cleunik="+fa_att_get("tb_interlo","int_cleunik")+"&";
  //vl_c_donnees+="vl_date="+fa_enc(fa_date_formate(fa_value_get("tb_dat_deb"),"AAAA-MM-JJ")+" "+fa_value_get("tb_heu_deb"))+"&";
  vl_c_donnees+="vl_date="+fa_enc(fa_value_get("tb_dat_deb")+" "+fa_value_get("tb_heu_deb"))+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_value_get("tb_commentaire"))+"&";
  switch(vv_quoi) {
    case "enregistrer":
	  if (fa_att_get("tb_interlo","int_cleunik")==-1){alert("Il faut sélectionner un interlocuteur.");return;}
      if (vf_e_commentaire_cleunik!=-1)
        {vl_c_donnees+="vf_c_action=modifier&";vf_c_action="modification";}
      else
        {vl_c_donnees+="vf_c_action=ajouter&";vf_c_action="ajout";}
      break;
    case "supprimer":
        if(confirm("Confirmez-vous la suppression de ce commentaire ?") == false) return;
        vl_c_donnees+="vf_c_action=supprimer&"
        vf_c_action="suppression";
      break;
  }
  //  Enregistrement données action
  fa_xmlhttprequest_txt(c_script_bdope_document,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
