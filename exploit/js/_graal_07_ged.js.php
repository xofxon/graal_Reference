<?php
include("_graal_var_portee.php");
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
if ($rss_accès=="restreint"){
	$bloc_00=<<<EOT
const c07_script_liens='pagesparticulieres/acces_restreint.php?';
const c07_script_notes='pagesparticulieres/acces_restreint.php?';
const c07_script_docum='pagesparticulieres/acces_restreint.php?';
const c07_script_downl='pagesparticulieres/acces_restreint.php?';
const c07_script_visua='pagesparticulieres/acces_restreint.php?';
const c07_telecharge_source_courriel='pagesparticulieres/acces_restreint.php?';
const c07_voir_source_courriel='pagesparticulieres/acces_restreint.php?';
const c07_script_critere_ged_entreprise='pagesparticulieres/acces_restreint.php?';
EOT;
} else {
$vl_tb_droits_onglet_admin=_graal_requete_droits_fenetre('Trait_00305',$vl_e_uti_cleunik); //  Autorisation de télécharger un courriel
if ($vl_tb_droits_onglet_admin[0]==false) {
	$bloc_01="";
} else {
	$bloc_01=<<<EOT
function pf07_courriel_telecharge(courriel_brut_cleunik){
	window.open(c07_telecharge_source_courriel+"vl_e_courriel_brut_cleunik="+courriel_brut_cleunik+"&raf="+Math.random());
}
function pf07_courriel_voir_source(vv_window,courriel_brut_cleunik) {
	fa_xmlhttprequest_txt(c07_voir_source_courriel+"vl_e_courriel_brut_cleunik="+courriel_brut_cleunik+"&raf="+Math.random(),"",vv_window.pf_voir_source_suite);
}
EOT;
}
$bloc_00=<<<EOT
const c07_script_liens='_graal_fen_pseudodocs_01.php?quelsdocs=unlien&';
const c07_script_notes="_graal_fen_note_01.php?quelsdocs=unenot_acteur&";
const c07_script_docum="_graal_fen_doc_07.php?";
const c07_script_downl="_graal_tel_doc_01.php?vl_e_doc_cleunik=";
const c07_script_visua="_graal_tel_doc_07.php?vl_e_doc_cleunik=";
const c07_telecharge_source_courriel='_graal_tel_courriel_01.php?';
const c07_voir_source_courriel="_graal_xml_recmail_03.php?";
const c07_script_critere_ged_entreprise='_graal_fen_ged_criteres.php?';
const c07_script_recherche="_graal_rech_ged_01.php?selection=$vl_c_selection&";
EOT;
}
switch ("$vl_c_genreged") {
	case "cgv": case "palett" : case "filigrane" : case "110000": case "favori":
		$sel_date='fa05_sel_date("21","bem_tb_deb","bem_tb_fin");';	// ad vitam
		break;
	default:
		$sel_date='fa05_sel_date("1","bem_tb_deb","bem_tb_fin");';	//	aujourd'hui
		/*
		 * a priori perturbant de n'avoir que les notes du jour ... il faudra affiner cela via un paramètre
		 */
		$sel_date='fa05_sel_date("21","bem_tb_deb","bem_tb_fin");';	// ad vitam
		break;
}
$pf_ged_ajout=<<<EOT
function pf_ged_ajout(vv_quoi_01) {}
EOT;
if ($vl_c_genreged=="cgv"||$vl_c_genreged=="palett"||$vl_c_genreged=="filigrane"){
$pf_ged_ajout=<<<EOT
function pf_ged_ajout(vv_quoi_01) {
  var vl_c_param='portee_cleunik=0&doc_cleunik=-1&';
  switch (vv_quoi_01){
    case "ged_doc":
			pf07_ouvre_doc("quelsdocs=$vl_c_genreged&genre=entrep&"+vl_c_param);
      break;
  }
}
EOT;
}
if ($vl_c_voir_doc=="oui") {
$pf07_sel_arbre_ged=<<<EOT
function pf07_sel_arbre_ged(){
	var rowIndex = fa_cui("arbre_des_ged");
	if(rowIndex == -1){return;}
	var vl_e_doc_cleunik=fa_cell_get("arbre_des_ged",rowIndex,"doc_cleunik");
	pf07_voir_iframe_doc(vl_e_doc_cleunik,"ifr_doc");
}
EOT;
} else {
$pf07_sel_arbre_ged=<<<EOT
function pf07_sel_arbre_ged(){}
EOT;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
$bloc_00
var vf07_c_qui="";
function pf07_aa_init() {
  switch ("$vl_c_retour") {
    case "oui":
      switch ("$vl_c_quelsdocs") {
        case "docs" :fa_att_set("arbre_des_ged","seltype","multiple");
		case "notes" :fa_att_set("arbre_des_ged","seltype","multiple");
		case "pseudodocs" :fa_att_set("arbre_des_ged","seltype","multiple");
        break;
      }
  }
  $sel_date
  vf07_c_qui=fa_mlget("bek_ml_qui","value");
  fa_badl("arbre_des_ged",lstn_grise);
  fa_ael("bek_ml_qui","ValueChange",pf07_change_menu);
  fa_ael("bek_tb_limit","input",pf07_approximatif);
  pf07_change_menu();
  if (("$vl_c_genreged"=="favori") || ("$vl_c_genreged"=="palett") || ("$vl_c_genreged"=="filigrane") || ("$vl_c_genreged"=="cgv")){
  	pf07_approximatif();
  }
}
function pf07_approximatif() {
  if ( fa_value_get("bek_tb_rechapproxima") == "" ) {return;}
	fa_grise_fenetre("","oui");
  var item=fa_gid("bek_ml_actif").selectedItem;
  var vl_c_url_alimente_table="";
  vl_c_url_alimente_table=c07_script_recherche+'sortie=das&vl_c_recherche='+fa_enc(fa_value_get("bek_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bek_ml_zone")+'&vl_c_type='+fa_value_get("bek_ml_type")
  vl_c_url_alimente_table+='&vl_c_qui='+vf07_c_qui+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bek_ml_actif")+'&vl_e_panier='+item.getAttribute("_graal_cleunik")+"&vl_e_limit="+fa_value_get("bek_tb_limit")+"&";
  vl_c_url_alimente_table+='vl_c_quelleplage=debut&vl_c_dateheuredebut='+fa_enc(fa_date_formate(fa_value_get("bem_tb_deb"),"AAAAMMJJ"))+'&vl_c_dateheurefin='+fa_enc(fa_date_formate(fa_value_get("bem_tb_fin"),"AAAAMMJJ"));
  vl_c_url_alimente_table+='&vl_c_sauf='+fa_att_get('bek_tb_rechapproxima','doc_cleunik_sauf');
  fa_das("arbre_des_ged",vl_c_url_alimente_table);
}
function pf07_assigne(vv_valeur,vv_label,vv_class) {
  vf_valeur=vv_valeur;
  fa_att_set("bek_ml_qui","label",vv_label);
  vf07_c_qui=fa_mlget("bek_ml_qui","value");
}
function pf07_atteindre() {
  var rowIndex = fa_cui("arbre_des_ged");
  if(rowIndex == -1){return;}
  var vl_emplacement=fa_cell_get("arbre_des_ged",rowIndex,"emplacement");
  switch (fa_cell_get("arbre_des_ged",rowIndex,"typedoc")) {
    case '1': fa_ouvre(vl_emplacement,0,0);break;
    case '2': return;break;
    case '3':
    case '13':
    return;break;
  }
}
function pf07_change_menu() {
  var vo_list = fa_gid("bek_ml_qui");
  var vo_item = vo_list.selectedItem;
  vo_list.setAttribute("class",vo_item.getAttribute("class"));
  fa_das("bek_ml_actif","$vl_c_source_paniers"+"&raf_random="+Math.random()+"&");
}
$bloc_01
function pf07_ouvre_doc(vv_param){
	fa_ouvre(c07_script_docum+vv_param,800,350);
}
function pf07_ouvre_criteres_doc(vv_doc_cleunik,vv_typedoc,vv_titre){
	var vl_c_param="typedoc="+vv_typedoc+"&";
  vl_c_param+='vl_e_doc_cleunik='+vv_doc_cleunik+'&genrecritere=entreprise&vl_c_titre='+fa_enc(vv_titre)+"&";
  fa_ouvre(c07_script_critere_ged_entreprise+vl_c_param,800,600);
}
function pf07_ouvre_ged() {
  var rowIndex = fa_cui("arbre_des_ged");
  if(rowIndex == -1){return;}
  var vl_e_doc_cleunik=fa_cell_get("arbre_des_ged",rowIndex,"doc_cleunik")
  var vl_e_portee=fa_cell_get("arbre_des_ged",rowIndex,"rattachement")
  var vl_c_param="doc_cleunik="+vl_e_doc_cleunik+"&";
  vl_c_param+="portee_cleunik="+vl_e_portee+"&";
  switch (fa_cell_get("arbre_des_ged",rowIndex,"portee")) {
    case "$vl_e_articl":vl_c_param+="genre=articl&";break;
    case "$vl_e_action":vl_c_param+="genre=action&";break;
	case "$vl_e_piejoi":vl_c_param+="genre=action&";break;
    case "$vl_e_interl":vl_c_param+="genre=interl&";break;
    case "$vl_e_acteur":vl_c_param+="genre=acteur&";break;
    case "$vl_e_utilis":vl_c_param+="genre=utilis&";break;
    case "$vl_e_entrep":vl_c_param+="genre=entrep&";break;
  }
  switch (fa_cell_get("arbre_des_ged",rowIndex,"typedoc")) {
    case '1': fa_ouvre(c07_script_liens+vl_c_param,800,300);break;
    case '2': fa_ouvre(c07_script_notes+vl_c_param,800,600);break;
    case '3': //  Documents
    case '13':  //  Pièces jointes
	case '900':  //  Les conditions générales de ventes
	case '153':  //  Formulaire de palette
	case '154':  //  Fichier filigrane
      switch (fa_cell_get("arbre_des_ged",rowIndex,"portee")) {
        case "$vl_e_articl":vl_c_param+="quelsdocs=undoc_articl&";break;
        case "$vl_e_action":vl_c_param+="quelsdocs=undoc_action&";break;
        case "$vl_e_interl":vl_c_param+="quelsdocs=undoc_interl&";break;
        case "$vl_e_acteur":vl_c_param+="quelsdocs=undoc_acteur&";break;
        case "$vl_e_utilis":vl_c_param+="quelsdocs=undoc_utilis&";break;
        case "$vl_e_entrep":vl_c_param+="quelsdocs=undoc_entrep&";break;
        default:vl_c_param+="quelsdocs=undoc&";break;
      }
    fa_ouvre(c07_script_docum+vl_c_param,800,350);break;
  }
}
function pf07_sel() {
  var vf_c_url_alimente_table="$vf_c_url_alimente_table";
  var item=fa_gid("bek_ml_qui").selectedItem;
  var vl_portee=item.getAttribute("_graal_portee")
  var vl_e_total=parseInt(vl_portee)
  fa_das("bek_ml_actif",vf_c_url_alimente_table+vl_e_total);
	try {
		fa_gid("bek_ml_actif").builder.rebuild();
	} catch (e) {
    // Je ne comprends pas pourquoi cela plante lors du premier appel
		//alert(e)
  }
  pf07_change_menu();
}
$pf07_sel_arbre_ged
function pf07_telecharge(){
  var rowIndex = fa_cui("arbre_des_ged");
  if(rowIndex == -1){return;}
  var vl_e_doc_cleunik=fa_cell_get("arbre_des_ged",rowIndex,"doc_cleunik");
	var typedoc=fa_cell_get("arbre_des_ged",rowIndex,"typedoc");
  switch (typedoc) {
    case '3':
    case '13':
    	pf07_telecharge_doc(vl_e_doc_cleunik);
			break;
		default:
  }
}
function pf07_telecharge_doc(vl_e_doc_cleunik){
	fa_ouvre(c07_script_downl+vl_e_doc_cleunik+"&",400,400);
}
function pf07_visualise(vv_doc_cleunik){
	if (vv_doc_cleunik== undefined){
		var rowIndex = fa_cui("arbre_des_ged");
		if(rowIndex == -1){return;}
		var vl_e_doc_cleunik=fa_cell_get("arbre_des_ged",rowIndex,"doc_cleunik");
	} else {
		var vl_e_doc_cleunik=vv_doc_cleunik;
	}
	fa_ouvre(c07_script_visua+vl_e_doc_cleunik+"&");
}
function pf07_visualise_doc(vl_e_doc_cleunik){
	fa_ouvre(c07_script_visua+vl_e_doc_cleunik+"&");
}
function pf07_voir_iframe_doc(vl_e_doc_cleunik,vv_iframe){
	fa_att_set(vv_iframe,"src",c07_script_visua+vl_e_doc_cleunik+"&");
}
]]></script>
END;
?>
