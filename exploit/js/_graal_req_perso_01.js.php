<?php
$vl_c_mes01='Cette fonctionnalité est en développement ...\nMerci pour votre patience.';
/*
$c_procli=($vl_e_acteur+$vl_e_procli);
$c_client=($vl_e_acteur+$vl_e_client);
$c_profou=($vl_e_acteur+$vl_e_profou);
$c_fourni=($vl_e_acteur+$vl_e_fourni);
$c_autrac=($vl_e_acteur+$vl_e_autrac);
$c_actind=($vl_e_acteur+$vl_e_actind);
*/
$c_acteur=($vl_e_acteur);
$c_interl=($vl_e_interl);
$c_procli=($vl_e_procli);
$c_client=($vl_e_client);
$c_profou=($vl_e_profou);
$c_fourni=($vl_e_fourni);
$c_autrac=($vl_e_autrac);
$c_actind=($vl_e_actind);
$c_gedged=($vl_e_gedged);
$c_criter=($vl_e_criter);
$vl_c_param_rdf="&vl_e_maportee=-1&vl_e_portee=";
switch ($vl_c_id_inc_reqperso_02){
  case "Fen_00104": // Construction des requêtes personnelles
    $vl_readonly_01="false";
    $vl_c_modif_01='fa_att_rem("req_manu_edition","readonly");';
    break;
  case "Fen_00105": // Gestion de mes requêtes personnelles
    $vl_readonly_01="true";
    $vl_c_modif_01='fa_att_rem("req_manu_edition","readonly");';
    break;
  case "Fen_00562":$vl_readonly_01="true";  // Requêtes standard
    $vl_c_modif_01='fa_grise_oui("ml_portee");';
    switch ($vl_c_type) {
      case "1"  : //  acteurs
        switch ($vl_c_genre) {
          case "999999" : $vl_c_param_rdf.=$c_acteur;break; //  Tous les acteurs
          case "110003" : $vl_c_param_rdf.=$c_client+$c_acteur;break; //  Clients
          case "110001" : $vl_c_param_rdf.=$c_procli+$c_acteur;break; //  Prospects Clients
          case "110004" : $vl_c_param_rdf.=$c_fourni+$c_acteur;break; //  Fournisseurs
          case "110002" : $vl_c_param_rdf.=$c_profou+$c_acteur;break; //  Prospects fournisseurs
          case "110005" : $vl_c_param_rdf.=$c_autrac+$c_acteur;break; //  Autres acteurs
          case "110006" : $vl_c_param_rdf.=$c_actind+$c_acteur;break; //  Acteurs indéterminés
          default : fa_redirige("acces_interdit");break;
        }
        break;
      case "2"  : //  articles
        $vl_c_param_rdf.=$vl_e_articl;
        break;
			case "3"  : //  ged
        $vl_c_param_rdf.=$vl_e_gedged;
        break;
      case "4"  : //  interlocuteurs
        switch ($vl_c_genre) {
          case "999999" : $vl_c_param_rdf.=$c_interl;break; //  Tous les acteurs
          case "110003" : $vl_c_param_rdf.=$c_client+$c_interl;break; //  Clients
          case "110001" : $vl_c_param_rdf.=$c_procli+$c_interl;break; //  Prospects Clients
          case "110004" : $vl_c_param_rdf.=$c_fourni+$c_interl;break; //  Fournisseurs
          case "110002" : $vl_c_param_rdf.=$c_profou+$c_interl;break; //  Prospects fournisseurs
          case "110005" : $vl_c_param_rdf.=$c_autrac+$c_interl;break; //  Autres acteurs
          case "110006" : $vl_c_param_rdf.=$c_actind+$c_interl;break; //  Acteurs indéterminés
          default : fa_redirige("acces_interdit");break;
        }
        break;
			case "5":	//	critères
        $vl_c_param_rdf.=$c_criter;
        break;
      default : fa_redirige("acces_interdit");break;
    }
  break;
  default : fa_redirige("acces_interdit");break;  // Erreur de programmation
}

echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
****************************************************************
**********  Fenêtre de gestion des Requêtes personnelles  ********
****************************************************************
*/
var vf_e_panier_cleunik=-1;
var vf_c_action;
var vl_c_script_meta,vl_c_script_titre;
var vf_c_genre;
var vf_c_ValRetour;
var vf_c_requete_en_cours;
var vf_c_requete="";
const vf_c_url_execute_requete="_admin_fen_bd_select_lambda_01.php?";
const vf_c_script_xml="_graal_xml_paniers_01.php?"
const vf_c_url_alimente_table="_graal_das_paniers_01.php?vl_e_type=2,3&vl_c_quelspaniers=$vl_c_quelsdocs$vl_c_param_rdf&vl_c_operateur_portee=";
const vf_c_script_bdope_doc="_graal_bdope_paniers_01.php";
const c_script_droits='_graal_fen_paniers_droits_01.php?';
function pf_action(vv_quoi){
  switch (vv_quoi){
    case 'atteindre' :
      alert("$vl_c_mes01");
      return;
      break;
    case 'droits' :
      if (vf_e_panier_cleunik!=0)
      {
        fa_ouvre("_graal_fen_droits_01.php?vl_c_genredoc=Docus&vl_e_doc_cleunik="+vf_e_sel_cleunik,400,400);
      }
      else
      {
        alert('Vous ne pouvez pas gérer les droits de cette manière !!');
      }
      break;
  }
}
function pf_affiche_datas(stream){
  var vl_c_datas=stream;
  pf_raz_fiche();
  vf_e_panier_cleunik=fa_xml_get(vl_c_datas,'panier_cleunik');
  fa_value_set('tb_titre',fa_xml_get(vl_c_datas,'panier_titre'));
  fa_value_set('tb_descriptif_sommaire',fa_xml_get(vl_c_datas,'blocnote_brut'));
  fa_value_set('la_dateheurecreation',fa_xml_get(vl_c_datas,'dateheurecreation'));
  fa_value_set('la_dateheuremodif',fa_xml_get(vl_c_datas,'dateheuremodif'));
  fa_value_set('req_manu_edition',fa_xml_get(vl_c_datas,'panier_requete_selection'));
	var toto=fa_xml_get(vl_c_datas,'panier_requete_selection_exploit');
	vf_c_requete=toto;	//	 si on affecte directement à vf_c_requete, ça plante !!!
	var pre=8;
	var der=vf_c_requete.indexOf(']]',1);
	vf_c_requete=vf_c_requete.substring(pre,der);
	switch(fa_xml_get(vl_c_datas,'actif')) {
   case "1": fa_att_set('ra_choix_actif_oui',"selected", 'true');break;
   case "2": default : fa_att_set('ra_choix_actif_non','selected', 'true');break;
  }
  var vl_e_nombre=fa_att_get("ml_portee","_graal_nombre");
  for(var i=0;i<vl_e_nombre;i++){
    fa_gid("ml_portee").selectedIndex=i;
    if (fa_xml_get(vl_c_datas,'panier_portee')==fa_gid("ml_portee").selectedItem.getAttribute("value")){pf_change_ml_portee();break;}
  }
}
function pf_alimente_defaut(){
  fa_att_set('ra_choix_actif_oui',"selected", 'true');
}
function pf_alimente_table() {
  fa_das("arbre_des_requetes",vf_c_url_alimente_table+fa_enc("=")+"&raf01="+Math.random());
}
function pf_change_ml_portee() {
  var vo_list = fa_gid("ml_portee");
  var vo_item = vo_list.selectedItem;
  vo_list.setAttribute("class",vo_item.getAttribute("class"));
}
function pf_droits() {
  if (vf_e_panier_cleunik==-1) {return;}
  fa_ouvre(c_script_droits+"vl_e_panier_cleunik="+vf_e_panier_cleunik,400,400);
}
function pf_etat_fen(vv_quoi){
   vf_c_action=vv_quoi;
   switch(vv_quoi) {
     case "ini":
       fa_att_get("la_genre","_graal_lesquels");
       fa_grise_non("bt_ajouter");
       fa_grise_non("bt_annuler");
       fa_grise_non("bt_detailler");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_modifier");
       fa_grise_non("bt_sortir");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_droits");
       fa_grise_groupe_oui('broadcaster_01');
       pf_change_ml_portee();
       pf_alimente_table();
       break;
     case "selectionner":
     	pf_verif_acces();
     	break;
     case "selectionner_suite":  //   à affiner, en fonction des droits
       fa_grise_oui("bt_ajouter");
       fa_grise_non("bt_annuler");
       fa_grise_oui("bt_detailler");
       fa_grise_oui("bt_enregistrer");
       fa_grise_non("bt_modifier");
       fa_grise_oui("bt_sortir");
       fa_grise_non("bt_supprimer");
       fa_att_set("menu_02_01","disabled","false");
       //fa_grise_non("menu_02_01");  Ne fonctionne pas pour un menu
       break;
    case "ajouter":
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_oui("bt_droits");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_titre");
      fa_att_rem("req_manu_edition",'readonly');
      break;

     case "modifier":
       fa_grise_non("bt_enregistrer");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_supprimer");
       fa_grise_non("bt_droits");
       fa_att_set("menu_02_01","disabled","false");
       //fa_grise_non("menu_02_01");  Ne fonctionne pas pour un menu
       fa_grise_groupe_non('broadcaster_01');
       $vl_c_modif_01
       fa_focusdonne('tb_titre');
       break;
     case "annuler":
       fa_grise_non("bt_ajouter");
       fa_grise_oui("bt_annuler");
       fa_grise_non("bt_detailler");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_modifier");
       fa_grise_non("bt_sortir");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_droits");
       fa_att_set("menu_02_01","disabled","true");
       //fa_grise_oui("menu_02_01");  Ne fonctionne pas pour un menu
       fa_focusdonne('arbre_des_requetes');
       fa_grise_groupe_oui('broadcaster_01');
       pf_raz_fiche();
       break;
     case "sortir":
       window.close();
       break;
    default:
      alert("Cas"+vv_quoi+" pas géré ...")
      break;
}
  }
function pf_lance(){
  fa_gid('tabpan_03').selectedIndex=1;
  fa_att_set("req_manu_resultat","src",vf_c_url_execute_requete+"vl_e_panier_cleunik="+vf_e_panier_cleunik+"&");
}
function pf_raz_fiche(){
  fa_value_set('tb_titre',"");
  fa_value_set('tb_descriptif_sommaire',"");
  fa_value_set('la_dateheurecreation',"");
  fa_value_set('la_dateheuremodif',"");
  fa_value_set('req_manu_edition',"");
  vf_e_panier_cleunik=-1;
  fa_att_rem('ra_choix_actif_oui','selected');
  fa_att_rem('ra_choix_actif_non','selected');
  fa_att_set("req_manu_edition",'readonly',"$vl_readonly_01");
}
function pf_sel_ligne(vv_objet){
  if (fa_est_grise("bt_detailler")==true) {return};
  var arbre = fa_gid(vv_objet);
  var rowIndex = arbre.currentIndex;
  if(rowIndex == -1){return;}
  vf_e_panier_cleunik=arbre.view.getCellText( rowIndex ,arbre.columns.getNamedColumn("panier_cleunik"));
  var s ="vl_e_panier_cleunik="+fa_enc(vf_e_panier_cleunik)+"&raf01="+Math.random()+"&";
  fa_xmlhttprequest_xml(vf_c_script_xml,s,pf_affiche_datas);
}

function pf_validation(vv_quoi){
var s;
switch(vv_quoi){
  case "supprimer":
    var Check = confirm("Confirmez-vous la suppression de cette requête ?");
    if(Check == false) return;
    vf_c_action="supprimer";
    break;
  case "enregistrer":
    switch (vf_e_panier_cleunik) {
      case -1: vf_c_action="ajouter_req_manu_perso";break;
      default: vf_c_action="modifier_req_manu_perso";break;
    }
    break;
  default:
    alert(vv_quoi+" imprévu !!!");
    return;
    break;
  }
  vf_c_requete_en_cours=vf_c_action;
  var vl_c_choix_actif;
  vl_c_choix_actif=fa_value_get('rdg_actif');
  if (vl_c_choix_actif=='') {vl_c_choix_actif=1};
  s="";
  s+="vl_panier_cleunik="+fa_enc(vf_e_panier_cleunik)+"&";
  s+="vl_panier_titre="+fa_enc(fa_value_get("tb_titre"))+"&";
  s+="vl_blocnote_brut="+fa_enc(fa_value_get("tb_descriptif_sommaire"))+"&";
  s+="vl_c_action="+fa_enc(vf_c_action)+"&";
  s+="vl_actif="+fa_enc(vl_c_choix_actif)+"&";
  s+="vl_panier_requete_selection="+fa_enc(fa_value_get('req_manu_edition'))+"&";
  s+="vl_panier_portee="+fa_enc(fa_gid("ml_portee").selectedItem.getAttribute("value"))+"&";
  s+="quelsdocs="+fa_enc("$vl_c_quelsdocs")+"&";
  fa_att_set("_graal_req_perso_01","wait-cursor","true");
  //alert(s)
  fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_validation_fin);
}
function pf_validation_fin(stream){
  var vl_datas = stream;
  fa_att_rem("_graal_req_perso_01","wait-cursor");
  pf_raz_fiche();
  pf_alimente_table();
  pf_etat_fen('annuler');
}

function pf_verif_acces(){
	var rowIndex = fa_cui("arbre_des_requetes");if(rowIndex == -1){return;}
	var vl_e_panier_cleunik=fa_gid("arbre_des_requetes").view.getCellText( rowIndex ,fa_gid("arbre_des_requetes").columns.getNamedColumn("panier_cleunik"));
	var s ="vf_c_action=verifier_droits_acces&vf_e_panier_cleunik="+fa_enc(vl_e_panier_cleunik)+"&";
	fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_verif_acces_fin);
}
function pf_verif_acces_fin(stream) {
  var vl_c_datas=stream;
  vf_e_droits_proprio=vl_c_datas;
  pf_etat_fen("selectionner_suite");
}


function pf_voir_plein_ecran(){
  var arbre = fa_gid("arbre_des_requetes");
  var rowIndex = arbre.currentIndex;
  if(rowIndex == -1){return;}
  vf_e_panier_cleunik=arbre.view.getCellText( rowIndex ,arbre.columns.getNamedColumn("panier_cleunik"));
  var s ="vl_e_panier_cleunik="+fa_enc(vf_e_panier_cleunik)+"&raf01="+Math.random()+"&";
  fa_xmlhttprequest_xml(vf_c_script_xml,s,pf_voir_plein_ecran_suite);
}
function pf_voir_plein_ecran_suite(stream){
  var vl_c_datas=stream;
  var vl_c_url=vf_c_url_execute_requete;
  vl_c_url+="vl_c_requete="+fa_xml_get(vl_c_datas,'panier_requete_selection')+"&";
  fa_ouvre(vl_c_url,0,0);
}
]]></script>
END;
?>
