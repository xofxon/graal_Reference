<?php
$vl_c_bpi_113=fa_recup_dico_js("bpi_113");
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_interlo_mesinst_01.php";
const vf_c_script_edite="_graal_xml_act_interlo_mesinst_01.php";
const c_script_verif="_graal_verifie_mail_02.php?";
var vf_c_action;
var vf_e_mesinst_cleunik;

function pf_aa_init(){
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  vf_e_mesinst_cleunik="$vl_e_mesinst_cleunik";
  fa_gid('dk_01').selectedIndex=0;
  switch (vf_e_mesinst_cleunik)  {
    case "-1":  //  création
      pf_etat_fen("ajouter");
      break;
    default:
      pf_etat_fen("ini");
      pf_selectionne_mail();
      break    
  }
}
function pf_affiche_datas(stream){
var vl_c_datas = stream;
vf_e_mesinst_cleunik=fa_xml_get(vl_c_datas,'mesinst_cleunik');
fa_value_set("tb_mesinst",fa_xml_get(vl_c_datas,'mesinst'));
fa_value_set("tb_blocnotebrut",fa_xml_get(vl_c_datas,'blocnotebrut'));
fa_value_set("tb_dateheuremodif",fa_xml_get(vl_c_datas,'dateheuremodif'));
fa_value_set("tb_dateheureverification",fa_xml_get(vl_c_datas,'dateheureverification'));
fa_value_set("tb_cr_verification",fa_xml_get(vl_c_datas,'cr_verification'));
fa_value_set("rdg_actif",fa_xml_get(vl_c_datas,'infofavori'));
fa_value_set("rdg_veuxpasdecontact",fa_xml_get(vl_c_datas,'veuxpasdecontact'));
fa_value_set("rdg_valide",fa_xml_get(vl_c_datas,'valide'));
fa_mlsel("ml_type_mesinst_00",fa_xml_get(vl_c_datas,'choix_cleunik_type'));
fa_mlsel("ml_prot_mesinst_00",fa_xml_get(vl_c_datas,'choix_cleunik_prot'));
}
function pf_alimente_defaut(){
  fa_value_set("tb_mesinst","$vl_c_mesinst");
  fa_value_set("tb_blocnotebrut","")
  fa_value_set("rdg_actif",2);
  fa_value_set("rdg_veuxpasdecontact",3);
  fa_value_set("rdg_valide",3);
  fa_value_set("tb_dateheureverification","");
  fa_value_set("tb_cr_verification","");
}
function pf_etat_fen(vv_quoi) {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_sortir");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("ml_type_mesinst_00");
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("ml_type_mesinst_00");
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      switch (vf_e_mesinst_cleunik) {
        case "-1":  //  création
          pf_etat_fen("ajouter");
          break;
        default:
          pf_etat_fen("ini");
          pf_selectionne_mail();
          break    
      }
      break;
    case "sortir":
      window.close();
      break;
    default:
      break;
  }
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (window.opener!=null) {
    try {
      window.opener.pf_affiche_donnees_interlo();
    } catch(e) {}
  }
  if (vl_datas!="-1") {
      switch (vf_c_action) {
        case "ajout":
          break;
        case "modification":
          break;
        case "suppression":
          alert("Adresse courriel supprimée.")
          break;
      }
      pf_etat_fen("sortir");
    }
  else
    {
    alert(vl_datas);
    pf_etat_fen("annuler");
    }
}
function pf_raz_fiche() {
  fa_value_set("tb_mesinst","");
  fa_value_set("tb_dateheuremodif","");
  fa_value_set("tb_blocnotebrut","");
  fa_att_set('ra_choix_actif_oui','selected', 'false');
  fa_att_set('ra_choix_actif_non','selected', 'false');
  fa_att_set('ra_veuxpasdecontact_oui','selected', 'false');
  fa_att_set('ra_veuxpasdecontact_non','selected', 'false');
  fa_att_set('ra_veuxpasdecontact_nsp','selected', 'false');
  fa_att_set('ra_valide_oui','selected', 'false');
  fa_att_set('ra_valide_non','selected', 'false');
  fa_att_set('ra_valide_nsp','selected', 'false');
}
function pf_selectionne_mail(){
  var s ="vl_e_mesinst_cleunik="+vf_e_mesinst_cleunik+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var vl_c_donnees;
  vl_c_donnees="";
  vl_c_donnees+="vl_mesinst_cleunik="+fa_enc(vf_e_mesinst_cleunik)+"&";
  vl_c_donnees+="vl_int_cleunik=$vl_e_interlo_cleunik&";
  vl_c_donnees+="vl_act_cleunik=$vl_e_act_cleunik&";
  vl_c_donnees+="vl_mesinst="+fa_enc(fa_value_get("tb_mesinst"))+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_gid("tb_blocnotebrut").value)+"&";
  vl_c_donnees+="vl_infofavori="+fa_enc(fa_value_get('rdg_actif'))+"&";
  vl_c_donnees+="vl_choix_cleunik_type="+fa_enc(fa_mlget("ml_type_mesinst_00"))+"&";
  vl_c_donnees+="vl_choix_cleunik_prot="+fa_enc(fa_mlget("ml_prot_mesinst_00"))+"&";
  vl_c_donnees+="vl_veuxpasdecontact="+fa_enc(fa_value_get('rdg_veuxpasdecontact'))+"&";
  vl_c_donnees+="vl_valide="+fa_enc(fa_value_get('rdg_valide'))+"&";
  switch(vv_quoi) {
    case "enregistrer":
      if (vf_e_mesinst_cleunik!=-1)
        {vl_c_donnees+="vf_c_action=modifier&";}
      else
        {vl_c_donnees+="vf_c_action=ajouter&";}
      break;
    case "supprimer":
        if(confirm("$vl_c_bpi_113") == false) return;
        vl_c_donnees+="vf_c_action=supprimer&"
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
function pf_verifie(){
  var vl_t_mail=[];
  var vl_t_mesinst=[];
  var vl_c_param="";
  vl_t_mail[0]=window.btoa(fa_value_get("tb_mesinst"));
  vl_t_mesinst[0]=vf_e_mesinst_cleunik;
  vl_c_param+='vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_mesinst))+"&";
  vl_c_param+='vl_t_listemail='+fa_enc(fa_jsarray2php_00(vl_t_mail))+"&";
  vl_c_param+='vl_type_sortie=texte'+"&raf="+Math.random()+'&';
  fa_att_set("if_cr_visite","src",c_script_verif+vl_c_param);
  fa_gid("dk_01").selectedIndex=1;
}
]]></script>
END;
?>
