<?php
$c_fen_id="_graal_fen_identification_01.php?q=".$_SESSION["vsid_uuid"];
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_connect="_graal_exe_reinit_session.php";
const vf_c_script_recup_menu="_graal_construit_menu_personalise_01.php?doc_cleunik=";
const aad_c_script_edite_note='_graal_bdope_note_03.php?doc_cleunik=';
var vf_c_menugrise=false;
function aad_pf_aa_init(what) {
END;
if ($doc_cleunik==0) {
  $vl_tb_droits=_graal_requete_droits_fenetre('Fen_00059',$vl_e_uti_cleunik); //  Dossier exploitation
  if ($vl_tb_droits[0]==true) {echo('fa_xmlhttprequest_xml("_graal_construit_menu03_exploitation_01.php","",aad_pf_loadtree_1,"treeitems");');}
} else {
  echo("aad_pf_charge_menu_dest($doc_cleunik);");
}
echo <<<END
}
function aad_pf_cache() {
  var vl_tab_edition,vl_label,vl_c_actions;
  vl_label=fa_att_get("bt_gesaff","label");
  vl_c_actions=fa_gid("bt_actions");
  if(vl_label=="Afficher le dossier") {
  	fa_att_set("bt_gesaff","label","Masquer le dossier");
		fa_att_set("bt_gesaff","tooltiptext","Pour masquer le dossier Ctrl+Alt+M");
    fa_cache_non("hbox_panneaudegauche");
   }
   else {
    fa_cache_oui("hbox_panneaudegauche");
		fa_att_set("bt_gesaff","label","Afficher le dossier");
		fa_att_set("bt_gesaff","tooltiptext","Pour afficher le dossier Ctrl+Alt+M");
   }
}
function aad_pf_change_deck(vv_lequel){
	fa_gid("deck_menus").selectedIndex=vv_lequel;
}
function aad_pf_charge_criteres() {
  fa_xmlhttprequest_xml('_graal_construit_menu03_criteres_01.php','',aae_pf_loadtree,'treeitems');
}
function aad_pf_charge_exploitation_defaut_ouvert() {
  fa_xmlhttprequest_xml('_graal_construit_menu03_exploitation_01.php','',aad_pf_charge_exploitation_defaut_ouvert_fin,'treeitems');
}
function aad_pf_charge_exploitation_defaut_ouvert_fin(xml,quel_treechildren) {
  fa_att_set('treedata',"collapsed");
  aae_pf_loadtree(xml,quel_treechildren);
  fa_att_rem('treedata',"collapsed");
}
function aad_pf_charge_exploitation_defaut_ferme() {
  fa_xmlhttprequest_xml('_graal_construit_menu03_exploitation_01.php','',aad_pf_charge_exploitation_defaut_ferme_fin,'treeitems');
}
function aad_pf_charge_exploitation_defaut_ferme_fin(xml,quel_treechildren) {
  var xmlroot = xml.documentElement;                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
  fa_collapse_tree('treedata');
}
function aad_pf_charge_menu_dest(vv_doc_cleunik,vv_titre,vv_descriptif_sommaire) {
  fa_vide_arbre("treeitems");
  fa_xmlhttprequest_xml(vf_c_script_recup_menu+vv_doc_cleunik,"",aad_pf_charge_menu_dest_suite,"treeitems");
}
function aad_pf_charge_menu_dest_suite(xml,quel_treechildren){
  //  On ne prends pas la racine car on a des difficultés à mémoriser sans la première ligne !!
  var xmlroot = xml.documentElement.childNodes[0];                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
  fa_att_rem('treedata',"collapsed");
}
function aad_pf_charge_menu_dest_page(vv_doc_cleunik,vv_titre,vv_descriptif_sommaire) {
  fa_att_set("graal_iframe_menu_pages","src",aad_c_script_edite_note+vv_doc_cleunik+'&raf_random='+Math.random()+'&');
}
END;
if ($vl_tb_droits_admin[0]==true) {echo('function aad_pf_charge_administration() {fa_xmlhttprequest_xml(\'_graal_construit_menu03_administration_01.php\',\'\',aae_pf_loadtree,\'treeitems\');}');}
if ($vl_e_uti_cleunik==1){echo('function aad_pf_charge_gestion() {fa_xmlhttprequest_xml(\'_graal_construit_menu00_gesstion_01.php\',\'\',aae_pf_loadtree,\'treeitems\');}');}
echo <<<END
function aad_pf_ferme(){
	window.close();
}
function aad_pf_fin_con(stream) {
  window.location="$c_fen_id";
}
function aad_pf_grise_menu_oui(){
	vf_c_menugrise=true;
	//fa_att_set("graal_fen_menu003","onbeforeunload","aad_pf_onbeforeunload();");
	//fa_att_set("graal_fen_menu003","onunload","");
	fa_grise_oui("aad_menu_arbre");
	fa_grise_oui("treedata");
}
function aad_pf_grise_menu_non(){
	vf_c_menugrise=false;
	fa_grise_non("aad_menu_arbre");
	fa_grise_non("treedata");
}
function aad_pf_loadtree_1(xml,quel_treechildren) {
  aae_pf_loadtree(xml,quel_treechildren);
  fa_collapse_tree('treedata');
  fa_att_rem('treedata',"collapsed");
}
function aad_pf_onbeforeunload(){
	if (vf_c_menugrise==true){
		//return "Traitement en cours. Voulez-vous quand même sortir ?";
		if (confirm("Traitement en cours. Voulez-vous quand même sortir ?")!=true) {
			return false;
		} else {
			return true;
		}
	} else {
		alert("gooooooooo");
	}
}
function aad_pf_reconnecte() {
  var http = new XMLHttpRequest();
  http.open("GET",vf_c_script_connect,true);
  http.onreadystatechange=function(){if(http.readyState==4){aad_pf_fin_con(http.responseText);}};
  http.send("");
}
]]></script>
END;
?>
