<?php
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_sites_01.php";
const vf_c_script_edite="_graal_xml_act_sites_01.php";
const vf_c_script_metatags="_graal_fen_metatags_02.php?";
const vf_c_script_meta='_graal_das_metatag_keyword_03.php?genre=description&';
var vf_c_action;
var vf_e_site_cleunik;

function pf_aa_init(){
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  vf_e_site_cleunik="$vl_e_site_cleunik";
  switch (vf_e_site_cleunik)  {
    case "-1":  //  création
      pf_etat_fen("ajouter");
      break;
    default:
      pf_etat_fen("ini");
      pf_selectionne_site();
      break    
  }
}
function pf_action(vv_quoi){
  var vl_c_param="";
  switch (vv_quoi){
    case 'meta_description':
			vl_c_param=fa_value_get('tb_refweb');
			var vl_c_http=vl_c_param.substr(0,4);
			vl_c_http=vl_c_http.toLowerCase();
			if (vl_c_http!="http") {vl_c_param="http://"+vl_c_param;}
      s="vl_c_url="+fa_enc(vl_c_param)+"&";
      vf_c_requete_en_cours=vv_quoi;
      fa_xmlhttprequest_xml(vf_c_script_meta,s,pf_affiche_metas);
      break;
  }
}

function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  fa_att_set("_win_fen_act_site","_graal_site_cleunik",fa_xml_get(vl_c_datas,'site_cleunik'));
  vf_e_site_cleunik=fa_gid("_win_fen_act_site").getAttribute("_graal_site_cleunik");
  fa_value_set("tb_refweb",fa_xml_get(vl_c_datas,'refweb'));
  fa_value_set("tb_blocnotebrut",fa_xml_get(vl_c_datas,'blocnotebrut'));
  fa_value_set("tb_dateheuremodif",fa_xml_get(vl_c_datas,'dateheuremodif'));
  fa_value_set("tb_dateheurevalidite",fa_xml_get(vl_c_datas,'dateheurevalidite'));
  fa_mlsel("ml_site_00",fa_xml_get(vl_c_datas,'choix_cleunik'));
}
function pf_affiche_metas(stream){
  var vl_c_datas;
  vl_c_datas = stream;
  try{
    if (fa_xml_get(vl_c_datas,'nombre')==0){
      alert('Il n\'y a pas, a priori, de description exploitable sur cette page.');
      return;
    }
    fa_value_set('tb_blocnotebrut',fa_xml_get(vl_c_datas,'description'));
  } catch (e) {}
}
function pf_alimente_defaut(){
  fa_value_set("tb_refweb","");
  fa_value_set("tb_blocnotebrut","");
}
function pf_etat_fen(vv_quoi)  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_sortir");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("ml_site_00");
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("ml_site_00");
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      switch (vf_e_site_cleunik){
        case "-1":  //  création
          pf_etat_fen("ajouter");
          break;
        default:
          pf_etat_fen("ini");
          pf_selectionne_site();
          break    
      }
      break;
    case "sortir":
      window.close();
      break;
    default:
      break;
  }
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
	try {
    if (window.opener!=null) {window.opener.pf_affiche_donnees_sites();}
  }
  catch (e) {
    //alert(e);
  }
  if (vl_datas!="-1") {
      switch (vf_c_action){
        case "ajout":
          break;
        case "modification":
          break;
        case "suppression":
          alert("Référence au site supprimée.")
          break;
      }
      pf_etat_fen("sortir");
    }
  else
    {
    alert(vl_datas);
    pf_etat_fen("annuler");
    }
}
function pf_ouvre_criteres_particuliers() {
  var s="";
  s+="vf_e_act_cleunik=$vl_e_act_cleunik&";
  s+="vf_e_critere_cleunik="+fa_gid("ml_criteres_particuliers").selectedItem.getAttribute("_graal_cleunik_critere")+"&";
	var vl_c_param=fa_value_get('tb_refweb');
	var vl_c_http=vl_c_param.substr(0,4);
	vl_c_http=vl_c_http.toLowerCase();
	if (vl_c_http!="http") {vl_c_param="http://"+vl_c_param;}
  s+="vf_c_url="+fa_enc(vl_c_param)+"&";
  fa_ouvre(vf_c_script_metatags+s,400,400);
}

function pf_raz_fiche(){
  fa_value_set("tb_refweb","");
  fa_value_set("tb_blocnotebrut","");
  fa_value_set("tb_dateheuremodif","");
}
function pf_selectionne_site(){
  var s ="vl_e_site_cleunik="+vf_e_site_cleunik+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var vl_c_donnees;var vl_c_choix_actif;var vl_c_veuxpasdemail;var vl_c_valide;
  vl_c_donnees="";
  vl_c_donnees+="vl_site_cleunik="+fa_enc(vf_e_site_cleunik)+"&";
  vl_c_donnees+="vl_act_cleunik=$vl_e_act_cleunik&";
  vl_c_donnees+="vl_refweb="+fa_enc(fa_value_get("tb_refweb"))+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_gid("tb_blocnotebrut").value)+"&";
  vl_c_donnees+="vl_choix_cleunik="+fa_enc(fa_mlget("ml_site_00"))+"&";
  switch(vv_quoi)  {
    case "enregistrer":
      if (vf_e_site_cleunik!=-1)
        {vl_c_donnees+="vf_c_action=modifier&";}
      else
        {vl_c_donnees+="vf_c_action=ajouter&";}
      break;
    case "supprimer":
        Check = confirm("Confirmez-vous la suppression de cet élément ?");
        if(Check == false) return;
        vl_c_donnees+="vf_c_action=supprimer&"
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
