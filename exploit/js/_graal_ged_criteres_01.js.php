<?php
$vl_mess_00010=fa_recup_dico_js('mess_00010','');
$vl_mess_00012=fa_recup_dico_js('mess_00012','');
switch ($vl_c_genrecritere) {
  case "entreprise": $vf_c_script_critere_ged='_graal_das_ged_criteres_entreprise.php?';$uti=0;break;
  case "moi": $vf_c_script_critere_ged='_graal_das_ged_criteres_lesmiens.php?';$uti=intval(fa_recup_session('vs_uti_cleunik','0'));break;
}
$vf_c_script_critere_potentiel_ged="_graal_das_criteres_potentiels_ged.php?portee=$vl_e_portee&genrecritere=$vl_c_genrecritere&";
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_e_critere_cleunik,vf_e_choix_cleunik,vf_e_critere_cleunik_ged,vf_e_choix_cleunik_ged,vf_e_critere_codechoixpertinent;
const vf_c_script_critere_ged="$vf_c_script_critere_ged";
const vf_c_script_critere="$vf_c_script_critere_potentiel_ged";
const vf_c_script_choix="_graal_das_choix_critere_01.php?vl_c_nombre=ged&vl_c_etat=1&sauf=sauf&vl_e_uti_cleunik=$uti&vl_e_recipiendaire=$vl_e_doc_cleunik&";
const vf_c_script_bdope_fen="_graal_bdope_ged_criteres_01.php?genrecritere=$vl_c_genrecritere&typedoc=$vl_c_typedoc&";
const vf_c_script_metatags="_graal_fen_metatags_01.php?typedoc=$vl_c_typedoc&";
const vf_c_script_proprietes="_graal_fen_doc_proprietes_01.php?typedoc=$vl_c_typedoc&";
const vf_c_script_nouveaux_choix="_graal_fen_choix_criteres_ged.php?";
const vf_c_script_langues="_graal_fen_critere_02.php?";
const vf_c_script_nouveaux_criteres="_graal_fen_criteres_ged.php?";
const lstn_arb_choix_criteres = { 
	willRebuild : function(event){},
	didRebuild  : function(event){fa_lignes_arbre_deselectionne("arb_choix_criteres");} 
};
function pf_aa_init() {
  fa_badl("arb_choix_criteres",lstn_arb_choix_criteres);
  pf_affiche_criteres_ged();
  pf_affiche_criteres_potentiel_ged();
}
function pf_affiche_criteres_ged() {
  var vl_c_param=vf_c_script_critere_ged+"vl_e_doc_cleunik="+"$vl_e_doc_cleunik"+"&raf_random="+Math.random();
  fa_das("criteres_des_geds",vl_c_param);
}
function pf_affiche_criteres_potentiel_ged(){
  var vl_c_param=vf_c_script_critere+"doc_cleunik="+"$vl_e_doc_cleunik"+"&raf_random="+Math.random();
  fa_das("arb_criteres",vl_c_param);
}
function pf_affiche_choix_criteres_potentiel_ged() {
  var vl_c_param=vf_c_script_choix+"vl_c_critere_cleunik="+vf_e_critere_cleunik+"&raf_random="+Math.random()+"&vl_c_position="+fa_value_get("rdg_position")+"&";
  fa_das("arb_choix_criteres",vl_c_param);
}
function pf_etat_fen(vv_quoi){
  var vl_portee;
  switch(vv_quoi) {
    case "ini":
      vf_e_critere_cleunik="A";
      break;
    case "sortir":
      try {
        window.opener.pf_affiche_donnees_criteres()
      } catch(e) {}
      window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
      break;   
    default:
      break;
  }
}
function pf_fin_requete(stream) {
  var vl_datas = stream;
  if (window.opener!=null) {
  	try {
  			window.opener.pf_affiche_donnees_criteres();
		}  catch (e) {
		// raf
		}
	}
  if (vl_datas=="ok") {
	  pf_affiche_criteres_ged();
	  pf_affiche_criteres_potentiel_ged();
	  fa_vide_arbre_bis("arb_choix_criteres");
      pf_affiche_choix_criteres_potentiel_ged();
    } 
  else {
    alert(vl_datas);
    pf_etat_fen("annuler");
    }
}  
function pf_nouveaux_criteres() {
  fa_ouvre(vf_c_script_nouveaux_criteres,1000,600)
}
function pf_nouveaux_choix() {
  switch (vf_e_critere_cleunik) {
    case "A"  : return;break;
    case "58" : fa_ouvre(vf_c_script_langues+"quelnocritere=58",400,400);break; 
    case "121": fa_ouvre(vf_c_script_langues+"quelnocritere=121",400,400);break;
    default   : 
    fa_ouvre(vf_c_script_nouveaux_choix+"critere_cleunik="+vf_e_critere_cleunik+"&per="+vf_e_critere_codechoixpertinent,1000,600);break;
  }
}
function pf_ouvre_criteres_particuliers(vv_quoi) {
  var s="";
  s+="vf_e_doc_cleunik=$vl_e_doc_cleunik&";
  s+="vf_e_critere_cleunik="+fa_gid("ml_criteres_particuliers").selectedItem.getAttribute("_graal_cleunik_critere")+"&";
  s+="vf_c_url="+fa_enc(fa_att_get("_win_fen_ged_criteres_01","_graal_lien"))+"&";
  s+="genrecritere=$vl_c_genrecritere&";
  switch (vv_quoi) {
  	case "metatags":
  		fa_ouvre(vf_c_script_metatags+s,400,400);
		break;
	case "proprietes":
  		fa_ouvre(vf_c_script_proprietes+s,400,400);
		break;
	}
}
function pf_raz_fiche() {}
function pf_sel_arbre_criteres() {
  var rowIndex = fa_cui("arb_criteres");if(rowIndex == -1){return;}
  var vl_e_choix_multiples;
  vf_e_critere_cleunik=fa_cell_get("arb_criteres",rowIndex,"critere_cleunik");  //  Clé unique critère
  vl_e_choix_multiples=fa_cell_get("arb_criteres",rowIndex,"critere_choixmultiples");  //  Si choix multiple ?
  vf_e_critere_codechoixpertinent=fa_cell_get("arb_criteres",rowIndex,"critere_codechoixpertinent");  //  Si code choix pertinent ?
  if (vl_e_choix_multiples==1) {fa_att_set("arb_choix_criteres",'seltype', 'multiple');} else {fa_att_set("arb_choix_criteres",'seltype', 'single');} 
  if (vf_e_critere_codechoixpertinent==2) {fa_cache_oui("choix_code");} else {fa_cache_non("choix_code");}
  pf_affiche_choix_criteres_potentiel_ged();
}
function pf_sel_arbre_choix() {
  var rowIndex = fa_cui("arb_choix_criteres");if(rowIndex == -1){return;}
  vf_e_choix_cleunik=fa_cell_get("arb_choix_criteres",rowIndex,"choix_cleunik");  //  Clé unique choix
}
function pf_sel_arbre_criteres_ged() {
  var rowIndex = fa_cui("criteres_des_geds");if(rowIndex == -1){return;}
  vf_e_critere_cleunik_ged=fa_cell_get("criteres_des_geds",rowIndex,"critere_cleunik_fixe");  //  Clé unique critère
  vf_e_choix_cleunik_ged=fa_cell_get("criteres_des_geds",rowIndex,"choix_cleunik_fixe");  //  Clé unique du choix de la relation
}
function pf_validation(vv_quoi) {
    var vl_c_donnees;
    vl_c_donnees="";
    switch(vv_quoi) {
      case "enregistrer":
        var vl_t_tableau=[];
        var vl_e_nb_sel;
        var vl_e_no;
        vl_t_tableau=fa_lignes_selectionnees("arb_choix_criteres");
        vl_e_nb_sel=vl_t_tableau.length;
        switch (vl_e_nb_sel) {
          case 0:
            return;
            break;
          case 1:
            vl_c_donnees+="vl_doc_cleunik="+fa_enc("$vl_e_doc_cleunik")+"&";
            vl_c_donnees+="vl_choix_cleunik="+fa_enc(vf_e_choix_cleunik)+"&";
            vl_c_donnees+="vl_critere_cleunik="+fa_enc(vf_e_critere_cleunik)+"&";
            vl_c_donnees+="vf_c_action=enregistrer&";
            break;          
          default:
            //  On initialise le tableau des geds avec une dimension inutile sinon cela plante quand on n'a qu'un seule dimension
            var vl_te_doc_cleunik=[];vl_te_doc_cleunik[0]=-1;vl_te_doc_cleunik[1]="$vl_e_doc_cleunik";
            var vl_te_choix_cleunik=[];
            var vl_te_critere_cleunik=[];
            for(i=0;i<vl_e_nb_sel;i++) {
              vl_te_critere_cleunik[i]=vf_e_critere_cleunik;
              vl_te_choix_cleunik[i]=fa_cell_get("arb_choix_criteres",vl_t_tableau[i],"choix_cleunik");
            }
            vl_c_donnees+="vl_te_doc_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_doc_cleunik))+"&";
            vl_c_donnees+="vl_te_choix_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_choix_cleunik))+"&";
            vl_c_donnees+="vl_te_critere_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_critere_cleunik))+"&";
            vl_c_donnees+="vf_c_action=enregistrer_kilometre&";
            break;
        }
        break;
      case "supprimer":
        var vl_t_tableau=[];
        var vl_e_nb_sel;
        var vl_e_no;
        vl_t_tableau=fa_lignes_selectionnees("criteres_des_geds");
        vl_e_nb_sel=vl_t_tableau.length;
        switch (vl_e_nb_sel) {
          case 0:
            return;
            break;
          case 1:
            Check = confirm("$vl_mess_00010");
            if(Check == false) return;
            vl_c_donnees+="vl_doc_cleunik="+fa_enc("$vl_e_doc_cleunik")+"&";
            vl_c_donnees+="vl_choix_cleunik="+fa_enc(vf_e_choix_cleunik_ged)+"&";
            vl_c_donnees+="vl_critere_cleunik="+fa_enc(vf_e_critere_cleunik_ged)+"&";
            vl_c_donnees+="vf_c_action=supprimer&";
            break;          
          default:
            var vl_b_rep=confirm("$vl_mess_00012("+vl_e_nb_sel+")");
            if(vl_b_rep == false) return;
            var vl_te_doc_cleunik=[];
            var vl_te_choix_cleunik=[];
            var vl_te_critere_cleunik=[];
            for(i=0;i<vl_e_nb_sel;i++) {
              vl_te_doc_cleunik[i]="$vl_e_doc_cleunik";
              vl_te_choix_cleunik[i]=fa_cell_get("criteres_des_geds",vl_t_tableau[i],"choix_cleunik_fixe");
              vl_te_critere_cleunik[i]=fa_cell_get("criteres_des_geds",vl_t_tableau[i],"critere_cleunik_fixe");
            }
            vl_c_donnees+="vl_te_doc_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_doc_cleunik))+"&";
            vl_c_donnees+="vl_te_choix_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_choix_cleunik))+"&";
            vl_c_donnees+="vl_te_critere_cleunik="+fa_enc(fa_jsarray2php_00(vl_te_critere_cleunik))+"&";
            vl_c_donnees+="vf_c_action=supprimer_kilometre&";
            break;
        }
        break;
    }
    fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
