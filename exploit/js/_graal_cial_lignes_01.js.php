<?php
$vl_c_bpj_171=fa_recup_dico_js("bpj_171");
$vl_c_bpj_172=fa_recup_dico_js("bpj_172");
$vl_c_bpj_176=fa_recup_dico_js("bpj_176");
$param_generaux_graal_177=intval(fa_recup_session('vs_param_generaux_graal_177','-15'));	//	Dépot par défaut
$param_generaux_graal_178=intval(fa_recup_session('vs_param_generaux_graal_178','-16'));	//	Emplacement par defaut
$param_generaux_graal_179=intval(fa_recup_session('vs_param_generaux_graal_179','2'));		//	Gestion de la saisie des dépôts et emplacements
switch ($vl_c_genreaction){
  case "offcli":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_045','3'));break;
  case "cdecli":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_046','3'));break;
  case "livcli":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_047','3'));break;
  case "faccli":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_048','3'));break;
  case "avocli":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_048','3'));break;
  case "avofin":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_048','3'));break;
  case "demfou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_049','3'));break;
  case "cdefou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_050','3'));break;
  case "recfou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_125','3'));break;
  case "facfou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_136','3'));break;
  case "retcli":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_103','3'));break;
  case "retfou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_114','3'));break;
  case "relfou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_183','3'));break;
  case "avofou":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_136','3'));break;
  case "avofif":$type_gestion_doc=intval(fa_recup_session('vs_param_generaux_graal_136','3'));break;
}
$pf_tarif_charge_fin=<<<EOT
function pf_tarif_charge_fin(){
	//alert("tarif fin");
	if (vf_pas_tarif_charge_fin==false) {
		fa_gid("ml_tarif_ligne").selectedIndex=0;
		var toto=fa_gid("ml_tarif_ligne").selectedItem.getAttribute("_graal_selection");
		fa_value_set("ml_tarif_ligne",toto);
		fa_value_set("tb_nbdec_pu",fa_mlget("ml_tarif_ligne","_graal_nb_dec"));
		fa_att_set('tb_pu',"decimalplaces",fa_value_get("tb_nbdec_pu"));
		fa_value_set('tb_pu',fa_mlget("ml_tarif_ligne","_graal_tarif"));
	} else {
		fa_gid("ml_tarif_ligne").selectedIndex=0;
		var toto=fa_gid("ml_tarif_ligne").selectedItem.getAttribute("_graal_selection");
		fa_value_set("ml_tarif_ligne",toto);
		fa_cache_oui("hb_tarif_ligne");
	}
	fa_grise_fenetre("","non")
}
EOT;
switch ($type_gestion_doc){
	case 1:
$pf_sel_article=<<<EOT
function pf_sel_article() {
  var vl_e_cleunik=fa_att_get('selart','_graal_cleunik');
  if (vl_e_cleunik==0){return;}
  fa_xmlhttprequest_xml(c_script_xml_art+vl_e_cleunik,"",pf_sel_article_fin);
}
EOT;
			break;
	case 2:
	case 3:
$pf_sel_article=<<<EOT
function pf_sel_article() {
  var vl_e_cleunik=fa_att_get('selart','_graal_cleunik');
  if (vl_e_cleunik==0){return;}
  fa_xmlhttprequest_xml(c_script_xml_art+vl_e_cleunik,"",pf_sel_article_fin);
  fa_xmlhttprequest_xml(c_script_xml_art_depot+vl_e_cleunik,"",pf_depot_maj_fin);
  fa_xmlhttprequest_xml(c_script_xml_art_empla+vl_e_cleunik,"",pf_empla_maj_fin);
}
EOT;
		break;
}
$vf_c_script_bdope_fen="_graal_bdope_cial_lignes_01.php?action_cleunik=$vl_c_action_cleunik&genreaction=$vl_c_genreaction&commercial_cleunik=$commercial_cleunik&act_cleunik=$act_cleunik&commercial_ligne_cleunik=$commercial_ligne_cleunik&";
$vf_c_script_bdope_fen_verif="_graal_bdope_cial_lignes_01.php?genreaction=verif_dispo_frla&commercial_cleunik=$commercial_cleunik&act_cleunik=$act_cleunik&commercial_ligne_cleunik=$commercial_ligne_cleunik&";
switch ($vl_c_genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
	case "avocli":
	case "avofin":
	case "retcli":
		$vl_e_pas_tarif=-31;
    $c_script_recherche_article="_graal_das_art_selection.php?actif=1&type_recherche=1&portee=2&";  //  Recherche des articles actifs gérés en vente
    break;
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retfou":
  case "relfou":
  case "avofou":
  case "avofif":
		$vl_e_pas_tarif=-33;
    $c_script_recherche_article="_graal_das_art_selection.php?actif=1&type_recherche=1&portee=1&";  //  Recherche des articles actifs gérés en achats
    break;
}
$vf_c_script_das_lignes_01="";$vf_c_script_das_lignes_02="";$vf_c_script_das_lignes_03="";$vf_c_script_das_lignes_04="";
switch ($vl_c_genreaction){
  case "offcli"   :
    $vf_c_script_das_lignes_01="_graal_das_art_lignes_cdecli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_cdecli_02.php?";
    $vf_c_script_das_lignes_03="_graal_das_art_lignes_offcli_01.php?";$vf_c_script_das_lignes_04="_graal_das_art_lignes_offcli_02.php?";
    break;
  case "demfou"   :$vf_c_script_das_lignes_01="_graal_das_art_lignes_demfou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_demfou_02.php?";break;
  case "cdecli"   :
    $vf_c_script_das_lignes_01="_graal_das_art_lignes_cdecli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_cdecli_02.php?";
    $vf_c_script_das_lignes_03="_graal_das_art_lignes_offcli_01.php?";$vf_c_script_das_lignes_04="_graal_das_art_lignes_offcli_02.php?";
    break;
  case "cdefou"   :
  case "relfou":
  	$vf_c_script_das_lignes_01="_graal_das_art_lignes_cdefou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_cdefou_02.php?";break;
  case "livcli"   :
    $vf_c_script_das_lignes_01="_graal_das_art_lignes_livcli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_livcli_02.php?";
    $vf_c_script_das_lignes_03="_graal_das_art_lignes_cdecli_01.php?";$vf_c_script_das_lignes_04="_graal_das_art_lignes_cdecli_02.php?";
    break;
  case "retcli"   :
    $vf_c_script_das_lignes_01="_graal_das_art_lignes_livcli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_livcli_02.php?";
    $vf_c_script_das_lignes_03="_graal_das_art_lignes_retcli_01.php?";$vf_c_script_das_lignes_04="_graal_das_art_lignes_retcli_02.php?";
    break;
  case "recfou"   :$vf_c_script_das_lignes_01="_graal_das_art_lignes_recfou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_recfou_02.php?";break;
  case "retfou"   :
  	$vf_c_script_das_lignes_01="_graal_das_art_lignes_recfou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_recfou_02.php?";
  	$vf_c_script_das_lignes_03="_graal_das_art_lignes_retfou_01.php?";$vf_c_script_das_lignes_04="_graal_das_art_lignes_retfou_02.php?";
  	break;
  case "faccli"   :$vf_c_script_das_lignes_01="_graal_das_art_lignes_faccli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_faccli_02.php?";break;
	case "avocli"		:$vf_c_script_das_lignes_01="_graal_das_art_lignes_avocli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_avocli_02.php?";break;
	case "avofin"		:$vf_c_script_das_lignes_01="_graal_das_art_lignes_avocli_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_avocli_02.php?";break;
  case "facfou"   :$vf_c_script_das_lignes_01="_graal_das_art_lignes_facfou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_facfou_02.php?";break;
  
  case "avofou"		:$vf_c_script_das_lignes_01="_graal_das_art_lignes_avofou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_avofou_02.php?";break;
	case "avofif"		:$vf_c_script_das_lignes_01="_graal_das_art_lignes_avofou_01.php?";$vf_c_script_das_lignes_02="_graal_das_art_lignes_avofou_02.php?";break;
}
if ($commercial_ligne_cleunik==0) {
switch ($vl_c_specificite) {
	case "livcli_partielle":
	case "recfou_partielle":
	switch ($commercial_ligne_cleunik_partielle) {
		case 0:	//	nouvelle ligne
$vl_c_champ_focus="tb_qte";
$vl_c_init=<<<EOT
  pf_charge_tarif();
  pf_affiche_donnees_tarifs();
  pf_affiche_donnees_histo_01();
  pf_affiche_donnees_histo_02();
  pf_affiche_donnees_histo_03();
  pf_affiche_donnees_histo_04();
  
  vf_nombre_quantite=$vl_e_nombre_quantites;
  alert(vf_nombre_quantite)
  if (vf_nombre_quantite!=0){
  	
  	//	nouvelle ligne
  	fa_att_set('tb_qte',"onchange",'pf_change_tarif();');
  	vf_c_script_quantite=atob("$script_quantite");
  	fa_gid("tab_infogene").selectedIndex=0;
  	fa_cache_non("tob_acces_pu");
  }	else {
  	vf_c_script_quantite="";
  	fa_cache_non("hb_tarif_ligne");
  	fa_gid("tab_infogene").selectedIndex=1;
  }
      fa_grise_groupe_non('broadcaster_01');
      fa_grise_groupe_non('broadcaster_02');
      fa_focusdonne("$vl_c_champ_focus");
EOT;
if ($statut_lignebloque==true) {
  $vl_c_init.="pf_etat_fen('bloque');";
}
$vl_c_validation=<<<EOT
  vl_c_donnees+="&vf_c_action=$vl_c_specificite&ligne_qte_cleunik_partielle=$ligne_qte_cleunik_partielle&commercial_ligne_cleunik_partielle=$commercial_ligne_cleunik_partielle&"+s;
  vf_c_action="ajouter_partiel";
  fa_xmlhttprequest_txt("$vf_c_script_bdope_fen",vl_c_donnees,pf_fin_requete);
EOT;
$vl_c_change_tarif=<<<EOT
if (vf_c_script_quantite!=""){
	if (vf_b_pu_manuel==false) {
		eval(vf_c_script_quantite);
	}
} else {  
	if(confirm("$vl_c_bpj_176") == false) return;
  fa_att_set("ml_tarif_ligne","class",fa_mlget("ml_tarif_ligne",'class'));
  fa_value_set("tb_nbdec_pu",fa_mlget("ml_tarif_ligne","_graal_nb_dec"));
  if (fa_mlget("ml_tarif_ligne","_graal_cleunik")==$vl_e_pas_tarif) {
    fa_grise_non("tb_pu");
    fa_focusdonne("tb_pu");
  } else {
    fa_value_set('tb_pu',fa_mlget("ml_tarif_ligne","_graal_tarif"));
    fa_grise_oui("tb_pu");
  } 
}
EOT;
	break;
		default:
$vl_c_champ_focus="tb_qte";
$vl_c_init=<<<EOT
  pf_charge_tarif();
  pf_affiche_donnees_tarifs();
  pf_affiche_donnees_histo_01();
  pf_affiche_donnees_histo_02();
  pf_affiche_donnees_histo_03();
  pf_affiche_donnees_histo_04();
  vf_nombre_quantite=$vl_e_nombre_quantites;
  //vf_nombre_quantite=0;
  if (vf_nombre_quantite!=0){
  	
  	//	nouvelle ligne
  	fa_att_set('tb_qte',"onchange",'pf_change_tarif();');
  	vf_c_script_quantite=atob("$script_quantite");
  	fa_gid("tab_infogene").selectedIndex=0;
  	fa_cache_non("tob_acces_pu");
  }	else {
  	vf_c_script_quantite="";
	vf_pas_tarif_charge_fin=true;
  	fa_cache_non("hb_tarif_ligne");
  	fa_cache_non("tob_acces_pu");
  	//fa_cache_oui("ml_tarif_ligne");
  	fa_gid("tab_infogene").selectedIndex=1;
  }
      fa_grise_groupe_non('broadcaster_01');
      fa_grise_groupe_non('broadcaster_02');
      fa_focusdonne("$vl_c_champ_focus");
EOT;
if ($statut_lignebloque==true) {
  $vl_c_init.="pf_etat_fen('bloque');";
}
$vl_c_validation=<<<EOT
  vl_c_donnees+="&vf_c_action=$vl_c_specificite&ligne_qte_cleunik_partielle=$ligne_qte_cleunik_partielle&commercial_ligne_cleunik_partielle=$commercial_ligne_cleunik_partielle&"+s;
  vf_c_action="ajouter_partiel";
  fa_xmlhttprequest_txt("$vf_c_script_bdope_fen",vl_c_donnees,pf_fin_requete);
EOT;
$vl_c_change_tarif=<<<EOT
if (vf_c_script_quantite!=""){
	if (vf_b_pu_manuel==false) {
		eval(vf_c_script_quantite);
	}
} else {  
	if(confirm("$vl_c_bpj_176") == false) return;
  fa_att_set("ml_tarif_ligne","class",fa_mlget("ml_tarif_ligne",'class'));
  fa_value_set("tb_nbdec_pu",fa_mlget("ml_tarif_ligne","_graal_nb_dec"));
  if (fa_mlget("ml_tarif_ligne","_graal_cleunik")==$vl_e_pas_tarif) {
    fa_grise_non("tb_pu");
    fa_focusdonne("tb_pu");
  } else {
    fa_value_set('tb_pu',fa_mlget("ml_tarif_ligne","_graal_tarif"));
    fa_grise_oui("tb_pu");
  } 
}
EOT;
	break;
	}
		
		
		break;
	default:	//	ajout d'une ligne "normale"
		
		$vl_c_champ_focus="selart";
$vl_c_init=<<<EOT
  pf_param_choix_selart();
  pf_affiche_donnees_histo_02();
  pf_affiche_donnees_histo_04();
  fa_gid("tab_infogene").selectedIndex=2;
EOT;
$vl_c_validation=<<<EOT
  if (fa_att_get("tb_art_code","_graal_cleunik")=='') {alert("$vl_c_bpj_172");return;}
  vl_c_donnees="&vf_c_action=ajouter&"+s;
  vf_c_action="ajouter";
  fa_xmlhttprequest_txt("$vf_c_script_bdope_fen",vl_c_donnees,pf_fin_requete);
EOT;
$vl_c_change_tarif=<<<EOT
if (vf_c_script_quantite!=""){
	if (vf_b_pu_manuel==false) {
		eval(vf_c_script_quantite);
	}
} else {
	fa_att_set("ml_tarif_ligne","class",fa_mlget("ml_tarif_ligne",'class'));
	  fa_value_set("tb_nbdec_pu",fa_mlget("ml_tarif_ligne","_graal_nb_dec"));
	  if (fa_mlget("ml_tarif_ligne","_graal_cleunik")==$vl_e_pas_tarif) {
	    fa_grise_non("tb_pu");
	    fa_focusdonne("tb_pu");
	  } else {
	    fa_value_set('tb_pu',fa_mlget("ml_tarif_ligne","_graal_tarif"));
	    
	    fa_grise_oui("tb_pu");
	  } 
}	  
EOT;
		
}
	
	
  
} else {
EOT;
  $vl_c_champ_focus="tb_qte";
$vl_c_init=<<<EOT
  
  pf_affiche_donnees_tarifs();
  pf_affiche_donnees_histo_01();
  pf_affiche_donnees_histo_02();
  pf_affiche_donnees_histo_03();
  pf_affiche_donnees_histo_04();
  vf_nombre_quantite=$vl_e_nombre_quantites;
  if (vf_nombre_quantite!=0){
  //	modification de ligne existante
	  	switch ("$vl_c_genreaction") {
		  case "offcli":
		  case "cdecli":
		  case "demfou":
		  case "cdefou":
		  	fa_att_set('tb_qte',"onchange",'pf_change_tarif();');
  			vf_c_script_quantite=atob("$script_quantite");
  			//alert(vf_c_script_quantite)
  			fa_gid("tab_infogene").selectedIndex=0;
  			fa_cache_non("tob_acces_pu");
  			break;
		  default:
		  	vf_c_script_quantite="";
  			fa_cache_non("hb_tarif_ligne");
  			fa_cache_non("tob_acces_pu");
  			fa_cache_oui("hb_tarif_ligne");
  			fa_gid("tab_infogene").selectedIndex=1;
  			break;
		}
  }	else {
    pf_charge_tarif();
  	vf_c_script_quantite="";
  	fa_cache_non("hb_tarif_ligne");
  	fa_gid("tab_infogene").selectedIndex=1;
  }
EOT;
if ($statut_lignebloque==true) {
  $vl_c_init.="pf_etat_fen('bloque');";
}
$vl_c_validation=<<<EOT
  vl_c_donnees+="&vf_c_action=modifier&"+s;
  vf_c_action="modifier";
  fa_xmlhttprequest_txt("$vf_c_script_bdope_fen",vl_c_donnees,pf_fin_requete);
EOT;
$vl_c_change_tarif=<<<EOT
if (vf_c_script_quantite!=""){
	if (vf_b_pu_manuel==false) {
		eval(vf_c_script_quantite);
	}
} else {  
	if(confirm("$vl_c_bpj_176") == false) return;
  fa_att_set("ml_tarif_ligne","class",fa_mlget("ml_tarif_ligne",'class'));
  fa_value_set("tb_nbdec_pu",fa_mlget("ml_tarif_ligne","_graal_nb_dec"));
  if (fa_mlget("ml_tarif_ligne","_graal_cleunik")==$vl_e_pas_tarif) {
    fa_grise_non("tb_pu");
    fa_focusdonne("tb_pu");
  } else {
    fa_value_set('tb_pu',fa_mlget("ml_tarif_ligne","_graal_tarif"));
    
    fa_grise_oui("tb_pu");
  } 
}
EOT;

}
$vl_c_fin_requete="if (window.opener!=null) {try {window.opener.pf_cial_affiche_lignes();window.opener.pf_cial_affiche_montants();window.opener.pf_cial_entete();} catch(e){}}";
echo <<<END
<script type="application/x-javascript"><![CDATA[
const c_script_xml_art="_graal_xml_articles_03.php?genreaction=$vl_c_genreaction&commercial_cleunik=$commercial_cleunik&vl_e_act_cleunik=$act_cleunik&vl_e_tarif_cleunik=$vl_c_tarif_cleunik&vl_e_type_tarifs=$vl_c_type_tarifs&vl_e_art_cleunik=";
const vf_c_script_das_tarifs="_graal_das_art_tarifs_01.php?actif=3&vl_e_type_tarifs=$vl_c_type_tarifs&vl_art_cleunik=";
//const vf_c_script_das_tarifs_quantite="_graal_das_art_tarifs_02.php?actif=3&vl_e_type_tarifs=$vl_c_type_tarifs&vl_art_cleunik=";
const c_script_recherche_article="?????????_graal_das_art_selection.php?actif=1&type_recherche=2&";  //  Recherche des articles actifs gérés en ventes, en achats
const c_script_conv_conditionnement="_graal_xml_univente_par_con_01.php?";
const c_script_xml_art_depot="_graal_xml_art_depot.php?vl_e_art_cleunik=";
const c_script_xml_art_empla="_graal_xml_art_empla.php?vl_e_art_cleunik=";
var vf_c_action,vf_c_url_alimente_table;
var vf_c_script_quantite="";
var vf_nombre_quantite=0;
var vf_b_pu_manuel=false;
var vf_pas_tarif_charge_fin=false;
const lstn_tarifs= { 
	willRebuild : function(event){fa_grise_fenetre("","oui");},
	didRebuild  : function(event){pf_tarif_charge_fin();} 
};
$pf_tarif_charge_fin
function pf_aa_init() {
  fa_sep("tb_ligne_cleunik");
  fa_sep("tb_pu");
  fa_sep("tb_nbdec_pu");
  fa_sep("tb_remise_taux");
  fa_sep("tb_qte");
  fa_sep("tb_qte_condi");
  fa_value_set("tb_qte","$qte");
  fa_att_set("tb_qte","qte_avant","$qte");
  fa_value_set("tb_qte_condi","$qte_condi");
  fa_grise_groupe_oui('broadcaster_01');
  fa_grise_groupe_oui('broadcaster_02');
  fa_focusdonne("$vl_c_champ_focus");
  fa_value_set("dp_date_demande","$date_demande");
  fa_badl("ml_tarif_ligne",lstn_tarifs);
  $vl_c_init
}
function pf_affiche_donnees_histo_01() {
	if ("$vf_c_script_das_lignes_01"!=""){
  		var vl_c_param="$vf_c_script_das_lignes_01"+"vl_act_cleunik=$act_cleunik&vl_c_dateheuredebut=19610123&vl_c_dateheurefin=20610123&statut=-1&limit=150&vl_art_cleunik="+fa_att_get('tb_art_code',"_graal_cleunik")+"&raf_random="+Math.random()+"&vl_commercial_cleunik=$commercial_cleunik&";
  		fa_das("tr_histo_cial_01",vl_c_param);
  	}
}
function pf_affiche_donnees_histo_02() {
	if ("$vf_c_script_das_lignes_02"!=""){
		var vl_c_param="$vf_c_script_das_lignes_02"+"vl_act_cleunik=$act_cleunik&vl_c_dateheuredebut=19610123&vl_c_dateheurefin=20610123&statut=-1&limit=150&raf_random="+Math.random()+"&";
  		fa_das("tr_histo_cial_02",vl_c_param);
  	}
}
function pf_affiche_donnees_histo_03() {
	if ("$vf_c_script_das_lignes_03"!=""){
		var vl_c_param="$vf_c_script_das_lignes_03"+"vl_act_cleunik=$act_cleunik&vl_c_dateheuredebut=19610123&vl_c_dateheurefin=20610123&statut=-1&limit=150&vl_art_cleunik="+fa_att_get('tb_art_code',"_graal_cleunik")+"&raf_random="+Math.random()+"&";
  		fa_das("tr_histo_cial_03",vl_c_param);
  	}
}
function pf_affiche_donnees_histo_04() {
	if ("$vf_c_script_das_lignes_04"!=""){
		var vl_c_param="$vf_c_script_das_lignes_04"+"vl_act_cleunik=$act_cleunik&vl_c_dateheuredebut=19610123&vl_c_dateheurefin=20610123&statut=-1&limit=150&raf_random="+Math.random()+"&";
  		fa_das("tr_histo_cial_04",vl_c_param);
  	}
}
function pf_affiche_donnees_tarifs() {
  var vl_c_param=vf_c_script_das_tarifs+fa_att_get("tb_art_code","_graal_cleunik")+"&raf_random="+Math.random()+"&vl_e_tarif_cleunik=-20&";
  fa_das("arbre_tarif",vl_c_param);
}
function pf_alimente_detail(stream){
var vl_c_datas = stream;
  fa_mlsel("ml_commission_typ",fa_xml_get(vl_c_datas,'commission_typ'),"value");
  fa_mlsel("ml_commission_regle",fa_xml_get(vl_c_datas,'commission_regle'),"value");
  fa_value_set("tb_taux",fa_xml_get(vl_c_datas,'commission_taux'));
  fa_value_set("tb_montant",fa_xml_get(vl_c_datas,'commission_fixe'));
}
function pf_change_tarif() {
  $vl_c_change_tarif
}
function pf_charge_tarif(){
	if (vf_nombre_quantite==0){
		//alert("tarif 01");
		var ds="_graal_das_tarifs_articles_01.php?vl_e_pas_tarif=$vl_e_pas_tarif&vl_e_act_cleunik=$act_cleunik&vl_e_critere_cleunik=$vl_e_critere_tarif_cleunik&";
		ds+="vl_e_type_tarifs=$vl_c_type_tarifs&vl_e_nouvelleligne=$commercial_ligne_cleunik&vl_e_art_cleunik="+fa_att_get("tb_art_code",'_graal_cleunik')
		ds+="&vl_c_nom_ml=ml_tarif_ligne&vl_e_tarif_cleunik=$vl_c_tarif_cleunik&raf="+Math.random()+"&ligne_qte="+fa_value_get("tb_qte")+"&";
		ds+="vl_pu="+fa_value_get("tb_pu")+"&";
		ds+="nbdec_pu="+fa_value_get("tb_nbdec_pu")+"&";
		fa_das("ml_tarif_ligne",ds);
	}
}
function pf_conv_condi_vers_vente(){
  fa_xmlhttprequest_xml(c_script_conv_conditionnement+"con_choix_cleunik="+fa_mlget("ml_unite_condi")+"&univente_choix_cleunik="+fa_mlget("ml_unite_vente")+"&","",pf_conv_condi_vers_vente_fin);
}
function pf_conv_condi_vers_vente_fin(stream) {
  var vl_c_datas=stream;
  var qte=fa_xml_get(vl_c_datas,"qte");
  fa_att_set("tb_qte_condi","_graal_nb_stock_in_condi");
  var qte_condi=fa_value_get("tb_qte_condi");
  fa_value_set("tb_qte",qte*qte_condi);
}
function pf_conv_vente_vers_condi(){
  fa_xmlhttprequest_xml(c_script_conv_conditionnement+"con_choix_cleunik="+fa_mlget("ml_unite_condi")+"&univente_choix_cleunik="+fa_mlget("ml_unite_vente")+"&","",pf_conv_vente_vers_condi_fin);
}
function pf_conv_vente_vers_condi_fin(stream) {
  var vl_c_datas=stream;
  var qte=fa_xml_get(vl_c_datas,"qte");
  fa_att_set("tb_qte_condi","_graal_nb_stock_in_condi");
  var qte_vente=fa_value_get("tb_qte");
  fa_value_set("tb_qte_condi",qte_vente/qte);
}
function pf_dblclick_arbre_histo_cial(vv_arbre){
	switch (vv_arbre){
		case "tr_histo_cial_01":
			var rowIndex =fa_cui('tr_histo_cial_01');if(rowIndex == -1){return;}
			var vl_e_art_cleunik=fa_cell_get("tr_histo_cial_01",rowIndex,"tc_art_cleunik_01");
			fa_att_set('selart','_graal_cleunik',vl_e_art_cleunik);
			pf_sel_article();
			break;
		case "tr_histo_cial_02":
			var rowIndex =fa_cui('tr_histo_cial_02');if(rowIndex == -1){return;}
			var vl_e_art_cleunik=fa_cell_get("tr_histo_cial_02",rowIndex,"tc_art_cleunik_02");
			fa_att_set('selart','_graal_cleunik',vl_e_art_cleunik);
			pf_sel_article();
			break;
		case "tr_histo_cial_03":
			var rowIndex =fa_cui('tr_histo_cial_03');if(rowIndex == -1){return;}
			var vl_e_art_cleunik=fa_cell_get("tr_histo_cial_03",rowIndex,"tc_art_cleunik_03");
			fa_att_set('selart','_graal_cleunik',vl_e_art_cleunik);
			pf_sel_article();
			break;
		case "tr_histo_cial_04":
			var rowIndex =fa_cui('tr_histo_cial_04');if(rowIndex == -1){return;}
			var vl_e_art_cleunik=fa_cell_get("tr_histo_cial_04",rowIndex,"tc_art_cleunik_04");
			fa_att_set('selart','_graal_cleunik',vl_e_art_cleunik);
			pf_sel_article();
			break;
	}
}
function pf_depot_maj_fin(stream) {
  var vl_c_datas = stream;
  var vl_nb=fa_xml_get(vl_c_datas,'nombre');
  var vl_sel=0;
  //alert($param_generaux_graal_177);
  for (i=0; i<vl_nb; i++){
    var vl_c_label=fa_xml_get(vl_c_datas,'nom_'+i);
    var vl_cleunik=fa_xml_get(vl_c_datas,'cleunik_'+i);
    var mi = document.createElementNS(onlyxul,'menuitem');
    mi.setAttribute('label', vl_c_label);
    mi.setAttribute('value', vl_c_label);
    mi.setAttribute('_graal_cleunik',vl_cleunik);
    if (vl_cleunik==$param_generaux_graal_177){
    	vl_sel=i;
    }
    fa_gid("mp_depot").appendChild(mi);
  }
  fa_gid("ml_depot").selectedIndex=vl_sel;
}
function pf_empla_maj_fin(stream) {
  var vl_c_datas = stream;
  var vl_sel=0;
  var vl_nb=fa_xml_get(vl_c_datas,'nombre');
  for (i=0; i<vl_nb; i++){
    var vl_c_label=fa_xml_get(vl_c_datas,'nom_'+i);
    var vl_cleunik=fa_xml_get(vl_c_datas,'cleunik_'+i);
    var mi = document.createElementNS(onlyxul,'menuitem');
    mi.setAttribute('label', vl_c_label);
    mi.setAttribute('value', vl_c_label);
    mi.setAttribute('_graal_cleunik',vl_cleunik);
    if (vl_cleunik==$param_generaux_graal_178){
    	vl_sel=i;
    }
    fa_gid("mp_empla").appendChild(mi);
  }
  fa_gid("ml_empla").selectedIndex=vl_sel;
}
function pf_etat_fen(vv_quoi) {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "annuler":
      window.location=document.location;
      break;
    case "modifier":
      fa_grise_non("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_groupe_non('broadcaster_01');
      fa_grise_groupe_non('broadcaster_02');
      fa_focusdonne("$vl_c_champ_focus");
      break;
    case "bloque":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_supprimer");
      break;
    case "debloque":
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_ligne_soldee");
      break;
    case "sortir":
      window.close();
      break;
  }
}
function pf_fin_requete(stream){
	//alert(stream)
	//return;
	fa_grise_fenetre("","oui");
  var vl_datas = stream;
  if (vl_datas=="-1") {
    alert("Problème d'enregistrement de la ligne. Informations comptables manquantes sur l'article ?");
    }
  else{
  }
  $vl_c_fin_requete
  switch (vf_c_action) {
    case "supprimer":
    case "ajouter_partiel":
      pf_etat_fen("sortir");
      break;
    default:
      pf_etat_fen("annuler");
      break;
  }
}
function pf_modifie_pu(){
	if (vf_b_pu_manuel==false){
		fa_grise_non("tb_pu");
		fa_grise_non("tb_nbdec_pu");
		vf_b_pu_manuel=true;
	} else {
		fa_grise_oui("tb_pu");
		vf_b_pu_manuel=false;
		fa_grise_oui("tb_nbdec_pu");
	}
}
function pf_ouvre(vv_quoi_01,vv_quoi_02) {
  switch (vv_quoi_01) {
    case "article":
      var vl_art_cleunik=fa_att_get("tb_art_code","_graal_cleunik");
			fa_ouvre_article('genre=tousss&vl_e_art_cleunik='+vl_art_cleunik+"&","");
      break;
  }
}
function pf_param_choix_selart() {
  fa_att_set("selart","autosuggestsearch","$c_script_recherche_article"+"zone="+fa_value_get("selart_ml_zone")+"&");
}
$pf_sel_article
function pf_sel_article_fin(stream) {

  var vl_c_datas=stream;
  fa_value_set('tb_art_description',fa_xml_get(vl_c_datas,'description'));
  fa_value_set('tb_art_code',fa_xml_get(vl_c_datas,'code'));
  vf_nombre_quantite=fa_xml_get(vl_c_datas,'nombre_quantites');
  fa_att_set('ml_tarif_ligne',"_graal_nombre_quantite",vf_nombre_quantite);
  if (vf_nombre_quantite!=0){
  	fa_att_set('tb_qte',"onchange",'pf_change_tarif();');
  	vf_c_script_quantite=atob(fa_xml_get(vl_c_datas,'script_quantite'));
  	fa_gid("tab_infogene").selectedIndex=0;
  	fa_cache_non("tob_acces_pu");
  }	else {
  	vf_c_script_quantite="";
  	fa_cache_non("hb_tarif_ligne");
  	fa_gid("tab_infogene").selectedIndex=1;
  }
	fa_value_set('tb_art_code_acteur',fa_xml_get(vl_c_datas,'art_code_acteur'));
  fa_value_set('tb_art_description_acteur',fa_xml_get(vl_c_datas,'art_description_acteur'));
	fa_value_set('tb_blocnotebrut_ligne',fa_xml_get(vl_c_datas,'descriptif_brut'));
	fa_att_set('tb_art_code',"_graal_cleunik",fa_xml_get(vl_c_datas,'art_cleunik'));
	//alert(fa_xml_get(vl_c_datas,'nbdec_qte'));
	fa_att_set('tb_qte',"decimalplaces",fa_xml_get(vl_c_datas,'nbdec_qte'));
  fa_mlsel('ml_unite_vente',fa_xml_get(vl_c_datas,'unite_vente'));
  fa_mlsel('ml_unite_condi',fa_xml_get(vl_c_datas,'unite_condi'));
  pf_affiche_donnees_tarifs();
  pf_affiche_donnees_histo_01();
  fa_value_set('tb_pu',fa_xml_get(vl_c_datas,'pu'));
  fa_value_set('tb_nbdec_pu',fa_xml_get(vl_c_datas,'nbdec_pu'));
  pf_charge_tarif();
  fa_grise_groupe_non('broadcaster_01');
  fa_grise_groupe_non('broadcaster_02');
  fa_cache_oui("hb_selart");
  fa_focusdonne("tb_qte");
  
  if (fa_xml_get(vl_c_datas,'gestion_depo_empla')==1) {
  	if ($param_generaux_graal_179==2){
    		fa_cache_oui("gp_depo_empla");
    	} else {
    		fa_cache_non("gp_depo_empla");
    	}
    
  }
  var vl_catcompta_cleunik=fa_xml_get(vl_c_datas,'catcompta_cleunik');
  if (fa_se(vl_catcompta_cleunik)=="") {
    alert("Les informations comptables de cet article sont incomplètes !!!\\nElles ne sont peut-être pas en adéquation\\navec la catégorie fiscale de l'acteur.");
  } else {
    fa_cache_non("bt_ajouter");
  }
}
function pf_sortir() {
  $vl_c_fin_requete
 	window.close();
}
function pf_validation(vv_quoi){
  var s="";
  var vl_c_donnees="";
  s+="&ligne_cleunik="+fa_value_get("tb_ligne_cleunik");
  s+="&art_cleunik="+fa_att_get('tb_art_code',"_graal_cleunik");
  s+="&pu="+fa_value_get('tb_pu');
  s+="&pu_type="+fa_mlget("ml_pu_type","value");
  s+="&nbdec_pu="+fa_value_get("tb_nbdec_pu");
  if (vf_nombre_quantite==0) {
  	var tarif_cleunik=fa_mlget("ml_tarif_ligne");
  	if (tarif_cleunik.charAt(0)=="*"){
  		tarif_cleunik=tarif_cleunik.substring(1,25);
  	}
  	//alert(tarif_cleunik);
  	s+="&tarif_cleunik="+tarif_cleunik;
  } else {
  	s+="&tarif_cleunik=-31";
  }
  s+="&remise_taux="+fa_value_get("tb_remise_taux");
  s+="&remise_type="+fa_mlget("ml_remise_type","value");
  s+="&remise_genr="+fa_mlget("ml_remise_genr","value");
  s+="&blocnotebrut="+fa_enc(fa_value_get("tb_blocnotebrut_ligne"));
  s+="&devise="+fa_mlget("ml_devise");
  s+="&remise_natu="+fa_mlget("ml_remise_natu","value");
  s+="&coef_facture="+fa_mlget("ml_coef_facture","value");
  s+="&typeligne="+fa_att_get('tb_ligne_cleunik',"_graal_typeligne");

  s+="&qte="+fa_value_get("tb_qte");
  s+="&qte_avant="+fa_att_get("tb_qte","qte_avant");
  s+="&ligne_qte_doc_origine="+fa_att_get("tb_qte","ligne_qte_doc_origine");
  s+="&qte_unite="+fa_mlget("ml_unite_vente");
  s+="&qte_nbdec="+fa_att_get("tb_qte","decimalplaces");
  s+="&dateheure_demande="+fa_value_get("dp_date_demande")+" "+fa_value_get("tb_heur_demande")
  s+="&statut="+fa_mlget("ml_statut");
  s+="&unite_condi="+fa_mlget("ml_unite_condi");
  s+="&qte_condi="+fa_value_get("tb_qte_condi");
  s+="&nb_stock_in_condi="+fa_att_get("tb_qte_condi","_graal_nb_stock_in_condi");
  s+="&choix_depot="+fa_mlget("ml_depot");
  s+="&choix_empla="+fa_mlget("ml_empla");
  s+="&code="+fa_enc(fa_value_get('tb_code'));
  s+="&ligne_qte_cleunik="+fa_att_get("tb_qte","_graal_cleunik");
  s+="&mvt_cleunik="+fa_att_get("tb_qte","_graal_mvt_cleunik");
  s+="&code_acteur="+fa_enc(fa_value_get('tb_art_code_acteur'));
  s+="&description_acteur="+fa_enc(fa_value_get('tb_art_description_acteur'));
	s+="&type_gestion_doc=$type_gestion_doc";
  //alert(fa_att_get("tb_qte","_graal_mvt_cleunik"))
  //return;
	switch (vv_quoi) {
    case "enregistrer":
			fa_grise_fenetre("","oui");
      $vl_c_validation
      break;
    case "supprimer":
      if(confirm("$vl_c_bpj_171") == false) return;
			fa_grise_fenetre("","oui");
      s="";
      s+="&ligne_qte_cleunik="+fa_att_get("tb_qte","_graal_cleunik");
      s+="&mvt_cleunik="+fa_att_get("tb_qte","_graal_mvt_cleunik");
      s+="&vf_c_action=supprimer&";
      s+="&qte="+fa_value_get("tb_qte");
      s+="&ligne_qte_doc_origine="+fa_att_get("tb_qte","ligne_qte_doc_origine");
      vf_c_action="supprimer";
      fa_xmlhttprequest_txt("$vf_c_script_bdope_fen",s,pf_fin_requete);
      break;
  }
}
]]></script>
END;
?>
