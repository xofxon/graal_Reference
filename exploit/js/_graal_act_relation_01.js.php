<?php
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_relations_01.php";
const vf_c_script_recherche="_graal_rech_acteurs_01.php?";
const vf_c_script_relations='_graal_das_acteurs_relations_01.php?'
var vf_c_action,vf_c_url_alimente_table;
var vf_e_act_cleunik_droite;
function pf_aa_init() {
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  fa_att_set("arbre_relations",'seltype', 'multiple');
  fa_focusdonne("bbm_tb_rechapproxima");
  pf_affiche_donnees_relations()
  pf_approximatif();
}
function pf_affiche_donnees_relations() {
  var vl_c_param;
  vl_c_param=vf_c_script_relations;
  vl_c_param+="vl_e_act_cleunik=$vl_e_act_cleunik_gauche&";
  vl_c_param+="raf_random="+Math.random()+"&vf_c_genre=A&'";
  fa_das("arbre_relations",vl_c_param);
}
function pf_alimente_table() {
  fa_das("arbre_acteurs",vf_c_url_alimente_table);
}
function pf_approximatif(){
  var vl_c_texte=fa_value_get("bbm_tb_rechapproxima");
  if ( vl_c_texte == "" ) {return;}
  vf_c_url_alimente_table =  vf_c_script_recherche+'sortie=das&vl_c_recherche='+fa_enc(fa_value_get("bbm_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bbm_ml_zone")+'&vl_c_type='+fa_value_get("bbm_ml_type")+'&vl_c_qui='+fa_value_get("bbm_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bao_ml_actif")+'&vl_e_panier='+fa_mlget("bao_ml_actif")+"&";
  pf_alimente_table();
  
}
function pf_etat_fen(vv_quoi) {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "sortir":
      window.close();
      break;
  }
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=="-1") {alert(vl_datas);}
  pf_affiche_donnees_relations();
  if (window.opener!=null) {try {window.opener.pf_affiche_donnees_relations();} catch(e){}}
}
function pf_raz_fiche() {
  fa_value_set("tb_blocnotebrut",'');
}
function pf_sel_arbre_acteurs(){
  var i=fa_cui("arbre_acteurs");if(i==-1){return;}
  vf_e_act_cleunik_droite=fa_cell_get("arbre_acteurs",i,"act_cleunik");  //  Clé unique acteur
  fa_att_set("tb_qui_droite","_graal_act_cleunik",vf_e_act_cleunik_droite);
  fa_value_set("tb_qui_droite",fa_cell_get("arbre_acteurs",i,"qui")+' ('+fa_cell_get("arbre_acteurs",i,"raisonsoc")+')');
}
function pf_sel_arbre_relations() {} 
function pf_validation(vv_quoi){
  var vl_c_donnees;
  switch (vv_quoi) {
    case "enregistrer":
      if (fa_gid("tb_qui_droite").getAttribute("_graal_act_cleunik")=='0') {alert("Sélectionnez un acteur !!");return;}
      vl_c_donnees="";
      vl_c_donnees+="vl_act_cleunik_gauche=$vl_e_act_cleunik_gauche&";
      vl_c_donnees+="vl_act_cleunik_droite="+fa_enc(fa_gid("tb_qui_droite").getAttribute("_graal_act_cleunik"))+"&";
      vl_c_donnees+="vl_choix_cleunik_gauche="+fa_enc(fa_mlget("ml_rel_gauche"))+"&";
      vl_c_donnees+="vl_choix_cleunik_droite="+fa_enc(fa_mlget("ml_rel_droite"))+"&";
      vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_gid("tb_blocnotebrut").value)+"&";
      vl_c_donnees+="vf_c_action=ajouter&";
      //alert(vl_c_donnees)
      fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
      break;
    case "supprimer":
      var vl_t_tableau=[];
      var vl_e_nb_sel;
      vl_t_tableau=fa_lignes_selectionnees("arbre_relations");
      vl_e_nb_sel=vl_t_tableau.length;
      if (vl_e_nb_sel!=0) {
      var vl_b_rep=confirm("Confirmez-vous la suppression des relations sélectionnées ("+vl_e_nb_sel+")");
      if(vl_b_rep == false) return;
        var vl_t_act_droite=[];
        var vl_t_act_gauche=[];
        var vl_t_cho_droite=[];
        var vl_t_cho_gauche=[];
        for(i=0;i<vl_e_nb_sel;i++)
          {
            vl_t_act_droite[i]=fa_cell_get("arbre_relations",vl_t_tableau[i],"tc_act_cleunik_droite");
            vl_t_act_gauche[i]=fa_cell_get("arbre_relations",vl_t_tableau[i],"tc_act_cleunik_gauche");
            vl_t_cho_droite[i]=fa_cell_get("arbre_relations",vl_t_tableau[i],"tc_choix_cleunik_droite");
            vl_t_cho_gauche[i]=fa_cell_get("arbre_relations",vl_t_tableau[i],"tc_choix_cleunik_gauche");
          }
        vl_c_donnees="vf_c_action=kilometres_supprimer&";
        vl_c_donnees+="vl_t_act_droite="+fa_enc(fa_jsarray2php_00(vl_t_act_droite))+"&";
        vl_c_donnees+="vl_t_act_gauche="+fa_enc(fa_jsarray2php_00(vl_t_act_gauche))+"&";
        vl_c_donnees+="vl_t_cho_droite="+fa_enc(fa_jsarray2php_00(vl_t_cho_droite))+"&";
        vl_c_donnees+="vl_t_cho_gauche="+fa_enc(fa_jsarray2php_00(vl_t_cho_gauche))+"&";
        fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
      }
      break;
    }
}
]]></script>
END;
?>
