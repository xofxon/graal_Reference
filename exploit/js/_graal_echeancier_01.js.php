<?php
$vl_tb_droits_trait_00302=_graal_requete_droits_fenetre("Trait_00302",$vl_e_uti_cleunik);
if ($vl_tb_droits_trait_00302[0]==true) {$js_type_cli="cli";} else {$js_type_cli="???";}
$vl_tb_droits_trait_00303=_graal_requete_droits_fenetre("Trait_00303",$vl_e_uti_cleunik);
if ($vl_tb_droits_trait_00303[0]==true) {$js_type_fou="fou";} else {$js_type_fou="???";}
$js_01="";$js_02="";$js_03="";$js_04="";$js_05="";$js_06="";$js_07="";$js_08="";
switch ($vl_c_type){
	case '1':	//Echéancier factures
	case '2':	//Echéancier commandes
	case '3':	//Echéancier général
		$js_01=<<<EOT
		fa_badl("arbre_echeancier",lstn_grise);
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
EOT;
		break;
	case '5': //Réglements clients : 1 chèque -> une facture
	case '12': //Réglements fournisseurs : 1 chèque -> une facture
		$js_01=<<<EOT
		fa_badl("arbre_echeancier",lstn_grise);
		//fa05_sel_date('21','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_21");
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
		fa_att_set("arbre_echeancier","onselect","pf_sel_ligne();");
		fa_att_set("arbre_echeancier","onclick","pf_sel_ligne();");
EOT;
		$js_06=<<<EOT
		function pf_sel_ligne(vv_qui){
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			if (fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik")==""){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			var param='_graal_fen_reglement_01.php?echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&genre=$vl_c_type';
			param+="&fichier_echeance="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_fichier_echeance"));
			param+='&journal_cleunik='+fa_mlget("ml_journal")+"&";
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
EOT;
		break;
	case '7': //Réglements clients : 1 chèque -> n factures
	case '14': //Réglements fournisseurs : 1 chèque -> n factures
		$js_00=<<<EOT
var vf_t_panier_echeancier=[];
const vf_c_script_var_01='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_echeancier';
EOT;
		$js_01=<<<EOT
		fa_badl("arbre_echeancier",lstn_grise);
		fa_badl("arbre_echeancier_panier",lstn_grise);
		//fa05_sel_date('21','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_21");
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
		fa_att_set("arbre_echeancier","onselect","");
		fa_att_set("arbre_echeancier","onclick","");
		fa_att_set("arbre_echeancier","seltype","multiple");
EOT;
		$js_06=<<<EOT
		function pf_sel_ligne(vv_qui){
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik")==""){return;}
			var param='_graal_fen_reglement_01.php?echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&genre=$vl_c_type';
			param+="&fichier_echeance="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_fichier_echeance"));
			param+='&journal_cleunik='+fa_mlget("ml_journal")+"&";
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
EOT;
		$js_07=<<<EOT
		function pf_panier_ajoute() {
		var vl_t_tableau=[];
	  var vl_e_nb_sel;
	  var vl_c_fichier="";
	  var vl_t_echeancier=[];
	  vl_t_tableau=fa_lignes_selectionnees("arbre_echeancier");
	  vl_e_nb_sel=vl_t_tableau.length;
	  if (vl_e_nb_sel==0){return;}
	    for(i=0;i<vl_e_nb_sel;i++) {
	    vl_c_fichier=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_fichier_echeance");
	    vl_t_echeancier[i]=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_echeance_cleunik");
	  }
	  if (vl_t_echeancier==0){return;}
	  vf_t_panier_echeancier=vf_t_panier_echeancier.concat(vl_t_echeancier);
	  fa_xmlhttprequest_txt(vf_c_script_var_01,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier_echeancier),pf_panier_ajoute_fin);
		}
		function pf_panier_ajoute_fin(stream){
			fa_grise_fenetre("","oui");
			vf_c_url_alimente_table=_c_url_alimente_table_echeancier+'&raf_random='+Math.random();
			vf_c_url_alimente_table+='&vl_e_etat=0';
			fa_ds("arbre_echeancier_panier",vf_c_url_alimente_table);
			var param="_graal_fen_reglement_01.php?genre=$vl_c_type";
			param+="&vf_t_panier_echeancier="+fa_jsarray2php_00(vf_t_panier_echeancier);
			param+='&journal_cleunik='+fa_mlget("ml_journal")+"&";
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
		function pf_panier_enleve() {
		  var vl_t_tableau=[];
		  var vl_e_nb_sel;
		  vl_t_tableau=fa_lignes_selectionnees("arbre_echeancier_panier");
		  vl_e_nb_sel=vl_t_tableau.length;
		  if (vl_e_nb_sel!=0) {
		    var vl_t_panier=[];
		    var vl_t_echeances=[];
		    for(i=0;i<vl_e_nb_sel;i++) {
		      vl_t_echeances[i]=fa_cell_get("arbre_echeancier_panier",vl_t_tableau[i],"tc_echeance_cleunik");
		    }
		    var j=0;k=-1;
		    for(i=0;i<vf_t_panier.length;i++) {
		      if (vl_t_echeances.indexOf(vf_t_panier[i])==-1) { 
		        k++;
		        vl_t_panier[k]=vf_t_panier[i];
		      }  
		    }
		    vf_t_panier=vl_t_panier;
		    fa_xmlhttprequest_txt(vf_c_script_var_01,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
		  }
		}
		function pf_panier_retour(){
			vf_t_panier=[];
			fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
			fa_lignes_arbre_deselectionne("arbre_echeancier");
			pf_approximatif();
		}
EOT;
		break;		
	case '8': //  Réglement client 1 virement/traite/LCR -> une facture	
	case 'C8': //  Réglement client 1 virement/traite/LCR -> une commande client	
	case '15': ///  Réglement fournisseur 1 virement/traite/LCR -> une facture	
		$js_01=<<<EOT
		fa_badl("arbre_echeancier",lstn_grise);
		//fa05_sel_date('21','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_21");
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
		fa_att_set("arbre_echeancier","onselect","pf_sel_ligne();");
		fa_att_set("arbre_echeancier","onclick","pf_sel_ligne();");
EOT;
		$js_06=<<<EOT
		function pf_sel_ligne(vv_qui){
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			if (fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik")==""){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			var param='_graal_fen_reglement_01.php?echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&genre=$vl_c_type';
			param+='&journal_cleunik='+fa_mlget("ml_journal")+"&";
			param+="&fichier_echeance="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_fichier_echeance"));
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
EOT;
		break;
		case '10': //  Réglement client 1 virement/traite/LCR -> n factures
		case '17': //  Réglement fournisseur 1 virement/traite/LCR -> n factures
		$js_00=<<<EOT
var vf_t_panier_echeancier=[];
const vf_c_script_var_01='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_echeancier';
EOT;
		$js_01=<<<EOT
		fa_badl("arbre_echeancier",lstn_grise);
		fa_badl("arbre_echeancier_panier",lstn_grise);
		//fa05_sel_date('21','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_21");
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
		fa_att_set("arbre_echeancier","onselect","");
		fa_att_set("arbre_echeancier","onclick","");
		fa_att_set("arbre_echeancier","seltype","multiple");
EOT;
		$js_06="";
		$js_07=<<<EOT
		function pf_panier_ajoute() {
		var vl_t_tableau=[];
	  var vl_e_nb_sel;
	  var vl_c_fichier="";
	  var vl_t_echeancier=[];
	  vl_t_tableau=fa_lignes_selectionnees("arbre_echeancier");
	  vl_e_nb_sel=vl_t_tableau.length;
	  if (vl_e_nb_sel==0){return;}
	    for(i=0;i<vl_e_nb_sel;i++) {
	    vl_c_fichier=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_fichier_echeance");
	    vl_t_echeancier[i]=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_echeance_cleunik");
	  }
	  if (vl_t_echeancier==0){return;}
	  vf_t_panier_echeancier=vf_t_panier_echeancier.concat(vl_t_echeancier);
	  fa_xmlhttprequest_txt(vf_c_script_var_01,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier_echeancier),pf_panier_ajoute_fin);
		}
		function pf_panier_ajoute_fin(stream){
			fa_grise_fenetre("","oui");
			vf_c_url_alimente_table=_c_url_alimente_table_echeancier+'&raf_random='+Math.random();
			vf_c_url_alimente_table+='&vl_e_etat=0';
			fa_ds("arbre_echeancier_panier",vf_c_url_alimente_table);
			var param='_graal_fen_reglement_01.php?type=$js_type_cli&genre=$vl_c_type';
			param+='&journal_cleunik='+fa_mlget("ml_journal")+"&";
			param+="&vf_t_panier_echeancier="+fa_jsarray2php_00(vf_t_panier_echeancier);
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
		function pf_panier_enleve() {
		  var vl_t_tableau=[];
		  var vl_e_nb_sel;
		  vl_t_tableau=fa_lignes_selectionnees("arbre_echeancier_panier");
		  vl_e_nb_sel=vl_t_tableau.length;
		  if (vl_e_nb_sel!=0) {
		    var vl_t_panier=[];
		    var vl_t_echeances=[];
		    for(i=0;i<vl_e_nb_sel;i++) {
		      vl_t_echeances[i]=fa_cell_get("arbre_echeancier_panier",vl_t_tableau[i],"tc_echeance_cleunik");
		    }
		    var j=0;k=-1;
		    for(i=0;i<vf_t_panier.length;i++) {
		      if (vl_t_echeances.indexOf(vf_t_panier[i])==-1) { 
		        k++;
		        vl_t_panier[k]=vf_t_panier[i];
		      }  
		    }
		    vf_t_panier=vl_t_panier;
		    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
		  }
		}
		function pf_panier_retour(){
			vf_t_panier=[];
			fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
			fa_lignes_arbre_deselectionne("arbre_echeancier");
			pf_approximatif();
		}
EOT;
		break;		
		default:
		$js_01=<<<EOT
		fa_badl("arbre_echeancier",lstn_grise);
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
EOT;
		break;
}
switch ($vl_c_id_fenetre) {
	case "Fen_00960":$js_type=$js_type_cli;break;	//	Traitements de masse échéancier factures clients
	case "Fen_00961":$js_type=$js_type_fou;break;	//	Traitements de masse échéancier factures fournisseurs
}
switch ($vl_c_id_fenetre) {
	case "Fen_00960":	//	Traitements de masse échéancier factures clients
	case "Fen_00961":	//	Traitements de masse échéancier factures fournisseurs
		$js_02=<<<EOT
		fa_att_set("arbre_echeancier","seltype","multiple");
EOT;
		$js_03="";
	$js_04=<<<EOT
		case "echeance_solde":
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_echeance=[];
  var vl_t_fic_eche=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_echeancier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_echeance[i]=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_echeance_cleunik");
      vl_t_fic_eche[i]=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_fichier_echeance");
    }
  }
  vl_e_nb_sel=vl_t_echeance.length;
  if (vl_e_nb_sel!=0) {
    if (confirm("Confirmez-vous le solde des échéances ("+vl_e_nb_sel+") ?")!=true) {return};
		var vl_c_bloc_notes=prompt("Note pour solde échéance","Solde en masse des échéances.");
    	var vl_c_donnees="vl_t_echeance="+fa_enc(fa_jsarray2php_00(vl_t_echeance))+"&";
    	vl_c_donnees+="vl_t_fic_eche="+fa_enc(fa_jsarray2php_00(vl_t_fic_eche))+"&";
		vl_c_donnees+="vl_blocnotebrut="+fa_enc(vl_c_bloc_notes)+"&";
		var vl_c_script_bdope_fen_echeances="_graal_bdope_echeance_01.php?&vf_c_action=kilometres_solder&";
    fa_xmlhttprequest_txt(vl_c_script_bdope_fen_echeances,vl_c_donnees,pf_solde_kilometre_fin);
  } else {
  	alert("Vous n'avez pas sélectionné d'échéance !!");
  }
EOT;
$js_05=<<<EOT
function pf_solde_kilometre_fin(vv_stream){
	pf_approximatif();
}
EOT;
		break;
	default:
	$js_03=<<<EOT
	case "echeance_modif":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (prop_doc=='ai14'){
				var vl_c_type="$js_type_cli";
			} else {
				var vl_c_type="$js_type_fou";
			}
			var param='&echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&type='+vl_c_type+'&genre=modif&';
			param+="fichier_echeance="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_fichier_echeance"))+'&'
  		fa_ouvre(vf_c_script_fen_echeance+param,600,600);
			break;
EOT;
	$js_04=<<<EOT
		case "echeance_solde":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (prop_doc=='ai14'){
				var vl_c_type="$js_type_cli";
			} else {
				var vl_c_type="$js_type_fou";
			}
			var param='&echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&type='+vl_c_type+'&genre=solde';
			param+="&fichier_echeance="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_fichier_echeance"))+'&'
  			fa_ouvre(vf_c_script_fen_echeance+param,600,600);
			break;
EOT;
	$js_05="";
		break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const _c_url_alimente_table_echeancier="_graal_das_echeancier_01.php?genreacteur=$vl_c_genreacteur&nature=$vl_c_type&";
const _c_url_alimente_table_graphique="_graal_das_echeancier_01.php?genreacteur=$vl_c_genreacteur&nature=$vl_c_type&sortie=graphique&";
const vf_c_script_fen_action='_graal_fen_actions_02.php?';
const vf_c_script_fen_acteur="_graal_fen_acteurs_01.php?";
const vf_c_script_fen_echeance="_graal_fen_echeance_01.php?";
var vf_c_url_alimente_table="";
const lstn_grise= { 
	willRebuild : function(event){},
	didRebuild  : function(event){pf_grise_fenetre_non();} 
};
$js_00
function pf_aa_init(){
$js_01
	$js_02
	fa_badl("arbre_echeancier_graphique",lstn_grise);
  //pf_approximatif();
  fa_focusdonne("brb_tb_rechapproxima");
}
$js_07
function pf_alimente_table(){
	fa_grise_fenetre("","oui");
  fa_ds("arbre_echeancier",vf_c_url_alimente_table+'&raf_random='+Math.random());
}
function pf_approximatif(){
  if ( fa_value_get("brb_tb_rechapproxima") == "" ) {return;}
  vf_c_url_alimente_table=_c_url_alimente_table_echeancier;
  vf_c_url_alimente_table+='&vl_c_dateheuredebut='+fa_enc(fa_date_formate(fa_value_get("brb_tb_deb"),"AAAAMMJJ"));
	vf_c_url_alimente_table+='&vl_c_dateheurefin='+fa_enc(fa_date_formate(fa_value_get("brb_tb_fin"),"AAAAMMJJ"));
	vf_c_url_alimente_table+='&vl_c_recherche='+fa_enc(fa_value_get("brb_tb_rechapproxima"));
	vf_c_url_alimente_table+='&vl_e_typedate='+fa_value_get("brb_ml_typedate");
	vf_c_url_alimente_table+='&vl_e_type='+fa_value_get("brb_ml_type");
	vf_c_url_alimente_table+='&vl_e_etat='+fa_value_get("brb_ml_etat");
	pf_alimente_table();
}
function pf_deck_graphique(){
  if ( fa_value_get("brb_tb_rechapproxima") == "" ) {return;}
  var vl_c_url_alimente_table=_c_url_alimente_table_graphique+'&raf_random='+Math.random();
  vl_c_url_alimente_table+='&vl_c_dateheuredebut='+fa_enc(fa_date_formate(fa_value_get("brb_tb_deb"),"AAAAMMJJ"));
	vl_c_url_alimente_table+='&vl_c_dateheurefin='+fa_enc(fa_date_formate(fa_value_get("brb_tb_fin"),"AAAAMMJJ"));
	vl_c_url_alimente_table+='&vl_c_recherche='+fa_enc(fa_value_get("brb_tb_rechapproxima"));
	vl_c_url_alimente_table+='&vl_e_typedate='+fa_value_get("brb_ml_typedate");
	vl_c_url_alimente_table+='&vl_e_type='+fa_value_get("brb_ml_type");
	vl_c_url_alimente_table+='&vl_e_etat='+fa_value_get("brb_ml_etat");
  vl_c_url_alimente_table+="&ml_art_04="+fa_value_get("ml_art_04");
	fa_grise_fenetre("","oui");
  fa_ds("arbre_echeancier_graphique",vl_c_url_alimente_table);
}
function pf_dessin(){
  var vl_donnes="";
  var vl_affichage="";
  var vl_noms="";
  var wTree = fa_gid("arbre_echeancier_graphique");
	var nb=fa_cl("arbre_echeancier_graphique");
  for(var i=0;i<nb;i++){
    vl_donnes+=parseFloat(fa_dec(fa_se(wTree.view.getCellText( i ,wTree.columns["nombre_brut"] ))))+';';
    vl_affichage+=parseFloat(fa_dec(fa_se(wTree.view.getCellText( i ,wTree.columns["nombre_formatte"] ))))+';';
    vl_noms+=wTree.view.getCellText( i ,wTree.columns["periode"] )+';';
   }
  fa_value_set("datas",vl_affichage);  
  lien='_graal_svg_histo_01.php?large='+fa_enc(fa_value_get("large"));
  lien=lien+'&haut='+fa_enc(fa_value_get("haut"));
  lien=lien+'&titre='+fa_enc(fa_value_get("titre"));
  lien=lien+'&donnees='+fa_enc(vl_donnes);
  lien=lien+'&noms='+fa_enc(vl_noms);
  lien=lien+'&type='+fa_enc(fa_value_get("type"));
  lien=lien+'&col1='+fa_enc(fa_value_get("tb_01"));
  lien=lien+'&col2='+fa_enc(fa_value_get("tb_02"));
  lien=lien+'&col3='+fa_enc(fa_value_get("tb_03"));
  lien=lien+'&col4='+fa_enc(fa_value_get("tb_04"));
  fa_att_set("webFrame","src",lien);
}
function pf_grise_fenetre_non(){
	fa_grise_fenetre("","non");
}
$js_06
function pf_onunload(){
	fa_brl("arbre_echeancier",lstn_grise);
}
function pf_ouvre(vv_quoi){
	switch (vv_quoi){
		case "action":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var vl_c_donnees="vf_e_action_cleunik="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_action_cleunik"))+"&vf_c_action=modifier&genreaction=jenesaispas&";
			fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
			break;
		case "acteur":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var param='&act_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_act_cleunik"))+'&';
  			fa_ouvre(vf_c_script_fen_acteur+param,1000,800);
			break;
		case "excel_01":
			var vl_c_nom_fichier_xls=prompt("Nom du fichier","echéancier.xls");
  			fa_ouvre(vf_c_url_alimente_table+'&raf_random='+Math.random()+"&sortie=excel_01&vl_c_nom_fichier_xls="+fa_enc(vl_c_nom_fichier_xls)+"&");
			break;
		$js_04
		$js_03
	}
}
function pf_raz_frame(){
	//alert("toto")
	//fa_att_set("graal_iframe_visu_reglement","src","");
}
$js_05
]]></script>
END;
?>