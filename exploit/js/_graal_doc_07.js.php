<?php
include("_graal_var_portee.php");
$vl_c_mes_01='Cette fonctionnalité est en développement ...\nMerci pour votre patience.';
$vl_c_mes_02='Vous ne pouvez pas gérer les droits de cette manière !!';
$vl_c_dico_00004=fa_recup_dico("dico_00004");
if ($vl_e_dossier_cleunik !="A"){
$js_ajout_dossier=<<<XOF
      		var vl_c_donnees="$vl_e_dossier_cleunik&cleunik_insertion_dossier="+fa_enc(vf_e_doc_cleunik)+"&label_insertion_dossier="+fa_value_get("tb_emplacement")+"("+fa_enc(fa_value_get("tb_titre"))+")";
      		fa_xmlhttprequest_txt(c_bdope_dossiers+vl_c_donnees,"",pf_retour_fenetre_dossiers_fin);
XOF;
}
if ($vl_e_dossier_cleunik !="A"){
$js_ajout_dossier=<<<XOF
	var vl_t_doc_cleunik=[];
      var vl_t_doc_nom=[];
      var vl_t_doc_titre=[];
        vl_t_doc_cleunik[0]=vf_e_doc_cleunik;
        vl_t_doc_nom[0]=fa_value_get("tb_emplacement");
        vl_t_doc_titre[0]=fa_value_get("tb_titre");
	window.opener.pf_retour_fenetre_docs(vl_t_doc_cleunik,vl_t_doc_nom,vl_t_doc_titre);
XOF;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
****************************************************************
**********  Fenêtre de gestion des documents physiques  ********
****************************************************************
*/
var vf_e_doc_cleunik;
var vf_c_action;
var vf_c_genre;
var vf_c_url_alimente_table='_graal_das_doc_01.php?';
var vf_c_script_edite="_graal_xml_doc_01.php";
var vf_c_script_bdope_doc="_graal_bdope_doc_02.php?genre=$vl_c_genre&portee_cleunik=$vl_e_portee_cleunik&";
var vf_c_script_bdope_doc_liaison="_graal_bdope_doc_02.php?";
const vf_c_upload_doc="_graal_upload_document.php?genre=$vl_c_genre&portee_cleunik=$vl_e_portee_cleunik&quelsdocs=$vl_c_quelsdocs&";
var vf_e_droits_proprio=0,vf_e_nombre=0,vf_c_typedoc="";
const vf_c_script_critere_ged_entreprise='_graal_das_ged_criteres_entreprise.php?';
const vf_c_script_critere_ged_lesmiens='_graal_das_ged_criteres_lesmiens.php?';
const vf_c_script_critere_ged_lesautres='_graal_das_ged_criteres_lesautres.php?';
const vf_c_script_critere_ged_tous='_graal_das_ged_criteres_tous.php?';
const vf_c_fen_criteres='_graal_fen_ged_criteres.php?';
const vf_c_script_favoris='_graal_bdope_ged_favoris_01.php?';
const vf_c_script_affiche_image="_graal_bdope_affiche_image_01.php?";
const c_fen_commentaires='_graal_fen_documents_commentaires_01.php?genreacteur=tousss&genredoc=doc&';
const c_iframe_commentaires_menu='_graal_fen_iframe_documents_commentaires_01.php?vl_doc_cleunik=';
const c_fen_selection_image="_graal_fen_ged_02.php?vl_c_retour=oui&";
const vf_c_script_ged='_graal_rech_ged_01.php?sortie=das&vl_c_actifs=0&vl_c_type=1&vl_c_qui=liaisons&';
const c_fen_selection_doc='_graal_fen_ged_01.php?genreged=tousss&quelsdocs=docs&retour=oui&';
const c_fen_selection_notes='_graal_fen_ged_01.php?genreged=tousss&quelsdocs=notes&retour=oui&';
const c_fen_selection_pseudodocs='_graal_fen_ged_01.php?genreged=tousss&quelsdocs=pseudodocs&retour=oui&';
const c_script_connecte="_graal_bdope_doc_connexions.php?";
const c_das_connecte='_graal_rech_ged_03.php?sortie=das&vl_e_doc_cleunik_pere=';
const c_script_liens="_graal_fen_pseudodocs_01.php?genre=$vl_c_genre&quelsdocs=unlien&";
const c_script_notes="_graal_fen_note_01.php?genre=$vl_c_genre&quelsdocs=unenot_acteur&";
const vf_c_script_fen_action='_graal_fen_actions_02.php?';
const vf_c_script_fen_acteur="_graal_fen_acteurs_01.php?act_cleunik=";
const vf_c_scripf_fen_entrep="_graal_fen_entreprise_01.php";
const c_script_fen_visu_acteurs='_graal_fen_rech_acteurs.php?vl_c_origine=selection&vl_c_proc_retour=pf_ouvre_acteur_recup&';
const c_script_choix_interlo="_graal_fen_rech_interlocuteurs_01.php?p02=$vl_c_id_fenetre&";
const c_script_choix_actions="_graal_fen_rech_actions_01.php?p02=$vl_c_id_fenetre&genreaction=toutes&";
const c_script_choix_article="_graal_fen_rech_articles_01.php?p02=$vl_c_id_fenetre&";
const c_fen_selection_dossiers='_graal_fen_ged_01.php?genreged=tousss&quelsdocs=dossiers&retour=oui&';
const c_bdope_dossiers='_graal_bdope_note_01.php?vf_c_action=insere_dans_dossier&type_insertion_dossier=doc&vf_e_doc_cleunik=';
var vf_c_retour="";
const lstn_grise = { 
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre("","non");} 
};
function pf_action(vv_quoi){
  switch (vv_quoi) {
    case 'atteindre' :
      alert("$vl_c_mes_01");
      return;
      break;
    case 'droits' :
      if (vf_e_doc_cleunik!=0) {fa_ouvre("_graal_fen_droits_01.php?vl_c_genredoc=Docus&vl_e_doc_cleunik="+vf_e_doc_cleunik,400,400)}else{alert("$vl_c_mes_02");}
      break;
    case 'favoris_ajout':
      vl_c_param="vf_c_action=ajouter&vf_c_quoi=1&vl_doc_cleunik="+vf_e_doc_cleunik+"&raf_random="+Math.random()+"&";
      fa_xmlhttprequest_txt(vf_c_script_favoris,vl_c_param,pf_action_fin_01,'');
      break;
    case 'favoris_supprimer':
      vl_c_param="vf_c_action=supprimer&vf_c_quoi=1&vl_doc_cleunik="+vf_e_doc_cleunik+"&raf_random="+Math.random()+"&";
      fa_xmlhttprequest_txt(vf_c_script_favoris,vl_c_param,pf_action_fin_01,'');
      break;
    case 'dossier_ajouter':
    	fa_ouvre(c_fen_selection_dossiers,1000,800);
      break;
  }
}
function pf_action_fin_01(vv_message) {
  alert(vv_message)
}
function pf_affiche_commentaire(vl_commentaire_cleunik) {
  var vl_c_param='&raf_random='+Math.random()+'&';
  vl_c_param+='vf_e_doc_cleunik='+vf_e_doc_cleunik+'&';
  vl_c_param+='vf_e_commentaire_cleunik='+vl_commentaire_cleunik+'&';
  vl_c_param+='genreacteur=favori&';
  fa_ouvre(c_fen_commentaires+vl_c_param,800,650);
}
function pf_affiche_datas(stream){
  var vl_c_datas;
  pf_raz_fiche();
  vl_c_datas = stream;
  vf_e_doc_cleunik=fa_xml_get(vl_c_datas,'doc_cleunik');
  fa_value_set('tb_emplacement',fa_xml_get(vl_c_datas,'emplacement'));
  fa_value_set('tb_titre',fa_xml_get(vl_c_datas,'titre'));
  fa_value_set('tb_descriptif_sommaire',fa_xml_get(vl_c_datas,'descriptif_sommaire'));
  fa_value_set("la_dateheurecreation",fa_xml_get(vl_c_datas,'dateheurecreation'));
  fa_value_set("la_dateheuremodif",fa_xml_get(vl_c_datas,'dateheuremodif'));
  fa_value_set("la_tailledoc",fa_xml_get(vl_c_datas,'tailledoc'));
  fa_value_set("tb_hash",fa_xml_get(vl_c_datas,'hash'));
  fa_value_set("tb_origine",fa_xml_get(vl_c_datas,'origine'));
  fa_value_set("rdg_actif",fa_xml_get(vl_c_datas,'actif'));
  vf_e_nombre=fa_xml_get(vl_c_datas,'nombre');
  vf_c_typedoc=fa_xml_get(vl_c_datas,'typedoc');
  fa_cache_non("tab_appartenance");
  var vl_c_nombre_criteres=fa_xml_get(vl_c_datas,'nombre_criteres');
  var vl_c_nombre_commentaires=fa_xml_get(vl_c_datas,'nombre_commentaires');
  var vl_c_nombre_connexions=fa_xml_get(vl_c_datas,'nombre_connexions');
  var vl_c_nombre_rattachements=fa_xml_get(vl_c_datas,'nombre_rattachements');
	fa_att_set("tab_criteres","label","$vl_c_aak_122"+vl_c_nombre_criteres);
	fa_att_set("tab_commentaires","label","$vl_c_aak_126"+vl_c_nombre_commentaires);
	fa_att_set("tab_connexions","label","$vl_c_aak_132"+vl_c_nombre_connexions);
	fa_att_set("tab_appartenance","label","$vl_c_aak_131"+vl_c_nombre_rattachements);
  if (vf_e_nombre!=1) {
    fa_gid("bt_supprimer").label="Détacher";
    fa_att_set("bt_supprimer","tooltiptext","Détacher Ctrl+Shift+F4")
    fa_att_set("bt_supprimer","oncommand","if(fa_est_grise('bt_supprimer')==true){return};pf_validation('detacher');")
    //fa_cache_non("tab_appartenance");
  } else {
    fa_gid("bt_supprimer").label="$vl_c_dico_00004";
    fa_att_set("bt_supprimer","tooltiptext","$vl_c_dico_00004 Ctrl+Shift+F4")
    fa_att_set("bt_supprimer","oncommand","if(fa_est_grise('bt_supprimer')==true){return};pf_validation('supprimer');")
  }
  if (vl_c_nombre_criteres!="") {pf_affiche_donnees_criteres();}
  if (vl_c_nombre_rattachements!="") {pf_affiche_donnees_ged();}
  if (vl_c_nombre_connexions!="") {pf_affiche_donnees_connexions();}
  if (vl_c_nombre_commentaires!="") {pf_affiche_iframe_commentaires();}
}
function pf_affiche_donnees_connexions() {
  var vl_c_param=c_das_connecte+vf_e_doc_cleunik+'&raf_random='+Math.random()+'&'
  fa_das("arbre_des_connexions",vl_c_param);
}
function pf_affiche_donnees_criteres(){
  pf_affiche_donnees_criteres_entreprise();
  pf_affiche_donnees_criteres_lesautres();
  pf_affiche_donnees_criteres_lesmiens();
  pf_affiche_donnees_criteres_tous();
}
function pf_affiche_donnees_criteres_entreprise() {
  var vl_c_param=vf_c_script_critere_ged_entreprise+"vl_e_doc_cleunik="+vf_e_doc_cleunik+"&raf_random="+Math.random()+"&";
  fa_das("criteres_des_ged_entreprise",vl_c_param);
}
function pf_affiche_donnees_criteres_lesautres() {
  var vl_c_param=vf_c_script_critere_ged_lesautres+"vl_e_doc_cleunik="+vf_e_doc_cleunik+"&raf_random="+Math.random();
  fa_das("criteres_des_ged_lesautres",vl_c_param);
}
function pf_affiche_donnees_criteres_lesmiens() {
  var vl_c_param=vf_c_script_critere_ged_lesmiens+"vl_e_doc_cleunik="+vf_e_doc_cleunik+"&raf_random="+Math.random();
  fa_das("criteres_des_ged_lesmiens",vl_c_param);
}
function pf_affiche_donnees_criteres_tous() {
  var vl_c_param=vf_c_script_critere_ged_tous+"vl_e_doc_cleunik="+vf_e_doc_cleunik+"&raf_random="+Math.random();
  fa_das("criteres_des_ged_tous",vl_c_param);
}
function pf_affiche_donnees_ged() {
  var vl_c_param=vf_c_script_ged+'vl_e_portee_cleunik='+vf_e_doc_cleunik+'&raf_random='+Math.random()+'&';
  fa_das("arbre_des_ged",vl_c_param);
}
function pf_affiche_iframe_commentaires() {
  fa_att_set("if_commentaires_doc","src",c_iframe_commentaires_menu+vf_e_doc_cleunik+"&raf_random="+Math.random()+"&");
}
function pf_affiche_image() {
  fa_att_set("ifr_image","src",vf_c_script_affiche_image+'doc_cleunik='+vf_e_doc_cleunik );
}
function pf_ajoute_liaison(vv_qui){
	var vl_c_param='&raf_random='+Math.random()+'&';
	switch (vv_qui){
		case "acteur":
			vl_c_param+="vl_e_genreacteur=tousss&";
			fa_ouvre(c_script_fen_visu_acteurs+vl_c_param,800,650);
			break;
		case "interlocuteur":
			fa_ouvre(c_script_choix_interlo+"genreacteur=tousss&",800,600);
			break;
		case "article":
			fa_ouvre(c_script_choix_article+"genreacteur=tousss&",800,600);
			break;
		case "action":
			fa_ouvre(c_script_choix_actions+vl_c_param,1000,800);
			break;
	}
}
function pf_alimente_defaut(){}
function pf_alimente_table(){
	fa_grise_fenetre("","oui");
  fa_das("arbre_des_docs",vf_c_url_alimente_table+"&raf01="+Math.random());
}
function pf_cache_tab(){
  var vl_tab=fa_gid("vb_tableau");
  if(vl_tab.hidden == true){vl_tab.hidden=false;}else {vl_tab.hidden=true;}
}
function pf_connecte(vv_quoi_01){
  switch (vv_quoi_01) {
    case 'doc':
      vf_c_retour="connexion";
	  switch ("$vl_c_quelsdocs"){
		  case "image_articl"  :  //  Un lien d'image article
		  case "uneimg_articl" :
			case "unlogoentrep"	 :	//	Un logo d'entreprise	
		    fa_ouvre(c_fen_selection_image+"&sauf="+vf_e_doc_cleunik,1000,800);
		    break;
		  default:
		    fa_ouvre(c_fen_selection_doc+"&sauf="+vf_e_doc_cleunik,1000,800);
		}
      break;
		case 'note':
      vf_c_retour="connexion";
      fa_ouvre(c_fen_selection_notes,1000,800);
      break;
		case 'pseudodocs':
      vf_c_retour="connexion";
      fa_ouvre(c_fen_selection_pseudodocs,1000,800);
      break;
  }
}
function pf_deconnecte(vv_quoi_01){
  switch (vv_quoi_01) {
    case 'doc':
		case 'note':
		case 'pseudodocs':
      var rowIndex=fa_cui("arbre_des_connexions");if(rowIndex == -1){return;}
      if (confirm("Confirmez-vous la suppression de cette connexion ?")==false) {return;}
      var s ="vf_c_action=deconnecter&vl_e_doc_cleunik_gauche="+fa_enc(vf_e_doc_cleunik)+"&vl_e_doc_cleunik_droite="+fa_cell_get("arbre_des_connexions",rowIndex,"arbre_des_connexions_doc_cleunik");
      fa_xmlhttprequest_txt(c_script_connecte,s,pf_affiche_donnees_connexions);
      break;
  }
}
function pf_etat_fen(vv_quoi)  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
	fa_badl("arbre_des_docs",lstn_grise);
      vf_c_url_alimente_table+='quelsdocs='+fa_att_get("_graal_fen_doc_07","_graal_lesquels");
      vf_c_url_alimente_table+='&vs_typedoc='+fa_att_get("_graal_fen_doc_07","_graal_typedoc");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_detailler");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_oui("bt_supprimer");
      fa_grise_groupe_oui('broadcaster_01');
      $vl_c_fenini      
      switch ("$vl_e_doc_cleunik") {
        case "A" : pf_alimente_table();break;
        case "-1":pf_etat_fen("ajouter");break;
        default:
          vf_e_doc_cleunik=$vl_e_doc_cleunik;
          fa_grise_oui("bt_ajouter");
          fa_xmlhttprequest_xml(vf_c_script_edite,"vl_e_doc_cleunik=$vl_e_doc_cleunik&",pf_affiche_datas);
       }
      break;
    case "selectionner":
      pf_verif_acces();
      break;
    case "selectionner_suite":
      vf_c_action="selectionner"
      fa_grise_groupe_oui('broadcaster_01');
      if ((vf_e_droits_proprio & 4) == 4) {fa_grise_non("bt_modifier");}
      if ((vf_e_droits_proprio & 8) == 8) {fa_grise_non("bt_supprimer");}
      fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_detailler");
      fa_cache_oui("bloc_recherche");
      fa_cache_non("bloc_telecharge");
      //fa_grise_oui("bt_sortir");
      break;
    case "modifier":
      fa_grise_non("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_supprimer");
      fa_grise_groupe_non('broadcaster_01');
      if ((vf_e_droits_proprio & 1) == 1) {fa_grise_non("menu_gestion_des_droits");} else {fa_grise_oui("menu_gestion_des_droits");}
      if ((vf_e_droits_proprio & 2) == 2) {fa_grise_non("tb_telecharge_doc");} else {fa_grise_oui("tb_telecharge_doc");}
      fa_grise_oui("tb_ouvre_fichier");fa_grise_oui("tb_ouvre_fichier_ged");
      fa_ro_oui("tb_emplacement");
      fa_focusdonne('tb_titre');
      break;
    case "ajouter":
      fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_oui("bt_supprimer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_cache_oui("tab_criteres");fa_cache_oui("tab_commentaires");fa_cache_oui("tab_appartenance");fa_cache_oui("tab_connexions");if ("$vl_c_quelsdocs"=="image_articl"){fa_cache_oui("tab_image");}
      fa_gid("tab_infogene").selectedIndex=0;
      fa_grise_groupe_non('broadcaster_01');
      fa_grise_oui("menu_02");
      fa_focusdonne("tb_emplacement");
      fa_cache_non("bloc_recherche");
      fa_cache_oui("bloc_telecharge");
      break;
    case "annuler":
      fa_gid("dk_02").selectedIndex=0;
      fa_cache_oui("bloc_recherche");
      fa_cache_oui("bloc_telecharge");
      fa_grise_non("bt_ajouter");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_detailler");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_oui("bt_supprimer");
      fa_grise_non("tb_telecharge_doc");
      fa_grise_non("menu_gestion_des_droits")
      fa_cache_non("tab_criteres");fa_cache_non("tab_commentaires");fa_cache_non("tab_appartenance");fa_cache_non("tab_connexions");if ("$vl_c_quelsdocs"=="image_articl"){fa_cache_non("tab_image");}
      pf_raz_fiche();
      fa_grise_groupe_oui('broadcaster_01');
      switch ("$vl_e_doc_cleunik") {
        case "A" : pf_alimente_table();break;
        case "-1":pf_etat_fen("ajouter");break;
        default:
          vf_e_doc_cleunik=$vl_e_doc_cleunik;
          fa_grise_oui("bt_ajouter");
          fa_xmlhttprequest_xml(vf_c_script_edite,"vl_e_doc_cleunik=$vl_e_doc_cleunik&",pf_affiche_datas);
       }
      fa_focusdonne('arbre_des_docs');
      break;
    case "sortir":
      window.close();
      break;   
  }
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (window.opener!=null) {
    switch ("$vl_c_quelsdocs") {
      case "uneimg_articl"  : 
        window.opener.pf_affiche_donnees_images();
        break;   //  Une image article
      case "undoc_interl"   : 
      case "undoc_articl"   :
      case "undoc_acteur"   :
      case "undoc"          :
      case "medoc"          :
      case "nosdocs"        : 
      case "leurdocs"       :
      case "undoc_entrep"   :
      case "undoc_action"   :
      try {  
      	window.opener.pf_affiche_donnees_ged();
      } catch (e) {
		//alert(e)
    //return null
	}	
        break;      
    }  
  }
  if (vl_datas=='ok') {
    pf_affiche_donnees_criteres_entreprise();
    switch (vf_c_action) {
      case 'ajouter':
      $js_ajout_dossier
        vf_c_action="modifier";
		pf_affiche_donnees_ged();
        fa_cache_non("tab_criteres");fa_cache_non("tab_commentaires");fa_cache_non("tab_appartenance");fa_cache_non("tab_connexions");if ("$vl_c_quelsdocs"=="image_articl"){fa_cache_non("tab_image");}
        fa_grise_non("menu_02");
        break;
      case 'modifier':
        pf_raz_fiche();
        pf_etat_fen('annuler');
        break;
       case 'supprimer':
       case 'detacher':
        pf_etat_fen('annuler');
        pf_etat_fen("sortir");
        break;
      case 'attacher':
      $js_ajout_dossier
        pf_etat_fen('annuler');
        pf_etat_fen("sortir");
        break;
      default :
        alert('gestion mal gérée');
    }
  }
  else {
    fa_erreur(vl_datas)
  }
}
function pf_ouvre(vv_quoi_01,vv_quoi_02) {
  var vl_c_param;
  vl_c_param="typedoc=3&";
  switch (vv_quoi_01) {
    case "critere_entreprise":
      vl_c_param+='vl_e_doc_cleunik='+vf_e_doc_cleunik+'&genrecritere=entreprise&vl_c_titre='+fa_enc(fa_value_get("tb_titre"))+"&";
      fa_ouvre(vf_c_fen_criteres+vl_c_param,800,600);
      break;
    case "critere_lesmiens":
      vl_c_param+='vl_e_doc_cleunik='+vf_e_doc_cleunik+'&genrecritere=moi&vl_c_titre='+fa_enc(fa_value_get("tb_titre"))+"&";
      fa_ouvre(vf_c_fen_criteres+vl_c_param,800,600);
      break;
    case "commentaires":
      vl_c_param='vf_e_doc_cleunik='+vf_e_doc_cleunik+'&';
      vl_c_param+='vf_e_commentaire_cleunik=-1&';
      vl_c_param+='genreacteur=favori&';
      fa_ouvre(c_fen_commentaires+vl_c_param,800,650);
      break;
  }
}
function pf_ouvre_acteur_recup(vl_act_cleunik,vl_c_raisonsoc,vl_c_typeacteur){
	var s="genre=acteur&portee_cleunik="+vl_act_cleunik+"&";
	s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
	s +="vf_c_action=attacher&";
	fa_xmlhttprequest_txt(vf_c_script_bdope_doc_liaison,s,pf_affiche_donnees_ged);
}
function pf_ouvre_action_recup(vl_action_cleunik,vf_c_sujet) {
	var s="genre=action&portee_cleunik="+vl_action_cleunik+"&";
	s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
	s +="vf_c_action=attacher&";
	fa_xmlhttprequest_txt(vf_c_script_bdope_doc_liaison,s,pf_affiche_donnees_ged);
}
function pf_ouvre_article_recup(vl_art_cleunik,vl_code,vl_description){
	var s="genre=articl&portee_cleunik="+vl_art_cleunik+"&";
	s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
	s +="vf_c_action=attacher&";
	fa_xmlhttprequest_txt(vf_c_script_bdope_doc_liaison,s,pf_affiche_donnees_ged);
}
function pf_ouvre_interlo_recup(vl_int_cleunik,vl_qui,vl_act_cleunik,vl_raisonsoc,vl_portee) {
	var s="genre=interl&portee_cleunik="+vl_int_cleunik+"&";
	s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
	s +="vf_c_action=attacher&";
	fa_xmlhttprequest_txt(vf_c_script_bdope_doc_liaison,s,pf_affiche_donnees_ged);
}
function pf_ouvre_fichier(vv_quoi_01){
  switch (vv_quoi_01) {
    case 'disque':
      var vl_c_nomfic=fa03_sel_fichier("","");
			if (vl_c_nomfic!=""){
	      var vl_c_hash=fa03_fichier_sha1(vl_c_nomfic);
	      fa_value_set("tb_emplacement",vl_c_nomfic);
	      fa_value_set("tb_hash",vl_c_hash);
	      fa_cache_non("tb_hash_verifie");
	      pf_verif_hash();
			}
      break;
    case 'ged':
      vf_c_retour="ouverture";
      switch ("$vl_c_quelsdocs"){
		  case "image_articl"  :  //  Un lien d'image article
		  case "uneimg_articl" :
			case "unlogoentrep"	 :	//	Un logo d'entreprise	
		    fa_ouvre(c_fen_selection_image,1000,800);
		    break;
		  default:
		    fa_ouvre(c_fen_selection_doc,1000,800);
		}
      break;
  }
}
function pf_ouvre_ged() {
  var rowIndex = fa_cui("arbre_des_connexions");
  if(rowIndex == -1){return;}
  var vl_e_doc_cleunik=fa_cell_get("arbre_des_connexions",rowIndex,"arbre_des_connexions_doc_cleunik");
  var vl_e_portee=fa_cell_get("arbre_des_connexions",rowIndex,"arbre_des_connexions_rattachement");
  var vl_c_param="doc_cleunik="+vl_e_doc_cleunik+"&";
  vl_c_param+="portee_cleunik="+vl_e_portee+"&";
  var vl_c_genre=fa_cell_get("arbre_des_connexions",rowIndex,"arbre_des_connexions_portee");
  switch (vl_c_genre) {
    case "$vl_e_articl":vl_c_param+="genre=articl&";break;
    case "$vl_e_action":vl_c_param+="genre=action&";break;
    case "$vl_e_interl":vl_c_param+="genre=interl&";break;
    case "$vl_e_acteur":vl_c_param+="genre=acteur&";break;
    case "$vl_e_utilis":vl_c_param+="genre=utilis&";break;
    case "$vl_e_entrep":vl_c_param+="genre=entrep&";break;
  }
  switch (fa_cell_get("arbre_des_connexions",rowIndex,"arbre_des_connexions_typedoc")) {
    case '1': fa_ouvre(c_script_liens+vl_c_param,800,300);break;
    case '2': fa_ouvre(c_script_notes+vl_c_param,800,600);break;
    case '3': //  Documents
    case '13':  //  Pièces jointes
      switch (fa_cell_get("arbre_des_connexions",rowIndex,"arbre_des_connexions_portee")) {
        case "$vl_e_articl":vl_c_param+="quelsdocs=undoc_articl&";break;
        case "$vl_e_action":vl_c_param+="quelsdocs=undoc_action&";break;
        case "$vl_e_interl":vl_c_param+="quelsdocs=undoc_interl&";break;
        case "$vl_e_acteur":vl_c_param+="quelsdocs=undoc_acteur&";break;
        case "$vl_e_utilis":vl_c_param+="quelsdocs=undoc_utilis&";break;
        case "$vl_e_entrep":vl_c_param+="quelsdocs=undoc_entrep&";break;
        default:vl_c_param+="quelsdocs=undoc&";break;
      }
		pf07_ouvre_doc("genre=$vl_c_genre&"+vl_c_param);
		break;
  }
}
function pf_ouvre_liaison() {
  var rowIndex = fa_cui("arbre_des_ged");
  if(rowIndex == -1){return;}
  var vl_e_cleunik=fa_cell_get("arbre_des_ged",rowIndex,"arbre_des_ged_rattachement");
  var vl_e_portee=fa_cell_get("arbre_des_ged",rowIndex,"arbre_des_ged_portee");
  switch (vl_e_portee) {
    case "$vl_e_articl":
			fa_ouvre_article('genre=tousss&vl_e_art_cleunik='+vl_e_cleunik+"&","");
			break;
    case "$vl_e_action":
		case "$vl_e_piejoi":
			var vl_c_donnees="vf_e_action_cleunik="+vl_e_cleunik+"&vf_c_action=modifier&genreaction=jenesaispas&";
			fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
			break;
    case "$vl_e_interl":
			fa_ouvre_interlo("vl_e_interlo_cleunik="+vl_e_cleunik);
			break;
    case "$vl_e_acteur":
			fa_ouvre(vf_c_script_fen_acteur+vl_e_cleunik,1200,800);
			break;
    case "$vl_e_utilis":
			break;
    case "$vl_e_entrep":
		fa_ouvre(vf_c_scripf_fen_entrep,1200,800);
			break;
  }
}
function pf_raz_fiche(){
  vf_e_doc_cleunik=0;vf_e_nombre=0;
  fa_value_set("tb_emplacement","");
  fa_value_set("tb_titre","");
  fa_value_set("tb_descriptif_sommaire","");
  fa_value_set("la_dateheurecreation","");
  fa_value_set("la_dateheuremodif","");
  fa_value_set("tb_hash","");
  fa_value_set("la_tailledoc","");
  fa_value_set("tb_origine","");
  fa_value_set("rdg_actif","1");
  vf_e_droits_proprio=0;
  fa_ds("criteres_des_ged_entreprise","");
  fa_ds("criteres_des_ged_lesautres","");
  fa_ds("criteres_des_ged_lesmiens","");
  fa_ds("criteres_des_ged_tous","");
  fa_att_set("tb_hash_verifie","class","ak17");
  fa_att_set("ifr_image","src","_graal_page_blanche_01.php");
	fa_att_set("tab_criteres","label","$vl_c_aak_122");
	fa_att_set("tab_commentaires","label","$vl_c_aak_126");
	fa_att_set("tab_connexions","label","$vl_c_aak_132");
	fa_att_set("tab_appartenance","label","$vl_c_aak_131");

}
function pf_retour_fenetre_image(vv_t_tableau_cleunik) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vv_t_tableau_cleunik.length!=0) {
    fa_gid("dk_02").selectedIndex=1;
    fa_cache_non("tab_criteres");fa_cache_non("tab_commentaires");fa_cache_non("tab_appartenance");if ("$vl_c_quelsdocs"=="image_articl"){fa_cache_non("tab_image");}
    fa_xmlhttprequest_xml(vf_c_script_edite,"vl_e_doc_cleunik="+vv_t_tableau_cleunik[0]+"&",pf_affiche_datas);
  }
}
function pf_retour_fenetre_docs(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  var vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    switch (vf_c_retour) {
      case "ouverture":
        fa_gid("dk_02").selectedIndex=1;
        fa_cache_non("tab_criteres");fa_cache_non("tab_commentaires");fa_cache_non("tab_appartenance");
		fa_grise_oui("tb_ouvre_fichier");fa_grise_oui("tb_ouvre_fichier_ged");
        fa_xmlhttprequest_xml(vf_c_script_edite,"vl_e_doc_cleunik="+vv_t_tableau_cleunik[0]+"&",pf_affiche_datas);
        break;
      case "connexion":
		  	pf_retour_connecte_docs(vv_t_tableau_cleunik);
        break;
    }
  }
}
function pf_retour_fenetre_dossiers(vv_t_tableau_cleunik) {
  var vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
	for(var i=0;i<vl_e_nb_sel;i++){                      /* loop 'em */
      var vl_c_donnees=vv_t_tableau_cleunik[i]+"&cleunik_insertion_dossier="+fa_enc(vf_e_doc_cleunik)+"&label_insertion_dossier="+fa_value_get("tb_emplacement")+"("+fa_enc(fa_value_get("tb_titre"))+")";
      fa_xmlhttprequest_txt(c_bdope_dossiers+vl_c_donnees,"",pf_retour_fenetre_dossiers_fin);
    }
  }
}
function pf_retour_fenetre_dossiers_fin(stream){
	alert(stream)
}
function pf_retour_connecte_docs(vv_t_tableau_cleunik){
	var vl_c_donnees="vf_c_action=connecter_kilometre&";
	vl_c_donnees+="vl_t_doc="+fa_enc(fa_jsarray2php_00(vv_t_tableau_cleunik))+"&";
	vl_c_donnees+="vl_e_doc_cleunik_gauche="+vf_e_doc_cleunik+"&";
  fa_xmlhttprequest_xml(c_script_connecte,vl_c_donnees,pf_affiche_donnees_connexions);
}
function pf_retour_fenetre_notes(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  var vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    pf_retour_connecte_docs(vv_t_tableau_cleunik);
  }
}
function pf_retour_fenetre_pseudodocs(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  var vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    pf_retour_connecte_docs(vv_t_tableau_cleunik);
  }
}
function pf_sel_ligne(vv_objet) {
  if(fa_est_grise("bt_detailler")==true){return};
  var rowIndex = fa_cui("arbre_des_docs");if(rowIndex == -1){return;}
  vf_e_doc_cleunik=fa_cell_get("arbre_des_docs",rowIndex,"doc_cleunik");
  var s ="vl_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_telecharge(){
  if (vf_e_doc_cleunik!=0){
    pf07_telecharge_doc(vf_e_doc_cleunik);
  }
  else {
    alert("Aucun fichier n'est sélectionné !!!");
  }
}
function pf_validation(vv_quoi){
  var s="";
  switch(vv_quoi){
    case "enregistrer":
      if (fa_gid("tb_emplacement").value ==''){alert('Votre saisie n\'a pas de sens!');fa_focusdonne("tb_emplacement");return;}
      if (vf_e_doc_cleunik==0){
        vf_c_action="ajouter";
          fa_grise_oui("bt_annuler");
          fa_grise_oui("bt_enregistrer");
					fa_grise_fenetre("","oui");
          window.setTimeout('pf_validation_upload()',250);
      } else {
        s+="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
        s+="vf_c_emplacement="+fa_enc(fa_value_get("tb_emplacement"))+"&";
        s+="vf_c_titre="+fa_enc(fa_value_get("tb_titre"))+"&";
        s+="vf_c_descriptif_sommaire="+fa_enc(fa_value_get("tb_descriptif_sommaire"))+"&";
        s+="&vf_c_hash="+fa_enc(fa_value_get("tb_hash"))+"&";
        s+="&vf_c_origine="+fa_enc(fa_value_get("tb_origine"))+"&";
		s+="&vf_c_actif="+fa_enc(fa_value_get("rdg_actif"))+"&";
        s+="vf_c_action="+fa_enc("modifier")+"&";
        fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
      }
      return;
      break;
    case "attacher":
      vf_c_action="attacher";
      s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
      s +="vf_c_action=attacher&";
      fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
      break;
    case "detacher":
      vf_c_action="detacher";
      s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
      s +="vf_c_action=detacher&";
      fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
      break;

    case "supprimer":
      if(confirm("Confirmez-vous la suppression de ce document ?") == false) return;
      vf_c_action="supprimer";
      s +="vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
      s +="vf_c_action=supprimer&";
      fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
      break;
  }     
}
function pf_validation_upload(){
  fa_att_set("_graal_fen_doc_07","wait-cursor","true");
  fa03_fichier_lit_et_envoie(vf_c_upload_doc,pf_validation_upload_fin,fa_value_get("tb_emplacement"));
}
function pf_validation_upload_fin(stream) {
  var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  fa_grise_non("bt_annuler");
  fa_grise_non("bt_enregistrer");
  fa_gid("_graal_fen_doc_07").removeAttribute("wait-cursor");
  if (window.opener!=null) {
  try {  
      	window.opener.pf_affiche_donnees_ged();
      } catch (e) {
		//alert(e)
    //return null
	}	
  }
  if (tableau_retour[0]!=0) {
    alert("Document téléchargé ...");
		fa_grise_fenetre("","non");
    vf_e_doc_cleunik=tableau_retour[0];
    pf_validation("enregistrer");
  } else {
    alert(tableau_retour[1]);
		fa_grise_fenetre("","non");
  }
}
function pf_verif_acces(){
	if ("$vl_c_tab_hidden"=="false") {
		var rowIndex = fa_cui("arbre_des_docs");if(rowIndex == -1){return;}
	}
	if ((vf_c_typedoc=="13") || (vf_c_typedoc=="153")|| (vf_c_typedoc=="154")) {
		pf_verif_acces_fin(15);
	} else {
	  if (vf_e_doc_cleunik==0){return;}
		var s ="vf_c_action=verifier_droits_acces&vf_e_doc_cleunik="+fa_enc(vf_e_doc_cleunik)+"&";
	  fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_verif_acces_fin);
	}
}
function pf_verif_acces_fin(stream) {
  var vl_c_datas=stream;
  vf_e_droits_proprio=vl_c_datas;
  pf_etat_fen("selectionner_suite");
}
function pf_verif_hash(){
  var s ="vf_c_action=verifier_hash&vf_c_hash="+fa_enc(fa_value_get("tb_hash"))+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_verif_hash_fin);
}
function pf_verif_hash_fin(stream) {
  var vl_c_param=stream;
  fa_grise_oui("tb_ouvre_fichier");fa_grise_oui("tb_ouvre_fichier_ged");
  var tableau_retour=vl_c_param.split('|');
  if (tableau_retour[0]==0) {
    fa_att_set("tb_hash_verifie","class","ak16");
  } else {
    alert("Attention !!! Existe déjà dans la base ...");
    fa_gid("dk_02").selectedIndex=1;
    fa_cache_non("tab_criteres");fa_cache_non("tab_commentaires");fa_cache_non("tab_appartenance");fa_cache_non("tab_connexions");if ("$vl_c_quelsdocs"=="image_articl"){fa_cache_non("tab_image");}
    fa_xmlhttprequest_xml(vf_c_script_edite,"vl_e_doc_cleunik="+tableau_retour[1]+"&",pf_affiche_datas);
  }
}
function pf_visualise(){
  if (vf_e_doc_cleunik!=0){
    pf07_visualise_doc(vf_e_doc_cleunik);
  }
  else {
    alert("Aucun fichier n'est sélectionné !!!");
  }
	
}
]]></script>
END;
?>
