<?php
$pf_init_01="";
if ($vl_c_qui!="eux") {   
  $pf_init_01=<<<EOT
  vf_e_uti_cleunik=$vl_e_uti_cleunik;
  pf_alimente_table("arbre_des_comptes_courriels");
EOT;
} else {
$pf_init_01=<<<EOT
  pf_alimente_table("arbre_des_utilisateurs");
EOT;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope='_graal_bdope_comptes_courriels_01.php?vl_e_genre=$vl_e_genre&';
const vf_c_script_edite='_graal_xml_comptes_courriels_01.php?vl_e_genre=$vl_e_genre&';
const vf_c_script_alim_table01='_graal_das_utilisateurs_01.php?';
const vf_c_script_alim_table02='_graal_das_comptes_courriels_01.php?vl_e_genre=$vl_e_genre&';
const c_script_test_envoi='_graal_exe_courriel_envoie_test.php?';
const c_script_test_recep='_graal_exe_courriel_recept_test.php?';
const c_script_droits='_graal_fen_comptes_courriels_droits_01.php?';
const c_script_changer_motpasse='_graal_fen_modif_idcon_02.php?vl_e_genre=$vl_e_genre&';
var vf_c_action;
var vf_c_genre;
var vf_e_uti_cleunik,vf_e_uticptbal_cleunik,vf_e_nombre;
const lstn_grise = {
	willRebuild : function(event){}, 
	didRebuild  : function(event){fa_att_rem("_graal_comptes_courriels_01","cursor-wait");fa_grise_fenetre(event,"non");} 
}
function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  fa_value_set("tb_titre",fa_xml_get(vl_c_datas,'titre'));
  fa_att_set("tb_titre","_graal_cleunik",vf_e_uticptbal_cleunik);
  fa_value_set("tb_serveursmtp",fa_xml_get(vl_c_datas,'smtp'));
  fa_value_set("tb_sendfrom",fa_xml_get(vl_c_datas,'from'));
  fa_value_set("tb_nomemetteur",fa_xml_get(vl_c_datas,'nomemetteur'));
  fa_value_set("tb_courrielemetteur",fa_xml_get(vl_c_datas,'emetteur'));
  fa_value_set("tb_courrielreponse",fa_xml_get(vl_c_datas,'adressereponse'));
  fa_value_set("tb_courrielretour",fa_xml_get(vl_c_datas,'cheminretour'));
  fa_value_set("tb_courrielerreurs",fa_xml_get(vl_c_datas,'adresseerreurs'));
  fa_value_set("tb_courrielconfirmationlecture",fa_xml_get(vl_c_datas,'adresseconfirmationlecture'));
  fa_value_set("tb_serveurpop3",fa_xml_get(vl_c_datas,'serveurpop3'));
  fa_value_set("tb_utilisateurpop3",fa_xml_get(vl_c_datas,'utilisateurpop3'));
  fa_value_set("tb_motdepassepop3",fa_xml_get(vl_c_datas,'motdepassepop3'));
  fa_value_set("tb_portsmtp",fa_xml_get(vl_c_datas,'port_smtp'));
  fa_value_set("tb_portpop",fa_xml_get(vl_c_datas,'port_pop'));
  fa_mlsel("ml_type_compte",fa_xml_get(vl_c_datas,'type_compte'),"value");
	fa_cache_non('tb_changerpwd');
	fa_grise_oui('tb_motdepassepop3');
  var vl_e_pop_ssl=fa_xml_get(vl_c_datas,'pop_ssl');
  fa_att_set('ra_pop_ssl_oui',"selected", 'false');
  fa_att_set('ra_pop_ssl_non',"selected", 'false');
  switch(vl_e_pop_ssl) {
   case "1": fa_att_set('ra_pop_ssl_oui',"selected", 'true');fa_value_set('rdg_pop_ssl',1);  break;
   case "2": fa_att_set('ra_pop_ssl_non','selected', 'true');fa_value_set('rdg_pop_ssl',2);  break;
   default : fa_att_set('ra_pop_ssl_non','selected', 'true');fa_value_set('rdg_pop_ssl',2);  break;
  }

}
function pf_alimente_defaut() {
  fa_value_set("tb_portsmtp","25");
  fa_value_set("tb_portpop","110");
  fa_att_set('ra_pop_ssl_oui',"selected", 'false');
  fa_att_set('ra_pop_ssl_non','selected', 'true');
}
function pf_alimente_table(vv_laquelle){
  var raf_random=Math.random();
  switch (vv_laquelle){
    case "arbre_des_utilisateurs":
      fa_das(vv_laquelle,vf_c_script_alim_table01+'raf01='+Math.random());
      break;
    case "arbre_des_comptes_courriels":
			fa_grise_fenetre("","oui");
			fa_att_set("_graal_comptes_courriels_01","cursor-wait");
      fa_das(vv_laquelle,vf_c_script_alim_table02+'vl_e_uti_cleunik='+vf_e_uti_cleunik+'&raf01='+Math.random());
      break;
  }
}
function pf_changer_mot_de_passe(){
	var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
	if (vl_e_uticptbal_cleunik==-1) {return;}
  fa_ouvre(c_script_changer_motpasse+"vl_e_uticptbal_cleunik="+vl_e_uticptbal_cleunik,500,100);
}
function pf_droits() {
  var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
  if (vl_e_uticptbal_cleunik==-1) {return;}
  fa_ouvre(c_script_droits+"vl_e_uticptbal_cleunik="+vl_e_uticptbal_cleunik,400,400);

}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
  var vl_e_rowIndex;
  switch(vv_quoi) {
    case "ini":
			vf_e_uticptbal_cleunik=-1;
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_groupe_oui('broadcaster_01');
			fa_gid("arbre_des_comptes_courriels").builder.addListener(lstn_grise);
      $pf_init_01
      break;
    case "selectionner":
			if (vf_e_uticptbal_cleunik==-1){return;}
      if (vf_e_nombre==0) {fa_grise_non("bt_supprimer");}
      fa_grise_non("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne('tb_titre');
			fa_grise_oui('tb_motdepassepop3');
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne('tb_titre');
			fa_cache_oui('tb_changerpwd');
			fa_grise_non('tb_motdepassepop3');
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_detailler");
      fa_grise_groupe_oui('broadcaster_01');
      pf_raz_fiche();
      break;
    case "sortir":
     window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
     //window.history.back(); //  Ne fonctionne que si cette fenetre est une fenetre appellée dans la même fenêtre
     break;   
 default:
 pf_montre_saisie();
 break;
}
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=='ok') {
    pf_alimente_table("arbre_des_comptes_courriels");
  }
  else {
    fa_erreur(vl_datas)
  }
  pf_etat_fen('annuler');
}
function pf_raz_fiche(){
  fa_att_set("tb_titre","_graal_cleunik","-1");
	vf_e_uticptbal_cleunik=-1;
  fa_value_set("tb_titre","");
  fa_value_set("tb_serveursmtp","");
  fa_value_set("tb_sendfrom","");
  fa_value_set("tb_nomemetteur","");
  fa_value_set("tb_courrielemetteur","");
  fa_value_set("tb_courrielreponse","");
  fa_value_set("tb_courrielretour","");
  fa_value_set("tb_courrielerreurs","");
  fa_value_set("tb_courrielconfirmationlecture","");
  fa_value_set("tb_serveurpop3","");
  fa_value_set("tb_utilisateurpop3","");
  fa_value_set("tb_motdepassepop3","");
  fa_value_set("tb_portsmtp","");
  fa_value_set("tb_portpop","");

}
function pf_sel_ligne(vv_laquelle){
  switch (vv_laquelle){
  case "arbre_des_utilisateurs":
    var rowIndex =fa_cui("arbre_des_utilisateurs");if(rowIndex==-1){return;}
    vf_e_uti_cleunik=fa_cell_get("arbre_des_utilisateurs",rowIndex,"uti_cleunik");
    pf_alimente_table("arbre_des_comptes_courriels");
    break;
  case "arbre_des_comptes_courriels":
    if(fa_est_grise("bt_detailler")==true){return};
    var rowIndex = fa_cui("arbre_des_comptes_courriels");if(rowIndex == -1){return;}
    vf_e_uticptbal_cleunik=fa_cell_get("arbre_des_comptes_courriels",rowIndex,"uticptbal_cleunik");
    vf_e_nombre=fa_cell_get("arbre_des_comptes_courriels",rowIndex,"nombre");
    var s =fa_enc("vl_e_uticptbal_cleunik")+"="+vf_e_uticptbal_cleunik+"&raf01="+Math.random();
    fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
  }
}
function pf_test_emis() {
  var s="";
  s+="vl_c_serveursmtp="+fa_enc(fa_value_get("tb_serveursmtp"))+"&";
  s+="vl_c_sendfrom="+fa_enc(fa_value_get("tb_sendfrom"))+"&";
  s+="vl_c_nomemetteur="+fa_enc(fa_value_get("tb_nomemetteur"))+"&";
  s+="vl_c_courrielemetteur="+fa_enc(fa_value_get("tb_courrielemetteur"))+"&";
  s+="vl_c_port_smtp="+fa_enc(fa_value_get("tb_portsmtp"))+"&";
  s+="vl_c_destinataire="+fa_enc(prompt('Courriel du destinataire',''))+"&";
  s+="raf01="+Math.random();
  fa_xmlhttprequest_txt(c_script_test_envoi,s,pf_test_emis_fin);
}
function pf_test_emis_fin(stream) {
  alert(stream);
}
function pf_test_rece() {
  var vl_c_pop_ssl=fa_value_get('rdg_pop_ssl');
  if (vl_c_pop_ssl=='') {vl_c_pop_ssl=2};
  var s="";
  s+="vl_e_uticptbal_cleunik="+fa_att_get("tb_titre","_graal_cleunik")+"&";
  s+="vl_c_serveurpop3="+fa_enc(fa_value_get("tb_serveurpop3"))+"&";
  s+="vl_c_port_pop="+fa_enc(fa_value_get("tb_portpop"))+"&";
  s+="vl_c_utilisateurpop3="+fa_enc(fa_value_get("tb_utilisateurpop3"))+"&";
  s+="vl_c_pop_ssl="+fa_enc(vl_c_pop_ssl)+"&";
  s+="raf01="+Math.random();
  fa_xmlhttprequest_txt(c_script_test_recep,s,pf_test_rece_fin);
}
function pf_test_rece_fin(stream) {
  alert(stream);
}
function pf_onunload(){
	fa_brl("arbre_des_comptes_courriels",lstn_grise);
}
function pf_validation(vv_quoi){
  var s;
  var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
  var vl_c_pop_ssl=fa_value_get('rdg_pop_ssl');
  if (vl_c_pop_ssl=='') {vl_c_pop_ssl=2};
  s="";
  s+="vl_e_uticptbal_cleunik="+vl_e_uticptbal_cleunik+"&";
  s+="vl_e_uti_cleunik="+vf_e_uti_cleunik+"&";
  s+="vl_c_titre="+fa_enc(fa_value_get("tb_titre"))+"&";
  s+="vl_c_serveursmtp="+fa_enc(fa_value_get("tb_serveursmtp"))+"&";
  s+="vl_c_sendfrom="+fa_enc(fa_value_get("tb_sendfrom"))+"&";
  s+="vl_c_nomemetteur="+fa_enc(fa_value_get("tb_nomemetteur"))+"&";
  s+="vl_c_courrielemetteur="+fa_enc(fa_value_get("tb_courrielemetteur"))+"&";
  s+="vl_c_courrielreponse="+fa_enc(fa_value_get("tb_courrielreponse"))+"&";
  s+="vl_c_courrielretour="+fa_enc(fa_value_get("tb_courrielretour"))+"&";
  s+="vl_c_courrielerreurs="+fa_enc(fa_value_get("tb_courrielerreurs"))+"&";
  s+="vl_c_courrielconfirmationlecture="+fa_enc(fa_value_get("tb_courrielconfirmationlecture"))+"&";
  s+="vl_c_serveurpop3="+fa_enc(fa_value_get("tb_serveurpop3"))+"&";
  s+="vl_c_utilisateurpop3="+fa_enc(fa_value_get("tb_utilisateurpop3"))+"&";
  s+="vl_c_motdepassepop3="+fa_enc(fa_value_get("tb_motdepassepop3"))+"&";
  s+="vl_c_port_smtp="+fa_enc(fa_value_get("tb_portsmtp"))+"&";
  s+="vl_c_type_compte="+fa_enc(fa_mlget("ml_type_compte","value"))+"&"
  s+="vl_c_port_pop="+fa_enc(fa_value_get("tb_portpop"))+"&";
  s+="vl_c_pop_ssl="+fa_enc(vl_c_pop_ssl)+"&";
  switch(vv_quoi) {
     case "enregistrer":
      if (vl_e_uticptbal_cleunik!=-1) {
        s +="vl_c_action=modifier&";
      }
      else {
         s +="vl_c_action=ajouter&";
      }
      break;
     case "supprimer":
       if(confirm("Confirmez-vous la suppression de ce compte courriel ?") == false) return;
       s =fa_enc("vl_c_action")+"="+fa_enc('supprimer')+"&";
       s +=fa_enc("vl_e_uticptbal_cleunik")+"="+fa_enc(vl_e_uticptbal_cleunik);
      break;
 }     
fa_xmlhttprequest_txt(vf_c_script_bdope,s,pf_fin_requete);
}
]]></script>
END;
?>
