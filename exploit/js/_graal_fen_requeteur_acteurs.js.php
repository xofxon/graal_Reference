<?php
$vl_c_00002=fa_recup_session('mess_00002','');
$vl_c_00011=fa_recup_session('mess_00011','');
$vl_c_dico00020=fa_recup_dico_js("dico_00020");
$vl_c_dico00021=fa_recup_dico_js("dico_00021");
$vl_c_dico00022=fa_recup_dico_js("dico_00022");
$vl_c_dico00023=fa_recup_dico_js("dico_00023");
$vl_c_dico00024=fa_recup_dico_js("dico_00024");
$vl_c_dico00025=fa_recup_dico_js("dico_00025");
$vl_tb_droits_02=_graal_requete_droits_fenetre("Fen_00260",$vl_e_uti_cleunik);$vl_e_ajout_02=$vl_tb_droits_02[1];$vl_e_modif_02=$vl_tb_droits_02[2];//Prospects clients
$vl_tb_droits_03=_graal_requete_droits_fenetre("Fen_00262",$vl_e_uti_cleunik);$vl_e_ajout_03=$vl_tb_droits_03[1];$vl_e_modif_03=$vl_tb_droits_03[2];//Clients
$vl_tb_droits_04=_graal_requete_droits_fenetre("Fen_00261",$vl_e_uti_cleunik);$vl_e_ajout_04=$vl_tb_droits_04[1];$vl_e_modif_04=$vl_tb_droits_04[2];//Prospects fournisseurs
$vl_tb_droits_05=_graal_requete_droits_fenetre("Fen_00263",$vl_e_uti_cleunik);$vl_e_ajout_05=$vl_tb_droits_05[1];$vl_e_modif_05=$vl_tb_droits_05[2];//fournisseurs
$vl_tb_droits_06=_graal_requete_droits_fenetre("Fen_00264",$vl_e_uti_cleunik);$vl_e_ajout_06=$vl_tb_droits_06[1];$vl_e_modif_06=$vl_tb_droits_06[2];//Autres acteurs
$vl_tb_droits_07=_graal_requete_droits_fenetre("Fen_00265",$vl_e_uti_cleunik);$vl_e_ajout_07=$vl_tb_droits_07[1];$vl_e_modif_07=$vl_tb_droits_07[2];//Acteurs indéterminés
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_url_arbre='_graal_das_criteres_acteurs.php?';
const vf_c_url_arbre_choix='_graal_das_choix_critere_01.php?genre=acteurs&';
const vf_c_script_edite='_graal_xml_criteres_00.php';
const vf_c_script_bdope_criteres='_graal_bdope_criteres_00.php';
var vf_e_critere_cleunik=0;
var vf_e_nombre_utilisations;
var vf_c_arbre;
var vf_t_panier=[];
function pf_affiche_datas_critere(stream) { //  Affchage critères des acteurs
  var vl_c_datas;
  var vl_c_type_acteurs;
  var vl_e_nombre,vl_e_portee;
  pf_raz_fiche(2);
  vl_c_datas = stream;
  fa_value_set('la_critere_code',fa_xml_get(vl_c_datas,'critere_code'));
  fa_value_set('la_critere_denomination',fa_xml_get(vl_c_datas,'critere_denomination'));
  vl_e_portee=fa_xml_get(vl_c_datas,'critere_portee')
  if ((vl_e_portee &   2) ==   2) {fa_grise_non('ch_n02')}
  if ((vl_e_portee &   4) ==   4) {fa_grise_non('ch_n03')}
  if ((vl_e_portee &   8) ==   8) {fa_grise_non('ch_n04')}
  if ((vl_e_portee &  16) ==  16) {fa_grise_non('ch_n05')}
  if ((vl_e_portee &  32) ==  32) {fa_grise_non('ch_n06')}
  if ((vl_e_portee &  64) ==  64) {fa_grise_non('ch_n07')}
  vf_e_nombre_utilisations=0;
  for (i=1; i<=6; i++){
  	try {
  		vl_e_nombre=fa_xml_get(vl_c_datas,('nombre_utilisations_'+i));
  		vf_e_nombre_utilisations+=vl_e_nombre;
      vl_c_type_acteurs=fa_xml_get(vl_c_datas,('typeacteur_'+i));
  		pf_affiche_nombre_portee(vl_c_type_acteurs,vl_e_nombre);
  	} catch (e) {
  		vl_e_nombre=0;
  	}
  }
}
function pf_affiche_nombre_portee(vv_c_type_acteurs,vv_e_nombre) {
  switch(vv_c_type_acteurs) {
   case '110001':  fa_check('ch_n02');fa_label('ch_n02',"$vl_c_dico00020 ("+vv_e_nombre+")");break;
   case '110003':  fa_check('ch_n03');fa_label('ch_n03',"$vl_c_dico00021 ("+vv_e_nombre+")");break;
   case '110002':  fa_check('ch_n04');fa_label('ch_n04',"$vl_c_dico00022 ("+vv_e_nombre+")");break;
   case '110004':  fa_check('ch_n05');fa_label('ch_n05',"$vl_c_dico00023 ("+vv_e_nombre+")");break;
   case '110005':  fa_check('ch_n06');fa_label('ch_n06',"$vl_c_dico00024 ("+vv_e_nombre+")");break;
   case '110006':  fa_check('ch_n07');fa_label('ch_n07',"$vl_c_dico00025 ("+vv_e_nombre+")");break;
  }
}
function pf_choix_ajoute() {
  var vl_t_tableau=[[]];
  var vl_e_nb_sel;
  var vl_e_no;
  vl_t_tableau=fa_lignes_selectionnees("arb_choix_criteres");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_choix=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_choix[i]=fa_cell_get("arb_choix_criteres",vl_t_tableau[i],"choix_cleunik");
    }
    var vl_t_panier=[];
    vl_t_panier=vf_t_panier;
    vf_t_panier=vl_t_panier.concat(vl_t_choix);
    var vl_c_param=vf_c_url_arbre_choix+'&vl_c_liste_cleunik='+fa_jsarray2php_00(vf_t_panier)+'&raf01='+Math.random()+'&vl_c_etat=2&vl_c_position=4&';
    fa_das("arb_choix_criteres_cible",vl_c_param);
  } 
}
function pf_choix_enleve() {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arb_choix_criteres_cible");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_panier=[];
    var vl_t_choix=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_choix[i]=fa_cell_get("arb_choix_criteres_cible",vl_t_tableau[i],"choix_cleunik");
    }
    var j=0;k=-1;
    for(i=0;i<vf_t_panier.length;i++) {
      if (vl_t_choix.indexOf(vf_t_panier[i])==-1) { 
        k++;
        vl_t_panier[k]=vf_t_panier[i];
      }  
    }
    vf_t_panier=vl_t_panier
    var vl_c_param=vf_c_url_arbre_choix+'&vl_c_liste_cleunik='+fa_jsarray2php_00(vf_t_panier)+'&raf01='+Math.random()+'&vl_c_etat=2&vl_c_position=4&';
    fa_das("arb_choix_criteres_cible",vl_c_param);
  }
}

function pf_alimente_defaut(vv_lequel){
switch (vv_lequel) {
  case 1:
    fa_value_set('rdg_presence_critere',"1");
    break;
}

fa_value_set('rdg_multiple',"2");
fa_value_set('rdg_horsliste',"2");
fa_value_set('rdg_perso',"2");
fa_value_set('rdg_codepertinent',2);
if ($vl_e_ajout_02==0) {fa_grise_oui('ch_n02')}
if ($vl_e_ajout_02==0) {fa_grise_oui('ch_n03')}
if ($vl_e_ajout_04==0) {fa_grise_oui('ch_n04')}
if ($vl_e_ajout_05==0) {fa_grise_oui('ch_n05')}
if ($vl_e_ajout_06==0) {fa_grise_oui('ch_n06')}
if ($vl_e_ajout_07==0) {fa_grise_oui('ch_n07')}
}
function pf_alimente_table_bbb(){
  var vl_c_param=vf_c_url_arbre_choix+'vl_c_critere_cleunik='+vf_e_critere_cleunik+'&vl_c_liste_cleunik=&raf01='+Math.random()+'&vl_c_etat='+fa_value_get('rdg_etat')+'&vl_c_position='+fa_value_get('rdg_position');
  fa_das("arb_choix_criteres",vl_c_param);
}
function pf_alimente_table_bcb(){
  var vl_c_param=vf_c_url_arbre+'vl_e_portee='+fa_value_get("bcb_ml_qui")+'&raf01='+Math.random()+'&vl_c_etat='+fa_value_get('rdg_etat_critere')+'&vl_c_position='+fa_value_get('rdg_position_critere');
  fa_das("arb_criteres",vl_c_param);
}
function pf_etat_fen(vv_quoi)  {
   var vl_e_rowIndex;
   vf_c_action=vv_quoi;
   switch(vv_quoi) {
     case "ini":
       vf_c_arbre = fa_gid('arb_criteres');
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
       fa_att_set("arb_choix_criteres","context","pop_choix_a_faire")
       fa_att_set("arb_choix_criteres_cible","context","pop_choix_faits")
       break;
     case "selectionner":
       vl_e_rowIndex=vf_c_arbre.currentIndex;
      if(vl_e_rowIndex == -1){
        return;
      }
     if (vf_e_nombre_utilisations==0) {fa_grise_non("bt_supprimer");}else{fa_grise_oui("bt_supprimer");}
     fa_grise_non("bt_modifier");
     fa_grise_oui("bt_ajouter");
     fa_grise_oui("bt_detailler");
     fa_grise_non("bt_annuler");
     fa_grise_oui("bt_sortir");
     fa_grise_oui("bt_enregistrer");
     break;
     case "annuler":
       fa_grise_non("bt_detailler");
       fa_grise_non("bt_ajouter");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
       pf_raz_fiche();
       break;
     case "ajouter":
       fa_value_set('rdg_etat_critere',2);
       fa_value_set('rdg_position_critere',2);
       fa_value_set('rdg_etat',2);
       fa_value_set('rdg_position',2);
       pf_alimente_defaut();
       pf_alimente_table_bcb();
       pf_voir_deck(1);
       break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_enregistrer");
      if ($vl_e_modif_02==0) {fa_grise_oui('ch_n02')}
      if ($vl_e_modif_02==0) {fa_grise_oui('ch_n03')}
      if ($vl_e_modif_04==0) {fa_grise_oui('ch_n04')}
      if ($vl_e_modif_05==0) {fa_grise_oui('ch_n05')}
      if ($vl_e_modif_06==0) {fa_grise_oui('ch_n06')}
      if ($vl_e_modif_07==0) {fa_grise_oui('ch_n07')}
      fa_focusdonne("tb_critere_denomination");
      break;
    case "sortir":
     window.close();
     break;   
  }
}
function pf_fin_requete(stream){
}
function pf_raz_fiche(vv_no_deck){
switch (vv_no_deck ) {
  case 2:   //  2° étape de la construction
    fa_value_set('la_critere_code',"");
    fa_value_set('la_critere_denomination',"");
    fa_uncheck('ch_n02')
    fa_uncheck('ch_n03')
    fa_uncheck('ch_n04')
    fa_uncheck('ch_n05')
    fa_uncheck('ch_n06')
    fa_uncheck('ch_n07')
    fa_grise_oui('ch_n02');
    fa_grise_oui('ch_n03');
    fa_grise_oui('ch_n04');
    fa_grise_oui('ch_n05');
    fa_grise_oui('ch_n06');
    fa_grise_oui('ch_n07');
    fa_label('ch_n02',"$vl_c_dico00020");
    fa_label('ch_n03',"$vl_c_dico00021");
    fa_label('ch_n04',"$vl_c_dico00022");
    fa_label('ch_n05',"$vl_c_dico00023");
    fa_label('ch_n06',"$vl_c_dico00024");
    fa_label('ch_n07',"$vl_c_dico00025");
    break;
  }
}
function pf_sel_ligne(vv_objet){
  var arbre = fa_gid(vv_objet);
  var rowIndex = arbre.currentIndex;
  if(rowIndex == -1){return;}
  switch (vv_objet) {
    case "arb_criteres" :
      vf_e_critere_cleunik=arbre.view.getCellText( rowIndex ,arbre.columns.getNamedColumn("critere_cleunik"));
      s ="vl_e_critere_cleunik="+fa_enc(vf_e_critere_cleunik)+"&";
      s+="vl_c_portee=acteurs&";
      fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas_critere);
      break;
  } 
}

function pf_validation(vv_quoi)
  {
  var s;
  var vl_c_portee;
  vl_c_portee=8192;
  if (fa_est_coche("ch_n02")==true) {vl_c_portee+=  2};
  if (fa_est_coche("ch_n03")==true) {vl_c_portee+=  4};
  if (fa_est_coche("ch_n04")==true) {vl_c_portee+=  8};
  if (fa_est_coche("ch_n05")==true) {vl_c_portee+= 16};
  if (fa_est_coche("ch_n06")==true) {vl_c_portee+= 32};
  if (fa_est_coche("ch_n07")==true) {vl_c_portee+= 64};
  if (vl_c_portee==8192) {alert("$vl_c_00011");return;}
  switch(vv_quoi) {
      case "enregistrer":
         s ="vl_c_action="+fa_enc(vf_c_action)+"&";
         s +="vl_critere_cleunik="+vf_e_critere_cleunik+"&";
         s +="vl_critere_code="+fa_enc(fa_value_get('tb_critere_code'))+"&";
         s +="vl_critere_denomination="+fa_enc(fa_value_get('tb_critere_denomination'))+"&"
         s +="vl_critere_type="+fa_enc(fa_gid("bcc_ml_type").selectedItem.value)+"&"
         s +="vl_critere_choixmultiples="+fa_enc(fa_value_get('rdg_multiple'))+"&"
         s +="vl_critere_blocnotebrut="+fa_enc(fa_value_get('tb_blocnotebrut'))+"&"
         s +="vl_critere_actif="+fa_enc(fa_value_get('rdg_actif'))+"&"
         s +="vl_critere_portee="+fa_enc(vl_c_portee)+"&"
         s +="vl_critere_hl="+fa_enc(fa_value_get('rdg_horsliste'))+"&"
         s +="vl_critere_perso="+fa_enc(fa_value_get('rdg_perso'))+"&"
         s +="vl_critere_codechoixpertinent="+fa_enc(fa_value_get('rdg_codepertinent'))+"&"
      break;
     case "supprimer":
       Check = confirm("$vl_c_00002");
       if(Check == false) return;
       s ="vl_c_action=supprimer&";
       s +="vl_critere_cleunik="+vf_e_critere_cleunik+"&";
      break;
}
fa_xmlhttprequest_txt(vf_c_script_bdope_criteres,s,pf_fin_requete);       
}
function pf_voir_deck(vv_lequel) {
  fa_gid("deck_requeteur").selectedIndex=vv_lequel;
}
function pf_voir_deck_construction_precedent(vv_lequel) {
  fa_gid("deck_construction").selectedIndex=vv_lequel;
}
function pf_voir_deck_construction_suivant(vv_lequel) {
  switch (vv_lequel) {
    case 1:
      //  Il faut avoir sélectionné un critère
      if (vf_e_critere_cleunik==0) {alert('Il faut sélectionner un critère !!!');return;}
      pf_alimente_defaut(vv_lequel);
      fa_gid("deck_construction").selectedIndex=vv_lequel;
      break;
    case 2:
      //  il faut avoir sélectionné au moins une portée d'acteurs
      var vl_c_portee;
      vl_c_portee=8192;
      if (fa_est_coche("ch_n02")==true) {vl_c_portee+=  2};
      if (fa_est_coche("ch_n03")==true) {vl_c_portee+=  4};
      if (fa_est_coche("ch_n04")==true) {vl_c_portee+=  8};
      if (fa_est_coche("ch_n05")==true) {vl_c_portee+= 16};
      if (fa_est_coche("ch_n06")==true) {vl_c_portee+= 32};
      if (fa_est_coche("ch_n07")==true) {vl_c_portee+= 64};
      if (vl_c_portee==8192) {alert("$vl_c_00011");return;}
      if (fa_value_get('rdg_presence_critere')==2) {
        //  On a décidé de selectionner les acteurs qui n'ont pas le critère, donc on saute l'étape de choix des choix de critères
        pf_alimente_defaut(3);
        fa_gid("deck_construction").selectedIndex=3;
      } else {
        pf_alimente_table_bbb();
        pf_alimente_defaut(vv_lequel);
        fa_gid("deck_construction").selectedIndex=vv_lequel;

      }
  }
}
]]></script>
END;
?>
