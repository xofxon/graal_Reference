<?php
switch ($vl_quoi){
	case "creation_dep_emp_regul_inventaire":
		$pf_affiche_fenetre_mere=<<<EOT
if (window.opener!=null) {
try {
	window.opener.pf_rafraichir();
} catch(e){}}
EOT;
		break;
	default:
		$pf_affiche_fenetre_mere=<<<EOT
if (window.opener!=null) {
try {
	window.opener.pf_affiche_donnees_stock();
	window.opener.pf_affiche_donnees_dep_emp();
} catch(e){}}
EOT;
		break;
}

echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_art_mousto_01.php?";
const c_script_das_mousto="_graal_das_art_mousto.php?";
var vf_c_action,vf_c_url_alimente_table;
var vf_e_art_cleunik;
const c_script_tar_valorisation_mousto="_graal_das_art_tarifs_type_nomenc.php?";
var lstn = { 
    willRebuild : function(event){pf_cons_ml_mousto_base_valorisation_a_faire(event);},
    didRebuild  : function(event){pf_cons_ml_mousto_base_valorisation_faite(event);} 
  };
function pf_aa_init() {
  fa_sep("tb_qte_mvt");
  fa_sep("tb_pu_mvt");
  fa_sep("tb_mt_mvt");
  fa_cache_oui("portee");
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  vf_e_art_cleunik=$vl_e_art_cleunik;
  pf_affiche_donnees_mousto();
  pf_maintenant("tb_debut_maintenant");
  if ("$vl_gestion_dep_emp"==2) {
    fa_grise_oui('ml_depot');
    fa_grise_oui('ml_empla');
  }
  var s="";
  s+="actif=1&vl_art_cleunik="+$vl_e_art_cleunik+"&"
  fa_badl("ml_mousto_base_valorisation",lstn);
  fa_das("ml_mousto_base_valorisation",c_script_tar_valorisation_mousto+s);
  fa_focusdonne("tb_qte_mvt");
}
function pf_affiche_donnees_mousto() {
  var vl_c_param=c_script_das_mousto+"vl_art_cleunik="+vf_e_art_cleunik+"&raf_random="+Math.random()+"&";
  fa_das("arbre_des_mousto",vl_c_param);
}
function pf_change_menu_actifs_mousto_base_valorisation() {
  var vo_list = fa_gid("ml_mousto_base_valorisation")
  var vo_item = vo_list.selectedItem;
  vo_list.setAttribute("class",vo_item.getAttribute("class"))
  fa_value_set("tb_pu_mvt",vo_item.getAttribute("_graal_base_valorisation"));
  pf_mousto_valorise();
}
function pf_cons_ml_mousto_base_valorisation_a_faire(event){
  //raf doir exister mais ne sert à rien
}
function pf_cons_ml_mousto_base_valorisation_faite(event) {
  //var vf_e_timeout=200;
  //setTimeout('pf_cons_ml_mousto_base_valorisation_faite_suite()',vf_e_timeout)
  pf_cons_ml_mousto_base_valorisation_faite_suite(); 
}
function pf_cons_ml_mousto_base_valorisation_faite_suite() {
  fa_gid("ml_mousto_base_valorisation").selectedIndex=1;
  fa_value_set("tb_pu_mvt",fa_gid("ml_mousto_base_valorisation").selectedItem.getAttribute("_graal_base_valorisation"));
  pf_mousto_valorise()
}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "sortir":
      window.close();
      break;
  }
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=="-1"){alert(vl_datas);}
  pf_affiche_donnees_mousto();
  $pf_affiche_fenetre_mere
}
function pf_maintenant(vv_qui) {
  var ladate_deb=new Date();
  var vl_c_date=ladate_deb.getFullYear()+"-"+(ladate_deb.getMonth()+1)+"-"+ladate_deb.getDate();
  var vl_c_heur=ladate_deb.getHours()+":"+fa_padleft('0', 2,ladate_deb.getMinutes().toString())+":"+fa_padleft('0', 2,ladate_deb.getSeconds().toString());
  switch (vv_qui) {
    case "tb_debut_maintenant" :
      fa_value_set('dp_dat_deb',vl_c_date);
      fa_value_set('tb_heu_deb',vl_c_heur);
      break;
  }
}
function pf_mousto_valorise() {
  var vl_valeur_ref=Number(fa_value_get("tb_pu_mvt"));
  var vl_quantite=Number(fa_value_get("tb_qte_mvt"));
  var vl_valeur_ligne= new Number(vl_valeur_ref*vl_quantite)
  fa_value_set("tb_mt_mvt",vl_valeur_ligne);
}
function pf_onunload(){
	fa_brl("ml_mousto_base_valorisation",lstn);
}
function pf_raz_fiche(){
  fa_value_set("tb_blocnotebrut",'')
}
function pf_validation(vv_quoi){
  if (vf_e_art_cleunik=='-1') {alert("Sélectionnez un article !!");return;}
  var vl_c_donnees;
  vl_c_donnees="";
  vl_c_donnees+="vl_art_cleunik="+vf_e_art_cleunik+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_value_get("tb_blocnotebrut"))+"&";
  vl_c_donnees+="vl_date_mvt="+fa_enc(fa_value_get("dp_date_deb")+" "+fa_value_get("tb_heu_deb"))+"&";
  vl_c_donnees+="vl_choix_depot="+fa_enc(fa_mlget("ml_depot"))+"&";
  vl_c_donnees+="vl_choix_empla="+fa_enc(fa_mlget("ml_empla"))+"&";
  vl_c_donnees+="vl_qte_mvt="+fa_enc(fa_value_get("tb_qte_mvt"))+"&";
  vl_c_donnees+="vl_pu_mvt="+fa_enc(fa_value_get("tb_pu_mvt"))+"&";
  vl_c_donnees+="vl_genre_mvt="+fa_enc(fa_mlget("ml_genre_mvt"))+"&";
  vl_c_donnees+="vl_type_mvt="+fa_enc(fa_mlget("ml_type_mvt","value"))+"&";
  vl_c_donnees+="vf_c_action=ajouter&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
