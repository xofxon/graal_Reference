<?php
$var_rc='\r\n';
$var_0d='\n';
$rExp ="\x0d\x0a";
$vl_c_init="";
if ($vl_e_intweb_cleunik!=-1) {
	$vl_c_init="fa_focusdonne('tb_sujet');vf_c_liste_en_cours='li_dest_a';fa_xmlhttprequest_xml(vf_c_script_edite_intweb+$vl_e_intweb_cleunik,'',pf_sel_courriel_fin);";
} else {
	$vl_c_init="";
}
switch ($vl_doc_cleunik){
	case -99999:
		break;
	default:
		$vl_c_init.=<<<EOT
		var t=[];t[0]=$vl_doc_cleunik;
		var n=[];n[0]='$vl_c_nomdoc';
		pf_retour_fenetre_pj(t,n);
EOT;
		break;
}
$vl_tb_reg_00007=_graal_requete_regle("Reg_00007"); //  Envoi systématique d'une demande de confirmation de lecture
if ($vl_tb_reg_00007[0]==1) {
  $defaut_confirmation_lecture="fa_value_set('rdg_confirmation_lecture',1);";
} else {
  $defaut_confirmation_lecture="fa_value_set('rdg_confirmation_lecture',2);";
}
$vl_c_bak_155js=fa_recup_dico_js("bak_155");
$vl_c_bak_156js=fa_recup_dico_js("bak_156");
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
*********************************************************************
**********  Fenêtre de gestion de la création des courriels  ********
*********************************************************************
*/
var vf_c_script_edite_note='_graal_bdope_note_03.php';
const vf_c_script_edite='_graal_xml_modeles_courriels_01.php';
const vf_c_script_intweb='_graal_xml_modeles_courriels_01.php';
const vf_c_script_das_courriel="_graal_das_courriel_01.php?";
const vf_c_script_edite_intweb='_graal_xml_act_interlo_mail_02.php?vl_e_intweb_cleunik=';
const c_fen_panier_intweb='_graal_traitements_courriel_01.php?genreacteur=';
const c_script_var='_graal_cree_variable_session_tempo.php?';
const c_script_modele_reponse='_graal_cree_variable_session_tempo_texte.php';
const c_script_hash_doc='_graal_bdope_pj_hash_01.php?vf_c_hash=';
const c_upload_pj="_graal_upload_pj.php?";
const c_script_envoie_courriel="_graal_exe_courriel_envoie.php?";
const c_fen_panier_pj="_graal_fen_rech_piecesjointes_01.php?type=select&";
const c_fen_selection_notes="_graal_fen_ged_01.php?genreged=tousss&quelsdocs=notes&retour=oui&";
const c_fen_selection_docs="_graal_fen_ged_01.php?genreged=tousss&quelsdocs=docs&retour=oui&selection=oui&";
var vf_c_liste_en_cours="",vf_indice_liste_pj=0,vf_b_suite=false,vf_b_validation_possible=false;
var vf_c_tableau_retour="";
var vf_nombre_pj=0,vf_t_cleunik=[],vf_nombre_pj_lues=0,vf_ligne_pj_a_lire=0;
var vf_c_bak_145="$vl_c_bak_145"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_146="$vl_c_bak_146"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_147="$vl_c_bak_147"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_148="$vl_c_bak_148"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_149="$vl_c_bak_149"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_150="$vl_c_bak_150"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_151="$vl_c_bak_151"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_152="$vl_c_bak_152"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_texte_cite="";
var vf_c_references=""; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_genre="$vl_c_genre";//  utilisé dans _graal_courriel_01_complement.js
var vf_c_sujet_ini="$vl_sujet_ini";//  utilisé dans _graal_courriel_01_complement.js
var vf_c_from="$vl_from";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_emimail_renvoi="_graal_xml_emimail_01.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_recmail_transfert="_graal_xml_recmail_01.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_html_renvoi="_graal_xml_emimail_02.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_text_renvoi="_graal_xml_emimail_03.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_html_reponse="_graal_xml_recmail_02.php?action_cleunik=$vl_e_action_cleunik&sortie=src&";//  utilisé dans _graal_courriel_01_complement.js
var vf_nombre_pj=0,vf_t_cleunik=[],vf_nombre_pj_lues=0,vf_ligne_pj_a_lire=0,vf_t_sequence=[];
var vf_c_brouillon;
function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  var vl_c_chaine=fa_xml_get(vl_c_datas,'blocnote_riche');
  var vl_c_sortie=vl_c_chaine.replace(/<br>/g, "$var_rc");
  vl_c_sortie=vl_c_sortie.replace(/#date#/g,fa05_dates_en_clair("date"));
  vl_c_sortie=vl_c_sortie.replace(/#heure#/g,fa05_dates_en_clair("heure"));
  vl_c_sortie=vl_c_sortie.replace(/#dateheure#/g,fa05_dates_en_clair("dateheure"));
  fa_value_set("tb_message",vl_c_sortie);
}
function pf_alimente_defaut(){
  fa_value_set("tb_sujet","$vl_sujet");
  switch ("$vl_c_type_courriel") {
    case "texte":
      pf_complement_01_texte();//  Dans _graal_courriel_01_complement.js
      break;
    case "html":
      fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';");
      //fa_att_set("content","src","_graal_page_blanche_01.php");
			switch ("$vl_c_genre") {
			  case "reponse":
					var texte=fa_gid("content").contentWindow.document.body.innerHTML;  //  Sans balises body etc : ok
					//vf_c_texte_cite="<blockquote type='cite'>"+texte+"</blockquote>";
					vf_c_texte_cite="<blockquote type='cite'>"+fa_gid("content").contentWindow.document.documentElement.innerHTML+"</blockquote>";	//	Avec balise body



					//vf_c_texte_cite=btoa(vf_c_texte_cite);
					//vf_c_texte_cite=btoa("<blockquote type='cite'>"+fa_gid("content").contentWindow.document.body.innerHTML+"</blockquote>");
		  		texte="<div>"+vf_c_bak_151+"</div><blockquote type='cite'>"+texte+"</blockquote><div>"+vf_c_bak_152+"</div>";
		  		fa_gid("content").contentWindow.document.body.innerHTML=texte;
			    break;
			  case "transfert":
					var texte=fa_gid("content").contentWindow.document.body.innerHTML;  //  Sans balises body etc : ok
				  var vl_c_from=vf_c_bak_147+vf_c_from;
				  var vl_c_date=vf_c_bak_148+pf_complement_extraction('["date:"]=>');
				  var vl_c_subject=vf_c_bak_149+vf_c_sujet_ini;
				  var toto="";
				  toto="<div>"+vf_c_bak_146+"</div><div>"+vl_c_from+"</div><div>"+vl_c_date+"</div><div>"+vl_c_subject+"</div><br>";
				  texte="<br><br><blockquote type='cite'>"+toto+texte+"</blockquote><div>";
				  fa_gid("content").contentWindow.document.body.innerHTML=texte;
					fa_xmlhttprequest_xml(c_script_edite_recmail_transfert,"",pf_complement_emimail_affiche_pj);
			    break;
			  case "normal":
			    break;
			  case "renvoi":
			  case "brouillon":
					fa_xmlhttprequest_xml(c_script_edite_emimail_renvoi,"",pf_complement_emimail_affiche_datas);
			    break;
				case "formulaire":
					var texte=pf_complement_html_entity_decode(fa_value_get("tb_cr"))
				  texte="<br><br><blockquote type='cite'>"+texte+"</blockquote><div>";
				  fa_gid("content").contentWindow.document.body.innerHTML=texte;

			}
      break;
  }
  fa_value_set("rdg_unpardestinataire",1);
  fa_value_set("rdg_uneactionpardestinataire",1);
  fa_value_set("rdg_priorite",0);
  fa_value_set("rdg_sensitivite",0);
  fa_value_set("rdg_integre_pj_sipossible",2);
  $defaut_confirmation_lecture

}
function pf_destinataires(){
  { //  Traitement des destinataires simples
    var listbox = fa_gid("li_dest_a");
    var count = listbox.getRowCount();
    var x, item1,tab_a;
    var vl_t_nom=[];
    var vl_t_courriel=[];
    var vl_t_intweb=[];
    var vl_t_int=[];
    for(x = 0; x < count; x++) {
      item1 = listbox.getItemAtIndex(x)
      vl_t_nom[x]=window.btoa(fa_enc(item1.childNodes[1].getAttribute('label')));
      vl_t_courriel[x]=item1.childNodes[0].getAttribute('label');
      vl_t_intweb[x]=item1.childNodes[1].getAttribute('intweb_cleunik');
      vl_t_int[x]=item1.childNodes[0].getAttribute('int_cleunik');
    }
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_01",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_nom)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_02",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_courriel)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_03",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_intweb)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_04",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_int)),'');
  }
  { //  Traitement des destinataires en copie carbone
    var listbox = fa_gid("li_dest_cc");
    var count = listbox.getRowCount();
    var x, item1,tab_a;
    var vl_t_nom=[];
    var vl_t_courriel=[];
    var vl_t_intweb=[];
    var vl_t_int=[];
    for(x = 0; x < count; x++) {
      item1 = listbox.getItemAtIndex(x);
      vl_t_nom[x]=window.btoa(fa_enc(item1.childNodes[1].getAttribute('label')));
      vl_t_courriel[x]=item1.childNodes[0].getAttribute('label');
      vl_t_intweb[x]=item1.childNodes[1].getAttribute('intweb_cleunik');
      vl_t_int[x]=item1.childNodes[0].getAttribute('int_cleunik');
    }
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_05",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_nom)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_06",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_courriel)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_07",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_intweb)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_08",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_int)),'');
  }
  { //  Traitement des destinataires en copie carbone invisible
    var listbox = fa_gid("li_dest_cci");
    var count = listbox.getRowCount();
    var x, item1,tab_a;
    var vl_t_nom=[];
    var vl_t_courriel=[];
    var vl_t_intweb=[];
    var vl_t_int=[];
    for(x = 0; x < count; x++) {
      item1 = listbox.getItemAtIndex(x)
      vl_t_nom[x]=window.btoa(fa_enc(item1.childNodes[1].getAttribute('label')));
      vl_t_courriel[x]=item1.childNodes[0].getAttribute('label');
      vl_t_intweb[x]=item1.childNodes[1].getAttribute('intweb_cleunik');
      vl_t_int[x]=item1.childNodes[0].getAttribute('int_cleunik');
    }
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_09",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_nom)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_10",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_courriel)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_11",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_intweb)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_12",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_int)),'');
  }
}
function pf_etat_fen(vv_quoi){
  switch(vv_quoi) {
    case "ini":
      fa_att_set("dest_a","autosuggestsearch",vf_c_script_das_courriel);
      fa_att_set("dest_cc","autosuggestsearch",vf_c_script_das_courriel);
      fa_att_set("dest_cci","autosuggestsearch",vf_c_script_das_courriel);
      fa_grise_oui("ra_integre_pj_sipossible_1");
      fa_grise_oui("ra_integre_pj_sipossible_2");
      pf_alimente_defaut();
      fa_focusdonne('dest_a');
      pf_complement_02();//  Dans _graal_courriel_01_complement.js
      $vl_c_init
END;
switch ($vl_c_type_courriel) {
  case "texte":
    break;
  case "html":
    echo('fa_gid("content").contentDocument.designMode="on";');
    echo('fa_grise_oui("ra_integre_pj_sipossible_1");');
    echo('fa_grise_oui("ra_integre_pj_sipossible_2");');
    break;
}
echo <<<END
      break;
    case "annuler":
			window.location=document.location;
      pf_raz_fiche();
      pf_alimente_defaut();
      break;
    case "sortir":
      window.close();
      break;
  }
}
function old_pf_ouvre_fichier(vv_quoi){
  switch (vv_quoi) {
    case 'disque' :
      var vl_c_nomfic=fa03_sel_fichier("","");
      fa_value_set("tb_emplacement",vl_c_nomfic)
      var vl_c_hash=fa03_fichier_sha1(vl_c_nomfic);
      fa_xmlhttprequest_txt(c_script_hash_doc+fa_enc(vl_c_hash),'',pf_ouvre_fichier_fin);
      break;
    case 'ged':
      fa_ouvre(c_fen_selection_docs);
      break;
  }
}
function old_pf_ouvre_fichier_fin(stream){
  var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  var row = document.createElement('listitem');
  var cell = document.createElement('listcell');
  cell.setAttribute('label', fa_value_get("tb_emplacement"));
  cell.setAttribute('_graal_fichier', tableau_retour[0]);
  cell.setAttribute('_graal_cleunik', tableau_retour[1]);
  row.appendChild( cell );
  fa_gid("li_pj").appendChild( row );
  fa_value_set("tb_emplacement","");
}
function pf_ouvre_fichier(vv_quoi){
	switch (vv_quoi) {
    case 'ged':
      fa_ouvre(c_fen_selection_docs);
      break;
  case 'disque' :
    var i=0;
	var vv_t_tableau_nom=[];
	vv_t_tableau_nom=fa03_sel_fichiers_plusieurs("","");
	fa_grise_fenetre("","oui");
	var vl_e_nb_sel=vv_t_tableau_nom.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
    	var hash=fa03_fichier_sha1(vv_t_tableau_nom[i]);
      var row = fa_crexul('listitem');
      var cell_01 = fa_crexul('listcell');
      var cell_02 = fa_crexul('listcell');
			var cell_03 = fa_crexul('listcell');
			var cell_04 = fa_crexul('listcell');
      cell_01.setAttribute('label', vv_t_tableau_nom[i]);
      cell_02.setAttribute('label', "A vérifier");
      cell_03.setAttribute('label', hash);
      cell_04.setAttribute('label',-1);
      row.appendChild(cell_01);
      row.appendChild(cell_02);
      row.appendChild(cell_03);
			row.appendChild(cell_04);
      fa_gid("li_pj").appendChild( row );
    }
  }
	vf_nombre_pj=fa_gid("li_pj").getRowCount();
  vf_t_cleunik=[];
	vf_nombre_pj_lues=0;
	vf_ligne_pj_a_lire=0;
	if (vf_nombre_pj!=0) {
		pf_verifie_hash(vf_ligne_pj_a_lire);
	} else {
		pf_verifie_hash_fin();
	}
	break;
	}
}
function pf_verifie_hash(vv_quelle_ligne) {
	var item1 = fa_gid("li_pj").getItemAtIndex(vv_quelle_ligne);
	var vl_c_veri=item1.childNodes[1].getAttribute('label');
	var vl_c_hash=item1.childNodes[2].getAttribute('label');
 	vf_nombre_pj_lues++;
  if (vl_c_veri=="A vérifier") {
		fa_xmlhttprequest_txt(c_script_hash_doc+fa_enc(vl_c_hash)+"&raf="+Math.random()+"&","",pf_verifie_hash_suite);
	} else {
		pf_verifie_hash_suite(-1);
	}
}
function pf_verifie_hash_suite(vv_data) {
	//alert(vv_data)
	switch (vv_data) {
		case -1:
			break;
		default:
			var tableau_retour=vv_data.split('|');
			var item1 = fa_gid("li_pj").getItemAtIndex(vf_ligne_pj_a_lire);
			item1.childNodes[0].setAttribute('_graal_fichier',tableau_retour[0]);
			item1.childNodes[0].setAttribute('_graal_cleunik',tableau_retour[1]);
			//alert(item1.childNodes[0].getAttribute('label'))
			item1.childNodes[1].setAttribute('label',"");
			item1.childNodes[2].setAttribute('label',"");
			item1.childNodes[3].setAttribute('label',"");
			vf_t_cleunik.push(vv_data);
	}
	if (vf_nombre_pj_lues!=vf_nombre_pj) {
		vf_ligne_pj_a_lire++;
		pf_verifie_hash(vf_ligne_pj_a_lire);
	} else {
		pf_verifie_hash_fin();
	}
}
function pf_verifie_hash_fin() {
	fa_grise_fenetre("","non");
}


function pf_ouvre_panier_courriel(vv_bouton) {
  var vl_e_cleunik=-1;
  switch (vv_bouton) {
    case "bt_panier_dest_a":vf_c_liste_en_cours="li_dest_a";break;
    case "bt_panier_dest_cc":vf_c_liste_en_cours="li_dest_cc";break;
    case "bt_panier_dest_cci":vf_c_liste_en_cours="li_dest_cci";break;
  }
  fa_ouvre(c_fen_panier_intweb+"tousss&",800,800);
}
function pf_ouvre_panier_courriel_retour() {
  var vl_t_tableau=vf_c_tableau_retour;
  fa_xmlhttprequest_xml(vf_c_script_edite_intweb+vl_t_tableau,"&raf="+Math.random()+"&",pf_sel_courriel_fin);
}
function pf_ouvre_panier_pj() {
  fa_ouvre(c_fen_panier_pj,600,400);
}
function pf_ouvre_selection_note() {
  fa_ouvre(c_fen_selection_notes);
}
function pf_raf(){
	alert("$vl_c_bak_155js");
}
function pf_raz_fiche(){}
function pf_retour_fenetre(vv_t_tableau) {
  vf_c_tableau_retour=vv_t_tableau;
  setTimeout(pf_ouvre_panier_courriel_retour, 0);
}
function pf_retour_fenetre_docs(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', vv_t_tableau_nom[i]);
      cell.setAttribute('_graal_fichier', 2);
      cell.setAttribute('_graal_cleunik', vv_t_tableau_cleunik[i]);
      row.appendChild( cell );
      fa_gid("li_pj").appendChild( row );
    }
  }
}
function pf_retour_fenetre_notes(vv_t_tableau_cleunik) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      pf_top_model(vv_t_tableau_cleunik[i]);
    }
  }
}
function pf_retour_fenetre_pj(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', vv_t_tableau_nom[i]);
      cell.setAttribute('_graal_fichier', 1);
      cell.setAttribute('_graal_cleunik', vv_t_tableau_cleunik[i]);
      row.appendChild( cell );
      fa_gid("li_pj").appendChild( row );
    }
  }
}
function pf_sel_courriel(vv_bouton){
  var vl_e_cleunik=-1;
  switch (vv_bouton) {
    case "bt_dest_a":vf_c_liste_en_cours="li_dest_a";vl_e_cleunik=fa_gid('dest_a').getAttribute('_graal_cleunik');break;
    case "bt_dest_cc":vf_c_liste_en_cours="li_dest_cc";vl_e_cleunik=fa_gid('dest_cc').getAttribute('_graal_cleunik');break;
    case "bt_dest_cci":vf_c_liste_en_cours="li_dest_cci";vl_e_cleunik=fa_gid('dest_cci').getAttribute('_graal_cleunik');break;
  }
  fa_xmlhttprequest_xml(vf_c_script_edite_intweb+vl_e_cleunik,"",pf_sel_courriel_fin);
}
function pf_sel_courriel_fin(stream,vv_target) {
  var vl_c_datas = stream;
  var vl_e_nombre=fa_xml_get(vl_c_datas,'nombre');
  for (i=1; i<=vl_e_nombre; i++){
  	try {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', fa_xml_get(vl_c_datas,'refweb_'+i));
      cell.setAttribute('int_cleunik', fa_xml_get(vl_c_datas,'int_cleunik_'+i));
      row.appendChild( cell );
      cell = document.createElement('listcell');
      cell.setAttribute('label', fa_xml_get(vl_c_datas,'prenom_nom_'+i));
      cell.setAttribute('intweb_cleunik', fa_xml_get(vl_c_datas,'intweb_cleunik_'+i));
      row.appendChild( cell );
      fa_gid(vf_c_liste_en_cours).appendChild( row );
  	} catch (e) {
  	}
  }
}
function pf_supprime_ligne(vv_qui) {
  var listbox = fa_gid(vv_qui);
  var x=fa_cui(vv_qui);if (x==-1) {return;}
  listbox.removeItemAt(x);
}

function pf_top_model(vv_quoi){
	if (vv_quoi!="") {
		var vv_qui=vv_quoi;
	} else {
		var vv_qui=fa_mlget("ml_modeles");
		var vl_c_affiche_sujet=fa_mlget("ml_modeles","_graal_origine");
		if (vl_c_affiche_sujet==1) {
			var vl_c_sujet=fa_mlget("ml_modeles","_graal_sujet");
			if (fa_se(vl_c_sujet)!="") {
				fa_value_set("tb_sujet",vl_c_sujet);
			}
		}
	}
END;
switch ($vl_c_type_courriel) {
  case "texte":
echo <<<END
  s ="vl_e_modele="+vv_qui+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
END;
  break;
  case "html" :
echo <<<END
  fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';pf_complement_model();");
  switch ("$vl_c_genre") {
    case "reponse":
    	//fa_xmlhttprequest_txt(c_script_modele_reponse+'?var=V_'+vv_qui,"vl_texte="+fa_enc(vf_c_texte_cite),pf_top_model_fin,vv_qui);
    	fa_xmlhttprequest_txt(c_script_modele_reponse+'?comment=tel_quel&var=V_'+vv_qui,"vl_texte="+fa_enc(vf_c_texte_cite),pf_top_model_fin,vv_qui);
  		break;
  	default:
  		fa_att_set("content","src",vf_c_script_edite_note+'?doc_cleunik='+vv_qui);
  		break;
  	}
END;
  break;
}
echo <<<END
}
function pf_top_model_fin(vv_raf,vv_qui){
	fa_att_set("content","src",vf_c_script_edite_note+'?doc_cleunik='+vv_qui+"&vf_c_texte_cite=raf&");
}
function pf_upload_pj(vv_quelle_ligne) {
	var item1 = fa_gid("li_pj").getItemAtIndex(vv_quelle_ligne);
	var vl_graal_fichier=parseInt(item1.childNodes[0].getAttribute('_graal_fichier'));
	var vl_graal_cleunik=parseInt(item1.childNodes[0].getAttribute('_graal_cleunik'));
	var vl_c_nomfic=item1.childNodes[0].getAttribute('label');
 	vf_nombre_pj_lues++;
  if (vl_graal_fichier==0) {
		fa03_fichier_lit_et_envoie(c_upload_pj,pf_upload_pj_suite,vl_c_nomfic);
	} else {
		vf_t_cleunik.push(vl_graal_cleunik);
		pf_upload_pj_suite(-1);
	}
}
function pf_upload_pj_suite(vv_data) {
	switch (vv_data) {
		case -1:
			break;
		default:
			vf_t_cleunik.push(vv_data);
	}
	if (vf_nombre_pj_lues!=vf_nombre_pj) {
		vf_ligne_pj_a_lire++;
		pf_upload_pj(vf_ligne_pj_a_lire);
	} else {
		pf_validation_suite();
	}
}
function pf_validation(vv_genre){
	var listbox = fa_gid("li_dest_a");
  var vl_nombre = listbox.getRowCount();
  if (vl_nombre==0) {alert("Il n'y a pas de destinataire !!");return;}
  	if (vv_genre!="brouillon"){
  		vf_c_brouillon="non";
	} else {
		vf_c_brouillon="oui";
	}
  if (fa_value_get("tb_sujet")=="") {if (!confirm("Il n'y a pas de sujet. Confirmez-vous l'envoi du courriel ?")) {fa_focusdonne("tb_sujet");return;}}
  switch ("$vl_c_type_courriel") {
    case "texte":
      if (fa_value_get("tb_message")=="") {if (!confirm("Il n'y a pas de message. Confirmez-vous l'envoi du courriel ?")) {fa_focusdonne("tb_message");return;}}
      break;
    case "html":
      break;
  }
	fa_gid("html_qui_grise").style.display = "";
  fa_gid("bt_enregistrer").label="$vl_c_bak_114"+' (1/2)';
	vf_b_validation_possible=true;
  fa_grise_oui("bt_enregistrer");
	vf_nombre_pj=fa_gid("li_pj").getRowCount();
  vf_t_cleunik=[];
	vf_nombre_pj_lues=0;
	vf_ligne_pj_a_lire=0;
	if (vf_nombre_pj!=0) {
		fa_gid("bt_enregistrer").label="$vl_c_bak_114"+' (1/2) ... (1/'+vf_nombre_pj+")";
		pf_upload_pj(vf_ligne_pj_a_lire);
	} else {
		pf_validation_suite();
	}
}
function pf_validation_fin(stream){
  var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  if (tableau_retour[0]!='0') {
    fa_value_set("tb_cr",tableau_retour[0]+tableau_retour[1])
    fa_gid('dk_01').selectedIndex=1;
		alert("Erreur. Consultez le compte rendu.");
  } else {
	if (vf_c_brouillon=="oui"){
		alert("Brouillon enregistré.")
	} else {
  		alert("Envoi effectué.");
  	}
  }
  fa_gid("bt_enregistrer").label="$vl_c_bak_101";
  fa_gid("html_qui_grise").style.display = "none";
  fa_grise_non("bt_enregistrer");
}
function pf_validation_suite(){
  var s="";
  if (!vf_b_validation_possible) {
    alert("L'enregistrement d'une ou des pièce(s) jointe(s) a échoué. Le courriel n'est pas envoyé.");
    fa_gid("bt_enregistrer").label="$vl_c_bak_101";
    fa_gid("html_qui_grise").style.display = "none";
    fa_grise_non("bt_enregistrer");
    return;
  }
  fa_gid("bt_enregistrer").label="$vl_c_bak_114"+' (2/2)';
  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_14",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vf_t_cleunik)),'');
  pf_destinataires();
  s+="vl_c_sujet="+fa_enc(fa_value_get("tb_sujet"))+"&";
  s+="vl_e_sendmail_from="+fa_enc(fa_mlget("ml_emetteur"))+"&";
  s+="vl_c_id="+fa_enc("?")+"&";
  s+="vl_c_type_envoi="+fa_enc(fa_gid("rdg_unpardestinataire").selectedItem.value)+"&";
  s+="vl_c_type_action="+fa_enc(fa_gid("rdg_uneactionpardestinataire").selectedItem.value)+"&";
  s+="vl_c_priorite="+fa_enc(fa_gid("rdg_priorite").selectedItem.value)+"&";
  s+="vl_c_sensitivity="+fa_enc(fa_gid("rdg_sensitivite").selectedItem.value)+"&";
  s+="vl_c_integre_pj_sipossible="+fa_enc(fa_gid("rdg_integre_pj_sipossible").selectedItem.value)+"&";
  s+="vl_c_confirmation_lecture="+fa_enc(fa_value_get("rdg_confirmation_lecture"))+"&";
	s+="vl_action_cleunik_liee=$vl_action_cleunik_liee&";
  s+="raf="+Math.random()+"&";
  if (vf_c_brouillon=="oui"){
 	s+="vl_c_genre=brouillon&";
  } else {
  	if ("$vl_c_genre"=="formulaire") {
  		s+="vl_c_genre=normal&";
  	} else {
  		s+="vl_c_genre=$vl_c_genre&";
  	}
  }
END;
  switch ($vl_c_type_courriel) {
    case "texte":
      echo('s+="vl_c_message="+fa_enc(fa_value_get("tb_message"))+"&";s+="vl_c_type_courriel=1&";');
      break;
    case "html":
      echo('s+="vl_c_message="+fa_enc(fa_gid("content").contentWindow.document.documentElement.innerHTML)+"&";s+="vl_c_type_courriel=2&";');
      break;
  }
  switch ($vl_c_genre) {
    case "reponse":
      echo('s+="vl_c_idorigine="+fa_enc("'.$vl_mel_id.'")+"&";');
      echo('s+="vl_c_references="+fa_enc(vf_c_references+"'.$vl_mel_id.'")+"&";');
      echo('s+="vl_e_action_cleunik='.$vl_e_action_cleunik.'"+"&";');
      break;
    case "transfert":
      echo('s+="vl_c_references="+fa_enc(vf_c_references+"'.$vl_mel_id.'")+"&";');
      echo('s+="vl_e_action_cleunik='.$vl_e_action_cleunik.'"+"&";');
      echo('s+="vl_int_cleunik_initial='.$vl_int_cleunik_initial.'"+"&";');
      break;

  }
echo <<<END
  fa_xmlhttprequest_txt(c_script_envoie_courriel,s,pf_validation_fin);
}
function pf_voir_pj(){
  var listbox = fa_gid("li_pj");
  var x=fa_cui("li_pj");if (x==-1) {return;}
  item1 = listbox.getItemAtIndex(x);
  var _graal_cleunik=item1.childNodes[0].getAttribute('_graal_cleunik');
  var vl_graal_label=item1.childNodes[0].getAttribute('label');
  if (_graal_cleunik==0) {
  	fa03_fichier_lit_et_ouvre(vl_graal_label);
  } else {
		pf07_visualise(_graal_cleunik);
	}
}
]]></script>
END;
?>
