<?php
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
_graal_requete_charge_varlib($id_fen_doc_fabr,$vl_e_uti_cleunik);
$vf_c_script_cial_entete="_graal_xml_docial_entete.php?genreaction=$vl_c_genreaction&vl_commercial_cleunik=$commercial_cleunik&";
$vf_c_script_cial_adresses_01="_graal_xml_docial_adresses_01.php?genreaction=$vl_c_genreaction&vl_commercial_cleunik=$commercial_cleunik&";
$vf_c_script_cial_adresses_02="_graal_xml_docial_adresses_02.php?genreaction=$vl_c_genreaction&vl_commercial_cleunik=$commercial_cleunik&";
$vf_c_script_cial_bdope_action="_graal_bdope_doc_cial_01.php?genreaction=$vl_c_genreaction&vl_commercial_cleunik=$commercial_cleunik&";
$vf_c_script_cial_lignes="_graal_das_actions_cial_lignes.php?genreaction=$vl_c_genreaction&vl_commercial_cleunik=$commercial_cleunik&";
$js_bon_preparation="";
$js_confirmation_cdecli="";
$param_generaux_graal_025=intval(fa_recup_session('vs_param_generaux_graal_025','0'));
$tb_cial_int_complement=<<<EOT
	fa_cache_oui('bt_supprimer');
EOT;
switch ($vf_c_action) {
  case 'modifier' :
    $vl_c_ini="";
    break; 
  case 'ajoutermodifier' :
    $vl_c_ini="pf_fabr_etat_fen('modifier');";
    break;
}
$vl_c_bqh_152=fa_recup_dico_js("bqh_152");
$vl_c_bqh_155=fa_recup_dico_js("bqh_155");
$vl_c_bqh_156=fa_recup_dico_js("bqh_156");
echo <<<END
<script type="application/x-javascript"><![CDATA[
const c_fabr_entete="_graal_xml_fabric_entete.php?vl_action_cleunik=$vl_action_cleunik&";
const c_fabr_lignes="_graal_das_fabric_lignes_nomenc_01.php?vl_fab_ligne_cleunik=";
const c_fabr_lignes_saisie="_graal_das_fabric_lignes_nomenc_02.php?vl_fab_ligne_cleunik=";
const c_fabr_bdope_fen="_graal_bdope_doc_fab_01.php?vl_action_cleunik=$vl_action_cleunik&";
const c_fabr_script_xml_nomenclature_fab="_graal_xml_fabric_ligne_01.php?";
const c_fabr_script_tar_valorisation_nomenc_fab="_graal_das_art_tarifs_type_nomenc.php?";
const c_fabr_script_recherche_article_nomencfab="_graal_das_art_selection.php?actif=1&portee=8&type_recherche=1&";  //  Recherche des articles actifs gérés en fabrication
const c_fabr_script_xml_art_pour_nomencfab='_graal_xml_articles_02.php?vl_e_art_cleunik=';
var vf_fabr_fab_ligne_nomenc_cleunik=0;
var lstn_fabr_nomenc_saisie = { 
    willRebuild : function(event){},
    didRebuild  : function(event){pf_fabr_nomenc_saisie_suite(event);} 
};
var lstn_ml_nomencfab_base_valorisation = { 
    willRebuild : function(event){},
    didRebuild  : function(event){pf_fabr_cons_ml_nomencfab_base_valorisation_faite(event);} 
  };
function pf_fabr_affiche_donnees() {
  fa_xmlhttprequest_xml(c_fabr_entete+"raf_random="+Math.random()+"&","",pf_fabr_affiche_entete);
	//fa_ouvre(c_fabr_entete+"raf_random="+Math.random()+"&")
}
function pf_fabr_affiche_entete(stream) {
  var vl_c_datas=stream;
  fa_value_set("tb_fabr_entete_blocnotebrut",fa_xml_get(vl_c_datas,"blocnotebrut_entete"));
  fa_value_set("tb_fabr_entete_code",fa_xml_get(vl_c_datas,"code"));
  fa_att_set("tb_fabr_entete_code","_graal_fab_cleunik",fa_xml_get(vl_c_datas,"fab_cleunik"));
  fa_att_set("tb_fabr_entete_code","_graal_art_cleunik",fa_xml_get(vl_c_datas,"art_cleunik"));	
	fa_att_set("tb_fabr_entete_code","_graal_fab_ligne_cleunik",fa_xml_get(vl_c_datas,"fab_ligne_cleunik"));
  fa_value_set("tb_fabr_entete_date_creation",fa_xml_get(vl_c_datas,"datecreation")+" "+fa_xml_get(vl_c_datas,"heurecreation"));
  fa_value_set("tb_fabr_entete_date_modifica",fa_xml_get(vl_c_datas,"datemodif")+" "+fa_xml_get(vl_c_datas,"heuremodif"));
  fa_value_set("tb_fabr_ligne_code_article",fa_xml_get(vl_c_datas,"code_article"));
  fa_value_set("tb_fabr_ligne_desc_article",fa_xml_get(vl_c_datas,"description"));
  fa_value_set("tb_fabr_ligne_qte_lancee",fa_xml_get(vl_c_datas,"qte_lancee"));
  fa_value_set("tb_fabr_ligne_qte_fabriq",fa_xml_get(vl_c_datas,"qte_fabriq"));
	fa_value_set("tb_fabr_ligne_qte_rebute",fa_xml_get(vl_c_datas,"qte_rebute"));
  fa_value_set("tb_fabr_ligne_pu",fa_xml_get(vl_c_datas,"pu"));
	fa_mlsel("ml_fabr_ligne_statut",fa_xml_get(vl_c_datas,'statut'));
	fa_value_set("tb_fabr_ligne_blocnotebrut",fa_xml_get(vl_c_datas,"blocnotebrut_ligne"));
	if (fa_xml_get(vl_c_datas,"nombre_saisies")!=0){
		fa_cache_oui('bt_supprimer');
	}
  pf_fabr_affiche_lignes();
  $tb_cial_int
}
function pf_fabr_affiche_lignes() {
	fa_das("arbre_fabric_lignes_nomenc",c_fabr_lignes+fa_att_get("tb_fabr_entete_code","_graal_fab_ligne_cleunik")+"&raf="+Math.random());
}
function pf_fabr_cons_ml_nomencfab_base_valorisation_faite(event) {
  fa_gid("ml_nomencfab_base_valorisation").selectedIndex=0;
  var vl_e_nombre=fa_mlget("ml_nomencfab_base_valorisation","_graal_nombre");
  var base_valorisation=fa_att_get("tb_nomencfab_valorisation","_graal_base_valorisation");
  for(var i=0;i<vl_e_nombre;i++){
    fa_gid("ml_nomencfab_base_valorisation").selectedIndex=i;
    fa_att_set("ml_nomencfab_base_valorisation","class",fa_mlget("ml_nomencfab_base_valorisation","class"));
    if (base_valorisation==fa_mlget("ml_nomencfab_base_valorisation","_graal_cleunik")){
      fa_value_set("tb_nomencfab_valorisation",fa_mlget("ml_nomencfab_base_valorisation","_graal_base_valorisation"));
      break;
    }
  }
  pf_fabr_nomenclaturefab_valorise();
}
function pf_fabr_change_menu_actifs_nomencfab_base_valorisation() {
  var vo_list = fa_gid("ml_nomencfab_base_valorisation");
  var vo_item = vo_list.selectedItem;
  vo_list.setAttribute("class",vo_item.getAttribute("class"));
  fa_value_set("tb_nomencfab_valorisation",vo_item.getAttribute("_graal_base_valorisation"));
  pf_fabr_nomenclaturefab_valorise();
}
function pf_fabr_change_nombre_decimales(){
	var nbdec=fa_value_get("tb_nomencfab_nbdecimales");
	fa_att_set('tb_nomencfab_quantite','decimalplaces',nbdec);
	fa_att_set('tb_nomencfab_quantite_lancee','decimalplaces',nbdec);
	fa_att_set('tb_nomencfab_quantite_fabriq','decimalplaces',nbdec);
	fa_att_set('tb_nomencfab_quantite_rebute','decimalplaces',nbdec);		
}

function pf_fabr_etat_fen(vv_quoi) {
  switch(vv_quoi) {
    case "ini":
			fa_sep("tb_fabr_ligne_qte_lancee");
			fa_sep("tb_fabr_ligne_qte_fabriq");
			fa_sep("tb_fabr_ligne_qte_rebute");
			fa_sep("tb_fabr_ligne_pu");
			
		  fa_sep("tb_nomencfab_noligne");
		  fa_sep("tb_nomencfab_quantite");
		  fa_sep("tb_nomencfab_nbdecimales");
		  fa_sep("tb_nomencfab_valorisation");
		  fa_sep("tb_nomencfab_valeur_complement");
		  fa_sep("tb_nomencfab_valeurligne");
			fa_sep("tb_fabr_ligne_qte_lancee");
		  fa_sep("tb_deja_fabr_ligne_qte_lancee");
		  fa_sep("tb_deja_fabr_ligne_qte_fabriq");
		  fa_sep("tb_deja_fabr_ligne_qte_rebute");
		  fa_sep("tb_fabr_ligne_qte_fabriq_saisie");
		  fa_sep("tb_fabr_ligne_qte_rebute_saisie");
		  fa_sep("tb_nomencfab_quantite_fabriq_deja");
			fa_sep("tb_nomencfab_quantite_fabriq");
		  fa_sep("tb_nomencfab_quantite_rebute_deja");
		  fa_sep("tb_nomencfab_quantite_rebute");
			
      pf_fabr_affiche_donnees();
      fa_grise_groupe_oui('broadcaster_02');
      fa_grise_groupe_non('broadcaster_01');
			fa_badl("ml_nomencfab_base_valorisation",lstn_ml_nomencfab_base_valorisation);
      $vl_c_ini
      break;
    case "selectionner":
      fa_grise_non("bt_cial_modifier");fa_grise_non("bt_cial_annuler");fa_grise_oui("bt_cial_enregistrer");
      fa_grise_groupe_oui('broadcaster_02');
      break;
    case "modifier":
      fa_grise_oui("bt_cial_modifier");fa_grise_non("bt_cial_enregistrer");fa_grise_non("bt_cial_annuler");
      fa_grise_groupe_non('broadcaster_02');
      break;
    case "annuler":
      pf_aa_init()
      break;
    case "sortir":
      try { window.opener.pf_approximatif_bem()} catch (e) {}
      window.close();
      break;   
    default:
      break;
  }
}
function pf_fabr_ligne(vv_quoi){
	
	switch (vv_quoi){
		case "nouveau":
			vf_fabr_fab_ligne_nomenc_cleunik=0;
			fa_cache_non("row_selection_article");
			fa_cache_oui("la_nomencfab_quantite_fabriq_deja");
			fa_cache_oui("la_nomencfab_quantite_rebute_deja");
			fa_cache_oui("tb_nomencfab_quantite_fabriq_deja");
			fa_cache_oui("tb_nomencfab_quantite_rebute_deja");
			pf_fabr_ligne_raz();
      fa_grise_groupe_non('broadcaster_02');
			fa_att_rem("tb_nomencfab_quantite_lancee","disabled");
			fa_att_set("tb_nomencfab_valorisation","_graal_base_valorisation","$param_generaux_graal_025");
			fa_att_set("selart_nomenc_fab","autosuggestsearch",c_fabr_script_recherche_article_nomencfab+"zone="+fa_value_get("selart_nomenc_fab_ml_zone")+"&");
			fa_focusdonne('selart_nomenc_fab');
			fa_att_set('deck_saisie_fab_01','selectedIndex',2);
			break;
		case "ouvrir":
		case "supprimer":
		  var i=fa_cui("arbre_fabric_lignes_nomenc");if(i==-1){return;}
			fa_att_set('deck_saisie_fab_01','selectedIndex',2);
			fa_att_set("tb_nomencfab_quantite_lancee","disabled","true");
			vf_fabr_fab_ligne_nomenc_cleunik=fa_cell_get("arbre_fabric_lignes_nomenc",i,"tc_fab_ligne_nomenc_cleunik");
			var vl_art_cleunik_fils=fa_cell_get("arbre_fabric_lignes_nomenc",i,"tc_art_cleunik_fils");
		  var s="&vl_fab_ligne_nomenc_cleunik="+vf_fabr_fab_ligne_nomenc_cleunik+"&raf="+Math.random();
		  fa_xmlhttprequest_xml(c_fabr_script_xml_nomenclature_fab,s,pf_fabr_ligne_affiche_detail,vv_quoi);
			s="";
		  s+="actif=1&vl_art_cleunik="+vl_art_cleunik_fils+"&";
		  fa_das("ml_nomencfab_base_valorisation",c_fabr_script_tar_valorisation_nomenc_fab+s);
			break;
	}
}
function pf_fabr_ligne_affiche_detail(vv_stream,vv_quoi){
  var vl_c_datas=vv_stream;
  fa_value_set('tb_nomencfab_noligne',fa_xml_get(vl_c_datas,'noligne'));
  fa_value_set('tb_nomencfab_codefils',fa_xml_get(vl_c_datas,'code'));
  fa_att_set('tb_nomencfab_codefils',"_graal_cleunik",fa_xml_get(vl_c_datas,'art_cleunik_fils'));
	fa_att_set('tb_nomencfab_codefils',"_graal_hg",fa_xml_get(vl_c_datas,'hg'));
	fa_att_set('tb_nomencfab_codefils',"_graal_nbdec_pu",fa_xml_get(vl_c_datas,'nbdec_pu'));
	fa_att_set('tb_nomencfab_codefils',"_graal_unite_quantite",fa_xml_get(vl_c_datas,'unite_quantite'));
  fa_att_set('tb_nomencfab_codefils',"_graal_noligne",fa_xml_get(vl_c_datas,'noligne'));
	fa_att_set("tb_nomencfab_codefils","_graal_fab_ligne_cleunik",fa_xml_get(vl_c_datas,"fab_ligne_cleunik"));
  fa_value_set('tb_nomencfab_descourfils',fa_xml_get(vl_c_datas,'description'));
	fa_mlsel("ml_nomencfab_arrondi_fab",fa_xml_get(vl_c_datas,'arrondi_fab'),"value");
	fa_att_set('tb_nomencfab_quantite_lancee','decimalplaces',fa_xml_get(vl_c_datas,'nb_decimales_qte'));
	fa_att_set('tb_nomencfab_quantite_fabriq','decimalplaces',fa_xml_get(vl_c_datas,'nb_decimales_qte'));
	fa_att_set('tb_nomencfab_quantite_rebute','decimalplaces',fa_xml_get(vl_c_datas,'nb_decimales_qte'));		
	fa_att_set('tb_nomencfab_quantite_fabriq_deja','decimalplaces',fa_xml_get(vl_c_datas,'nb_decimales_qte'));
	fa_att_set('tb_nomencfab_quantite_rebute_deja','decimalplaces',fa_xml_get(vl_c_datas,'nb_decimales_qte'));		
	fa_value_set('tb_nomencfab_quantite_lancee',fa_xml_get(vl_c_datas,'quantite_lancee'));
	fa_value_set('tb_nomencfab_quantite_fabriq_deja',fa_xml_get(vl_c_datas,'quantite_fabriq'));
	fa_value_set('tb_nomencfab_quantite_rebute_deja',fa_xml_get(vl_c_datas,'quantite_rebute'));
	fa_value_set('tb_nomencfab_quantite_fabriq','0');
	fa_value_set('tb_nomencfab_quantite_rebute','0');

  fa_value_set('tb_nomencfab_nbdecimales',fa_xml_get(vl_c_datas,'nb_decimales_qte'));
  fa_value_set('tb_nomencfab_blocnotebrut',fa_xml_get(vl_c_datas,'blocnotebrut'));
  fa_value_set('tb_nomencfab_valorisation',fa_xml_get(vl_c_datas,'base_valorisation'));
  fa_value_set('tb_nomencfab_valeur_complement',fa_xml_get(vl_c_datas,'valeur_complement'));
  var vl_e_nombre=2;
  for(var i=0;i<vl_e_nombre;i++){
    fa_gid("ml_nomencfab_valeur_complement_type").selectedIndex=i;
    if (fa_xml_get(vl_c_datas,'valeur_complement_type')==fa_value_get("ml_nomencfab_valeur_complement_type")){break;}
  }
  fa_att_set("tb_nomencfab_valorisation","_graal_base_valorisation",fa_xml_get(vl_c_datas,'base_valorisation'));
	switch (vv_quoi){
		case "ouvrir":
	    fa_grise_groupe_non('broadcaster_02');
			fa_focusdonne('tb_nomencfab_quantite_fabriq');
			break;
		case "supprimer":
			var vl_quantite_fabriq=Number(fa_value_get("tb_nomencfab_quantite_fabriq_deja"));
  		var vl_quantite_rebute=Number(fa_value_get("tb_nomencfab_quantite_rebute_deja"));
			if ((vl_quantite_fabriq+vl_quantite_rebute)!=0) {
				alert("$vl_c_bqh_156");
				fa_att_set('deck_saisie_fab_01','selectedIndex',0);
				return;
			}
			if (!confirm("$vl_c_bqh_152")) {
				fa_att_set('deck_saisie_fab_01','selectedIndex',0);
			} else {
				var vl_c_donnees="";
				vl_c_donnees="vf_c_action=supprimer_ligne&vl_fab_ligne_nomenc_cleunik="+vf_fabr_fab_ligne_nomenc_cleunik+"&";
				vl_c_action="supprimer_ligne";
				fa_xmlhttprequest_txt(c_fabr_bdope_fen,vl_c_donnees,pf_fabr_ligne_valide_fin,vl_c_action);
			}
			break;
	}
}
function pf_fabr_ligne_annuler(vv_quoi){
	fa_att_set('deck_saisie_fab_01','selectedIndex',0);
	vf_fab_ligne_nomenc_cleunik=-1;
}
function pf_fabr_ligne_raz(){
	fa_value_set('tb_nomencfab_noligne',"");
  fa_value_set('tb_nomencfab_codefils',"");
  fa_value_set('tb_nomencfab_descourfils',"");
	fa_value_set('tb_nomencfab_quantite_lancee',"0");
	fa_value_set('tb_nomencfab_quantite_fabriq_deja',"0");
	fa_value_set('tb_nomencfab_quantite_rebute_deja',"0");
	fa_value_set('tb_nomencfab_quantite_fabriq','0');
	fa_value_set('tb_nomencfab_quantite_rebute','0');

  fa_value_set('tb_nomencfab_nbdecimales',"0");
  fa_value_set('tb_nomencfab_blocnotebrut',"");
  fa_value_set('tb_nomencfab_valorisation',"0");
  fa_value_set('tb_nomencfab_valeur_complement',"0");
	
	
	
}
function pf_fabr_ligne_valider() {
	var vl_quantite_fab=Number(fa_value_get('tb_fabr_ligne_qte_fabriq_saisie'));
	var vl_quantite_reb=Number(fa_value_get('tb_fabr_ligne_qte_rebute_saisie'));
	if (vl_quantite_fab==0 & vl_quantite_reb==0) {
		
	} else {
		//	Il ne faut contrôler la date que s'il y a des quantités saisies
		if (fa_value_get('dp_dat_deb_fabriq_ligne')=='') {alert("$vl_c_bqh_155");fa_focusdonne('dp_dat_deb_fabriq_ligne');return}
	}
	var vl_c_donnees="",vl_c_action="";
	if (vf_fabr_fab_ligne_nomenc_cleunik==0) {
		vl_c_donnees="vf_c_action=ajouter_ligne&";
		vl_c_action="ajouter_ligne";
		
	} else {
		vl_c_donnees="vf_c_action=modifier_ligne&";
		vl_c_action="modifier_ligne";
	}
	var vl_c_liste_cle=[],vl_c_liste_qtefab=[],vl_c_liste_qtereb=[],vl_c_liste_qtelan=[],vl_c_liste_note=[];
	var vl_c_liste_pu=[],vl_c_liste_valeur_complement_type=[],vl_c_liste_valeur_complement=[],vl_c_liste_hg=[],vl_c_liste_base_valorisation=[];
	var vl_c_liste_nb_decimales_qte=[],vl_c_liste_nbdec_pu=[],vl_c_liste_noligne=[],vl_c_liste_art_cleunik=[],vl_c_liste_unite_quantite=[];
	var i=0;
  vl_c_liste_cle[i]=vf_fabr_fab_ligne_nomenc_cleunik;
	vl_c_liste_qtelan[i]=fa_value_get("tb_nomencfab_quantite_lancee");
	vl_c_liste_qtefab[i]=fa_value_get("tb_nomencfab_quantite_fabriq");
	vl_c_liste_qtereb[i]=fa_value_get("tb_nomencfab_quantite_rebute");
  vl_c_liste_pu[i]=fa_value_get("tb_nomencfab_valorisation");
	vl_c_liste_valeur_complement_type[i]=fa_mlget("ml_nomencfab_valeur_complement_type","value");
	vl_c_liste_valeur_complement[i]=fa_value_get("tb_nomencfab_valeur_complement");
  vl_c_liste_hg[i]=fa_att_get("tb_nomencfab_codefils","_graal_hg");
	vl_c_liste_base_valorisation[i]=fa_mlget("ml_nomencfab_base_valorisation","value");
	vl_c_liste_nb_decimales_qte[i]=fa_value_get("tb_nomencfab_nbdecimales");
  vl_c_liste_nbdec_pu[i]=fa_att_get("tb_nomencfab_codefils","_graal_nbdec_pu");
	vl_c_liste_unite_quantite[i]=fa_att_get("tb_nomencfab_codefils","_graal_unite_quantite");
	vl_c_liste_art_cleunik[i]=fa_att_get("tb_nomencfab_codefils","_graal_cleunik");
	vl_c_liste_note[i]=fa_value_get("tb_nomencfab_blocnotebrut");
	
	vl_c_donnees+="vl_dat_fabriq="+fa_enc(fa_value_get("dp_dat_deb_fabriq_ligne")+" "+fa_value_get("tb_heu_deb_fabriq_ligne"))+"&";
	vl_c_donnees+="vl_fab_ligne_cleunik="+fa_att_get("tb_fabr_entete_code","_graal_fab_ligne_cleunik")+"&";
  vl_c_donnees+="vl_c_liste_cle="+fa_jsarray2php_00(vl_c_liste_cle)+"&";
	vl_c_donnees+="vl_c_liste_qtelan="+fa_jsarray2php_00(vl_c_liste_qtelan)+"&";
	vl_c_donnees+="vl_c_liste_qtefab="+fa_jsarray2php_00(vl_c_liste_qtefab)+"&";
	vl_c_donnees+="vl_c_liste_qtereb="+fa_jsarray2php_00(vl_c_liste_qtereb)+"&";
  vl_c_donnees+="vl_c_liste_valeur_complement_type="+fa_jsarray2php_00(vl_c_liste_valeur_complement_type)+"&";
	vl_c_donnees+="vl_c_liste_valeur_complement="+fa_jsarray2php_00(vl_c_liste_valeur_complement)+"&";
	vl_c_donnees+="vl_c_liste_hg="+fa_jsarray2php_00(vl_c_liste_hg)+"&";
  vl_c_donnees+="vl_c_liste_base_valorisation="+fa_jsarray2php_00(vl_c_liste_base_valorisation)+"&";
	vl_c_donnees+="vl_c_liste_nb_decimales_qte="+fa_jsarray2php_00(vl_c_liste_nb_decimales_qte)+"&";
	vl_c_donnees+="vl_c_liste_nbdec_pu="+fa_jsarray2php_00(vl_c_liste_nbdec_pu)+"&";
  vl_c_donnees+="vl_c_liste_pu="+fa_jsarray2php_00(vl_c_liste_pu)+"&";
	vl_c_donnees+="vl_c_liste_noligne="+fa_jsarray2php_00(vl_c_liste_noligne)+"&";
	vl_c_donnees+="vl_c_liste_art_cleunik="+fa_jsarray2php_00(vl_c_liste_art_cleunik)+"&";	
	vl_c_donnees+="vl_c_liste_unite_quantite="+fa_jsarray2php_00(vl_c_liste_unite_quantite)+"&";
	vl_c_donnees+="vl_c_statut="+fa_mlget('ml_statut_fabr')+"&";
	
	vl_c_donnees+="vl_fab_cleunik="+fa_att_get("tb_fabr_entete_code","_graal_fab_cleunik")+"&";
	vl_c_donnees+="vl_e_art_cleunik="+fa_att_get("tb_fabr_entete_code","_graal_art_cleunik")+"&";
	vl_c_donnees+="vl_c_liste_note="+fa_jsarray2php_00(fa_enc(vl_c_liste_note))+"&";

	fa_xmlhttprequest_txt(c_fabr_bdope_fen,vl_c_donnees,pf_fabr_ligne_valide_fin,vl_c_action);
	
}
function pf_fabr_ligne_valide_fin(vv_stream,vv_quoi){
	window.location=document.location;
	/*
	switch (vv_quoi){
		case "ajouter_ligne":
		  window.location=document.location;
			break;
		case "supprimer_ligne":
		case "modifier_ligne":
			pf_fabr_affiche_lignes();
			fa_att_set('deck_saisie_fab_01','selectedIndex',0);
			break;
	}
	*/
	
}
function pf_fabr_nomenc_saisie(){
	fa_badl("arbre_saisie_fabric_lignes_nomenc",lstn_fabr_nomenc_saisie);
	var s=c_fabr_lignes_saisie+fa_att_get("tb_fabr_entete_code","_graal_fab_ligne_cleunik")+"&raf="+Math.random();
	s+="&vl_qte_fab="+fa_value_get("tb_fabr_ligne_qte_fabriq_saisie");
	s+="&vl_qte_reb="+fa_value_get("tb_fabr_ligne_qte_rebute_saisie");	
	fa_das("arbre_saisie_fabric_lignes_nomenc",s);
	fa_cache_non("bt_fabr_solde_valide");
	//fa_ouvre(s)
}
function pf_fabr_nomenc_saisie_suite(vv_evenement){
	pf_fabr_valorise_saisie();
	fa_cache_non("bt_fabr_solde_valide");
}
function pf_fabr_nomclaturefab_sel_article_pour_ligne() {
  var vl_e_cleunik=fa_att_get('selart_nomenc_fab','_graal_cleunik');
  fa_das("ml_nomencfab_base_valorisation",c_fabr_script_tar_valorisation_nomenc_fab+"actif=1&vl_art_cleunik="+vl_e_cleunik+"&");
  fa_xmlhttprequest_xml(c_fabr_script_xml_art_pour_nomencfab+vl_e_cleunik,"",pf_fabr_nomclaturefab_sel_article_pour_ligne_fin);
}
function pf_fabr_nomclaturefab_sel_article_pour_ligne_fin(stream) {
  var vl_c_datas=stream;
  fa_value_set('tb_nomencfab_descourfils',fa_xml_get(vl_c_datas,'description'));
  fa_value_set('tb_nomencfab_codefils',fa_xml_get(vl_c_datas,'code'));
  fa_att_set('tb_nomencfab_codefils',"_graal_cleunik",fa_xml_get(vl_c_datas,'art_cleunik'));
  fa_att_set('tb_nomencfab_codefils',"_graal_hg","1");
  fa_att_set('tb_nomencfab_codefils',"_graal_nbdec_pu","4");
  fa_att_set('tb_nomencfab_codefils',"_graal_unite_quantite","-14");		
	fa_focusdonne('tb_nomencfab_quantite_lancee');
}
function pf_fabr_nomenclaturefab_valorise() {
  var vl_valeur_ref=Number(fa_value_get("tb_nomencfab_valorisation"));
  var vl_quantite_fabriq=Number(fa_value_get("tb_nomencfab_quantite_fabriq"));
  var vl_quantite_rebute=Number(fa_value_get("tb_nomencfab_quantite_rebute"));
  var vl_valeur_complement=Number(fa_value_get("tb_nomencfab_valeur_complement"));
  var vl_valeur_complement_type=fa_gid("ml_nomencfab_valeur_complement_type").selectedItem.value;
  var vl_valeur_ligne_01= new Number(vl_valeur_ref*(vl_quantite_fabriq+vl_quantite_rebute));
  var vl_valeur_ligne_02= new Number(0);
  switch (vl_valeur_complement_type) {
    case "1" : // unitaire
      vl_valeur_ligne_02=(vl_valeur_complement*(vl_quantite_fabriq+vl_quantite_rebute));
      break;
    case "2" : // Forfaitaire
      vl_valeur_ligne_02=(vl_valeur_complement);
      break;
  }
  var vl_valeur_ligne=(vl_valeur_ligne_01+vl_valeur_ligne_02);
  fa_value_set("tb_nomencfab_valeurligne",vl_valeur_ligne);
}

function pf_fabr_onunload(){
	fa_brl("ml_nomencfab_base_valorisation",lstn_ml_nomencfab_base_valorisation);
}
function pf_fabr_solde(){
	fa_value_set("tb_deja_fabr_ligne_qte_lancee",fa_value_get("tb_fabr_ligne_qte_lancee"));
	fa_value_set("tb_deja_fabr_ligne_qte_fabriq",fa_value_get("tb_fabr_ligne_qte_fabriq"));
	fa_value_set("tb_deja_fabr_ligne_qte_rebute",fa_value_get("tb_fabr_ligne_qte_rebute"));		
	fa_att_set('deck_saisie_fab_01','selectedIndex',1);
	fa_cache_oui("bt_fabr_solde_valide");
	fa_focusdonne("tb_fabr_ligne_qte_fabriq_saisie");
}
function pf_fabr_solde_annule(){
	fa_brl("arbre_saisie_fabric_lignes_nomenc",lstn_fabr_nomenc_saisie);
	fa_att_set('deck_saisie_fab_01','selectedIndex',0);
}
function pf_fabr_solde_valide(){
	pf_fabr_valorise_saisie();
	var vl_e_nb=fa_cl("arbre_saisie_fabric_lignes_nomenc");
  if (vl_e_nb==0) {return;}
	if (fa_value_get('dp_dat_deb_fabriq')=='') {alert("$vl_c_bqh_155");fa_focusdonne('dp_dat_deb_fabriq');return}
  var vl_c_liste_cle=[],vl_c_liste_qtefab=[],vl_c_liste_qtereb=[];
	vl_c_liste_pu=[];vl_c_liste_valeur_complement_type=[];vl_c_liste_valeur_complement=[];vl_c_liste_hg=[];vl_c_liste_base_valorisation=[];
	vl_c_liste_nb_decimales_qte=[];vl_c_liste_nbdec_pu=[];vl_c_liste_noligne=[];vl_c_liste_art_cleunik=[];vl_c_liste_unite_quantite=[];
	for(i=0;i<vl_e_nb;i++) { 
    vl_c_liste_cle[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_fab_ligne_nomenc_cleunik");
		vl_c_liste_qtefab[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_quantite_fabriq");
		vl_c_liste_qtereb[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_quantite_rebute");
    vl_c_liste_pu[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_pu");
		vl_c_liste_valeur_complement_type[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_valeur_complement_type");
		vl_c_liste_valeur_complement[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_valeur_complement");
    vl_c_liste_hg[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_fab_hg");
		vl_c_liste_base_valorisation[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_fab_base_valorisation");
		vl_c_liste_nb_decimales_qte[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_fab_nb_decimales_qte");
    vl_c_liste_nbdec_pu[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_fab_nbdec_pu");
		vl_c_liste_noligne[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_noligne");
		vl_c_liste_art_cleunik[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_art_cleunik_fils");
		vl_c_liste_unite_quantite[i]=fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_unite_quantite");
	
  }
  var vl_c_donnees="vf_c_action=saisie_ensemble&";
	vl_c_donnees+="vl_dat_fabriq="+fa_enc(fa_value_get("dp_dat_deb_fabriq")+" "+fa_value_get("tb_heu_deb_fabriq"))+"&";
	vl_c_donnees+="vl_fab_ligne_cleunik="+fa_att_get("tb_fabr_entete_code","_graal_fab_ligne_cleunik")+"&";
  vl_c_donnees+="vl_c_liste_cle="+fa_jsarray2php_00(vl_c_liste_cle)+"&";
	vl_c_donnees+="vl_c_liste_qtefab="+fa_jsarray2php_00(vl_c_liste_qtefab)+"&";
	vl_c_donnees+="vl_c_liste_qtereb="+fa_jsarray2php_00(vl_c_liste_qtereb)+"&";
  vl_c_donnees+="vl_c_liste_valeur_complement_type="+fa_jsarray2php_00(vl_c_liste_valeur_complement_type)+"&";
	vl_c_donnees+="vl_c_liste_valeur_complement="+fa_jsarray2php_00(vl_c_liste_valeur_complement)+"&";
	vl_c_donnees+="vl_c_liste_hg="+fa_jsarray2php_00(vl_c_liste_hg)+"&";
  vl_c_donnees+="vl_c_liste_base_valorisation="+fa_jsarray2php_00(vl_c_liste_base_valorisation)+"&";
	vl_c_donnees+="vl_c_liste_nb_decimales_qte="+fa_jsarray2php_00(vl_c_liste_nb_decimales_qte)+"&";
	vl_c_donnees+="vl_c_liste_nbdec_pu="+fa_jsarray2php_00(vl_c_liste_nbdec_pu)+"&";
  vl_c_donnees+="vl_c_liste_pu="+fa_jsarray2php_00(vl_c_liste_pu)+"&";
	vl_c_donnees+="vl_c_liste_noligne="+fa_jsarray2php_00(vl_c_liste_noligne)+"&";
	vl_c_donnees+="vl_c_liste_art_cleunik="+fa_jsarray2php_00(vl_c_liste_art_cleunik)+"&";	
	vl_c_donnees+="vl_c_liste_unite_quantite="+fa_jsarray2php_00(vl_c_liste_unite_quantite)+"&";
	vl_c_donnees+="vl_c_qtefab="+fa_value_get('tb_fabr_ligne_qte_fabriq_saisie')+"&";
	vl_c_donnees+="vl_c_qtereb="+fa_value_get('tb_fabr_ligne_qte_rebute_saisie')+"&";
	vl_c_donnees+="vl_c_pubru="+fa_value_get('tb_fabr_ligne_pu_saisie_bru')+"&";
	vl_c_donnees+="vl_c_punet="+fa_value_get('tb_fabr_ligne_pu_saisie_net')+"&";
	vl_c_donnees+="vl_c_statut="+fa_mlget('ml_saisie_fabr_ligne_statut')+"&";
  fa_xmlhttprequest_txt(c_fabr_bdope_fen,vl_c_donnees,pf_fabr_solde_valide_fin);
}
function pf_fabr_solde_valide_fin(stream) {
	switch (stream){
		case "-1":
		case "-2":
		case "-3":
		case "-4":
		case "-5":
			alert("Impossible d'enregistrer la saisie. Erreur :"+stream);
			return;
	}
  window.location=document.location;
}
function pf_fabr_statut(){
	var vl_quantite_fab=Number(fa_value_get('tb_fabr_ligne_qte_fabriq_saisie'));
	var vl_quantite_reb=Number(fa_value_get('tb_fabr_ligne_qte_rebute_saisie'));
	var vl_qte_tot=vl_quantite_fab+vl_quantite_reb;
	var vl_qte_deja_lance=Number(fa_value_get('tb_deja_fabr_ligne_qte_lancee'));
	var vl_qte_deja_fabri=Number(fa_value_get('tb_deja_fabr_ligne_qte_fabriq'));
	
	if (vl_qte_tot+vl_quantite_reb>=vl_qte_deja_lance-vl_qte_deja_fabri) {
		fa_mlsel("ml_saisie_fabr_ligne_statut",-40);
	} else {
		fa_mlsel("ml_saisie_fabr_ligne_statut",-23);
	}
}
function pf_fabr_valorise_saisie(){
	var vl_e_nb=fa_cl("arbre_saisie_fabric_lignes_nomenc");
  if (vl_e_nb==0) {return;}
  var vl_valeur_ligne_total=0;
  for(i=0;i<vl_e_nb;i++) { 
    var vl_valeur_ref=Number(fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_pu"));
	  var vl_quantite=Number(fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_quantite_fabriq"));
	  var vl_valeur_complement=Number(fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_valeur_complement"));
	  var vl_valeur_complement_type=Number(fa_cell_get("arbre_saisie_fabric_lignes_nomenc",i,"tc_valeur_complement_type"));
	  var vl_valeur_ligne_01= new Number(vl_valeur_ref*vl_quantite);
	  var vl_valeur_ligne_02= new Number(0);
	  switch (vl_valeur_complement_type) {
	    case "1" : // unitaire
	      vl_valeur_ligne_02=(vl_valeur_complement*vl_quantite);
	      break;
	    case "2" : // Forfaitaire
	      vl_valeur_ligne_02=(vl_valeur_complement);
	      break;
	  }
	  var vl_valeur_ligne=(vl_valeur_ligne_01+vl_valeur_ligne_02);
		vl_valeur_ligne_total+=vl_valeur_ligne;
  }
	var qte_bru=Number(fa_value_get('tb_fabr_ligne_qte_fabriq_saisie'));
	var qte_net=qte_bru-Number(fa_value_get('tb_fabr_ligne_qte_rebute_saisie'));
  fa_value_set("tb_fabr_ligne_pu_saisie_bru",vl_valeur_ligne_total/qte_bru);
	fa_value_set("tb_fabr_ligne_pu_saisie_net",vl_valeur_ligne_total/qte_net);
}
]]></script>
END;
?>
