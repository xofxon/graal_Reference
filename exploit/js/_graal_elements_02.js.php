<?php
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_o_tree_objets;
var vf_o_tree_elements;
var vf_e_obj_cleunik;
var vf_e_sel_cleunik;
var vf_c_action;
var vf_c_url_alimente_table;
var vf_c_script_bdope_fen;
var vf_c_script_edite;
var vf_button;
var vf_c_ValRetour;
//  Affectations
  vf_c_script_bdope_fen='_graal_bdope_elements_01.php';
const c_url_alimente_table="_graal_das_objets_01.php?vl_e_type=$vl_e_type&";
function pf_aa_init() {
  vf_o_tree_objets=fa_gid("arbre_des_objets");
  vf_o_tree_elements=fa_gid("arbre_des_elements")
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  pf_raz_fiche();
  pf_approximatif()
}
function pf_approximatif() {
  if ( fa_value_get("bgj_tb_rechapproxima") == "" ) {return;}
  vf_c_url_alimente_table =  c_url_alimente_table+'vl_c_recherche='+fa_enc(fa_value_get("bgj_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bgj_ml_zone")+'&vl_c_quoi=approx&raf_random='+Math.random()+'&vl_e_limit='+fa_value_get("bgb_tb_limit")+'&uti_cleunik='+fa_mlget("ml_utilisateur")+'&vl_e_langue='+fa_mlget("ml_langue");
  fa_das("arbre_des_elements",vf_c_url_alimente_table)
}
function pf_etat_fen(vv_quoi)  {
   vf_c_action=vv_quoi;
   switch(vv_quoi) {
     case "selectionner": 
      var rowIndex = vf_o_tree_elements.currentIndex;
      if(rowIndex == -1){return;}
      fa_grise_non("bt_supprimer");
      fa_grise_non("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
       break;
     case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_focusdonne('tb_titre');
      break;
     case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      fa_focusdonne('tb_titre');
       break;
     case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_detailler");
      pf_raz_fiche();
      vf_o_tree_objets.focus();
      break;
     case "sortir":
     window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
     //window.history.back(); //  Ne fonctionne que si cette fenetre est une fenetre appellée dans la même fenêtre

     break;   
 default:
 break;
}
  }
function pf_fin_requete(stream){
var vl_datas = stream;
if (vl_datas=='ok') {pf_alimente_table("arbre_des_elements");} else {alert(vl_datas)}
pf_etat_fen('annuler');
}
function pf_raz_fiche(){
  fa_value_set("tb_descriptif_sommaire","")
  fa_value_set("tb_descriptif_sommaire_ancien","")
}
function pf_sel_ligne(vv_qui) 
 {
      if(fa_est_grise("bt_detailler")==true){return};
      switch (vv_qui)
      {
        case "arbre_des_objets":
          var rowIndex = vf_o_tree_objets.currentIndex;
          if(rowIndex == -1){return;}
          vf_e_obj_cleunik=vf_o_tree_objets.view.getCellText( rowIndex ,vf_o_tree_objets.columns.getNamedColumn("fen_cleunik"));
          pf_alimente_table("arbre_des_elements");
          break;
        case "arbre_des_elements":
          var rowIndex = vf_o_tree_elements.currentIndex;
          if(rowIndex == -1){return;}
          var vl_e_ele_cleunik=vf_o_tree_elements.view.getCellText( rowIndex ,vf_o_tree_elements.columns.getNamedColumn("tc_element_ele_cleunik"));
          fa_att_set("tb_titre","_ele_cleunik",vl_e_ele_cleunik);
          fa_gid("tb_titre").value = vf_o_tree_elements.view.getCellText( rowIndex ,vf_o_tree_elements.columns.getNamedColumn("tc_element_titre") );
          fa_gid("tb_descriptif_sommaire").value = vf_o_tree_elements.view.getCellText( rowIndex ,vf_o_tree_elements.columns.getNamedColumn("tc_element_descriptif") );
          fa_gid("tb_commentaire").value = vf_o_tree_elements.view.getCellText( rowIndex ,vf_o_tree_elements.columns.getNamedColumn("tc_element_commentaire") );
          var vl_e_type_objet=vf_o_tree_elements.view.getCellText( rowIndex ,vf_o_tree_elements.columns.getNamedColumn("tc_element_type_objet"));
          fa_mlsel("ml_types_elements",vl_e_type_objet,"_graal_type_objet")
        break;
      }
  }

function pf_validation(vv_quoi)
  {
  var s;
   var vl_e_ele_cleunik=fa_gid("tb_titre").getAttribute("_ele_cleunik");
   s ="vl_e_fen_cleunik="+vf_e_obj_cleunik+"&";
   s +="vl_e_ele_cleunik="+vl_e_ele_cleunik+"&";
   s +="vl_c_titre="+fa_enc(fa_gid("tb_titre").value)+"&";
   s +="vl_c_descriptif="+fa_enc(fa_gid("tb_descriptif_sommaire").value)+"&";
   s +="vl_c_commentaire="+fa_enc(fa_gid("tb_commentaire").value)+"&";
   s +="vl_e_type_objet="+fa_gid("ml_types_elements").selectedItem.getAttribute("_graal_type_objet")+"&";
  switch(vv_quoi) {
     case "enregistrer":
        if (vl_e_ele_cleunik!=-1) {s +="vf_c_action=modifier&";}
        else
        {s +="vf_c_action=ajouter&";}
      break;
     case "supprimer":
       Check = confirm("Confirmez-vous la suppression de cet élément ?");
       if(Check == false) return;
       s +="vf_c_action=supprimer&";
      break;
 }     
       fa_xmlhttprequest_txt(vf_c_script_bdope_fen,s,pf_fin_requete);
}
]]></script>
END;
