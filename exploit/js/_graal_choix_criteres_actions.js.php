<?php
$vl_c_00002=fa_recup_session('mess_00002','');
$vl_tb_droits_traitement=_graal_requete_droits_fenetre("Fen_00435",$vl_e_uti_cleunik);
include("_graal_var_portee.php");
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_url_arbre='_graal_das_choix_critere_01.php?genre=actions&vl_c_nombre=actions&';
const vf_c_script_edite_critere='_graal_xml_criteres_00.php?vl_c_portee=actions&';
const vf_c_script_edite='_graal_xml_choix_criteres_01.php?genre=actions&';
const vf_c_script_bdope_criteres='_graal_bdope_choix_criteres_01.php';
const vf_e_critere_cleunik="$vl_e_critere_cleunik";
const vf_c_script_stats="_graal_fen_graphiques_stat_01.php?critere_cleunik=$vl_e_critere_cleunik&genre=criteres_actions&";
const c_c_script_fen_traitements_actions='_graal_traitements_actions_01.php?type=2&genreged=tousss&quelsdocs=tous&';
var vf_e_nombre_utilisations,vf_e_choix_cleunik;
t_intitule=new Array("raf","$vl_c_bfa_101","$vl_c_bfa_102","$vl_c_bfa_103","$vl_c_bfa_104")
function pf_affiche_datas(stream){
  var vl_c_datas,vl_c_type_acteurs;
  var vl_e_nombre,vl_e_choix_actif,vl_e_portee;
  pf_raz_fiche_bis();
  vl_c_datas = stream;
  fa_value_set('tb_choix_code',fa_xml_get(vl_c_datas,'choix_code'));
  fa_value_set('tb_choix_valeur_texte_01',fa_xml_get(vl_c_datas,'choix_valeur_texte_01'));
  fa_value_set('rdg_choix_actif',fa_xml_get(vl_c_datas,'choix_actif'));
  vf_e_choix_cleunik=fa_xml_get(vl_c_datas,'choix_cleunik');
  vf_e_nombre_utilisations=0;
  for (i=0; i<=1; i++){
  	try {
  		vl_e_nombre=fa_xml_get(vl_c_datas,'nombre_utilisations_'+i);
  		vf_e_nombre_utilisations+=vl_e_nombre;
      vl_c_type_acteurs=fa_xml_get(vl_c_datas,'typeacteur_'+i);
  	} catch (e) {
  		vl_e_nombre=0;
  	}
  }
}
function pf_alimente_defaut(){
  fa_value_set('rdg_choix_actif',1);
}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_value_set('rdg_etat',1);
      fa_value_set('rdg_position',1);
      pf_alimente_defaut();
      pf06_alimente_table_bbb();
      s ="vl_e_critere_cleunik="+fa_enc(vf_e_critere_cleunik)+"&";
      fa_xmlhttprequest_xml(vf_c_script_edite_critere,s,bey_pf_affiche_datas);
      fa_grise_groupe_oui('broadcaster_01');
      fa_grise_groupe_oui('broadcaster_02');
      break;
     case "selectionner":
      if(fa_cui('arb_choix_criteres')==-1){return;}
     if (vf_e_nombre_utilisations==0) {fa_grise_non("bt_supprimer");}else{fa_grise_oui("bt_supprimer");}
     fa_grise_non("bt_modifier");
     fa_grise_oui("bt_ajouter");
     fa_grise_oui("bt_detailler");
     fa_grise_non("bt_annuler");
     fa_grise_oui("bt_sortir");
     fa_grise_oui("bt_enregistrer");
    fa_grise_groupe_oui('broadcaster_02');     
     break;
     case "annuler":
       fa_grise_non("bt_detailler");
       fa_grise_non("bt_ajouter");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
       fa_grise_non("bt_sortir");
       pf_raz_fiche_bis();
       fa_grise_groupe_oui('broadcaster_02');
       break;
     case "ajouter":
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_ajouter");
       fa_grise_oui("bt_detailler");
       fa_grise_non("bt_annuler");
       fa_grise_oui("bt_sortir");
       fa_grise_non("bt_enregistrer");
       pf_raz_fiche_bis();
       pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_02');
       if ($vl_c_codecache==false) {fa_focusdonne("tb_choix_code");} else {fa_focusdonne("tb_choix_valeur_texte_01");} 
       break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_enregistrer");
      fa_focusdonne("tb_choix_valeur_texte_01");
      fa_grise_groupe_non('broadcaster_02');
      break;
    case "sortir":
     window.close();
     break;   
}
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas!='-1'){pf06_alimente_table_bbb();}else{fa_erreur(vl_datas);}
  if (window.opener!=null) {
    window.opener.pf_affiche_choix_criteres_potentiel_action()
  }
  pf_etat_fen('annuler');
}
function pf_ouvre(vv_qui,vv_enclair,vv_quoi,vv_quoi_encore){
  var vl_c_param;
  vl_c_param='vl_e_critere_cleunik='+fa_enc(vf_e_critere_cleunik)+"&";
  vl_c_param+='vl_c_quoi='+fa_enc(vv_quoi)+"&";
  vl_c_param+='vl_c_enclair='+fa_enc(t_intitule[vv_enclair])+"&";
  vl_c_param+='vl_c_code_critere='+fa_enc(fa_value_get('tb_critere_code'))+"&";
  vl_c_param+='vl_c_code_choix='+fa_enc(fa_value_get('tb_choix_code'))+"&";
  vl_c_param+='vl_c_deno_critere='+fa_enc(fa_value_get('tb_critere_denomination'))+"&";
  vl_c_param+='vl_c_deno_choix='+fa_enc(fa_value_get('tb_choix_valeur_texte_01'))+"&";
  switch (vv_quoi_encore) {
    case "choix":
      if (vf_e_choix_cleunik==0) {alert("Pas de choix sélectionné !!! Visualisation impossible!!");return;}
      vl_c_param+='vl_e_choix_cleunik='+fa_enc(vf_e_choix_cleunik)+"&";
      break;
    case "critere":
      vl_c_param+='vl_e_choix_cleunik=0&';
      break;
  }
  if ($vl_tb_droits_traitement[0]==false) {
    alert("on n'a pas le droit")
  } else {
    fa_ouvre(c_c_script_fen_traitements_actions+vl_c_param,1000,800);
  }
}
function pf_ouvre_stats() {
  fa_ouvre(vf_c_script_stats)
}
function pf_raz_fiche(){}
function pf_raz_fiche_bis(){
  fa_value_set('rdg_choix_actif',2);
}
function pf_sel_ligne(vv_objet){
  if (fa_est_grise("bt_detailler")==true) {return};
  var arbre = fa_gid(vv_objet);
  var rowIndex = arbre.currentIndex;
  if(rowIndex == -1){ return;}
  vf_e_choix_cleunik=arbre.view.getCellText( rowIndex ,arbre.columns.getNamedColumn("choix_cleunik"));
  s ="vl_e_choix_cleunik="+fa_enc(vf_e_choix_cleunik)+"&";
  s+="vl_c_portee=actions&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var s;
  switch(vv_quoi) {
      case "enregistrer":
         s ="vl_c_action="+fa_enc(vf_c_action)+"&";
         s +="vl_e_choix_cleunik="+vf_e_choix_cleunik+"&";
         s +="vl_e_critere_cleunik="+fa_enc(vf_e_critere_cleunik)+"&";
         s +="vl_c_choix_actif="+fa_enc(fa_value_get('rdg_choix_actif'))+"&";
         s +="vl_c_portee=$vl_e_action&";
         s +="vl_c_choix_valeur_texte_01="+fa_enc(fa_value_get('tb_choix_valeur_texte_01'))+"&"
         s +="vl_c_code="+fa_enc(fa_value_get('tb_choix_code'))+"&"
      break;
     case "supprimer":
       Check = confirm("$vl_c_00002");
       if(Check == false) return;
       s ="vl_c_action=supprimer&";
       s +="vl_e_choix_cleunik="+vf_e_choix_cleunik+"&";
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_criteres,s,pf_fin_requete);
}
]]></script>
END;
