<?php
$vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));
if (isset($vl_c_xml->selection_interlocuteur)){$selection_interlocuteur=$vl_c_xml->selection_interlocuteur->attributes();}else{$selection_interlocuteur='1';}
if (isset($vl_c_xml->vl_selint_nbcaracrech)){$vl_selint_nbcaracrech=$vl_c_xml->vl_selint_nbcaracrech->attributes();}else{$vl_selint_nbcaracrech='3';}
switch ($vl_c_genreacteur) {
	case "110000": //  interlocuteurs de Entreprise
		$vl_selint_nbcaracrech=-1;	//	pour pouvoir embrayer sur la recherche tout de suite
		break;
}
switch ($vl_c_genreacteur) {
  case "moimoi":  //  Moi
    $vl_c_aa_init="";
    $vl_c_validation_fin="";
    break;
  case "offcli":  //  Interlocuteur privilégié d'une offre client
  case "cdecli":  //  Interlocuteur privilégié d'une commande client
  case "livcli":  //  Interlocuteur privilégié d'une livrisaon client
  case "faccli":  //  Interlocuteur privilégié d'une facture client
  case "demfou":  //  Interlocuteur privilégié d'une demande fournisseur
  case "cdefou":  //  Interlocuteur privilégié d'une commande fournisseur
  case "recfou":  //  Interlocuteur privilégié d'une réception fournisseur
  case "facfou":  //  Interlocuteur privilégié d'une facture fournisseur
  case "relfou":  //  Interlocuteur privilégié d'une relance fournisseur
$vl_c_aa_init=<<<EOT
  vf_c_url_alimente_table=vf_c_script_int+"&raf="+Math.random()+"&vl_c_actifs=7&vl_act_cleunik=$vl_e_act_cleunik&";
  pf_alimente_table();
EOT;
    $vl_c_validation_fin="window.opener.pf_cial_graal_retour('$vl_c_genreacteur',fa_value_get('tb_interlo'));close();";
    break;
  case "tousss": //  interlocuteurs de Tous les acteurs
  case "110001": //  interlocuteurs de prospects clients
  case "110002": //  interlocuteurs de prospects fournisseurs
  case "110003": //  interlocuteurs de clients
  case "110004": //  interlocuteurs de fournisseurs
  case "110005": //  interlocuteurs de autres acteurs
  case "110006": //  interlocuteurs de acteurs indéterminés
  case "110000": //  interlocuteurs de Entreprise
$vl_c_aa_init=<<<EOT
  fa_ael('bbj_ml_qui','ValueChange',po_change_menu);
  po_change_menu();
  var vl_c_recherche=fa_value_get("bbj_tb_rechapproxima");
	if ("$vl_selint_nbcaracrech"!='-1') {
		if (vl_c_recherche.length>=$vl_selint_nbcaracrech)
  	pf_approximatif();
	} else {
		pf_approximatif();
	}
	fa_focusdonne("bbj_tb_rechapproxima");
EOT;
    $vl_c_validation_fin="";
    break;
	case "luilui":  //  Un interlocuteur déjà sélectionné
  case "favori": //  interlocuteurs favoris
$vl_c_aa_init=<<<EOT
  fa_ael('bbj_ml_qui','ValueChange',po_change_menu);
  po_change_menu();
  var vl_c_recherche=fa_value_get("bbj_tb_rechapproxima");
	pf_approximatif();
	fa_focusdonne("bbj_tb_rechapproxima");
EOT;
    $vl_c_validation_fin="";  
  	break;
}
include("_graal_var_portee.php");
switch ($vl_c_id_arbre_inc_interlocuteurs_01) {
  case 'arbre_des_interlocuteurs':
    $vl_c_complement_nom="";
    break;
  case 'arbre_des_interlocuteurs_panier':
    $vl_c_complement_nom="_panier";
    break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_c_url_alimente_table;
const vf_c_script_int='_graal_rech_interlo_01.php?sortie=das';
const vf_c_script_bdope_graal="_graal_bdope_graal_01.php";
const vf_c_script_graal='_graal_das_actions_graal_01.php?';
const vf_c_script_fen_acteur="_graal_fen_acteurs_01.php?genreacteur=";
const lstn_grise = {
	willRebuild : function(event){}, 
	didRebuild  : function(event){fa_att_rem("_graal_fen_actions_graal_01","cursor-wait");fa_grise_fenetre(event,"non");fa_grise_non("bbj_tb_rechapproxima");fa_ro_non("bbj_tb_rechapproxima");} 
}
function pf_aa_init() {
  pf_affiche_arbre_graal();
  fa_att_set("arbre_des_interlocuteurs",'context','pop_selections');
  fa_att_set("rd_principal_non","selected", 'true');
  fa_value_set("rdg_principal",1);
	fa_badl("arbre_des_interlocuteurs",lstn_grise);
  fa_mlsel('ml_graal',$vl_relation_privilege);
  $vl_c_aa_init
}
function pf_acteur_ouvre() {
  var rowIndex = fa_cui("arbre_des_interlocuteurs");if(rowIndex == -1){return;}
  var param=fa_cell_get("arbre_des_interlocuteurs",rowIndex,"typeacteur")+"&act_cleunik="+fa_cell_get("arbre_des_interlocuteurs",rowIndex,"act_cleunik")+"&";
  fa_ouvre(vf_c_script_fen_acteur+param,1000,800);
}

function pf_interlo_ouvre(){
  var rowIndex = fa_cui("arbre_des_interlocuteurs");if(rowIndex == -1){return;}
  var param="genreacteur="+fa_cell_get("arbre_des_interlocuteurs",rowIndex,"typeacteur")+"&vl_e_act_cleunik="+fa_cell_get("arbre_des_interlocuteurs",rowIndex,"act_cleunik")+"&vl_e_interlo_cleunik="+fa_cell_get("arbre_des_interlocuteurs",rowIndex,"int_cleunik")+"&";
  fa_ouvre_interlo(param);
}
function pf_affiche_arbre_graal() {
  var vl_c_param=vf_c_script_graal+"vl_action_cleunik=$vl_e_action_cleunik&raf_random="+Math.random()+"&";
  fa_das("arbre_graal",vl_c_param);
}
function pf_alimente_table() {
  switch (fa_value_get("bbj_ml_qui")) {
    case "000000": case "110000": case "110001": case "110003": case "110002": case "110004": case "110005": case "110006":
      fa_cache_oui("portee");break;
    case "999999": case "888888":
      fa_cache_non("portee");break;
  }
	fa_grise_oui("bbj_tb_rechapproxima");fa_ro_oui("bbj_tb_rechapproxima");
	fa_grise_fenetre("","oui");
	fa_att_set("_graal_fen_actions_graal_01","cursor-wait");
  fa_das("arbre_des_interlocuteurs",vf_c_url_alimente_table);
}
function pf_approximatif() {
  switch (fa_value_get("bbj_ml_qui")) {
    case "000000": case "110000": case "110001": case "110003": case "110002": case "110004": case "110005": case "110006": case "999999":
      if ( fa_value_get("bbj_tb_rechapproxima") == "" ) {return;};
      var item=fa_gid("bbj_ml_actif").selectedItem;
      vf_c_url_alimente_table=vf_c_script_int+'&listecles=&vl_c_recherche='+fa_enc(fa_value_get("bbj_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bbj_ml_zone")+'&vl_c_type='+fa_value_get("bbj_ml_type")+'&vl_c_qui='+fa_value_get("bbj_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bbj_ml_actif")+'&vl_e_panier='+item.getAttribute("_graal_cleunik")+"&";
      break;
    case "888888":
      vf_c_url_alimente_table=vf_c_script_int+'&listecles=&vl_c_recherche='+fa_enc(fa_value_get("bbj_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bbj_ml_zone")+'&vl_c_type='+fa_value_get("bbj_ml_type")+'&vl_c_qui='+fa_value_get("bbj_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs=4&';
      break;
  }
  pf_alimente_table();
}
function pf_etat_fen(vv_quoi){
  switch (vv_quoi) {
    case 'sortir' :
      close();
      break;
  }
}
function pf_fin_requete(vv_stream) {
  var vl_c_data=vv_stream;
  if (vl_c_data!='ok') {alert(vl_c_data);}
  window.opener.pf_affiche_arbre_graal();
  $vl_c_validation_fin
  pf_affiche_arbre_graal();
}
function pf_onunload(){
	fa_brl("arbre_des_interlocuteurs",lstn_grise);
}
function pf_sel_ligne(vv_qui) {
  var i=fa_cui("$vl_c_id_arbre_inc_interlocuteurs_01");if(i==-1){return;}
  fa_value_set("tb_interlo",fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"civilite$vl_c_complement_nom")+" "+fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"qui$vl_c_complement_nom"));
  fa_att_set("tb_interlo","int_cleunik",fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"int_cleunik$vl_c_complement_nom"));
  fa_att_set("tb_interlo","act_cleunik",fa_cell_get("$vl_c_id_arbre_inc_interlocuteurs_01",i,"act_cleunik$vl_c_complement_nom"));
}
function pf_sel_arbre_adresses(){}
function pf_validation(vv_quoi) {
  var vl_c_donnees="";
  vl_c_donnees+="vl_portee=$vl_e_interl&";
  vl_c_donnees+="vl_action_cleunik=$vl_e_action_cleunik&";
  vl_c_donnees+="vl_act_cleunik="+fa_att_get("tb_interlo","act_cleunik")+"&";
  vl_c_donnees+="vl_int_cleunik="+fa_att_get("tb_interlo","int_cleunik")+"&";
  vl_c_donnees+="vl_choix_cleunik="+fa_enc(fa_mlget("ml_graal"))+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_value_get("tb_blocnotebrut"))+"&";
  vl_c_donnees+="vl_principal="+fa_enc(fa_value_get('rdg_principal'))+"&";
  switch(vv_quoi) {
    case "ajouter":
      vl_c_donnees+="vf_c_action=ajouter&";vf_c_action="ajout";
      break;
    case "modifier":
      vl_c_donnees+="vf_c_action=modifier&";vf_c_action="modification";
      break;
    case "supprimer":
        if(confirm("Confirmez-vous la suppression de cette relation ?")== false) return;
        vl_c_donnees+="vf_c_action=supprimer&"
        vf_c_action="suppression";
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_graal,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
