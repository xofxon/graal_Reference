<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_stats.php");
require_once ('calc/classes/OpenOfficeSpreadsheet.class.php');
require_once "sources_excel/class.writeexcel_workbook.inc.php";
require_once "sources_excel/class.writeexcel_worksheet.inc.php";
$date_deb=fa_recup_param('date_deb','1961');
$date_fin=fa_recup_param('date_deb','1961');
$ml_panier_acteurs_01=intval(fa_recup_param('ml_panier_acteurs_01',1));
$ml_art_02=intval(fa_recup_param('ml_art_02',2));
$ml_art_03=intval(fa_recup_param('ml_art_03',4));
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$sortie=fa_recup_param('sortie','das');
$arrondi=0;
stats_rectif_dates($ml_art_03);
/*
 * 1° passage pour l'année demandée
 */
$uuid=_graal_requete_uuid();
$uuid_01=$uuid;
$sql_req="";
fs_construit_requete();
$sql_req_01=$sql_req;
$vf_c_echo=_graal_exec_requete($sql_req_01);
//echo($sql_req_01);
//echo $sql_req_01;
$uuid=_graal_requete_uuid();
$uuid_02=$uuid;
$sql_req="";
$date_deb--;
$date_fin--;
fs_construit_requete();
$sql_req_02=$sql_req;
$vf_c_echo=_graal_exec_requete($sql_req_02);
//echo($sql_req_02);
function fs_construit_requete(){
	global $ml_art_02,$ml_art_03,$uuid,$sql_req,$vl_e_act_cleunik,$date_deb,$date_fin;
	switch ($ml_art_02) {
	  case 1:
	  case 2:
	  case 3:
			switch ($ml_art_03) {
			  case  4: $fic_cial="faccli";$coeff="1";break;
			  case  8: $fic_cial="facfou";$coeff="1";break;
			  case  9: $fic_cial="faccli";$coeff="1";break;
			  case 10: $fic_cial="avocli";$coeff="-1";break;
			}
			switch ($ml_art_03) {
			  case  8:
			  case  9:
			  case 10:
					switch ($ml_art_02) {
					  case 1: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
					  case 2: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
					  case 3: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
					}
					$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
					$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (year(f5.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,f3.act_cleunik ";
					break;
				case 4:
					switch ($ml_art_02) {
					  case 1: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
					  case 2: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
					  case 3: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
					}
					$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
					$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (year(f5.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,f3.act_cleunik ";
					$sql_req.=" union all ";

					$fic_cial="avocli";$coeff="-1";

					switch ($ml_art_02) {
					  case 1: $sql_req.=" select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
					  case 2: $sql_req.=" select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
					  case 3: $sql_req.=" select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
					}
					$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
					$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (year(f5.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,f3.act_cleunik ";
			}
			break;
	  case 4:
			switch ($ml_art_03) {
			  case  4: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_01";$fic_cial_03="_vue_faccli_ht_00_inter";break; //  Factures et avoirs (-110116,-110117) regroupés
			  case  8: $fic_cial_01="_facfou_entetes";$fic_cial_02="_vue_facfou_ht_01";$fic_cial_03="_vue_facfou_ht_00_inter";break;
			  case  9: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_01";$fic_cial_03="_vue_faccli_ht_00_inter";break;
			  case 10: $fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_01";$fic_cial_03="_vue_avocli_ht_00_inter";break;
			}
			switch ($ml_art_03) {
			  case  8:
			  case  9:
			  case 10:
					$sql_req="insert into _temp_stat_01 select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=2 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a3.act_cleunik ";
					$sql_req.=" union all ";
					$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=1 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a3.act_cleunik ";
					break;
			}
			switch ($ml_art_03) {
			  case  4:
					$sql_req="insert into _temp_stat_01 select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=2 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a3.act_cleunik ";
					$sql_req.=" union all ";
					$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=1 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a3.act_cleunik ";
					$sql_req.=" union all ";

					$fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_01";$fic_cial_03="_vue_avocli_ht_00_inter";$coeff="1";

					$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) AS z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=2 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a3.act_cleunik ";
					$sql_req.=" union all ";
					$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) as z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=1 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a3.act_cleunik ";
					break;

			}
			break;
	}
}
if ($ml_panier_acteurs_01!=1){
	$vl_e_panier=$ml_panier_acteurs_01;
	include("_graal_req_panier_acteurs.php");
  	if ($vl_act_cleunik=="") {$vl_act_cleunik=-3;}  //  Impossible
	$sql_complement_condition=" and f00.cleunik_reference in($vl_act_cleunik)";
}
$sql_req_01=<<<XOF
select f2.raisonsoc as client,
(select round(sum(f01.montant),$arrondi) from _temp_stat_01 f01 where f01.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f01.c_uuid and month(f01.dateheure) = 1 ) as 'CA janvier',
(select round(sum(f02.montant),$arrondi) from _temp_stat_01 f02 where f02.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f02.c_uuid and month(f02.dateheure) = 2 ) as 'CA février',
(select round(sum(f03.montant),$arrondi) from _temp_stat_01 f03 where f03.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f03.c_uuid and month(f03.dateheure) = 3 ) as 'CA mars',
(select round(sum(f04.montant),$arrondi) from _temp_stat_01 f04 where f04.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f04.c_uuid and month(f04.dateheure) = 4 ) as 'CA avril',
(select round(sum(f05.montant),$arrondi) from _temp_stat_01 f05 where f05.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f05.c_uuid and month(f05.dateheure) = 5 ) as 'CA mai',
(select round(sum(f06.montant),$arrondi) from _temp_stat_01 f06 where f06.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f06.c_uuid and month(f06.dateheure) = 6 ) as 'CA juin',
(select round(sum(f07.montant),$arrondi) from _temp_stat_01 f07 where f07.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f07.c_uuid and month(f07.dateheure) = 7 ) as 'CA juillet',
(select round(sum(f08.montant),$arrondi) from _temp_stat_01 f08 where f08.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f08.c_uuid and month(f08.dateheure) = 8 ) as 'CA août',
(select round(sum(f09.montant),$arrondi) from _temp_stat_01 f09 where f09.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f09.c_uuid and month(f09.dateheure) = 9 ) as 'CA septembre',
(select round(sum(f10.montant),$arrondi) from _temp_stat_01 f10 where f10.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f10.c_uuid and month(f10.dateheure) =10 ) as 'CA octobre',
(select round(sum(f11.montant),$arrondi) from _temp_stat_01 f11 where f11.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f11.c_uuid and month(f11.dateheure) =11 ) as 'CA novembre',
(select round(sum(f12.montant),$arrondi) from _temp_stat_01 f12 where f12.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f12.c_uuid and month(f12.dateheure) =12 ) as 'CA décembre',
f00.cleunik_reference,f2.act_cleunik as z02,f2.codealphanum15 as z03,f2.typeacteur as z05
 from _temp_stat_01 f00 left join _acteurs f2 on f00.cleunik_reference=f2.act_cleunik
 where f00.c_uuid='$uuid_01' $sql_complement_condition
 group by f00.cleunik_reference order by 1
XOF;
$sql_req_02=<<<XOF
select "CA Total" as client,
(select round(sum(f01.montant),$arrondi) from _temp_stat_01 f01 where f00.c_uuid=f01.c_uuid and month(f01.dateheure) = 1 ) as 'CA janvier',
(select round(sum(f02.montant),$arrondi) from _temp_stat_01 f02 where f00.c_uuid=f02.c_uuid and month(f02.dateheure) = 2 ) as 'CA février',
(select round(sum(f03.montant),$arrondi) from _temp_stat_01 f03 where f00.c_uuid=f03.c_uuid and month(f03.dateheure) = 3 ) as 'CA mars',
(select round(sum(f04.montant),$arrondi) from _temp_stat_01 f04 where f00.c_uuid=f04.c_uuid and month(f04.dateheure) = 4 ) as 'CA avril',
(select round(sum(f05.montant),$arrondi) from _temp_stat_01 f05 where f00.c_uuid=f05.c_uuid and month(f05.dateheure) = 5 ) as 'CA mai',
(select round(sum(f06.montant),$arrondi) from _temp_stat_01 f06 where f00.c_uuid=f06.c_uuid and month(f06.dateheure) = 6 ) as 'CA juin',
(select round(sum(f07.montant),$arrondi) from _temp_stat_01 f07 where f00.c_uuid=f07.c_uuid and month(f07.dateheure) = 7 ) as 'CA juillet',
(select round(sum(f08.montant),$arrondi) from _temp_stat_01 f08 where f00.c_uuid=f08.c_uuid and month(f08.dateheure) = 8 ) as 'CA août',
(select round(sum(f09.montant),$arrondi) from _temp_stat_01 f09 where f00.c_uuid=f09.c_uuid and month(f09.dateheure) = 9 ) as 'CA septembre',
(select round(sum(f10.montant),$arrondi) from _temp_stat_01 f10 where f00.c_uuid=f10.c_uuid and month(f10.dateheure) =10 ) as 'CA octobre',
(select round(sum(f11.montant),$arrondi) from _temp_stat_01 f11 where f00.c_uuid=f11.c_uuid and month(f11.dateheure) =11 ) as 'CA novembre',
(select round(sum(f12.montant),$arrondi) from _temp_stat_01 f12 where f00.c_uuid=f12.c_uuid and month(f12.dateheure) =12 ) as 'CA décembre',
'CA Total',"" z02,"" as z03,"" as z05
 from _temp_stat_01 f00
 where f00.c_uuid='$uuid_01' $sql_complement_condition
 group by f00.c_uuid
 union all
select "CA A-1" as client,
(select round(sum(f01.montant),$arrondi) from _temp_stat_01 f01 where f00.c_uuid=f01.c_uuid and month(f01.dateheure) = 1 ) as 'CA janvier',
(select round(sum(f02.montant),$arrondi) from _temp_stat_01 f02 where f00.c_uuid=f02.c_uuid and month(f02.dateheure) = 2 ) as 'CA février',
(select round(sum(f03.montant),$arrondi) from _temp_stat_01 f03 where f00.c_uuid=f03.c_uuid and month(f03.dateheure) = 3 ) as 'CA mars',
(select round(sum(f04.montant),$arrondi) from _temp_stat_01 f04 where f00.c_uuid=f04.c_uuid and month(f04.dateheure) = 4 ) as 'CA avril',
(select round(sum(f05.montant),$arrondi) from _temp_stat_01 f05 where f00.c_uuid=f05.c_uuid and month(f05.dateheure) = 5 ) as 'CA mai',
(select round(sum(f06.montant),$arrondi) from _temp_stat_01 f06 where f00.c_uuid=f06.c_uuid and month(f06.dateheure) = 6 ) as 'CA juin',
(select round(sum(f07.montant),$arrondi) from _temp_stat_01 f07 where f00.c_uuid=f07.c_uuid and month(f07.dateheure) = 7 ) as 'CA juillet',
(select round(sum(f08.montant),$arrondi) from _temp_stat_01 f08 where f00.c_uuid=f08.c_uuid and month(f08.dateheure) = 8 ) as 'CA août',
(select round(sum(f09.montant),$arrondi) from _temp_stat_01 f09 where f00.c_uuid=f09.c_uuid and month(f09.dateheure) = 9 ) as 'CA septembre',
(select round(sum(f10.montant),$arrondi) from _temp_stat_01 f10 where f00.c_uuid=f10.c_uuid and month(f10.dateheure) =10 ) as 'CA octobre',
(select round(sum(f11.montant),$arrondi) from _temp_stat_01 f11 where f00.c_uuid=f11.c_uuid and month(f11.dateheure) =11 ) as 'CA novembre',
(select sum(f12.montant) from _temp_stat_01 f12 where f00.c_uuid=f12.c_uuid and month(f12.dateheure) =12 ) as 'CA décembre',
'CA A-1',"" z02,"" as z03,"" as z05
 from _temp_stat_01 f00
 where f00.c_uuid='$uuid_02' $sql_complement_condition
 group by f00.c_uuid
XOF;
//die($sql_req_02);
switch ($sortie){
	case "sql":
		header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req_01.EOL.$sql_req_02.EOL;
		exit();
		break;

	case "das":
$result = _graal_requete_bd($sql_req_01);
echo('<donnees>');
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
	    echo(' Acteur="'.fa_ent_xml($row['client']).'"');
	    echo(' cleunik_reference="'.fa_ent_xml($row['cleunik_reference']).'"');
	    echo(' typeacteur="'.fa_ent_xml($row['z05']).'"');
	    if (is_null($row['CA janvier'])||$row['CA janvier']==0) {
	    	echo(' CA_janvier=""');
	    } else {
	    	echo(' CA_janvier="'.fa_ent_xml(number_format(round($row['CA janvier'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA février'])||$row['CA février']==0) {
	    	echo(' CA_février=""');
	    } else {
	    	echo(' CA_février="'.fa_ent_xml(number_format(round($row['CA février'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA mars'])||$row['CA mars']==0) {
	    	echo(' CA_mars=""');
	    } else {
	    	echo(' CA_mars="'.fa_ent_xml(number_format(round($row['CA mars'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA avril'])||$row['CA avril']==0) {
	    	echo(' CA_avril=""');
	    } else {
	    	echo(' CA_avril="'.fa_ent_xml(number_format(round($row['CA avril'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA mai'])||$row['CA mai']==0) {
	    	echo(' CA_mai=""');
	    } else {
	    	echo(' CA_mai="'.fa_ent_xml(number_format(round($row['CA mai'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA juin'])||$row['CA juin']==0) {
	    	echo(' CA_juin=""');
	    } else {
	    	echo(' CA_juin="'.fa_ent_xml(number_format(round($row['CA juin'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA juillet'])||$row['CA juillet']==0) {
	    	echo(' CA_juillet=""');
	    } else {
	    	echo(' CA_juillet="'.fa_ent_xml(number_format(round($row['CA juillet'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA août'])||$row['CA août']==0) {
	    	echo(' CA_août=""');
	    } else {
	    	echo(' CA_août="'.fa_ent_xml(number_format(round($row['CA août'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA septembre'])||$row['CA septembre']==0) {
	    	echo(' CA_septembre=""');
	    } else {
	    	echo(' CA_septembre="'.fa_ent_xml(number_format(round($row['CA septembre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA octobre'])||$row['CA octobre']==0) {
	    	echo(' CA_octobre=""');
	    } else {
	    	echo(' CA_octobre="'.fa_ent_xml(number_format(round($row['CA octobre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA novembre'])||$row['CA novembre']==0) {
	    	echo(' CA_novembre=""');
	    } else {
	    	echo(' CA_novembre="'.fa_ent_xml(number_format(round($row['CA novembre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA décembre'])||$row['CA décembre']==0) {
	    	echo(' CA_décembre=""');
	    } else {
	    	echo(' CA_décembre="'.fa_ent_xml(number_format(round($row['CA décembre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		$total_acteur=0;
		$total_acteur+=$row['CA janvier'];
		$total_acteur+=$row['CA février'];
		$total_acteur+=$row['CA mars'];
		$total_acteur+=$row['CA avril'];
		$total_acteur+=$row['CA mai'];
		$total_acteur+=$row['CA juin'];
		$total_acteur+=$row['CA juillet'];
		$total_acteur+=$row['CA août'];
		$total_acteur+=$row['CA septembre'];
		$total_acteur+=$row['CA octobre'];
		$total_acteur+=$row['CA novembre'];
		$total_acteur+=$row['CA décembre'];
		if (is_null($total_acteur)||$total_acteur==0) {
	    	echo(' CA_annuel=""');
	    } else {
	    	echo(' CA_annuel="'.fa_ent_xml(number_format(round($total_acteur,$arrondi), $arrondi, ',', ' ')).'"');
		}
	     echo('/>');
	}
	_graal_libere_requete_bd($result);
	$result = _graal_requete_bd($sql_req_02);
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
	    echo(' Acteur="'.fa_ent_xml($row['client']).'"');
		if (is_null($row['CA janvier'])||$row['CA janvier']==0) {
	    	echo(' CA_janvier=""');
	    } else {
	    	echo(' CA_janvier="'.fa_ent_xml(number_format(round($row['CA janvier'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA février'])||$row['CA février']==0) {
	    	echo(' CA_février=""');
	    } else {
	    	echo(' CA_février="'.fa_ent_xml(number_format(round($row['CA février'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA mars'])||$row['CA mars']==0) {
	    	echo(' CA_mars=""');
	    } else {
	    	echo(' CA_mars="'.fa_ent_xml(number_format(round($row['CA mars'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA avril'])||$row['CA avril']==0) {
	    	echo(' CA_avril=""');
	    } else {
	    	echo(' CA_avril="'.fa_ent_xml(number_format(round($row['CA avril'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA mai'])||$row['CA mai']==0) {
	    	echo(' CA_mai=""');
	    } else {
	    	echo(' CA_mai="'.fa_ent_xml(number_format(round($row['CA mai'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA juin'])||$row['CA juin']==0) {
	    	echo(' CA_juin=""');
	    } else {
	    	echo(' CA_juin="'.fa_ent_xml(number_format(round($row['CA juin'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA juillet'])||$row['CA juillet']==0) {
	    	echo(' CA_juillet=""');
	    } else {
	    	echo(' CA_juillet="'.fa_ent_xml(number_format(round($row['CA juillet'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA août'])||$row['CA août']==0) {
	    	echo(' CA_août=""');
	    } else {
	    	echo(' CA_août="'.fa_ent_xml(number_format(round($row['CA août'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA septembre'])||$row['CA septembre']==0) {
	    	echo(' CA_septembre=""');
	    } else {
	    	echo(' CA_septembre="'.fa_ent_xml(number_format(round($row['CA septembre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA octobre'])||$row['CA octobre']==0) {
	    	echo(' CA_octobre=""');
	    } else {
	    	echo(' CA_octobre="'.fa_ent_xml(number_format(round($row['CA octobre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA novembre'])||$row['CA novembre']==0) {
	    	echo(' CA_novembre=""');
	    } else {
	    	echo(' CA_novembre="'.fa_ent_xml(number_format(round($row['CA novembre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		if (is_null($row['CA décembre'])||$row['CA décembre']==0) {
	    	echo(' CA_décembre=""');
	    } else {
	    	echo(' CA_décembre="'.fa_ent_xml(number_format(round($row['CA décembre'],$arrondi),$arrondi, ',', ' ')).'"');
		}
		$total_acteur=0;
		$total_acteur+=$row['CA janvier'];
		$total_acteur+=$row['CA février'];
		$total_acteur+=$row['CA mars'];
		$total_acteur+=$row['CA avril'];
		$total_acteur+=$row['CA mai'];
		$total_acteur+=$row['CA juin'];
		$total_acteur+=$row['CA juillet'];
		$total_acteur+=$row['CA août'];
		$total_acteur+=$row['CA septembre'];
		$total_acteur+=$row['CA octobre'];
		$total_acteur+=$row['CA novembre'];
		$total_acteur+=$row['CA décembre'];
		if (is_null($total_acteur)||$total_acteur==0) {
	    	echo(' CA_annuel=""');
	    } else {
	    	echo(' CA_annuel="'.fa_ent_xml(number_format(round($total_acteur,$arrondi), $arrondi, ',', ' ')).'"');
		}
		switch ($row['client']){
			case "CA Total":
				$ca_a=array();
				$ca_a[ 0]=$row['CA janvier'];
				$ca_a[ 1]=$row['CA février'];
				$ca_a[ 2]=$row['CA mars'];
				$ca_a[ 3]=$row['CA avril'];
				$ca_a[ 4]=$row['CA mai'];
				$ca_a[ 5]=$row['CA juin'];
				$ca_a[ 6]=$row['CA juillet'];
				$ca_a[ 7]=$row['CA août'];
				$ca_a[ 8]=$row['CA septembre'];
				$ca_a[ 9]=$row['CA octobre'];
				$ca_a[10]=$row['CA novembre'];
				$ca_a[11]=$row['CA décembre'];
				$ca_a[12]=$total_acteur;
				break;
			case "CA A-1":
				$ca_a1=array();
				$ca_a1[ 0]=$row['CA janvier'];
				$ca_a1[ 1]=$row['CA février'];
				$ca_a1[ 2]=$row['CA mars'];
				$ca_a1[ 3]=$row['CA avril'];
				$ca_a1[ 4]=$row['CA mai'];
				$ca_a1[ 5]=$row['CA juin'];
				$ca_a1[ 6]=$row['CA juillet'];
				$ca_a1[ 7]=$row['CA août'];
				$ca_a1[ 8]=$row['CA septembre'];
				$ca_a1[ 9]=$row['CA octobre'];
				$ca_a1[10]=$row['CA novembre'];
				$ca_a1[11]=$row['CA décembre'];
				$ca_a1[12]=$total_acteur;
			}
	     echo('/>');
	}
	echo('<quoi ');
	    echo(' Acteur="CA A / CA A-1"');
		/*
		 * ligne différence A A -1
		 */
		if (is_null($ca_a1[ 0])||$ca_a1[ 0]==0||$ca_a[ 0]==0) {echo(' CA_janvier="ns"');} else {$dif=$ca_a[ 0]/$ca_a1[ 0];echo(' CA_janvier="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 1])||$ca_a1[ 1]==0||$ca_a[ 1]==0) {echo(' CA_février="ns"');} else {$dif=$ca_a[ 1]/$ca_a1[ 1];echo(' CA_février="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 2])||$ca_a1[ 2]==0||$ca_a[ 2]==0) {echo(' CA_mars="ns"');} else {$dif=$ca_a[ 2]/$ca_a1[ 2];echo(' CA_mars="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 3])||$ca_a1[ 3]==0||$ca_a[ 3]==0) {echo(' CA_avril="ns"');} else {$dif=$ca_a[ 3]/$ca_a1[ 3];echo(' CA_avril="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 4])||$ca_a1[ 4]==0||$ca_a[ 4]==0) {echo(' CA_mai="ns"');} else {$dif=$ca_a[ 4]/$ca_a1[ 4];echo(' CA_mai="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 5])||$ca_a1[ 5]==0||$ca_a[ 5]==0) {echo(' CA_juin="ns"');} else {$dif=$ca_a[ 5]/$ca_a1[ 5];echo(' CA_juin="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 6])||$ca_a1[ 6]==0||$ca_a[ 6]==0) {echo(' CA_juillet="ns"');} else {$dif=$ca_a[ 6]/$ca_a1[ 6];echo(' CA_juillet="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 7])||$ca_a1[ 7]==0||$ca_a[ 7]==0) {echo(' CA_août="ns"');} else {$dif=$ca_a[ 7]/$ca_a1[ 7];echo(' CA_août="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 8])||$ca_a1[ 8]==0||$ca_a[ 8]==0) {echo(' CA_septembre="ns"');} else {$dif=$ca_a[ 8]/$ca_a1[ 8];echo(' CA_septembre="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[ 9])||$ca_a1[ 9]==0||$ca_a[ 9]==0) {echo(' CA_octobre="ns"');} else {$dif=$ca_a[ 9]/$ca_a1[ 9];echo(' CA_octobre="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[10])||$ca_a1[10]==0||$ca_a[10]==0) {echo(' CA_novembre="ns"');} else {$dif=$ca_a[10]/$ca_a1[10];echo(' CA_novembre="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[11])||$ca_a1[11]==0||$ca_a[11]==0) {echo(' CA_décembre="ns"');} else {$dif=$ca_a[11]/$ca_a1[11];echo(' CA_décembre="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		if (is_null($ca_a1[12])||$ca_a1[12]==0||$ca_a[12]==0) {echo(' CA_annuel="ns"');} else {$dif=$ca_a[12]/$ca_a1[12];echo(' CA_annuel="'.fa_ent_xml(number_format(round($dif,2), 2, ',', ' ')).'"');}
		echo('/>');

echo('</donnees>');
_graal_libere_requete_bd($result);
	break;

	case "xls":
		$vl_c_nom_fichier_xls=utf8_decode("CA_Mensuel_Client_$date_deb.xls");
		$fname = tempnam("mail", "$vl_c_nom_fichier_xls");
		$workbook =new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet(utf8_decode("XsOFt-Graal CA Client $date_deb"));
		$result = _graal_requete_bd($sql_req_01);
		$nfields = mysql_num_fields($result);
		$vl_e_noligne=0;
		for ($i=0; $i<$nfields; $i++)
		{
		    $fieldname = mysql_field_name($result, $i);
		    if($i<13) {
		    	$worksheet->write($vl_e_noligne, $i, utf8_decode("$fieldname"));
		    }
			if($i==13) {
		      	$worksheet->write($vl_e_noligne, $i,"Total annuel");
		      }
		}
		//  Lecture des résultats de la requête

		while ($line = mysql_fetch_array($result, MYSQL_ASSOC))
		{
		  $j = 0;
		  $vl_e_noligne++;
		  $total_acteur=0;
		  foreach ($line as $field)
		  {
		      if($j<13) {
		      	$worksheet->write($vl_e_noligne, $j, utf8_decode("$field"));
		      	if($j>0) {$total_acteur+=$field;}
				$j++;
		      }
		      if($j==13) {
		      	$worksheet->write($vl_e_noligne, $j, $total_acteur);
		      }

		  }
		}
		_graal_libere_requete_bd($result);

		/*
		 * 2° requête
		 */

		$result = _graal_requete_bd($sql_req_02);
		$nfields = mysql_num_fields($result);
		//  Lecture des résultats de la requête
		$i=0;
		$ca_a=array();$ca_a1=array();
		while ($line = mysql_fetch_array($result, MYSQL_ASSOC)) {
			$i++;
		  $j = 0;
		  $vl_e_noligne++;
		  $total_acteur=0;
		  foreach ($line as $field)
		  {
		  	if($j<13) {
		      	$worksheet->write($vl_e_noligne, $j, utf8_decode("$field"));
		      	if($j>0) {
		      		$total_acteur+=$field;


		      		 switch ($i){
						case 1:
							$ca_a[$j-1]=$field;
							break;
						case 2:
							$ca_a1[$j-1]=$field;
							break;
			      	}

		      	}
				$j++;
		  	}
		      if($j==13) {
		      	$worksheet->write($vl_e_noligne, $j, $total_acteur);
		      	switch ($i){
					case 1:
						$ca_a[$j-1]=$field;
						break;
					case 2:
						$ca_a1[$j-1]=$field;
						break;
		      	}
		      }
		  }
		}
		$difaa=array();
		/*
		 * ligne différence A A -1
		 */
		if (is_null($ca_a1[ 0])||$ca_a1[ 0]==0||$ca_a[ 0]==0) {$difaa[ 0]="ns";} else {$difaa[ 0]=$ca_a[ 0]/$ca_a1[ 0];}
		if (is_null($ca_a1[ 1])||$ca_a1[ 1]==0||$ca_a[ 1]==0) {$difaa[ 1]="ns";} else {$difaa[ 1]=$ca_a[ 1]/$ca_a1[ 1];}
		if (is_null($ca_a1[ 2])||$ca_a1[ 2]==0||$ca_a[ 2]==0) {$difaa[ 2]="ns";} else {$difaa[ 2]=$ca_a[ 2]/$ca_a1[ 2];}
		if (is_null($ca_a1[ 3])||$ca_a1[ 3]==0||$ca_a[ 3]==0) {$difaa[ 3]="ns";} else {$difaa[ 3]=$ca_a[ 3]/$ca_a1[ 3];}
		if (is_null($ca_a1[ 4])||$ca_a1[ 4]==0||$ca_a[ 4]==0) {$difaa[ 4]="ns";} else {$difaa[ 4]=$ca_a[ 4]/$ca_a1[ 4];}
		if (is_null($ca_a1[ 5])||$ca_a1[ 5]==0||$ca_a[ 5]==0) {$difaa[ 5]="ns";} else {$difaa[ 5]=$ca_a[ 5]/$ca_a1[ 5];}
		if (is_null($ca_a1[ 6])||$ca_a1[ 6]==0||$ca_a[ 6]==0) {$difaa[ 6]="ns";} else {$difaa[ 6]=$ca_a[ 6]/$ca_a1[ 6];}
		if (is_null($ca_a1[ 7])||$ca_a1[ 7]==0||$ca_a[ 7]==0) {$difaa[ 7]="ns";} else {$difaa[ 7]=$ca_a[ 7]/$ca_a1[ 7];}
		if (is_null($ca_a1[ 8])||$ca_a1[ 8]==0||$ca_a[ 8]==0) {$difaa[ 8]="ns";} else {$difaa[ 8]=$ca_a[ 8]/$ca_a1[ 8];}
		if (is_null($ca_a1[ 9])||$ca_a1[ 9]==0||$ca_a[ 9]==0) {$difaa[ 9]="ns";} else {$difaa[ 9]=$ca_a[ 9]/$ca_a1[ 9];}
		if (is_null($ca_a1[10])||$ca_a1[10]==0||$ca_a[10]==0) {$difaa[10]="ns";} else {$difaa[10]=$ca_a[10]/$ca_a1[10];}
		if (is_null($ca_a1[11])||$ca_a1[11]==0||$ca_a[11]==0) {$difaa[11]="ns";} else {$difaa[11]=$ca_a[11]/$ca_a1[11];}
		if (is_null($ca_a1[12])||$ca_a1[12]==0||$ca_a[12]==0) {$difaa[12]="ns";} else {$difaa[12]=$ca_a[12]/$ca_a1[12];}

		$j = 1;
		  $vl_e_noligne++;
		  foreach ($difaa as $field)
		  {
		      $worksheet->write($vl_e_noligne, $j, utf8_decode($field));
		      $j++;
		  }
		_graal_libere_requete_bd($result);
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		break;

}
$sql_req="delete from _temp_stat_01 where c_uuid in ('$uuid_01','$uuid_02');";
$vf_c_echo=_graal_exec_requete($sql_req);
//echo $sql_req;
_graal_ferme_connexion();
?>
