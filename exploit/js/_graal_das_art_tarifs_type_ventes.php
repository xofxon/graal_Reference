<?php
include("_graal_header_xml.inc.php");
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","-1"));
$vl_actif=intval(fa_recup_param("actif",1));	//	tarifs actifs
$vl_e_actif=intval(fa_recup_param("vl_e_actif",1));	//	articles actifs
$vl_limit=intval(fa_recup_param("vl_e_limit",-1));
$vl_c_genre=fa_recup_param('genre','0');  //  1 ventes, 2 achats
$vl_c_sortie=fa_recup_param("sortie","das");
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','tarifs_fournisseurs.xls');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_tarifs=fa_recup_param("vl_c_tarifs","-1");
$sql_req = "SELECT code,description,tar_cleunik,quantite_basse,quantite_haute,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference,";
$sql_req.=" _article.actif as article_actif,_art_tarifs.actif as actif_tarif,";
$sql_req.= _graalsql_date('dateheure_dermaj')." as date_dermaj,";
$sql_req.=" choix_code,choix_valeur_texte_01,"._graalsql_date('dateheure_validite')." as datevalidite,_art_tarifs.actif,_art_tarifs.nb_dec ";
$sql_req.="  FROM _article left join _art_tarifs using(art_cleunik) left join _choix on choix_cleunik=tarif_cleunik where act_cleunik=0 and type=1 ";
if ($vl_e_art_cleunik!=-1){
	$sql_req.=" and _art_tarifs.art_cleunik=$vl_e_art_cleunik and _article.art_cleunik=$vl_e_art_cleunik";
}
if ($vl_c_tarifs!="-1"){
	$sql_req.=" and _art_tarifs.tarif_cleunik in($vl_c_tarifs)";
}
if ($vl_e_art_cleunik==-1){
	switch ($vl_c_zone) {
          case '1': $sql_req.=" and _article.description like '$vl_c_recherche%'";break;//  Description courte
          case '2': $sql_req.=" and _article.code like '$vl_c_recherche%'";break;//  Code
          case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%'";break;//  Mnémotechnique
    }
	switch ($vl_e_actif) {
	  case 1 : $sql_req.= " and _article.actif=1";break;
	  case 2 : $sql_req.= " and _article.actif=2";break;
	  case 3 : break;
	}
	 $sql_req.= " AND _article.types_gestion & 2";
}
switch ($vl_actif) {
  case 1 : $sql_req.= " and _art_tarifs.actif=1";break;
  case 2 : $sql_req.= " and _art_tarifs.actif=2";break;
  case 3 : break;
}

$sql_req.=" order by code,choix_valeur_texte_01";
if ($vl_limit!=-1){
	$sql_req.=" LIMIT $vl_limit";
}
$result = _graal_requete_bd($sql_req);
switch ($vl_c_sortie) {
	case "das":
		echo('<donnees>');
		//echo $sql_req;
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
			echo(' code="'.fa_ent_xml($row['code']).'"');
		    echo(' description="'.fa_ent_xml($row['description']).'"');
		    echo(' date_dermaj="'.fa_ent_xml($row['date_dermaj']).'"');
		    echo(' nouveau_tarif_type_vente=""');
		    echo(' tar_cleunik_type_vente="'.fa_ent_xml($row['tar_cleunik']).'"');
		    echo(' code_type_vente="'.fa_ent_xml($row['choix_code']).'"');
		    echo(' designation_type_vente="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
		    echo(' tarif_type_vente="'.fa_ent_xml($row['pu_reference']).'"');
			echo(' nbdec="'.fa_ent_xml($row['nb_dec']).'"');
		    if ($row['actif_tarif']==1) {
		      echo(' properties_tarif=""');
		    } else {
		      echo(' properties_tarif="css_0001"');
		    }
			if ($row['article_actif']==1) {
		      echo(' properties_article=""');
		    } else {
		      echo(' properties_article="css_0001"');
		    }
		    echo(' datevalidite="'.fa_ent_xml($row['datevalidite']).'"');

		    $borne_basse=fa_reel(fa_ent_xml($row['quantite_basse']),0);
		 	$val_borne_basse=fa_ent_xml($row['quantite_basse'])*1000;
		  	echo(' borne_basse="'.$borne_basse.'"');
		  	printf(' val_borne_basse="%011u"',$val_borne_basse);
		  	$borne_haute=fa_reel(fa_ent_xml($row['quantite_haute']),0);
		 	$val_borne_haute=fa_ent_xml($row['quantite_haute'])*1000;
		  	echo(' borne_haute="'.$borne_haute.'"');
		  	printf(' val_borne_haute="%011u"',$val_borne_haute);
		 echo('/>');
		}
		echo('</donnees>');
		break;
	case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		switch ($vl_c_genre) {
		  case "1": $id_inc_tarifs_particuliers_fournis="Div_00318";break;  //  Tarifs de vente
		  case "2": $id_inc_tarifs_particuliers_fournis="Div_00xxx";break;  //  Tarifs d'achats
		  default: fa_redirige("acces_interdit");break;
		}
		_graal_requete_charge_varlib($id_inc_tarifs_particuliers_fournis,$vl_e_uti_cleunik);
		$vl_c_bdg_005=fa_recup_dico("bdg_005");
		$vl_c_bdg_006=fa_recup_dico("bdg_006");
		$vl_c_bdg_007=fa_recup_dico("bdg_007");
		$vl_c_bdg_030=fa_recup_dico("bdg_030");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Tarifs vente"));
		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("tc_tar_cleunik_type_vente"));
		$worksheet->write(0, 1, utf8_decode("tc_code_tarif_type_vente"));
		$worksheet->write(0, 2, utf8_decode("$vl_c_bdg_006"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bdg_007"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bdg_030"));
		$worksheet->write(0, 5, utf8_decode("Borne basse"));
		$worksheet->write(0, 6, utf8_decode("Borne haute"));
		$worksheet->write(0, 7, utf8_decode("Borne basse"));
		$worksheet->write(0, 8, utf8_decode("Borne haute"));
		$worksheet->write(0, 9, utf8_decode("Dernière MAJ"));
		$worksheet->write(0,10, utf8_decode("Nouveau tarif"));
		$worksheet->write(0,11, utf8_decode("Code article"));
		$worksheet->write(0,12, utf8_decode("Désignation article"));
		$vl_e_noligne=1;

		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['tar_cleunik']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['choix_code']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['choix_valeur_texte_01']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['pu_reference']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['datevalidite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_basse']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_haute']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_basse']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['quantite_haute']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_dermaj']));$j++;
		    $worksheet->write($vl_e_noligne, $j, 0);$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    	break;

	case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
	    break;
}
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
