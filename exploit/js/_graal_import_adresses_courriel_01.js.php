<?php
$vl_c_url_absolue=fa_url_absolue();
$vl_c_bgm_116js=fa_recup_dico_js("bgm_116");
$vl_c_bgm_117js=fa_recup_dico_js("bgm_117");
$vl_c_bgm_118js=fa_recup_dico_js("bgm_118");
$vl_c_bgm_130js=fa_recup_dico_js("bgm_130");
$vl_c_bgm_131js=fa_recup_dico_js("bgm_131");
$vl_c_bgm_132js=fa_recup_dico_js("bgm_132");
$vl_c_bgm_134js=fa_recup_dico_js("bgm_134");
$vl_c_bgm_135js=fa_recup_dico_js("bgm_135");
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_c_action;
var vf_imp_cleunik="$vf_imp_cleunik";
var vf_c_sha1="";
const c_script_lecture_csv="_graal_import_adresses_courriel_01_resultat.php?separateur=";
const c_script_das_courriels="_graal_das_import_adresses_courriels_01.php?vl_e_imp_cleunik=";
const c_script_verif_existence="_graal_import_adresses_courriel_01_verif.php?sha1=";
const c_script_fen_visu_acteurs='_graal_fen_rech_acteurs.php?vl_c_origine=selection&vl_e_genreacteur=tousss&';
const c_script_rech_interlo='_graal_fen_rech_interlocuteurs_01.php?genreacteur=tousss&p02=Fen_00511&';
const c_script_traitement="_graal_import_adresses_courriel_01_traitement.php?var=vs_tempo_panier_lig_cleunik&";
const c_script_suppression="_graal_import_adresses_courriel_01_suppression.php?var=vs_tempo_panier_lig_cleunik&";
const c_das_fichiers="_graal_das_w_import_courriel_entete_01.php?";
const c_script_bdope_entetes="_graal_bdope_w_import_courriel_entete_01.php?";
const c_script_courriel="_graal_import_adresses_courriel_02.php?courriel=";
const lstn_grise = {
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre(event,"non");}
};
const lstn_grise_01 = {
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre(event,"non");}
};

function pf_alimente_arbre() {
	fa_grise_fenetre('',"oui");
	var vl_c_param=c_script_das_courriels+vf_imp_cleunik+"&raf="+Math.random()+"&"
  fa_das("arbre_adresses_courriel",vl_c_param);
}
function pf_alimente_liste_fichiers() {
	fa_grise_fenetre('',"oui");
  fa_das("arbre_entetes_courriels",c_das_fichiers+"&raf="+Math.random()+"&");
}
function pf_courriel_supprime() {
  var vl_t_tableau=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_adresses_courriel");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_web=[];
    var j=-1;
    for(i=0;i<vl_e_nb_sel;i++) {
      j++;
      vl_t_web[j]=fa_cell_get("arbre_adresses_courriel",vl_t_tableau[i],"tc_lig_cleunik");
    }
    if (vl_t_web.length!=0) {
      if (confirm("$vl_c_bgm_134js")!=true) {return;}
			fa_xmlhttprequest_txt(c_script_suppression,"vs_tempo_panier_lig_cleunik="+fa_jsarray2php_00(vl_t_web),pf_courriel_supprime_fin);
    }
  }
}
function pf_courriel_supprime_fin(stream) {
  pf_alimente_arbre();
}
function pf_etat_fen(vv_quoi)  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_oui("bt_exploiter");
      fa_grise_oui("bt_sel_courr");
      fa_grise_oui("bt_sel_inter");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_rafraichir");
			fa_grise_oui("rdg_conserver");
      fa_value_set("menu_02",4);
			fa_badl("arbre_adresses_courriel",lstn_grise);
			fa_badl("arbre_entetes_courriels",lstn_grise_01);
			if (vf_imp_cleunik!=-1) {
				pf_sel_fichier();
			}
      break;
    case "annuler":
      fa_grise_oui("bt_exploiter");
      fa_cache_oui("vb_traitement");
      fa_grise_non("bt_selection");
      fa_grise_non("bt_rouvrir");
      fa_grise_non("tb_emplacement");
      fa_grise_oui("bt_rafraichir");
			fa_grise_oui("rdg_conserver");
      fa_ds("arbre_adresses_courriel","");
      break;
    case "sortir":
       window.history.back(); //  Ne fonctionne que si cette fenetre est une fenetre appellée dans la même fenêtre
      break;
    default:
      break;
  }
}
function pf_fichier_exploite(){
	fa_grise_fenetre('','oui');
  fa03_fichier_lit_et_envoie(c_script_lecture_csv+"1&hash="+vf_c_sha1+"&vl_c_modele="+fa_value_get("menu_02")+"&raf="+Math.random()+"&ged="+fa_value_get("rdg_conserver")+"&",pf_fichier_exploite_fin,fa_value_get("tb_emplacement"));
}
function pf_fichier_exploite_fin(stream) {
//alert(stream)
var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  if (tableau_retour[0]=='-1') {alert(tableau_retour[1]);fa_grise_fenetre('','non');return;}
  vf_imp_cleunik=tableau_retour[0];
  pf_alimente_arbre();
  fa_grise_oui("bt_exploiter");
  fa_cache_non("vb_traitement");
	//fa_grise_fenetre('','non');
}
function pf_fichier_ouvre(vv_quoi){
  switch (vv_quoi) {
    case 1:
      var vl_c_filtre00="Fichiers CSV";
      var vl_c_filtre01="*.csv";
      fa_value_set("tb_emplacement",fa03_sel_fichier(vl_c_filtre00,vl_c_filtre01));
      if (fa_value_get("tb_emplacement")!='' ) {
        vf_c_sha1=fa03_fichier_sha1(fa_value_get("tb_emplacement"));
        fa_xmlhttprequest_txt(c_script_verif_existence+vf_c_sha1+"&raf="+Math.random()+"&","",pf_fichier_ouvre_suite);
      }
      break;
    case 2:
      fa_gid("deck01").selectedIndex=1;
      pf_alimente_liste_fichiers();
      break;
    case 3:
      fa_gid("deck01").selectedIndex=0;
      break;
    case 4:
      var i=fa_cui("arbre_entetes_courriels"); if (i==-1) {return;}
      vf_imp_cleunik=fa_cell_get("arbre_entetes_courriels",i,"tc_imp_cleunik");
			fa_gid("deck01").selectedIndex=0;
      pf_sel_fichier();
      break;
  }
}
function pf_fichier_ouvre_suite(stream) {
  //alert(stream)
  if (stream!=0 && stream!=""){
    if (confirm("$vl_c_bgm_116js")==false) {return;};
    vf_imp_cleunik=stream;
    pf_sel_fichier();
  } else {
    fa_grise_non("bt_exploiter");
		fa_grise_non("rdg_conserver");
  }
}
function pf_fichier_supprime() {
  var i=fa_cui("arbre_entetes_courriels"); if (i==-1) {return;}
  vf_imp_cleunik=fa_cell_get("arbre_entetes_courriels",i,"tc_imp_cleunik");
  if (confirm("$vl_c_bgm_130js")!=true) {return;}
  fa_xmlhttprequest_txt(c_script_bdope_entetes+"&vf_c_action=supprimer&raf="+Math.random()+"&vf_imp_cleunik="+vf_imp_cleunik,"",pf_fichier_supprime_suite);
}
function pf_fichier_supprime_suite(stream) {
  if (stream!="ok") {
    alert("$vl_c_bgm_132js");
  }else {
    alert("$vl_c_bgm_131js");
  }
  pf_alimente_liste_fichiers();
}
function pf_onunload(){
	fa_brl("arbre_adresses_courriel",lstn_grise);
	fa_brl("arbre_entetes_courriels",lstn_grise_01);
}
function pf_ouvre(vv_quoi){
  switch (vv_quoi) {
    case 'acteur': fa_ouvre(c_script_fen_visu_acteurs,1000,800);break;
    case 'interlo':fa_ouvre(c_script_rech_interlo,800,600);break;
    case 'courriel':
      var i=fa_cui("arbre_adresses_courriel"); if (i==-1) {return;}
      var courriel=fa_cell_get("arbre_adresses_courriel",i,"tc_refweb");
      var lig_cleunik=fa_cell_get("arbre_adresses_courriel",i,"tc_lig_cleunik");
      fa_ouvre(c_script_courriel+fa_enc(courriel)+"&lig_cleunik="+lig_cleunik,800,200);
    break;
  }
}
function pf_ouvre_acteur_recup(vl_act_cleunik,vl_c_raisonsoc,vl_c_typeacteur){
  pf_sel_acteur(vl_act_cleunik,vl_c_raisonsoc,vl_c_typeacteur);
}
function pf_ouvre_interlo_recup(vl_int_cleunik,vl_qui, vl_act_cleunik,vl_raisonsoc,vl_portee) {
  fa_value_set("tb_interlo",vl_qui);
  fa_att_set("tb_interlo","_graal_cleunik",vl_int_cleunik);
  fa_value_set("tb_acteur_interlo",vl_raisonsoc);
  fa_att_set("tb_acteur_interlo","_graal_cleunik",vl_act_cleunik);
  fa_grise_non("bt_enregistrer");
}
function pf_sel_acteur(vl_e_act_cleunik,vl_c_raisonsoc,vl_c_typeacteur) {
  fa_value_set("tb_acteur",vl_c_raisonsoc);
  fa_att_set("tb_acteur","_graal_cleunik",vl_e_act_cleunik);
  fa_att_set("tb_acteur","_graal_typeacteur",vl_c_typeacteur);
  fa_grise_non("bt_enregistrer");
}
function pf_sel_fichier() {
  pf_alimente_arbre();
  fa_grise_oui("bt_exploiter");
  fa_cache_non("vb_traitement");
  fa_grise_oui("bt_selection");
  fa_grise_oui("bt_rouvrir");
  fa_grise_oui("tb_emplacement");
  fa_grise_non("bt_rafraichir");
}
function pf_sel_genre(vv_genre) {
  switch (vv_genre) {
    case "1":
      fa_grise_oui("bt_sel_courr");
      fa_grise_non("bt_sel_inter");
      fa_value_set("tb_interlo","");fa_att_set("tb_interlo","_graal_cleunik","");
      fa_value_set("tb_acteur_interlo","");fa_att_set("tb_acteur_interlo","_graal_cleunik","");
      break;
    case "2":
      fa_grise_non("bt_sel_courr");
      fa_grise_oui("bt_sel_inter");
      fa_value_set("tb_acteur","");fa_att_set("tb_acteur","_graal_cleunik","");
      break;
  }
  if (fa_value_get("tb_interlo")=="" && fa_value_get("tb_acteur")=="") {fa_grise_oui("bt_enregistrer");} else {fa_grise_non("bt_enregistrer");}
}
function pf_validation(vv_quoi){
  switch(vv_quoi){
    case "enregistrer":
      var vl_t_tableau=[];
      vl_t_tableau=fa_lignes_selectionnees("arbre_adresses_courriel");
      vl_e_nb_sel=vl_t_tableau.length;
      if (vl_e_nb_sel!=0) {
        var vl_t_web=[];
        var j=-1;
        for(i=0;i<vl_e_nb_sel;i++) {
          if (fa_cell_get("arbre_adresses_courriel",vl_t_tableau[i],"tc_val_nombre_deja")==0) {
            // Pour l'instant (26/09/2007) on n'enregistre pas les adresses de courriel déja présentes dans la base
            //  Il faudra rajouter l'option dans les paramètres d'exploitation de la fenêtre
            j++;
            vl_t_web[j]=fa_cell_get("arbre_adresses_courriel",vl_t_tableau[i],"tc_lig_cleunik");
          }
        }
        if (vl_t_web.length!=0) {
          fa_grise_oui("bt_enregistrer");
          fa_gid("deck01").selectedIndex=2;
					fa_grise_fenetre('','oui');
					var vl_c_donnee="";
				  var vl_e_type=fa_value_get("rdg_defaut");
				  switch (vl_e_type) {
				    case "1" :
				      vl_c_donnee+="act_cleunik="+fa_att_get("tb_acteur","_graal_cleunik","")+"&";
				      vl_c_donnee+="typeacteur="+fa_att_get("tb_acteur","_graal_typeacteur","")+"&";
				      break;
				    case "2" :
				      vl_c_donnee+="act_cleunik="+fa_att_get("tb_acteur_interlo","_graal_cleunik","")+"&";
				      vl_c_donnee+="int_cleunik="+fa_att_get("tb_interlo","_graal_cleunik","")+"&";
				      break;
				  }
				  vl_c_donnee+="type="+vl_e_type+"&vs_tempo_panier_lig_cleunik="+fa_jsarray2php_00(vl_t_web);
					fa_xmlhttprequest_txt(c_script_traitement,vl_c_donnee,pf_validation_fin);
        } else {
          alert("$vl_c_bgm_117js");
        }
      } else {
        alert("$vl_c_bgm_118js");
        return;
      }
  }
}
function pf_validation_fin(stream) {
  alert(stream);
	fa_gid("deck01").selectedIndex=0;
  pf_alimente_arbre();
}
]]></script>
END;
?>
