<?php
switch ($vl_e_pays_adresse){
  case "60000":
    $c_script_recherche_cp_ville="_graal_das_cpville_selection_60000.php?";  //  Recherche des codes postaux villes de france
    break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_adresses_01.php";
const vf_c_script_edite="_graal_xml_act_adresses_01.php";
const c_script_choix="_graal_xml_choix_criteres_01.php?genre=raf&";
var vf_c_action;
var vf_e_act_cleunik;
var vf_e_adr_cleunik;

function pf_aa_init(){
  fa_sep("tb_adr_latitude");
  fa_sep("tb_adr_longitude");
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  vf_e_act_cleunik="$vl_e_act_cleunik";
  vf_e_adr_cleunik="$vl_e_adr_cleunik";
  pf_param_choix_selcpville();
  switch ("$vl_e_adr_cleunik")  {
    case "-1":  //  création
      pf_etat_fen("ajouter");
      break;
    default:
      pf_etat_fen("ini");
      pf_selectionne_adresse();
      break    
  }
}

function pf_affiche_datas(stream){
/* **********  Affichage des données sur fiche adresses courriel ******** */
var vl_c_datas = stream;
var vl_e_nombre,cb_adresse,vl_adr_typecoordonnees;
fa_att_set("_win_fen_act_adresses","_graal_adr_cleunik",fa_xml_get(vl_c_datas,'adr_cleunik'));
vf_e_adr_cleunik=fa_att_get("_win_fen_act_adresses","_graal_adr_cleunik");
fa_value_set("tb_adr_cod",fa_xml_get(vl_c_datas,'adr_cod'))
fa_value_set("tb_adr_complementnom",fa_xml_get(vl_c_datas,'adr_complementnom'))
fa_value_set("tb_adr_ligne1",fa_xml_get(vl_c_datas,'adr_ligne1'))
fa_value_set("tb_adr_ligne2",fa_xml_get(vl_c_datas,'adr_ligne2'))
fa_value_set("tb_adr_ligne3",fa_xml_get(vl_c_datas,'adr_ligne3'))
fa_value_set("tb_adr_cp",fa_xml_get(vl_c_datas,'adr_cp'))
fa_value_set("tb_adr_ville",fa_xml_get(vl_c_datas,'adr_ville'))
fa_value_set("tb_dateheuremodif",fa_xml_get(vl_c_datas,'dateheuremodif'))
fa_value_set("tb_adr_latitude",fa_xml_get(vl_c_datas,'adr_latitude'))
fa_value_set("tb_adr_longitude",fa_xml_get(vl_c_datas,'adr_longitude'))
vl_e_nombre=fa_att_get("cb_adresse_00","_graal_nombre");
vl_e_portee=fa_xml_get(vl_c_datas,'adr_typecoordonnees');
fa_att_set("cb_adresse_00","_graal_adr_typecoordonnees",vl_e_portee)
for(var i=0;i<vl_e_nombre;i++)  {
  cb_adresse="cb_adresse"+i;
  vl_adr_typecoordonnees=fa_att_get(cb_adresse,"_graal_adr_typecoordonnees");
  if ((vl_e_portee & vl_adr_typecoordonnees ) == vl_adr_typecoordonnees) {fa_check(cb_adresse)}
}
vl_e_nombre=fa_gid("ml_pays").itemCount;
for(var i=0;i<vl_e_nombre;i++){
  fa_gid("ml_pays").selectedIndex=i;
  if (fa_xml_get(vl_c_datas,'choix_cleunik')==fa_mlget("ml_pays")){break;}
}
}
function pf_alimente_defaut(){
  fa_value_set("tb_adr_cleunik","")
  fa_value_set("tb_adr_cod","")
  fa_value_set("tb_act_cleunik","")
  fa_value_set("tb_adr_complementnom","")
  fa_value_set("tb_adr_ligne1","")
  fa_value_set("tb_adr_ligne2","")
  fa_value_set("tb_adr_ligne3","")
  fa_value_set("tb_adr_cp","")
  fa_value_set("tb_adr_ville","")
  fa_value_set("tb_choix_cleunik","")
  fa_value_set("tb_dateheuremodif","")
  fa_value_set("tb_adr_latitude","")
  fa_value_set("tb_adr_longitude","")
  fa_value_set("tb_adr_typecoordonnees","")
  var vl_e_nombre=fa_att_get("cb_adresse_00","_graal_nombre");
  for(var i=0;i<vl_e_nombre;i++)  {
    cb_adresse="cb_adresse"+i;
    fa_uncheck(cb_adresse);
  }
}
function pf_etat_fen(vv_quoi)  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_sortir");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_adr_ligne1");
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_adr_ligne1");
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      switch (vf_e_adr_cleunik)      {
        case "-1":  //  création
          pf_etat_fen("ajouter");
          break;
        default:
          pf_etat_fen("ini");
          pf_selectionne_adresse();
          break    
      }
      break;
    case "sortir":
      window.close();
      break;
    default:
      break;
  }
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
	/*
	 * 
	 * Comme la fenêtre est appelée dans une frame on ne peut pas jouer sur window.opener (chercher quand on aura le temps ce qui remplace dans ce cas)
	 * if (window.opener!=null) {try {window.opener.pf_affiche_donnees_adresses();} catch(e){alert(e)}}
	 * 
	 */
  if (vl_datas!="-1"){
      switch (vf_c_action)      {
        case "ajout":
          break;
        case "modification":
          break;
        case "suppression":
          alert("Adresse supprimée.")
          break;
      }
      pf_etat_fen("sortir");
    }
  else
    {
    alert(vl_datas);
    pf_etat_fen("annuler");
    }
}
function pf_raz_fiche(){
  fa_att_set("_win_fen_act_adresses","_graal_adr_cleunik",-1);
  vf_e_adr_cleunik=-1;
  fa_value_set("tb_adr_cod","");
  fa_value_set("tb_adr_complementnom","");
  fa_value_set("tb_adr_ligne1","");
  fa_value_set("tb_adr_ligne2","");
  fa_value_set("tb_adr_ligne3","");
  fa_value_set("tb_adr_cp","");
  fa_value_set("tb_adr_ville","");
  fa_value_set("tb_dateheuremodif","");
  fa_value_set("tb_adr_latitude","");
  fa_value_set("tb_adr_longitude","");
  var vl_e_nombre=fa_att_get("cb_adresse_00","_graal_nombre");
  for(var i=0;i<vl_e_nombre;i++)  {
    cb_adresse="cb_adresse"+i;
    fa_uncheck(cb_adresse);
  }
}
function pf_param_choix_selcpville() {
  fa_att_set("selcpville","autosuggestsearch","$c_script_recherche_cp_ville"+"&");
}
function pf_sel_cp_ville() {
  fa_xmlhttprequest_xml(c_script_choix+"vl_e_choix_cleunik="+fa_att_get('selcpville','_graal_cleunik'),"",pf_sel_cp_ville_fin);
}
function pf_sel_cp_ville_fin(stream) {
  var vl_c_datas=stream;
  fa_value_set('tb_adr_cp',fa_xml_get(vl_c_datas,'choix_code'));
  fa_value_set('tb_adr_ville',fa_xml_get(vl_c_datas,'choix_valeur_texte_01'));
}
function pf_selectionne_adresse(){
  var s ="vl_e_adr_cleunik="+vf_e_adr_cleunik+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi) {
    var vl_c_donnees;
    var vl_e_ele_cleunik;
    vl_c_donnees="";
    vl_c_donnees+="vl_adr_cleunik="+vf_e_adr_cleunik+"&";
    vl_c_donnees+="vl_adr_cod="+fa_enc(fa_value_get("tb_adr_cod"))+"&";
    vl_c_donnees+="vl_act_cleunik="+vf_e_act_cleunik+"&";
    vl_c_donnees+="vl_adr_complementnom="+fa_enc(fa_value_get("tb_adr_complementnom"))+"&";
    vl_c_donnees+="vl_adr_ligne1="+fa_enc(fa_value_get("tb_adr_ligne1"))+"&";
    vl_c_donnees+="vl_adr_ligne2="+fa_enc(fa_value_get("tb_adr_ligne2"))+"&";
    vl_c_donnees+="vl_adr_ligne3="+fa_enc(fa_value_get("tb_adr_ligne3"))+"&";
    vl_c_donnees+="vl_adr_cp="+fa_enc(fa_value_get("tb_adr_cp"))+"&";
    vl_c_donnees+="vl_adr_ville="+fa_enc(fa_value_get("tb_adr_ville"))+"&";
    vl_c_donnees+="vl_choix_cleunik="+fa_enc(fa_mlget("ml_pays"))+"&";
    vl_c_donnees+="vl_adr_latitude="+fa_enc(fa_value_get("tb_adr_latitude"))+"&";
    vl_c_donnees+="vl_adr_longitude="+fa_enc(fa_value_get("tb_adr_longitude"))+"&";
    vl_c_donnees+="vl_adr_typecoordonnees="+fa_enc(fa_att_get("cb_adresse_00","_graal_adr_typecoordonnees"))+"&";
    switch(vv_quoi)    {
      case "enregistrer":
        if (vf_e_adr_cleunik!=-1)
          {vl_c_donnees+="vf_c_action=modifier&";}
        else
          {vl_c_donnees+="vf_c_action=ajouter&";}
        if (parseInt(fa_att_get("cb_adresse_00","_graal_adr_typecoordonnees"))==0) {
        	if (!confirm("Vous n'avez pas déterminé de type d'adresse. Souhaitez-vous continuer ?")){return;}
        }
        break;
      case "supprimer":
          Check = confirm("Confirmez-vous la suppression de cette adresse ?");
          if(Check == false) return;
          vl_c_donnees+="vf_c_action=supprimer&"
        break;
    }
    fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
  }
]]></script>
END;
?>
