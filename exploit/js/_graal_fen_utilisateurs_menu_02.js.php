<?php
$vl_c_bps_107js=fa_recup_dico_js("bps_107");
$vl_c_bps_108js=fa_recup_dico_js("bps_108");
$vl_c_bps_109js=fa_recup_dico_js("bps_109");
if ($vl_c_qui=="lui"){
	$vf_c_script_bdope_doc=<<<EOT
	var vf_c_script_bdope_doc="_graal_bdope_note_01.php?genre=$vl_c_genre&portee_cleunik=$vl_e_portee_cleunik&qui=$vl_c_qui&utilisateur_menu=$vl_e_uti_cleunik";
EOT;
} else {
	$vf_c_script_bdope_doc=<<<EOT
	var vf_c_script_bdope_doc="_graal_bdope_note_01.php?genre=$vl_c_genre&portee_cleunik=$vl_e_portee_cleunik";
EOT;
}
$src_ajout="data:text/html;base64,".base64_encode('<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"<title>Note</title></head><body></body></html>');
$src_ajout="_graal_page_blanche_01.php";
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_e_doc_cleunik;
$vf_c_script_bdope_doc
var vf_c_script_recup_menu="_graal_construit_menu_personalise_01.php?doc_cleunik=";
const c_script_encode_icone='_graal_xml_icones_01.php?sortie=b64&vl_e_icones_cleunik=';
const vf_c_script_edite_note='_graal_bdope_note_03.php?doc_cleunik=';
var vf_c_titre;
var vf_e_ficones_cleunik;
function pf_aa_init() {
}
function pf_change_libelle() {
  var node = aae_pf_getselectednode(vf_tree);
  var nouveau_lib=prompt("$vl_c_bps_107js",node.firstChild.childNodes[0].getAttribute("label"))
  node.firstChild.childNodes[0].setAttribute("label",nouveau_lib);
}
function pf_charge_menu_dest(vv_doc_cleunik,vv_titre,vv_descriptif_sommaire) {
  vf_e_doc_cleunik=vv_doc_cleunik;
  vf_c_titre=vv_titre;
  fa_value_set("tb_descriptif_sommaire",vv_descriptif_sommaire);
  fa_value_set("tb_titre",vv_titre);
  pf_etat_fen("selectionner");
  fa_att_set("content","src",vf_c_script_edite_note+vf_e_doc_cleunik+'&raf_random='+Math.random()+'&');
}
function pf_charge_menu_dest_suite(xml,quel_treechildren){
  //  On ne prends pas la racine car on a des difficultés à mémoriser sans la première ligne !!
  var xmlroot = xml.documentElement.childNodes[0];                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
	fa_gid("treedata_destination").view.selection.select(0);
  pf_etat_fen("selectionner");
}
function pf_charge_menu_orig(vv_doc_cleunik,vv_titre,vv_descriptif_sommaire) {
  fa_vide_arbre("treeitems_origine");
  fa_xmlhttprequest_xml(vf_c_script_recup_menu+vv_doc_cleunik,"",pf_charge_menu_orig_suite,"treeitems_origine")
}
function pf_charge_menu_orig_suite(xml,quel_treechildren){
  //  On ne prends pas la racine car on a des difficultés à mémoriser sans la première ligne !!
  //  On changera l'id de root sinon, ça va foutre le bouzin
  var xmlroot = xml.documentElement.childNodes[0];                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
  var toto=fa_gid("treeitems_origine").childNodes[0];
  //alert("Avant "+toto.getAttribute("id"));
  toto.setAttribute("id","root_origine");
  //alert("Après "+toto.getAttribute("id"));
}

function pf_charge_menu_perso_fin(xml,quel_treechildren) {
  fa_att_set('treedata_destination',"collapsed");
  aae_pf_loadtree(xml,quel_treechildren);
}
function pf_charge_destination_defaut() {
  pf_etat_fen("ajouter");
  fa_vide_arbre("treeitems_destination");
  fa_xmlhttprequest_xml('xml/modele_menu_01.xml',"",pf_charge_destination_defaut_suite,"treeitems_destination");
}
function pf_charge_destination_defaut_suite(xml,quel_treechildren){
  var xmlroot = xml.documentElement;                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
	fa_gid("treedata_destination").view.selection.select(0);
}

function pf_charge_exploitation_defaut_ferme() {
  fa_xmlhttprequest_xml('_graal_construit_menu03_exploitation_01.php','',pf_charge_exploitation_defaut_ferme_fin,'treeitems_origine');
}
function pf_charge_exploitation_defaut_ferme_fin(xml,quel_treechildren) {
  //  On changera l'id de root sinon, ça va foutre le bouzin
  var xmlroot = xml.documentElement;                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
  var toto=fa_gid("treeitems_origine").childNodes[0];
  //alert("Avant 2 "+toto.getAttribute("id"));
  toto.setAttribute("id","root_origine");
  //alert("Après 2 "+toto.getAttribute("id"));
  fa_collapse_tree('treedata_origine');
}
function pf_charge_exploitation_defaut_ouvert() {
  fa_vide_arbre("treeitems_origine");
  fa_xmlhttprequest_xml('_graal_construit_menu03_exploitation_01.php','',pf_charge_exploitation_defaut_ouvert_fin,'treeitems_origine');
}
function pf_charge_exploitation_defaut_ouvert_fin(xml,quel_treechildren) {
  fa_att_set('treedata_origine',"collapsed");
  //  On changera l'id de root sinon, ça va foutre le bouzin
  var xmlroot = xml.documentElement;                                   /* get the first element */
  var xultree = fa_gid(quel_treechildren);                  /* treechildren is the xul container */         
  aae_pf_walkthexmltree(xmlroot,xultree);                                  /* get the party started */
  var toto=fa_gid("treeitems_origine").childNodes[0];
  //alert("Avant 1 "+toto.getAttribute("id"));
  toto.setAttribute("id","root_origine");
  //alert("Après 1 "+toto.getAttribute("id"));
  fa_att_rem('treedata_origine',"collapsed");
}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
   switch(vv_quoi) {
     case "ini":
       fa_grise_non("bt_ajouter");
       fa_grise_oui("bt_dupliquer");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
			 fa_grise_oui("tb_copie_branche");
			 fa_grise_groupe_oui('broadcaster_01');
       break;
    case "selectionner":
      vf_c_action="selectionner"
      //if ((vf_e_droits_proprio & 4) == 4) {fa_grise_non("bt_modifier");}
      //if ((vf_e_droits_proprio & 8) == 8) {fa_grise_non("bt_supprimer");}
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_dupliquer");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      if (vf_e_doc_cleunik <0) {fa_grise_oui("bt_supprimer");}
      break;
     case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_dupliquer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
			fa_grise_non("tb_copie_branche");
			fa_grise_groupe_non('broadcaster_01');
	fa_gid('content').contentDocument.designMode='on';
      break;
    case "dupliquer":
    vf_e_doc_cleunik=0;
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_dupliquer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
			fa_grise_non("tb_copie_branche");
			fa_grise_groupe_non('broadcaster_01');
	fa_gid('content').contentDocument.designMode='on';
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_dupliquer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      vf_e_doc_cleunik=0;
      vf_c_titre="$vl_c_bps_109js";
			fa_grise_non("tb_copie_branche");
			fa_grise_groupe_non('broadcaster_01');
	fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on'");
	fa_att_set("content","src","$src_ajout");
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_dupliquer");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_detailler");
      fa_vide_arbre("treeitems_destination");
		 fa_grise_oui("tb_copie_branche");
		 fa_grise_groupe_oui('broadcaster_01');
	fa_att_set("content","src","$src_ajout");
      break;
     case "sortir":
        window.close();
     break;   
 default:
 break;
}
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas.substring(0,3)!="-1-") {
    window.location=document.location;
  }
  else {
    fa_erreur(vl_datas)
  }
}
function pf_retour_fenetre_ficones(vl_e_ficones_cleunik){
	vf_e_ficones_cleunik=vl_e_ficones_cleunik
	fa_xmlhttprequest_txt(c_script_encode_icone+vl_e_ficones_cleunik,"",pf_retour_fenetre_ficones_fin);
}
function pf_retour_fenetre_ficones_fin(stream){
var vl_c_datas = stream;
var tree = fa_gid("treedata_origine");
    if(tree.currentIndex<0) {return;}
	var selected  = tree.contentView.getItemAtIndex(tree.currentIndex);
      var itemlabel = selected.firstChild.childNodes[0].getAttribute("label");
      var itemLink  = selected.firstChild.childNodes[0].getAttribute("url");
  var e = fa_gid("content");
  var img=e.contentWindow.document.createElement("img");
  img.setAttribute("src", vl_c_datas);
  img.setAttribute("border","0");
  img.setAttribute("onclick","window.parent.fa_att_set('graal_iframe_menu','src','"+itemLink+"');");
  img.setAttribute("oncontextmenu","window.parent.fa_ouvre('"+itemLink+"',0,0);return false;");
  img.setAttribute("alt",itemlabel);
  img.setAttribute("title",itemlabel);
  
  insertNodeAtSelection(e.contentWindow, img);
}
function pf_retour_fenetre_ficones_background(vl_e_ficones_cleunik){
	vf_e_ficones_cleunik=vl_e_ficones_cleunik
	fa_xmlhttprequest_txt(c_script_encode_icone+vl_e_ficones_cleunik,"",pf_retour_fenetre_ficones_background_fin);
}
function pf_retour_fenetre_ficones_background_fin(stream){
	var vl_c_datas = stream;
	fa_gid("content").contentWindow.document.body.background=vl_c_datas
}
function pf_select_branche(){
	var tree = fa_gid("treedata_origine");
    if(tree.currentIndex<0) {return;}
	var selected  = tree.contentView.getItemAtIndex(tree.currentIndex);
      var itemlabel = selected.firstChild.childNodes[0].getAttribute("label");
      var itemLink  = selected.firstChild.childNodes[0].getAttribute("url");
      //fa_value_set("tb_label",itemlabel);
}

function pf_validation(vv_quoi){
  var s="";
  s="vf_e_typedoc=$vl_e_typedoc&";
  s +="vf_e_doc_cleunik="+vf_e_doc_cleunik+"&";
  s +="blocnote_riche="+fa_enc(fa_gid("content").contentWindow.document.documentElement.innerHTML)+"&";
  s +="descriptif_sommaire="+fa_enc(fa_value_get("tb_descriptif_sommaire"))+"&";
  s +="titre="+fa_enc(fa_value_get("tb_titre"))+"&";
  switch(vv_quoi) {
    case "enregistrer":
      if (vf_e_doc_cleunik!=0) {
        s +="vf_c_action=modifier&";
        vf_c_action="modifier";
      } else {
        s +="vf_c_action=ajouter&";
        vf_c_action="ajouter";
      }
      break;
    case "supprimer":
      if(confirm("$vl_c_bps_108js") == false) return;
      s +="vf_c_action=supprimer&";
      vf_c_action="supprimer";
    break;
  }     
  fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
}
]]></script>
END;
?>
