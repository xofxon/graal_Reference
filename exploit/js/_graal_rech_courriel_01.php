<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
include("_graal_var_portee.php");
define('EOL', "\r\n");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_typeacteur=intval(fa_recup_param('typeacteur','9'));
$vl_c_raisonsoc=fa_recup_param('raisonsoc','%');
$vl_c_quoi=intval(fa_recup_param('quoi','4'));
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_c_sortie=fa_recup_param('sortie','rdf');
$vl_e_limit=intval(fa_recup_param('vl_e_limit','4'));
$vl_c_veuxpasdemail=fa_recup_param('vl_c_veuxpasdemail','');
$vl_c_valide=fa_recup_param('vl_c_valide','');
$vl_e_masse=intval(fa_recup_param('masse','0'));
$vl_c_deja_dans_emailing=intval(fa_recup_param('vl_c_deja_dans_emailing',-1));
$vl_e_action_cleunik=intval(fa_recup_param('vl_e_action_cleunik',-1));
if ($vl_c_veuxpasdemail!="") {$vl_c_veuxpasdemail=substr($vl_c_veuxpasdemail, 0, -1);}
if ($vl_c_valide!="") {$vl_c_valide=substr($vl_c_valide, 0, -1);}
$vl_e_operat_genre=intval(fa_recup_param('operat_genre',1));
$vl_c_id_rech_courriel=fa_recup_param('vl_c_id_rech_courriel','????');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','export_courriels.xls');
$vl_e_int_cleunik=intval(fa_recup_param('vl_e_int_cleunik',-1));
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik',-1));

$vl_c_quelleplage=fa_recup_param('vl_c_quelleplage','-2');
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','19610123');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','20610123');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');

switch ($vl_c_quelleplage){
	case 1:	//	=
		$sql_cond_date= " AND date(_act_interlo_mail.dateheureverification) = '$vl_c_datedebut'";
		break;
	case 2:	//	<
		$sql_cond_date= " AND ((date(_act_interlo_mail.dateheureverification) < '$vl_c_datedebut') or (_act_interlo_mail.dateheureverification is null) or (_act_interlo_mail.dateheureverification ='00000000')) ";
		break;
	case 3:	//	>
		$sql_cond_date= " AND ((date(_act_interlo_mail.dateheureverification) > '$vl_c_datedebut') or (_act_interlo_mail.dateheureverification is null) or (_act_interlo_mail.dateheureverification ='00000000')) ";
		break;
	case 4://	Date de vérification de moins d'un mois
		$sql_cond_date= " and datediff(now(),_act_interlo_mail.dateheureverification) <=30";
		break;
	case 5://	Date de vérification de plus d'un mois ou jamais faite
		$sql_cond_date= " and (datediff(now(),_act_interlo_mail.dateheureverification) >30 or _act_interlo_mail.dateheureverification is null ) or (_act_interlo_mail.dateheureverification ='00000000')";
		break;
}
switch ($vl_e_operat_genre){
	case 1:
		$vl_c_operat_genre=" like ";
		break;
	case 2:
		$vl_c_operat_genre=" not like";
		break;
}
$exclusion_deja_emailing_00="";
$exclusion_deja_emailing_01="";
$exclusion_deja_emailing_02="";
if ($vl_c_deja_dans_emailing==2){
	$exclusion_deja_emailing_00=" left join _emailing_refweb on _emailing_refweb.refweb=_act_interlo_mail.refweb and _emailing_refweb.action_cleunik=$vl_e_action_cleunik ";
	$exclusion_deja_emailing_01=" and _emailing_refweb.refweb is null ";
	$exclusion_deja_emailing_02=" group by _act_interlo_mail.refweb ";
}
/*
switch ($vl_c_quoi) {
      case 1 : $orderby=" $exclusion_deja_emailing_02 ORDER BY `raisonsoc` ASC";break;  //  Raison sociale
      case 2 : $orderby=" $exclusion_deja_emailing_02 ORDER BY `nomcommercial` ASC";break;  //  Nom commercial
      case 3 : $orderby=" $exclusion_deja_emailing_02 ORDER BY qui ASC";break;  //  Interlocuteur
      case 4 : $orderby=" $exclusion_deja_emailing_02 ORDER BY `refweb` ASC";break;  //  adresse courriel
      case 5 : $orderby=" $exclusion_deja_emailing_02 ";break;  //  adresse courriel exacte
      case 6 : $orderby=" $exclusion_deja_emailing_02 ";break;  //  Pas de condition supplémentaire particulière
      case 7 : $orderby=" $exclusion_deja_emailing_02 ";break;  //  compte rendu de vérification
      case 8 : $orderby=" $exclusion_deja_emailing_02 ";break;  //  commentaires
      default:
    }
*/

    $orderby=" $exclusion_deja_emailing_02 ";


switch ($vl_c_sortie) {
	case "das":
	case "rdf":
	case "sql":
	case "sql_session":
	case "excel_01":
$sql_req = "SELECT _acteurs.act_cleunik as act_cleunik, _act_interlo.int_cleunik as int_cleunik, _act_interlo_mail.intweb_cleunik as intweb_cleunik,
 _acteurs.raisonsoc as raisonsoc, _acteurs.nomcommercial as nc, _acteurs.typeacteur as typeacteur,_acteurs.actif as act_actif,_act_interlo.actif as int_actif,
 _choix.choix_valeur_texte_01 as civilite, concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui, _act_interlo.prenom as prenom, _act_interlo.patronyme as nom,
  _act_interlo_mail.refweb as refweb, _choixweb.choix_valeur_texte_01 as genreweb, _choixact.choix_valeur_texte_01 as portee,_act_interlo_mail.valide as mail_valide,
	_act_interlo_mail.veuxpasdemail as mail_veuxpasdemail,IFNULL(_act_interlo_mail.dateheureverification,0) as dateheureverification,
	IFNULL(_act_interlo_mail.cr_verification,'.') as cr_verification,_act_interlo_mail.blocnotebrut as mail_blocnotebrut
	from _acteurs
	inner join _act_interlo on _acteurs.act_cleunik = _act_interlo.act_cleunik
	inner join _choix on _choix.choix_cleunik = _act_interlo.choix_cleunik
	inner join _act_interlo_mail on _act_interlo_mail.int_cleunik=_act_interlo.int_cleunik
	inner join _choix _choixweb on _choixweb.choix_cleunik = _act_interlo_mail.choix_cleunik
	inner join _choix _choixact on _choixact.choix_cleunik = _acteurs.typeacteur
	$exclusion_deja_emailing_00
	where 1 = 1 $exclusion_deja_emailing_01 $sql_cond_date";
		break;
	case "comptage";
	$sql_req = "SELECT count(_act_interlo_mail.intweb_cleunik) as nombre
	from _acteurs
	inner join _act_interlo on _acteurs.act_cleunik = _act_interlo.act_cleunik
	inner join _choix on _choix.choix_cleunik = _act_interlo.choix_cleunik
	inner join _act_interlo_mail on _act_interlo_mail.int_cleunik=_act_interlo.int_cleunik
	inner join _choix _choixweb on _choixweb.choix_cleunik = _act_interlo_mail.choix_cleunik
	inner join _choix _choixact on _choixact.choix_cleunik = _acteurs.typeacteur
	$exclusion_deja_emailing_00
	where 1 = 1 $exclusion_deja_emailing_01 $sql_cond_date";
	$orderby="";
	  	break;
}
/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */
$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
switch ($vs_gesacteurs_ml_zone){
	case '1':	//	Accès libre
		$req_liste_noire="";
		$req_liste_blanc="";
		break;
	case '3':	//	Accès sur liste noire
		$req_liste_noire=" and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=_acteurs.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		$req_liste_blanc="";
		break;
	case '4':	//	Accès sur liste blanche
		$req_liste_blanc=" and (select count(*) from _acteurs_blanc where _acteurs_blanc.act_cleunik=_acteurs.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) <> 0 ";
		$req_liste_noire="";
		break;
}
$sql_req.= $req_liste_blanc . $req_liste_noire;
switch ($vl_c_actifs) {
	case '9'://	adresses ayant ouvert un emailing
		$sql_req_trackin="select intweb from _emailing_ouvre where action_cleunik=$vl_e_action_cleunik and nbclic<>0";
		$result = _graal_requete_bd($sql_req_trackin);
$vl_refweb="";
	    while ($row = mysql_fetch_assoc($result)) {
	      $vl_refweb.=$row[intweb].',';
	    }
			_graal_libere_requete_bd($result);
	    if ($vl_refweb!="") {
	      $vl_refweb=substr($vl_refweb, 0, -1);
				$sql_req.=" and intweb_cleunik IN($vl_refweb)";
	    } else {
    		$sql_req.=" and 1=2";
    	}
		break;
	case '8'://	adresses ayant cliqué sur lien emailing (tracking)
		$sql_req_trackin="select intweb from _emailing_trackin where action_cleunik=$vl_e_action_cleunik and nbclic<>0";
		$result = _graal_requete_bd($sql_req_trackin);
$vl_refweb="";
	    while ($row = mysql_fetch_assoc($result)) {
	      $vl_refweb.=$row[intweb].',';
	    }
			_graal_libere_requete_bd($result);
	    if ($vl_refweb!="") {
	      $vl_refweb=substr($vl_refweb, 0, -1);
				$sql_req.=" and intweb_cleunik IN($vl_refweb)";
	    } else {
    		$sql_req.=" and 1=2";
    	}
		break;
  case '3': //  C'est un panier
    $vl_e_panier=fa_recup_param('vl_e_panier','');
    $sql_req_panier = "SELECT panier_requete_selection as req,panier_resultat,panier_type,panier_portee FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
    $result = _graal_requete_bd($sql_req_panier);
    $row = mysql_fetch_assoc($result);
    $panier_portee=$row['panier_portee'];
    //die($sql_req_panier."**".$row['panier_type']);
		switch ($row['panier_type']){
			case 1:	//	liste de clef
	      		$vl_act_cleunik=$row['panier_resultat'];
				break;
			case 2:	//	Requête contenant la clé unique mais pas seulement
			      $sql_req_panier = $row['req'];
			      _graal_libere_requete_bd($result);
			      $result = _graal_requete_bd($sql_req_panier);
			      $vl_act_cleunik="";
			      while ($row = mysql_fetch_assoc($result)) {
			      	//$portee_requete=$panier_portee & $vl_e_interl;
			      	$portee_requete=$panier_portee;
			      	switch ($portee_requete){
			      		case $vl_e_interl:
			      		case $vl_e_procli+$vl_e_interl:
		      			case $vl_e_client+$vl_e_interl:
	      				case $vl_e_profou+$vl_e_interl:
	      				case $vl_e_fourni+$vl_e_interl:
		      			case $vl_e_autrac+$vl_e_interl:
	      				case $vl_e_actind+$vl_e_interl:
			      			$vl_act_cleunik.=$row[int_cleunik].',';
			      			break;
			      		case $vl_e_refweb:
			      			$vl_act_cleunik.=$row[intweb_cleunik].',';
			      			break;
			      		case 0:
			      		case $vl_e_acteur:
			      		case $vl_e_procli+$vl_e_acteur:
		      			case $vl_e_client+$vl_e_acteur:
	      				case $vl_e_profou+$vl_e_acteur:
	      				case $vl_e_fourni+$vl_e_acteur:
		      			case $vl_e_autrac+$vl_e_acteur:
	      				case $vl_e_actind+$vl_e_acteur:
			      			$vl_act_cleunik.=$row[act_cleunik].',';
			      			break;
			      	}
			      }
			      if ($vl_act_cleunik!="") {
			        $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
			      }
				break;
			case 3:	//	Requête ne récupérant que des clés uniques -> directement exploitables
			 	$vl_act_cleunik=$row['req'];
				break;
		}
    _graal_libere_requete_bd($result);
    switch ($panier_portee) {
    	case 8192 ://  Tous les acteurs
      case 8192+2 ://  prospects clients
      case 8192+4 ://  clients
      case 8192+8 ://  Prospects fournisseurs
      case 8192+16 ://  Fournisseurs
      case 8192+32 ://  Autres acteurs
      case 8192+64 ://  Acteurs indéterminés
        $sql_req.=" and _acteurs.act_cleunik in($vl_act_cleunik)";
        break;
      case 4096:		//	tous les interlocuteurs
	  case 4096+2:  //  interlocuteurs de prospects clients
      case 4096+4:  //  interlocuteurs de clients
      case 4096+8:  //  interlocuteurs de prospects fournisseurs
      case 4096+16:  //  interlocuteurs de fournisseurs
      case 4096+32:  //  interlocuteurs d'autres acteurs
      case 4096+64:  //  interlocuteurs d'acteurs indéterminés
        $sql_req.=" and _act_interlo.int_cleunik in($vl_act_cleunik)";
        break;
      case $vl_e_refweb:
      	$sql_req.=" and _act_interlo_mail.intweb_cleunik in($vl_act_cleunik)";
      	break;
    }
    if ($vl_c_veuxpasdemail!="") {$sql_req.=" and _act_interlo_mail.veuxpasdemail in($vl_c_veuxpasdemail)";}
    if ($vl_c_valide!="") {$sql_req.=" and _act_interlo_mail.valide in($vl_c_valide)";}
    /*
		if ($vl_c_deja_dans_emailing==2 && $vl_e_action_cleunik<>-1 && $vl_c_quoi==4) {
			$sql_req.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik and _emailing_refweb.refweb $vl_c_operat_genre '$vl_c_raisonsoc%')";
		}
		if ($vl_c_deja_dans_emailing==2 && $vl_e_action_cleunik<>-1 && $vl_c_quoi<>4) {
			$sql_req.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik)";
		}
	*/
		switch ($vl_c_quoi) {
      case 1 : $sql_req.=" and _acteurs.raisonsoc $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  Raison sociale
      case 2 : $sql_req.=" and _acteurs.nomcommercial $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  Nom commercial
      case 3 : $sql_req.=" and ( concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) $vl_c_operat_genre '$vl_c_raisonsoc%' or concat_ws(' ',_act_interlo.patronyme,_act_interlo.prenom) $vl_c_operat_genre '$vl_c_raisonsoc%') $orderby";break;  //  Interlocuteur
      case 4 : $sql_req.=" and _act_interlo_mail.refweb $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  adresse courriel
      case 5 : $sql_req.=" and _act_interlo_mail.refweb='$vl_c_raisonsoc' $orderby";break;  //  adresse courriel exacte
      case 6 : break;  //  Pas de condition supplémentaire particulière
      case 7 : $sql_req.=" and _act_interlo_mail.cr_verification $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  compte rendu de vérification
      case 8 : $sql_req.=" and _act_interlo_mail.blocnotebrut $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  commentaires
      default:
    }
    $sql_req.="  LIMIT 0, $vl_e_limit";
    break;


    break;
	case '4': //  Les doublons
    $sql_req_panier = "Select f3.refweb from _act_interlo_mail f3 group by f3.refweb having count(f3.refweb) > 1;";
    $result = _graal_requete_bd($sql_req_panier);
    $vl_refweb="";
    while ($row = mysql_fetch_assoc($result)) {
      $vl_refweb.="'".$row[refweb]."',";
    }
		_graal_libere_requete_bd($result);
    if ($vl_refweb!="") {
      $vl_refweb=substr($vl_refweb, 0, -1);
			$sql_req_panier = "Select f3.intweb_cleunik from _act_interlo_mail f3 where refweb in ($vl_refweb);";
	    $result = _graal_requete_bd($sql_req_panier);
	    $vl_refweb="";
	    while ($row = mysql_fetch_assoc($result)) {
	      $vl_refweb.=$row[intweb_cleunik].',';
	    }
			_graal_libere_requete_bd($result);
	    if ($vl_refweb!="") {
	      $vl_refweb=substr($vl_refweb, 0, -1);
				$sql_req.=" and intweb_cleunik IN($vl_refweb)";
	    } else {
    		$sql_req.=" and 1=2";
    	}
    } else {
    	$sql_req.=" and 1=2";
    }
    break;
	case '5': //  Pas encore contrôlés (date de contrôle nulle)
      $vl_refweb=substr($vl_refweb, 0, -1);
		$sql_req_panier = "Select intweb_cleunik from _act_interlo_mail left join _acteurs using(act_cleunik) where dateheureverification is null";
		if ($vl_c_veuxpasdemail!="") {$sql_req_panier.=" and _act_interlo_mail.veuxpasdemail in($vl_c_veuxpasdemail)";}
	    if ($vl_c_valide!="") {$sql_req_panier.=" and _act_interlo_mail.valide in($vl_c_valide)";}
	    /*
			if ($vl_c_deja_dans_emailing==2 && $vl_e_action_cleunik<>-1 && $vl_c_quoi==4) {$sql_req_panier.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik and _emailing_refweb.refweb $vl_c_operat_genre '$vl_c_raisonsoc%')";}
			if ($vl_c_deja_dans_emailing==2 && $vl_e_action_cleunik<>-1 && $vl_c_quoi<>4) {$sql_req_panier.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik)";}
	    */
	    switch ($vl_e_typeacteur) {
	        case 2: $sql_req_panier.=" and _acteurs.typeacteur =110000";break; //  membres de l'entreprise
	        case 3: $sql_req_panier.=" and _acteurs.typeacteur =110001";break; //  Prospects clients
	        case 4: $sql_req_panier.=" and _acteurs.typeacteur =110003";break; //  Clients
	        case 5: $sql_req_panier.=" and _acteurs.typeacteur =110002";break; //  Prospects fournisseurs
	        case 6: $sql_req_panier.=" and _acteurs.typeacteur =110004";break; //  Fournisseurs
	        case 7: $sql_req_panier.=" and _acteurs.typeacteur =110005";break; //  Autres acteurs
	        case 8: $sql_req_panier.=" and _acteurs.typeacteur =110006";break; //  Acteurs indéterminés
	        case 9: break; //  Tous les acteurs
	    }
	    switch ($vl_c_quoi) {
	      case 1 : $sql_req_panier.=" and _acteurs.raisonsoc $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  Raison sociale
	      case 2 : $sql_req_panier.=" and _acteurs.nomcommercial $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  Nom commercial
	      case 3 : $sql_req_panier.=" and ( concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) $vl_c_operat_genre '$vl_c_raisonsoc%' or concat_ws(' ',_act_interlo.patronyme,_act_interlo.prenom) $vl_c_operat_genre '$vl_c_raisonsoc%') $orderby";break;  //  Interlocuteur
	      case 4 : $sql_req_panier.=" and _act_interlo_mail.refweb $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  adresse courriel
	      case 5 : $sql_req_panier.=" and _act_interlo_mail.refweb='$vl_c_raisonsoc' $orderby";break;  //  adresse courriel exacte
	      case 6 : break;  //  Pas de condition supplémentaire particulière
	      default:
	    }
		$sql_req_panier.="  LIMIT 0, $vl_e_limit";
	    $result = _graal_requete_bd($sql_req_panier);
	    $vl_refweb="";
	    while ($row = mysql_fetch_assoc($result)) {
	      $vl_refweb.=$row[intweb_cleunik].',';
	    }
		_graal_libere_requete_bd($result);
	    if ($vl_refweb!="") {
	      $vl_refweb=substr($vl_refweb, 0, -1);
				$sql_req.=" and intweb_cleunik IN($vl_refweb)";
	    } else {
    		$sql_req.=" and 1=2";
			//echo $sql_req_panier;
    	}
    break;
	case "6":	//	les courriels d'un interlocuteur
		$sql_req.=" and _act_interlo_mail.int_cleunik =$vl_e_int_cleunik";
		break;
	case "7":	//	les courriels d'un acteur
		$sql_req.=" and _act_interlo_mail.act_cleunik =$vl_e_act_cleunik";
		break;
  default:
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_courriel');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        //unset($_SESSION["$vl_c_var"]);  //  Attention, il ne faut pas détruire cette variable car en fait ce script est appelé 2 fois dans pf_masse_04_suite de _graal_courriel_traitements_01.js.php
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_intweb_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_intweb_cleunik!="") {
          $vl_intweb_cleunik=substr($vl_intweb_cleunik, 0, -1);
        } else {
          $vl_intweb_cleunik="-99999999999999999";
        }
        $sql_req.=" and intweb_cleunik IN($vl_intweb_cleunik)";
        break;
      default:
    }
    if ($vl_c_veuxpasdemail!="") {$sql_req.=" and _act_interlo_mail.veuxpasdemail in($vl_c_veuxpasdemail)";}
    if ($vl_c_valide!="") {$sql_req.=" and _act_interlo_mail.valide in($vl_c_valide)";}
    /*
		if ($vl_c_deja_dans_emailing==2 && $vl_e_action_cleunik<>-1 && $vl_c_quoi==4) {$sql_req.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik and _emailing_refweb.refweb $vl_c_operat_genre '$vl_c_raisonsoc%')";}
		if ($vl_c_deja_dans_emailing==2 && $vl_e_action_cleunik<>-1 && $vl_c_quoi<>4) {$sql_req.=" and _act_interlo_mail.refweb not IN(select _emailing_refweb.refweb from _emailing_refweb where action_cleunik=$vl_e_action_cleunik)";}
    */
    switch ($vl_e_typeacteur) {
        case 2: $sql_req.=" and _acteurs.typeacteur =110000";break; //  membres de l'entreprise
        case 3: $sql_req.=" and _acteurs.typeacteur =110001";break; //  Prospects clients
        case 4: $sql_req.=" and _acteurs.typeacteur =110003";break; //  Clients
        case 5: $sql_req.=" and _acteurs.typeacteur =110002";break; //  Prospects fournisseurs
        case 6: $sql_req.=" and _acteurs.typeacteur =110004";break; //  Fournisseurs
        case 7: $sql_req.=" and _acteurs.typeacteur =110005";break; //  Autres acteurs
        case 8: $sql_req.=" and _acteurs.typeacteur =110006";break; //  Acteurs indéterminés
        case 9: break; //  Tous les acteurs
    }
    switch ($vl_c_actifs) {
      case '1': $sql_req.=" and _acteurs.actif=1";break; //  actifs
      case '2': $sql_req.=" and _acteurs.actif=2";break;//  inactifs
      case '0': break;//  tous
    }
    switch ($vl_c_quoi) {
      case 1 : $sql_req.=" and _acteurs.raisonsoc $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  Raison sociale
      case 2 : $sql_req.=" and _acteurs.nomcommercial $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  Nom commercial
      case 3 : $sql_req.=" and ( concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) $vl_c_operat_genre '$vl_c_raisonsoc%' or concat_ws(' ',_act_interlo.patronyme,_act_interlo.prenom) $vl_c_operat_genre '$vl_c_raisonsoc%') $orderby";break;  //  Interlocuteur
      case 4 : $sql_req.=" and _act_interlo_mail.refweb $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  adresse courriel
      case 5 : $sql_req.=" and _act_interlo_mail.refweb='$vl_c_raisonsoc' $orderby";break;  //  adresse courriel exacte
      case 6 : break;  //  Pas de condition supplémentaire particulière
      case 7 : $sql_req.=" and _act_interlo_mail.cr_verification $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  compte rendu de vérification
      case 8 : $sql_req.=" and _act_interlo_mail.blocnotebrut $vl_c_operat_genre '$vl_c_raisonsoc%' $orderby";break;  //  commentaires
      default:
    }
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        break;
      default:
        $sql_req.="  LIMIT 0, $vl_e_limit";
    }
    break;
}
switch ($vl_c_sortie) {
	case "das":
	case "rdf":
		session_write_close(); //  Nécessaire pour éviter le blocage du au trop long traitements de vérification d'existence des courriels voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
    	include("_graal_das_courriel_02.php");
    	break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  case "sql_session":
  	$nom_param='req_requete_emailing_'.$vl_e_action_cleunik;
	$_SESSION[$nom_param]=$sql_req;
  	echo $nom_param;
    break;
   case "comptage":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    session_write_close(); //  Nécessaire pour éviter le blocage du au trop long traitements de vérifiaction d'existence des courriels voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
    $result = _graal_requete_bd($sql_req);
	while ($row = mysql_fetch_assoc($result)) {
	  echo($row['nombre']);
	}_graal_libere_requete_bd($result);
	_graal_ferme_connexion();
    //echo $sql_req;
    break;

    case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib($vl_c_id_rech_courriel,$vl_e_uti_cleunik);
		$vl_c_aao_023=fa_recup_dico("aao_023");
		$vl_c_aao_024=fa_recup_dico("aao_024");
		$vl_c_aao_025=fa_recup_dico("aao_025");
		$vl_c_aao_026=fa_recup_dico("aao_026");
		$vl_c_aao_027=fa_recup_dico("aao_027");
		$vl_c_aao_028=fa_recup_dico("aao_028");
		$vl_c_aao_035=fa_recup_dico("aao_035");
		$vl_c_aao_038=fa_recup_dico("aao_038");
		$vl_c_aao_043=fa_recup_dico("aao_043");
		$vl_c_aao_044=fa_recup_dico("aao_044");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook =new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_bsq_107"));
		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("$vl_c_aao_023"));
		$worksheet->write(0, 1, utf8_decode("$vl_c_aao_024"));
		$worksheet->write(0, 2, utf8_decode("$vl_c_aao_025"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_aao_028"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_aao_026"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_aao_027"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_aao_035"));
		$worksheet->write(0, 7, utf8_decode("$vl_c_aao_036"));
		$worksheet->write(0, 8, utf8_decode("$vl_c_aao_038"));
		$worksheet->write(0, 9, utf8_decode("$vl_c_aao_043"));
		$worksheet->write(0,10, utf8_decode("$vl_c_aao_044"));
		$vl_e_noligne=1;
		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['raisonsoc']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['nc']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['civilite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['qui']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['genreweb']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['refweb']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheureverification']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['cr_verification']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['blocnotebrut']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['nom']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['prenom']));$j++;
		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    	break;
}
?>
