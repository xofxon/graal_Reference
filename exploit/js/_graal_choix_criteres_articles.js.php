<?php
$vl_c_00002=fa_recup_session('mess_00002','');
$vl_c_bct_101=fa_recup_dico("bct_101");
$vl_c_bct_102=fa_recup_dico("bct_102");
$vl_c_bct_103=fa_recup_dico("bct_103");
$vl_c_bct_104=fa_recup_dico("bct_104");
$vl_tb_droits_traitement=_graal_requete_droits_fenetre("Fen_00360",$vl_e_uti_cleunik);
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_url_arbre='_graal_das_choix_critere_01.php?genre=articles&vl_c_nombre=articles&';
const vf_c_script_edite_critere='_graal_xml_criteres_00.php';
const vf_c_script_edite='_graal_xml_choix_criteres_01.php?genre=articles&';
const vf_c_script_bdope_criteres='_graal_bdope_choix_criteres_01.php';
const vf_c_script_fen_visu_interlocuteurs='_graal_fen_articles_selection.php?';
const vf_e_critere_cleunik="$vl_e_critere_cleunik";
const vf_c_script_stats="_graal_fen_graphiques_stat_01.php?critere_cleunik=$vl_e_critere_cleunik&genre=criteres_articles&";
const c_c_script_fen_traitements_articles='_graal_traitements_articles_01.php?type=2&';
var vf_e_nombre_utilisations,vf_c_arbre,vf_e_choix_cleunik;
t_intitule=new Array("raf","$vl_c_bct_101","$vl_c_bct_102","$vl_c_bct_103","$vl_c_bct_104")
function pf_affiche_datas(stream){
  var vl_c_datas,vl_c_type_acteurs;
  var vl_e_nombre,vl_e_choix_actif,vl_e_portee;
  pf_raz_fiche_bis();
  vl_c_datas = stream;
  fa_value_set('tb_choix_code',fa_xml_get(vl_c_datas,'choix_code'));
  fa_value_set('tb_choix_valeur_texte_01',fa_xml_get(vl_c_datas,'choix_valeur_texte_01'));
  fa_value_set('rdg_choix_actif',fa_xml_get(vl_c_datas,'choix_actif'));
  vf_e_choix_cleunik=fa_xml_get(vl_c_datas,'choix_cleunik');
  vf_e_nombre_utilisations=0;
  for (i=0; i<=1; i++){
  	try {
  		vl_e_nombre=fa_xml_get(vl_c_datas,'nombre_utilisations');
  		vf_e_nombre_utilisations+=vl_e_nombre;
      vl_c_type_acteurs=fa_xml_get(vl_c_datas,'typeacteur');
  	} catch (e) {
  		vl_e_nombre=0;
  	}
  }
}
function pf_alimente_defaut(){
  fa_value_set('rdg_choix_actif',1);
}
function pf_etat_fen(vv_quoi){
  var vl_e_rowIndex;
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      vf_c_arbre = fa_gid('arb_choix_criteres');
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_value_set('rdg_etat',1);
      fa_value_set('rdg_position',1);
      pf_alimente_defaut();
      pf06_alimente_table_bbb();
      s ="vl_e_critere_cleunik="+fa_enc(vf_e_critere_cleunik)+"&vl_c_portee=articles&";
      fa_xmlhttprequest_xml(vf_c_script_edite_critere,s,bcs_pf_affiche_datas);
      fa_grise_groupe_oui('broadcaster_01');
      fa_grise_groupe_oui('broadcaster_02');
      break;
     case "selectionner":
       vl_e_rowIndex=vf_c_arbre.currentIndex;
      if(vl_e_rowIndex == -1){
        return;
      }
     if (vf_e_nombre_utilisations==0) {fa_grise_non("bt_supprimer");}else{fa_grise_oui("bt_supprimer");}
	 if (vf_e_choix_cleunik<=0) {fa_grise_oui("bt_supprimer");}
     fa_grise_non("bt_modifier");
     fa_grise_oui("bt_ajouter");
     fa_grise_oui("bt_detailler");
     fa_grise_non("bt_annuler");
     fa_grise_oui("bt_sortir");
     fa_grise_oui("bt_enregistrer");
    fa_grise_groupe_oui('broadcaster_02');     
     break;
     case "annuler":
       fa_grise_non("bt_detailler");
       fa_grise_non("bt_ajouter");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
       fa_grise_non("bt_sortir");
       pf_raz_fiche_bis();
       fa_grise_groupe_oui('broadcaster_02');
       break;
     case "ajouter":
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_ajouter");
       fa_grise_oui("bt_detailler");
       fa_grise_non("bt_annuler");
       fa_grise_oui("bt_sortir");
       fa_grise_non("bt_enregistrer");
       pf_raz_fiche_bis();
       pf_alimente_defaut();
       fa_grise_groupe_non('broadcaster_02');       
       if ($vl_c_codecache_choix_article==false) {fa_focusdonne("tb_choix_code");} else {fa_focusdonne("tb_choix_valeur_texte_01");} 
       break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_enregistrer");
       fa_grise_groupe_non('broadcaster_02');      
      fa_focusdonne("tb_choix_valeur_texte_01");
      break;
    case "sortir":
     window.close();
     break;   
}
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas!='-1'){pf06_alimente_table_bbb();}else{fa_erreur(vl_datas);}
  if (window.opener!=null) { window.opener.pf_affiche_choix_criteres_potentiel_article();}
  pf_etat_fen('annuler');
}
function pf_ouvre(vv_qui,vv_enclair,vv_quoi,vv_quoi_encore){
  var vl_c_param;
  vl_c_param='vl_e_critere_cleunik='+fa_enc(vf_e_critere_cleunik)+"&";
  vl_c_param+='vl_c_quoi='+fa_enc(vv_quoi)+"&";
  vl_c_param+='vl_c_enclair='+fa_enc(t_intitule[vv_enclair])+"&";
  vl_c_param+='vl_c_code_critere='+fa_enc(fa_value_get('tb_critere_code'))+"&";
  vl_c_param+='vl_c_code_choix='+fa_enc(fa_value_get('tb_choix_code'))+"&";
  vl_c_param+='vl_c_deno_critere='+fa_enc(fa_value_get('tb_critere_denomination'))+"&";
  vl_c_param+='vl_c_deno_choix='+fa_enc(fa_value_get('tb_choix_valeur_texte_01'))+"&";
  switch (vv_quoi_encore) {
    case "choix":
      if (vf_e_choix_cleunik==0) {alert("Pas de choix sélectionné !!! Visualisation impossible!!");return;}
      vl_c_param+='vl_e_choix_cleunik='+fa_enc(vf_e_choix_cleunik)+"&type=2&";
      break;
    case "critere":
      vl_c_param+='vl_e_choix_cleunik=0&type=3&';
      break;
  }
  if ($vl_tb_droits_traitement[0]==false) {
    alert("on n'a pas le droit")
  } else {
    fa_ouvre(c_c_script_fen_traitements_articles+vl_c_param,1000,800)
  }
}
function pf_ouvre_stats() {
  fa_ouvre(vf_c_script_stats)
}
function pf_raz_fiche(){}
function pf_raz_fiche_bis(){
  fa_value_set('rdg_choix_actif',2);
}
function pf_validation(vv_quoi){
  var s;
  switch(vv_quoi) {
      case "enregistrer":
         s ="vl_c_action="+fa_enc(vf_c_action)+"&";
         s +="vl_e_choix_cleunik="+vf_e_choix_cleunik+"&";
         s +="vl_e_critere_cleunik="+fa_enc(vf_e_critere_cleunik)+"&";
         s +="vl_c_choix_actif="+fa_enc(fa_value_get('rdg_choix_actif'))+"&";
         s +="vl_c_portee=127&";
         s +="vl_c_choix_valeur_texte_01="+fa_enc(fa_value_get('tb_choix_valeur_texte_01'))+"&"
         s +="vl_c_code="+fa_enc(fa_value_get('tb_choix_code'))+"&"
      break;
     case "supprimer":
       Check = confirm("$vl_c_00002");
       if(Check == false) return;
       s ="vl_c_action=supprimer&";
       s +="vl_e_choix_cleunik="+vf_e_choix_cleunik+"&";
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_criteres,s,pf_fin_requete);       
}
]]></script>
END;
