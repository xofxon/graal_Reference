<?php
echo <<<END
<script type="application/x-javascript"><![CDATA[
var isDebugging = true;
var vf_c_base_encours="";
var vf_c_tabl_encours="";
var vf_c_requete_det_01="";
var vf_c_requete_det_02="";
const c_script_verif="_graal_bdope_verif_existence.php";
const vf_c_script_bdope_doc='_graal_bdope_note_01.php';
const vf_c_script_squel='_admin_bd_cree_squelettes_01.php';
const vf_c_script_lambda_txt='_admin_bd_txt_lambda_01.php';
const vf_c_script_lambda_sel='_admin_fen_bd_select_lambda_01.php?';
const vf_c_script_bd='_admin_bd_sql.php?';
const vf_c_sep_mysql='`';
var vf_e_nombre_existe=0;
function pf_aa_init(){
  fa_collapse_tree("arbre_des_objets_bd");
}
function pf_ajoute_liste(vv_liste,vv_label_01,vv_value_01,vv_label_02,vv_value_02){
  var row = document.createElement('listitem');
  var cell = document.createElement('listcell');
  cell.setAttribute('label', vv_label_01 );
  cell.setAttribute('value', vv_value_01 );
  row.appendChild( cell );
  cell = document.createElement('listcell');
  cell.setAttribute('label', vv_label_02 );
  cell.setAttribute('value', vv_value_02 );
  row.appendChild( cell );
  fa_gid('li_actions').appendChild( row );
  //fa_gid(vv_liste).appendChild(row);
}
function pf_edite_req(vv_quoi){
//  switch
//fa_gid('tabpan_01').selectedIndex=2;
}

function pf_execute(){
  //  On récupère l'attribut "Value" de la ligne sélectionné dans la liste
  var vl_c_id_action=fa_gid("li_actions").selectedItems[0].childNodes[0].getAttribute('value');
  var vl_c_action="";
  switch (vl_c_id_action)  {
    case "t_0001":
      vl_c_action=fa_gid("li_actions").selectedItems[0].childNodes[0].getAttribute('label');
      fa_gid('tabpan_01').selectedIndex=1;
      fa_httppost_txt(vf_c_script_bd,vl_c_action,pf_showcolumns);
      //alert(vl_c_action)
      //fa_ouvre(vf_c_script_bd+vl_c_action)
      break;
    case "t_0002":
      vl_c_action=fa_gid("li_actions").selectedItems[0].childNodes[0].getAttribute('label');
      fa_gid('tabpan_01').selectedIndex=0;
      fa_httppost_txt(vf_c_script_lambda_txt,vl_c_action,pf_show_texte);
      break;
    case "t_0005":
      fa_value_set('req_manu_edition',fa_gid("li_actions").selectedItems[0].childNodes[1].getAttribute('value'));
      fa_gid('tabpan_01').selectedIndex=3;
      break;
    case "m_0001":
      var vl_c_url=vf_c_script_lambda_sel;
      vl_c_action=fa_gid("li_actions").selectedItems[0].childNodes[0].getAttribute('label');
      vl_c_url+="vl_c_requete="+vl_c_action+"&";
      fa_gid('tabpan_01').selectedIndex=2;
      fa_att_set("viewarea","src",vl_c_url);
      break;
    case "m_0002":
      var vl_c_url=vf_c_script_lambda_sel;
      vl_c_action=fa_gid("li_actions").selectedItems[0].childNodes[1].getAttribute('value');
      vl_c_url+="vl_c_requete="+fa_enc(vl_c_action)+"&";
      fa_gid('tabpan_01').selectedIndex=2;
      fa_att_set("viewarea","src",vl_c_url);
      break;
    case "t_0003": 
      alert('En développement !!!');
      break;
    case "t_0004":
      var vl_c_url="";
      var vl_c_quoi="";
      vl_c_url+="vl_c_requete_lib="+fa_enc(fa_gid("li_actions").selectedItems[0].childNodes[1].getAttribute('value'))+"&";
      vl_c_url+="vl_c_requete="+fa_enc("Select * from "+vf_c_base_encours+"."+vf_c_tabl_encours)+"&";
      vl_c_url+="vl_c_nom_fenetre="+fa_enc(vf_c_tabl_encours)+"&";
      vl_c_url+="vl_c_nom_table="+fa_enc(vf_c_tabl_encours)+"&";
      vl_c_url+="vl_c_nom_base="+fa_enc(vf_c_base_encours)+"&";
      /*  vl_c_quoi peut prendre comme valeurs :
        'javascript','fenetre_01','fenetre_02','rdf','xml','enregistrement','tout'
      */   
      vl_c_url+="vl_c_prefixe="+fa_enc(fa_gid("tb_prefixe_appli").value)+"&";
      vl_c_url+="vl_b_integre_script="+fa_enc(true)+"&";
      /*  vl_c_quoi peut prendre comme valeurs :
        'javascript','fenetre_01','fenetre_02','rdf','xml','enregistrement','tout'
      */   
      vl_c_quoi="vl_c_quoi="+fa_enc('javascript')+"&";
      fa_xmlhttprequest_txt(vf_c_script_squel,vl_c_url+vl_c_quoi,pf_show_javascript);
      vl_c_quoi="vl_c_quoi="+fa_enc('fenetre_01')+"&";
      fa_xmlhttprequest_txt(vf_c_script_squel,vl_c_url+vl_c_quoi,pf_show_fenetre_01);
      vl_c_quoi="vl_c_quoi="+fa_enc('fenetre_02')+"&";
      fa_xmlhttprequest_txt(vf_c_script_squel,vl_c_url+vl_c_quoi,pf_show_fenetre_02);
      vl_c_quoi="vl_c_quoi="+fa_enc('rdf')+"&";
      fa_xmlhttprequest_txt(vf_c_script_squel,vl_c_url+vl_c_quoi,pf_show_rdf);
      vl_c_quoi="vl_c_quoi="+fa_enc('xml')+"&";
      fa_xmlhttprequest_txt(vf_c_script_squel,vl_c_url+vl_c_quoi,pf_show_xml);
      vl_c_quoi="vl_c_quoi="+fa_enc('enregistrement')+"&";
      fa_xmlhttprequest_txt(vf_c_script_squel,vl_c_url+vl_c_quoi,pf_show_enregistrement);
      fa_gid('tabpan_01').selectedIndex=4;
      break;    
    case "m_0000":
      //  On ne fait rien, c'est une ligne de séparation
      break;
    default:
      alert('Le cas '+vl_c_id_action+' n\'est pas encore géré !!!');
      break;
  }
}

function pf_lance(){
  var vl_c_action="";
  var vl_c_url=vf_c_script_lambda_sel;
  vl_c_action=fa_gid("req_manu_edition").value;
  vl_c_url+="vl_c_requete="+vl_c_action+"&";
  fa_gid('tabpan_03').selectedIndex=1;
  fa_att_set("req_manu_resultat","src",vl_c_url);
}
function pf_sauve_requete(){
  pf_verif_existence();
  if (vf_e_nombre_existe!=0){
      var vl_b_reponse=confirm("Cette requête existe déjà. Confirmez-vous cet enregistrement?");
      if(vl_b_reponse == false) return;
    }
  var s="";
  s +="titre="+fa_enc(fa_gid("tb_titre").value)+"&";
  s +="blocnote_riche="+fa_enc(fa_gid("req_manu_edition").value)+"&";
  s +="descriptif_sommaire="+fa_enc(fa_gid("tb_descriptif_sommaire").value)+"&";
  s +="vf_e_typedoc=8&";
  s +="vf_c_action=ajouter&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_sauve_requete_retour);
}
function pf_sauve_requete_retour(stream){
  var vl_datas = stream;
  if (vl_datas=='ok') 
    {alert("La requête est correctement enregistrée.");}//Tout baigne
  else
    {fa_erreur(vl_datas)}
}
function pf_sel_ligne(vv_qui){
	var tree = fa_gid(vv_qui);
	var selection = tree.contentView.getItemAtIndex(tree.currentIndex);
	var vl_c_type=selection.getAttribute("_graal_type");
  fa_vide_liste("li_actions");
  switch(vl_c_type) {
    case "mysql":
      pf_ajoute_liste("li_actions",'SHOW SESSION VARIABLES;',"m_0001","Variables session","m_0001");
      pf_ajoute_liste("li_actions",'SHOW GLOBAL VARIABLES;',"m_0001","Variables globales","m_0001");
      pf_ajoute_liste("li_actions",'SHOW PROCESSLIST;',"m_0001","Liste des processus","m_0001");
      pf_ajoute_liste("li_actions",'SHOW DATABASES;',"m_0001","Liste des bases","m_0001");
      pf_ajoute_liste("li_actions",'SHOW CHARACTER SET;',"m_0001","Liste des jeux de caractères disponibles","m_0001");
      pf_ajoute_liste("li_actions",'SHOW COLLATION;',"m_0001","Inclut tous les jeux de caractères disponibles.","m_0001");
      pf_ajoute_liste("li_actions",'SHOW ENGINES;',"m_0001","Affiche les informations sur les moteurs de stockage du serveur..","m_0001");
      pf_ajoute_liste("li_actions",'SHOW COUNT(*) ERRORS;',"m_0001","Nombre d'erreurs","m_0001");
      pf_ajoute_liste("li_actions",'SHOW ERRORS;',"m_0001","Liste les erreurs","m_0001");
      pf_ajoute_liste("li_actions",'SHOW COUNT(*) WARNINGS;',"m_0001","Nombre d'alertes","m_0001");
      pf_ajoute_liste("li_actions",'SHOW WARNINGS;',"m_0001","Liste les alertes","m_0001");
      pf_ajoute_liste("li_actions",'CURRENT_USER();',"m_0001","Utilisateur connecté","m_0001");
      pf_ajoute_liste("li_actions",'SHOW GRANTS FOR CURRENT_USER;',"m_0001","Droits de l'utilisateur connecté.","m_0001");
      pf_ajoute_liste("li_actions",'SHOW PRIVILEGES;',"m_0001","Liste des droits que le serveur MySQL supporte.","m_0001");
      pf_ajoute_liste("li_actions",'SHOW STATUS;',"m_0001","Affiche des informations sur le statut du serveur.","m_0001");
      break;
    case "base":
      vf_c_base_encours=selection.getAttribute("_graal_name_base");
      pf_ajoute_liste("li_actions",'SHOW CREATE DATABASE '+vf_c_base_encours+';',"t_0002","Requête pour créer la base","t_0002");
      pf_ajoute_liste("li_actions",'SHOW TABLES from '+vf_c_base_encours+';',"m_0001","Tables de la base","m_0001");
      break;   
    case "table":
     	vf_c_base_encours=selection.getAttribute("_graal_name_base");
      vf_c_tabl_encours=selection.getAttribute("_graal_name_table");
      pf_ajoute_liste("li_actions",'show full columns from '+vf_c_base_encours+"."+vf_c_tabl_encours,"m_0001","Liste des colonnes de la table (Brut de pomme)","m_0001");
      pf_ajoute_liste("li_actions",'show full columns from '+vf_c_base_encours+"."+vf_c_tabl_encours,"t_0001","Liste des colonnes de la table","t_0001");
      pf_ajoute_liste("li_actions",'show create table '+vf_c_base_encours+"."+vf_c_tabl_encours,"t_0002","Requête de création de la table","t_0002")
      pf_ajoute_liste("li_actions",'CHECK TABLE '+vf_c_base_encours+"."+vf_c_tabl_encours,"m_0001","Vérifie l'intégrité de la table ... ATTENTION : peut-être très long...","m_0001")      
      pf_ajoute_liste("li_actions",'',"m_0000",'',"m_0000")
      pf_ajoute_liste("li_actions",'select count(*) as Nombre_Enregistrements from '+vf_c_base_encours+"."+vf_c_tabl_encours,"m_0001","Compter le nombre d'enregistrements de la table","m_0001")      
      pf_ajoute_liste("li_actions",'select * from '+vf_c_base_encours+"."+vf_c_tabl_encours,"m_0001","Récupérer tous les enregistrements ... ATTENTION : peut-être très long...","m_0001")
      break;
    case "lestables":
     	vf_c_base_encours=selection.getAttribute("_graal_name_base");
      pf_ajoute_liste("li_actions",'CREATE TABLE ... ',"t_0003","Créer une nouvelle table dans "+vf_c_base_encours,vf_c_base_encours);
      break;
    default:
      break;
  }
}
function pf_showcolumns(stream){
	var vl_c_requete_det_03="";
  var fields = eval(stream);
	var icon   = "graphics/field.bmp";
	var tree   = fa_gid("treeFields"); //  Attention, c'est l'identifiant de treeitem et c'est tout à fait bon et normal
	var rows   = fields.rows;
	var count=0;
	var i=0;
	var vl_c_nomcol="";
	var vl_c_descol="";
  fa_vide_arbre("treeFields");
	for(i in rows){
		node = fa_ajoute_ligne_dans_arbre(rows[i],icon);
		tree.appendChild(node);
	}
  vl_graal_requete_construite=fa_gid("li_actions").selectedItems[0].childNodes[0].getAttribute('_graal_requete_construite');	
  if (!vl_graal_requete_construite=="") {return;}
  vf_c_requete_det_01="SELECT ";
  vf_c_requete_det_02="SELECT ";
  vl_c_requete_det_03="SELECT ";
  tree = fa_gid("treeStructure");   //  Attention, ici, c'est vraiment l'identifiant de l'arbre, et c'est normal
  count=fa_cl("treeStructure");
  for(i=0;i<count;i++){ 
    vl_c_nomcol=tree.view.getCellText( i ,tree.columns.getNamedColumn("colname"));
    vl_c_descol=tree.view.getCellText( i ,tree.columns.getNamedColumn("colcomm"));
    //  Je ne sais pas si c'est normal, mais les valeurs commencent a priori par un espace dont je n'ai que faire
    vl_c_nomcol=vl_c_nomcol.substring(1,vl_c_nomcol.length)
    vl_c_descol=vl_c_descol.substring(1,vl_c_descol.length)
    vf_c_requete_det_01+=vf_c_sep_mysql+vl_c_nomcol+vf_c_sep_mysql;
    vf_c_requete_det_02+=vf_c_sep_mysql+vl_c_nomcol+vf_c_sep_mysql+" as "+vf_c_sep_mysql+vl_c_nomcol+vf_c_sep_mysql+",";
    vl_c_requete_det_03+=vl_c_nomcol+",";
    if (!vl_c_descol==""){
        //  Bien utiliser la syntaxe avec g -> pour global (remplace toutes les occurrences sinon ne remplace que la première)
        vf_c_requete_det_01+=" as "+vf_c_sep_mysql+vl_c_descol.replace(/'/g,"\\'")+vf_c_sep_mysql;
      }
    vf_c_requete_det_01+=",";
  }
  vf_c_requete_det_01=vf_c_requete_det_01.substring(0,vf_c_requete_det_01.length-1);  //  on enlève la dernière virgule
  vf_c_requete_det_02=vf_c_requete_det_02.substring(0,vf_c_requete_det_02.length-1);  //  on enlève la dernière virgule
  vl_c_requete_det_03=vl_c_requete_det_03.substring(0,vl_c_requete_det_03.length-1);  //  on enlève la dernière virgule
  vf_c_requete_det_01+=" FROM "+vf_c_base_encours+"."+vf_c_tabl_encours;
  vf_c_requete_det_02+=" FROM "+vf_c_base_encours+"."+vf_c_tabl_encours;
  vl_c_requete_det_03+=" FROM "+vf_c_base_encours+"."+vf_c_tabl_encours;
  //pf_ajoute_liste("li_actions","Select ... from ...","m_0002","Récupérer tous les enregistrements avec les commentaires comme identifiants des colonnes... ATTENTION : peut-être très long...",vf_c_requete_det_01)
  pf_ajoute_liste("li_actions","Requête select ...","t_0005","... avec les commentaires comme identifiants des colonnes.",vf_c_requete_det_01)
  //pf_ajoute_liste("li_actions","Select ... from ...","m_0002","Récupérer tous les enregistrements avec les noms des colonnes comme identifiants des colonnes... ATTENTION : peut-être très long...",vf_c_requete_det_02)
  pf_ajoute_liste("li_actions","Requête select ...","t_0005","... avec les noms des colonnes comme identifiants des colonnes.",vf_c_requete_det_02)
  pf_ajoute_liste("li_actions","Requête select ...","t_0005","... uniquement avec les noms des colonnes .",vl_c_requete_det_03)
  pf_ajoute_liste("li_actions",'',"m_0000",'',"m_0000")
  pf_ajoute_liste("li_actions",'Squelette code',"t_0004","Construire un squelette de fenêtre xul correspondant à la table",vf_c_requete_det_01)
  fa_gid("li_actions").selectedItems[0].childNodes[0].setAttribute('_graal_requete_construite','construite');
}
function pf_show_enregistrement (stream) {fa_value_set('sqel_06',stream);}
function pf_show_fenetre_01 (stream) {fa_value_set('sqel_02',stream);}
function pf_show_fenetre_02 (stream) {fa_value_set('sqel_03',stream);}
function pf_show_javascript(stream) {fa_value_set('sqel_01',stream);}
function pf_show_rdf(stream) {fa_value_set('sqel_04',stream);}
function pf_show_texte(stream) {fa_value_set('sqleditor',stream);}
function pf_show_xml (stream) {fa_value_set('sqel_05',stream);}

function pf_verif_existence(){
  var vl_c_req="";
  vl_c_req +="vl_c_valeur="+fa_enc(fa_gid("req_manu_edition").value)+"&";
  vl_c_req +="vl_c_identi=00001&";
  fa_xmlhttprequest_txt(c_script_verif,vl_c_req,pf_verif_existence_retour);
}
function pf_verif_existence_retour(stream){vf_e_nombre_existe=stream;}
]]></script>
END;
?>
