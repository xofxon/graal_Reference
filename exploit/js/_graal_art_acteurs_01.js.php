<?php
switch ($vl_e_type) {
  case 110004:  // fournisseur
  case 110002:  // prospect fournisseur
    $vf_c_arbre_art_acteur="arbre_art_fournisseurs";
    $vf_c_script_das_art_acteur='_graal_das_art_fournis_01.php?';
    $pf_affiche_fenetre_mere="if (window.opener!=null) {try {window.opener.pf_affiche_donnees_art_four();} catch(e){}}";
    break;
  case 110003:  // clients
	case 110001:  // prospects clients
    $vf_c_arbre_art_acteur="arbre_art_clients";
    $vf_c_script_das_art_acteur='_graal_das_art_client_01.php?';
    $pf_affiche_fenetre_mere="if (window.opener!=null) {try {window.opener.pf_affiche_donnees_art_cli();} catch(e){}}";
    break;
}
switch ($vl_c_genre) {
  case 'article':
    $vf_c_script_das_art_acteur.="vl_e_act_cleunik=-1&vl_e_art_cleunik=$vl_e_art_cleunik&raf_random=";
    break;
  case 'acteur':  // clients
    $vf_c_script_das_art_acteur.="vl_e_act_cleunik=$vl_e_act_cleunik&vl_e_art_cleunik=-1&raf_random=";
    break;
}

echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_art_acteur_01.php?type=$vl_e_type&";
const vf_c_script_recherche_acteurs="_graal_rech_acteurs_01.php?";
const vf_c_script_das_art_acteur="$vf_c_script_das_art_acteur";
const vf_c_script_xml_art_acteur="_graal_xml_art_acteur_01.php?vl_e_art_acteur_cleunik=$vl_e_art_acteur_cleunik&";
var vf_c_action,vf_c_url_alimente_table;
var vf_e_act_cleunik,vf_e_art_cleunik;
function pf_aa_init() {
  fa_cache_oui("portee");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  vf_e_act_cleunik=$vl_e_act_cleunik;
  vf_e_art_cleunik=$vl_e_art_cleunik;
  pf_affiche_donnees_art_acteur();
  if ($vl_e_art_acteur_cleunik!=0) {
    fa_xmlhttprequest_xml(vf_c_script_xml_art_acteur,"",pf_affiche_donnees);
  }
  else {
    if ($vl_e_act_cleunik!=-1) {
      fa_focusdonne("bbo_tb_rechapproxima");
      fa_approximatif_bbo();
    }
    else
    {
      fa_focusdonne("aai_tb_rechapproxima");
      pf_approximatif_acteur();
    }
  }
  
}
function pf_affiche_donnees(stream){
var vl_e_unite_reappro,vl_e_nombre,vl_c_datas;
vl_c_datas=stream;
vf_e_art_cleunik=fa_xml_get(vl_c_datas,'art_cleunik')
vf_e_act_cleunik=fa_xml_get(vl_c_datas,'act_cleunik')
fa_value_set('tb_blocnotebrut',fa_xml_get(vl_c_datas,'blocnotebrut'));
fa_value_set('tb_acteur',fa_xml_get(vl_c_datas,'raisonsoc'));
fa_value_set('tb_code_mnemotechnique',fa_xml_get(vl_c_datas,'mnemotechnique'));
fa_value_set('tb_code_description',fa_xml_get(vl_c_datas,'desi_article_interne'));
fa_value_set('tb_code_art',fa_xml_get(vl_c_datas,'code_article_interne'));
fa_value_set('tb_description',fa_xml_get(vl_c_datas,'description'));
fa_value_set('tb_code',fa_xml_get(vl_c_datas,'code'));
fa_value_set("dp_dateheurevalidite",fa_xml_get(vl_c_datas,'dateheurevalidite'));
END;
if (($vl_e_type==110004) || ($vl_e_type==110002)){
echo <<<END
fa_value_set('tb_delai_reappro',fa_xml_get(vl_c_datas,'delai_reappro'));
fa_mlsel("ml_unite_reappro",fa_xml_get(vl_c_datas,'unite_reappro'));
fa_mlsel("ml_unite_achat",fa_xml_get(vl_c_datas,'unite_achat'));
fa_value_set("tb_minimum_commande",fa_xml_get(vl_c_datas,'minimum_commande'));
END;
}
echo <<<END
}
function pf_affiche_donnees_art_acteur(){
  fa_das("$vf_c_arbre_art_acteur","$vf_c_script_das_art_acteur"+Math.random()+"&");
}
function pf_approximatif(){
  if (vf_e_act_cleunik!=-1) {
    fa_approximatif_bbo();
  }
  else
  {
    pf_approximatif_acteur();
  }
}
function pf_approximatif_acteur(){
  if ( fa_value_get("aai_tb_rechapproxima") == "" ) {return;}
  var item=fa_gid("bao_ml_actif").selectedItem; 
  vf_c_url_alimente_table=vf_c_script_recherche_acteurs+'sortie=das&vl_c_limit='+fa_enc(fa_value_get("bao_tb_limit"))+'&vl_c_recherche='+fa_enc(fa_value_get("aai_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("aai_ml_zone")+'&vl_c_type='+fa_value_get("aai_ml_type")+'&vl_c_qui='+fa_value_get("bao_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bao_ml_actif")+'&vl_e_panier='+item.getAttribute("_graal_cleunik")+"&";
  fa_ds("arbre_des_acteurs", '');
  fa_ds("arbre_des_acteurs",vf_c_url_alimente_table);
}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "sortir":
      window.close();
      break;
  }
}
function pf_fin_requete(stream){
  var vl_datas = stream;
	//alert(vl_datas);
  if (vl_datas=="-1"){alert(vl_datas);}
  pf_affiche_donnees_art_acteur();
  $pf_affiche_fenetre_mere
  if (vf_c_action=="supprimer") {
  	pf_etat_fen("sortir");
  }
}
function pf_raz_fiche(){
  fa_value_set("tb_blocnotebrut",'');
}
function pf_sel_ligne(){
  var i=fa_cui("arbre_des_acteurs");if(i==-1){return;}
  vf_e_act_cleunik=fa_cell_get("arbre_des_acteurs",i,"act_cleunik");  //  Clé unique acteur
  fa_value_set("tb_acteur",fa_cell_get("arbre_des_acteurs",i,"qui")+' ('+fa_cell_get("arbre_des_acteurs",i,"raisonsoc")+')');
}
function pf_sel_arbre_articles(){
  var rowIndex = fa_cui("arbre_des_articles");if(rowIndex == -1){return;}
  vf_e_art_cleunik=fa_cell_get("arbre_des_articles",rowIndex ,"art_cleunik");  //  Clé unique article
  fa_value_set("tb_code_art",fa_cell_get("arbre_des_articles",rowIndex ,"code"));
  fa_value_set("tb_code_mnemotechnique",fa_cell_get("arbre_des_articles",rowIndex ,"mnemotech"));
  fa_value_set("tb_code_description",fa_cell_get("arbre_des_articles",rowIndex ,"description"));
}
function pf_validation(vv_quoi){
  var vl_c_donnees;
  if (vf_e_act_cleunik=='-1') {alert("Sélectionnez un fournisseur !!");return;}
  if (vf_e_art_cleunik=='-1') {alert("Sélectionnez un article !!");return;}
  vl_c_donnees="";
  vl_c_donnees+="vl_act_cleunik="+vf_e_act_cleunik+"&";
  vl_c_donnees+="vl_art_cleunik="+vf_e_art_cleunik+"&";
  vl_c_donnees+="vl_art_acteur_cleunik="+$vl_e_art_acteur_cleunik+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_value_get("tb_blocnotebrut"))+"&";
  vl_c_donnees+="vl_code="+fa_enc(fa_value_get("tb_code"))+"&";
  vl_c_donnees+="vl_description="+fa_enc(fa_value_get("tb_description"))+"&";
  vl_c_donnees+="vl_dateheurevalidite="+fa_enc(fa_value_get("dp_dateheurevalidite"))+"&";
END;
if (($vl_e_type==110004) || ($vl_e_type==110002)){
echo <<<END
  vl_c_donnees+="vl_delai_reappro="+fa_enc(fa_value_get("tb_delai_reappro"))+"&";
  vl_c_donnees+="vl_unite_reappro="+fa_enc(fa_mlget("ml_unite_reappro"))+"&";
  vl_c_donnees+="vl_minimum_commande="+fa_enc(fa_value_get("tb_minimum_commande"))+"&";
  vl_c_donnees+="vl_unite_achat="+fa_enc(fa_mlget("ml_unite_achat"))+"&";
END;
}
echo <<<END
  if ($vl_e_art_acteur_cleunik==0) {
  	vl_c_donnees+="vf_c_action=ajouter&";
  } else {
  	if (vv_quoi!="supprimer"){	
  		vl_c_donnees+="vf_c_action=modifier&";
  	} else {
  		if (!confirm("Confirmez-vous la suppression de cette référence ?")){return;}
  		vf_c_action="supprimer";
  		vl_c_donnees+="vf_c_action=supprimer&";
  	}
  } 
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
