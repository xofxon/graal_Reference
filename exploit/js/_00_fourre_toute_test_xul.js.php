<?php
$vl_tb_droits_trait_00302=_graal_requete_droits_fenetre("Trait_00302",$vl_e_uti_cleunik);
if ($vl_tb_droits_trait_00302[0]==true) {$js_type_cli="cli";} else {$js_type_cli="???";}
$vl_tb_droits_trait_00303=_graal_requete_droits_fenetre("Trait_00303",$vl_e_uti_cleunik);
if ($vl_tb_droits_trait_00303[0]==true) {$js_type_fou="fou";} else {$js_type_fou="???";}
switch ($vl_c_type){
	case '1':	//Echéancier factures
	case '2':	//Echéancier commandes
	case '3':	//Echéancier général
		$js_01=<<<EOT
		fa05_sel_date('14','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_14");
EOT;
		break;
	case '5': //Réglements clients : 1 chèque -> une facture
		$js_01=<<<EOT
		fa05_sel_date('21','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_21");
		fa_att_set("arbre_echeancier","onselect","pf_sel_ligne();");
		fa_att_set("arbre_echeancier","onclick","pf_sel_ligne();");
EOT;
		$js_06=<<<EOT
		function pf_sel_ligne(vv_qui){
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (prop_doc=='ai14'){
				var vl_c_type="$js_type_cli";
			} else {
				var vl_c_type="$js_type_fou";
			}
			var param='_graal_fen_reglement_01.php?echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&type='+vl_c_type+"&genre=$vl_c_type";
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
EOT;
		break;
	case '8': //Réglements clients : 1 chèque -> une facture
		$js_01=<<<EOT
		fa05_sel_date('21','brb_tb_deb','brb_tb_fin');fa_check("-me_tb_deb_21");
		fa_att_set("arbre_echeancier","onselect","pf_sel_ligne();");
		fa_att_set("arbre_echeancier","onclick","pf_sel_ligne();");
EOT;
		$js_06=<<<EOT
		function pf_sel_ligne(vv_qui){
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (prop_doc=='ai14'){
				var vl_c_type="$js_type_cli";
			} else {
				var vl_c_type="$js_type_fou";
			}
			var param='_graal_fen_reglement_01.php?echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&type='+vl_c_type+"&genre=$vl_c_type&";
			param+='journal_cleunik='+fa_mlget("ml_journal")+"&";
			fa_att_set("graal_iframe_visu_reglement","src",param);
		}
EOT;
		break;
}
switch ($vl_c_id_fenetre) {
	case "Fen_00960":$js_type=$js_type_cli;break;	//	Traitements de masse échéancier factures clients
	case "Fen_00961":$js_type=$js_type_fou;break;	//	Traitements de masse échéancier factures fournisseurs
}
switch ($vl_c_id_fenetre) {
	case "Fen_00960":	//	Traitements de masse échéancier factures clients
	case "Fen_00961":	//	Traitements de masse échéancier factures fournisseurs
		$js_02=<<<EOT
		fa_att_set("arbre_echeancier","seltype","multiple");
EOT;
		$js_03="";
	$js_04=<<<EOT
		case "echeance_solde":
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_echeance=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_echeancier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_echeance[i]=fa_cell_get("arbre_echeancier",vl_t_tableau[i],"tc_echeance_cleunik");
    }
  }
  vl_e_nb_sel=vl_t_echeance.length;
  if (vl_e_nb_sel!=0) {
    if (confirm("Confirmez-vous le solde des échéances ("+vl_e_nb_sel+") ?")!=true) {return};
		var vl_c_bloc_notes=prompt("Note pour solde échéance","Solde en masse des échéances.");
    var vl_c_donnees="vl_t_echeance="+fa_enc(fa_jsarray2php_00(vl_t_echeance))+"&";
		vl_c_donnees+="vl_blocnotebrut="+fa_enc(vl_c_bloc_notes)+"&";
		var vl_c_script_bdope_fen_echeances="_graal_bdope_echeance_01.php?&type=$js_type&vf_c_action=kilometres_solder&";
    fa_xmlhttprequest_txt(vl_c_script_bdope_fen_echeances,vl_c_donnees,pf_solde_kilometre_fin);
  } else {
  	alert("Vous n'avez pas sélectionné d'échéance !!");
  }
EOT;
$js_05=<<<EOT
function pf_solde_kilometre_fin(vv_stream){
	pf_approximatif();
}
EOT;
		break;
	default:
	$js_03=<<<EOT
	case "echeance_modif":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (prop_doc=='ai14'){
				var vl_c_type="$js_type_cli";
			} else {
				var vl_c_type="$js_type_fou";
			}
			var param='&echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&type='+vl_c_type+'&genre=modif';
  		fa_ouvre(vf_c_script_fen_echeance+param,600,600);
			break;
EOT;
	$js_04=<<<EOT
		case "echeance_solde":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var prop_doc=fa_cell_get("arbre_echeancier",rowIndex,"tc_properties_document");
			if (prop_doc=='ai14'){
				var vl_c_type="$js_type_cli";
			} else {
				var vl_c_type="$js_type_fou";
			}
			var param='&echeance_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_echeance_cleunik"))+'&type='+vl_c_type+'&genre=solde';
  		fa_ouvre(vf_c_script_fen_echeance+param,600,600);
			break;
EOT;
	$js_05="";
		break;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const _c_url_alimente_table_echeancier="_graal_das_echeancier_01.php?genreacteur=$vl_c_genreacteur&nature=$vl_c_type&";
const vf_c_script_fen_action='_graal_fen_actions_02.php?';
const vf_c_script_fen_acteur="_graal_fen_acteurs_01.php?";
const vf_c_script_fen_echeance="_graal_fen_echeance_01.php?";
var vf_c_url_alimente_table="";
const lstn_grise= { 
	willRebuild : function(event){},
	didRebuild  : function(event){pf_grise_fenetre_non();} 
};
function pf_aa_init(){
	//fa_badl("arbre_echeancier",lstn_grise);
	$js_01
	$js_02
  //pf_approximatif();
}
function pf_alimente_table(){
	fa_grise_fenetre("","oui");
  fa_ds("arbre_echeancier",vf_c_url_alimente_table);
}
function pf_approximatif(){
	if (fa05_verif_date("brb_tb_deb","brb_tb_fin")!=true) {return;}
  if ( fa_value_get("brb_tb_rechapproxima") == "" ) {return;}
  vf_c_url_alimente_table=_c_url_alimente_table_echeancier+'&raf_random='+Math.random();
  vf_c_url_alimente_table+='&vl_c_dateheuredebut='+fa_enc(fa_date_formate(fa_value_get("brb_tb_deb"),"AAAAMMJJ"));
	vf_c_url_alimente_table+='&vl_c_dateheurefin='+fa_enc(fa_date_formate(fa_value_get("brb_tb_fin"),"AAAAMMJJ"));
	vf_c_url_alimente_table+='&vl_c_recherche='+fa_enc(fa_value_get("brb_tb_rechapproxima"));
	vf_c_url_alimente_table+='&vl_e_typedate='+fa_mlget("brb_ml_typedate","value");
	vf_c_url_alimente_table+='&vl_e_type='+fa_mlget("brb_ml_type","value");
	vf_c_url_alimente_table+='&vl_e_etat='+fa_mlget("brb_ml_etat","value");
	pf_alimente_table();
}
function pf_grise_fenetre_non(){
	fa_grise_fenetre("","non");
}
$js_06
function pf_onunload(){
	fa_brl("arbre_echeancier",lstn_grise);
}
function pf_ouvre(vv_quoi){
	switch (vv_quoi){
		case "action":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var vl_c_donnees="vf_e_action_cleunik="+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_action_cleunik"))+"&vf_c_action=modifier&genreaction=jenesaispas&";
			fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
			break;
		case "acteur":
			var rowIndex = fa_cui("arbre_echeancier");if(rowIndex == -1){return;}
			var param='&act_cleunik='+fa_enc(fa_cell_get("arbre_echeancier",rowIndex,"tc_act_cleunik"))+'&';
  		fa_ouvre(vf_c_script_fen_acteur+param,1000,800);
			break;
		$js_04
		$js_03
	}
}
function pf_raz_frame(){
	alert("toto")
	//fa_att_set("graal_iframe_visu_reglement","src","");
}
$js_05
]]></script>
END;
?>