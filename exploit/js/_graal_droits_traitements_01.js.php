<?php
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
********************************************************************************************************************************
**********  Fenêtre de gestion des droits d'accès aux traitements                  (_graal_fen_droits_fenetres_01.php)                             ********
********************************************************************************************************************************
*/
var vf_o_tree_fen,vf_o_tree_acc;
var vf_e_sel_cleunik;
var vf_c_action;
var vf_c_url_alimente_table_fenet;
var vf_c_url_alimente_table_acces;
var vf_c_script_edite_info_fenetre;
var vf_c_script_edite;
var vf_button;
var vf_c_ValRetour;
//  Affectations
  vf_c_script_bdope_fen='_graal_bdope_droits_fenetres_01.php';
  vf_c_script_edite_info_fenetre='_graal_xml_objets_traitements_01.php?';
function pf_affiche_datas_fenetre(stream){
  var vl_c_datas = stream;
  if (fa_xml_get(vl_c_datas,'acces')==1) {fa_check('ch_n01');fa_grise_non('ch_n01');} else {fa_uncheck('ch_n01');fa_grise_oui('ch_n01');} 
}
function pf_alimente_defaut(){
  fa_check('ch_n01');
}
function pf_alimente_table(){
  var raf_random=Math.random();
  fa_das("arbre_des_objets",vf_c_url_alimente_table_fenet+"?vl_e_type=2&raf="+raf_random+"&vl_e_uti_cleunik="+fa_mlget("ml_utilisateur"));
  fa_das("arbre_des_droits_fenetres",vf_c_url_alimente_table_acces+"?raf="+raf_random+"&vl_e_uti_cleunik="+fa_mlget("ml_utilisateur"));
}
function pf_duplique_tout(){
var vl_e_uti_cleunik=fa_mlget("ml_utilisateur");
fa_ouvre("_graal_fen_duplique_droits_objets_01.php?vl_e_type=2&vl_e_uti_origine="+fa_mlget("ml_utilisateur")+"&",400,150)
pf_alimente_table();
}

function pf_etat_fen(vv_quoi)
  {
   vf_c_action=vv_quoi;
   switch(vv_quoi) {
     case "ini":
       vf_c_url_alimente_table_fenet='_graal_das_fenetres_02.php';
       vf_c_url_alimente_table_acces='_graal_das_droits_traitements_01.php';
       vf_o_tree_fen = fa_gid("arbre_des_objets");
       vf_o_tree_acc=fa_gid("arbre_des_droits_fenetres");
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
       pf_raz_fiche();
       break;
     case "selectionner": 
      fa_grise_non("bt_supprimer");
      fa_grise_non("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      var vl_e_fen_cleunik=fa_gid("bt_enregistrer").getAttribute("_graal_fen_cleunik");
      var s ="fen_cleunik="+vl_e_fen_cleunik+"&";
      fa_xmlhttprequest_xml(vf_c_script_edite_info_fenetre,s,pf_affiche_datas_fenetre);
      pf_sel_ligne("arbre_des_droits_fenetres");
       break;
     case "selectionner_utilisateur":
        pf_alimente_table();
        break;
     case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_focusdonne('ch_n01');
      break;
     case "ajouter":
        {
        var vl_t_tableau=[];
        var vl_e_nb_sel;
        vl_t_tableau=fa_lignes_selectionnees("arbre_des_objets");
        vl_e_nb_sel=vl_t_tableau.length;
        if (vl_e_nb_sel >1) {
          var vl_t_fen_cleunik=[];
          for(i=0;i<vl_e_nb_sel;i++)
            {
              vl_t_fen_cleunik[i]=fa_cell_get("arbre_des_objets",vl_t_tableau[i],"fen_cleunik");
            }
          var vl_e_uti_cleunik=fa_mlget("ml_utilisateur");
          vl_c_donnees="vf_c_action=ajouter_kilometre&";
          vl_c_donnees+="vl_e_uti_cleunik="+vl_e_uti_cleunik+"&";
          vl_c_donnees+="vl_t_fen_cleunik="+fa_enc(fa_jsarray2php_00(vl_t_fen_cleunik))+"&";
          fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
        }
        else
        {    
          fa_grise_oui("bt_supprimer");
          fa_grise_oui("bt_modifier");
          fa_grise_oui("bt_ajouter");
          fa_grise_oui("bt_detailler");
          fa_grise_oui("bt_sortir");
          fa_grise_non("bt_annuler");
          fa_grise_non("bt_enregistrer");
          pf_alimente_defaut();
          var vl_e_fen_cleunik=fa_gid("bt_enregistrer").getAttribute("_graal_fen_cleunik");
          var s ="fen_cleunik="+vl_e_fen_cleunik+"&";
          fa_xmlhttprequest_xml(vf_c_script_edite_info_fenetre,s,pf_affiche_datas_fenetre);
          fa_focusdonne('ch_n01');
        }
      }
       break;
     case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_detailler");
      pf_raz_fiche();
      break;
     case "sortir":
     window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
     //window.history.back(); //  Ne fonctionne que si cette fenetre est une fenetre appellée dans la même fenêtre

     break;   
 default:
 break;
}
  }
function pf_fin_requete(stream)
{
var vl_datas = stream;
if (vl_datas=='ok') 
{pf_alimente_table();}
else
{fa_erreur(vl_datas)}
pf_etat_fen('annuler');


}
function pf_raz_fiche(){
  fa_check('ch_n01');fa_grise_non('ch_n01');
  fa_att_set("bt_enregistrer","_graal_cleunik","-1");
  fa_att_set("bt_enregistrer","_graal_fen_cleunik","-1");
}
function pf_sel_ligne(vv_qui) 
 {
      var rowIndex;
      if(fa_est_grise("bt_detailler")==true){return};
      switch (vv_qui)
      {
        case "arbre_des_droits_fenetres":
          rowIndex = vf_o_tree_acc.currentIndex;
          if(rowIndex == -1){return;}
          fa_att_set("bt_enregistrer","_graal_cleunik",vf_o_tree_acc.view.getCellText( rowIndex ,vf_o_tree_acc.columns.getNamedColumn("duf_cleunik")));
          fa_att_set("bt_enregistrer","_graal_fen_cleunik",vf_o_tree_acc.view.getCellText( rowIndex ,vf_o_tree_acc.columns.getNamedColumn("fen_cleunik")));
          if (vf_o_tree_acc.view.getCellText( rowIndex ,vf_o_tree_acc.columns.getNamedColumn("acces")) !="")
            {fa_uncheck('ch_n01');}
          else
            {fa_check('ch_n01');}
          break;
        case "arbre_des_objets":
          rowIndex = vf_o_tree_fen.currentIndex;
          if(rowIndex == -1){return;}
          fa_att_set("bt_enregistrer","_graal_fen_cleunik",vf_o_tree_fen.view.getCellText( rowIndex ,vf_o_tree_fen.columns.getNamedColumn("fen_cleunik")));

          break;
      }
      
  }

function pf_supprime_tout()
{
var s;
Check = confirm("Confirmez-vous la suppression de tous les droits de cet utilisateur ?");
if(Check == false) return;
var vl_e_uti_cleunik=fa_mlget("ml_utilisateur");
s="vl_e_uti_cleunik="+vl_e_uti_cleunik+"&";
s+="vl_e_type=2&";
s+="vf_c_action=tout_supprimer&";
fa_xmlhttprequest_txt(vf_c_script_bdope_fen,s,pf_fin_requete);
}
function pf_validation(vv_quoi)
  {
  var s;
   var vl_e_fen_cleunik=fa_gid("bt_enregistrer").getAttribute("_graal_fen_cleunik");
   var vl_e_uti_cleunik=fa_mlget("ml_utilisateur");
   var vl_e_duf_cleunik=fa_gid("bt_enregistrer").getAttribute("_graal_cleunik");
   s ="vl_e_fen_cleunik="+vl_e_fen_cleunik+"&";
   s +="vl_e_uti_cleunik="+vl_e_uti_cleunik+"&";
   s +="vl_e_duf_cleunik="+vl_e_duf_cleunik+"&";
   if (fa_est_coche('ch_n01')==true) {s +="vl_e_acces=1&"} else {s +="vl_e_acces=0&"};
  switch(vv_quoi) {
     case "enregistrer":
        if (vl_e_duf_cleunik!=-1) {s +="vf_c_action=modifier&";}
        else
        {s +="vf_c_action=ajouter&";}
      break;
     case "supprimer":
       Check = confirm("Confirmez-vous la suppression de cet élément ?");
       if(Check == false) return;
       s +="vf_c_action=supprimer&";
      break;
 }     
       fa_xmlhttprequest_txt(vf_c_script_bdope_fen,s,pf_fin_requete);
}
]]></script>
END;
?>
