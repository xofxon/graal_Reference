<?php
if ($vl_e_uti_cleunik==1){
$js_requete_sql=<<<EOT
case "mysql":
		var vl_e_acces,vl_e_aajout,vl_e_modif,vl_e_suppr;
		var vl_e_fen_cleunik=fa_att_get("tb_titre","_graal_cleunik");
	  if (fa_est_coche('ch_n01')==true) {vl_e_acces=1} else {vl_e_acces=0};
	  if (fa_est_coche('ch_n02')==true) {vl_e_ajout=1} else {vl_e_ajout=0};
	  if (fa_est_coche('ch_n03')==true) {vl_e_modif=1} else {vl_e_modif=0};
	  if (fa_est_coche('ch_n04')==true) {vl_e_suppr=1} else {vl_e_suppr=0};
		var toto="";
		var chaine="";
		chaine=fa_value_get("tb_descriptif_sommaire");
		var chaine_descriptif= chaine.replace(/'/g, "\\\'");
		chaine=fa_value_get("tb_titre");
		var chaine_titre= chaine.replace(/'/g, "\\\'");
		toto+="replace into _objets_libelle set descriptif='"+chaine_descriptif+"'";
		toto+=",fen_cleunik="+vl_e_fen_cleunik;
		toto+=",langue=120131";
		toto+=",uti_cleunik=0;\\n";
		toto+="update _objets set titre='"+chaine_titre+"'";
		toto+=",source_principal='"+fa_value_get("tb_source")+"'";
		toto+=",fen_acces="+vl_e_acces;
		toto+=",fen_ajout="+vl_e_ajout;
		toto+=",fen_modif="+vl_e_modif;
		toto+=",fen_suppr="+vl_e_suppr;
		toto+=",prefixe='"+fa_value_get("tb_prefixe")+"'";
		toto+=" where fen_cleunik="+vl_e_fen_cleunik+";";
		alert(toto);
		break;
EOT;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
********************************************************************************************************************************
**********  Fenêtre de gestion des fenêtres                  (_graal_fen_objets_fenetres_01.php)                             ********
********************************************************************************************************************************
*/
var vf_c_action;
var vf_c_url_alimente_table;
var vf_c_script_bdope_fen='_graal_bdope_objets_01.php';
var vf_c_script_edite='_graal_xml_objets_fenetres_01.php';
function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  if (fa_xml_get(vl_c_datas,'acces')==1) {fa_check('ch_n01');} else {fa_uncheck('ch_n01');} 
  if (fa_xml_get(vl_c_datas,'ajout')==1) {fa_check('ch_n02');} else {fa_uncheck('ch_n02');}
  if (fa_xml_get(vl_c_datas,'modif')==1) {fa_check('ch_n03');} else {fa_uncheck('ch_n03');}
  if (fa_xml_get(vl_c_datas,'suppr')==1) {fa_check('ch_n04');} else {fa_uncheck('ch_n04');}
}
function pf_alimente_defaut(){
  fa_check('ch_n01');
  fa_check('ch_n02');
  fa_check('ch_n03');
  fa_check('ch_n04');
  fa_value_set("tb_titre","Fen_");
}
function pf_alimente_table(){
  fa_das("arbre_des_objets",vf_c_url_alimente_table+"raf="+Math.random());
}
function pf_etat_fen(vv_quoi){
   vf_c_action=vv_quoi;
   switch(vv_quoi) {
     case "ini":
       vf_c_url_alimente_table='_graal_das_objets_01.php?vl_e_type=1&';
       fa_grise_oui("bt_supprimer");
       fa_grise_oui("bt_modifier");
       fa_grise_oui("bt_enregistrer");
       fa_grise_oui("bt_annuler");
       pf_raz_fiche();
       pf_alimente_table();
       break;
     case "selectionner": 
      var rowIndex = fa_cui("arbre_des_objets");if(rowIndex == -1){return;}
      fa_att_set("tb_titre","_graal_cleunik",fa_cell_get("arbre_des_objets",rowIndex,"fen_cleunik"));
      fa_value_set("tb_titre",fa_cell_get("arbre_des_objets",rowIndex,"titre"));
      fa_value_set("tb_descriptif_sommaire",fa_cell_get("arbre_des_objets",rowIndex,"descriptif"));
      fa_value_set("tb_prefixe",fa_cell_get("arbre_des_objets",rowIndex,"prefixe"));
      fa_value_set("tb_source",fa_cell_get("arbre_des_objets",rowIndex,"source"));
      fa_grise_non("bt_supprimer");
      fa_grise_non("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
       break;
     case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_focusdonne('tb_titre');
      break;
     case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_focusdonne('tb_titre');
       break;
     case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_detailler");
      pf_raz_fiche();
//      fa_focusdonne("arbre_des_objets");
			fa_focusdonne('tb_titre');
      break;
     case "sortir":
     window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
     //window.history.back(); //  Ne fonctionne que si cette fenetre est une fenetre appellée dans la même fenêtre
     break; 
     $js_requete_sql
}
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=='ok') {pf_alimente_table();} else {fa_erreur(vl_datas)} 
  pf_etat_fen('annuler');
}
function pf_ouvre_info_prefixes(){
  fa_ouvre("_graal_fen_infos_prefixes_objets_01.php",400,450)
}
function pf_raz_fiche(){
  fa_value_set("tb_titre","");
  fa_value_set("tb_descriptif_sommaire","");
  fa_att_set("tb_titre","_graal_cleunik","-1");
}
function pf_sel_ligne(vv_qui){
  if(fa_est_grise("bt_detailler")==true){return};
  var rowIndex = fa_cui("arbre_des_objets");if(rowIndex == -1){return;}
  var vl_e_fen_cleunik=fa_cell_get("arbre_des_objets",rowIndex,"fen_cleunik");
  fa_att_set("tb_titre","_graal_cleunik",vl_e_fen_cleunik);
  fa_value_set("tb_titre",fa_cell_get("arbre_des_objets",rowIndex,"titre"));
  fa_value_set("tb_descriptif_sommaire",fa_cell_get("arbre_des_objets",rowIndex,"descriptif"));
  fa_value_set("tb_prefixe",fa_cell_get("arbre_des_objets",rowIndex,"prefixe"));
  fa_value_set("tb_source",fa_cell_get("arbre_des_objets",rowIndex,"source"));
  s ="fen_cleunik="+vl_e_fen_cleunik+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var s;
  var vl_e_fen_cleunik=fa_att_get("tb_titre","_graal_cleunik");
  s ="vl_e_fen_cleunik="+vl_e_fen_cleunik+"&";
  s +="vl_c_prefixe="+fa_enc(fa_gid("tb_prefixe").value)+"&";
  s +="vl_e_type=1&";  //  Objet fenêtre
  s +="vl_c_titre="+fa_enc(fa_gid("tb_titre").value)+"&";
  s +="vl_c_descriptif="+fa_enc(fa_gid("tb_descriptif_sommaire").value)+"&";
  s +="vl_c_source="+fa_enc(fa_gid("tb_source").value)+"&";
  if (fa_est_coche('ch_n01')==true) {s +="vl_e_acces=1&"} else {s +="vl_e_acces=0&"};
  if (fa_est_coche('ch_n02')==true) {s +="vl_e_ajout=1&"} else {s +="vl_e_ajout=0&"};
  if (fa_est_coche('ch_n03')==true) {s +="vl_e_modif=1&"} else {s +="vl_e_modif=0&"};
  if (fa_est_coche('ch_n04')==true) {s +="vl_e_suppr=1&"} else {s +="vl_e_suppr=0&"};
  switch(vv_quoi) {
     case "enregistrer":
        if (vl_e_fen_cleunik!=-1) {s +="vf_c_action=modifier&";}
        else
        {s +="vf_c_action=ajouter&";}
      break;
     case "supprimer":
       Check = confirm("Confirmez-vous la suppression de cet élément ?");
       if(Check == false) return;
       s +="vf_c_action=supprimer&";
      break;
  }     
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,s,pf_fin_requete);
}
]]></script>
END;
?>
