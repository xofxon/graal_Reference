<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_type=fa_recup_param("type","ventes");
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_type_dates=intval(fa_recup_param("selection_date","0"));
$journal_cleunik=intval(fa_recup_param("vl_journal_cleunik","0"));
$vl_c_format_date=fa_recup_param("vl_c_format_date","1");
$vl_c_sortie=fa_recup_param("sortie","das");
switch ($vl_c_type_dates){
	case 0:
		$quelle_date="f1.dateheurereglemen";
	break;
}
switch ($vl_c_type){
	case "old_ventes":
		$fichier_01="_treso_reglement_cli";$fichier_02="_treso_reglement_cli_detail";$fichier_04="_faccli_entetes";
		$sql_req = "SELECT f1.reglement_cleunik,f4.sujet as no_piece,f5.code as compte_acteur,date(f1.dateheurereglemen) as date_reglement,"._graalsql_date("dateheurereglemen")." as `date_reglement_jj`,";
		$sql_req.= " f1.ref_piece as libelle,0 as debit_acteur,sum(f2.montant_paye) as credit_acteur,f7.code as compte_banque,sum(f2.montant_paye) as debit_banque,0 as credit_banque,";
		$sql_req.= " f5.intitule as intitule_compte_acteur";
		$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 on f1.reglement_cleunik=f2.reglement_cleunik ";
		$sql_req.= " left join _echeancier f3 on f2.echeance_cleunik=f3.echeance_cleunik ";
		$sql_req.= " left join _actions f4 on f4.action_cleunik=f3.action_cleunik ";
		$sql_req.= " left join _param_pc f5 on f1.pc_cleunik=f5.pc_cleunik ";
		$sql_req.= " left join _treso_journal f6 on f1.journal_cleunik=f6.journal_cleunik ";
		$sql_req.= " left join _param_pc f7 on f7.pc_cleunik=f6.compte_comptable ";
		$sql_req.= " where $quelle_date between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin' and f1.journal_cleunik=$journal_cleunik ";
		/*
		 * gros spécif baronnat pour mars 2010 le temps de découvrir, pourquoi, comment on se retrouve avec ces tonnes d'écritures !!!
		 * merdra encore en avril -> à résoudre très très rapidement !!!
		 */
		/*
		 * gros spécif baronnat pour mars 2010 le temps de découvrir, pourquoi, comment on se retrouve avec ces tonnes d'écritures !!!
		 * merdra encore en mai -> à résoudre très très rapidement !!!
		 */
		//$sql_req.= " and f2.reglement_cleunik not in(20000374,20000375,20000380,20000379,20000371,20000388)";
		$sql_req.= " group by f2.reglement_cleunik order by $quelle_date;";

	case "ventes":
		$fichier_01="_treso_reglement_cli";$fichier_02="_treso_reglement_cli_detail";$fichier_04="_faccli_entetes";
		$sql_req = "SELECT f1.reglement_cleunik,f4.sujet as no_piece,f5.code as compte_acteur,date(f1.dateheurereglemen) as date_reglement,"._graalsql_date("dateheurereglemen")." as `date_reglement_jj`,";
		$sql_req.= " f1.ref_piece as libelle,0 as debit_acteur,f2.montant_paye as credit_acteur,f7.code as compte_banque,f2.montant_paye as debit_banque,0 as credit_banque,";
		$sql_req.= " f5.intitule as intitule_compte_acteur";
		$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 on f1.reglement_cleunik=f2.reglement_cleunik ";
		$sql_req.= " left join _echeancier f3 on f2.echeance_cleunik=f3.echeance_cleunik ";
		$sql_req.= " left join _actions f4 on f4.action_cleunik=f3.action_cleunik ";
		$sql_req.= " left join _param_pc f5 on f1.pc_cleunik=f5.pc_cleunik ";
		$sql_req.= " left join _treso_journal f6 on f1.journal_cleunik=f6.journal_cleunik ";
		$sql_req.= " left join _param_pc f7 on f7.pc_cleunik=f6.compte_comptable ";
		$sql_req.= " where $quelle_date between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin' and f1.journal_cleunik=$journal_cleunik ";
		/*
		 * gros spécif baronnat pour mars 2010 le temps de découvrir, pourquoi, comment on se retrouve avec ces tonnes d'écritures !!!
		 * merdra encore en avril -> à résoudre très très rapidement !!!
		 */
		/*
		 * gros spécif baronnat pour mars 2010 le temps de découvrir, pourquoi, comment on se retrouve avec ces tonnes d'écritures !!!
		 * merdra encore en mai -> à résoudre très très rapidement !!!
		 */
		//$sql_req.= " and f2.reglement_cleunik not in(20000374,20000375,20000380,20000379,20000371,20000388)";
		$sql_req.= " order by $quelle_date;";



		break;
	case "old_achats":
		$fichier_01="_treso_reglement_fou";$fichier_02="_treso_reglement_fou_detail";$fichier_04="_facfou_entetes";
		$sql_req = "SELECT f1.reglement_cleunik,f4.sujet as no_piece,f5.code as compte_acteur,date(f1.dateheurereglemen) as date_reglement,"._graalsql_date("dateheurereglemen")." as `date_reglement_jj`,";
		$sql_req.= " f1.ref_piece as libelle,sum(f2.montant_paye) as debit_acteur,0 as credit_acteur,f7.code as compte_banque,0 as debit_banque,sum(f2.montant_paye) as credit_banque,";
		$sql_req.= " f5.intitule as intitule_compte_acteur";
		$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 on f1.reglement_cleunik=f2.reglement_cleunik ";
		$sql_req.= " left join _echeancier f3 on f2.echeance_cleunik=f3.echeance_cleunik ";
		$sql_req.= " left join _actions f4 on f4.action_cleunik=f3.action_cleunik ";
		$sql_req.= " left join _param_pc f5 on f1.pc_cleunik=f5.pc_cleunik ";
		$sql_req.= " left join _treso_journal f6 on f1.journal_cleunik=f6.journal_cleunik ";
		$sql_req.= " left join _param_pc f7 on f7.pc_cleunik=f6.compte_comptable ";
		$sql_req.= " where $quelle_date between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin' and f1.journal_cleunik=$journal_cleunik ";
		$sql_req.= " group by f2.reglement_cleunik order by $quelle_date;";
		break;

	case "achats":
		$fichier_01="_treso_reglement_fou";$fichier_02="_treso_reglement_fou_detail";$fichier_04="_facfou_entetes";
		$sql_req = "SELECT f1.reglement_cleunik,f4.sujet as no_piece,f5.code as compte_acteur,date(f1.dateheurereglemen) as date_reglement,"._graalsql_date("dateheurereglemen")." as `date_reglement_jj`,";
		$sql_req.= " f1.ref_piece as libelle,f2.montant_paye as debit_acteur,0 as credit_acteur,f7.code as compte_banque,0 as debit_banque,f2.montant_paye as credit_banque,";
		$sql_req.= " f5.intitule as intitule_compte_acteur";
		$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 on f1.reglement_cleunik=f2.reglement_cleunik ";
		$sql_req.= " left join _echeancier f3 on f2.echeance_cleunik=f3.echeance_cleunik ";
		$sql_req.= " left join _actions f4 on f4.action_cleunik=f3.action_cleunik ";
		$sql_req.= " left join _param_pc f5 on f1.pc_cleunik=f5.pc_cleunik ";
		$sql_req.= " left join _treso_journal f6 on f1.journal_cleunik=f6.journal_cleunik ";
		$sql_req.= " left join _param_pc f7 on f7.pc_cleunik=f6.compte_comptable ";
		$sql_req.= " where $quelle_date between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin' and f1.journal_cleunik=$journal_cleunik ";
		$sql_req.= " order by $quelle_date;";
		break;

}
/*
$sql_req = "SELECT f4.code as no_piece,f5.code as compte_acteur,date(f1.dateheurereglemen) as date_reglement,"._graalsql_date("dateheurereglemen")." as `date_reglement_jj`,";
$sql_req.= " f1.ref_piece as libelle,0 as debit_acteur,f2.montant_paye as credit_acteur,f7.code as compte_banque,f2.montant_paye as debit_banque,0 as credit_banque,";
$sql_req.= " f5.intitule as intitule_compte_acteur";
$sql_req.= " FROM $fichier_01 f1 left join $fichier_02 f2 on f1.reglement_cleunik=f2.reglement_cleunik ";
$sql_req.= " left join _echeancier f3 on f2.echeance_cleunik=f3.echeance_cleunik ";
$sql_req.= " left join $fichier_04 f4 on f4.action_cleunik=f3.action_cleunik ";
$sql_req.= " left join _param_pc f5 on f1.pc_cleunik=f5.pc_cleunik ";
$sql_req.= " left join _treso_journal f6 on f1.journal_cleunik=f6.journal_cleunik ";
$sql_req.= " left join _param_pc f7 on f7.pc_cleunik=f6.compte_comptable ";
$sql_req.= " where $quelle_date between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin' and f1.journal_cleunik=$journal_cleunik order by $quelle_date;";
*/




switch ($vl_c_sortie) {
 	case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
		exit();
		break;
	case "das":
    	$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		    echo(' no_piece="'.fa_ent_xml($row['no_piece']).'"');
			switch ($vl_c_format_date){
				case "2":
					echo(' date_reglement="'.fa_ent_xml($row['date_reglement']).'"');
					break;
				case "1":
					$jj=substr($row['date_reglement_jj'],0,2);
					$mm=substr($row['date_reglement_jj'],3,2);
					$aa=substr($row['date_reglement_jj'],6,4);
					$date=$jj."/".$mm."/".$aa;
					//echo(' date_de_facture="'.fa_ent_xml($row['date_de_facture_jj']).'"');
					echo(' date_reglement="'.$date.'"');
					break;
			}
		  	echo(' libelle="'.fa_ent_xml($row['libelle']).'"');
		  	echo(' intitule_compte_acteur="'.fa_ent_xml($row['intitule_compte_acteur']).'"');
		 	$debit=fa_reel(fa_ent_xml($row['debit_acteur']),2);
		 	$val_debit=fa_ent_xml($row['debit_acteur'])*1000;
		 	if ($debit==0){$debit="";}
		  	echo(' debit="'.$debit.'"');
		  	printf(' val_debit="%011u"',$val_debit);
		  	$credit=fa_reel(fa_ent_xml($row['credit_acteur']),2);
		 	$val_credit=fa_ent_xml($row['credit_acteur'])*1000;
			if ($credit==0){$credit="";}
		  	echo(' credit="'.$credit.'"');
		  	printf(' val_credit="%011u"',$val_credit);
		  	echo(' compte_acteur="'.fa_ent_xml($row['compte_acteur']).'"');
		  	echo(' compte_banque=""');
		  	echo(' reglement_cleunik="'.fa_ent_xml($row['reglement_cleunik']).'"');
		   echo('/>');
		   echo('<quoi ');
		    echo(' no_piece=""');
		    echo(' date_reglement=""');
		  	echo(' libelle=""');
		  	echo(' intitule_compte_acteur=""');
		 	$debit=fa_reel(fa_ent_xml($row['debit_banque']),2);
		 	$val_debit=fa_ent_xml($row['debit_banque'])*1000;
		 	if ($debit==0){$debit="";}
		  	echo(' debit="'.$debit.'"');
		  	printf(' val_debit="%011u"',$val_debit);
		  	$credit=fa_reel(fa_ent_xml($row['credit_banque']),2);
		 	$val_credit=fa_ent_xml($row['credit_banque'])*1000;
			if ($credit==0){$credit="";}
		  	echo(' credit="'.$credit.'"');
		  	printf(' val_credit="%011u"',$val_credit);
		  	echo(' compte_acteur=""');
		  	echo(' compte_banque="'.fa_ent_xml($row['compte_banque']).'"');
		  	echo(' reglement_cleunik="'.fa_ent_xml($row['reglement_cleunik']).'"');
		   echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
		break;
	case "excel_01":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		switch ($vl_c_type) {
			case "ventes":$vl_c_id_fenetre="Fen_01096";break;
			case "achats":$vl_c_id_fenetre="Fen_01097";break;
		}
		_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
		$vl_c_bsq_101=fa_recup_dico("bsq_101");
		$vl_c_bsq_102=fa_recup_dico("bsq_102");
		$vl_c_bsq_103=fa_recup_dico("bsq_103");
		$vl_c_bsq_104=fa_recup_dico("bsq_104");
		$vl_c_bsq_105=fa_recup_dico("bsq_105");
		$vl_c_bsq_106=fa_recup_dico("bsq_106");
		$vl_c_bsq_107=fa_recup_dico("bsq_107");
		$vl_c_bsq_108=fa_recup_dico("bsq_108");$vl_c_bsq_108="Intitulé acteur";


		$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook =new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("$vl_c_bsq_107"));
		$result = _graal_requete_bd($sql_req);
		//echo $sql_req.EOL;
		$worksheet->write(0, 0, utf8_decode("$vl_c_bsq_101"));
		$worksheet->write(0, 1, utf8_decode("$vl_c_bsq_102"));
		$worksheet->write(0, 2, utf8_decode("$vl_c_bsq_103"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bsq_104"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bsq_108"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_bsq_105"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_bsq_106"));
		$vl_e_noligne=1;
		while ($row = mysql_fetch_assoc($result)) {
			switch ($vl_c_format_date){
			case "2":
				$date=($row['date_reglement']);
				break;
			case "1":
				$jj=substr($row['date_reglement_jj'],0,2);
				$mm=substr($row['date_reglement_jj'],3,2);
				$aa=substr($row['date_reglement_jj'],6,4);
				$date=$jj."/".$mm."/".$aa;
				break;
			}
			$j=0;
			//echo($row['no_piece'].EOL);
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['no_piece']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['compte_acteur']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($date));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['libelle']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['intitule_compte_acteur']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['debit_acteur']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['credit_acteur']));$j++;

		    $vl_e_noligne++;
		    $j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['no_piece']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['compte_banque']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($date));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['libelle']));$j++;
		    $worksheet->write($vl_e_noligne, $j, "");$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['debit_banque']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['credit_banque']));$j++;

		    $vl_e_noligne++;
		}
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    break;
}
?>
