<?php
$vl_c_bsf_106_js=fa_recup_dico_js("bsf_106");

if ("$vl_c_visu"=="oui") {
$pf_sel_ligne_visu=<<<EOT
		switch (vf_e_choix_cleunik) {
        case "-110114" : vl_c_genre="offcli";break;
        case "-110115" : vl_c_genre="demfou";break;
        case "-110108" : vl_c_genre="cdecli";break;
        case "-110109" : vl_c_genre="cdefou";break;
        case "-110110" : vl_c_genre="livcli";break;
        case "-110111" : vl_c_genre="recfou";break;
        case "-110112" : vl_c_genre="faccli";break;
        case "-110113" : vl_c_genre="facfou";break;
        case "-110116" : vl_c_genre="avocli";break;
        case "-110117" : vl_c_genre="avofin";break;
        case "-110118" : vl_c_genre="chat";break;
		case "-110119" : vl_c_genre="fabrica";break;
        case "-110103" : vl_c_genre="emimail";break;
        case "-110121" : vl_c_genre="emimail_ar";break;
        case "-110122" : vl_c_genre="emailing";break;
        case "-110102" : vl_c_genre="recmail";break;
        case "-110120" : vl_c_genre="recmail_lecture";break;
        case "-110104" : vl_c_genre="recmail_erreur";break;
        case "-110123" : vl_c_genre="formul";break;
		case "-110124" : vl_c_genre="desins_mail";break;
		case "-110125" : vl_c_genre="recvoc";break;
		case "-110126" : vl_c_genre="recfax";break;
		case "-110127" : vl_c_genre="remban";break;
		case "-110128" : vl_c_genre="emifax";break;
		case "-110129" : vl_c_genre="emisms";break;
		case "-110130" : vl_c_genre="post_it";break;
		case "-110131" : vl_c_genre="bordex";break;
        default : vl_c_genre="$vl_c_genreaction";break;
      }
      vl_c_donnees="vf_e_action_cleunik="+fa_enc(vf_e_action_cleunik)+"&vf_c_action=modifier&genreaction="+fa_enc(vl_c_genre)+"&";
      fa_att_set("graal_iframe_visu_action","src",vf_c_script_fen_action+vl_c_donnees);
EOT;
} else {
	$pf_sel_ligne_visu="";
}		
echo <<<END
<script type="application/x-javascript"><![CDATA[


const vf_c_script_var='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_action';
const vf_c_script_das_action='_graal_das_actions_01.php?vl_c_type_affichage=$vl_c_quelarbre_actions&';
const c_script_prepa_creation_cial="_graal_bdope_doc_bordereau_expedition_01.php?vf_c_action=ajouter&";
var vf_t_panier=[];
const vf_c_script_fen_action='_graal_fen_actions_02.php?';
const vf_c_script_bdope_action='_graal_bdope_actions_01.php?';
var vf_e_action_cleunik=-1,vf_e_choix_cleunik;
const lstn_grise = { 
	willRebuild : function(event){},
	didRebuild  : function(event){pf_grise_fenetre_non();} 
};
function pf_aa_init_bem(vv_choix_date){
  fa05_sel_date(vv_choix_date,'bem_tb_deb','bem_tb_fin');
  fa_att_set("ml_genre_action_rech","oncommand","pf_approximatif_bem()");
  fa_att_set("arbre_actions_01","context","pop_selections");
  fa_att_set("arbre_des_actions_panier",'context',"pop_panier");
  fa_check("me_tb_deb_21");
	fa_badl("arbre_actions_01",lstn_grise);
	fa_badl("arbre_des_actions_panier",lstn_grise);
	fa_ael("bem_tb_limit","input",pf_approximatif_bem);
      fa_grise_oui('ml_genre_action_rech');
      pf_approximatif_bem();
}
function pf_action_ouvre(vv_qui){
  var rowIndex = fa_cui(vv_qui);if(rowIndex == -1){return;}
  var vl_e_action_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_action_cleunik");
  var vl_e_choix_cleunik=fa_cell_get(vv_qui,rowIndex,"tc_choix_cleunik");
  vl_c_genre="livcli";
  vl_c_donnees="vf_e_action_cleunik="+fa_enc(vl_e_action_cleunik)+"&vf_c_action=modifier&genreaction="+fa_enc(vl_c_genre)+"&";
  fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
}

function pf_ajoute_fin_bem(stream) {
}
function pf_ajoute_fin_bem_cial(stream,vv_qui) {
  switch (stream) {
    case "0":alert("Impossible de créer ce document.");break
    case "":
    case "-1":
    case "-2":
    case "-3":
    case "-4":
    case "-5":
    case "-6":
    case "-7":
    case "-8":
    case "-9":
    case "-13":
      alert("Erreur de creation ("+stream+").");
      break;
    case "-10":
      alert("Informations comptables non renseignées. Création impossible");
      break;
    case "-11":
      alert("Catégorie fiscale non renseignée. Création impossible");
      break;
    case "-12":
      alert("Compte imputation comptable non renseigné. Création impossible");
      break;
    case "-13":
      alert("Eléments de gestion non renseignés (remise etc). Création impossible");
      break;
    default:
			if (vv_qui=="profor"){vv_qui="faccli";}
      var vl_c_donnees="vf_e_action_cleunik="+fa_enc(stream)+"&vf_c_action=ajoutermodifier&genreaction="+vv_qui+"&";
      fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
      break;
  }
}
function pf_approximatif_bem() {
	if ("$vl_c_genreaction"=="post_it"){pf_approximatif_post_it();return;}
	var vl_c_statuts=fa_mlget_check("ml_statut_action_rech");
	var vl_c_priorit=fa_mlget_check("ml_priori_action_rech");
	var vl_c_genress=fa_mlget_check("ml_genre_action_rech");
	var vl_c_concerne_qui="&vl_c_concerne_qui="+fa_mlget("bem_ml_concerne_qui","value")+'&';
	var vl_c_spec="";
	switch (fa_value_get("ml_action_spec")){
		case "-1":
			vl_c_spec="&spec=-1&spec_quoi="+fa_mlget("ml_action_spec","_graal_cleunik")
			break;
		case "-2":
			vl_c_spec="&spec=-2&spec_quoi="+fa_mlget("ml_action_spec","_graal_cleunik")
			break;
		default:
			break;
	}
	var vl_c_datedeb=fa_value_get("bem_tb_deb");
	var vl_c_datefin=fa_value_get("bem_tb_fin");
	vl_c_datedeb=vl_c_datedeb.replace("-", "", "gi");
	vl_c_datefin=vl_c_datefin.replace("-", "", "gi");
      var vl_c_script="",vl_c_date="",vl_c_url_alimente_table="";
      if ( fa_value_get("bem_tb_rechapproxima") == "" ) {return;}
      vl_c_url_alimente_table=vf_c_script_das_action+vl_c_concerne_qui+'&vl_c_particularisme=1&vl_c_lesquelles=toutes_principales&';
      vl_c_url_alimente_table+='raf_random='+Math.random()+'&vl_c_quelleplage=debut&vl_c_dateheuredebut='+fa_enc(vl_c_datedeb)+'&vl_c_dateheurefin='+fa_enc(vl_c_datefin);
      vl_c_url_alimente_table+="&vl_e_limit="+fa_value_get("bem_tb_limit")+'&vl_c_recherche='+fa_enc(fa_value_get("bem_tb_rechapproxima"))+'&vl_e_genre='+vl_c_genress;
      vl_c_url_alimente_table+='&vl_e_statut='+vl_c_statuts+'&vl_operat='+fa_mlget("bem_ml_operat","value")+'&vl_operat_genre='+fa_mlget("bem_ml_operat_genre","value");
      vl_c_url_alimente_table+="&vl_zone="+fa_mlget("bem_ml_zone","value")+"&vl_type_recherche="+fa_mlget("bem_ml_type_recherche","value")+"&vl_e_priorite="+vl_c_priorit;
      vl_c_url_alimente_table+="&vl_operat_priorite="+fa_mlget("bem_ml_operat_priori","value")+'&';
      vl_c_url_alimente_table+="&vl_operat_confiden="+fa_mlget("bem_ml_operat_confid","value")+'&vl_e_confiden='+fa_mlget_check("ml_confid_action_rech");
      
	vl_c_url_alimente_table+=vl_c_spec;
	pf_grise_fenetre_oui();
  fa_das("arbre_actions_01",vl_c_url_alimente_table);
}
function pf_dblclick_arbre_actions_bem(){
  if($vl_b_modif==false) {return};
  var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
  vf_e_action_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik");
  vf_e_choix_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_choix_cleunik");
  pf_etat_fen_bem("modifier");
}
function pf_etat_fen_bem(vv_quoi){
  var vl_c_donnees="";
  switch(vv_quoi) {
    case "modifier":
      switch (vf_e_choix_cleunik) {
        case "-110114" : vl_c_genre="offcli";break;
        case "-110115" : vl_c_genre="demfou";break;
        case "-110108" : vl_c_genre="cdecli";break;
        case "-110109" : vl_c_genre="cdefou";break;
        case "-110110" : vl_c_genre="livcli";break;
        case "-110111" : vl_c_genre="recfou";break;
        case "-110112" : vl_c_genre="faccli";break;
        case "-110113" : vl_c_genre="facfou";break;
        case "-110116" : vl_c_genre="avocli";break;
        case "-110117" : vl_c_genre="avofin";break;
        case "-110118" : vl_c_genre="chat";break;
		case "-110119" : vl_c_genre="fabrica";break;
        case "-110103" : vl_c_genre="emimail";break;
        case "-110121" : vl_c_genre="emimail_ar";break;
        case "-110122" : vl_c_genre="emailing";break;
        case "-110102" : vl_c_genre="recmail";break;
        case "-110120" : vl_c_genre="recmail_lecture";break;
        case "-110104" : vl_c_genre="recmail_erreur";break;
        case "-110123" : vl_c_genre="formul";break;
		case "-110124" : vl_c_genre="desins_mail";break;
		case "-110125" : vl_c_genre="recvoc";break;
		case "-110126" : vl_c_genre="recfax";break;
		case "-110127" : vl_c_genre="remban";break;
		case "-110128" : vl_c_genre="emifax";break;
		case "-110129" : vl_c_genre="emisms";break;
		case "-110130" : vl_c_genre="post_it";break;
		case "-110131" : vl_c_genre="bordex";break;
        default : vl_c_genre="$vl_c_genreaction";break;
      }
      vl_c_donnees="vf_e_action_cleunik="+fa_enc(vf_e_action_cleunik)+"&vf_c_action=modifier&genreaction="+fa_enc(vl_c_genre)+"&";
      fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
      break;
    case "ajouter":
      vl_c_donnees="vf_e_action_cleunik=-1&vf_c_action=ajouter&";
      fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
      break;
	case 'renvoyer' :
      var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
  	vf_e_action_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik");
      window.opener.pf_ouvre_action_recup(vf_e_action_cleunik);
      pf_etat_fen_bem('sortir');
      break;	  
    case "sortir":
      window.close();
      break;   
  }
}

function pf_grise_fenetre_non(){
	fa_grise_non("bem_tb_limit");
	fa_grise_non("bem_ml_operat_genre");
	fa_grise_non("ml_genre_action_rech");
	fa_grise_non("ml_statut_action_rech");
	fa_grise_non("bem_ml_operat");
	fa_grise_non("bem_ml_actif");
	fa_grise_non("bem_ml_zone");
	fa_grise_non("bem_tb_rechapproxima");fa_ro_non("bem_tb_rechapproxima");
	fa_grise_non("bem_ml_type_recherche");
	fa_grise_non("bem_tb_deb");
	fa_grise_non("bem_tb_fin");
	fa_grise_non("bem_tb_limit");
	fa_grise_non("bem_tb_rafraichir");
	fa_grise_fenetre("","non");
}
function pf_grise_fenetre_oui(){
	fa_grise_oui("bem_tb_limit");
	fa_grise_oui("bem_ml_operat_genre");
	fa_grise_oui("ml_genre_action_rech");
	fa_grise_oui("ml_statut_action_rech");
	fa_grise_oui("bem_ml_operat");
	fa_grise_oui("bem_ml_actif");
	fa_grise_oui("bem_ml_zone");
	fa_grise_oui("bem_tb_rechapproxima");fa_ro_oui("bem_tb_rechapproxima");
	fa_grise_oui("bem_ml_type_recherche");
	fa_grise_oui("bem_tb_deb");
	fa_grise_oui("bem_tb_fin");
	fa_grise_oui("bem_tb_limit");
	fa_grise_oui("bem_tb_rafraichir");
	fa_grise_fenetre("","oui");
}
function pf_onunload(){
	fa_brl("arbre_actions_01",lstn_grise);
	fa_gid("bem_tb_limit").removeEventListener("input",pf_approximatif_bem, false);
}
function pf_ouvre_acteur(vv_qui,vv_quoi) {
  vl_c_param="&vl_c_proc_retour=pf_ouvre_acteur_recup_livcli&";
  fa_ouvre(c_script_recherche_acteurs+vl_c_param+"vl_e_genreacteur="+vv_qui+"&",800,600);
}
function pf_panier_ajoute() {
  var vl_t_action=pf_tab_actions();
  if (vl_t_action.length==0) {return;}
  var vl_t_panier=[];
  vl_t_panier=vf_t_panier;
  vf_t_panier=vl_t_panier.concat(vl_t_action);
  fa_remove_attribute("bt_voir_panier","collapsed")
  fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
}
function pf_panier_enleve() {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_des_actions_panier");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_panier=[];
    var vl_t_action=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_action[i]=fa_cell_get("arbre_des_actions_panier",vl_t_tableau[i],"tc_action_cleunik");
    }
    var j=0;k=-1;
    for(i=0;i<vf_t_panier.length;i++) {
      if (vl_t_action.indexOf(vf_t_panier[i])==-1) { 
        k++;
        vl_t_panier[k]=vf_t_panier[i];
      }  
    }
    vf_t_panier=vl_t_panier
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_tableau_donnees_fin);
  }
}
function pf_tab_actions(){
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_action=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_actions_01");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_action[i]=fa_cell_get("arbre_actions_01",vl_t_tableau[i],"tc_action_cleunik");
    }
  }
  return vl_t_action;
} 
function pf_tableau_donnees_fin(stream) {
  fa_das("arbre_des_actions_panier",vf_c_script_das_action+'vl_c_lesquelles=selection&raf_random='+Math.random())
}
function pf_sel_ligne_bem()  {
  vf_e_action_cleunik=-1;
  var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
  vf_e_action_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik");
	vf_e_choix_cleunik=fa_cell_get("arbre_actions_01",rowIndex,"tc_choix_cleunik");
	$pf_sel_ligne_visu
}
function pf_validation(){
	if (vf_t_panier.length==0){alert("Aucune expédition n'est sélectionnée ...");return;}
	if (!confirm("$vl_c_bsf_106_js")){return;}
	var vl_c_donnees="";
	vl_c_donnees+="vl_e_transp_cleunik="+fa_value_get("ml_transporteurs")+"&";
  	vl_c_donnees+="vl_c_liste_cle="+fa_jsarray2php_00(vf_t_panier)+"&";
	fa_xmlhttprequest_txt(c_script_prepa_creation_cial,vl_c_donnees,pf_validation_fin);	
}
function pf_validation_fin(stream){
  var vl_c_datas=stream;
  if (vl_c_datas!=-1) {
    var vl_c_donnees="vf_e_action_cleunik="+fa_enc(vl_c_datas)+"&vf_c_action=ajoutermodifier&";
    fa_ouvre(vf_c_script_fen_action+vl_c_donnees,1000,600);
	window.location=document.location;
  }
}
function pf_voir_action(){
  var rowIndex = fa_cui("arbre_actions_01");if(rowIndex == -1){return;}
	var vl_c_donnees="vf_e_action_cleunik="+fa_enc(fa_cell_get("arbre_actions_01",rowIndex,"tc_action_cleunik"))+"&vf_c_action=modifier&genreaction=jenesaispas&";
	fa_att_set("graal_iframe_visu_action","src",vf_c_script_fen_action+vl_c_donnees);
}
]]></script>
END;
?>
