<?php
$vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));
if (isset($vl_c_xml->selection_interlocuteur)){$selection_interlocuteur=$vl_c_xml->selection_interlocuteur->attributes();}else{$selection_interlocuteur='1';}
if (isset($vl_c_xml->vl_selint_nbcaracrech)){$vl_selint_nbcaracrech=$vl_c_xml->vl_selint_nbcaracrech->attributes();}else{$vl_selint_nbcaracrech='3';}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_interlo_relations_01.php";
const vf_c_script_int="_graal_rech_interlo_01.php";
const vf_c_script_relations='_graal_das_interlos_relations_01.php?'
var vf_c_action,vf_c_url_alimente_table;
var vf_e_interlo_cleunik_droite,vf_e_interlo_cleunik_rela;
const lstn_grise = {
	willRebuild : function(event){}, 
	didRebuild  : function(event){fa_att_rem("bbj_tb_rechapproxima","disabled");fa_att_rem("_graal_fen_rech_courriel_01","cursor-wait");fa_grise_fenetre(event,"non");} 
}
function pf_aa_init() {
  fa_grise_oui("bt_supprimer");
  fa_grise_oui("bt_modifier");
  fa_grise_oui("bt_enregistrer");
  fa_grise_oui("bt_annuler");
  fa_focusdonne("bbj_tb_rechapproxima");
  pf_affiche_donnees_relations();
	fa_gid("arbre_interlo").builder.addListener(lstn_grise);
	var vl_c_recherche=fa_value_get("bbj_tb_rechapproxima");
	if ("$vl_selint_nbcaracrech"!='-1') {
		if (vl_c_recherche.length>=$vl_selint_nbcaracrech)
  	pf_approximatif();
	} else {
		pf_approximatif();
	}
}
function pf_affiche_donnees_relations(){
  var vl_c_param;
  var raf_random=Math.random();
  vl_c_param=vf_c_script_relations;
  vl_c_param+="vl_e_int_cleunik=$vl_e_int_cleunik_gauche&";
  vl_c_param+="raf_random="+raf_random+"&vf_c_genre=A&'";
  fa_das("arbre_relations",vl_c_param);
}
function pf_alimente_table(){
	fa_grise_fenetre("","oui");
	fa_att_set("_graal_fen_rech_courriel_01","cursor-wait");
	fa_att_set("bbj_tb_rechapproxima","disabled","true");
  fa_das("arbre_interlo",vf_c_url_alimente_table);
}
function pf_approximatif(){
  if ( fa_value_get("bbj_tb_rechapproxima") == "" ) {return;};
  item=fa_gid("bbj_ml_actif").selectedItem;
  vf_c_url_alimente_table=vf_c_script_int+'?sortie=das&listecles=&vl_c_recherche='+fa_enc(fa_value_get("bbj_tb_rechapproxima"))+'&vl_c_zone='+fa_value_get("bbj_ml_zone")+'&vl_c_type='+fa_value_get("bbj_ml_type")+'&vl_c_qui='+fa_value_get("bbj_ml_qui")+'&raf_random='+Math.random()+'&vl_c_actifs='+fa_value_get("bbj_ml_actif")+'&vl_e_panier='+item.getAttribute("_graal_cleunik")+"&";
  vf_c_url_alimente_table+='vl_e_limit='+fa_value_get("bbj_tb_limit")+"&";
	pf_alimente_table();
}
function pf_etat_fen(vv_quoi)  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "sortir":
      window.close();
      break;
  }
}
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=="-1") {
    alert(vl_datas);
  }
  pf_affiche_donnees_relations();
  window.opener.pf_affiche_donnees_relations();
}
function pf_onunload(){
	fa_brl("arbre_interlo",lstn_grise);
}
function pf_raz_fiche(){
  fa_value_set("tb_blocnotebrut",'')
}
function pf_sel_arbre_interlo(){
  var i=fa_cui("arbre_interlo");if(i==-1){return;}
  vf_e_int_cleunik_droite=fa_cell_get("arbre_interlo",i,"int_cleunik");  //  ClÃ© unique interlocuteur
  fa_att_set("tb_qui_droite","_graal_int_cleunik",vf_e_int_cleunik_droite)
  fa_value_set("tb_qui_droite",fa_cell_get("arbre_interlo",i,"qui")+' ('+fa_cell_get("arbre_interlo",i,"raisonsoc")+')');
}
function pf_validation(vv_quoi) {
  var vl_c_donnees;
  if (fa_gid("tb_qui_droite").getAttribute("_graal_int_cleunik")=='0') {alert("Selectionnez un interlocuteur !!");return;}
  vl_c_donnees="";
  vl_c_donnees+="vl_interlo_cleunik_gauche=$vl_e_int_cleunik_gauche&";
  vl_c_donnees+="vl_interlo_cleunik_droite="+fa_enc(fa_gid("tb_qui_droite").getAttribute("_graal_int_cleunik"))+"&";
  vl_c_donnees+="vl_choix_cleunik_gauche="+fa_enc(fa_mlget("ml_rel_gauche"))+"&";
  vl_c_donnees+="vl_choix_cleunik_droite="+fa_enc(fa_mlget("ml_rel_droite"))+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_gid("tb_blocnotebrut").value)+"&";
  vl_c_donnees+="vf_c_action=ajouter&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}
]]></script>
END;
?>
