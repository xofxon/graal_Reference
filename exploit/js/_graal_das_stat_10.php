<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_stats.php");
require_once ('calc/classes/OpenOfficeSpreadsheet.class.php');
require_once "sources_excel/class.writeexcel_workbook.inc.php";
require_once "sources_excel/class.writeexcel_worksheet.inc.php";
$date_deb=fa_recup_param('date_deb','1961');
$date_fin=fa_recup_param('date_fin','2061');

$date_deb='1961';
$date_fin='2061';
$ml_art_02=intval(fa_recup_param('ml_art_02',2));
$ml_art_03=intval(fa_recup_param('ml_art_03',4));
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$ml_panier_acteurs_01=intval(fa_recup_param('ml_panier_acteurs_01',1));
$sortie=fa_recup_param('sortie','das');
$arrondi=0;
stats_rectif_dates($ml_art_03);
/*
 * 1° passage pour l'année demandée
 */
$uuid=_graal_requete_uuid();
$uuid_01=$uuid;
$sql_req="";
fs_construit_requete();
$sql_req_01=$sql_req;
$vf_c_echo=_graal_exec_requete($sql_req_01);
function fs_construit_requete(){
	global $ml_art_02,$ml_art_03,$uuid,$sql_req,$vl_e_act_cleunik,$date_deb,$date_fin;
	switch ($ml_art_02) {
	  case 1:
	  case 2:
	  case 3:
			switch ($ml_art_03) {
			  case  4: $fic_cial="faccli";$coeff="1";break;
			  case  8: $fic_cial="facfou";$coeff="1";break;
			  case  9: $fic_cial="faccli";$coeff="1";break;
			  case 10: $fic_cial="avocli";$coeff="-1";break;
			}
			switch ($ml_art_03) {
			  case  8:
			  case  9:
			  case 10:
					switch ($ml_art_02) {
					  case 1: $sql_req="insert into _temp_stat_01 select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
					  case 2: $sql_req="insert into _temp_stat_01 select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
					  case 3: $sql_req="insert into _temp_stat_01 select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
					}
					$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
					$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (year(f5.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,f1.art_cleunik ";
					break;
				case 4:
					switch ($ml_art_02) {
					  case 1: $sql_req="insert into _temp_stat_01 select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
					  case 2: $sql_req="insert into _temp_stat_01 select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
					  case 3: $sql_req="insert into _temp_stat_01 select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
					}
					$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
					$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (year(f5.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,f1.art_cleunik ";
					$sql_req.=" union all ";

					$fic_cial="avocli";$coeff="-1";

					switch ($ml_art_02) {
					  case 1: $sql_req.=" select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
					  case 2: $sql_req.=" select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
					  case 3: $sql_req.=" select f1.art_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
					}
					$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik";
					$sql_req.=" and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (year(f5.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,f1.art_cleunik ";
			}
			break;
	  case 4:
			switch ($ml_art_03) {
			  case  4: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_02";$fic_cial_03="_vue_faccli_ht_00_inter";break; //  Factures et avoirs (-110116,-110117) regroupés
			  case  8: $fic_cial_01="_facfou_entetes";$fic_cial_02="_vue_facfou_ht_02";$fic_cial_03="_vue_facfou_ht_00_inter";break;
			  case  9: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_02";$fic_cial_03="_vue_faccli_ht_00_inter";break;
			  case 10: $fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_02";$fic_cial_03="_vue_avocli_ht_00_inter";break;
			}
			switch ($ml_art_03) {
			  case  8:
			  case  9:
			  case 10:
					$sql_req="insert into _temp_stat_01 select a1.art_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=2 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a1.art_cleunik ";
					$sql_req.=" union all ";
					$sql_req.=" select a1.art_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=1 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a1.art_cleunik ";
					break;
			}
			switch ($ml_art_03) {
			  case  4:
					$sql_req="insert into _temp_stat_01 select a1.art_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=2 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a1.art_cleunik ";
					$sql_req.=" union all ";
					$sql_req.=" select a1.art_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=1 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a1.art_cleunik ";
					$sql_req.=" union all ";

					$fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_02";$fic_cial_03="_vue_avocli_ht_00_inter";$coeff="1";

					$sql_req.=" select a1.art_cleunik,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) AS z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=2 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a1.art_cleunik ";
					$sql_req.=" union all ";
					$sql_req.=" select a1.art_cleunik,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) as z01,NULL";
					$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
					$sql_req.=" where a3.remise_genr=1 and (year(a1.dateheure_confirm) between '$date_deb' and '$date_fin')";
					$sql_req.=" group by z03,a1.art_cleunik ";
					break;

			}
			break;
	}
}
if ($ml_panier_acteurs_01!=1){
	$vl_e_panier=$ml_panier_acteurs_01;
	include("_graal_req_panier_articles.php");
  	if ($vl_art_cleunik=="") {$vl_art_cleunik=-3;}  //  Impossible
	$sql_complement_condition=" and f00.cleunik_reference in($vl_art_cleunik)";
}

$sql_req="select distinct(year(dateheure_confirm)) as 'Années' from _faccli_lignes_qte order by 1";
    $sql_result = _graal_requete_bd($sql_req);
	$vv_brik='';
	$i=1;
  while ($row = mysql_fetch_assoc($sql_result)) {
  	$value=fa_ent_xml($row['Années']);
  	$vv_brik.=<<<EOT
  	  	(select round(sum(f$i.montant),$arrondi) from _temp_stat_01 f$i where f$i.cleunik_reference=f00.cleunik_reference and f00.c_uuid=f$i.c_uuid and year(f$i.dateheure) = $value ) as 'CA_$value',
EOT;
	$vv_brik.EOL;
  	$i++;
  }
  if ($vv_brik!="") {
        $vv_brik=substr($vv_brik, 0, -1);
      }
  _graal_libere_requete_bd($sql_result);

  $sql_req_01=<<<XOF
select f02.code as code,f00.cleunik_reference,f02.art_cleunik as z02,f02.description as description,
$vv_brik
 from _temp_stat_01 f00 left join _article f02 on f00.cleunik_reference=f02.art_cleunik
 where f00.c_uuid='$uuid_01' $sql_complement_condition
 group by f00.cleunik_reference order by 1
XOF;
/*
echo ($sql_req_01);
die($sql_req_02);
*/
switch ($sortie){
	case "sql":
		header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req_01.EOL;
		exit();
		break;
	case "das":
		$result = _graal_requete_bd($sql_req_01);
		$nfields = mysql_num_fields($result);
		$total_col=array();$total_nom=array();
		echo('<donnees>');
		while ($row = mysql_fetch_array($result, MYSQL_NUM)) {
			echo('<quoi ');
		    echo(' description="'.fa_ent_xml($row[3]).'"');
		    echo(' cleunik_reference="'.fa_ent_xml($row[1]).'"');
		    echo(' code="'.fa_ent_xml($row[0]).'"');
		    $total_ligne=0;
			for ($i=4; $i<$nfields; $i++){
			    $fieldname = mysql_field_name($result, $i);
			    $total_nom[$i]=$fieldname;
				if (is_null($row[$i])||$row[$i]==0) {
			    	echo(" $fieldname=''");
			    } else {
			    	echo(" $fieldname='".fa_ent_xml(number_format(round($row[$i],$arrondi),$arrondi, ',', ' '))."'");
			    	$total_ligne+=round($row[$i],$arrondi);
			    	$total_col[$i]+=round($row[$i],$arrondi);
				}
			}
			echo(" CA_total='".fa_ent_xml(number_format(round($total_ligne,$arrondi),$arrondi, ',', ' '))."'");
			echo('/>');
		}
		echo('<quoi ');
	    echo(' description="Total"');
	    $total_ligne=0;
		for ($i=4; $i<$nfields; $i++){
			$fieldname=$total_nom[$i];
	    	echo(" $fieldname='".fa_ent_xml(number_format(round($total_col[$i],$arrondi),$arrondi, ',', ' '))."'");
	    	$total_ligne+=round($total_col[$i],$arrondi);
		}
		echo(" CA_total='".fa_ent_xml(number_format(round($total_ligne,$arrondi),$arrondi, ',', ' '))."'");
		echo('/>');

		_graal_libere_requete_bd($result);
		echo('</donnees>');
	break;

	case "xls":
		$vl_c_nom_fichier_xls=utf8_decode("CA_Annuel_articles.xls");
		$fname = tempnam("mail", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet(utf8_decode("XsOFt-Graal CA Articles"));
		$result = _graal_requete_bd($sql_req_01);
		$nfields = mysql_num_fields($result);
		$total_col=array();$total_nom=array();
		$vl_e_noligne=0;
		$k=0;
		for ($i=0; $i<$nfields; $i++){
		    $fieldname = mysql_field_name($result, $i);
		    switch ($i){
				case 1:
				case 2:
					break;
				default:
					$worksheet->write($vl_e_noligne, $k, utf8_decode("$fieldname"));
					$k++;
		    		break;
		    }
		}
		$worksheet->write($vl_e_noligne, $k, utf8_decode("Total"));
		//  Lecture des résultats de la requête
		while ($row = mysql_fetch_array($result, MYSQL_NUM)) {
			$vl_e_noligne++;
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode("$row[0]"));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode("$row[3]"));$j++;
		    $total_ligne=0;
			for ($i=4; $i<$nfields; $i++){
			    $fieldname = mysql_field_name($result, $i);
			    $total_nom[$i]=$fieldname;
			    $worksheet->write($vl_e_noligne, $j, utf8_decode("$row[$i]"));$j++;
			    $total_ligne+=round($row[$i],$arrondi);
			    $total_col[$i]+=round($row[$i],$arrondi);
			}
			$worksheet->write($vl_e_noligne, $j, utf8_decode("$total_ligne"));$j++;
		}
		/*
		 * totaux
		 */
		$vl_e_noligne++;
		$j=0;
		$worksheet->write($vl_e_noligne, $j, utf8_decode("Total"));$j++;$j++;
	    $total_ligne=0;
		for ($i=4; $i<$nfields; $i++){
			$fieldname=$total_nom[$i];
			$worksheet->write($vl_e_noligne, $j, utf8_decode("$total_col[$i]"));$j++;
	    	$total_ligne+=round($total_col[$i],$arrondi);
		}
		$worksheet->write($vl_e_noligne, $j, utf8_decode("$total_ligne"));$j++;
		_graal_libere_requete_bd($result);
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		break;
}
$sql_req="delete from _temp_stat_01 where c_uuid in ('$uuid_01');";
$vf_c_echo=_graal_exec_requete($sql_req);
//echo $sql_req;
_graal_ferme_connexion();
?>
