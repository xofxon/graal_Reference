<?php
$pf_init_01="";
if ($vl_c_qui!="eux") {   
  $pf_init_01=<<<EOT
  vf_e_uti_cleunik=$vl_e_uti_cleunik;
  pf_alimente_table("arbre_des_comptes_courriels");
EOT;
} else {
$pf_init_01=<<<EOT
  pf_alimente_table("arbre_des_utilisateurs");
EOT;
}
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope='_graal_bdope_comptes_courriels_01.php?vl_e_genre=$vl_e_genre&';
const vf_c_script_edite='_graal_xml_comptes_courriels_01.php?vl_e_genre=$vl_e_genre&';
const vf_c_script_alim_table01='_graal_das_utilisateurs_02.php?';
const vf_c_script_alim_table02='_graal_das_comptes_courriels_01.php?vl_e_genre=$vl_e_genre&';
const c_script_test_envoi='_graal_exe_fax_envoie_test_01.php?';
const c_script_droits='_graal_fen_comptes_courriels_droits_01.php?';
const c_script_changer_motpasse='_graal_fen_modif_idcon_02.php?vl_e_genre=$vl_e_genre&';
var vf_c_action;
var vf_c_genre;
var vf_e_uti_cleunik,vf_e_uticptbal_cleunik,vf_e_nombre;
const lstn_grise = {
	willRebuild : function(event){}, 
	didRebuild  : function(event){fa_att_rem("_graal_comptes_courriels_01","cursor-wait");fa_grise_fenetre(event,"non");} 
}
function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  fa_value_set("tb_titre",fa_xml_get(vl_c_datas,'titre'));
  fa_att_set("tb_titre","_graal_cleunik",vf_e_uticptbal_cleunik);
  fa_mlsel("ml_type_compte",fa_xml_get(vl_c_datas,'type_compte'),"value");
  fa_value_set("tb_id",fa_xml_get(vl_c_datas,'id'));
	fa_value_set("tb_motdepasse",fa_xml_get(vl_c_datas,'motdepasse'));
	fa_cache_non('tb_changerpwd');
	fa_grise_oui('tb_motdepasse');
	fa_mlsel("ml_qualite",fa_xml_get(vl_c_datas,'qualite'),"value");
	fa_value_set("tb_adresse_cr_fax",fa_xml_get(vl_c_datas,'adresse_cr_fax'));
}
function pf_alimente_defaut() {
}
function pf_alimente_table(vv_laquelle){
  var raf_random=Math.random();
  switch (vv_laquelle){
    case "arbre_des_utilisateurs":
      fa_das(vv_laquelle,vf_c_script_alim_table01+'raf01='+Math.random());
      break;
    case "arbre_des_comptes_courriels":
			fa_grise_fenetre("","oui");
			fa_att_set("_graal_comptes_courriels_01","cursor-wait");
      fa_das(vv_laquelle,vf_c_script_alim_table02+'vl_e_uti_cleunik='+vf_e_uti_cleunik+'&raf01='+Math.random());
      break;
  }
}
function pf_changer_mot_de_passe(){
	var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
	if (vl_e_uticptbal_cleunik==-1) {return;}
  fa_ouvre(c_script_changer_motpasse+"vl_e_uticptbal_cleunik="+vl_e_uticptbal_cleunik,500,100);
}
function pf_droits() {
  var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
  if (vl_e_uticptbal_cleunik==-1) {return;}
  fa_ouvre(c_script_droits+"vl_e_uticptbal_cleunik="+vl_e_uticptbal_cleunik,400,400);

}
function pf_etat_fen(vv_quoi){
  vf_c_action=vv_quoi;
  var vl_e_rowIndex;
  switch(vv_quoi) {
    case "ini":
			vf_e_uticptbal_cleunik=-1;
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_groupe_oui('broadcaster_01');
	fa_gid("arbre_des_comptes_courriels").builder.addListener(lstn_grise);
      $pf_init_01
      break;
    case "selectionner":
			if (vf_e_uticptbal_cleunik==-1){return;}
      if (vf_e_nombre==0) {fa_grise_non("bt_supprimer");}
      fa_grise_non("bt_modifier");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne('tb_titre');
			fa_grise_oui('tb_motdepassepop3');
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_ajouter");
      fa_grise_oui("bt_detailler");
      fa_grise_oui("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne('tb_titre');
			fa_cache_oui('tb_changerpwd');
			fa_grise_non('tb_motdepasse');
			fa_grise_oui('bt_test_emis');
			fa_grise_oui('bt_droits');
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_ajouter");
      fa_grise_non("bt_detailler");
      fa_grise_groupe_oui('broadcaster_01');
      pf_raz_fiche();
      break;
    case "sortir":
     window.close();  //  Ne fonctionne que si c'est une nouvelle fenêtre
     //window.history.back(); //  Ne fonctionne que si cette fenetre est une fenetre appellée dans la même fenêtre
     break;   
 default:
 pf_montre_saisie();
 break;
}
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas=='ok') {
    pf_alimente_table("arbre_des_comptes_courriels");
  }
  else {
    fa_erreur(vl_datas)
  }
  pf_etat_fen('annuler');
}
function pf_raz_fiche(){
  fa_att_set("tb_titre","_graal_cleunik","-1");
	vf_e_uticptbal_cleunik=-1;
  fa_value_set("tb_titre","");
  fa_value_set("tb_motdepasse","");
  fa_value_set("tb_id","");
  fa_value_set("tb_adresse_cr_fax","");
}
function pf_sel_ligne(vv_laquelle){
  switch (vv_laquelle){
  case "arbre_des_utilisateurs":
    var rowIndex =fa_cui("arbre_des_utilisateurs");if(rowIndex==-1){return;}
    vf_e_uti_cleunik=fa_cell_get("arbre_des_utilisateurs",rowIndex,"uti_cleunik");
    pf_alimente_table("arbre_des_comptes_courriels");
    break;
  case "arbre_des_comptes_courriels":
    if(fa_est_grise("bt_detailler")==true){return};
    var rowIndex = fa_cui("arbre_des_comptes_courriels");if(rowIndex == -1){return;}
    vf_e_uticptbal_cleunik=fa_cell_get("arbre_des_comptes_courriels",rowIndex,"uticptbal_cleunik");
    vf_e_nombre=fa_cell_get("arbre_des_comptes_courriels",rowIndex,"nombre");
    var s =fa_enc("vl_e_uticptbal_cleunik")+"="+vf_e_uticptbal_cleunik+"&raf01="+Math.random();
    fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
  }
}
function pf_test_emis() {
  var s="";
  var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
  s+="vl_e_compte="+vl_e_uticptbal_cleunik+"&";
  var vl_c_fax_dest=prompt('Fax du destinataire','');
  if (vl_c_fax_dest!="") {
  	s+="vl_c_fax_dest="+fa_enc(vl_c_fax_dest)+"&";
  	s+="raf01="+Math.random();
  	fa_xmlhttprequest_txt(c_script_test_envoi,s,pf_test_emis_fin);
	}
}
function pf_test_emis_fin(stream) {
  alert(stream);
}
function pf_onunload(){
	fa_brl("arbre_des_comptes_courriels",lstn_grise);
}
function pf_validation(vv_quoi){
  var s;
  var vl_e_uticptbal_cleunik=fa_att_get("tb_titre","_graal_cleunik");
  s="";
  s+="vl_e_uticptbal_cleunik="+vl_e_uticptbal_cleunik+"&";
  s+="vl_e_uti_cleunik="+vf_e_uti_cleunik+"&";
  s+="vl_c_titre="+fa_enc(fa_value_get("tb_titre"))+"&";
  s+="vl_c_id="+fa_enc(fa_value_get("tb_id"))+"&";
  s+="vl_c_motdepasse="+fa_enc(fa_value_get("tb_motdepasse"))+"&";
  s+="vl_c_type_compte="+fa_enc(fa_mlget("ml_type_compte","value"))+"&";
  s+="vl_c_qualite="+fa_enc(fa_mlget("ml_qualite","value"))+"&";
  s+="vl_c_adresse_cr_fax="+fa_enc(fa_value_get("tb_adresse_cr_fax"))+"&";
  switch(vv_quoi) {
     case "enregistrer":
      if (vl_e_uticptbal_cleunik!=-1) {
        s +="vl_c_action=modifier&";
      }
      else {
         s +="vl_c_action=ajouter&";
      }
      break;
     case "supprimer":
       if(confirm("Confirmez-vous la suppression de ce compte fax ?") == false) return;
       s =fa_enc("vl_c_action")+"="+fa_enc('supprimer')+"&";
       s +=fa_enc("vl_e_uticptbal_cleunik")+"="+fa_enc(vl_e_uticptbal_cleunik);
      break;
 }     
fa_xmlhttprequest_txt(vf_c_script_bdope,s,pf_fin_requete);
}
]]></script>
END;
?>
