<?php
$vl_c_mes_01='Cette fonctionnalité est en développement ...\nMerci pour votre patience.';
$vl_c_mes_02='Vous ne pouvez pas gérer les droits de cette manière !!';
$vl_c_dico_00004=fa_recup_dico("dico_00004");
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
****************************************************************
**********  Fenêtre de gestion des icones  ********
****************************************************************
*/
var vf_e_ficones_cleunik;
var vf_c_action;
var vf_c_genre;
var vf_c_url_alimente_table='_graal_das_icones_01.php?quelsdoc=$vl_c_quelsdocs&';
var vf_c_script_bdope_doc="_graal_bdope_icones_01.php?";
const vf_c_upload_doc="_graal_upload_icone.php?quelsdocs=$vl_c_quelsdocs&";
var vf_c_script_edite="_graal_xml_icones_01.php";
const vf_c_script_affiche_image="_graal_bdope_affiche_icone_01.php?";
var vf_c_retour="";
const lstn_grise = { 
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre("","non");} 
};
function pf_action_fin_01(vv_message) {
  alert(vv_message)
}

function pf_affiche_datas(stream){
  var vl_c_datas;
  pf_raz_fiche();
  vl_c_datas = stream;
  vf_e_ficones_cleunik=fa_xml_get(vl_c_datas,'ficones_cleunik');
  fa_value_set('tb_emplacement',fa_xml_get(vl_c_datas,'ficones_cheminorigine'));
  fa_value_set('tb_titre',fa_xml_get(vl_c_datas,'ficones_designation'));
  fa_value_set('tb_descriptif_sommaire',fa_xml_get(vl_c_datas,'ficones_infos'));
    fa_att_set("bt_supprimer","label","$vl_c_dico_00004");
    fa_att_set("bt_supprimer","tooltiptext","$vl_c_dico_00004 Ctrl+Shift+F4")
    fa_att_set("bt_supprimer","oncommand","if(fa_est_grise('bt_supprimer')==true){return};pf_validation('supprimer');")
}
function pf_affiche_image() {
  fa_att_set("ifr_image","src",vf_c_script_affiche_image+'ficones_cleunik='+vf_e_ficones_cleunik );
}

function pf_alimente_defaut(){}
function pf_alimente_table(){
	fa_grise_fenetre("","oui");
  fa_das("arbre_icones",vf_c_url_alimente_table+"&raf01="+Math.random());
}
function pf_etat_fen(vv_quoi)  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
	fa_badl("arbre_icones",lstn_grise);
      fa_grise_non("bt_ajouter");
      fa_grise_oui("bt_affiche_image");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_detailler");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_oui("bt_supprimer");
      fa_grise_groupe_oui('broadcaster_01');
      pf_alimente_table();
      break;
    case "selectionner":
      vf_c_action="selectionner"
      fa_grise_groupe_oui('broadcaster_01');
      fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_modifier");
      if (("$vl_c_quelsdocs"=="client")&&(vf_e_ficones_cleunik<0)) {
      	fa_grise_oui("bt_supprimer");}
      else {
      	fa_grise_non("bt_supprimer");
      }
      //fa_grise_oui("bt_sortir");
      fa_grise_non("bt_affiche_image");
      break;
    case "modifier":
      fa_grise_non("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_supprimer");
      fa_grise_groupe_non('broadcaster_01');
      fa_grise_non("tb_telecharge_doc");
      fa_grise_oui("tb_ouvre_fichier");fa_grise_oui("tb_ouvre_fichier_ged");
      fa_ro_oui("tb_emplacement");
      fa_focusdonne('tb_titre');
      break;
    case "ajouter":
    fa_grise_oui("bt_affiche_image");
      fa_grise_oui("bt_ajouter");
      fa_grise_non("bt_annuler");
      fa_grise_oui("bt_detailler");
      fa_grise_non("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_oui("bt_supprimer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_emplacement");
      break;
    case "annuler":
    fa_grise_oui("bt_affiche_image");
      fa_grise_non("bt_ajouter");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_detailler");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_oui("bt_supprimer");
      fa_grise_non("tb_telecharge_doc");
      pf_raz_fiche();
      fa_grise_groupe_oui('broadcaster_01');
      fa_focusdonne('arbre_icones');
      break;
    case "sortir":
      window.close();
      break;   
  }
}
function pf_fin_requete(stream){
	pf_alimente_table();
  var vl_datas = stream;
  if (vl_datas=='ok') {
    switch (vf_c_action) {
      case 'ajouter':
        vf_c_action="modifier";
        pf_etat_fen('annuler');
        break;
      case 'modifier':
        pf_raz_fiche();
        pf_etat_fen('annuler');
        break;
       case 'supprimer':
        pf_etat_fen('annuler');
        pf_etat_fen("sortir");
        break;
      default :
        alert('gestion mal gérée');
    }
  }
  else {
    fa_erreur(vl_datas)
  }
}
function pf_ouvre_fichier(vv_quoi_01){
  switch (vv_quoi_01) {
    case 'disque':
      var vl_c_nomfic=fa03_sel_fichier("-1","");
			if (vl_c_nomfic!=""){
	      var vl_c_hash=fa03_fichier_sha1(vl_c_nomfic);
	      fa_value_set("tb_emplacement",vl_c_nomfic);
	      fa_att_set("tb_emplacement","hash",vl_c_hash);
	      pf_verif_hash();
			}
      break;
    case 'ged':
      vf_c_retour="ouverture";
      switch ("$vl_c_quelsdocs"){
		  case "image_articl"  :  //  Un lien d'image article
		  case "uneimg_articl" :
			case "unlogoentrep"	 :	//	Un logo d'entreprise	
		    fa_ouvre(c_fen_selection_image,1000,800);
		    break;
		  default:
		    fa_ouvre(c_fen_selection_doc,1000,800);
		}
      break;
  }
}

function pf_raz_fiche(){
  vf_e_ficones_cleunik=0;
  fa_value_set("tb_emplacement","");
  fa_value_set("tb_titre","");
  fa_value_set("tb_descriptif_sommaire","");
  fa_att_set("ifr_image","src","_graal_page_blanche_01.php");
}
function pf_sel_ligne(vv_objet) {
  if(fa_est_grise("bt_detailler")==true){return};
  var rowIndex = fa_cui("arbre_icones");if(rowIndex == -1){return;}
  vf_e_ficones_cleunik=fa_cell_get("arbre_icones",rowIndex,"tc_ficones_cleunik");
  var s ="vl_e_icones_cleunik="+fa_enc(vf_e_ficones_cleunik)+"&";
  fa_grise_non("bt_affiche_image");
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var s="";
  switch(vv_quoi){
    case "enregistrer":
      if (fa_gid("tb_emplacement").value ==''){alert('Votre saisie n\'a pas de sens!');fa_focusdonne("tb_emplacement");return;}
      if (vf_e_ficones_cleunik==0){
        vf_c_action="ajouter";
          fa_grise_oui("bt_annuler");
          fa_grise_oui("bt_enregistrer");
		fa_grise_fenetre("","oui");
          window.setTimeout('pf_validation_upload()',250);
      } else {
        s+="vf_e_ficones_cleunik="+fa_enc(vf_e_ficones_cleunik)+"&";
        s+="vf_c_titre="+fa_enc(fa_value_get("tb_titre"))+"&";
        s+="vf_c_descriptif_sommaire="+fa_enc(fa_value_get("tb_descriptif_sommaire"))+"&";
        s+="vf_c_action="+fa_enc("modifier")+"&";
        fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
      }
      return;
      break;
    case "supprimer":
      if(confirm("Confirmez-vous la suppression de cette image ?") == false) return;
      vf_c_action="supprimer";
      s +="vf_e_ficones_cleunik="+fa_enc(vf_e_ficones_cleunik)+"&";
      s +="vf_c_action=supprimer&";
      fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_fin_requete);
      break;
  }     
}
function pf_validation_upload(){
  fa_att_set("_graal_fen_doc_08","wait-cursor","true");
  fa03_fichier_lit_et_envoie(vf_c_upload_doc,pf_validation_upload_fin,fa_value_get("tb_emplacement"));
}
function pf_validation_upload_fin(stream) {
  var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  fa_grise_non("bt_annuler");
  fa_grise_non("bt_enregistrer");
  fa_gid("_graal_fen_doc_08").removeAttribute("wait-cursor");
  if (window.opener!=null) {window.opener.pf_affiche_donnees_ged();}
  if (tableau_retour[0]!=0) {
    alert("Image téléchargée ...");
		fa_grise_fenetre("","non");
    vf_e_ficones_cleunik=tableau_retour[0];
    pf_validation("enregistrer");
  } else {
    alert(tableau_retour[1]);
		fa_grise_fenetre("","non");
  }
}
function pf_verif_hash(){
  var s ="vf_c_action=verifier_hash&vf_c_hash="+fa_enc(fa_att_get("tb_emplacement","hash"))+"&";
  fa_xmlhttprequest_txt(vf_c_script_bdope_doc,s,pf_verif_hash_fin);
}
function pf_verif_hash_fin(stream) {
  var vl_c_param=stream;
  fa_grise_oui("tb_ouvre_fichier");fa_grise_oui("tb_ouvre_fichier_ged");
  var tableau_retour=vl_c_param.split('|');
  if (tableau_retour[0]==0) {
    fa_att_set("tb_hash_verifie","class","ak16");
  } else {
    alert("Attention !!! Existe déjà dans la base ...");
    fa_xmlhttprequest_xml(vf_c_script_edite,"vl_e_icones_cleunik="+tableau_retour[1]+"&",pf_affiche_datas);
  }
}
function pf_visualise(){
  if (vf_e_ficones_cleunik!=0){
    pf07_visualise_doc(vf_e_ficones_cleunik);
  }
  else {
    alert("Aucun fichier n'est sélectionné !!!");
  }
	
}
]]></script>
END;
?>
