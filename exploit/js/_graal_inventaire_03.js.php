<?php
include("_graal_var_portee.php");
$vl_c_bvh_123js=fa_recup_dico_js("bvh_123");
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_selection_encours=false;var vf_c_url_alimente_table="";
const c_script_bdope_fen="_graal_bdope_inventaire_articles_03.php";
const c_script_lecture_csv="_graal_import_inventaire_03.php?vl_c_modele=1&";
const c_script_import_lambda_01="_graal_das_import_lambda_02.php?sortie=inventaire_03&id=";

const lstn_grise_articles= { 
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre("","non");} 
	};
function pf_aa_init() {
  fa_ael('bbo_ml_qui','ValueChange',po_change_menu);
  po_change_menu();
  fa_badl("arbre_des_articles",lstn_grise_articles);
}
function pf_aa_ferme(){
}
function pf_alimente_table(vl_c_url_alimente_table){
	vf_c_url_alimente_table=vl_c_url_alimente_table;
	fa_grise_fenetre("","oui");
	fa_das("arbre_des_articles",vl_c_url_alimente_table);
}
function pf_clavier(e,vv_objet) {
	try {
		switch(e.keyCode){
      case 13: // 'Enter'	//	Surtout pas enter !!!
      case 9: // 'Tab'
      case 40: // 'flèche basse'
      pf_ligne_suivante(vv_objet);
      	break;
      case 38:	//	flèche précédente
        pf_ligne_précedente(vv_objet)
        break;
      default:
        break;
    }
 	} catch (e) {
    alert("erreur"+e)
  }
}
function pf_export_excel_01(){
	var vl_c_nom_fichier_xls=prompt("Nom du fichier","essai.xls");
	var vl_c_url="";
	vl_c_url=vf_c_url_alimente_table;
	vl_c_url+='&sortie=excel_01';
	vl_c_url+="&vl_c_nom_fichier_xls="+fa_enc(vl_c_nom_fichier_xls)+"&";
	fa_ouvre(vl_c_url);
}
function pf_ligne_suivante(vv_objet){
var vl_e_nb=fa_gid(vv_objet).view.rowCount;
  var rowIndex = fa_gid(vv_objet).currentIndex;
  if(rowIndex == -1){return;}
  if (vl_e_nb-1<=rowIndex){
  	fa_gid(vv_objet).view.selection.select(rowIndex);
	fa_gid(vv_objet).startEditing(rowIndex,fa_gid(vv_objet).columns.getNamedColumn("qte_inventaire"));
  	return;
  }
  rowIndex++;
  fa_gid(vv_objet).view.selection.select(rowIndex)
	fa_gid(vv_objet).startEditing(rowIndex,fa_gid(vv_objet).columns.getNamedColumn("qte_inventaire"));
}
function pf_ligne_précedente(vv_objet){
var vl_e_nb=fa_gid(vv_objet).view.rowCount;
  var rowIndex = fa_gid(vv_objet).currentIndex;
  if(rowIndex == -1){return;}
  if (rowIndex == 0){
  	fa_gid(vv_objet).view.selection.select(0);
	fa_gid(vv_objet).startEditing(0,fa_gid(vv_objet).columns.getNamedColumn("qte_inventaire"));
  	return;
  }
  rowIndex--;
  fa_gid(vv_objet).view.selection.select(rowIndex);
	fa_gid(vv_objet).startEditing(rowIndex,fa_gid(vv_objet).columns.getNamedColumn("qte_inventaire"));
}
function pf_ouvre_csv(){
	var vl_c_filtre00="Fichiers CSV";
    var vl_c_filtre01="*.csv";
    var vl_c_fichier=fa03_sel_fichier(vl_c_filtre00,vl_c_filtre01);
    if (vl_c_fichier!='' ) {
    	vf_c_sha1=fa03_fichier_sha1(vl_c_fichier);
    	fa_grise_fenetre('','oui');
    	fa03_fichier_lit_et_envoie(c_script_lecture_csv+"separateur="+fa_value_get("ml_separateur")+"&raf="+Math.random()+"&",pf_ouvre_csv_suite,vl_c_fichier);
    }
}
function pf_ouvre_csv_suite(stream){
var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  if (tableau_retour[0]=='-1') {
  	alert(tableau_retour[1]);
  	fa_grise_fenetre('','non');
  	return;
  }
  fa_grise_fenetre("","oui");
  fa_das("arbre_des_articles",c_script_import_lambda_01+tableau_retour[0]);
}
function pf_saisie(){
	switch (vf_selection_encours){
		case false:
			var vl_e_nb=0;
			try {
    			vl_e_nb=fa_gid("arbre_des_articles").view.rowCount;
	  			if (vl_e_nb==0) {return;}
		  	}  catch (e) {
				return;
			}
			fa_cache_oui("vb_selection");
			fa_cache_oui("bt_ouvre_csv");
			fa_cache_oui("ml_separateur");
			fa_cache_non("qte_inventaire");
			fa_cache_non("boite_validation_inventaire");
			fa_att_set("arbre_des_articles","editable","true");
			fa_att_set("qte_inventaire","editable","true");
			fa_att_set("arbre_des_articles","onkeyup","pf_clavier(event,this.id);");
			vf_selection_encours=true;
			break;
		case true:
			fa_cache_oui("boite_validation_inventaire");
			fa_cache_non("bt_ouvre_csv");
			fa_cache_non("vb_selection");
			fa_cache_oui("qte_inventaire");
			fa_cache_non("ml_separateur");
			fa_att_set("qte_inventaire","editable","false");
			fa_att_set("arbre_des_articles","editable","false");
			fa_att_set("arbre_des_articles","onkeyup","");
			vf_selection_encours=false;
			break;
	}
}
function pf_validation(vv_arbre){
	var vl_e_nb=fa_gid("arbre_des_articles").view.rowCount;
  var vl_t_art_cleunik=[];
  var vl_t_qte=[];
  var vl_qte="";
  if (vl_e_nb!=0) {
  	vl_e_j=-1;
    for(i=0;i<vl_e_nb;i++) {
    	vl_qte=fa_cell_get("arbre_des_articles",i,"qte_inventaire");
    	if (vl_qte!=""){
    		vl_qte=parseFloat(vl_qte);
    		//alert(vl_pu)
    		if (isNaN(vl_qte)==false){
    			vl_e_j++;
    			vl_t_art_cleunik[vl_e_j]=fa_cell_get("arbre_des_articles",i,"art_cleunik");
    			vl_t_qte[vl_e_j]=vl_qte;
    		}
    	}
    }
  }
  if (vl_t_art_cleunik==0) {alert("Rien n'a été mis à jour !");return;}
  if(!confirm("$vl_c_bvh_123js (date, dépôt, emplacement, valorisation)")) {return;}
  var vl_c_donnees="vf_c_action=kilometres_inventaire_simple&";
  vl_c_donnees+="vl_dateheureinventaire="+fa_enc(fa_value_get("tb_dateheureinventaire")+" "+fa_value_get("tb_heu_deb"))+"&";
  vl_c_donnees+="vl_tarif_reference="+fa_enc(fa_value_get('ml_tarif_reference'))+"&";
  vl_c_donnees+="vl_depot="+fa_enc(fa_mlget('ml_depot'))+"&";
  vl_c_donnees+="vl_empla="+fa_enc(fa_mlget('ml_empla'))+"&";
  vl_c_donnees+="vl_t_art_cleunik="+fa_enc(fa_jsarray2php_00(vl_t_art_cleunik))+"&";
  vl_c_donnees+="vl_t_qte="+fa_enc(fa_jsarray2php_00(vl_t_qte))+"&";
  fa_grise_fenetre("","oui");
  fa_xmlhttprequest_txt(c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
} 
function pf_validation_fin(stream) {
  var vl_datas = stream;
  alert("Fin d'enregistrment de l'inventaire");
  pf_alimente_table(vl_c_url_alimente_table);
}
]]></script>
END;
?>
