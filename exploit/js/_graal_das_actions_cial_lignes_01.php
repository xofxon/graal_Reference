<?php
include("_graal_header_xml.inc.php");
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','19610123');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','20610123');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_sortie=fa_recup_param('sortie','das');
$nb_dec_qte=2;
$nb_dec_pu=2;

// execution de la requÃ¨te SQL
$sql_req="select 'Facture' as genre,a3.code as numero,f7.code,f7.description,a1.art_cleunik,"._graalsql_date('a1.dateheure_confirm')." as date_document,round(sum(a1.htbrutremise)+";
$sql_req.=" ((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else ";
$sql_req.=" round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) ";
$sql_req.=" AS montant,a3.act_cleunik,a3.action_cleunik as action_cleunik,(case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end) AS ";
$sql_req.=" nom_acteur from _vue_faccli_ht_02 a1 left join _vue_faccli_ht_00_inter a2 using(commercial_cleunik) left join _faccli_entetes a3 using(commercial_cleunik)";
$sql_req.="  left join _acteurs f6 on f6.act_cleunik=a3.act_cleunik left join _article f7 on f7.art_cleunik=a1.art_cleunik where a3.remise_genr=2 and ";
$sql_req.=" (a1.dateheure_confirm between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')  group by a3.action_cleunik,a1.art_cleunik ";
$sql_req.="  union all  ";
$sql_req.=" select 'Facture' as genre,a3.code as numero,f7.code,f7.description,a1.art_cleunik,"._graalsql_date('a1.dateheure_confirm')." as date_document,round(sum(a1.htbrutremise)+";
$sql_req.=" ((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else ";
$sql_req.=" sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as montant,a3.act_cleunik,a3.action_cleunik as action_cleunik, ";
$sql_req.=" (case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end) AS nom_acteur  from _vue_faccli_ht_02 a1 left join ";
$sql_req.=" _faccli_entetes a3 using(commercial_cleunik)  left join _acteurs f6 on f6.act_cleunik=a3.act_cleunik left join _article f7 on f7.art_cleunik=a1.art_cleunik  ";
$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')  group by a3.action_cleunik,a1.art_cleunik ";
$sql_req.=" union all  ";
$sql_req.=" select 'Avoir' as genre,a3.code as numero,f7.code,f7.description,a1.art_cleunik,"._graalsql_date('a1.dateheure_confirm')." as date_document,(round(sum(a1.htbrutremise)+";
$sql_req.=" ((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else ";
$sql_req.=" round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) ";
$sql_req.=" AS montant,a3.act_cleunik,a3.action_cleunik as action_cleunik,(case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end) AS nom_acteur ";
$sql_req.="   from _vue_avocli_ht_02 a1 left join _vue_avocli_ht_00_inter a2 using(commercial_cleunik) left join _avocli_entetes a3 using(commercial_cleunik) ";
$sql_req.=" left join _acteurs f6 on f6.act_cleunik=a3.act_cleunik  left join _article f7 on f7.art_cleunik=a1.art_cleunik  where a3.remise_genr=2 and ";
$sql_req.=" (a1.dateheure_confirm between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')  group by a3.action_cleunik,a1.art_cleunik ";
$sql_req.=" union all  ";
$sql_req.=" select 'Avoir' as genre,a3.code as numero,f7.code,f7.description,a1.art_cleunik,"._graalsql_date('a1.dateheure_confirm')." as date_document,(round(sum(a1.htbrutremise)+";
$sql_req.=" ((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) ";
$sql_req.=" * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) as montant,a3.act_cleunik,a3.action_cleunik as action_cleunik,(case `f6`.`raisonsoc` ";
$sql_req.=" when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end) AS nom_acteur  from _vue_avocli_ht_02 a1 left join _avocli_entetes a3 ";
$sql_req.=" using(commercial_cleunik) left join _acteurs f6 on f6.act_cleunik=a3.act_cleunik  left join _article f7 on f7.art_cleunik=a1.art_cleunik  ";
$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')  group by a3.action_cleunik,a1.art_cleunik";

//die($sql_req);

switch ($vl_c_sortie) {
  case "das":
    echo('<?xml version="1.0" encoding="UTF-8"?>');
	$result = _graal_requete_bd($sql_req);
	echo('<donnees>');
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
		  echo(' genre="'.fa_ent_xml($row['genre']).'"');
		  echo(' numero="'.fa_ent_xml($row['numero']).'"');
		  echo(' code="'.fa_ent_xml($row['code']).'"');
		  echo(' description="'.fa_ent_xml($row['description']).'"');
		  echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		  echo(' date_document="'.fa_ent_xml($row['date_document']).'"');
		  echo(' montant="'.fa_ent_xml($row['montant']).'"');
		  echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
		  echo(' nom_acteur="'.fa_ent_xml($row['nom_acteur']).'"');
		  $total+=$row['montant'];
		echo('/>');
	}
	echo('<quoi ');
	  echo(' description="Total"');
	  echo(" montant='".$total."'");
	  echo(' nom_acteur="Total"');
	  $total+=$row['montant'];
	echo('/>');
	echo('</donnees>');
	// fermeture du curseur et de la connexion
	_graal_libere_requete_bd($result);
	_graal_ferme_connexion();
	break;
  case "sql":
  	header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
		exit();
    break;
  case "excel_02":
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";
		$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("CA Articles Clients"));
		$result = _graal_requete_bd($sql_req);
		$vl_e_noligne=0;
		while ($row = mysql_fetch_assoc($result)) {
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['genre']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['date_document']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['numero']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['nom_acteur']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['montant']));$j++;
		    $total+=$row['montant'];
		    $vl_e_noligne++;
		}
		$j=0;
	    $worksheet->write($vl_e_noligne, $j, "");$j++;
		$worksheet->write($vl_e_noligne, $j, "");$j++;
		$worksheet->write($vl_e_noligne, $j, "");$j++;
	    $worksheet->write($vl_e_noligne, $j, "");$j++;
	    $worksheet->write($vl_e_noligne, $j, "");$j++;
	    $worksheet->write($vl_e_noligne, $j, utf8_decode("Total HT"));$j++;
	    $worksheet->write($vl_e_noligne, $j, utf8_decode($total));$j++;
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
  	break;
}
?>
