<?php
echo <<<END
<script type="application/x-javascript"><![CDATA[
const _c_url_alimente_table_reglements="_graal_das_treso_reglement_02.php?genreacteur=$vl_c_genreacteur&";
const c_script_bdope_fen="_graal_bdope_remise_banque_01.php";
var vf_c_url_alimente_table="";
var vf_t_panier=[];
const vf_c_script_var='_graal_cree_variable_session_tempo.php?var=vs_tempo_panier_remises_banque';
const lstn_grise= { 
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre("","non");} 
};
function pf_aa_init(){
	fa_badl("arbre_reglements",lstn_grise);
	fa_badl("arbre_panier_remise_banque",lstn_grise);
	fa05_sel_date('34','bsr_tb_deb','bsr_tb_fin');fa_check("-me_tb_deb_34");
	fa_att_set("arbre_reglements","seltype","multiple");
  	pf_approximatif();
}
function pf_alimente_table(){
	fa_grise_fenetre("","oui");
  	fa_das("arbre_reglements",vf_c_url_alimente_table);
}
function pf_approximatif(){
  if ( fa_value_get("bsr_tb_rechapproxima") == "" ) {return;}
  vf_c_url_alimente_table=_c_url_alimente_table_reglements+'&raf_random='+Math.random();
  vf_c_url_alimente_table+='&vl_c_dateheuredebut='+fa_enc(fa_date_formate(fa_value_get("bsr_tb_deb"),"AAAAMMJJ"));
	vf_c_url_alimente_table+='&vl_c_dateheurefin='+fa_enc(fa_date_formate(fa_value_get("bsr_tb_fin"),"AAAAMMJJ"));
	vf_c_url_alimente_table+='&vl_c_recherche='+fa_enc(fa_value_get("bsr_tb_rechapproxima"));
	vf_c_url_alimente_table+='&vl_e_typedate='+fa_mlget("bsr_ml_typedate","value");
	vf_c_url_alimente_table+='&vl_e_type='+fa_mlget("bsr_ml_type","value");
	vf_c_url_alimente_table+='&vl_e_etat='+fa_mlget("bsr_ml_etat","value");
	vf_c_url_alimente_table+='&vl_e_journal='+fa_mlget("ml_journal");
	vf_c_url_alimente_table+='&vl_e_genre=-1';
	pf_alimente_table();
}
function pf_onunload(){
	fa_brl("arbre_reglements",lstn_grise);
	fa_brl("arbre_panier_remise_banque",lstn_grise);
}
function pf_panier_ajoute() {
	var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_t_reglements=[];
  vl_t_tableau=fa_lignes_selectionnees("arbre_reglements");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_reglements[i]=fa_cell_get("arbre_reglements",vl_t_tableau[i],"tc_reglement_cleunik");
    }
  }
  if (vl_t_reglements.length==0) {return;}
  var vl_t_panier=[];
  vl_t_panier=vf_t_panier;
  vf_t_panier=vl_t_panier.concat(vl_t_reglements);
  fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
}
function pf_panier_ajoute_fin(stream){
	fa_grise_fenetre("","oui");
	var vl_c_url_alimente_table=_c_url_alimente_table_reglements+'&raf_random='+Math.random();
	vl_c_url_alimente_table+='&vl_e_genre=-3';
	fa_ds("arbre_panier_remise_banque",vl_c_url_alimente_table);
}
function pf_panier_enleve() {
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  vl_t_tableau=fa_lignes_selectionnees("arbre_panier_remise_banque");
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_panier=[];
    var vl_t_reglements=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_reglements[i]=fa_cell_get("arbre_panier_remise_banque",vl_t_tableau[i],"tc_reglement_cleunik");
    }
    var j=0;k=-1;
    for(i=0;i<vf_t_panier.length;i++) {
      if (vl_t_reglements.indexOf(vf_t_panier[i])==-1) { 
        k++;
        vl_t_panier[k]=vf_t_panier[i];
      }  
    }
    vf_t_panier=vl_t_panier;
    fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
  }
}
function pf_validation(vv_quoi) {
    var vl_c_donnees;
    vl_c_donnees="";
    switch(vv_quoi) {
      case "enregistrer":
      	if (vf_t_panier.length==0){alert("Aucun réglement à remettre.");return;}
        vl_c_donnees+='&vl_mode_paiement='+fa_mlget("ml_mode_paiement");
		vl_c_donnees+='&vl_option_remise='+fa_mlget("ml_option_remise");
		vl_c_donnees+='&vl_journal_cleunik='+fa_mlget("ml_journal_remise");
        vl_c_donnees+="&vl_te_reglement_cleunik="+fa_enc(fa_jsarray2php_00(vf_t_panier));
        vl_c_donnees+="&vl_date_remise_banque="+fa_enc(fa_value_get("tb_dat_remise_banque"));
        vl_c_donnees+="&vf_c_action=ajouter&";
        break;
    }
    fa_xmlhttprequest_txt(c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
}
function pf_validation_fin(stream){
	if(stream=="ok"){
		alert("Remise enregistrée");
	} else {
		alert(stream);
	}
	vf_t_panier=[];
	fa_xmlhttprequest_txt(vf_c_script_var,'vl_t_listecles='+fa_jsarray2php_00(vf_t_panier),pf_panier_ajoute_fin);
	fa_lignes_arbre_deselectionne("arbre_panier_remise_banque");
	pf_approximatif();
}
]]></script>
END;
?>