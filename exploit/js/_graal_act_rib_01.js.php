<?php
$vl_c_bdf_110=fa_recup_dico_js("bdf_110");
echo <<<END
<script type="application/x-javascript"><![CDATA[
const vf_c_script_bdope_fen="_graal_bdope_act_rib_01.php";
const vf_c_script_edite="_graal_xml_act_rib_01.php";
const vf_c_script_verif="_graal_verifie_rib.php";
var vf_c_action;
const vf_e_act_cleunik="$vl_e_act_cleunik";
var vf_e_rib_cleunik="$vl_e_rib_cleunik";
function pf_aa_init() {
  switch (vf_e_rib_cleunik) {
    case "-1":  //  création
      pf_etat_fen("ajouter");
      break;
    default:
      pf_etat_fen("ini");
      pf_selectionne_rib();
      break;
  }
}
function pf_affiche_datas(stream) {
  var vl_c_datas = stream;
  fa_value_set("la_dateheurevalidite",fa_xml_get(vl_c_datas,'dateheurevalidite'));
  fa_value_set("tb_domiciliation",fa_xml_get(vl_c_datas,'domiciliation'));
  fa_value_set("tb_etablissement",fa_xml_get(vl_c_datas,'etablissement'));
  fa_value_set("tb_guichet",fa_xml_get(vl_c_datas,'guichet'));
  fa_value_set("tb_compte",fa_xml_get(vl_c_datas,'compte'));
  fa_value_set("tb_cle",fa_xml_get(vl_c_datas,'cle'));
  fa_value_set("la_dateheuremodif",fa_xml_get(vl_c_datas,'dateheuremodif'));
  fa_value_set("tb_blocnotebrut",fa_xml_get(vl_c_datas,'blocnotebrut'));
  fa_value_set("rdg_oui_non",fa_xml_get(vl_c_datas,'principal'));
}
function pf_alimente_defaut() {}
function pf_cree_iban(){
  var vl_c_donnees="";
  vl_c_donnees+="vl_etablissement="+fa_enc(fa_value_get("tb_etablissement"))+"&";
  vl_c_donnees+="vl_guichet="+fa_enc(fa_value_get("tb_guichet"))+"&";
  vl_c_donnees+="vl_compte="+fa_enc(fa_value_get("tb_compte"))+"&";
  vl_c_donnees+="vl_cle="+fa_enc(fa_value_get("tb_cle"))+"&";
  vl_c_donnees+="vl_e_act_cleunik="+vf_e_act_cleunik+'&';
  var vl_e_pays=fa_gid("ml_iban").selectedItem.value;
  switch (vl_e_pays) {
    case '121500': fa_xmlhttprequest_txt('_graal_exe_transfo_rib_fr_iban.php',vl_c_donnees,pf_cree_iban_fin);break; //  France
    default: alert("Fonctionnalité en développement !!!");break;
  }
}
function pf_cree_iban_fin(stream) {
  var vl_c_data=stream;
  alert(vl_c_data);
  switch ("$vl_c_genreacteur") {
		case "110001": window.opener.pf_affiche_donnees_iban_cli();break;
    case "110003": window.opener.pf_affiche_donnees_iban_cli();break;
    case "110004": window.opener.pf_affiche_donnees_iban_fou();break;
  }
}
function pf_etat_fen(vv_quoi)
  {
  vf_c_action=vv_quoi;
  switch(vv_quoi) {
    case "ini":
      fa_grise_non("bt_modifier");
      fa_grise_non("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_oui("bt_annuler");
      fa_grise_non("bt_sortir");
      fa_grise_groupe_oui('broadcaster_01');
      break;
    case "modifier":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_domiciliation");
      break;
    case "ajouter":
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_modifier");
      fa_grise_non("bt_sortir");
      fa_grise_non("bt_annuler");
      fa_grise_non("bt_enregistrer");
      pf_raz_fiche();
      pf_alimente_defaut();
      fa_grise_groupe_non('broadcaster_01');
      fa_focusdonne("tb_domiciliation");
      break;
    case "annuler":
      fa_grise_oui("bt_modifier");
      fa_grise_oui("bt_annuler");
      fa_grise_oui("bt_supprimer");
      fa_grise_oui("bt_enregistrer");
      fa_grise_non("bt_sortir");
      switch (vf_e_rib_cleunik)      {
        case "-1":  //  création
          pf_etat_fen("ajouter");
          break;
        default:
          pf_etat_fen("ini");
          pf_selectionne_rib();
          break    
      }
      break;
    case "sortir":
      window.close();
      break;
    default:
      break;
  }
  }
function pf_fin_requete(stream){
  var vl_datas = stream;
  if (vl_datas.substring(0,3)!="-1-") {
    switch (vf_c_action){
      case "ajouter":
      case "modifier":
        break;
      case "supprimer":
        alert("Rib supprimé.")
        break;
    }
    switch ("$vl_c_genreacteur") {
			case "110001": window.opener.pf_affiche_donnees_rib_cli();break;
      case "110003": window.opener.pf_affiche_donnees_rib_cli();break;
      case "110004": window.opener.pf_affiche_donnees_rib_fou();break;
    }
    pf_etat_fen("sortir");
    }
  else {alert(vl_datas);pf_etat_fen("annuler");}
}
function pf_gere_suivant(vv_qui) {
  var vl_c_valeur=vv_qui.value
  if (vv_qui.getAttribute("maxlength")==vl_c_valeur.length) {fa_focusdonne(vv_qui.getAttribute("_graal_suivant"));}
}
function pf_raz_fiche() {
  fa_value_set("la_dateheurevalidite","");
  fa_value_set("tb_domiciliation","");
  fa_value_set("tb_etablissement","");
  fa_value_set("tb_guichet","");
  fa_value_set("tb_compte","");
  fa_value_set("tb_cle","");
  fa_value_set("la_dateheuremodif","");
  fa_value_set("tb_blocnotebrut","");
}

function pf_selectionne_rib() {
  var s ="vl_e_rib_cleunik="+vf_e_rib_cleunik+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
}
function pf_validation(vv_quoi){
  var vl_c_donnees ="";
  vl_c_donnees+="vl_rib_cleunik="+fa_enc(vf_e_rib_cleunik)+"&";
  vl_c_donnees+="vl_domiciliation="+fa_enc(fa_value_get("tb_domiciliation"))+"&";
  vl_c_donnees+="vl_etablissement="+fa_enc(fa_value_get("tb_etablissement"))+"&";
  vl_c_donnees+="vl_guichet="+fa_enc(fa_value_get("tb_guichet"))+"&";
  vl_c_donnees+="vl_compte="+fa_enc(fa_value_get("tb_compte"))+"&";
  vl_c_donnees+="vl_cle="+fa_enc(fa_value_get("tb_cle"))+"&";
  vl_c_donnees+="vl_blocnotebrut="+fa_enc(fa_value_get("tb_blocnotebrut"))+"&";
  vl_c_donnees+="vl_act_cleunik="+fa_enc(vf_e_act_cleunik)+"&";
  vl_c_donnees+="vl_principal="+fa_enc(fa_value_get("rdg_oui_non"))+"&";
  switch(vv_quoi) {
    case "enregistrer":
      if (vf_e_rib_cleunik!=-1) {
        vl_c_donnees+="vf_c_action=modifier&";
        vf_c_action="modifier";
      }
      else {
        vl_c_donnees+="vf_c_action=ajouter&";
        vf_c_action="ajouter";
      }
      break;
    case "supprimer":
        Check = confirm("$vl_c_bdf_110");
        if(Check == false) return;
        vl_c_donnees+="vf_c_action=supprimer&"
        vf_c_action="supprimer";
      break;
  }
  fa_xmlhttprequest_txt(vf_c_script_bdope_fen,vl_c_donnees,pf_fin_requete);
}

function pf_verif_rib(){
  var vl_c_donnees="";
  vl_c_donnees+="vl_etablissement="+fa_enc(fa_value_get("tb_etablissement"))+"&";
  vl_c_donnees+="vl_guichet="+fa_enc(fa_value_get("tb_guichet"))+"&";
  vl_c_donnees+="vl_compte="+fa_enc(fa_value_get("tb_compte"))+"&";
  vl_c_donnees+="vl_cle="+fa_enc(fa_value_get("tb_cle"))+"&";
  fa_xmlhttprequest_txt(vf_c_script_verif,vl_c_donnees,pf_verif_rib_fin);
}
function pf_verif_rib_fin(stream) {
  var vl_c_data=stream;
  alert(vl_c_data);
}
]]></script>
END;
?>
