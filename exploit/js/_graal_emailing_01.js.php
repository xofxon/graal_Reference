<?php
$var_rc='\r\n';
$var_0d='\n';
$rExp ="\x0d\x0a";
$vl_c_bok_157js=fa_recup_dico_js("bok_157");
$vl_c_bok_158js=fa_recup_dico_js("bok_158");
$vl_c_bok_159js=fa_recup_dico_js("bok_159");
$vl_c_bok_162js=fa_recup_dico_js("bok_162");
$vl_c_bok_163js=fa_recup_dico_js("bok_163");
$vl_e_nbmax=intval(fa_recup_session('vs_nb007','0'));
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
*********************************************************************
**********  Fenêtre de gestion de la création des courriels  ********
*********************************************************************
*/
var vf_c_script_edite_note='_graal_bdope_note_03.php';
const c_script_edite_note_brut='_graal_bdope_note_04.php?';
const vf_c_script_edite='_graal_xml_modeles_courriels_01.php';
const vf_c_script_intweb='_graal_xml_modeles_courriels_01.php';
const vf_c_script_das_courriel="_graal_das_courriel_01.php?";
const vf_c_script_edite_intweb="_graal_xml_act_interlo_mail_03.php?vl_e_action_cleunik=$vl_e_action_cleunik&";
const c_script_emailing_cleweb_attente="_graal_bdope_emailing_cleweb_attente_01.php?vl_e_action_cleunik=$vl_e_action_cleunik&";
const c_script_das_deja="_graal_das_emailing_deja_01.php?vl_e_action_cleunik=$vl_e_action_cleunik&";
const c_script_das_attente="_graal_das_emailing_attente_01.php?vl_e_action_cleunik=$vl_e_action_cleunik&";
const c_script_das_destinataires="_graal_das_act_interlo_mail_03.php";
const c_fen_panier_intweb='_graal_traitements_courriel_01.php?vl_e_action_cleunik=$vl_e_action_cleunik&emailing=oui&genreacteur=';
const c_script_var='_graal_cree_variable_session_tempo.php?';
const c_script_hash_doc='_graal_bdope_pj_hash_01.php?vf_c_hash=';
const c_upload_pj="_graal_upload_pj.php?";
const vf_c_script_envoie_courriel="_graal_exe_emailing_envoie.php?";
const c_fen_panier_pj="_graal_fen_rech_piecesjointes_01.php?type=select&";
const c_fen_selection_notes="_graal_fen_ged_01.php?genreged=tousss&quelsdocs=notes&retour=oui&";
const c_fen_selection_docs="_graal_fen_ged_01.php?genreged=tousss&quelsdocs=docs&retour=oui&selection=oui&";
const vf_c_script_fen_acteur="_graal_fen_acteurs_01.php?genreacteur=";
const c_fen_interlo_mail="_graal_fen_act_interlo_mail_01.php?";
var vf_c_liste_en_cours="",vf_indice_liste_pj=0,vf_b_suite=false,vf_b_validation_possible=false;
var vf_c_tableau_retour="",vf_c_variable_requete="";
var vf_t_courriel=[];
var vf_t_intweb=[];
var vf_nombre_pj=0,vf_t_cleunik=[],vf_nombre_pj_lues=0,vf_ligne_pj_a_lire=0;
var vf_c_bok_145="$vl_c_bok_145"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_146="$vl_c_bok_146"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_147="$vl_c_bok_147"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_148="$vl_c_bok_148"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_149="$vl_c_bok_149"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_150="$vl_c_bok_150"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_151="$vl_c_bok_151"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_152="$vl_c_bok_152"; //  utilisé dans _graal_emailing_01_complement.js
var vf_c_bok_156="$vl_c_bok_156";
const c_max=Number($vl_e_nbmax);
var vf_e_reste=Number($vl_e_nbmax);
var vf_c_genre="$vl_c_genre";//  utilisé dans _graal_emailing_01_complement.js
const c_script_edite_emimail_renvoi="_graal_xml_emimail_01.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_emailing_01_complement.js
const c_script_edite_html_renvoi="_graal_xml_emimail_02.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_fen_mailing_suite="_graal_fen_emailing_01.php?genre=continuer&type=$vl_c_type_courriel&action_cleunik=";
const lstn_grise_01 = {
	willRebuild : function(event){},
	didRebuild  : function(event){fa_att_rem("_graal_emailing_01","cursor-wait");fa_grise_fenetre(event,"non");}
}
const lstn_grise_02 = {
	willRebuild : function(event){},
	didRebuild  : function(event){fa_att_rem("_graal_emailing_01","cursor-wait");fa_grise_fenetre(event,"non");}
}
const lstn_grise_03 = {
	willRebuild : function(event){},
	didRebuild  : function(event){fa_att_rem("_graal_emailing_01","cursor-wait");pf_cree_tableau();fa_grise_fenetre(event,"non");}
}
function pf_acteur_ouvre() {
  var rowIndex = fa_cui("arbre_deja_envoyes");if(rowIndex == -1){return;}
  var param=fa_cell_get("arbre_deja_envoyes",rowIndex,"tc_typeacteur_deja")+"&act_cleunik="+fa_cell_get("arbre_deja_envoyes",rowIndex,"tc_act_cleunik_deja")+"&";
  fa_ouvre(vf_c_script_fen_acteur+param,1200,800)
}
function pf_affiche_attente(){
	var vl_e_attente=Number(fa_att_get("tb_nombre_destinataires_file_attente","_graal_nombre"));
	if (vl_e_attente>=500){
		fa_att_set("tb_nombre_destinataires_file_attente","label",vl_e_attente+" destinataires en attente ...");
		fa_grise_fenetre("","non");
		fa_att_rem("_graal_emailing_01","cursor-wait")
	} else {
		pf_affiche_attente_force();
	}
}
function pf_affiche_attente_force(){
	fa_grise_fenetre("","oui");
	fa_das("arbre_file_attente",c_script_das_attente+"&raf="+Math.random()+"&");
}
function pf_affiche_attente_force_limite(){
	fa_grise_fenetre("","oui");
	fa_das("arbre_file_attente",c_script_das_attente+"&raf="+Math.random()+"&vl_e_limit="+vf_e_reste+"&");
}
function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  var vl_c_chaine=fa_xml_get(vl_c_datas,'blocnote_riche');
  var vl_c_sortie=vl_c_chaine.replace(/<br>/g, "$var_rc");
  vl_c_sortie=vl_c_sortie.replace(/#date#/g,fa05_dates_en_clair("date"));
  vl_c_sortie=vl_c_sortie.replace(/#heure#/g,fa05_dates_en_clair("heure"));
  vl_c_sortie=vl_c_sortie.replace(/#dateheure#/g,fa05_dates_en_clair("dateheure"));
  fa_value_set("tb_message",vl_c_sortie);
}
function pf_affiche_deja_envoyes(){
	var vl_e_deja_envoyes=Number(fa_att_get("tb_nombre_destinataires","_graal_nombre"));
	if (vl_e_deja_envoyes>=500){
		fa_att_set("tb_nombre_destinataires","label",vl_e_deja_envoyes+" Destinataires...")
		fa_cache_non("tob_deja_envoye");
		fa_grise_fenetre("","non");
		fa_att_rem("_graal_emailing_01","cursor-wait");
	} else {
		pf_affiche_deja_envoyes_force();
	}
}
function pf_affiche_deja_envoyes_force(){
	fa_das("arbre_deja_envoyes",c_script_das_deja+"&raf="+Math.random()+"&");
}
function pf_alimente_defaut(){
  fa_value_set("tb_sujet","$vl_sujet");
  switch ("$vl_c_type_courriel") {
    case "texte":
      pf_complement_01_texte();//  Dans _graal_courriel_01_complement.js
      break;
    case "html":

      switch ("$vl_e_action_cleunik") {
        case '-1':
          fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';");
          break;
        default:
					if ("$vf_c_modification"=="modif") {
						fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';");
					} else {
          	fa_grise_oui("tb_sujet");
					}
          break;
      }

/*
			if (("$vl_e_action_cleunik"=='-1') || ("$vf_c_modification"=="modif")){
	      fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';");
			else {
        fa_grise_oui("tb_sujet");
			}
*/
      pf_complement_01_html();
      fa_att_set("content","src","_graal_page_blanche_02.php");
      break;
  }
  fa_value_set("rdg_unpardestinataire",1);
  fa_value_set("rdg_uneactionpardestinataire",2);
  fa_value_set("rdg_priorite",0);
  fa_value_set("rdg_sensitivite",0);
  fa_value_set("rdg_integre_pj_sipossible",2);
  fa_value_set("rdg_confirmation_lecture",2);
}
function pf_courriel_ouvre(vv_qui) {
  var vl_c_arbre=vv_qui;
  var i=fa_cui(vl_c_arbre);if(i==-1){return;}
  var vl_c_param="genreacteur="+fa_cell_get(vl_c_arbre,i,"tc_typeacteur_deja")+"&vl_e_intweb_cleunik="+fa_cell_get(vl_c_arbre,i,"tc_intweb_cleunik_deja")
  fa_ouvre(c_fen_interlo_mail+vl_c_param,700,600);
}
function pf_cree_tableau() {
  var count=fa_cl(vf_c_liste_en_cours);
  vf_e_reste=c_max-count;
  fa_att_set("bt_panier_dest_a","label",vf_c_bok_156+(vf_e_reste));
  var vl_t_courriel=[];
  var vl_t_intweb=[];
  if (count!=0) {
    var vl_t_intweb=[];
    for(i=0;i<count;i++) {
      vl_t_intweb[i]=fa_cell_get("arb_destinataires",i,"arb_dest_intweb_cleunik");
      vl_t_courriel[i]=fa_cell_get("arb_destinataires",i,"arb_dest_courriel");
    }
  }
  vf_t_intweb=vf_t_intweb.concat(vl_t_intweb);
  vf_t_courriel=vf_t_courriel.concat(vl_t_courriel);
  if (vf_e_reste <=0) {
    fa_cache_oui("bt_panier_dest_a");
    fa_cache_oui("bt_dest_a");
  } else {
    fa_cache_non("bt_panier_dest_a");
    fa_cache_non("bt_dest_a");
  }
	fa_grise_fenetre("","non");
}
function pf_etat_fen(vv_quoi){
  switch(vv_quoi) {
    case "ini":
      fa_value_set("id_encore",vf_c_bok_156+(vf_e_reste));
      fa_att_set("bt_panier_dest_a","label",vf_c_bok_156+(vf_e_reste));
      fa_att_set("dest_a","autosuggestsearch",vf_c_script_das_courriel);
      fa_grise_oui("ra_integre_pj_sipossible_1");
      fa_grise_oui("ra_integre_pj_sipossible_2");
	fa_badl("arbre_file_attente",lstn_grise_01);
	fa_badl("arbre_deja_envoyes",lstn_grise_02);
	fa_badl("arb_destinataires",lstn_grise_03);
      pf_alimente_defaut();
      fa_focusdonne('dest_a');
      pf_complement_02();//  Dans _graal_courriel_01_complement.js

END;
switch ($vl_c_type_courriel) {
  case "texte":
    break;
  case "html":
    //echo('fa_gid("content").contentDocument.designMode="on";');
    echo('fa_grise_oui("ra_integre_pj_sipossible_1");');
    echo('fa_grise_oui("ra_integre_pj_sipossible_2");');
    break;
}
switch ("$vl_e_action_cleunik") {
  case '-1':
    break;
  default:
    echo('fa_cache_non("tab_deja");');
    echo('fa_cache_non("tabpanel_deja");');
		echo('fa_cache_non("tab_file_attente");');
    break;
}
echo <<<END
      break;
    case "annuler":
			window.location=document.location;
      pf_raz_fiche();
      pf_alimente_defaut();
      break;
    case "sortir":
      window.close();
      break;
    case "reinitialise":
      fa_gid('dk_02').selectedIndex=0;
      //window.location=document.location;
      break;
  }
}
function pf_interlo_ouvre() {
  var vl_c_arbre="arbre_deja_envoyes";
  var i=fa_cui(vl_c_arbre);if(i==-1){return;}
  var vl_c_param="genreacteur="+fa_cell_get(vl_c_arbre,i,"tc_typeacteur_deja")+"&vl_e_interlo_cleunik="+fa_cell_get(vl_c_arbre,i,"tc_int_cleunik_deja")
  vl_c_param+='&vl_e_act_cleunik='+fa_cell_get(vl_c_arbre,i,"tc_act_cleunik_deja")+"&";
  fa_ouvre_interlo(vl_c_param);
}
function pf_insere_desinscription(vv_quoi){
	//	Insère la référence à un bloc désinscription <bloc_desinscription_xsoftware 10000018>
  var e = fa_gid("content");
  var tracking=e.contentWindow.document.createElement("bloc_desinscription_xsoftware");
  tracking.innerHTML="bloc désinscription_" +vv_quoi+"_";
  insertNodeAtSelection(e.contentWindow, tracking);
}
function pf_insere_desinscription_texte(vv_quoi){
	//	Insère la référence à un bloc désinscription
  fa_value_set("tb_message_texte",fa_value_get("tb_message_texte")+"§bloc_desinscription_xsoftware_"+vv_quoi+"_§");
}
function pf_insere_sondage(vv_quoi){
	//	Insère la référence à un bloc désinscription <bloc_sondage_xsoftware 10000018>
  var e = fa_gid("content");
  var tracking=e.contentWindow.document.createElement("bloc_sondage_xsoftware");
  tracking.innerHTML="bloc sondage_" +vv_quoi+"_";
  insertNodeAtSelection(e.contentWindow, tracking);
}
function pf_insere_sondage_texte(vv_quoi){
	//	Insère la référence à un bloc sondage
  fa_value_set("tb_message_texte",fa_value_get("tb_message_texte")+"§bloc_sondage_xsoftware_"+vv_quoi+"_§");
}

function pf_insere_tracking(){
	var url = prompt("Saisissez l'adresse à laquelle il faudra aller après le tracking:", "http://");
    if((url!=null) && (url!="") && (url!="http://")&& (url!="mailto:")){
    var e = fa_gid("content");
    var range = e.contentWindow.getSelection().getRangeAt(0);
    var container = range.startContainer;
    var contenu=container.innerHTML;
    if (contenu==undefined){
    	contenu=e.contentWindow.getSelection();
    }
    contenu=e.contentWindow.getSelection();
    var toto='<a xsoftware_tracking="" href="'+url+'">'+contenu+'</a>';
    apply("insertHtml",false,toto);
    }
}
function pf_insere_image_tracking() {
  var vl_c_nomfic=fa03_sel_fichier("-1","");
  if (vl_c_nomfic=="") {return;}
  fa03_fichier_lit_et_envoie(c_script_encode_image,pf_insere_image_tracking_fin,vl_c_nomfic);
}
function pf_insere_image_tracking_fin(stream) {
  var vl_c_datas = stream;
  var url = prompt("Saisissez l'adresse à laquelle il faudra aller après le tracking:", "http://");
    if((url!=null) && (url!="") && (url!="http://")&& (url!="mailto:")){
	  var e = fa_gid("content");
	  var range = e.contentWindow.getSelection().getRangeAt(0);
	  var container = range.startContainer;
	  var toto='<a xsoftware_tracking="" href="'+url+'"><img src="'+vl_c_datas+'" border="0"></a>';
	  apply("insertHtml",false,toto);
	}
}
function pf_insere_lien_image_tracking() {
  var url_image = prompt("Saisissez l'adresse de l'image :", "http://");
    if((url_image!=null) && (url_image!="") && (url_image!="http://")){
	  var url = prompt("Saisissez l'adresse à laquelle il faudra aller après le tracking:", "http://");
	    if((url!=null) && (url!="") && (url!="http://")&& (url!="mailto:")){
		  var e = fa_gid("content");
		  var range = e.contentWindow.getSelection().getRangeAt(0);
		  var container = range.startContainer;
		  var toto='<a xsoftware_tracking="" href="'+url+'"><img src="'+url_image+'" border="0"></a>';
		  apply("insertHtml",false,toto);
		}
	}
}
function pf_insere_preuve_ouverture(){
  var e = fa_gid("content");
  var range = e.contentWindow.getSelection().getRangeAt(0);
  var container = range.startContainer;
  var toto='<img src="$param_generaux_graal_196" border="0" style="display:none;">';
  apply("insertHtml",false,toto);
}
function pf_onunload(){
	fa_brl("arbre_file_attente",lstn_grise_01);
	fa_brl("arbre_deja_envoyes",lstn_grise_02);
}
function pf_ouvre_fichier(vv_quoi){
  switch (vv_quoi) {
    case 'disque' :
      var vl_c_nomfic=fa03_sel_fichier("","");
      fa_value_set("tb_emplacement",vl_c_nomfic);
      var vl_c_hash=fa03_fichier_sha1(vl_c_nomfic);
      fa_xmlhttprequest_txt(c_script_hash_doc+fa_enc(vl_c_hash),'',pf_ouvre_fichier_fin);
      break;
    case 'ged':
      fa_ouvre(c_fen_selection_docs);
      break;
  }
}
function pf_ouvre_fichier_fin(stream){
  var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  var row = document.createElement('listitem');
  var cell = document.createElement('listcell');
  cell.setAttribute('label', fa_value_get("tb_emplacement"));
  cell.setAttribute('_graal_fichier', tableau_retour[0]);
  cell.setAttribute('_graal_cleunik', tableau_retour[1]);
  row.appendChild( cell );
  fa_gid("li_pj").appendChild( row );
  fa_value_set("tb_emplacement","");
}
function pf_ouvre_panier_courriel(vv_bouton) {
  var vl_e_cleunik=-1;
	switch (vv_bouton) {
		case "bt_panier_file_attente":
			vf_c_liste_en_cours="arbre_file_attente";
			break;
		case "bt_panier_dest_a":
		  vf_c_liste_en_cours="arb_destinataires";
			break;
	}
  fa_ouvre(c_fen_panier_intweb+"tousss&reste="+vf_e_reste+"&",1000,800);
}
function pf_ouvre_panier_courriel_retour() {
	var vl_t_tableau=vf_t_intweb.concat(vf_c_tableau_retour);
	fa_grise_fenetre("","oui");
	vf_t_intweb=[];
	fa_xmlhttprequest_txt(c_script_var+"var=vs_tempo_courriel_destinataires",'vl_t_listecles='+fa_jsarray2php_00(vl_t_tableau),pf_ouvre_panier_courriel_retour_fin);
}
function pf_ouvre_panier_courriel_retour_fin(){
	fa_das("arb_destinataires",c_script_das_destinataires+"?raf="+Math.random()+"&");
}
function pf_ouvre_panier_pj() {
  fa_ouvre(c_fen_panier_pj,600,400);
}
function pf_ouvre_selection_note() {
  fa_ouvre(c_fen_selection_notes);
}
function pf_raf(){
	alert("$vl_c_bok_162js");
}
function pf_raz_fiche(){}
function pf_retour_fenetre(vv_t_tableau) {
	vf_c_tableau_retour=vv_t_tableau;
	switch (vf_c_liste_en_cours){
		case "arb_destinataires":
			if (vf_c_tableau_retour.length <= vf_e_reste) {
		    vf_c_tableau_retour=vv_t_tableau;
		  } else {
		    vf_c_tableau_retour=[];
		    for(i=0;i<vf_e_reste;i++) {
		      vf_c_tableau_retour[i]=vv_t_tableau[i];
		    }
		    alert("On n'a retenu que "+vf_e_reste+" adresses (maximum atteint).");
		  }
			if (vf_e_reste<=0) {return;}
		  setTimeout(pf_ouvre_panier_courriel_retour, 0);
			break;
		case "arbre_file_attente":
			fa_grise_fenetre("","oui");
			fa_xmlhttprequest_txt(c_script_emailing_cleweb_attente,"vl_e_intweb_cleunik="+vf_c_tableau_retour+"&raf="+Math.random()+"&vf_c_action=ajouter&",pf_retour_fenetre_attente);
			break;
		default:
			alert("Erreur de programmation !!!");
			return;
			break;
	}
}
function pf_retour_fenetre_attente(stream){
	fa_att_set("tb_nombre_destinataires_file_attente","_graal_nombre",stream);
	fa_att_set("tb_nombre_destinataires_file_attente","label",stream);
	//fa_ouvre(c_script_emailing_cleweb_attente+"vl_e_intweb_cleunik="+vf_c_tableau_retour+"&raf="+Math.random()+"&vf_c_action=ajouter&")
	pf_affiche_attente();
}
function pf_retour_fenetre_docs(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', vv_t_tableau_nom[i]);
      cell.setAttribute('_graal_fichier', 2);
      cell.setAttribute('_graal_cleunik', vv_t_tableau_cleunik[i]);
      row.appendChild( cell );
      fa_gid("li_pj").appendChild( row );
    }
  }
}
function pf_retour_fenetre_notes(vv_t_tableau_cleunik) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      pf_top_model(vv_t_tableau_cleunik[i]);
    }
  }
}
function pf_retour_fenetre_pj(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', vv_t_tableau_nom[i]);
      cell.setAttribute('_graal_fichier', 1);
      cell.setAttribute('_graal_cleunik', vv_t_tableau_cleunik[i]);
      row.appendChild( cell );
      fa_gid("li_pj").appendChild( row );
    }
  }
}
function pf_retour_fenetre_requete(stream){
	vf_c_variable_requete=stream;
	//alert(vf_c_variable_requete)
	fa_cache_oui("bt_enregistrer");
	fa_cache_oui("bt_dest_a");
	fa_cache_oui("bt_panier_dest_a");
	fa_cache_non("bt_envoi_requete");
}
function pf_retro(){
	fa_gid("content").innerHTML=fa_value_get("tb_source");
}
function pf_sel_attentes(){
	vf_c_liste_en_cours="li_dest_a";
	var vl_c_arbre="arbre_file_attente";
	var vl_recherche="tc_intweb_cleunik_file_attente";
  var vl_t_tableau=[];
  var vl_e_nb_sel;
  var vl_c_donnees="";
  vl_t_tableau=fa_lignes_selectionnees(vl_c_arbre);
  vl_e_nb_sel=vl_t_tableau.length;
  if (vl_e_nb_sel!=0) {
    var vl_t_intweb=[];
    for(i=0;i<vl_e_nb_sel;i++) {
      vl_t_intweb[i]=fa_cell_get(vl_c_arbre,vl_t_tableau[i],vl_recherche);
    }
  }
  if (vl_t_intweb.length==0) {return;}
	vf_c_tableau_retour=vl_t_intweb;
	if (vf_c_tableau_retour.length <= vf_e_reste) {
  //if (vf_c_tableau_retour.length <= vf_c_tableau_retour.length) {
    vf_c_tableau_retour=vl_t_intweb;
  } else {
    vf_c_tableau_retour=[];
    for(i=0;i<vf_e_reste;i++) {
      vf_c_tableau_retour[i]=vl_t_intweb[i];
    }
    alert("On n'a retenu que "+vf_e_reste+" adresses (maximum atteint).");
  }
	if (vf_e_reste<=0) {return;}
  setTimeout(pf_ouvre_panier_courriel_retour, 0);
}
function pf_supprime_ligne(vv_qui) {
  var listbox = fa_gid(vv_qui);
  var x=fa_cui(vv_qui);if (x==-1) {return;}
  listbox.removeItemAt(x);
  pf_cree_tableau();
}

function pf_top_model(vv_qui){
END;
switch ($vl_c_type_courriel) {
  case "texte":
echo <<<END
  var s ="vl_e_modele="+vv_qui+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
END;
  break;
  case "html" :
echo <<<END
  fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';pf_complement_model();");
  fa_att_set("content","src",vf_c_script_edite_note+'?doc_cleunik='+vv_qui);
END;
  break;
}
echo <<<END
}
function pf_top_model_texte(vv_qui){
  var s ="doc_cleunik="+vv_qui+"&";
  fa_xmlhttprequest_txt(c_script_edite_note_brut+s,"",pf_top_model_texte_fin);
}
function pf_top_model_texte_fin(stream){
  /*
	var vl_c_datas = stream;
  var vl_c_chaine=fa_xml_get(vl_c_datas,'blocnote_brut');
	vl_c_chaine=vl_c_datas;
  var vl_c_sortie=vl_c_chaine.replace(/<br>/g, "$var_rc");
  vl_c_sortie=vl_c_sortie.replace(/#date#/g,fa05_dates_en_clair("date"));
  vl_c_sortie=vl_c_sortie.replace(/#heure#/g,fa05_dates_en_clair("heure"));
  vl_c_sortie=vl_c_sortie.replace(/#dateheure#/g,fa05_dates_en_clair("dateheure"));
 	*/
  fa_value_set("tb_message_texte",stream);
}
function pf_upload_pj(vv_quelle_ligne) {
	var item1 = fa_gid("li_pj").getItemAtIndex(vv_quelle_ligne);
	var vl_graal_fichier=parseInt(item1.childNodes[0].getAttribute('_graal_fichier'));
	var vl_graal_cleunik=parseInt(item1.childNodes[0].getAttribute('_graal_cleunik'));
	var vl_c_nomfic=item1.childNodes[0].getAttribute('label');
 	vf_nombre_pj_lues++;
  if (vl_graal_fichier==0) {
		fa03_fichier_lit_et_envoie(c_upload_pj,pf_upload_pj_suite,vl_c_nomfic);
	} else {
		vf_t_cleunik.push(vl_graal_cleunik);
		pf_upload_pj_suite(-1);
	}
}
function pf_upload_pj_suite(vv_data) {
	switch (vv_data) {
		case -1:
			break;
		default:
			vf_t_cleunik.push(vv_data);
	}
	if (vf_nombre_pj_lues!=vf_nombre_pj) {
		vf_ligne_pj_a_lire++;
		pf_upload_pj(vf_ligne_pj_a_lire);
	} else {
		pf_validation_suite();
	}
}
function pf_valid_attente(){
	if (!confirm("Confirmez-vous l'envoi des adresses en file d'attente ? Peut-être très long ...")) {return;}
  var s="";
  if (fa_value_get("tb_sujet")=="") {if (!confirm("$vl_c_bok_157js")) {fa_focusdonne("tb_sujet");return;}}
  switch ("$vl_c_type_courriel") {
    case "texte":
      if (fa_value_get("tb_message")=="") {if (!confirm("$vl_c_bok_158js")) {fa_focusdonne("tb_message");return;}}
      break;
    case "html":
      break;
  }
	fa_grise_fenetre("","oui");
  fa_att_set("bt_enregistrer","label","$vl_c_bok_114 (1/2)");
  fa_grise_oui("bt_enregistrer");
  vf_b_validation_possible=true;
	vf_nombre_pj=fa_gid("li_pj").getRowCount();
  vf_t_cleunik=[];
	vf_nombre_pj_lues=0;
	vf_ligne_pj_a_lire=0;
	if (vf_nombre_pj!=0) {
		fa_att_set("bt_enregistrer","label","$vl_c_bok_114 (1/2) ... (1/"+vf_nombre_pj+")");
		pf_upload_pj(vf_ligne_pj_a_lire);
	} else {
		pf_valid_attente_suite();
	}
}
function pf_valid_attente_suite(){
	var s="";
  if (!vf_b_validation_possible) {
    alert("$vl_c_bok_159js");
    fa_att_set("bt_enregistrer","label","$vl_c_bok_101");
		fa_grise_fenetre("","non");
    fa_bgc("bt_enregistrer",'init');
    fa_grise_non("bt_enregistrer");
    return;
  }
  fa_att_set("bt_enregistrer","label","$vl_c_bok_114 (2/2)");
	fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_14",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vf_t_cleunik)),'');

  s+="vl_c_sujet="+fa_enc(fa_value_get("tb_sujet"))+"&";
  s+="vl_e_sendmail_from="+fa_enc(fa_mlget("ml_emetteur","_graal_cleunik"))+"&";
  s+="vl_c_id="+fa_enc("?")+"&";
  s+="vl_c_type_envoi="+fa_enc(fa_value_get("rdg_unpardestinataire"))+"&";
  s+="vl_c_type_action="+fa_enc(fa_value_get("rdg_uneactionpardestinataire"))+"&";
  s+="vl_c_priorite="+fa_enc(fa_value_get("rdg_priorite"))+"&";
  s+="vl_c_sensitivity="+fa_enc(fa_value_get("rdg_sensitivite"))+"&";
  s+="vl_c_integre_pj_sipossible="+fa_enc(fa_value_get("rdg_integre_pj_sipossible"))+"&";
  s+="vl_c_confirmation_lecture="+fa_enc(fa_value_get("rdg_confirmation_lecture"))+"&";
	s+="vl_c_affichernom="+fa_enc(fa_value_get("rdg_affichernom"))+"&";
	s+="vl_c_remplacement_noms="+fa_enc(fa_value_get("tb_remplacement_noms"))+"&";
  s+="raf="+Math.random()+"&";
  s+="vl_c_genre=liste_attente&";
	s+="vl_e_action_cleunik=$vl_e_action_cleunik&";
	s+="vl_e_attente_nombre=$vl_e_nbmax&";
END;
  switch ($vl_c_type_courriel) {
    case "texte":
      echo('s+="vl_c_message="+fa_enc(fa_gid("tb_message").value)+"&";s+="vl_c_type_courriel=1&";');
      break;
    case "html":
      echo('s+="vl_c_message="+fa_enc(fa_gid("content").contentWindow.document.documentElement.innerHTML)+"&";s+="vl_c_type_courriel=2&";s+="vl_c_message_texte="+fa_enc(fa_value_get("tb_message_texte"))+"&";');
      break;
  }
echo <<<END
  fa_xmlhttprequest_txt(vf_c_script_envoie_courriel,s,pf_validation_fin);
}


function pf_validation(){
  var s="";
    var vl_nombre=fa_cl("arb_destinataires");
	if (vl_nombre==0) {alert("$vl_c_bok_163js");return;}
  if (fa_value_get("tb_sujet")=="") {if (!confirm("$vl_c_bok_157js")) {fa_focusdonne("tb_sujet");return;}}
  switch ("$vl_c_type_courriel") {
    case "texte":
      if (fa_value_get("tb_message")=="") {if (!confirm("$vl_c_bok_158js")) {fa_focusdonne("tb_message");return;}}
      break;
    case "html":
      break;
  }
	fa_gid("html_qui_grise").style.display = "";
  fa_att_set("bt_enregistrer","label","$vl_c_bok_114"+' (1/2)');
  fa_grise_oui("bt_enregistrer");
  vf_b_validation_possible=true;
	vf_nombre_pj=fa_gid("li_pj").getRowCount();
  vf_t_cleunik=[];
	vf_nombre_pj_lues=0;
	vf_ligne_pj_a_lire=0;
	if (vf_nombre_pj!=0) {
		fa_att_set("bt_enregistrer","label","$vl_c_bak_114"+' (1/2) ... (1/'+vf_nombre_pj+")");
		pf_upload_pj(vf_ligne_pj_a_lire);
	} else {
		pf_validation_suite();
	}
}
function pf_validation_fin(stream){
  var vl_c_datas = stream;
  //alert(stream);
  var vl_action_cleunik=0;
  var tableau_retour=vl_c_datas.split('|');
	fa_gid("tabbox_01").selectedIndex=0;
  if (tableau_retour[0]!='0') {
    fa_value_set("tb_cr",tableau_retour[0]+tableau_retour[1]);
    fa_gid('dk_01').selectedIndex=1;
  } else {
    fa_gid('dk_02').selectedIndex=1;
    vl_action_cleunik=tableau_retour[2];
		fa_vide_liste("li_dest_a");
		vf_e_reste=c_max;
  	fa_att_set("bt_panier_dest_a","label",vf_c_bok_156+(vf_e_reste));
		fa_cache_non("bt_panier_dest_a");
    fa_cache_non("bt_dest_a");
  }
  fa_gid("bt_enregistrer").label="$vl_c_bok_101";
	fa_grise_fenetre("","non");
  fa_grise_non("bt_enregistrer");
	if (vl_action_cleunik!=0) {
	  switch ("$vl_c_genre") {
	    case "normal":
	    case "continuer":
		  window.location=c_fen_mailing_suite+vl_action_cleunik;
	      break;
	  }
	} else {
		fa_grise_fenetre("","non");
	}
}
function pf_validation_modification(){
	var s="vl_c_genre=modifier&";
	s+="vl_e_sendmail_from="+fa_enc(fa_mlget("ml_emetteur","_graal_cleunik"))+"&";
	switch ("$vl_c_type_courriel") {
    case "texte":
      s+="vl_c_message="+fa_enc(fa_value_get("tb_message"))+"&";
	  s+="vl_c_type_courriel=2&";
      break;
    case "html":
      s+="vl_c_message="+fa_enc(fa_gid("content").contentWindow.document.documentElement.innerHTML)+"&";
	  s+="vl_c_type_courriel=2&";
	  s+="vl_c_message_texte="+fa_enc(fa_value_get("tb_message_texte"))+"&";
      break;
  }
  s+="vl_e_courriel_en_mes_cleunik="+fa_att_get("tb_sujet","courriel_en_mes_cleunik")+"&";
  s+="vl_c_sujet="+fa_enc(fa_value_get("tb_sujet"))+"&";
  s+="vl_e_action_cleunik=$vl_e_action_cleunik&";
  fa_xmlhttprequest_txt(vf_c_script_envoie_courriel,s,pf_validation_modification_fin);
}
function pf_validation_modification_fin(vv_stream){
	alert(vv_stream);
}
function pf_validation_suite(){
	var s="";
  if (!vf_b_validation_possible) {
    alert("$vl_c_bok_159js");
    fa_att_set("bt_enregistrer","label","$vl_c_bok_101");
		fa_gid("html_qui_grise").style.display = "none";
    fa_bgc("bt_enregistrer",'init');
    fa_grise_non("bt_enregistrer");
    return;
  }
  fa_grise_fenetre("","oui");
  fa_gid("bt_enregistrer").label="$vl_c_bok_114"+' (2/2)';
	{
	var count=fa_cl("arb_destinataires");
	  var x, item1,tab_a;
	  var vl_t_nom=[];
	  var vl_t_courriel=[];
	  var vl_t_intweb=[];
	  var vl_t_int=[];
	  var vl_t_patronyme=[];
	  var vl_t_prenom=[];
	  var vl_t_civilite=[];
	  if (count!=0) {
    for(x=0;x<count;x++) {
    		if (fa_value_get("tb_remplacement_noms")=="") {
				vl_t_nom[x]=window.btoa(fa_enc(fa_cell_get("arb_destinataires",x,"arb_dest_nompreno")));
			} else {
				vl_t_nom[x]=window.btoa(fa_enc(fa_value_get("tb_remplacement_noms")));
			}
      vl_t_intweb[x]=fa_cell_get("arb_destinataires",x,"arb_dest_intweb_cleunik");
      vl_t_courriel[x]=fa_cell_get("arb_destinataires",x,"arb_dest_courriel");
      vl_t_int[x]=fa_cell_get("arb_destinataires",x,"arb_dest_int_cleunik");
		vl_t_civilite[x]=fa_cell_get("arb_destinataires",x,"arb_dest_civilite");
		vl_t_prenom[x]=fa_cell_get("arb_destinataires",x,"arb_dest_prenom");
		vl_t_patronyme[x]=fa_cell_get("arb_destinataires",x,"arb_dest_nom");
    }
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_01",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_nom)),'');
	  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_02",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_courriel)),'');
	  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_03",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_intweb)),'');
	  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_04",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_int)),'');
	  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_05",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_civilite)),'');
	  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_06",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_prenom)),'');
	  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_07",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_patronyme)),'');
  	}

	}
  fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_14",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vf_t_cleunik)),'');
  s+="vl_c_variable_requete="+vf_c_variable_requete+"&";
  s+="vl_c_sujet="+fa_enc(fa_value_get("tb_sujet"))+"&";
  s+="vl_e_sendmail_from="+fa_enc(fa_mlget("ml_emetteur","_graal_cleunik"))+"&";
  s+="vl_c_id="+fa_enc("?")+"&";
  s+="vl_c_type_envoi="+fa_enc(fa_value_get("rdg_unpardestinataire"))+"&";
  s+="vl_c_type_action="+fa_enc(fa_value_get("rdg_uneactionpardestinataire"))+"&";
  s+="vl_c_priorite="+fa_enc(fa_value_get("rdg_priorite"))+"&";
  s+="vl_c_sensitivity="+fa_enc(fa_value_get("rdg_sensitivite"))+"&";
  s+="vl_c_integre_pj_sipossible="+fa_enc(fa_value_get("rdg_integre_pj_sipossible"))+"&";
  s+="vl_c_confirmation_lecture="+fa_enc(fa_value_get("rdg_confirmation_lecture"))+"&";
	s+="vl_c_affichernom="+fa_enc(fa_value_get("rdg_affichernom"))+"&";
	s+="vl_c_remplacement_noms="+fa_enc(fa_value_get("tb_remplacement_noms"))+"&";
  s+="raf="+Math.random()+"&";
  s+="vl_c_genre=$vl_c_genre&";
	s+="vl_c_references="+fa_enc(fa_value_get("tb_c_uuid"))+"&";

END;
  switch ($vl_c_type_courriel) {
    case "texte":
      echo('s+="vl_c_message="+fa_enc(fa_gid("tb_message").value)+"&";s+="vl_c_type_courriel=1&";');
      break;
    case "html":
      echo('s+="vl_c_message="+fa_enc(fa_gid("content").contentWindow.document.documentElement.innerHTML)+"&";s+="vl_c_type_courriel=2&";s+="vl_c_message_texte="+fa_enc(fa_value_get("tb_message_texte"))+"&";');
      break;
  }
  switch ($vl_c_genre) {
    case "continuer":
      echo('s+="vl_e_action_cleunik='.$vl_e_action_cleunik.'"+"&";');
      break;
    case "normal":
      break;
  }
echo <<<END
  fa_xmlhttprequest_txt(vf_c_script_envoie_courriel,s,pf_validation_fin);
}
function pf_verif_deja_intweb(vl_intweb){
  var nombre=vf_t_intweb.length;
  for(x = 0; x < nombre; x++) {
    if (vl_intweb==vf_t_intweb[x]) {return false;}
  }
  return true;
}
function pf_verif_deja_refweb(vl_refweb){
  var nombre=vf_t_courriel.length;
  for(x = 0; x < nombre; x++) {
    if (vl_refweb==vf_t_courriel[x]) {return false;}
  }
  return true;
}
]]></script>
END;
?>
