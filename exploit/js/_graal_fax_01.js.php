<?php
$var_rc='\r\n';
$var_0d='\n';
$rExp ="\x0d\x0a";
$vl_c_init="";
if ($vl_e_intel_cleunik!=-1) {
	$vl_c_init.="fa_focusdonne('tb_sujet');vf_c_liste_en_cours='li_dest_a';fa_xmlhttprequest_xml(vf_c_script_edite_intel+$vl_e_intel_cleunik,'',pf_sel_fax_fin);";
}
switch ($vl_doc_cleunik){
	case -99999:
		break;
	default:
		$vl_c_init.=<<<EOT
		var t=[];t[0]=$vl_doc_cleunik;
		var n=[];n[0]='$vl_c_nomdoc';
		pf_retour_fenetre_pj(t,n);
EOT;
		break;
}
$vl_c_bak_155js=fa_recup_dico_js("bak_155");
$vl_c_bak_156js=fa_recup_dico_js("bak_156");
echo <<<END
<script type="application/x-javascript"><![CDATA[
/*
*********************************************************************
**********  Fenêtre de gestion de la création des fax  ********
*********************************************************************
*/
var vf_c_script_edite_note='_graal_bdope_note_03.php';
const vf_c_script_edite='_graal_xml_modeles_courriels_01.php';
const vf_c_script_intweb='_graal_xml_modeles_courriels_01.php';
const vf_c_script_das_fax="_graal_das_fax_01.php?";
const vf_c_script_edite_intel='_graal_xml_act_interlo_fax_02.php?vl_e_intel_cleunik=';
const c_fen_panier_intel='_graal_fen_rech_fax_01.php?p02=$vl_c_id_fenetre&genreacteur=';
const c_script_var='_graal_cree_variable_session_tempo.php?';
const c_script_hash_doc='_graal_bdope_pj_hash_01.php?vf_c_hash=';
const c_upload_pj="_graal_upload_pj.php?";
const c_script_envoie_fax="_graal_exe_fax_envoie.php?vl_c_type_fax=$vl_c_type_fax&";
const c_fen_panier_pj="_graal_fen_rech_piecesjointes_01.php?type=select&";
const c_fen_selection_notes="_graal_fen_ged_01.php?genreged=tousss&quelsdocs=notes&retour=oui&";
const c_fen_selection_docs="_graal_fen_ged_01.php?genreged=tousss&quelsdocs=docs&retour=oui&selection=oui&";
var vf_c_liste_en_cours="",vf_indice_liste_pj=0,vf_b_suite=false,vf_b_validation_possible=false;
var vf_c_tableau_retour="";
var vf_nombre_pj=0,vf_t_cleunik=[],vf_nombre_pj_lues=0,vf_ligne_pj_a_lire=0;
var vf_c_bak_145="$vl_c_bak_145"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_146="$vl_c_bak_146"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_147="$vl_c_bak_147"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_148="$vl_c_bak_148"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_149="$vl_c_bak_149"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_150="$vl_c_bak_150"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_151="$vl_c_bak_151"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_bak_152="$vl_c_bak_152"; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_references=""; //  utilisé dans _graal_courriel_01_complement.js
var vf_c_genre="$vl_c_genre";//  utilisé dans _graal_courriel_01_complement.js
var vf_c_sujet_ini="$vl_sujet_ini";//  utilisé dans _graal_courriel_01_complement.js
var vf_c_from="$vl_from";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_emimail_renvoi="_graal_xml_emimail_01.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_recmail_transfert="_graal_xml_recmail_01.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_html_renvoi="_graal_xml_emimail_02.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_text_renvoi="_graal_xml_emimail_03.php?action_cleunik=$vl_e_action_cleunik";//  utilisé dans _graal_courriel_01_complement.js
const c_script_edite_html_reponse="_graal_xml_recmail_02.php?action_cleunik=$vl_e_action_cleunik&sortie=src&";//  utilisé dans _graal_courriel_01_complement.js
function pf_affiche_datas(stream){
  var vl_c_datas = stream;
  var vl_c_chaine=fa_xml_get(vl_c_datas,'blocnote_riche');
  var vl_c_sortie=vl_c_chaine.replace(/<br>/g, "$var_rc");
  vl_c_sortie=vl_c_sortie.replace(/#date#/g,fa05_dates_en_clair("date"));
  vl_c_sortie=vl_c_sortie.replace(/#heure#/g,fa05_dates_en_clair("heure"));
  vl_c_sortie=vl_c_sortie.replace(/#dateheure#/g,fa05_dates_en_clair("dateheure"));
  fa_value_set("tb_message",vl_c_sortie);
}
function pf_alimente_defaut(){
  fa_value_set("tb_sujet","$vl_sujet");
  switch ("$vl_c_type_fax") {
    case "texte":
      //pf_complement_01_texte();//  Dans _graal_courriel_01_complement.js
      break;
    case "doc":
      break;
  }
}
function pf_destinataires(){
  { //  Traitement des destinataires simples
    var listbox = fa_gid("li_dest_a");
    var count = listbox.getRowCount();
    var x, item1,tab_a;
    var vl_t_nom=[];
    var vl_t_courriel=[];
    var vl_t_intweb=[];
    var vl_t_int=[];
    for(x = 0; x < count; x++) {
      item1 = listbox.getItemAtIndex(x)
      vl_t_nom[x]=window.btoa(fa_enc(item1.childNodes[1].getAttribute('label')));
      vl_t_courriel[x]=item1.childNodes[0].getAttribute('label');
      vl_t_intweb[x]=item1.childNodes[1].getAttribute('intweb_cleunik');
      vl_t_int[x]=item1.childNodes[0].getAttribute('int_cleunik');
    }   
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_01",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_nom)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_02",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_courriel)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_03",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_intweb)),'');
    fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_courriel_04",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vl_t_int)),'');
  }
}
function pf_etat_fen(vv_quoi){
  switch(vv_quoi) {
    case "ini":
      fa_att_set("dest_a","autosuggestsearch",vf_c_script_das_fax);
      fa_grise_oui("ra_integre_pj_sipossible_1");
      fa_grise_oui("ra_integre_pj_sipossible_2");
      pf_alimente_defaut();
      fa_focusdonne('dest_a');
      //pf_complement_02();//  Dans _graal_courriel_01_complement.js
      $vl_c_init  
	switch ("$vl_c_type_fax") {
		case "texte":
    		break;
  		case "doc":
    		break;
	}
      break;
    case "annuler":
			window.location=document.location;
      pf_raz_fiche();
      pf_alimente_defaut();
      break;
    case "sortir":
      window.close();
      break;   
  }
}
function pf_onunload(){}
function pf_ouvre_fichier(vv_quoi){
  switch (vv_quoi) {
    case 'disque' :
      var vl_c_nomfic=fa03_sel_fichier("","");
      fa_value_set("tb_emplacement",vl_c_nomfic)
      var vl_c_hash=fa03_fichier_sha1(vl_c_nomfic);
      fa_xmlhttprequest_txt(c_script_hash_doc+fa_enc(vl_c_hash),'',pf_ouvre_fichier_fin);
      break;
    case 'ged':
      fa_ouvre(c_fen_selection_docs);      
      break;
  }
}
function pf_ouvre_fichier_fin(stream){
  var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  var row = document.createElement('listitem');
  var cell = document.createElement('listcell');
  cell.setAttribute('label', fa_value_get("tb_emplacement"));
  cell.setAttribute('_graal_fichier', tableau_retour[0]);
  cell.setAttribute('_graal_cleunik', tableau_retour[1]);
  row.appendChild( cell );
  fa_gid("li_pj").appendChild( row );
  fa_value_set("tb_emplacement","");
}
function pf_ouvre_panier_fax() {
  var vl_e_cleunik=-1;
  vf_c_liste_en_cours="li_dest_a";
  fa_ouvre(c_fen_panier_intel+"tousss&",800,800);
}
function pf_ouvre_panier_courriel_retour() {
  var vl_t_tableau=vf_c_tableau_retour;
  fa_xmlhttprequest_xml(vf_c_script_edite_intel+vl_t_tableau,"&raf="+Math.random()+"&",pf_sel_fax_fin);
}
function pf_ouvre_panier_pj() {
  fa_ouvre(c_fen_panier_pj,600,400);
}
function pf_ouvre_selection_note() {
  fa_ouvre(c_fen_selection_notes);
}
function pf_raf(){
	alert("$vl_c_bak_155js");
}
function pf_raz_fiche(){}
function pf_retour_fenetre_fax(vl_e_cleunik) {
  alert(vl_e_cleunik)
  fa_xmlhttprequest_xml(vf_c_script_edite_intel+vl_e_cleunik,"",pf_sel_fax_fin);
}
function pf_retour_fenetre_docs(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', vv_t_tableau_nom[i]);
      cell.setAttribute('_graal_fichier', 2);
      cell.setAttribute('_graal_cleunik', vv_t_tableau_cleunik[i]);
      row.appendChild( cell );
      fa_gid("li_pj").appendChild( row );
    }
  }
}
function pf_retour_fenetre_notes(vv_t_tableau_cleunik) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      pf_top_model(vv_t_tableau_cleunik[i]);
    }
  }
}
function pf_retour_fenetre_pj(vv_t_tableau_cleunik,vv_t_tableau_nom) {
  vl_e_nb_sel=vv_t_tableau_cleunik.length;
  if (vl_e_nb_sel!=0) {
    for(i=0;i<vl_e_nb_sel;i++) {
      var row = document.createElement('listitem');
      var cell = document.createElement('listcell');
      cell.setAttribute('label', vv_t_tableau_nom[i]);
      cell.setAttribute('_graal_fichier', 1);
      cell.setAttribute('_graal_cleunik', vv_t_tableau_cleunik[i]);
      row.appendChild( cell );
      fa_gid("li_pj").appendChild( row );
    }
  }
}
function pf_sel_fax(){
	var vl_e_cleunik=-1;
	vf_c_liste_en_cours="li_dest_a";
	vl_e_cleunik=fa_att_get('dest_a','_graal_cleunik');
	fa_xmlhttprequest_xml(vf_c_script_edite_intel+vl_e_cleunik,"",pf_sel_fax_fin);
}
function pf_sel_fax_fin(stream) {
  var vl_c_datas = stream;
  var vl_e_nombre=fa_xml_get(vl_c_datas,'nombre');
  for (i=1; i<=vl_e_nombre; i++){
  	try {
  		fa_value_set('tb_fax_destinataire',fa_xml_get(vl_c_datas,'recherche_'+i));
		fa_att_set('tb_fax_destinataire','_graal_intel_cleunik',fa_xml_get(vl_c_datas,'intel_cleunik_'+i));
  	} catch (e) {
  	}
  }
}
function pf_supprime_ligne(vv_qui) {
  var listbox = fa_gid(vv_qui);
  var x=fa_cui(vv_qui);if (x==-1) {return;}
  listbox.removeItemAt(x); 
}
function pf_top_model(vv_quoi){
	if (vv_quoi!="") {
		var vv_qui=vv_quoi;
	} else {
		var vv_qui=fa_mlget("ml_modeles");
		var vl_c_affiche_sujet=fa_mlget("ml_modeles","_graal_origine");
		if (vl_c_affiche_sujet==1) {
			var vl_c_sujet=fa_mlget("ml_modeles","_graal_sujet");
			if (fa_se(vl_c_sujet)!="") {
				fa_value_set("tb_sujet",vl_c_sujet);
			}
		}
	}
END;
switch ($vl_c_type_fax) {
  case "texte":
echo <<<END
  s ="vl_e_modele="+vv_qui+"&";
  fa_xmlhttprequest_xml(vf_c_script_edite,s,pf_affiche_datas);
END;
  break;
  case "html" :
echo <<<END
  fa_att_set("content","onload","fa_gid('content').contentDocument.designMode='on';pf_complement_model();");
  fa_att_set("content","src",vf_c_script_edite_note+'?doc_cleunik='+vv_qui);
END;
  break;
}
echo <<<END
}
function pf_upload_pj(vv_quelle_ligne) {
	var item1 = fa_gid("li_pj").getItemAtIndex(vv_quelle_ligne);
	var vl_graal_fichier=parseInt(item1.childNodes[0].getAttribute('_graal_fichier'));
	var vl_graal_cleunik=parseInt(item1.childNodes[0].getAttribute('_graal_cleunik'));
	var vl_c_nomfic=item1.childNodes[0].getAttribute('label');
 	vf_nombre_pj_lues++;
  if (vl_graal_fichier==0) {
		fa03_fichier_lit_et_envoie(c_upload_pj,pf_upload_pj_suite,vl_c_nomfic);
	} else {
		vf_t_cleunik.push(vl_graal_cleunik);
		pf_upload_pj_suite(-1);
	}
}
function pf_upload_pj_suite(vv_data) {
	switch (vv_data) {
		case -1:
			break;
		default:
			vf_t_cleunik.push(vv_data);
	}
	if (vf_nombre_pj_lues!=vf_nombre_pj) {
		vf_ligne_pj_a_lire++;
		pf_upload_pj(vf_ligne_pj_a_lire);
	} else {
		pf_validation_suite();
	}
}
function pf_validation(){
	if (fa_att_get('tb_fax_destinataire',"_graal_intel_cleunik")=="") {alert("Il n'y a pas de destinataire !!");return;}
	switch ("$vl_c_type_fax") {
    case "texte":
      if (fa_value_get("tb_message")=="") {
      	alert("Il n'y a pas de message. Ce fax n'a pas de sens...");
		fa_focusdonne("tb_message");
		return;
		}
		var s="vl_c_message="+fa_enc(fa_value_get("tb_message"))+"&";
  		s+="vl_c_sujet="+fa_enc(fa_value_get("tb_sujet"))+"&";
		s+="vl_e_compte="+fa_mlget("ml_emetteur")+"&";
		s+="vl_e_intel_cleunik="+fa_att_get('tb_fax_destinataire','_graal_intel_cleunik')+"&";
		fa_grise_fenetre("","oui");
		fa_xmlhttprequest_txt(c_script_envoie_fax,s,pf_validation_fin);
      break;
    case "doc":
		vf_b_validation_possible=true;
		vf_nombre_pj=fa_gid("li_pj").getRowCount();
		vf_t_cleunik=[];
		vf_nombre_pj_lues=0;
		vf_ligne_pj_a_lire=0;
		if (vf_nombre_pj!=0) {
			fa_grise_fenetre("","oui");
			pf_upload_pj(vf_ligne_pj_a_lire);
		} else {
			return;
		}
      break;
  }
  
}
function pf_validation_fin(stream){
  alert(stream);
  fa_grise_fenetre("","non");
}
function pf_validation_suite(){
  var s="";
  if (!vf_b_validation_possible) {
    alert("L'enregistrement d'une ou des pièce(s) jointe(s) a échoué. Le fax n'est pas envoyé.");
    return;
  }
  	fa_xmlhttprequest_txt_sync(c_script_var+"var=vs_tempo_fax_01",'vl_t_listecles='+fa_enc(fa_jsarray2php_00(vf_t_cleunik)),'');
	s+="vl_e_compte="+fa_mlget("ml_emetteur")+"&";
	s+="vl_e_intel_cleunik="+fa_att_get('tb_fax_destinataire','_graal_intel_cleunik')+"&";
	s+="vl_c_sujet="+fa_enc(fa_value_get("tb_sujet"))+"&";
	fa_xmlhttprequest_txt(c_script_envoie_fax,s,pf_validation_fin);
}
]]></script>
END;
?>
