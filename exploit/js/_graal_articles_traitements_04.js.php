<?php
include("_graal_var_portee.php");
$vl_c_bvg_103js=fa_recup_dico_js("bvg_103");
echo <<<END
<script type="application/x-javascript"><![CDATA[
var vf_selection_encours=false;var vf_c_url_alimente_table="";
const c_script_bdope_fen="_graal_bdope_traitements_articles_03.php";
const c_script_lecture_csv="_graal_import_tarif_ventes_01.php?";
const c_script_import_lambda_01="_graal_das_import_lambda_02.php?id=";

const lstn_grise_articles= { 
	willRebuild : function(event){},
	didRebuild  : function(event){fa_grise_fenetre("","non");} 
	};
function pf_aa_init() {
  fa_ael('bbo_ml_qui','ValueChange',po_change_menu);
  po_change_menu();
  fa_badl("arbre_tarif_type_vente",lstn_grise_articles);
  fa_cache_non("tc_code_article_tarif_type_vente");
  fa_cache_non("tc_description_article_tarif_type_vente");
}
function pf_aa_ferme(){
}
function pf_alimente_table(vl_c_url_alimente_table){
	vf_c_url_alimente_table=vl_c_url_alimente_table;
	fa_grise_fenetre("","oui");
	fa_das("arbre_tarif_type_vente",vl_c_url_alimente_table);
}
function pf_clavier(e,vv_objet) {
	try {
		switch(e.keyCode){
      case 13: // 'Enter'	//	Surtout pas enter !!!
      case 9: // 'Tab'
      case 40: // 'flèche basse'
      pf_ligne_suivante(vv_objet);
      	break;
      case 38:	//	flèche précédente
        pf_ligne_précedente(vv_objet)
        break;
      default:
        break;
    }
 	} catch (e) {
    alert("erreur"+e)
  }
}
function pf_deselectionne_choix_tous_tarifs(){
	var k=fa_gid("ml_tarif").selectedIndex;
	fa_gid("ml_tarif").selectedIndex=0;
	fa_gid("ml_tarif").selectedItem.removeAttribute("checked");
	fa_gid("ml_tarif").selectedIndex=k;
}
function pf_export_excel_01(){
	var vl_c_nom_fichier_xls=prompt("Nom du fichier","essai.xls");
	var vl_c_url="";
	vl_c_url=vf_c_url_alimente_table;
	vl_c_url+='&sortie=excel_01';
	vl_c_url+="&vl_c_nom_fichier_xls="+fa_enc(vl_c_nom_fichier_xls)+"&";
	fa_ouvre(vl_c_url);
}
function pf_ligne_suivante(vv_objet){
var vl_e_nb=fa_gid(vv_objet).view.rowCount;
  var rowIndex = fa_gid(vv_objet).currentIndex;
  if(rowIndex == -1){return;}
  if (vl_e_nb-1<=rowIndex){
  	fa_gid(vv_objet).view.selection.select(rowIndex);
	fa_gid(vv_objet).startEditing(rowIndex,fa_gid(vv_objet).columns.getNamedColumn("tc_nouveau_tarif_type_vente"));
  	return;
  }
  rowIndex++;
  fa_gid(vv_objet).view.selection.select(rowIndex)
	fa_gid(vv_objet).startEditing(rowIndex,fa_gid(vv_objet).columns.getNamedColumn("tc_nouveau_tarif_type_vente"));
}
function pf_ligne_précedente(vv_objet){
var vl_e_nb=fa_gid(vv_objet).view.rowCount;
  var rowIndex = fa_gid(vv_objet).currentIndex;
  if(rowIndex == -1){return;}
  if (rowIndex == 0){
  	fa_gid(vv_objet).view.selection.select(0);
	fa_gid(vv_objet).startEditing(0,fa_gid(vv_objet).columns.getNamedColumn("tc_nouveau_tarif_type_vente"));
  	return;
  }
  rowIndex--;
  fa_gid(vv_objet).view.selection.select(rowIndex);
	fa_gid(vv_objet).startEditing(rowIndex,fa_gid(vv_objet).columns.getNamedColumn("tc_nouveau_tarif_type_vente"));
}
function pf_ouvre_csv(){
	var vl_c_filtre00="Fichiers CSV";
    var vl_c_filtre01="*.csv";
    var vl_c_fichier=fa03_sel_fichier(vl_c_filtre00,vl_c_filtre01);
    if (vl_c_fichier!='' ) {
    	vf_c_sha1=fa03_fichier_sha1(vl_c_fichier);
    	fa_grise_fenetre('','oui');
    	fa03_fichier_lit_et_envoie(c_script_lecture_csv+"separateur="+fa_value_get("ml_separateur")+"&raf="+Math.random()+"&",pf_ouvre_csv_suite,vl_c_fichier);
    }
}
function pf_ouvre_csv_suite(stream){
var vl_c_datas = stream;
  var tableau_retour=vl_c_datas.split('|');
  if (tableau_retour[0]=='-1') {alert(tableau_retour[1]);fa_grise_fenetre('','non');return;}
  fa_grise_fenetre("","oui");
  fa_das("arbre_tarif_type_vente",c_script_import_lambda_01+tableau_retour[0]);
}
function pf_saisie(){
	switch (vf_selection_encours){
		case false:
			var vl_e_nb=0;
			try {
    			vl_e_nb=fa_gid("arbre_tarif_type_vente").view.rowCount;
	  			if (vl_e_nb==0) {return;}
		  	}  catch (e) {
				return;
			}
			fa_cache_oui("vb_selection");
			fa_cache_oui("bt_ouvre_csv");
			fa_cache_oui("ml_separateur");
			fa_cache_non("bt_validation");
			fa_cache_non("tc_nouveau_tarif_type_vente");
			fa_att_set("arbre_tarif_type_vente","editable","true");
			fa_att_set("tc_nouveau_tarif_type_vente","editable","true");
			fa_att_set("arbre_tarif_type_vente","onkeyup","pf_clavier(event,this.id);");
			vf_selection_encours=true;
			break;
		case true:
			fa_cache_oui("bt_validation");
			fa_cache_non("bt_ouvre_csv");
			fa_cache_non("vb_selection");
			fa_cache_non("ml_separateur");
			fa_cache_oui("tc_nouveau_tarif_type_vente");
			fa_att_set("tc_nouveau_tarif_type_vente","editable","false");
			fa_att_set("arbre_tarif_type_vente","editable","false");
			fa_att_set("arbre_tarif_type_vente","onkeyup","");
			vf_selection_encours=false;
			break;
	}
}
function pf_validation(vv_arbre){
	var vl_e_nb=fa_gid("arbre_tarif_type_vente").view.rowCount;
  var vl_t_tar_cleunik=[];
  var vl_t_tarif=[];
  var vl_pu="";
  if (vl_e_nb!=0) {
  	vl_e_j=-1;
    for(i=0;i<vl_e_nb;i++) {
    	vl_pu=fa_cell_get("arbre_tarif_type_vente",i,"tc_nouveau_tarif_type_vente");
    	if (vl_pu!=""){
    		vl_pu=parseFloat(vl_pu);
    		//alert(vl_pu)
    		if (isNaN(vl_pu)==false){
    			vl_e_j++;
    			vl_t_tar_cleunik[vl_e_j]=fa_cell_get("arbre_tarif_type_vente",i,"tc_tar_cleunik_type_vente");
    			vl_t_tarif[vl_e_j]=vl_pu;
    		}
    	}
    }
  }
  if (vl_t_tar_cleunik.length==0) {alert("Rien n'a été mis à jour !");return;}
  //alert(vl_t_tarif)
  if(!confirm("$vl_c_bvg_103js")) {return;}
  var vl_c_donnees="vf_c_action=kilometres_majtarif&";
  vl_c_donnees+="vl_t_tar_cleunik="+fa_enc(fa_jsarray2php_00(vl_t_tar_cleunik))+"&";
  vl_c_donnees+="vl_t_tarif="+fa_enc(fa_jsarray2php_00(vl_t_tarif))+"&";
  //alert(vl_c_donnees)
  fa_xmlhttprequest_txt(c_script_bdope_fen,vl_c_donnees,pf_validation_fin);
} 
function pf_validation_fin(stream) {
  var vl_datas = stream;
  alert(vl_datas);
  pf_alimente_table(vl_c_url_alimente_table);
}
]]></script>
END;
?>
