<?php
$var_rc='\r\n';
echo <<<END
<script type="application/x-javascript"><![CDATA[
const BOUNDARY = "xofxonxof"; //ce qui va nous servir de délimiteur
const MULTI    = "@mozilla.org/io/multiplex-input-stream;1";
const FINPUT   = "@mozilla.org/network/file-input-stream;1";
const STRINGIS = "@mozilla.org/io/string-input-stream;1";
const BUFFERED = "@mozilla.org/network/buffered-input-stream;1";
const SINSTREAM ='@mozilla.org/scriptableinputstream;1';
const XPC      = "UniversalXPConnect";
const FP       = "@mozilla.org/filepicker;1";
const FL       = "@mozilla.org/file/local;1"; 
const MIME     = "@mozilla.org/mime;1";
const HASH     = "@mozilla.org/security/hash;1";
const nsIMultiplexInputStream = Components.interfaces.nsIMultiplexInputStream;
const nsIFileInputStream      = Components.interfaces.nsIFileInputStream;
const nsIStringInputStream    = Components.interfaces.nsIStringInputStream;
const nsIBufferedInputStream  = Components.interfaces.nsIBufferedInputStream;
const nsIFilePicker           = Components.interfaces.nsIFilePicker;
const nsiLocalFile            = Components.interfaces.nsILocalFile;
const nsICryptoHash           = Components.interfaces.nsICryptoHash;
const nsIMIMEService          = Components.interfaces.nsIMIMEService;
const nsIScriptableInputStream= Components.interfaces.nsIScriptableInputStream;
const sl="$var_rc";

function fa03_fichier_choisi_lit_et_envoie(vv_script,vv_callback) {
  try {
  	netscape.security.PrivilegeManager.enablePrivilege(XPC);
  } catch (e) {
  	alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
  	return null;
  }
  //  Piqué ici : http://xulfr.org/wiki/ApplisWeb/Request
  var fp = Components.classes[FP].createInstance(nsIFilePicker);
  fp.init(window, "Sélectionnez un fichier", nsIFilePicker.modeOpen);
  var res = fp.show();
  var mis = Components.classes[MULTI].createInstance(nsIMultiplexInputStream);
  var fin = Components.classes[FINPUT].createInstance(nsIFileInputStream);
  //fin.init(fp.file, 0x01, 0444, null);
  // voir ici http://www.developpez.net/forums/d306902/webmasters-developpement-web/autres-langages-web/xul-fichier-uploade-restant-ouvert/#post4506000
  fin.init(fp.file, 0x01, 0444,Components.interfaces.nsIFileInputStream.CLOSE_ON_EOF);
  var buf = Components.classes[BUFFERED].createInstance(nsIBufferedInputStream);
  buf.init(fin, 4096);
  var hsis = Components.classes[STRINGIS].createInstance(nsIStringInputStream);
  var vl_c_disp00='Content-disposition: form-data;name="addfile"'+sl+sl;
  var vl_c_disp01='Content-disposition: form-data;name="filename";filename="'+fp.file.leafName+"'"+sl;
  var typefromfile="";
  try {typefromfile=Components.classes[MIME].getService(nsIMIMEService).getTypeFromFile(file);} catch(e) {typefromfile="bizarre";}
  var vl_c_type='Content-Type: ' + typefromfile + sl+sl;
  var vl_c_leng="Content-Length: " + fp.file.fileSize+sl+sl;
  var sheader = new String();
  sheader +=sl;
  sheader += "--" + BOUNDARY +sl;
  sheader += vl_c_disp00;
  sheader +=sl+ "--" + BOUNDARY + sl;
  sheader += vl_c_disp01;
  sheader += vl_c_type; 
  sheader += vl_c_leng;
  hsis.setData(sheader, sheader.length);
  var endsis = Components.classes[STRINGIS].createInstance(nsIStringInputStream);
  var bs = new String(sl+"--" + BOUNDARY + "--"+sl);
  endsis.setData(bs, bs.length);
  mis.appendStream(hsis);
  mis.appendStream(buf);
  mis.appendStream(endsis);
  fin.close();
  var xmlr = new XMLHttpRequest();
  xmlr.open("POST", vv_script, true);
  xmlr.setRequestHeader("Content-Length", mis.length );
  xmlr.setRequestHeader("Content-Type", "multipart/form-data; boundary=" + BOUNDARY);
  xmlr.onreadystatechange=function() {if(xmlr.readyState==4) {if(vv_callback!=""){vv_callback(xmlr.responseText,xmlr.responseText.length);}}};
  xmlr.send(mis);
  alert("type -> "+vl_c_type+" longueur" + vl_c_leng);
  return 'ok';
}
function fa03_fichier_lit(vv_fichier) {
	// piqué ici : http://xulfr.org/forums/read.php?1,10667,10667#msg-10667
  var vl_c_nom_fichier="";
	var data= new String();
  try {
  	netscape.security.PrivilegeManager.enablePrivilege(XPC);
  } catch (e) {
  	alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
  	return null;
  }
  var file =  Components.classes[FL].createInstance(nsiLocalFile);
  file.initWithPath(vv_fichier);
  if ( file.exists() != true) {
    alert("Le fichier "+vv_fichier+" n'existe pas");
    return null;
  }
  vl_c_nom_fichier=file.leafName;
  var fin = Components.classes[FINPUT].createInstance(nsIFileInputStream);
  var buf = Components.classes[SINSTREAM].createInstance(nsIScriptableInputStream);
  //fin.init(file, 0x01, 0,false);
  // voir ici http://www.developpez.net/forums/d306902/webmasters-developpement-web/autres-langages-web/xul-fichier-uploade-restant-ouvert/#post4506000
  fin.init(file, 0x01, 0,Components.interfaces.nsIFileInputStream.CLOSE_ON_EOF);
  buf.init(fin);
	data += buf.read(-1);
	buf.close;
	fin.close;
  return data;
}
function fa03_fichier_lit_et_envoie(vv_script,vv_callback,vv_fichier) {
  var vl_c_nom_fichier="";
  try {
  	netscape.security.PrivilegeManager.enablePrivilege(XPC);
  } catch (e) {
  	alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
  	return null;
  }
  //  Piqué ici : http://xulfr.org/wiki/ApplisWeb/Request
  var file =  Components.classes[FL].createInstance(nsiLocalFile);
  file.initWithPath(vv_fichier);
  if ( file.exists() != true) {
    alert("Le fichier "+vv_fichier+" n'existe pas");
    return null;
  }
  vl_c_nom_fichier=file.leafName;
  var mis = Components.classes[MULTI].createInstance(nsIMultiplexInputStream);
  var fin = Components.classes[FINPUT].createInstance(nsIFileInputStream);
  //fin.init(file, 0x01, 0444, null);
  // voir ici http://www.developpez.net/forums/d306902/webmasters-developpement-web/autres-langages-web/xul-fichier-uploade-restant-ouvert/#post4506000
  fin.init(file, 0x01, 0444,Components.interfaces.nsIFileInputStream.CLOSE_ON_EOF);
  var hsis = Components.classes[STRINGIS].createInstance(nsIStringInputStream);
  var buf = Components.classes[BUFFERED].createInstance(nsIBufferedInputStream);
  var endsis = Components.classes[STRINGIS].createInstance(nsIStringInputStream);
  buf.init(fin, 4096);  
  var vl_c_disp00='Content-Disposition: form-data;name="addfile"'+sl+sl;
  var vl_c_disp01='Content-Disposition: form-data;name="filename";filename="'+vl_c_nom_fichier+'"'+sl;
  var typefromfile="";
  //try {typefromfile=Components.classes[MIME].getService(nsIMIMEService).getTypeFromFile(file);} catch(e) {alert(e);fa_gid("tb_descriptif_sommaire").value=e;typefromfile="bizarre";}
  //try {typefromfile=Components.classes[MIME].getService(nsIMIMEService).getTypeFromExtension(file);} catch(e) {alert(e);fa_gid("tb_descriptif_sommaire").value=e;typefromfile="bizarre";}
  try {typefromfile=Components.classes[MIME].getService(nsIMIMEService).getTypeFromFile(file);} catch(e) {typefromfile="bizarre";}
  var vl_c_type='Content-Type: ' + typefromfile + sl+sl;
  var sheader = new String();
  sheader += sl;
  sheader += "--" + BOUNDARY + sl;
  sheader += vl_c_disp00;
  sheader += sl + "--" + BOUNDARY + sl;
  sheader += vl_c_disp01;
  sheader += vl_c_type; 
  hsis.setData(sheader, sheader.length);
  var endsis = Components.classes[STRINGIS].createInstance(nsIStringInputStream);
  var bs = new String(sl+'--' + BOUNDARY + '--'+sl);
  endsis.setData(bs, bs.length);
  mis.appendStream(hsis);
  mis.appendStream(buf);
  mis.appendStream(endsis);
  var xmlr = new XMLHttpRequest();
  xmlr.open("POST", vv_script+"vl_c_nom_fichier="+fa_enc(vl_c_nom_fichier), true);
  xmlr.setRequestHeader("Content-Length", mis.length );
  xmlr.setRequestHeader("Content-Type", "multipart/form-data; boundary=" + BOUNDARY);
  xmlr.onreadystatechange=function() {if(xmlr.readyState==4) {if(vv_callback!=""){vv_callback(xmlr.responseText,xmlr.responseText.length);}}};
  //xmlr.onreadystatechange=function() {if(xmlr.readyState==4) {if(vv_callback!=""){alert(xmlr.responseText);vv_callback(xmlr.responseText,xmlr.responseText.length);}}};
  //xmlr.onreadystatechange=function() {if(xmlr.readyState==4) {if(vv_callback!=""){alert(xmlr.responseText);fin.close();vv_callback(xmlr.responseText,xmlr.responseText.length);}}};
  xmlr.send(mis);
  return 'ok';
}
function fa03_fichier_lit_et_ouvre(vv_fichier){
try {
  	netscape.security.PrivilegeManager.enablePrivilege(XPC);
  } catch (e) {
  	alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
  	return null;
  }
var ioService = Components.classes["@mozilla.org/network/io-service;1"].
  getService(Components.interfaces.nsIIOService);
var mimeService = Components.classes["@mozilla.org/mime;1"].
  getService(Components.interfaces.nsIMIMEService);
var binaryInputStream = Components.classes["@mozilla.org/binaryinputstream;1"].
  createInstance(Components.interfaces.nsIBinaryInputStream);
var uri =  Components.classes[FL].createInstance(nsiLocalFile);
  uri.initWithPath(vv_fichier);
  if ( uri.exists() != true) {
    alert("Le fichier "+vv_fichier+" n'existe pas");
    return null;
  }
try {typefromfile=Components.classes[MIME].getService(nsIMIMEService).getTypeFromFile(uri);} catch(e) {typefromfile="bizarre";}
  vl_c_nom_fichier=uri.leafName;
  var fin = Components.classes[FINPUT].createInstance(nsIFileInputStream);
  var buf = Components.classes[SINSTREAM].createInstance(nsIScriptableInputStream);
  //fin.init(file, 0x01, 0,false);
  // voir ici http://www.developpez.net/forums/d306902/webmasters-developpement-web/autres-langages-web/xul-fichier-uploade-restant-ouvert/#post4506000
  fin.init(uri, 0x01, 0,Components.interfaces.nsIFileInputStream.CLOSE_ON_EOF);
  var stream = Components.classes["@mozilla.org/binaryinputstream;1"]
                         .createInstance(Components.interfaces.nsIBinaryInputStream);
  stream.setInputStream(fin);  
  var binaryData = "";
  var readLength = stream.available();
  while (readLength != 0) {
    binaryData = binaryData + stream.readBytes(readLength);
    readLength = stream.available();
  }
  var encodeData = btoa(binaryData);
  fa_ouvre( "data:" + typefromfile + ";base64," + encodeData);
	stream.close();
}
function fa03_fichier_sha1(vv_fichier) {
// piqué ici : http://developer.mozilla.org/en/docs/nsICryptoHash 
  try {
  	netscape.security.PrivilegeManager.enablePrivilege(XPC);
  } catch (e) {
  	alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
  	return null;
  }
  var path = vv_fichier;
  var f = Components.classes[FL].createInstance(nsiLocalFile);
  f.initWithPath(path);
  var istream = Components.classes[FINPUT].createInstance(nsIFileInputStream);
  //istream.init(f, 0x01, 0444, 0);
  // voir ici http://www.developpez.net/forums/d306902/webmasters-developpement-web/autres-langages-web/xul-fichier-uploade-restant-ouvert/#post4506000
  istream.init(f, 0x01, 0444,Components.interfaces.nsIFileInputStream.CLOSE_ON_EOF);
  
  var ch = Components.classes[HASH].createInstance(nsICryptoHash);
  ch.init(ch.SHA1);
  const PR_UINT32_MAX = 0xffffffff;
  ch.updateFromStream(istream, PR_UINT32_MAX);
  var hash = ch.finish(false);
  var s = [fa03_toHexString(hash.charCodeAt(i)) for (i in hash)].join("");
  return s;
}
function fa03_toHexString(charCode) {
  return ("0" + charCode.toString(16)).slice(-2);
}
function fa03_sel_fichier(vv_filtre00,vv_filtre01){
	try {
		netscape.security.PrivilegeManager.enablePrivilege(XPC);
	} catch (e) {
		alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
	}
	var file = Components.classes[FL].createInstance(Components.interfaces.nsILocalFile);
  var fp = Components.classes[FP].createInstance(nsIFilePicker);
  fp.init(window, "Sélectionner un fichier", nsIFilePicker.modeOpen);
  switch (vv_filtre00) {
    case ""   : fp.appendFilters(nsIFilePicker.filterAll);break;
    case "-1" : fp.appendFilters(nsIFilePicker.filterImages);break;
    default   : fp.appendFilter(vv_filtre00,vv_filtre01);break;
  }
  var reponse = fp.show();
	if (reponse == nsIFilePicker.returnOK){
		return fp.file.path;
	} else {
    return "";
  }
}
function fa03_sel_fichiers_plusieurs(vv_filtre00,vv_filtre01) {
	try {
  	netscape.security.PrivilegeManager.enablePrivilege(XPC);
  } catch (e) {
  	alert("Vous n'avez pas l\'autorisation de lire des fichiers!!");
  	return null;
  }
  var fp = Components.classes[FP].createInstance(nsIFilePicker);
  fp.init(window, "Sélectionnez un fichier ou plusieurs fichiers", nsIFilePicker.modeOpenMultiple);
	switch (vv_filtre00) {
    case ""   : fp.appendFilters(nsIFilePicker.filterAll);break;
    case "-1" : fp.appendFilters(nsIFilePicker.filterImages);break;
    default   : fp.appendFilter(vv_filtre00,vv_filtre01);break;
  }
  var reponse = fp.show();
	if (reponse == nsIFilePicker.returnOK){
		var files = fp.files;
    var paths = [];
    while (files.hasMoreElements()) {
      var arg = files.getNext().QueryInterface(Components.interfaces.nsILocalFile).path;
      paths.push(arg);
    }
		return paths;
	} else {
    return "";
  }
}
]]></script>
END;
?>
