<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_mousto.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
include_once("_graal_fonctions_documents_ciaux.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_cial_ligne_01";
$t_origines_ok[1]="_graal_fen_cial_ligne_02";
$t_origines_ok[2]="_graal_traitements_lignes_actions_ciales_01";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??");
$genreaction=fa_recup_param("genreaction","??");
$action_cleunik=intval(fa_recup_param("action_cleunik",-1));
$commercial_cleunik=intval(fa_recup_param("commercial_cleunik",-1));
$commercial_ligne_cleunik=intval(fa_recup_param("commercial_ligne_cleunik",-1));
$act_cleunik=intval(fa_recup_param("act_cleunik",-1));
$ligne_cleunik=intval(fa_recup_param("ligne_cleunik",-1));
$art_cleunik=intval(fa_recup_param("art_cleunik",-1));
$pu=fa_floatval(fa_recup_param("pu",-1));
$pu_type=intval(fa_recup_param("pu_type",-1));
$nbdec_pu=intval(fa_recup_param("nbdec_pu",-1));
$tarif_cleunik=intval(fa_recup_param("tarif_cleunik",-1));
$remise_taux=fa_floatval(fa_recup_param("remise_taux",-1));
$remise_type=intval(fa_recup_param("remise_type",-1));
$remise_genr=intval(fa_recup_param("remise_genr",-1));
$blocnotebrut=fa_recup_param("blocnotebrut",-1);
$blocnoteriche=fa_recup_param("blocnotebrut",-1);
$devise=intval(fa_recup_param("devise",-1));
$remise_natu=intval(fa_recup_param("remise_natu",-1));
$typeligne=fa_recup_param("typeligne",-1);
$coef_facture=intval(fa_recup_param("coef_facture",-1));


$ligne_cleunik=intval(fa_recup_param("ligne_cleunik",-1));
$qte=fa_floatval(fa_recup_param("qte",-1));
$qte_avant=fa_floatval(fa_recup_param("qte_avant",0));
$qte_unite=intval(fa_recup_param("qte_unite",-1));
$qte_nbdec=intval(fa_recup_param("qte_nbdec",-1));
$dateheure_demande=fa_recup_param("dateheure_demande",-1);
$statut=intval(fa_recup_param("statut",-1));
$unite_condi=intval(fa_recup_param("unite_condi",-1));
$qte_condi=fa_floatval(fa_recup_param("qte_condi",-1));
$nb_stock_in_condi=fa_floatval(fa_recup_param("nb_stock_in_condi",-1));
$choix_depot=intval(fa_recup_param("choix_depot",-15));
if ($choix_depot==0){$choix_depot=-15;};
$choix_empla=intval(fa_recup_param("choix_empla",-16));
if ($choix_empla==0){$choix_empla=-16;};
$code=fa_recup_param("code","");
$ligne_qte_cleunik=intval(fa_recup_param("ligne_qte_cleunik",-1));
$mvt_cleunik=intval(fa_recup_param("mvt_cleunik",-1));

$code_acteur=fa_recup_param("code_acteur","");
$description_acteur=fa_recup_param("description_acteur","");
$type_gestion_doc=fa_recup_param('type_gestion_doc',3);
$dateheure_confirm=$dateheure_demande;

$ligne_qte_cleunik_source=intval(fa_recup_param("ligne_qte_cleunik_partielle",-1));
$commercial_ligne_cleunik_source=intval(fa_recup_param("commercial_ligne_cleunik_partielle",-1));
$ligne_qte_doc_origine=intval(fa_recup_param("ligne_qte_doc_origine",-1));

switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retcli":
  case "retfou":
  case "relfou":
    $fichier_entete="_".$genreaction."_entetes";
    $fichier="_".$genreaction."_lignes";
    $fichier_qte="_".$genreaction."_lignes_qte";
    break;
  case "avocli":
  case "avofin":	
    $fichier_entete="_avocli_entetes";
    $fichier="_avocli_lignes";
    $fichier_qte="_avocli_lignes_qte";
    break;
  case "avofou":
  case "avofif":	
    $fichier_entete="_avofou_entetes";
    $fichier="_avofou_lignes";
    $fichier_qte="_avofou_lignes_qte";
    break;
  default:
    exit;
    break;  //  Toutes les actions génériques
}
switch ($genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "avocli":
  case "avofin":
  case "retcli":
    $pc_cleunik="pc_cleunik_vente";
    break;
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
  case "retfou":
  case "relfou":
  case "avofou":
  case "avofif":
    $pc_cleunik="pc_cleunik_achat";
    break;
}

switch ($genreaction){
  case "offcli":
  case "cdecli":
    break;
  case "livcli":
    $vl_mousto_blocnotebrut="Expédition ";
    $vl_mousto_genre_mvt=-43;// Livraison client
    $vl_mousto_type_mvt=2;//  Sortie de stock
    $vl_coeff_mousto_qte_mvt=1;
    break;
  case "retcli":
    $vl_mousto_blocnotebrut="Retour client ";
    $vl_mousto_genre_mvt=-153;//Retour client
    $vl_mousto_type_mvt=2;//  Sortie de stock
    $vl_coeff_mousto_qte_mvt=-1;
    break;
  case "faccli":
    $vl_mousto_blocnotebrut="Facture ";
    $vl_mousto_genre_mvt=-44;// Facturation client
    $vl_mousto_type_mvt=2;//  Sortie de stock
    $vl_coeff_mousto_qte_mvt=1;
    break;
  case "avocli":
    $vl_mousto_blocnotebrut="Avoir ";
    $vl_mousto_genre_mvt=-129;// Avoir client
    $vl_mousto_type_mvt=2;//  Sortie de stock
    $vl_coeff_mousto_qte_mvt=-1;
    break;
  case "avofou":
    $vl_mousto_blocnotebrut="Avoir ";
    $vl_mousto_genre_mvt=-164;// Avoir fournisseur
    $vl_mousto_type_mvt=2;//  Sortie de stock
    $vl_coeff_mousto_qte_mvt=-1;
    break;
  case "avofin":
  case "avofif":	
  case "demfou":
  case "cdefou":
  case "relfou":
  	break;
  case "recfou":
  	$vl_mousto_blocnotebrut="Réception fournisseur ";
    $vl_mousto_genre_mvt=-42;//Réception fournisseur
    $vl_mousto_type_mvt=1;//  Entrée en stock
    $vl_coeff_mousto_qte_mvt=1;
    break;
  case "facfou":
  	$vl_mousto_blocnotebrut="Facture fournisseur ";
    $vl_mousto_genre_mvt=-155;//Facture fournisseur
    $vl_mousto_type_mvt=1;//  Entrée en stock
    $vl_coeff_mousto_qte_mvt=1;
  	break;
  case "retfou":
    $vl_mousto_blocnotebrut="Retour fournisseur ";
    $vl_mousto_genre_mvt=-152;//Retour fournisseur
    $vl_mousto_type_mvt=1;//  Entrée en stock
    $vl_coeff_mousto_qte_mvt=-1;
    break;
    
}
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM $fichier WHERE commercial_ligne_cleunik=$commercial_ligne_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if ($mvt_cleunik!=-1) {
      fa_mousto_supprime($mvt_cleunik);
    }
    switch ($genreaction){
	  case "livcli":
	  	$sql_req="UPDATE _cdecli_lignes_qte set qte_deja=qte_deja-$qte where commercial_ligne_cleunik=$ligne_qte_doc_origine;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
		$sql_req="UPDATE _cdecli_lignes_qte set statut=-38 where commercial_ligne_cleunik=$ligne_qte_doc_origine and qte>=qte_deja;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
	  	break;
	  case "recfou":
	   $sql_req="UPDATE _cdefou_lignes_qte set qte_deja=qte_deja-$qte where commercial_ligne_cleunik=$ligne_qte_doc_origine;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6bis|";}
		$toto=$sql_req;
		$sql_req="UPDATE _cdefou_lignes_qte set statut=-38 where commercial_ligne_cleunik=$ligne_qte_doc_origine and qte>=qte_deja;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
		break;     
	}     
    
    exit;
    break;
  case $vf_c_action=="ajouter":
  case $vf_c_action=="modifier":
  case $vf_c_action=="livcli_partielle":
  case $vf_c_action=="recfou_partielle":
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}
switch (TRUE){
  case $vf_c_action=="ajouter":
  case $vf_c_action=="modifier":
  	$ajout_doc_ligne_qte_cleunik="null";
	$ajout_mvt_cleunik="null";
  	break;
  case $vf_c_action=="livcli_partielle":
  case $vf_c_action=="recfou_partielle":
  	$ajout_doc_ligne_qte_cleunik=$ligne_qte_cleunik_source;
	$ajout_mvt_cleunik="null";
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}


switch (TRUE){
  case $vf_c_action=="ajouter":
  case $vf_c_action=="modifier":	//	on ne traite pas les informations comptables récupérées ici: on peut donc faire comme si
		$sql_req="SELECT a1.code as code_interne,a1.description as description_interne,a1.mnemotechnique as mnemotechnique_interne,a1.indice as indice_interne,
		a1.pr_generique as pr,a2.catcompta_cleunik as catcompta_cleunik,a2.$pc_cleunik as pc_cleunik,a2.taxes_cleunik,a3.poids_brut as poids_brut,a3.poids_net as poids_net,
		a1.types_gestion,a2.tpf_cleunik,a2.tpf_cleunik_01,a3.longueur,a3.largeur,a3.epaisseur,a3.unite_longueur 
		FROM _article a1 left join _art_compta a2 using (art_cleunik) left join _art_dimensions a3 using(art_cleunik) 
		where a1.art_cleunik=$art_cleunik and a2.catcompta_cleunik=(select catcompta_cleunik from $fichier_entete where commercial_cleunik=$commercial_cleunik);";
		$result = _graal_requete_bd($sql_req);
		//if (mysql_num_rows($result)==0) {echo "-1".$sql_req;exit();}
		if (mysql_num_rows($result)==0) {echo -1;exit();}
		$row = mysql_fetch_assoc($result);
		$poidsbrut=fa_nn($row['poids_brut']);
		$poidsnet=fa_nn($row['poids_net']);
		$pr=fa_nn($row['pr']);
		$code_interne=fa_nt($row['code_interne']);
		$indice_interne=fa_nt($row['indice_interne']);
		$mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
		$description_interne=fa_nt($row['description_interne']);
		$catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
		$pc_cleunik=fa_nn($row['pc_cleunik']);
		$taxes_cleunik=fa_nn($row['taxes_cleunik']);
		$vl_e_types_gestion=fa_nn($row['types_gestion']);
		$longueur=fa_nn($row['longueur']);
          $largeur=fa_nn($row['largeur']);
          $epaisseur=fa_nn($row['epaisseur']);
          $unite_longueur=fa_nn($row['unite_longueur']);
          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
		_graal_libere_requete_bd($result);
    break;
}
switch (TRUE){
  case $vf_c_action=="livcli_partielle":
  case $vf_c_action=="recfou_partielle":
  		switch ($commercial_ligne_cleunik_source){
  			case 0:
  				$sql_req="SELECT a1.code as code_interne,a1.description as description_interne,a1.mnemotechnique as mnemotechnique_interne,a1.indice as indice_interne,";
		$sql_req.=" a1.pr_generique as pr,a2.catcompta_cleunik as catcompta_cleunik,a2.$pc_cleunik as pc_cleunik,a2.taxes_cleunik,a3.poids_brut as poids_brut,a3.poids_net as poids_net,";
		$sql_req.=" a1.types_gestion,a2.tpf_cleunik,a2.tpf_cleunik_01,a3.longueur,a3.largeur,a3.epaisseur,a3.unite_longueur FROM _article a1 left join _art_compta a2 using (art_cleunik) left join _art_dimensions a3 using(art_cleunik) ";
		$sql_req.="  where a1.art_cleunik=$art_cleunik and a2.catcompta_cleunik=(select catcompta_cleunik from $fichier_entete where commercial_cleunik=$commercial_cleunik);";
  				break;
  			default:
  				switch (TRUE){
  					case $vf_c_action=="livcli_partielle":
  		$sql_req="SELECT f1.commercial_ligne_cleunik, f1.commercial_cleunik,f1.ligne_cleunik,f1.art_cleunik,f1.code_interne,f1.indice_interne,";
  		$sql_req.=" f1.mnemotechnique_interne,f1.description_interne,f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f1.typeligne,f1.pu,f1.pu_portee,f1.pu_type,";
  		$sql_req.=" f1.nbdec_pu,f1.tarif_cleunik,f1.remise_taux,f1.remise_type,f1.remise_genr,f1.poidsbrut,f1.tare, f1.poidsnet,f1.devise_taux,f1.pr,f1.blocnotebrut,f1.blocnoteriche,";
  		$sql_req.=" f1.devise,f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu,f1.coef_facture,f1.taxes_cleunik,f2.types_gestion,f3.gestion as gestion_dep_emp,f1.longueur,f1.largeur,";
  		$sql_req.=" f1.epaisseur,f1.unite_longueur,f1.tpf_cleunik,f1.tpf_cleunik_01 ";
  		$sql_req.=" from _cdecli_lignes f1  left join _article f2 using(art_cleunik) left join _art_stock f3 using(art_cleunik) where commercial_ligne_cleunik=$commercial_ligne_cleunik_source;";
  						break;
					case $vf_c_action=="recfou_partielle":
  				  		$sql_req="SELECT f1.commercial_ligne_cleunik, f1.commercial_cleunik,f1.ligne_cleunik,f1.art_cleunik,f1.code_interne,f1.indice_interne,";
  		$sql_req.=" f1.mnemotechnique_interne,f1.description_interne,f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f1.typeligne,f1.pu,f1.pu_portee,f1.pu_type,";
  		$sql_req.=" f1.nbdec_pu,f1.tarif_cleunik,f1.remise_taux,f1.remise_type,f1.remise_genr,f1.poidsbrut,f1.tare, f1.poidsnet,f1.devise_taux,f1.pr,f1.blocnotebrut,f1.blocnoteriche,";
  		$sql_req.=" f1.devise,f1.catcompta_cleunik,f1.pc_cleunik,f1.remise_natu,f1.coef_facture,f1.taxes_cleunik,f2.types_gestion,f3.gestion as gestion_dep_emp,f1.longueur,f1.largeur,";
  		$sql_req.=" f1.epaisseur,f1.unite_longueur,f1.tpf_cleunik,f1.tpf_cleunik_01 ";
  		$sql_req.=" from _cdefou_lignes f1  left join _article f2 using(art_cleunik) left join _art_stock f3 using(art_cleunik) where commercial_ligne_cleunik=$commercial_ligne_cleunik_source;";
  					break;
  				}
  		}
		$result = _graal_requete_bd($sql_req);
		//echo ($sql_req);
		//if (mysql_num_rows($result)==0) {echo "-1".$sql_req;exit();}
		if (mysql_num_rows($result)==0) {echo -1;exit();}
		$row = mysql_fetch_assoc($result);
		$poidsbrut=fa_nn($row['poids_brut']);
		$poidsnet=fa_nn($row['poids_net']);
		$pr=fa_nn($row['pr']);
		$code_interne=fa_nt($row['code_interne']);
		$indice_interne=fa_nt($row['indice_interne']);
		$mnemotechnique_interne=fa_nt($row['mnemotechnique_interne']);
		$description_interne=fa_nt($row['description_interne']);
		$catcompta_cleunik=fa_nn($row['catcompta_cleunik']);
		$pc_cleunik=fa_nn($row['pc_cleunik']);
		$taxes_cleunik=fa_nn($row['taxes_cleunik']);
		$vl_e_types_gestion=fa_nn($row['types_gestion']);
		$longueur=fa_nn($row['longueur']);
          $largeur=fa_nn($row['largeur']);
          $epaisseur=fa_nn($row['epaisseur']);
          $unite_longueur=fa_nn($row['unite_longueur']);
          $tpf_cleunik=fa_nn($row['tpf_cleunik']);
          $tpf_cleunik_01=fa_nn($row['tpf_cleunik_01']);
		_graal_libere_requete_bd($result);
    break;
}
$pu_portee=1;
$devise_taux=1;
$tare=0;
switch (TRUE){
  case $vf_c_action=="ajouter":
  case $vf_c_action=="livcli_partielle":
  case $vf_c_action=="recfou_partielle"://*******************************************************************************
		//  Début de la transaction
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    $commercial_ligne_cleunik=_graal_requete_max("commercial_ligne_cleunik","$fichier");    
    $sql_req ="INSERT INTO $fichier (commercial_ligne_cleunik,commercial_cleunik,ligne_cleunik,art_cleunik,code_interne,indice_interne,mnemotechnique_interne,";
	$sql_req.=" description_interne,typeligne,pu,pu_portee,pu_type,nbdec_pu,tarif_cleunik,remise_taux,remise_type,remise_genr,poidsbrut,tare,poidsnet,devise_taux,pr,blocnotebrut,";
	$sql_req.=" blocnoteriche,devise,code_acteur,description_acteur,catcompta_cleunik,pc_cleunik,remise_natu,coef_facture,taxes_cleunik, `longueur`, `largeur`, `epaisseur`, `unite_longueur`,"; 
	$sql_req.="  `tpf_cleunik`,tpf_cleunik_01)";
	$sql_req.=" VALUES ($commercial_ligne_cleunik,$commercial_cleunik,$ligne_cleunik,$art_cleunik,$code_interne,$indice_interne,$mnemotechnique_interne,$description_interne,";
	$sql_req.=" '$typeligne',$pu,$pu_portee,$pu_type,$nbdec_pu,$tarif_cleunik,$remise_taux,$remise_type,$remise_genr,$poidsbrut,$tare,$poidsnet,$devise_taux,$pr,'$blocnotebrut',";
	$sql_req.=" '$blocnoteriche',$devise,'$code_acteur','$description_acteur',$catcompta_cleunik,$pc_cleunik,$remise_natu,$coef_facture,$taxes_cleunik,$longueur,$largeur,$epaisseur,";
	$sql_req.=" $unite_longueur,$tpf_cleunik,$tpf_cleunik_01)";
	if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-1|$sql_req";}
	//	$vf_c_retour.="-1fake|$sql_req";
    $ligne_qte_cleunik=_graal_requete_max("ligne_qte_cleunik","$fichier_qte");
    switch ($genreaction){
      case "offcli":
      case "cdecli":
      case "demfou":
      case "cdefou":
      case "relfou":
			switch ($type_gestion_doc){
				case 1:
        $sql_req="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,
				statut,qte_deja)
				 VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,0);";
					break;
				case 2:
				case 3:
        $sql_req="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,
				statut,unite_condi,qte_condi,nb_stock_in_condi,choix_depot,choix_empla,qte_deja)
				 VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,$unite_condi,
				 $qte_condi,$nb_stock_in_condi,$choix_depot,$choix_empla,0);";
					break;
			}
				if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-2|$sql_req";}
        break;
      case "avofin":
				switch ($type_gestion_doc){
					case 1:
		        $sql_req="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,qte_deja) 
						VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,0);";
						if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-3|";}
						break;
					case 2:
					case 3:
		        $sql_req="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,
						unite_condi,qte_condi,nb_stock_in_condi,choix_depot,choix_empla,cdecli_ligne_qte_cleunik,mvt_cleunik,qte_deja) 
						VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,
						$unite_condi,$qte_condi,$nb_stock_in_condi,$choix_depot,$choix_empla,$ajout_doc_ligne_qte_cleunik,$ajout_mvt_cleunik,0)";
						if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-3|";}
						break;
				}
				break;
    			
      case "livcli":
      case "faccli":
      case "avocli":
      case "retcli":
				switch ($type_gestion_doc){
					case 1:
		        $sql_req  ="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,qte_deja)";
				$sql_req.=" VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,0);";
		       	if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-4|";}
						break;
					case 2:
					case 3:
		        $sql_req ="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,";
				$sql_req.=" unite_condi,qte_condi,nb_stock_in_condi,choix_depot,choix_empla,cdecli_ligne_qte_cleunik,mvt_cleunik,qte_deja)";
				$sql_req.=" VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,";
				$sql_req.=" $unite_condi,$qte_condi,$nb_stock_in_condi,$choix_depot,$choix_empla,$ajout_doc_ligne_qte_cleunik,$ajout_mvt_cleunik,0);";
		       	if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-4 bis|$sql_req";}
						break;
				}
				break;
	  case "recfou":
      case "facfou":
      case "retfou":
      case "avofou":
      case "avofif":
    	switch ($type_gestion_doc){
			case 1:
		        $sql_req  ="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,qte_deja)";
				$sql_req.=" VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,0);";
		       	if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-4|";}
						break;
			case 2:
			case 3:
		        $sql_req ="INSERT INTO $fichier_qte (commercial_ligne_cleunik,ligne_cleunik,ligne_qte_cleunik,qte,qte_unite,qte_nbdec,dateheure_demande,dateheure_confirm,statut,";
				$sql_req.=" unite_condi,qte_condi,nb_stock_in_condi,choix_depot,choix_empla,cdefou_ligne_qte_cleunik,mvt_cleunik,qte_deja)";
				$sql_req.=" VALUES ($commercial_ligne_cleunik,1,$ligne_qte_cleunik,$qte,$qte_unite,$qte_nbdec,'$dateheure_demande','$dateheure_confirm',$statut,";
				$sql_req.=" $unite_condi,$qte_condi,$nb_stock_in_condi,$choix_depot,$choix_empla,$ajout_doc_ligne_qte_cleunik,$ajout_mvt_cleunik,0);";
		       	if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-4 bis|$sql_req";}
						break;
				}     	
      		break;
      	}		
    	switch ($genreaction){
			case "livcli":
			case "faccli":
			case "avocli":
			case "retcli":
			case "recfou":
			case "facfou":
			case "retfou":
			case "avofou":
        if (($vl_e_types_gestion & 4)==4) {
          if ($qte!=0) {
            /*
              L'article est géré en stock -> on va faire un mouvement                
            */
            /*
              On calcule le montant remisé de la ligne
            */
            //$req_montantremise_sourc="SELECT $sql_htbrutremise from $fichier f1,$fichier_qte f4 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$ligne_qte_cleunik;";
            $req_montantremise_sourc="SELECT $sql_htbrutremise,f2.dateheurelivraison from $fichier f1,$fichier_qte f4,$fichier_entete f2 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$ligne_qte_cleunik and f2.commercial_cleunik=f1.commercial_cleunik;";
            $resultat_montantremise_sourc = _graal_requete_bd($req_montantremise_sourc);
            $row = mysql_fetch_assoc($resultat_montantremise_sourc);
            $vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
            $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
            $vl_mousto_art_cleunik=$art_cleunik;
            $vl_mousto_blocnotebrut.=$code." Ligne $ligne_cleunik";
            //$vl_mousto_date_mvt=$dateheure_confirm;//renseigné plus haut
            $vl_mousto_date_mvt=$row['dateheurelivraison'];
            $vl_mousto_choix_depot=$choix_depot;
            $vl_mousto_choix_empla=$choix_empla;
            $vl_mousto_qte_mvt=$qte*$vl_coeff_mousto_qte_mvt;
            $vl_mousto_pu_mvt=$row['htbrutremise']/$qte;
            $vl_mousto_mvt_cleunik=fa_mousto_ajout();
            if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour."pasbon 5|";}
            _graal_libere_requete_bd($resultat_montantremise_sourc);
            $sql_req="UPDATE $fichier_qte set mvt_cleunik=$vl_mousto_mvt_cleunik where ligne_qte_cleunik=$ligne_qte_cleunik;";
            if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-5|";}
          }                
        }
		switch (TRUE){
		  //case $vf_c_action=="ajouter":
		  case $vf_c_action=="livcli_partielle":
		  	$sql_req="UPDATE _cdecli_lignes_qte set qte_deja=qte_deja+$qte,statut=$statut where commercial_ligne_cleunik=$ligne_qte_cleunik_source;";
			if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
			$sql_req="UPDATE _cdecli_lignes_qte set statut=-39 where commercial_ligne_cleunik=$ligne_qte_cleunik_source and qte_deja>=qte;";
			if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
			
			/*
			_graal_requete_bd("ROLLBACK;");
			$toto=$sql_req;
			die($toto);
			*/
			
		  	break;
		  case $vf_c_action=="recfou_partielle":
		   $sql_req="UPDATE _cdefou_lignes_qte set qte_deja=qte_deja+$qte,statut=$statut where commercial_ligne_cleunik=$ligne_qte_cleunik_source;";
			if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6bis|";}
			$toto=$sql_req;
			$sql_req="UPDATE _cdefou_lignes_qte set statut=-39 where commercial_ligne_cleunik=$ligne_qte_cleunik_source and qte_deja>=qte;";
			if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
			break;     
		}
		    
        break;
    }
    switch ($genreaction){
		case "cdecli":   
    		fa_maj_prepa_compta($genreaction,"montants",-2,$action_cleunik,"",1);
    		break;
    }		
	if ($vf_c_retour=="") {
      _graal_requete_bd("COMMIT;");
      //$vf_c_retour="$toto";
    } else {
      _graal_requete_bd("ROLLBACK;");
    }
    $vf_c_echo=$vf_c_retour;
    break;
  case $vf_c_action=="kilometre_dateheure_confirm"://*******************************************************************************
		$vl_t_listecles=fa_recup_param('vl_t_listecles','');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$ligne_qte_cleunik="";
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $ligne_qte_cleunik.=$vl_t_listecles[$vl_e_i].',';
    }
    if ($ligne_qte_cleunik!="") {
      $ligne_qte_cleunik=substr($ligne_qte_cleunik, 0, -1);
    }  else {
      $ligne_qte_cleunik="-99999999";
    }
		$deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    $sql_req="update $fichier_qte f1 set f1.dateheure_confirm=f1.dateheure_demande where f1.ligne_qte_cleunik in ($ligne_qte_cleunik);";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour=-6;}
		if ($vf_c_retour=="") {
      _graal_requete_bd("COMMIT;");
    } else {
      _graal_requete_bd("ROLLBACK;");
    }
    $vf_c_echo=$vf_c_retour;
		break;
	case $vf_c_action=="kilometre_dateheure_demande"://*******************************************************************************
		$vl_t_listecles=fa_recup_param('vl_t_listecles','');
		$vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
		$ligne_qte_cleunik="";
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $ligne_qte_cleunik.=$vl_t_listecles[$vl_e_i].',';
    }
    if ($ligne_qte_cleunik!="") {
      $ligne_qte_cleunik=substr($ligne_qte_cleunik, 0, -1);
    }  else {
      $ligne_qte_cleunik="-99999999";
    }
		$deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    $sql_req="update $fichier_qte f1,$fichier_entete f2, $fichier f3 set f1.dateheure_demande=f2.dateheurelivraison where f2.commercial_cleunik=f3.commercial_cleunik and f3.commercial_ligne_cleunik=f1.commercial_ligne_cleunik and ligne_qte_cleunik in ($ligne_qte_cleunik);";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour=-6;}
		if ($vf_c_retour=="") {
      _graal_requete_bd("COMMIT;");
    } else {
      _graal_requete_bd("ROLLBACK;");
    }
    $vf_c_echo=$vf_c_retour;
		break;
	case $vf_c_action=="modifier"://*******************************************************************************
		$deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    /*
     * on ne modifie pas les taxes ou les informations comptables
  
    $sql_req="update $fichier set art_cleunik=$art_cleunik,code_interne=$code_interne,indice_interne=$indice_interne,mnemotechnique_interne=$mnemotechnique_interne,
		description_interne=$description_interne,typeligne='$typeligne',pu=$pu,pu_portee=$pu_portee,pu_type=$pu_type,nbdec_pu=$nbdec_pu,tarif_cleunik=$tarif_cleunik,remise_taux=$remise_taux,
		remise_type=$remise_type,remise_genr=$remise_genr,poidsbrut=$poidsbrut,tare=$tare,poidsnet=$poidsnet,devise_taux=$devise_taux,pr=$pr,blocnotebrut='$blocnotebrut',
		blocnoteriche='$blocnoteriche',devise=$devise,code_acteur='$code_acteur',description_acteur='$description_acteur',catcompta_cleunik=$catcompta_cleunik,
		pc_cleunik=$pc_cleunik,remise_natu=$remise_natu,coef_facture=$coef_facture,taxes_cleunik=$taxes_cleunik where commercial_ligne_cleunik=$commercial_ligne_cleunik
		 and ligne_cleunik=$ligne_cleunik;";
	   */
    $sql_req="update $fichier set art_cleunik=$art_cleunik,code_interne=$code_interne,indice_interne=$indice_interne,mnemotechnique_interne=$mnemotechnique_interne,
		description_interne=$description_interne,typeligne='$typeligne',pu=$pu,pu_portee=$pu_portee,pu_type=$pu_type,nbdec_pu=$nbdec_pu,tarif_cleunik=$tarif_cleunik,remise_taux=$remise_taux,
		remise_type=$remise_type,remise_genr=$remise_genr,poidsbrut=$poidsbrut,tare=$tare,poidsnet=$poidsnet,devise_taux=$devise_taux,pr=$pr,blocnotebrut='$blocnotebrut',
		blocnoteriche='$blocnoteriche',devise=$devise,code_acteur='$code_acteur',description_acteur='$description_acteur',remise_natu=$remise_natu,coef_facture=$coef_facture where commercial_ligne_cleunik=$commercial_ligne_cleunik
		 and ligne_cleunik=$ligne_cleunik;";
    
    $toto=$sql_req;
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour=-6;}
		switch ($type_gestion_doc){
			case 1:
				$sql_req="UPDATE $fichier_qte SET qte=$qte,qte_unite=$qte_unite,qte_nbdec=$qte_nbdec,dateheure_demande='$dateheure_demande',dateheure_confirm='$dateheure_confirm',
				statut=$statut where ligne_qte_cleunik=$ligne_qte_cleunik;";
				break;
			case 2:
			case 3:
		    $sql_req="UPDATE $fichier_qte SET qte=$qte,qte_unite=$qte_unite,qte_nbdec=$qte_nbdec,dateheure_demande='$dateheure_demande',dateheure_confirm='$dateheure_confirm',
				statut=$statut,unite_condi=$unite_condi,qte_condi=$qte_condi,nb_stock_in_condi=$nb_stock_in_condi,choix_depot=$choix_depot,choix_empla=$choix_empla 
				where ligne_qte_cleunik=$ligne_qte_cleunik;";
				break;
		}
	if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour=-7;}
    if ($mvt_cleunik!=-1) {
      fa_mousto_supprime($mvt_cleunik);
    }
    switch ($genreaction){
      case "offcli":
      case "cdecli":
      case "demfou":
      case "cdefou":
	  case "avofin":
	  case "relfou":
	  case "avofif":
        break;
      case "livcli":
      case "faccli":
      case "avocli":
      case "retcli":
      case "retfou":
      case "facfou":
      case "recfou":
      case "avofou":
        if (($vl_e_types_gestion & 4)==4) {
          if ($qte!=0) {
            /*
              L'article est géré en stock -> on va faire un mouvement                
            */
            /*
              On calcule le montant remisé de la ligne
            */
            $req_montantremise_sourc="SELECT $sql_htbrutremise,f2.dateheurelivraison from $fichier f1,$fichier_qte f4,$fichier_entete f2 WHERE f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f4.ligne_qte_cleunik=$ligne_qte_cleunik and f2.commercial_cleunik=f1.commercial_cleunik;";
            $resultat_montantremise_sourc = _graal_requete_bd($req_montantremise_sourc);
            $row = mysql_fetch_assoc($resultat_montantremise_sourc);
            $vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
            $vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
            $vl_mousto_art_cleunik=$art_cleunik;
            $vl_mousto_blocnotebrut.=$code." Ligne $ligne_cleunik";
            //$vl_mousto_date_mvt=$dateheure_confirm;//renseigné plus haut
            $vl_mousto_date_mvt=$row['dateheurelivraison'];
            $vl_mousto_choix_depot=$choix_depot;
            $vl_mousto_choix_empla=$choix_empla;
            $vl_mousto_qte_mvt=$qte*$vl_coeff_mousto_qte_mvt;
            $vl_mousto_pu_mvt=$row['htbrutremise']/$qte;
            $vl_mousto_mvt_cleunik=fa_mousto_ajout();
            if ($vl_mousto_mvt_cleunik==-1) {$vf_c_retour="pasbon";}
            _graal_libere_requete_bd($resultat_montantremise_sourc);
            $sql_req="UPDATE $fichier_qte set mvt_cleunik=$vl_mousto_mvt_cleunik where ligne_qte_cleunik=$ligne_qte_cleunik;";
			if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour=-8;}
          }                
        }
        break;
    }
    switch ($genreaction){
	  case "livcli":
	  	$sql_req="UPDATE _cdecli_lignes_qte set qte_deja=qte_deja+$qte-$qte_avant,statut=$statut where commercial_ligne_cleunik=$ligne_qte_doc_origine;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
		$sql_req="UPDATE _cdecli_lignes_qte set statut=-39 where commercial_ligne_cleunik=$ligne_qte_doc_origine and qte_deja>=qte;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
	  	break;
	  case "recfou":
	   $sql_req="UPDATE _cdefou_lignes_qte set qte_deja=qte_deja+$qte-$qte_avant,statut=$statut where commercial_ligne_cleunik=$ligne_qte_doc_origine;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6bis|";}
		$toto=$sql_req;
		$sql_req="UPDATE _cdefou_lignes_qte set statut=-39 where commercial_ligne_cleunik=$ligne_qte_doc_origine and qte_deja>=qte;";
		if(_graal_exec_requete($sql_req)!="ok") {$vf_c_retour.="-6|";}
		break;     
	}       
    
    
    
	if ($vf_c_retour=="") {
      _graal_requete_bd("COMMIT;");
    } else {
      _graal_requete_bd("ROLLBACK;");
    }
    //$vf_c_retour=$toto;
    $vf_c_echo=$vf_c_retour;
    
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
