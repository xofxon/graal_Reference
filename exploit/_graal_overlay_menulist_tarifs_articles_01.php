<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
$vl_e_art_cleunik=intval(fa_recup_param("vl_e_art_cleunik",'-1'));
$vl_e_act_cleunik=intval(fa_recup_param("vl_e_act_cleunik",'-1'));
$vl_e_tarif_cleunik=intval(fa_recup_param("vl_e_tarif_cleunik",'-1'));
$vl_e_type_tarifs=intval(fa_recup_param("vl_e_type_tarifs",'-1'));
$vl_e_critere_cleunik=intval(fa_recup_param("vl_e_critere_cleunik",'0'));
$vl_e_nouvelle_ligne=intval(fa_recup_param("vl_e_nouvelleligne",'0'));
$vl_e_pas_tarif=intval(fa_recup_param("vl_e_pas_tarif",'0'));
$vl_c_nom_ml=fa_recup_param("vl_c_nom_ml","");
$sql_req = "SELECT count(*) FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.type=$vl_e_type_tarifs);";
$sql_result = _graal_requete_bd($sql_req);
$vl_e_nombre_types=mysql_num_rows($sql_result);
_graal_libere_requete_bd($sql_result);
$sql_req = "SELECT a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=$vl_e_act_cleunik and a2.type=$vl_e_type_tarifs)";
if ($vl_e_tarif_cleunik!=-1) {
  $sql_req.="UNION SELECT a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=$vl_e_act_cleunik and a2.type=$vl_e_type_tarifs and a2.tarif_cleunik=$vl_e_tarif_cleunik)";
}
$toto=$sql_req;
//echo $toto;
$sql_result = _graal_requete_bd($sql_req);
$vl_c_ove="";
$i=0;$vl_c_pu=-1;
$vl_c_ove.="<hbox id='toto' flex='1'>";
$tarif_deja_selectionne=false;
$vl_c_ove.=('<menulist sizetopopup="none" old_onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" observes="broadcaster_01" flex="1" id="'.$vl_c_nom_ml.'" _graal_nombre="'.$vl_e_nombre_types.'" oncommand="pf_change_tarif();" removeelemenent="true">');
$vl_c_ove.=('<menupopup>');
while ($row = mysql_fetch_assoc($sql_result)){
  $vl_c_lib=fa_remplace_quotes(fa_ent_xml($row['intitule_tarif'])."                 (".fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).")");
  $selected="";$class="";$disabled="";
  if ($vl_e_nouvelle_ligne==0) {
    $selected="selected='true'";
    $tarif_deja_selectionne=true;
    $vl_c_pu=fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']);
    $vl_c_nb_dec=$row['nb_dec'];
  } else {
    if ($vl_e_tarif_cleunik==$row['choix_cleunik']) {
      $selected="selected='true'";
      $tarif_deja_selectionne=true;
      $vl_c_pu=fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']);
      $vl_c_nb_dec=$row['nb_dec'];
    }
  }
  if ($row['actif']==2) {
  	$class="class='obsolete'";
		$disabled="disabled='true'";
	}
  $vl_c_ove.=('<menuitem '.$class.' '.$disabled.' value="' .$vl_c_lib.'" _graal_cleunik="'.$row['choix_cleunik'].'" label="'.$vl_c_lib.'" '.$selected.' _graal_tarif="'.fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).'" _graal_nb_dec="'.$row['nb_dec'].'"/>');
  //if ($i==0) {$vl_c_pu=fa_ent_xml($row['pu_reference']);}
  $i++;
}
_graal_libere_requete_bd($sql_result);
if ($i!=0) {$vl_c_ove.=('<menuseparator/>');}
$sql_req = "SELECT a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.actif=1 and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=0 and a2.type=$vl_e_type_tarifs)";
$sql_req.=" UNION SELECT a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,0,a1.choix_actif,2 FROM _choix a1 WHERE a1.critere_cleunik=$vl_e_critere_cleunik and a1.choix_cleunik=$vl_e_pas_tarif ";
if ($vl_e_tarif_cleunik!=-1) {
  $sql_req.=" UNION SELECT a1.choix_cleunik AS choix_cleunik,a1.choix_valeur_texte_01 AS intitule_tarif,a2.pu_reference,a2.actif,a2.nb_dec FROM  _choix a1 left join _art_tarifs a2 on a1.choix_cleunik=a2.tarif_cleunik WHERE (a1.critere_cleunik=$vl_e_critere_cleunik and a2.art_cleunik=$vl_e_art_cleunik and a2.act_cleunik=0 and a2.type=$vl_e_type_tarifs and a2.tarif_cleunik=$vl_e_tarif_cleunik)";
}
$titi=$sql_req;
//echo $titi;
$sql_result = _graal_requete_bd($sql_req);
$vl_e_nombre_types=mysql_num_rows($sql_result);
while ($row = mysql_fetch_assoc($sql_result)){
  $vl_c_lib=fa_remplace_quotes(fa_ent_xml($row['intitule_tarif'])."                 (".fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).")");
  $selected="";$class="";$disabled="";
  if ($tarif_deja_selectionne==false) {
    if ($vl_e_tarif_cleunik==$row['choix_cleunik']) {
      $selected="selected='true'";
      $vl_c_pu=fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']);
      $vl_c_nb_dec=$row['nb_dec'];
			$tarif_deja_selectionne=true;
    }
  }
	if ($vl_e_pas_tarif==$row['choix_cleunik']) {
		$vl_c_menu_pas_tarif_selectionne_oui=('<menuitem value="'.$vl_c_lib.'" _graal_cleunik="'.$row['choix_cleunik'].'" label="'.$vl_c_lib.'" selected="true" _graal_tarif="'.fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).'" _graal_nb_dec="'.$row['nb_dec'].'"/>');
		$vl_c_menu_pas_tarif_selectionne_non=('<menuitem value="'.$vl_c_lib.'" _graal_cleunik="'.$row['choix_cleunik'].'" label="'.$vl_c_lib.'" _graal_tarif="'.fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).'" _graal_nb_dec="'.$row['nb_dec'].'"/>');
	} else {
	  if ($row['actif']==2) {
	  	$class="class='obsolete'";
			$disabled="disabled='true'";
		}
	  $vl_c_ove.=('<menuitem '.$class.' '.$disabled.' value="'.$vl_c_lib.'" _graal_cleunik="'.$row['choix_cleunik'].'" label="'.$vl_c_lib.'" '.$selected.' _graal_tarif="'.fa_reel(fa_ent_xml($row['pu_reference']),$row['nb_dec']).'" _graal_nb_dec="'.$row['nb_dec'].'"/>');
	}
}
_graal_libere_requete_bd($sql_result);
if ($tarif_deja_selectionne==false) {
	$vl_c_ove.=$vl_c_menu_pas_tarif_selectionne_oui;
} else {
	$vl_c_ove.=$vl_c_menu_pas_tarif_selectionne_non;
}
$vl_c_ove.=('</menupopup></menulist>');
$vl_c_ove.=('<_graal_box id="ove_tarif" _graal_pu="-1" _graal_nb_dec="2"/>');
$vl_c_ove.="</hbox>";  
header('Content-type: text/xml; charset=utf-8');
echo '<?xml version="1.0" encoding="utf-8"?>';
echo <<<END
<overlay id="overlay_php" $c_xmlns>
$vl_c_ove
</overlay>
END;
?>
