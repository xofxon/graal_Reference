<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
define('EOL', "\r\n");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_art_duplication";
$t_origines_ok[1]="_graal_fen_articles_01";
$t_origines_ok[2]="_graal_fen_articles_02";
fa_acces_script();
$vf_c_echo="";
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","-1"));
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_code=fa_recup_param("vl_code","");
$vl_mnemotechnique=fa_recup_param("vl_mnemotechnique","");
$vl_description=fa_recup_param("vl_description","");
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_dateheurevalidite=fa_recup_param("vl_dateheurevalidite","");
$vl_types_gestion=intval(fa_recup_param("vl_types_gestion",""));
$vl_nbdec_prix=intval(fa_recup_param("vl_nbdec_prix",""));
$vl_nbdec_qte=intval(fa_recup_param("vl_nbdec_qte",""));
$vl_actif=intval(fa_recup_param("vl_actif",1));
$vl_pr_generique=fa_floatval(fa_recup_param("vl_pr_generique",$vl_nbdec_prix));
$vl_unite_capacite=intval(fa_recup_param("vl_unite_capacite",1));
$vl_capacite=fa_floatval(fa_recup_param("vl_capacite",4));
$vl_duplik_ged=intval(fa_recup_param("vl_duplik_ged","2"));
$vl_unite_vente=intval(fa_recup_param("vl_unite_vente",1));
$vl_unite_poids=intval(fa_recup_param("vl_unite_poids",-59));
$vl_poids_brut=fa_floatval(fa_recup_param("vl_poids_brut",0));
$vl_poids_net=fa_floatval(fa_recup_param("vl_poids_net",0));
$vl_nc_2009_autosuffisant_cleunik=intval(fa_recup_param("vl_nc_2009_autosuffisant_cleunik",-1));
$vl_unite_longueur=intval(fa_recup_param("vl_unite_longueur",-83));
$vl_tare=fa_floatval(fa_recup_param("vl_tare",0));
$vl_longueur=fa_floatval(fa_recup_param("vl_longueur",0));
$vl_largeur=fa_floatval(fa_recup_param("vl_largeur",0));
$vl_epaisseur=fa_floatval(fa_recup_param("vl_epaisseur",0));
switch (TRUE){
  case $vf_c_action=="supprimer":
    if ($vl_e_art_cleunik==0) {exit;}
    $sql_req = "DELETE FROM _article WHERE _article.art_cleunik = $vl_e_art_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_e_art_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="ajouter":
    $vl_e_art_cleunik=_graal_requete_max("art_cleunik","_article");
    $sql_req = "INSERT INTO _article set art_cleunik=$vl_e_art_cleunik,code='$vl_code',mnemotechnique='$vl_mnemotechnique',description='$vl_description',
		blocnotebrut='$vl_blocnotebrut',dateheurecreation=now(),types_gestion=$vl_types_gestion,actif=$vl_actif,nbdec_prix=$vl_nbdec_prix,nbdec_qte=$vl_nbdec_qte,
		pr_generique=$vl_pr_generique,nc_2009_autosuffisant_cleunik=$vl_nc_2009_autosuffisant_cleunik";
    if ($vl_dateheurevalidite!='') {$sql_req.=",dateheurevalidite='$vl_dateheurevalidite'";}
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_e_art_cleunik;
      $sql_req = "INSERT INTO _art_dimensions set art_cleunik=$vl_e_art_cleunik,capacite=$vl_capacite,unite_capacite=$vl_unite_capacite,poids_brut=$vl_poids_brut,
			poids_net=$vl_poids_net,unite_poids=$vl_unite_poids,unite_longueur=$vl_unite_longueur,tare=$vl_tare,longueur=$vl_longueur,largeur=$vl_largeur,epaisseur=$vl_epaisseur;";
      _graal_exec_requete($sql_req);
      $sql_req = "INSERT INTO _art_ventes set art_cleunik=$vl_e_art_cleunik,unite_vente=$vl_unite_vente;";
      _graal_exec_requete($sql_req);
    } else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _article set code='$vl_code',mnemotechnique='$vl_mnemotechnique',description='$vl_description',blocnotebrut='$vl_blocnotebrut',";
	$sql_req.= " dateheuremodif=now(),types_gestion=$vl_types_gestion,actif=$vl_actif,nbdec_prix=$vl_nbdec_prix,pr_generique=$vl_pr_generique,nbdec_qte=$vl_nbdec_qte,nc_2009_autosuffisant_cleunik=$vl_nc_2009_autosuffisant_cleunik";
    if ($vl_dateheurevalidite!='') {$sql_req.=",dateheurevalidite='$vl_dateheurevalidite'";}
    $sql_req.=" WHERE _article.art_cleunik = $vl_e_art_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_e_art_cleunik;
      $sql_req = "REPLACE INTO _art_dimensions set art_cleunik=$vl_e_art_cleunik,capacite=$vl_capacite,unite_capacite=$vl_unite_capacite,poids_brut=$vl_poids_brut,poids_net=$vl_poids_net,unite_poids=$vl_unite_poids,unite_longueur=$vl_unite_longueur,tare=$vl_tare,longueur=$vl_longueur,largeur=$vl_largeur,epaisseur=$vl_epaisseur;";
      $vf_c_echo=_graal_exec_requete($sql_req);
      $sql_req = "REPLACE INTO _art_ventes set art_cleunik=$vl_e_art_cleunik,unite_vente=$vl_unite_vente;";
      $vf_c_echo=_graal_exec_requete($sql_req);
    } else {
    	//die($sql_req);
    	$vf_c_echo=-1;
    }
    break;
  case $vf_c_action=="dupliquer":
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    $vl_e_art_cleunik_destination=_graal_requete_max("art_cleunik","_article");
    $vl_e_art_cleunik_origine=$vl_e_art_cleunik;
    $sql_req = "INSERT INTO _article SELECT $vl_e_art_cleunik_destination,'$vl_code',`indice` as `indice`,'$vl_mnemotechnique','$vl_description',`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,Now(),NULL,`dateheurevalidite` as `dateheurevalidite`,`types_gestion` as `types_gestion`,`actif` as `actif`,`nbdec_prix` as `nbdec_prix`,`pr_generique` as `pr_generique`,nbdec_qte,nc_2009_autosuffisant_cleunik FROM _article where art_cleunik=$vl_e_art_cleunik_origine";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo!='ok') {$vf_c_retour.="-1";}
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_e_art_cleunik_destination;
      $sql_req = "INSERT INTO _art_achats SELECT $vl_e_art_cleunik_destination,`delai_reappro` as `delai_reappro`,`unite_reappro` as `unite_reappro`,`der_pa` as `der_pa`,`pamp` as `pamp`,`dateheure_der_achat` as `dateheure_der_achat`,`unite_achat` as `unite_achat` FROM _art_achats where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-2";}
      $sql_req = "INSERT INTO _art_ventes SELECT $vl_e_art_cleunik_destination,`unite_vente` as `unite_vente` FROM _art_ventes where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-3";}
      $sql_req="SELECT `act_cleunik` as `act_cleunik`,`code` as `code`,`description` as `description`,`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,`dateheurevalidite` as `dateheurevalidite`,`delai_reappro` as `delai_reappro`,`unite_reappro` as `unite_reappro`,`minimum_commande` as `minimum_commande`,unite_achat FROM _art_acteur where art_cleunik=$vl_e_art_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      while ($row = mysql_fetch_assoc($result)){
        $vl_art_acteur_cleunik=_graal_requete_max("art_acteur_cleunik","_art_acteur");
        $vl_act_cleunik=fa_nn($row['act_cleunik']);
        $vl_code=fa_nt($row['code']);
        $vl_description=fa_nt($row['description']);
        $vl_blocnotebrut=fa_nt($row['blocnotebrut']);
        $vl_blocnotertf=fa_nt($row['blocnotertf']);
        $vl_delai_reappro=fa_nn($row['delai_reappro']);
        $vl_unite_reappro=fa_nn($row['unite_reappro']);
        $vl_dateheurevalidite=fa_nt($row['dateheurevalidite']);
        $vl_minimum_commande=fa_nn($row['minimum_commande']);
        $vl_unite_achat=fa_nn($row['unite_achat']);
        $sql_req_ins = "INSERT INTO _art_acteur set art_acteur_cleunik=$vl_art_acteur_cleunik,art_cleunik=$vl_e_art_cleunik_destination,act_cleunik=$vl_act_cleunik,code=$vl_code,description=$vl_description,blocnotebrut=$vl_blocnotebrut,dateheurecreation=now(),delai_reappro=$vl_delai_reappro,unite_reappro=$vl_unite_reappro,blocnotertf=$vl_blocnotertf,dateheuremodif=now(),dateheurevalidite=$vl_dateheurevalidite,minimum_commande=$vl_minimum_commande,unite_achat=$vl_unite_achat;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
        if($vf_c_echo!='ok') {$vf_c_retour.="-4".EOL.$sql_req_ins;}
      }
      _graal_libere_requete_bd($result);
      $sql_req="INSERT INTO _art_choix_fixes SELECT $vl_e_art_cleunik_destination,`choix_cleunik` as `choix_cleunik`,`critere_cleunik` as `critere_cleunik`,`uti_cleunik` as `uti_cleunik` FROM _art_choix_fixes where art_cleunik=$vl_e_art_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-5";}
      $sql_req = "INSERT INTO _art_compta SELECT $vl_e_art_cleunik_destination,catcompta_cleunik,pc_cleunik_vente,pc_cleunik_achat,taxes_cleunik,tpf_cleunik,tpf_cleunik_01  FROM _art_compta where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-6";}
      $sql_req = "INSERT INTO _art_dimensions SELECT $vl_e_art_cleunik_destination,`capacite` as `capacite`,`unite_capacite` as `unite_capacite`,poids_brut as poids_brut,poids_net as poids_net,unite_poids as unite_poids,`tare` as `tare`,`longueur` as `longueur`,`largeur` as `largeur`,`epaisseur` as `epaisseur`,`unite_longueur` as `unite_longueur` FROM _art_dimensions where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-7";}
      $sql_req = "INSERT INTO _art_fabs SELECT $vl_e_art_cleunik_destination,`multiple_base` as `multiple_base`,`pr` as `pr`,`nbdec_pr` as `nbdec_pr` FROM _art_fabs where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-8";}
      $sql_req = "INSERT INTO _art_libelle SELECT $vl_e_art_cleunik_destination,`descriptif_brut` as `descriptif_brut`,`descriptif_riche` as `descriptif_riche`,`langue` as `langue`,`genre` as `genre` FROM _art_libelle where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-9";}
      $sql_req="SELECT `tar_cleunik` as `tar_cleunik`,`art_cleunik` as `art_cleunik`,`tarif_cleunik` as `tarif_cleunik`,`act_cleunik` as `act_cleunik`,`pu_reference` as `pu_reference`,`actif` as `actif`,`dateheure_dermaj` as `dateheure_dermaj`,`dateheure_validite` as `dateheure_validite`,`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,`type` as `type`,`quantite_basse` as `quantite_basse`,`quantite_haute` as `quantite_haute`,`unite_quantite` as `unite_quantite`,`nb_dec` as `nb_dec`,remise_taux,remise_type,remise_genr,remise_natu FROM _art_tarifs where art_cleunik=$vl_e_art_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      $vl_tar_cleunik=_graal_requete_max("tar_cleunik","_art_tarifs");
      while ($row = mysql_fetch_assoc($result)){
        $tarif_cleunik=fa_nn($row['tarif_cleunik']);
        $act_cleunik=fa_nn($row['act_cleunik']);
        $pu_reference=fa_nn($row['pu_reference']);
        $actif=fa_nn($row['actif']);
        $dateheure_validite=fa_nt($row['dateheure_validite']);
        $blocnotebrut=fa_nt($row['blocnotebrut']);
        $blocnotertf=fa_nt($row['blocnotertf']);
        $type=fa_nn($row['type']);
        $quantite_basse=fa_nn($row['quantite_basse']);
        $quantite_haute=fa_nn($row['quantite_haute']);
        $unite_quantite=fa_nn($row['unite_quantite']);
        $nb_dec=fa_nn($row['nb_dec']);
		$remise_taux=fa_nn($row['remise_taux']);
		$remise_type=fa_nn($row['remise_type']);
		$remise_genr=fa_nn($row['remise_genr']);
		$remise_natu=fa_nn($row['remise_natu']);
        $sql_req_ins = "INSERT INTO _art_tarifs set `tar_cleunik`=$vl_tar_cleunik,`art_cleunik`=$vl_e_art_cleunik_destination,`tarif_cleunik`=$tarif_cleunik,`act_cleunik`=$act_cleunik,`pu_reference`=$pu_reference,`actif`=$actif,`dateheure_dermaj`=now(),`dateheure_validite`=$dateheure_validite,`blocnotebrut`=$blocnotebrut,`blocnotertf`=$blocnotertf,`type`=$type,`quantite_basse`=$quantite_basse,`quantite_haute`=$quantite_haute,`unite_quantite`=$unite_quantite,nb_dec=$nb_dec,remise_taux=$remise_taux,remise_type=$remise_type,remise_genr=$remise_genr,remise_natu=$remise_natu;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
				$vl_tar_cleunik++;
        if($vf_c_echo!='ok') {$vf_c_retour.="-10";}
      }
      _graal_libere_requete_bd($result);
      $sql_req = "INSERT INTO _nomenclatures_fab SELECT $vl_e_art_cleunik_destination,`art_cleunik_fils` as `art_cleunik_fils`,`noligne` as `noligne`,`quantite` as `quantite`,`unite_quantite` as `unite_quantite`,`nb_decimales_qte` as `nb_decimales_qte`,`blocnotebrut` as `blocnotebrut`,`valeur_complement` as `valeur_complement`,`valeur_complement_type` as `valeur_complement_type`,`base_valorisation` as `base_valorisation`,arrondi_fab as arrondi_fab FROM _nomenclatures_fab where art_cleunik_pere=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-11";}
      if ($vl_duplik_ged==1) {
        $sql_req = "INSERT INTO _documents_rattachement SELECT doc_cleunik,$vl_e_articl,$vl_e_art_cleunik_destination FROM _documents_rattachement where rat_cleunik=$vl_e_art_cleunik_origine and portee = $vl_e_articl";
        $vf_c_echo=_graal_exec_requete($sql_req);
        if($vf_c_echo!='ok') {$vf_c_retour.="-12";}
      }
	}
      if ($vf_c_retour=="") {
        $vf_c_echo="ok|$vl_e_art_cleunik_destination||";
        _graal_requete_bd("COMMIT;");
      } else {
        $vf_c_echo="-13|$vf_c_retour|";
        _graal_requete_bd("ROLLBACK;");
      }
    break;
  case $vf_c_action=="dupliquer_ajouter":
    $deb_trans=_graal_requete_bd("START TRANSACTION;");
    $vf_c_retour="";
    $vl_e_art_cleunik_destination=_graal_requete_max("art_cleunik","_article");
    $vl_e_art_cleunik_origine=0;
    $vl_code="";
    $vl_mnemotechnique="";
    $vl_description="";
    $vl_actif=1;
    $sql_req = "INSERT INTO _article SELECT $vl_e_art_cleunik_destination,'$vl_code',`indice` as `indice`,'$vl_mnemotechnique','$vl_description',`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,Now(),NULL,`dateheurevalidite` as `dateheurevalidite`,`types_gestion` as `types_gestion`,$vl_actif,`nbdec_prix` as `nbdec_prix`,`pr_generique` as `pr_generique`,nbdec_qte,nc_2009_autosuffisant_cleunik FROM _article where art_cleunik=$vl_e_art_cleunik_origine";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo!='ok') {$vf_c_retour.="-1";}
    if($vf_c_echo=='ok') {
      $vf_c_echo=$vl_e_art_cleunik_destination;
      $sql_req = "INSERT INTO _art_achats SELECT $vl_e_art_cleunik_destination,`delai_reappro` as `delai_reappro`,`unite_reappro` as `unite_reappro`,`der_pa` as `der_pa`,`pamp` as `pamp`,`dateheure_der_achat` as `dateheure_der_achat`,`unite_achat` as `unite_achat` FROM _art_achats where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-2";}
      $sql_req = "INSERT INTO _art_ventes SELECT $vl_e_art_cleunik_destination,`unite_vente` as `unite_vente` FROM _art_ventes where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-3";}
      $sql_req="SELECT `act_cleunik` as `act_cleunik`,`code` as `code`,`description` as `description`,`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,`dateheurevalidite` as `dateheurevalidite`,`delai_reappro` as `delai_reappro`,`unite_reappro` as `unite_reappro`,`minimum_commande` as `minimum_commande`,unite_achat FROM _art_acteur where art_cleunik=$vl_e_art_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      while ($row = mysql_fetch_assoc($result)){
        $vl_art_acteur_cleunik=_graal_requete_max("art_acteur_cleunik","_art_acteur");
        $vl_act_cleunik=fa_nn($row['act_cleunik']);
        $vl_code=fa_nt($row['code']);
        $vl_description=fa_nt($row['description']);
        $vl_blocnotebrut=fa_nt($row['blocnotebrut']);
        $vl_blocnotertf=fa_nt($row['blocnotertf']);
        $vl_delai_reappro=fa_nn($row['delai_reappro']);
        $vl_unite_reappro=fa_nn($row['unite_reappro']);
        $vl_dateheurevalidite=fa_nt($row['dateheurevalidite']);
        $vl_minimum_commande=fa_nn($row['minimum_commande']);
        $vl_unite_achat=fa_nn($row['unite_achat']);
        $sql_req_ins = "INSERT INTO _art_acteur set art_acteur_cleunik=$vl_art_acteur_cleunik,art_cleunik=$vl_e_art_cleunik_destination,act_cleunik=$vl_act_cleunik,code=$vl_code,description=$vl_description,blocnotebrut=$vl_blocnotebrut,dateheurecreation=now(),delai_reappro=$vl_delai_reappro,unite_reappro=$vl_unite_reappro,blocnotertf=$vl_blocnotertf,dateheuremodif=now(),dateheurevalidite=$vl_dateheurevalidite,minimum_commande=$vl_minimum_commande,unite_achat=$vl_unite_achat;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
        if($vf_c_echo!='ok') {$vf_c_retour.="-4".EOL.$sql_req_ins;}
      }
      _graal_libere_requete_bd($result);
      $sql_req="INSERT INTO _art_choix_fixes SELECT $vl_e_art_cleunik_destination,`choix_cleunik` as `choix_cleunik`,`critere_cleunik` as `critere_cleunik`,`uti_cleunik` as `uti_cleunik` FROM _art_choix_fixes where art_cleunik=$vl_e_art_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-5";}
      $sql_req = "INSERT INTO _art_compta SELECT $vl_e_art_cleunik_destination,catcompta_cleunik,pc_cleunik_vente,pc_cleunik_achat,taxes_cleunik,tpf_cleunik,tpf_cleunik_01 FROM _art_compta where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-6";}
      $sql_req = "INSERT INTO _art_dimensions SELECT $vl_e_art_cleunik_destination,`capacite` as `capacite`,`unite_capacite` as `unite_capacite`,poids_brut as poids_brut,poids_net as poids_net,unite_poids as unite_poids,`tare` as `tare`,`longueur` as `longueur`,`largeur` as `largeur`,`epaisseur` as `epaisseur`,`unite_longueur` as `unite_longueur` FROM _art_dimensions where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-7";}
      $sql_req = "INSERT INTO _art_fabs SELECT $vl_e_art_cleunik_destination,`multiple_base` as `multiple_base`,`pr` as `pr`,`nbdec_pr` as `nbdec_pr` FROM _art_fabs where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-8";}
      $sql_req = "INSERT INTO _art_libelle SELECT $vl_e_art_cleunik_destination,`descriptif_brut` as `descriptif_brut`,`descriptif_riche` as `descriptif_riche`,`langue` as `langue`,`genre` as `genre` FROM _art_libelle where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-9";}
      $sql_req="SELECT `tar_cleunik` as `tar_cleunik`,`art_cleunik` as `art_cleunik`,`tarif_cleunik` as `tarif_cleunik`,`act_cleunik` as `act_cleunik`,`pu_reference` as `pu_reference`,`actif` as `actif`,`dateheure_dermaj` as `dateheure_dermaj`,`dateheure_validite` as `dateheure_validite`,`blocnotebrut` as `blocnotebrut`,`blocnotertf` as `blocnotertf`,`type` as `type`,`quantite_basse` as `quantite_basse`,`quantite_haute` as `quantite_haute`,`unite_quantite` as `unite_quantite`,`nb_dec` as `nb_dec`,remise_taux,remise_type,remise_genr,remise_natu FROM _art_tarifs where art_cleunik=$vl_e_art_cleunik_origine";
      $result = _graal_requete_bd($sql_req);
      $vl_tar_cleunik=_graal_requete_max("tar_cleunik","_art_tarifs");
      while ($row = mysql_fetch_assoc($result)){
        $tarif_cleunik=fa_nn($row['tarif_cleunik']);
        $act_cleunik=fa_nn($row['act_cleunik']);
        $pu_reference=fa_nn($row['pu_reference']);
        $actif=fa_nn($row['actif']);
        $dateheure_validite=fa_nt($row['dateheure_validite']);
        $blocnotebrut=fa_nt($row['blocnotebrut']);
        $blocnotertf=fa_nt($row['blocnotertf']);
        $type=fa_nn($row['type']);
        $quantite_basse=fa_nn($row['quantite_basse']);
        $quantite_haute=fa_nn($row['quantite_haute']);
        $unite_quantite=fa_nn($row['unite_quantite']);
        $nb_dec=fa_nn($row['nb_dec']);
		$remise_taux=fa_nn($row['remise_taux']);
		$remise_type=fa_nn($row['remise_type']);
		$remise_genr=fa_nn($row['remise_genr']);
		$remise_natu=fa_nn($row['remise_natu']);
        $sql_req_ins = "INSERT INTO _art_tarifs set `tar_cleunik`=$vl_tar_cleunik,`art_cleunik`=$vl_e_art_cleunik_destination,`tarif_cleunik`=$tarif_cleunik,`act_cleunik`=$act_cleunik,`pu_reference`=$pu_reference,`actif`=$actif,`dateheure_dermaj`=now(),`dateheure_validite`=$dateheure_validite,`blocnotebrut`=$blocnotebrut,`blocnotertf`=$blocnotertf,`type`=$type,`quantite_basse`=$quantite_basse,`quantite_haute`=$quantite_haute,`unite_quantite`=$unite_quantite,nb_dec=$nb_dec,remise_taux=$remise_taux,remise_type=$remise_type,remise_genr=$remise_genr,remise_natu=$remise_natu;";
        $vf_c_echo=_graal_exec_requete($sql_req_ins);
				$vl_tar_cleunik++;
        if($vf_c_echo!='ok') {$vf_c_retour.="-10";}
      }
      _graal_libere_requete_bd($result);
      $sql_req = "INSERT INTO _nomenclatures_fab SELECT $vl_e_art_cleunik_destination,`art_cleunik_fils` as `art_cleunik_fils`,`noligne` as `noligne`,`quantite` as `quantite`,`unite_quantite` as `unite_quantite`,`nb_decimales_qte` as `nb_decimales_qte`,`blocnotebrut` as `blocnotebrut`,`valeur_complement` as `valeur_complement`,`valeur_complement_type` as `valeur_complement_type`,`base_valorisation` as `base_valorisation`,arrondi_fab as arrondi_fab FROM _nomenclatures_fab where art_cleunik_pere=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
      if($vf_c_echo!='ok') {$vf_c_retour.="-11";}
      if ($vl_duplik_ged==1) {
        $sql_req = "INSERT INTO _documents_rattachement SELECT doc_cleunik,$vl_e_articl,$vl_e_art_cleunik_destination FROM _documents_rattachement where rat_cleunik=$vl_e_art_cleunik_origine and portee = $vl_e_articl";
        $vf_c_echo=_graal_exec_requete($sql_req);
        if($vf_c_echo!='ok') {$vf_c_retour.="-12";}
      }
	}
      if ($vf_c_retour=="") {
        $vf_c_echo="$vl_e_art_cleunik_destination";
        _graal_requete_bd("COMMIT;");
      } else {
        $vf_c_echo="-13|$vf_c_retour|";
        _graal_requete_bd("ROLLBACK;");
      }
    break;
  case $vf_c_action=="dupliquer_compta_reference":
  	$vl_e_art_cleunik_origine=0;
  	$sql_req = "INSERT IGNORE INTO _art_compta SELECT $vl_e_art_cleunik,catcompta_cleunik,pc_cleunik_vente,pc_cleunik_achat,taxes_cleunik,tpf_cleunik,tpf_cleunik_01 FROM _art_compta where art_cleunik=$vl_e_art_cleunik_origine";
      $vf_c_echo=_graal_exec_requete($sql_req);
  	break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
