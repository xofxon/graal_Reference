<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_c_qui=fa_recup_param('vl_c_qui','favoris');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_inactif=intval(fa_recup_param('vl_e_inactif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));

$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));

$vl_e_compta_cleunik=intval(fa_recup_param('vl_e_compta_cleunik','0'));
$vl_e_tva_cleunik=intval(fa_recup_param('vl_e_tva_cleunik','0'));

$vl_condition_01=" and p0.catcompta_cleunik=$vl_e_compta_cleunik and p0.taxes_cleunik=$vl_e_tva_cleunik";
switch ($vl_e_actif) {
  case '3': // Panier ou requête
    include("_graal_req_panier_articles.php");
    $sql_req = "SELECT _article.actif,_article.code,_article.description,_article.art_cleunik,p4.denomination as denomination_tva,p4.code as code_tva,p4.taxes_cleunik
 FROM _art_compta p0 left join _article on p0.art_cleunik=_article.art_cleunik left join _param_taxes p4 on p4.taxes_cleunik=p0.taxes_cleunik where art_cleunik IN($vl_art_cleunik) $vl_condition_01";
    break;
  case '1': 
  case '2': 
  case '0':
    switch ($vl_c_type) {
      case '0': //  Liste de clés
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_article');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        unset($_SESSION["$vl_c_var"]);
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_art_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_art_cleunik!="") {
          $vl_art_cleunik=substr($vl_art_cleunik, 0, -1);
        }  else {
          $vl_art_cleunik="-99999999";
        }
        $sql_req = "SELECT _article.actif,_article.code,_article.description,_article.art_cleunik,p4.denomination as denomination_tva,p4.code as code_tva,p4.taxes_cleunik
 FROM _art_compta p0 left join _article on p0.art_cleunik=_article.art_cleunik left join _param_taxes p4 on p4.taxes_cleunik=p0.taxes_cleunik where _article.art_cleunik in($vl_art_cleunik) $vl_condition_01";
        break;
      case '1': //  recherche orthographique 
        $sql_req = "SELECT _article.actif,_article.code,_article.description,_article.art_cleunik,p4.denomination as denomination_tva,p4.code as code_tva,p4.taxes_cleunik
 FROM _art_compta p0 left join _article on p0.art_cleunik=_article.art_cleunik left join _param_taxes p4 on p4.taxes_cleunik=p0.taxes_cleunik where 1 $vl_condition_01";
        switch ($vl_c_qui) {
          case 'tous': break;//tous
          case 'favoris': $sql_req.= " AND _article.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
          case 'achats' : $sql_req.= " AND _article.types_gestion & 1";break;
          case 'ventes' : $sql_req.= " AND _article.types_gestion & 2";break;
          case 'stocks' : $sql_req.= " AND _article.types_gestion & 4";break;        
          case 'fabrication': $sql_req.= " AND _article.types_gestion & 8";break;        
        }
        switch ($vl_c_validite) {
          case '': break;
          default: $sql_req.=" and (_article.dateheurevalidite >= '$vl_c_validite' or _article.dateheurevalidite is null)";break;  
          }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" and _article.description like '$vl_c_recherche%'";break;//  Description courte
          case '2': $sql_req.=" and _article.code like '$vl_c_recherche%'";break;//  Code
          case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%'";break;//  Mnémotechnique
        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            switch ($vl_e_actif) {
              case 1: $sql_req.= " AND _article.actif=1";break;// Actifs
              case 2: $sql_req.= " AND _article.actif=2";break;// Inactifs
              case 0: break;// Tous
            }
            break;
          default:
            switch ($vl_e_choix_cleunik) {
              case '0': //  on recherche sur le critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _article.art_cleunik in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where critere_cleunik=$vl_e_critere_cleunik)";break;
                  case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where critere_cleunik=$vl_e_critere_cleunik)";break;
                }
                break;
              default:
                //  on recherche sur le choix du critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _article.art_cleunik in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik in($vl_e_choix_cleunik))";break;
                  case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik in ($vl_e_choix_cleunik) and critere_cleunik=$vl_e_critere_cleunik)";break;
                  //case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik not in($vl_e_choix_cleunik))";break;
                }
              break;
            }
            $sql_req.= " AND _article.actif in($vl_e_actif,$vl_e_inactif)";
        }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" ORDER BY `description` ASC";break;//  Description courte
          case '2': $sql_req.=" ORDER BY `code` ASC";break;//  Code
          case '3': $sql_req.=" ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            $sql_req.= " LIMIT 0, $vl_e_limit";
            break;
          default:
        }
    }
}

switch ($vl_c_sortie) {
  case "das":
    $result = _graal_requete_bd($sql_req);
    echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		    echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		    echo(' description="'.fa_ent_xml($row['description']).'"');
		    echo(' code="'.fa_ent_xml($row['code']).'"');
		    echo(' denomination_tva="'.fa_ent_xml($row['denomination_tva']).'"');
		    echo(' code_tva="'.fa_ent_xml($row['code_tva']).'"');
		    echo(' tva_cleunik="'.fa_ent_xml($row['taxes_cleunik']).'"');
		    if ($row['actif']==1) {
		    	echo(' properties=""');
		    } else {
		        echo(' properties="css_0001"');
		    }
			echo('/>');
		}
		echo('</donnees>');
    _graal_libere_requete_bd($result);
    _graal_ferme_connexion();
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
