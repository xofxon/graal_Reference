<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
include("_graal_var_portee.php");
include("_graal_fonctions_documents.php");
set_time_limit(6000);
$vl_c_modele=fa_recup_param('vl_c_modele','0');
$vl_c_sep=fa_recup_param('separateur','1');
$vl_c_nom_fichier=fa_recup_param('vl_c_nom_fichier','??');
$vl_c_hash=fa_recup_param('hash','');
$vl_c_ged=intval(fa_recup_param('ged','2'));
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_genreacteur=intval(fa_recup_param('vl_e_genreacteur','0'));
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
//session_write_close();

switch ($vl_c_sep) {
  case '1':$sep=';';break;
  case '2':$sep=',';break;
  default:$sep=',';break;
}
//  On attend une première ligne avec le descriptif des colonnes
//  On attend trois colonnes
$name=$_FILES['filename']['name'];
$size=$_FILES['filename']['size'];
$tmp=$_FILES['filename']['tmp_name'];
$type=$_FILES['fichier']['type'];
$error=$_FILES['fichier']['error'];
$row=0;
$sep_ret='|';
$vf_c_echo='';
$o_import=new _graal_import();
$o_import->req="INSERT INTO _w_import_acteurs_ligne_01 (imp_cleunik,lig_cleunik,codealphanum15,raisonsoc,nomcommercial,siret) VALUES ";
$retour='1'.$sep_ret."C'est tout bon.".$sep_ret;
$vf_e_imp_cleunik=_graal_requete_max("imp_cleunik","_w_import_acteurs_entete");
$vf_e_lig_cleunik=_graal_requete_max("lig_cleunik","_w_import_acteurs_ligne_01");
if (!$handle = fopen($tmp, "r")) {
  $retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
} else {
	//	insertion dans la GED, le cas échéant
	if ($vl_c_ged==1){
		//  Vérification que le hash du document ne soit pas déjà présent
    $sql_req = "select count(*) FROM _documents WHERE hash = '$vl_c_hash';";
    if ($res = _graal_requete_bd($sql_req)) {
      $ligne = mysql_fetch_row($res);
      $nombre_doc=$ligne[0];
			_graal_libere_requete_bd($res);
      if ($nombre_doc==0){
				$type=fa_mime_type_buffer(file_get_contents($tmp));
				$type=addslashes($type);
				$vl_c_nom_fichier=addslashes($vl_c_nom_fichier);
				$contenu_fichier=addslashes(file_get_contents($tmp));
				if ($contenu_fichier===false) {
					die('-1'.$sep_ret."Impossible de lire le fichier ($tmp)".$sep_ret);
				}
				$vf_e_doc_cleunik=_graal_requete_max("doc_cleunik","_documents");
			  $typedoc=3;   //  Un document d'entreprise
			  $vf_c_retour=fa_insere_document($vf_e_doc_cleunik,"Import fichier adresses de courriel $vl_c_nom_fichier",$typedoc,$size,$tmp,"entrep",0,"","","","");
      } else {
      	$vf_c_echo='ok';	//	déjà dans la base
      }
    }
    else {
      _graal_libere_requete_bd($res);
    }
	}
	if ($vf_c_echo!='ok') {
		$retour='-1'.$sep_ret.$vf_c_echo.$sep_ret;
		die($retour);
	}
	$vf_c_echo="";
	$row=0;
  switch ($vl_c_modele) {
    case "1": //  Modèle 1 voir http://wiki.xsoftware.fr/mediawiki/index.php?title=Importer_des_acteurs
      while (($data = fgetcsv($handle, 0, "$sep")) !== FALSE) {
        $num = count($data);
        $row++;
        if ($row==1) {
          if ($num!=4) {
            $vf_c_echo="Le nombre de colonnes ($num) est incorrect.";
            break;
          } else {
            $sql_req_02="";
            $i=0;$i1=500;
            $sql_req00="INSERT INTO _w_import_acteurs_entete (imp_cleunik,description,blocnotebrut,dateheurecreation,typeimport,hash,genreimport) VALUES ($vf_e_imp_cleunik,'".addslashes("Import fichier $vl_c_nom_fichier ")."','".addslashes("Taille $size")."',now(),$vl_c_modele,'$vl_c_hash',$vl_e_genreacteur)";
            $result_00=_graal_requete_bd($sql_req00);
            if($result_00 === false) {$vf_c_echo='Erreur 00 ->'.$sql_req_02;}
          }
        } else {
          $i++;
          $vl_c_codealphanum15=addslashes($data[0]);
          $vl_c_raisonsoc=addslashes($data[1]);
          $vl_c_nomcommercial=addslashes($data[2]);
          $vl_c_siret=addslashes($data[3]);
          $vf_e_lig_cleunik++;
          $o_import->dat.="($vf_e_imp_cleunik,$vf_e_lig_cleunik,'$vl_c_codealphanum15','$vl_c_raisonsoc','$vl_c_nomcommercial','$vl_c_siret'),";
          if ($i % $i1==0){
            $o_import->execute();
          }
        }
      }
      $o_import->execute();
      break;
  }
  fclose($handle);
  if ($vf_c_echo!='') {$retour='-1'.$sep_ret.$vf_c_echo.$sep_ret;} else {$retour=$vf_e_imp_cleunik.$sep_ret."Préparé $row acteurs ...".$sep_ret;}
}
echo $retour;
?>
