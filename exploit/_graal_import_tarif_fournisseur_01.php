<?php
define('EOL', "\r\n");
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
include("_graal_var_portee.php");
set_time_limit(6000);
$vl_c_modele=fa_recup_param('vl_c_modele','1');
$vl_c_sep=fa_recup_param('separateur','2');
$vl_c_nom_fichier=fa_recup_param('vl_c_nom_fichier','??');
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
//session_write_close();

switch ($vl_c_sep) {
  case '1':$sep=',';break;
  case '2':$sep=';';break;
  default:$sep=',';break;
}
//  On attend une première ligne avec le descriptif des colonnes
//  On attend trois colonnes
$name=$_FILES['filename']['name'];
$size=$_FILES['filename']['size'];
$tmp=$_FILES['filename']['tmp_name'];
$type=$_FILES['fichier']['type'];
$error=$_FILES['fichier']['error'];
$row=0;
$sep_ret='|';
$vf_c_echo='';
$o_import=new _graal_import();
//$o_import->req="INSERT INTO _w_import_01 (col_001,col_002,col_003,col_004,col_005,col_006,col_007,col_008,col_009,col_010,col_011,col_012,col_013,col_014,col_015,col_016,col_017,col_018,col_019) VALUES ";
$retour='1'.$sep_ret."C'est tout bon.".$sep_ret;
$vf_e_col_001=_graal_requete_max("col_001","_w_import_01");
$i1=500;
if (!$handle = fopen($tmp, "r")) {
  $retour='-1'.$sep_ret."Impossible d'ouvrir le fichier ($tmp)".$sep_ret;
} else {
	$vf_c_echo="";
	$row=0;
  switch ($vl_c_modele) {
    case "1": //  Modèle 17 colonnes pour importation tarifs fournisseurs
      $o_import->req="INSERT INTO _w_import_01 (col_001,col_002,col_003,col_004,col_005,col_006,col_007,col_008,col_009,col_010,col_011,col_012,col_013,col_014,col_015,col_016,col_017,col_018) VALUES ";
    	while (($data = fgetcsv($handle, 0, "$sep")) !== FALSE) {
        $num = count($data);
        $row++;
        if ($row==1) {
          if ($num!=17) {
            $vf_c_echo="Le nombre de colonnes ($num) est incorrect.";
            break;
          }
        } else {
          $i++;
          $col_002=fa_nt(addslashes(utf8_decode(trim($data[ 0]))));
          $col_003=fa_nt(addslashes(utf8_decode(trim($data[ 1]))));
          $col_004=fa_nt(addslashes(utf8_decode(trim($data[ 2]))));
          $col_005=fa_nt(addslashes(utf8_decode(trim($data[ 3]))));
          $col_006=fa_nt(addslashes(utf8_decode(trim($data[ 4]))));
          $col_007=fa_nt(addslashes(utf8_decode(trim($data[ 5]))));
          $col_008=fa_nt(addslashes(utf8_decode(trim($data[ 6]))));
          $col_009=fa_nt(addslashes(utf8_decode(trim($data[ 7]))));
          $col_010=fa_nt(addslashes(utf8_decode(trim($data[ 8]))));
          $col_011=fa_nt(addslashes(utf8_decode(trim($data[ 9]))));
          $col_012=fa_nt(addslashes(utf8_decode(trim($data[10]))));
          $col_013=fa_nt(addslashes(utf8_decode(trim($data[11]))));
          $col_014=fa_nt(addslashes(utf8_decode(trim($data[12]))));
          $col_015=fa_nt(addslashes(utf8_decode(trim($data[13]))));
          $col_016=fa_nt(addslashes(utf8_decode(trim($data[14]))));
          $col_017=fa_nt(addslashes(utf8_decode(trim($data[15]))));
          $col_018=fa_nt(addslashes(utf8_decode(trim($data[16]))));
          $o_import->dat.="($vf_e_col_001,$col_002,$col_003,$col_004,$col_005,$col_006,$col_007,$col_008,$col_009,$col_010,$col_011,$col_012,$col_013,$col_014,$col_015,$col_016,$col_017,$col_018),";
          if ($i % $i1==0){
            $o_import->execute();
          }
        }
      }
      //echo $o_import->sql.$o_import->dat;
      $o_import->execute();
      break;
    
  }
  fclose($handle);
  if ($vf_c_echo!='') {$retour='-1'.$sep_ret.$vf_c_echo.$sep_ret;} else {$retour=$vf_e_col_001.$sep_ret."Préparé $row importations ...".$sep_ret;}
}
echo $retour;
?>
