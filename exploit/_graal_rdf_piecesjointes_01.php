<?php
include("_graal_header_xml.inc.php");
$vl_e_uti_cleunik=intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_c_recherche=fa_recup_param('vl_c_recherche',"ZZZZZZZZZZZZZZZZZZZZZZZZZZ");
$vl_c_type=fa_recup_param("vl_c_type","???");
define('EOL', "\r\n");
// execution de la requète SQL
$req_fav="and _documents.doc_cleunik in (select doc_cleunik from _documents_favoris where uti_cleunik=$vl_e_uti_cleunik";
$sql_req_01="SELECT _documents.doc_cleunik,emplacement,mime,hash,(select count(*) from _courriel_pj_action,_actions where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nombre,'courriels reçus' as genre from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _courriel_pj_action.doc_cleunik from _courriel_pj_action,_actions,_documents where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik and _actions.choix_cleunik in(-110102))";
$sql_req_02="SELECT _documents.doc_cleunik,emplacement,mime,hash,(select count(*) from _courriel_pj_action,_actions where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nombre,'courriels envoyés' as genre from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _courriel_pj_action.doc_cleunik from _courriel_pj_action,_actions,_documents where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik and _actions.choix_cleunik in(-110103,-110104))";
$sql_req_03="SELECT _documents.doc_cleunik,emplacement,mime,hash,(select count(*) from _courriel_pj_action,_actions where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nombre,'courriels reçus' as genre from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _courriel_pj_action.doc_cleunik from _courriel_pj_action,_actions,_documents where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik and _actions.choix_cleunik in(-110102) $req_fav))
union all
SELECT _documents.doc_cleunik,emplacement,mime,hash,(select count(*) from _courriel_pj_action,_actions where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik) as nombre,'courriels envoyés' as genre from _documents where emplacement like '$vl_c_recherche%' and _documents.doc_cleunik in (select distinct _courriel_pj_action.doc_cleunik from _courriel_pj_action,_actions,_documents where _documents.doc_cleunik=_courriel_pj_action.doc_cleunik and _courriel_pj_action.action_cleunik=_actions.action_cleunik and _actions.choix_cleunik in(-110103,-110104) $req_fav))";
switch ($vl_c_type) {
  case 'recfav':
    $sql_req=$sql_req_03;
    break;
  case 'rectou':
    $sql_req=$sql_req_01." union all ".$sql_req_02;
    break;
  case 'recenv':
    $sql_req=$sql_req_02;
    break;
  case 'recrec':
    $sql_req=$sql_req_01;
    break;
}
//echo $sql_req;
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
while ($row = mysql_fetch_assoc($result)){
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:doc_cleunik>'.fa_ent_xml($row['doc_cleunik']).'</row:doc_cleunik>');
  echo('<row:nom>'.fa_ent_xml($row['emplacement']).'</row:nom>');
  //echo('<row:mime>'.fa_ent_xml($row['mime']).'</row:mime>');
  echo('<row:hash>'.fa_ent_xml($row['hash']).'</row:hash>');
  echo('<row:nombre>'.fa_ent_xml($row['nombre']).'</row:nombre>');
  echo('<row:genre>'.fa_ent_xml($row['genre']).'</row:genre>');
  echo('</RDF:Description>');
  echo('</RDF:li>');
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
