<?php
include("_graal_header_txt.inc.php");
require("_graal_fonctions_mail.php");
define('EOL', "\r\n");
$t_origines_ok=array();
//$t_origines_ok[0]="_graal_traitements_courriel_01";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
switch ($vf_c_action) {
	case "verif_existence_email_interlo":
		$vl_e_int_cleunik=intval(fa_recup_param('vl_e_int_cleunik','-2'));
		$sql_req = "SELECT intweb_cleunik as intweb_cleunik,refweb as refweb from _act_interlo_mail where int_cleunik=$vl_e_int_cleunik;";
		break;
	case "verif_existence_email_acteur":
		$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','-2'));
		$sql_req = "SELECT intweb_cleunik as intweb_cleunik,refweb as refweb from _act_interlo_mail where act_cleunik=$vl_e_act_cleunik;";
		break;
}
session_write_close(); //  Nécessaire pour éviter le blocage du au trop long traitements de vérifiaction d'existence des courriels voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
$result = _graal_requete_bd($sql_req);
$nombre=mysql_num_rows($result);
$i=0;
/*
echo('<sql data="');
echo("$sql_req");
echo('"</sql>');
*/
while ($row = mysql_fetch_assoc($result)) {
	$vl_c_mailacontroler=$row['refweb'];
  
	$retour=verif_email($vl_c_mailacontroler,false);
  $sql_req_01="UPDATE _act_interlo_mail set dateheureverification=now(),cr_verification='".addslashes($retour[1])."' where intweb_cleunik=".$row['intweb_cleunik'].";";
  $result_01=_graal_requete_bd($sql_req_01);
  $vl_c_syntaxe_courriel=$retour[1];
	$i++;
  echo($i."/".$nombre.":".$vl_c_mailacontroler." -> ".$vl_c_syntaxe_courriel.EOL);
	flush();
}			
_graal_ferme_connexion();
?>
