<?php
include("_graal_header_xml.inc.php");

$prop_obsolete="css_0001";
// execution de la requète SQL
$vl_e_action_cleunik=fa_recup_param("vl_e_action_cleunik","-1");
$vl_e_limit=fa_recup_param("vl_e_limit","-1");
session_write_close();
if ($vl_e_limit==-1){
	$vl_c_limit="";
} else {
	$vl_c_limit=" LIMIT $vl_e_limit";
}
/*
 * désactivé le 21 décembre 2008 car beaucoup beaucoup trop long
//	Suppression des enregistrements présents dans la file d'attente mais déjà envoyés
$sql_req="delete from _emailing_cleweb_attente where action_cleunik=$vl_e_action_cleunik and intweb in(select intweb from _emailing_cleweb where action_cleunik=$vl_e_action_cleunik);";
$vf_c_echo=_graal_exec_requete($sql_req);
*/
/*
 * le 21 décembre, la conversation suivante 
 * http://www.developpez.net/forums/d662438/bases-donnees/mysql/requetes/optimisation-delete/
 * apporte la lumière
 */
$sql="DELETE a
FROM _emailing_cleweb_attente a
INNER JOIN _emailing_cleweb c ON a.intweb = c.intweb
  AND a.action_cleunik = c.action_cleunik
WHERE a.action_cleunik = $vl_e_action_cleunik";
$vf_c_echo=_graal_exec_requete($sql_req);
$sql_req="select `f1`.`intweb_cleunik` AS `intweb_cleunik`,`f1`.`int_cleunik` AS `int_cleunik`,`f2`.`act_cleunik` AS `act_cleunik`,`f1`.`refweb` AS `refweb`,concat_ws(_utf8' ',`f2`.`prenom`,`f2`.`patronyme`) AS `prenom_nom`,f1.valide as mail_valide,f2.actif as interlo_actif,f3.nomcommercial,f3.actif as acteur_actif,f3.typeacteur as typeacteur from (`_act_interlo_mail` `f1` left join `_act_interlo` `f2` using(`int_cleunik`) left join _acteurs f3 on f3.act_cleunik=f2.act_cleunik join _emailing_cleweb_attente f4 on f1.intweb_cleunik=f4.intweb) where f4.action_cleunik=$vl_e_action_cleunik $vl_c_limit;";
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' refweb="'.fa_ent_xml($row['refweb']).'"');
  echo(' prenom_nom="'.fa_ent_xml($row['prenom_nom']).'"');
  echo(' nomcommercial="'.fa_ent_xml($row['nomcommercial']).'"');
	if ($row['mail_valide']==2){
		echo(' prop_ref_web="'.$prop_obsolete.'"');
	} else {
		echo(' prop_ref_web=""');
	}
	if ($row['acteur_actif']==2){
		echo(' prop_acteur="'.$prop_obsolete.'"');
	} else {
		echo(' prop_acteur=""');
	}
	if ($row['interlo_actif']==2){
		echo(' prop_interlo="'.$prop_obsolete.'"');
	} else {
		echo(' prop_interlo=""');
	}
	echo(' int_cleunik="'.fa_ent_xml($row['int_cleunik']).'"');
	echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
	echo(' intweb_cleunik="'.fa_ent_xml($row['intweb_cleunik']).'"');
	echo(' typeacteur="'.fa_ent_xml($row['typeacteur']).'"');
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
