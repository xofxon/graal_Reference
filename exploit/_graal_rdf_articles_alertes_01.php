<?php
include("_graal_header_xml.inc.php");
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));  
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));
$vl_e_qte_nulle=intval(fa_recup_param("vl_e_qte_nulle",'3'));
define('EOL', "\r\n");
// execution de la requète SQL
$sql_req="SELECT _art_stock.art_cleunik as `art_cleunik`,qte_stock as `qte_stock`,_choix.choix_valeur_texte_01 as 'unite',"._graalsql_date('_art_stock.dateheure_dermvt')." as `dateheure_dermvt` ,_art_stock.dateheure_dermvt as `dateheure_dermvt_tri`,nb_decimales_qte as `nb_decimales_qte`,_article.code as `code`,_article.mnemotechnique as `mnemotechnique`,_article.description as `description`,_article.actif as `actif`,qte_alerte as `qte_alerte`,qte_securite as `qte_securite`,qte_mini as `qte_mini`,qte_maxi as `qte_maxi` FROM _art_stock left join _article using(art_cleunik) left join _choix on choix_cleunik=unite_stock where 1";
switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND _article.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND _article.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND _article.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND _article.types_gestion & 4";break;        
  case 'fabrication': $sql_req.= " AND _article.types_gestion & 8";break;        
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND _article.actif=1";break;// Actifs
  case 2: $sql_req.= " AND _article.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_validite) {
  case '': break;
  default: $sql_req.=" and (_article.dateheurevalidite >= '$vl_c_validite' or _article.dateheurevalidite is null)";break;  
}
switch ($vl_e_qte_nulle) {
  case 1: $sql_req.= " AND qte_alerte is not NULL=0";break;// Nulle
  case 2: $sql_req.= " AND qte_stock<=qte_alerte";break;// pertinent
  case 3: $sql_req.= " AND qte_alerte is NULL";break;// ceux qui n'ont pas d'alerte
  case 4: $sql_req.= " AND qte_stock<>0";break;// avec un stock
}

switch ($vl_c_zone) {
  case '1': $sql_req.=" and _article.description like '$vl_c_recherche%' ORDER BY `description` ASC";break;//  Description courte
  case '2': $sql_req.=" and _article.code like '$vl_c_recherche%' ORDER BY `code` ASC";break;//  Code
  case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%' ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
$sql_req.= " LIMIT 0, $vl_e_limit";
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
while ($row = mysql_fetch_assoc($result)) {
  $nb_dec=fa_ent_xml($row['nb_decimales_qte']);
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  if ($row['qte_stock']==0) {
    $qte_stock=""; } else 
  {
    $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
  }
  $val_qte_stock=$row['qte_stock']*1000;
  if ($row['qte_alerte']==0) {
    $qte_alerte=""; } else 
  {
    $qte_alerte=fa_reel(fa_ent_xml($row['qte_alerte']),$nb_dec);
  }
  $val_qte_alerte=$row['qte_alerte']*1000;
  if ($row['qte_securite']==0) {
    $qte_securite=""; } else 
  {
    $qte_securite=fa_reel(fa_ent_xml($row['qte_securite']),$nb_dec);
  }
  $val_qte_securite=$row['qte_securite']*1000;
  if ($row['qte_mini']==0) {
    $qte_mini=""; } else 
  {
    $qte_mini=fa_reel(fa_ent_xml($row['qte_mini']),$nb_dec);
  }
  $val_qte_mini=$row['qte_mini']*1000;
  if ($row['qte_maxi']==0) {
    $qte_maxi=""; } else 
  {
    $qte_maxi=fa_reel(fa_ent_xml($row['qte_maxi']),$nb_dec);
  }
  $val_qte_maxi=$row['qte_maxi']*1000;

  echo('<row:art_cleunik>'.fa_ent_xml($row['art_cleunik']).'</row:art_cleunik>');
  echo('<row:code>'.fa_ent_xml($row['code']).'</row:code>');
  echo('<row:mnemotechnique>'.fa_ent_xml($row['mnemotechnique']).'</row:mnemotechnique>');
  echo('<row:description>'.fa_ent_xml($row['description']).'</row:description>');
  echo('<row:qte_stock>'.$qte_stock.'</row:qte_stock>');
  echo('<row:val_qte_stock_old NC:parseType="Integer">'.$val_qte_stock.'</row:val_qte_stock_old>');
  printf('<row:val_qte_stock NC:parseType="Integer">%u</row:val_qte_stock>',$val_qte_stock);
  echo('<row:unite>'.fa_ent_xml($row['unite']).'</row:unite>');
  echo('<row:dateheure_dermvt>'.fa_ent_xml($row['dateheure_dermvt']).'</row:dateheure_dermvt>');
  echo('<row:dateheure_dermvt_tri>'.fa_ent_xml($row['dateheure_dermvt_tri']).'</row:dateheure_dermvt_tri>');
  echo('<row:qte_alerte>'.$qte_alerte.'</row:qte_alerte>');
  //echo('<row:val_qte_alerte NC:parseType="Integer">'.$val_qte_alerte.'</row:val_qte_alerte>');
  printf('<row:val_qte_alerte NC:parseType="Integer">%u</row:val_qte_alerte>',$val_qte_alerte);
  echo('<row:qte_securite>'.$qte_securite.'</row:qte_securite>');
  //echo('<row:val_qte_securite NC:parseType="Integer">'.$val_qte_securite.'</row:val_qte_securite>');
  printf('<row:val_qte_securite NC:parseType="Integer">%u</row:val_qte_securite>',$val_qte_securite);
  echo('<row:qte_mini>'.$qte_mini.'</row:qte_mini>');
  //echo('<row:val_qte_mini NC:parseType="Integer">'.$val_qte_mini.'</row:val_qte_mini>');
  printf('<row:val_qte_mini NC:parseType="Integer">%u</row:val_qte_mini>',$val_qte_mini);
  echo('<row:qte_maxi>'.$qte_maxi.'</row:qte_maxi>');
  //echo('<row:val_qte_maxi NC:parseType="Integer">'.$val_qte_maxi.'</row:val_qte_maxi>');
  printf('<row:val_qte_maxi NC:parseType="Integer">%u</row:val_qte_maxi>',$val_qte_maxi);
  if ($row['actif']==1) {
    echo('<row:properties></row:properties>');
  } else {
    echo('<row:properties>css_0001</row:properties>');
  }
  echo('</RDF:Description>');
  echo('</RDF:li>');
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
