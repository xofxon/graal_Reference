<?php
include("_graal_header_txt.inc.php");
include("_graal_var_portee.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_acteurs_01";
$t_origines_ok[1]="_graal_traitements_acteurs_01";
$t_origines_ok[2]="_graal_traitements_articles_01";
$t_origines_ok[3]="_graal_traitements_courriel_01";
$t_origines_ok[4]="_graal_traitements_interlocuteurs_01";
$t_origines_ok[5]="_graal_fen_paniers_01";
$t_origines_ok[6]="_graal_fen_requetes_perso_01";
$t_origines_ok[7]="_graal_traitements_ged_01";
$t_origines_ok[8]="_graal_traitements_actions_01";
$t_origines_ok[9]="_graal_fen_actions_02";
fa_acces_script();
$vf_c_action=fa_recup_param('vl_c_action','??????');
$vf_c_echo="";
$vl_panier_cleunik=intval(fa_recup_param("vl_panier_cleunik",""));
$vl_uti_cleunik=intval(fa_recup_param("vl_uti_cleunik",""));
$vl_panier_titre=fa_recup_param("vl_panier_titre","");
$vl_panier_portee=intval(fa_recup_param("vl_panier_portee",""));
$vl_panier_requete_selection=fa_recup_param("vl_panier_requete_selection","");
$vl_panier_requete_presentation=fa_recup_param("vl_panier_requete_presentation","");
$vl_panier_requete_selection_enclair=fa_recup_param("vl_panier_requete_selection_enclair","");
$vl_panier_composition=fa_recup_param("vl_panier_composition","");
$vl_panier_type=intval(fa_recup_param("vl_panier_type",""));
$vl_blocnote_riche=fa_recup_param("vl_blocnote_riche","");
$vl_blocnote_brut=fa_recup_param("vl_blocnote_brut","");
$vl_panier_resultat=fa_recup_param("vl_panier_resultat","");
$vl_c_quelsdocs=fa_recup_param("quelsdocs","");
$vl_actif=intval(fa_recup_param("vl_actif",1));
$vl_act_cleunik=intval(fa_recup_param("vl_act_cleunik",0));
$vl_e_uti_cleunik_droits =intval(fa_recup_session('vs_uti_cleunik','0'));
switch (TRUE){
  case $vf_c_action=='verifier_droits_acces': //  Vérification que l'utilisateur a bien accès au document
        $sql_req = "select droits_proprio from _droits_panier where panier_cleunik=$vl_e_panier_cleunik AND uti_cleunik=$vl_e_uti_cleunik_droits";
        $result = _graal_requete_bd($sql_req);
        $row = mysql_fetch_assoc($result);
        $vf_c_echo=$row['droits_proprio'];
        break;
	case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _panier WHERE _panier.panier_cleunik = $vl_panier_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_panier_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="ajouter_panier";
  	switch (true){
  		case (($vl_panier_portee & $vl_e_acteur) == $vl_e_acteur):
  			$vl_panier_requete_selection="SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_acteurs.raisonsoc as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur,codealphanum15 as code,mnemotechnique as mnemotechnique,actif as actif FROM `_acteurs` WHERE _acteurs.act_cleunik in (#panier#) ORDER BY `raisonsoc` ASC";
  			break;
  		case (($vl_panier_portee & $vl_e_articl) == $vl_e_articl) :
  			$vl_panier_requete_selection="SELECT _article.art_cleunik as art_cleunik,_article.code as code,_article.description as description,_article.mnemotechnique as mnemotechnique,_article.types_gestion as types_gestion,_article.actif as actif FROM `_article` where art_cleunik IN(#panier#)";
  			break;
  		case (($vl_panier_portee & $vl_e_refweb) == $vl_e_refweb) :
  			$vl_panier_requete_selection="SELECT intweb_cleunik as intweb_cleunik,refweb FROM _act_interlo_mail where 1=1 and intweb_cleunik in(#panier#)";
  			break;
  		case (($vl_panier_portee & $vl_e_interl) == $vl_e_interl) :
  			$vl_panier_requete_selection="SELECT _acteurs.act_cleunik as act_cleunik, _act_interlo.int_cleunik as int_cleunik, case _acteurs.nomcommercial when '' ";
  			$vl_panier_requete_selection.=" then _acteurs.raisonsoc else _acteurs.nomcommercial END as `raisonsoc`,  _acteurs.nomcommercial as nc, _choix.choix_valeur_texte_01 as civilite,";
  			$vl_panier_requete_selection.=" concat_ws(' ',_act_interlo.prenom,_act_interlo.patronyme) as qui,   _choixact.choix_valeur_texte_01 as portee,_act_interlo.actif,";
  			$vl_panier_requete_selection.=" _acteurs.codealphanum15,_acteurs.mnemotechnique,_acteurs.typeacteur,   _acteurs.blocnotebrut as acteur_bn,_act_interlo.blocnotebrut as ";
  			$vl_panier_requete_selection.=" interlo_bn    from _acteurs,_choix,_choix _choixact,_act_interlo   where _act_interlo.int_cleunik <> 0 and _acteurs.act_cleunik = ";
  			$vl_panier_requete_selection.=" _act_interlo.act_cleunik and _choixact.choix_cleunik = _acteurs.typeacteur and _choix.choix_cleunik = _act_interlo.choix_cleunik  ";
  			$vl_panier_requete_selection.=" and _act_interlo.int_cleunik in(#panier#)";
  			break;
  		case (($vl_panier_portee & $vl_e_action) == $vl_e_action) :
  			$vl_panier_requete_selection="SELECT (SELECT count( * ) AS nombre FROM _graal_act WHERE action_cleunik_gauche =_actions.action_cleunik  OR action_cleunik_droite =";
  			$vl_panier_requete_selection.=" _actions.action_cleunik  )   AS nombre_graal_act,_actions.action_cleunik,_actions.choix_cleunik,dateheuredebut,DATE_FORMAT";
  			$vl_panier_requete_selection.="(dateheuredebut, GET_FORMAT(DATE, 'EUR')) as `datedebut`,DATE_FORMAT(dateheuredebut, GET_FORMAT(TIME, 'ISO')) as `heuredebut`,";
  			$vl_panier_requete_selection.=" dateheurefin,DATE_FORMAT(dateheurefin, GET_FORMAT(DATE, 'EUR')) as `datefin`,DATE_FORMAT(dateheurefin, GET_FORMAT(TIME, 'ISO')) as `heurefin`,";
  			$vl_panier_requete_selection.=" _actions.dateheurecreation,_actions.dateheuremodif,description,f2.choix_valeur_texte_01 as genre,f3.choix_valeur_texte_01 as priorite,";
  			$vl_panier_requete_selection.=" _actions.statut as statut_124,f4.choix_valeur_texte_01 as statut,_actions.priorite as priorite_123,_actions.choix_cleunik as genre_094,";
  			$vl_panier_requete_selection.=" f9.choix_valeur_texte_01 as confidentialite_clair,_actions.confidentialite as confi_122, _actions.sujet as `sujet`,";
  			$vl_panier_requete_selection.=" _actions.reference as `reference`,''as `score`,(select count(*) from _documents_rattachement ";
  			$vl_panier_requete_selection.=" where _documents_rattachement.rat_cleunik=_actions.action_cleunik and portee &65536) as nb_pj   FROM _actions ,_choix f2,_choix f3,";
  			$vl_panier_requete_selection.=" _choix f4,_choix f9   where _actions.action_cleunik in (#panier#) and f2.choix_cleunik=_actions.choix_cleunik and ";
  			$vl_panier_requete_selection.=" f3.choix_cleunik=  _actions.priorite and f4.choix_cleunik=_actions.statut and f9.choix_cleunik=_actions.confidentialite ";
  			$vl_panier_requete_selection.=" order by score DESC,_actions.dateheuredebut DESC,_actions.dateheurefin DESC";
  			break;
  	}
  	$vl_panier_requete_selection=addslashes($vl_panier_requete_selection);
    $vl_panier_cleunik=_graal_requete_max("panier_cleunik","_panier");
    $sql_req = "INSERT INTO _panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,panier_titre='$vl_panier_titre',panier_portee=$vl_panier_portee,panier_type=$vl_panier_type,dateheurecreation=now(),panier_resultat='$vl_panier_resultat',panier_requete_selection='$vl_panier_requete_selection',actif=$vl_actif;";
    $vf_c_echo=_graal_exec_requete($sql_req);
    //if($vf_c_echo=='ok') {$vf_c_echo=$vl_panier_cleunik;} else {$vf_c_echo=-1;}
    if($vf_c_echo=='ok') {$vf_c_echo="Ajout correctement effectué.";} else {$vf_c_echo=-1;}
    $droits_groupe=0;
    $droits_lambda=0;
    $vl_e_droits_proprio=1+2+4+8+16;
    $sql_req = "INSERT INTO _droits_panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,droits_proprio=$vl_e_droits_proprio,droits_groupe=$droits_groupe,droits_lambda =$droits_lambda" ;
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="ajouter_lie_representant":
    $vl_panier_cleunik=_graal_requete_max("panier_cleunik","_panier");
    $vl_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
    $vl_panier_requete_selection="select act_cleunik_gauche as act_cleunik from _acteurs_representants where act_cleunik_droite=$vl_act_cleunik union select act_cleunik_droite as act_cleunik from _acteurs_representants where act_cleunik_gauche=$vl_act_cleunik;";
    $sql_req = "INSERT INTO _panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,panier_titre='$vl_panier_titre',panier_portee=$vl_e_acteur,panier_requete_selection='$vl_panier_requete_selection',panier_type=2,dateheurecreation=now(),actif=1";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="Ajout correctement effectué.";} else {$vf_c_echo=-1;}
    $droits_groupe=0;
    $droits_lambda=0;
    $vl_e_droits_proprio=1+2+4+8+16;
    $sql_req = "INSERT INTO _droits_panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,droits_proprio=$vl_e_droits_proprio,droits_groupe=$droits_groupe,droits_lambda =$droits_lambda" ;
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;

  case $vf_c_action=="ajouter":
    $vl_panier_cleunik=_graal_requete_max("panier_cleunik","_panier");
    $sql_req = "INSERT INTO _panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,panier_titre='$vl_panier_titre',panier_portee=$vl_panier_portee,panier_requete_selection='$vl_panier_requete_selection',panier_requete_presentation='$vl_panier_requete_presentation',panier_requete_selection_enclair='$vl_panier_requete_selection_enclair',panier_composition='$vl_panier_composition',panier_type=$vl_panier_type,dateheurecreation=now(),blocnote_riche='$vl_blocnote_riche',blocnote_brut='$vl_blocnote_brut',panier_resultat='$vl_panier_resultat',actif=$vl_actif";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="Ajout correctement effectué.";} else {$vf_c_echo=-1;}
    $droits_groupe=0;
    $droits_lambda=0;
    $vl_e_droits_proprio=1+2+4+8+16;
    $sql_req = "INSERT INTO _droits_panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,droits_proprio=$vl_e_droits_proprio,droits_groupe=$droits_groupe,droits_lambda =$droits_lambda" ;
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="ajouter_req_manu_perso":
    switch ($vl_c_quelsdocs) {
      case "medoc"   :  //Mes requêtes personnelles
        $vl_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
        $vl_panier_cleunik=_graal_requete_max("panier_cleunik","_panier");
        break;
      case "nosdocs" :  // Les requêtes communes
        $vl_uti_cleunik=0;
        $vl_panier_cleunik=_graal_requete_max_particuliere("panier_cleunik","_panier",0,9999999);
        break;
    }
    $sql_req = "INSERT INTO _panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,panier_titre='$vl_panier_titre',panier_portee=$vl_panier_portee,panier_requete_selection='$vl_panier_requete_selection',panier_type=2,dateheurecreation=now(),blocnote_riche='$vl_blocnote_riche',blocnote_brut='$vl_blocnote_brut',actif=$vl_actif";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo="Ajout correctement effectué.";} else {$vf_c_echo=-1;}
    $droits_groupe=0;
    $droits_lambda=0;
    $vl_e_droits_proprio=1+2+4+8+16;
    $sql_req = "INSERT INTO _droits_panier set panier_cleunik=$vl_panier_cleunik,uti_cleunik=$vl_uti_cleunik,droits_proprio=$vl_e_droits_proprio,droits_groupe=$droits_groupe,droits_lambda =$droits_lambda" ;
    $vf_c_echo=_graal_exec_requete($sql_req);
    break;
  case $vf_c_action=="completer_panier":
    $sql_req = "UPDATE _panier dateheuremodif=Now(),panier_resultat=panier_resultat+'$vl_panier_resultat' WHERE _panier.panier_cleunik = $vl_panier_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_panier_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier_infos_gene":
    $sql_req = "UPDATE _panier set panier_titre='$vl_panier_titre',dateheuremodif=Now(),blocnote_brut='$vl_blocnote_brut',actif=$vl_actif WHERE _panier.panier_cleunik = $vl_panier_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_panier_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _panier set panier_titre='$vl_panier_titre',panier_portee=$vl_panier_portee,panier_requete_selection='$vl_panier_requete_selection',panier_requete_presentation='$vl_panier_requete_presentation',panier_requete_selection_enclair='$vl_panier_requete_selection_enclair',panier_composition='$vl_panier_composition',panier_type=$vl_panier_type,dateheuremodif=Now(),blocnote_riche='$vl_blocnote_riche',blocnote_brut='$vl_blocnote_brut',panier_resultat='$vl_panier_resultat',actif=$vl_actif WHERE _panier.panier_cleunik = $vl_panier_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_panier_cleunik;} else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier_req_manu_perso":
    $sql_req = "UPDATE _panier set panier_titre='$vl_panier_titre',panier_requete_selection='$vl_panier_requete_selection',dateheuremodif=Now(),blocnote_brut='$vl_blocnote_brut',actif=$vl_actif,panier_requete_selection='$vl_panier_requete_selection',panier_portee=$vl_panier_portee WHERE _panier.panier_cleunik = $vl_panier_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_panier_cleunik;} else {$vf_c_echo=-1;}
    break;

  case $vf_c_action=="??????":
    $vf_c_echo=$vf_c_action;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
