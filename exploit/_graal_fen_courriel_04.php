<?php
include("_graal_header_xul.inc.php");
$vl_e_uti_cleunik=intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_c_genreaction=fa_recup_param("genreaction","aucune");
switch ($vl_c_genreaction) {
  case "envo":$vl_c_id_fenetre="Fen_00754";break;//Importation des courriels envoyés 
  case "recu":$vl_c_id_fenetre="Fen_00755";break;//Importation des courriels reçus
  default:
    fa_redirige("acces_interdit");
    break;
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bqe_100=fa_recup_dico("bqe_100");
$vl_c_bqe_101=fa_recup_dico("bqe_101");
$vl_c_bqe_102=fa_recup_dico("bqe_102");
$vl_c_bqe_103=fa_recup_dico("bqe_103");
$vl_c_bqe_104=fa_recup_dico("bqe_104");
$vl_c_bqe_105=fa_recup_dico("bqe_105");
$vl_c_bqe_106=fa_recup_dico("bqe_106");
$vl_c_bqe_107=fa_recup_dico("bqe_107");
$vl_c_bqe_108=fa_recup_dico("bqe_108");
$vl_c_bqe_116=fa_recup_dico("bqe_116");
//  On recherche tous les comptes possibles pour l'utilisateur        
$vl_compte="";
$sql_req = "SELECT _uti_cpt_bal.uticptbal_cleunik as cleunik,_uti_cpt_bal.titre as titre FROM _uti_cpt_bal,_droits_cpt_bal where _droits_cpt_bal.uti_cleunik=$vl_e_uti_cleunik and _droits_cpt_bal.uticptbal_cleunik=_uti_cpt_bal.uticptbal_cleunik and _uti_cpt_bal.genre = 1 order by titre;";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_b_importation_possible=false;
  $vl_compte.="<label value='$vl_c_bqe_108' />";
}
else {
  $vl_b_importation_possible=true;
  $vl_compte.="<label value='$vl_c_bqe_107'/><menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_emetteur'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)) {
    $vl_compte.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre'])). "' _graal_cleunik='".$row['cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' selected='true'/>";
  }
  $vl_compte.="</menupopup></menulist>";
	$vl_enregistrer='<hbox ><button id="bt_enregistrer" label="'.$vl_c_bqe_106.'" flex="1" oncommand="pf_validation();"/></hbox>';
}
_graal_libere_requete_bd($sql_result);
if ($vl_b_importation_possible==true){
	$vl_compte_total="<hbox id='boite_enregistrer' collapsed='true'>".$vl_enregistrer.$vl_compte."</hbox>";
} else {
	$vl_compte_total="<hbox id='boite_enregistrer' collapsed='true'>".$vl_compte."</hbox>";	
}
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_bqe_100" id="_graal_fen_courriel_04" onload="fa_aa(this);pf_etat_fen('ini')" $c_xmlns>
$vl_c_graal_cp00
END;
include_once("js/_graal_01.js.php");
include("js/_graal_03.js.php");
include("_graal_visites.inc.php");
include("js/_graal_courriel_04.js.php");
echo <<<END
<popup id="graal_cp_li_courriels"><menuitem label="$vl_c_bqe_101" oncommand="pf_supprime_ligne('li_courriels');"/></popup>
	<vbox flex="1">
    <hbox >
      <toolbarbutton class="al02" tooltiptext="$vl_c_bqe_102" id="tb_ouvre_fichiers_disque" oncommand="pf_ouvre_fichiers();"/>
			<button id="bt_explications" label="" flex="1"/>
    </hbox>
    <listbox flex="1" context="graal_cp_li_courriels" id="li_courriels">
      <listhead >
        <listheader label="$vl_c_bqe_103" />
				<listheader label="$vl_c_bqe_104" />
				<listheader label="$vl_c_bqe_105" />
				<listheader label="$vl_c_bqe_116"/>
      </listhead>
      <listcols >
        <listcol flex="10"/>
				<listcol flex="1"/>
				<listcol flex="2"/>
				<listcol flex="1"/>
      </listcols>
    </listbox>
		$vl_compte_total
  </vbox>  
</window>
END;
?>