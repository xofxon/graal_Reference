<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
// execution de la requète SQL
$vl_e_act_cleunik=intval(fa_recup_param('vl_e_act_cleunik','-1'));
$vf_c_genre=fa_recup_param('vf_c_genre','');
$vl_c_qui=fa_recup_param('vl_c_qui','nobody');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_e_typeacteur=intval(fa_recup_param('vl_e_typeacteur','0'));
$vl_c_recherche=fa_recup_param('vl_c_recherche','A');
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_limit=fa_recup_param('limit','1');
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_sortie=fa_recup_param('sortie','das');
$prop_obsolete="css_0001";
switch ($vf_c_genre) {
  case 'A': //  Sélection des sites d'un tiers
		$sql_req="select _acteurs.actif,_acteurs.raisonsoc as raisonsoc,_acteurs.nomcommercial as nomcommercial,_acteurs.act_cleunik as act_cleunik,";
		$sql_req.=" _act_sites.site_cleunik as site_cleunik,_act_sites.refweb as refweb,_act_sites.blocnotebrut as blocnotebrut,_choix.choix_valeur_texte_01 AS typedesite,";
		$sql_req.=" _acteurs.typeacteur as typeacteur from _act_sites, _choix,_acteurs where _act_sites.act_cleunik IN ($vl_e_act_cleunik) and _acteurs.act_cleunik=_act_sites.act_cleunik";
		$sql_req.=" and _choix.choix_cleunik=_act_sites.choix_cleunik";
		$sql_req.= " and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=_acteurs.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		break;
  case 'B':	//	Sélection de sites
		$sql_req="select _acteurs.actif,_acteurs.raisonsoc as raisonsoc,_acteurs.nomcommercial as nomcommercial,_acteurs.act_cleunik as act_cleunik,";
		$sql_req.=" _act_sites.site_cleunik as site_cleunik,_act_sites.refweb as refweb,_act_sites.blocnotebrut as blocnotebrut,_choix.choix_valeur_texte_01 AS typedesite,";
		$sql_req.=" _acteurs.typeacteur as typeacteur from _act_sites, _choix,_acteurs where _acteurs.act_cleunik=_act_sites.act_cleunik";
		$sql_req.=" and _choix.choix_cleunik=_act_sites.choix_cleunik ";
		$sql_req.= " and (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=_acteurs.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
		switch ($vl_c_actifs) {
		  case '3': //  C'est un panier
		    $vl_e_panier=fa_recup_param('vl_e_panier','');
		    $sql_req_panier = "SELECT panier_requete_selection as req,panier_resultat,panier_type,panier_portee FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
		    $result = _graal_requete_bd($sql_req_panier);
		    $row = mysql_fetch_assoc($result);
		    $panier_portee=$row['panier_portee'];
		    if ($row['panier_type']==1) {
		      $vl_act_cleunik=$row['panier_resultat'];
		      _graal_libere_requete_bd($result);
		    } else {
		      $sql_req_panier = $row['req'];
		      _graal_libere_requete_bd($result);
		      $result = _graal_requete_bd($sql_req_panier);
		      $vl_act_cleunik="";
		      while ($row = mysql_fetch_assoc($result)) {
		        $vl_act_cleunik.=$row[act_cleunik].',';
		      }
		      if ($vl_act_cleunik!="") {
		        $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
		      }
		    }
		    switch ($panier_portee) {
		      case 8192+2 ://  prospects clients
		      case 8192+4 ://  clients
		      case 8192+8 ://  Prospects fournisseurs
		      case 8192+16 ://  Fournisseurs
		      case 8192+32 ://  Autres acteurs
		      case 8192+64 ://  Acteurs indéterminés
		      case 4096+2:  //  interlocuteurs de prospects clients
		      case 4096+4:  //  interlocuteurs de clients
		      case 4096+8:  //  interlocuteurs de prospects fournisseurs
		      case 4096+16:  //  interlocuteurs de fournisseurs
		      case 4096+32:  //  interlocuteurs d'autres acteurs
		      case 4096+64:  //  interlocuteurs d'acteurs indéterminés
		        $sql_req.=" and _act_sites.act_cleunik IN ($vl_act_cleunik) ";
		        break;
		    }
		    break;
		  default:
		    switch ($vl_e_typeacteur)  {
		      case '999999':break;
		      case '110000':
		      case '110001':
		      case '110002':
		      case '110003':
		      case '110004':
		      case '110005':
		      case '110006':
		        $sql_req.=" and _acteurs.typeacteur IN ($vl_e_typeacteur)";
		        break;
		      case '888888' : $sql_req.=" and _acteurs.act_cleunik IN (SELECT _acteurs_favoris.act_cleunik from _acteurs_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;
		      default : $sql_req.=" and _acteurs.typeacteur IN ($vl_e_typeacteur)";break;
		    }
		    switch ($vl_c_actifs) {
		      case '1': $sql_req.=" and _acteurs.actif=1";break; //  actifs
		      case '2': $sql_req.=" and _acteurs.actif=2";break;//  inactifs
		      case '0': break;//  tous
		    }
		    switch ($vl_c_zone)  {
		      case '1' : $sql_req.=" and _acteurs.raisonsoc like '$vl_c_recherche%' order by _acteurs.raisonsoc ASC";break;             // Raison sociale
		      case '2' : $sql_req.=" and _acteurs.nomcommercial like '$vl_c_recherche%' order by _acteurs.nomcommercial ASC ";break;    // Nom commercial
		      case '3' : $sql_req.=" and _acteurs.codealphanum15 like '$vl_c_recherche%' order by _acteurs.codealphanum15 ASC";break;   // Code
		      case '4' : $sql_req.=" and _acteurs.mnemotechnique like '$vl_c_recherche%' order by _acteurs.mnemotechnique ASC ";break;  // Mnémotechnique
		      case '7' : $sql_req.=" and _act_sites.refweb like '$vl_c_recherche%' order by _act_sites.refweb ASC";break;         			// Site
		    }
		    $sql_req.=" limit $vl_c_limit";
			}
    break;
}

switch ($vl_c_sortie) {
  	case "das":
		$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		//echo('<donnees sql="'.fa_ent_xml($sql_req).'">');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
				echo(' typeacteur="'.fa_ent_xml($row['typeacteur']).'"');
		    echo(' site_cleunik="'.fa_ent_xml($row['site_cleunik']).'"');
		    echo(' refweb="'.fa_ent_xml($row['refweb']).'"');
		    echo(' typedesite="'.fa_ent_xml($row['typedesite']).'"');
		    echo(' blocnotebrut="'.fa_ent_xml($row['blocnotebrut']).'"');
				echo(' act_cleunik="'.fa_ent_xml($row['act_cleunik']).'"');
				echo(' raisonsoc="'.fa_ent_xml($row['raisonsoc']).'"');
				echo(' nomcommercial="'.fa_ent_xml($row['nomcommercial']).'"');
				if ($row['actif'] ==1) {
			    echo(' prop_act=""');
			  } else {
			    echo(' prop_act="'.$prop_obsolete.'"');
			  }
			echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
		break;
	case "sql":
	    header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
	    break;
}
?>
