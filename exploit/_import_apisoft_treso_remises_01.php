<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_finan');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
$o_unite=new _graal_import();
$o_action=new _graal_import();
$o_unite->req="INSERT INTO $vl_c_base_destination._choix (critere_cleunik,choix_cleunik,choix_code,choix_valeur_texte_01,choix_actif) VALUES ";
//  Recherche pour modes de paiement
$sql_req = "SELECT distinct(ModeP) FROM $vl_c_base_origine.remise where ModeP not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=137)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik++;
  $i++;
  $choix_code=addslashes($row['ModeP']);
  $choix_valeur_texte_01=addslashes($row['ModeP']);
  $o_unite->dat.="(137,$vf_e_choix_cleunik,'$choix_code','$choix_valeur_texte_01',1),";
}
_graal_libere_requete_bd($result);
//  Recherche pour options de remises
$sql_req = "SELECT distinct(`OPtion`) FROM $vl_c_base_origine.remise where `OPtion` not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=145)";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
	if ($row['OPtion']!=""){
	  $vf_e_choix_cleunik++;
	  $i++;
	  $choix_code=addslashes($row['OPtion']);
	  $choix_valeur_texte_01=addslashes($row['OPtion']);
	  $o_unite->dat.="(145,$vf_e_choix_cleunik,'$choix_code','$choix_valeur_texte_01',1),";
	}
}
_graal_libere_requete_bd($result);
//  Insertion des différents choix sur les différents critères
$o_unite->execute();
include("_import_apisoft_sp_array_journaux.php"); //  On recherche les journaux
include("_import_apisoft_sp_array_modepaiement.php");//  On recherche les modes de paiement
include("_import_apisoft_sp_array_optipaiement.php");//  On recherche les options de paiement
$i=0;$b=2000;
$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
$o_unite->req="INSERT INTO $vl_c_base_destination._treso_remise (remise_cleunik,action_cleunik,dateheure,montant,devise,journal_cleunik,mode_paiement,option_remise) VALUES ";
$o_action->req="INSERT INTO $vl_c_base_destination._actions (action_cleunik,choix_cleunik,dateheuredebut,dateheurefin,dateheurecreation,sujet,c_uuid,reference,statut) VALUES ";
//  Lecture de la table des remises
$sql_req = "SELECT `Numero` as `Numero`,`Date` as `Date`,`Montant` as `Montant`,`Banque` as `Banque`,`ModeP` as `ModeP`,`OPtion` as `OPtion`,`FlTransfert` as `FlTransfert`,`Caisse` as `Caisse`,`Devise` as `Devise` FROM $vl_c_base_origine.remise";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
	$remise_cleunik=$row['Numero'];
	$dateheure=addslashes($row['Date']);
	$montant=$row['Montant'];
	switch ($row['Devise']){
		case "E":$devise=122047;break;
		case "F":$devise=122176;break;
		default :$devise=122047;break;
	}
	$code="Remise n° $remise_cleunik";
  $vl_uuid=_graal_requete_uuid();
	$vl_e_trouve_journa=array_search($row['Banque'], $journa_cod);if ($vl_e_trouve_journa===false) {$journal_cleunik=0;} else {$journal_cleunik=$journa_cle[$vl_e_trouve_journa];}
	$vl_e_trouve_mod=array_search($row['ModeP'], $mod_cod);if ($vl_e_trouve_mod===false) {$mode_paiement=-91;} else {$mode_paiement=$mod_cle[$vl_e_trouve_mod];}
	$vl_e_trouve_opt=array_search($row['OPtion'], $opt_cod);if ($vl_e_trouve_opt===false) {$option_remise=-131;} else {$option_remise=$opt_cle[$vl_e_trouve_opt];}
  $o_action->dat.="($vl_action_cleunik,-110127,'$dateheure','$dateheure',now(),'$code','$vl_uuid','$code',-40),";
	$o_unite->dat.="($remise_cleunik,$vl_action_cleunik,'$dateheure',$montant,$devise,$journal_cleunik,$mode_paiement,$option_remise),";
	$i++;
	$vl_action_cleunik++;
	if ($i % $b==0){
    $o_action->execute();
    $o_unite->execute();
  }
}
_graal_libere_requete_bd($result);
$o_action->execute();
$o_unite->execute();
echo("$i remises importées.");
?>
