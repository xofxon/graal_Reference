<?php
include("_graal_header_xml.inc.php");
$vl_e_inv_cleunik=intval(fa_recup_param('vl_e_inv_cleunik',-1));
$vl_e_etat=intval(fa_recup_param('vl_e_etat',0));
$vl_e_inactifs=intval(fa_recup_param('vl_e_inactifs',0));
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$sql_req="SELECT tarif_reference as `tarif_reference`,critere_cleunik FROM _inventaire where inv_cleunik=$vl_e_inv_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_tarif_reference=$row['tarif_reference'];
$vl_critere_cleunik=$row['critere_cleunik'];
_graal_libere_requete_bd($result);
//$sql_req = "SELECT n1.actif as actif,n1.art_cleunik,n3.pr as pr,n3.nbdec_pr as nbdec_pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4";
//  le 6/1/2008 -> souci de requete avec le round et le order by !!!
if ($vl_critere_cleunik!=0) {
$sql_req = "SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik,n3.nbdec_pr,n3.pr as pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven,n6.choix_cleunik,n7.choix_code,n7.choix_valeur_texte_01,n8.nb_decimales_qte,n9.capacite,n10.choix_valeur_texte_01 as unite_capacite,CASE round(n9.capacite*n5.qte_inven,3) WHEN 0 THEN '' ELSE round(n9.capacite*n5.qte_inven,3) END as 'Capacité inventoriée' FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _art_stock n8 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) left join _art_dimensions n9 using(art_cleunik) left join _choix n10 on n9.unite_capacite=n10.choix_cleunik left join _art_choix_fixes n6 using(art_cleunik) left join _choix n7 on n7.choix_cleunik=n6.choix_cleunik where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 and n6.critere_cleunik=$vl_critere_cleunik ";
} else {
  $sql_req = "SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik,n3.nbdec_pr,n3.pr as pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven,n8.nb_decimales_qte,n9.capacite,n10.choix_valeur_texte_01 as unite_capacite,CASE round(n9.capacite*n5.qte_inven,3) WHEN 0 THEN '' ELSE round(n9.capacite*n5.qte_inven,3) END as 'Capacité inventoriée' FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _art_stock n8 using(art_cleunik) left join _art_dimensions n9 using(art_cleunik) left join _choix n10 on n9.unite_capacite=n10.choix_cleunik left join _inventaire_lignes n5 using(art_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 ";
}
switch ($vl_e_etat) {
  case 1:break; //toutes les lignes
  case 2:$sql_req.= " AND n5.etat=0";break;//  Les lignes à inventorier
  case 3:$sql_req.= " AND n5.etat=1";break; //  Lignes déja inventoriées
  case 4:$sql_req.= " AND n5.etat=2";break; //  Lignes sauvegardées
}
switch ($vl_e_inactifs) {
  case 1:$sql_req.= " AND n1.actif=2";break;//  Articles inactifs
  case 2:$sql_req.= " AND n1.actif=1";break; //  Articles actifs
  case 3:break; //toutes les lignes
}
switch ($vl_c_zone)  {
  case '1':$sql_req.=" ORDER BY `description` ASC;";break; //  Description courte
  case '2':$sql_req.=" ORDER BY `code` ASC;";break; //  Code
  case '3':$sql_req.=" ORDER BY `mnemotechnique` ASC;";break; //  Mnémotechnique
  case '4':$sql_req.=" ORDER by choix_code,code;";break;  // critère
}

$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	echo('<quoi ');
  echo(' inv_cleunik="'.fa_ent_xml($row['inv_cleunik']).'"');
  echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
  echo(' description="'.fa_ent_xml($row['description']).'"');
  echo(' code="'.fa_ent_xml($row['code']).'"');
  echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
  echo(' choix_code="'.fa_ent_xml($row['choix_code']).'"');
  echo(' choix_valeur_texte_01="'.fa_ent_xml($row['choix_valeur_texte_01']).'"');
  echo(' etat="'.fa_ent_xml($row['etat']).'"');
  echo(' tr="'.fa_ent_xml($vl_tarif_reference).'"');
  if ($row['derpa']==0) {
    $derpa=""; } else
  {
    $derpa=fa_reel(fa_ent_xml($row['derpa']),$row['nbdec_prix']);
  }
  $val_derpa=$row['derpa']*1000;
  if ($row['pamp']==0) {
    $pamp=""; } else 
  {
    $pamp=fa_reel(fa_ent_xml($row['pamp']),$row['nbdec_prix']);
  }
  $val_pamp=$row['pamp']*1000;
  if ($row['pr']==0) {
    $pr=""; } else 
  {
    $pr=fa_reel(fa_ent_xml($row['pr']),$row['nbdec_pr']);
  }
  $val_pr=$row['pr']*1000;
  if ($row['pr_generique']==0) {
    $pr_generique=""; } else 
  {
    $pr_generique=fa_reel(fa_ent_xml($row['pr_generique']),$row['nbdec_pr']);
  }
  $val_pr_generique=$row['pr_generique']*1000;
  switch ($vl_tarif_reference) {
    case "-4":  //  Rien
      echo(' tarif_reference_theorique="0"');
      printf(' val_tarif_reference_theorique="%011u"',0);
      break;
    case "-1":  //  Dernier prix d'achar
      echo(' tarif_reference_theorique="'.$derpa.'"');
      printf(' val_tarif_reference_theorique="%011u"',$val_derpa);
      break;
    case "-3":  //  PAMP
      echo(' tarif_reference_theorique="'.$pamp.'"');
      printf(' val_tarif_reference_theorique="%011u"',$val_pamp);
      break;
    case "-2":  //  Prix de revient de fabrication
      echo(' tarif_reference_theorique="'.$pr.'"');
      printf(' val_tarif_reference_theorique="%011u"',$val_pr);
      break;
    case "-5":  //  Prix de revient générique</row:inventaire_capacite>
      echo(' tarif_reference_theorique="'.$pr_generique.'"');
      printf(' val_tarif_reference_theorique="%011u"',$val_pr_generique);
      break;

  }
  if ($row['actif']==1) {
    echo(' properties=""');
  } else {
    echo(' properties="css_0001"');
  }
  $vl_qte_inven=$row['qte_inven'];
  $vl_nb_decimales_qte=$row['nb_decimales_qte'];
  $vl_qte_inven=fa_reel($vl_qte_inven,$vl_nb_decimales_qte);
  if ($vl_qte_inven==0) {
    $qte_inven=""; } else 
  {
    $qte_inven=$vl_qte_inven;
  }
  $capacite=fa_ent_xml($row['capacite']);
  if ($capacite!="0.0000") {
    $unite_capacite=fa_ent_xml($row['unite_capacite']);
  } else {
    $capacite="";
    $unite_capacite="";
  }
  $val_qte_inven=$row['qte_inven']*1000;
  echo(' qte_inven="'.$qte_inven.'"');
  printf(' val_qte_inven="%u"',$val_qte_inven);

  echo(' capacite="'.$capacite.'"');
  echo(' unite_capacite="'.$unite_capacite.'"');
  echo(' inventaire_capacite="'.$row['Capacité inventoriée'].'"');
  echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
