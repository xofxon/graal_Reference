<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_inv_cleunik=intval(fa_recup_param('vl_e_inv_cleunik',-1));
$vl_e_etat=intval(fa_recup_param('vl_e_etat',0));
$vl_e_inactifs=intval(fa_recup_param('vl_e_inactifs',0));
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$sql_req="SELECT tarif_reference as `tarif_reference`,critere_cleunik FROM _inventaire where inv_cleunik=$vl_e_inv_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_tarif_reference=$row['tarif_reference'];
$vl_critere_cleunik=$row['critere_cleunik'];
_graal_libere_requete_bd($result);
//$sql_req = "SELECT n1.actif as actif,n1.art_cleunik,n3.pr as pr,n3.nbdec_pr as nbdec_pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4";
//  le 6/1/2008 -> souci de requete avec le round et le order by !!!
if ($vl_critere_cleunik!=0) {
  $sql_req = "SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik,n3.nbdec_pr,n3.pr as pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven,n6.choix_cleunik,n7.choix_code,n7.choix_valeur_texte_01,n8.nb_decimales_qte FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _art_stock n8 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) left join _art_choix_fixes n6 using(art_cleunik) left join _choix n7 using(choix_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 and n6.critere_cleunik=$vl_critere_cleunik ";
} else {
  $sql_req = "SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik,n3.nbdec_pr,n3.pr as pr,n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n1.code as code,n1.description as description, n1.mnemotechnique as mnemotechnique,n5.etat,n5.qte_inven,n5.inv_cleunik as inv_cleunik,n5.qte_inven,n8.nb_decimales_qte FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) left join _art_stock n8 using(art_cleunik) left join _inventaire_lignes n5 using(art_cleunik) where n5.inv_cleunik=$vl_e_inv_cleunik AND n1.types_gestion & 4 ";
}
switch ($vl_e_etat) {
  case 1:break; //toutes les lignes
  case 2:$sql_req.= " AND n5.etat=0";break;//  Les lignes à inventorier
  case 3:$sql_req.= " AND n5.etat=1";break; //  Lignes déja inventoriées
  case 4:$sql_req.= " AND n5.etat=2";break; //  Lignes sauvegardées
}
switch ($vl_e_inactifs) {
  case 1:$sql_req.= " AND n1.actif=2";break;//  Articles inactifs
  case 2:$sql_req.= " AND n1.actif=1";break; //  Articles actifs
  case 3:break; //toutes les lignes
}
switch ($vl_c_zone)  {
  case '1':$sql_req.=" ORDER BY `description` ASC;";break; //  Description courte
  case '2':$sql_req.=" ORDER BY `code` ASC;";break; //  Code
  case '3':$sql_req.=" ORDER BY `mnemotechnique` ASC;";break; //  Mnémotechnique
  case '4':$sql_req.=" ORDER by choix_code,code;";break;  // critère
}
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
/*
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:sql>'.fa_ent_xml($sql_req).'</row:sql>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
*/
while ($row = mysql_fetch_assoc($result)) {
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:inv_cleunik NC:parseType="Integer">'.fa_ent_xml($row['inv_cleunik']).'</row:inv_cleunik>');
  echo('<row:art_cleunik NC:parseType="Integer">'.fa_ent_xml($row['art_cleunik']).'</row:art_cleunik>');
  echo('<row:description>'.fa_ent_xml($row['description']).'</row:description>');
  echo('<row:code>'.fa_ent_xml($row['code']).'</row:code>');
  echo('<row:mnemotechnique>'.fa_ent_xml($row['mnemotechnique']).'</row:mnemotechnique>');
  echo('<row:choix_code>'.fa_ent_xml($row['choix_code']).'</row:choix_code>');
  echo('<row:choix_valeur_texte_01>'.fa_ent_xml($row['choix_valeur_texte_01']).'</row:choix_valeur_texte_01>');
  echo('<row:etat>'.fa_ent_xml($row['etat']).'</row:etat>');
  echo('<row:tr>'.fa_ent_xml($vl_tarif_reference).'</row:tr>');
  if ($row['derpa']==0) {
    $derpa=""; } else
  {
    //$derpa=fa_reel(fa_ent_xml($row['derpa']),4);
    $derpa=fa_reel(fa_ent_xml($row['derpa']),$row['nbdec_prix']);
  }
  $val_derpa=$row['derpa']*1000;
  if ($row['pamp']==0) {
    $pamp=""; } else 
  {
    //$pamp=fa_reel(fa_ent_xml($row['pamp']),4);
    $pamp=fa_reel(fa_ent_xml($row['pamp']),$row['nbdec_prix']);
    
  }
  $val_pamp=$row['pamp']*1000;
  if ($row['pr']==0) {
    $pr=""; } else 
  {
    //$pr=fa_reel(fa_ent_xml($row['pr']),4);
    $pr=fa_reel(fa_ent_xml($row['pr']),$row['nbdec_pr']);
    
  }
  $val_pr=$row['pr']*1000;
  if ($row['pr_generique']==0) {
    $pr_generique=""; } else 
  {
    //$pr=fa_reel(fa_ent_xml($row['pr']),4);
    $pr_generique=fa_reel(fa_ent_xml($row['pr_generique']),$row['nbdec_pr']);
    
  }
  $val_pr_generique=$row['pr_generique']*1000;

  switch ($vl_tarif_reference) {
    case "-4":  //  Rien
      echo('<row:tarif_reference_theorique>0</row:tarif_reference_theorique>');
      printf('<row:val_tarif_reference_theorique NC:parseType="Integer">%u</row:val_tarif_reference_theorique>',0);
      break;
    case "-1":  //  Dernier prix d'achar
      echo('<row:tarif_reference_theorique>'.$derpa.'</row:tarif_reference_theorique>');
      printf('<row:val_tarif_reference_theorique NC:parseType="Integer">%u</row:val_tarif_reference_theorique>',$val_derpa);
      break;
    case "-3":  //  PAMP
      echo('<row:tarif_reference_theorique>'.$pamp.'</row:tarif_reference_theorique>');
      printf('<row:val_tarif_reference_theorique NC:parseType="Integer">%u</row:val_tarif_reference_theorique>',$val_pamp);
      break;
    case "-2":  //  Prix de revient de fabrication
      echo('<row:tarif_reference_theorique>'.$pr.'</row:tarif_reference_theorique>');
      printf('<row:val_tarif_reference_theorique NC:parseType="Integer">%u</row:val_tarif_reference_theorique>',$val_pr);
      break;
    case "-5":  //  Prix de revient générique
      echo('<row:tarif_reference_theorique>'.$pr_generique.'</row:tarif_reference_theorique>');
      printf('<row:val_tarif_reference_theorique NC:parseType="Integer">%u</row:val_tarif_reference_theorique>',$val_pr_generique);
      break;

  }
  if ($row['actif']==1) {
    echo('<row:properties></row:properties>');
  } else {
    echo('<row:properties>css_0001</row:properties>');
  }
  $vl_qte_inven=$row['qte_inven'];
  $vl_nb_decimales_qte=$row['nb_decimales_qte'];
  $vl_qte_inven=fa_reel($vl_qte_inven,$vl_nb_decimales_qte);
  if ($vl_qte_inven==0) {
    $qte_inven=""; } else 
  {
    $qte_inven=$vl_qte_inven;
  }
  $val_qte_inven=$row['qte_inven']*1000;
  echo('<row:qte_inven>'.$qte_inven.'</row:qte_inven>');
  printf('<row:val_qte_inven NC:parseType="Integer">%u</row:val_qte_inven>',$val_qte_inven);

  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
