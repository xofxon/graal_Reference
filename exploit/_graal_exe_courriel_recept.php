<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_cryptage.php");
require("_graal_classe_pop3.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
if (strtoupper(substr(PHP_OS,0,3)=='WIN')) {
  $eol="\r\n";
} elseif (strtoupper(substr(PHP_OS,0,3)=='MAC')) {
  $eol="\r";
} else {
  $eol="\n";
}
/* Uncomment when using SASL authentication mechanisms */
/*
require("sasl.php");
*/

//Il faudrait procéder en 2 temps : 1° temps simple compte et taille des infos à récupérer, 2° temps récupération
set_time_limit(6000);
$sess_id=session_id();
$vl_e_graal_cleunik=intval(fa_recup_param('vl_e_graal_cleunik','0'));
$sql_req = "SELECT compte AS compte FROM _uti_cpt_bal where uticptbal_cleunik=$vl_e_graal_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);

session_write_close();

$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);

$pop3=new pop3_class;
$pop3->hostname=$vl_c_xml->serveurpop3[0]->attributes();                          /* POP 3 server host name                      */
$pop3->port=intval($vl_c_xml->port_pop[0]->attributes());                         /* POP 3 server host port, usually 110 but some servers use other ports Gmail uses 995 */
if ($vl_c_xml->pop_ssl[0]->attributes()==1) {$pop3->tls=1;} else {$pop3->tls=0;}  /* Establish secure connections using TLS      */
$user=$vl_c_xml->utilisateurpop3[0]->attributes();                                /* Authentication user name                    */
$password=$vl_c_xml->motdepassepop3[0]->attributes();                             /* Authentication password                     */
$pop3->realm="";                                                                  /* Authentication realm or domain              */
$pop3->workstation="";                                                            /* Workstation for NTLM authentication         */
$apop=0;                                                                          /* Use APOP authentication                     */
$pop3->authentication_mechanism="USER";                                           /* SASL authentication mechanism               */
$pop3->debug=0;                                                                   /* Output debug information                    */
$pop3->html_debug=1;                                                              /* Debug information is in HTML                */
$pop3->join_continuation_header_lines=1;                                          /* Concatenate headers split in multiple lines */
$vl_c_header="";
$vl_c_corpus="";
$vl_sequence=-1;
$vl_e_nouveau=0;$vl_e_deja=0;$vl_e_idem=0;
if(($error=$pop3->Open())==""){
	if(($error=$pop3->Login($user,$password,$apop))==""){
		if(($error=$pop3->Statistics($messages,$size))==""){
			$vf_c_retour="Il y a $messages message(s) dans la boîte aux lettres ($size octets).".$eol;
			if ($messages!=0) {
        $vl_t_taille=$pop3->ListMessages("",0);
        $vl_t_id=$pop3->ListMessages("",1);
        $vl_sequence=_graal_requete_max_particuliere("sequence","_courriel_recus_brut");
        for($i=0;$i<=$messages;$i++) {
          $sql_req="SELECT courriel_brut_cleunik as cleunik FROM _courriel_recus_brut where idpop='$vl_t_id[$i]';";
          $result=_graal_requete_bd($sql_req);
          $ligne=mysql_fetch_row($result);
          $vl_courriel_brut_cleunik=$ligne[0];
          $vl_c_header="";
          $vl_c_corpus="";
          if ($vl_courriel_brut_cleunik==0) {
            if(($error=$pop3->RetrieveMessage($i,$headers,$body,-1))==""){
  						for($line=0;$line<count($headers);$line++) {
  							$vl_c_header.=$headers[$line].$eol;
  						}
  						for($line=0;$line<count($body);$line++) {
  							$vl_c_corpus.=$body[$line].$eol;
  						}
  						if(($error=$pop3->DeleteMessage($i))==""){
  							//echo "Marked message $i for deletion.".$eol;
  						}
              $ctx = hash_init('sha1');
              hash_update($ctx, addslashes($vl_c_header.$eol.$vl_c_corpus));
              //  On calcule toujours le hasj sur ce que l'on recoit, mais si on traficote le mail ensuite 
              $vl_c_hash=hash_final($ctx);
              //echo $vl_c_hash.$eol;
              $vl_id_pop=$vl_t_id[$i];
              $vl_courriel_brut_cleunik=0;
              $sql_req="SELECT courriel_brut_cleunik as cleunik FROM _courriel_recus_brut where hash='$vl_c_hash';";
              $result=_graal_requete_bd($sql_req);
              $ligne=mysql_fetch_row($result);
              $vl_courriel_brut_cleunik=$ligne[0];
              if ($vl_courriel_brut_cleunik==0) {              
                $vl_courriel_brut_cleunik=_graal_requete_max("courriel_brut_cleunik","_courriel_recus_brut");
                $vl_e_nouveau++;
                $vl_t_courriel_brut_cleunik[$i]=$vl_courriel_brut_cleunik;
                $mime=new mime_parser_class;
                $mime->mbox=0;
                $mime->decode_bodies=1;
                $mime->ignore_syntax_errors=1;
                $mail_init=$vl_c_header.$eol.$vl_c_corpus;
                // remplacement des CR "orphelins" par CRFL
                $definition_00=str_replace("\r\n", "\r",$mail_init);
                $definition_01=str_replace("\r", "\r\n", $definition_00);
                $definition_00="";
                $mail_traficote=$definition_01;
                $definition_01="";
                  //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
                $path="mail/".$sess_id."_".$vl_c_hash;
                $handle_file=fopen($path, 'wb');
								if ($handle_file===false){
									$error.="Impossible d'accéder au répertoire de décodage!!!".$eol;
								}
								$ecritureok=fwrite($handle_file, $mail_traficote);
							  fclose($handle_file);
								if ($ecritureok===0){
									$error.="Impossible de décoder les courriels (fichier vide !!!)".$eol;
								}
                $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$vl_c_hash,'sess_id'=>$sess_id,);
                //$parameters=array('Data'=>$mail_traficote);
                $vl_c_erreur="";
                if(!$mime->Decode($parameters, $decoded)) {
              		$vl_integre=4;
              	 } else {
                  $vl_integre=2;
                  $vl_c_z04=$decoded[0]["Headers"]["date:"];
                  if (($timestamp = strtotime($vl_c_z04)) === false) {
                    if (strtolower(substr($vl_c_z04,-2))=="ut") {
                      $vl_c_z04=substr($vl_c_z04,0,strlen($vl_c_z04)-2)."UTC";
                      if (($timestamp = strtotime($vl_c_z04)) === false) { 
                        $vl_c_z09="19610123060000";
                      } else {
                        $vl_c_z04=date('Y-m-d H:i:s', $timestamp);
                      }
                    } else {
                      $vl_c_z09="19700101000001";
                      $vl_c_z04=date('d-m-Y H:i:s', 1);
                    }
                  } else {
                    $vl_c_z04=date('Y-m-d H:i:s', $timestamp);
                  }
                }
                //$vl_integre=2;
                $vf_c_echo=_graal_exec_requete("INSERT INTO _courriel_recus_brut set courriel_brut_cleunik=$vl_courriel_brut_cleunik,courriel='".addslashes($mail_traficote)."',hash='$vl_c_hash',sequence=$vl_sequence,idpop='$vl_id_pop',integre=$vl_integre,uticptbal_cleunik=$vl_e_graal_cleunik,dateheurereception=now(),dateheuremessage='$vl_c_z04';");
                //echo $vf_c_echo;
                $mime=NULL;
								unlink($handle_file);
              }
              else {
                //echo "pas insert ->".$vl_courriel_brut_cleunik.$eol;
                $vl_t_courriel_brut_cleunik[$i]=$vl_courriel_brut_cleunik;
                $vl_e_idem++;
              }
            }
          }
          else {
            $vl_t_courriel_brut_cleunik[$i]=$vl_courriel_brut_cleunik;
            $vl_e_deja++;
          }
				}
				if(($error=$pop3->ResetDeletedMessages())==""){
					//echo "Resetted the list of messages to be deleted.".$eol;
				}
			}
		}
		if($error=="" && ($error=$pop3->Close())=="") {
			//echo "Disconnected from the POP3 server \"".$pop3->hostname."\"".$eol;
		}
		else {
			$error=$result;
		}
	}
}
if($error!="") {
	echo $error.$eol;
} else {
  $sql_req="SELECT count(*) FROM _courriel_recus_brut where integre=2 and uticptbal_cleunik=$vl_e_graal_cleunik;";
  $result=_graal_requete_bd($sql_req);
  $ligne=mysql_fetch_row($result);
  $vl_e_nb_atraiter=$ligne[0];
  echo $vf_c_retour;
  echo $vl_e_nouveau." nouveau(x)".$eol;
  echo $vl_e_deja." déjà intégré(s)".$eol;
  echo $vl_e_idem." déjà reçu(s)".$eol;
  echo $vl_e_nb_atraiter." à traiter".$eol;
}
?>
