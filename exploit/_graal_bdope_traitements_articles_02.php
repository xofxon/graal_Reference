<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_articles_02";
fa_acces_script();
$vl_c_mess_00018=fa_recup_dico("mess_00018");
$vl_c_mess_00019=fa_recup_dico("mess_00019");
$vl_c_mess_00020=fa_recup_dico("mess_00020");
$vl_c_mess_00021=fa_recup_dico("mess_00021");
$vl_c_mess_00022=fa_recup_dico("mess_00022");
$vl_c_mess_00023=fa_recup_dico("mess_00023");
$vl_c_mess_00024=fa_recup_dico("mess_00024");
$vl_c_mess_00025=fa_recup_dico("mess_00025");
$vl_c_mess_00026=fa_recup_dico("mess_00026");
$vl_c_mess_00027=fa_recup_dico("mess_00027");
$vl_c_mess_00028=fa_recup_dico("mess_00028");
$vl_c_mess_00029=fa_recup_dico("mess_00029");
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
//IMPORTANT IMPORTANT IMPORTANT IMPORTANT Bien penser à utiliser intval pour convertir les données numériques
$vl_t_tarif=fa_recup_param("vl_t_tarif","");
$vl_t_tarif=unserialize(stripslashes($vl_t_tarif));
$vl_c_datevalidite=fa_recup_param("vl_c_datevalidite","");
$vl_c_datedermaj=fa_recup_param("vl_c_datedermaj","");
$vl_e_coeff_maj=fa_floatval(fa_recup_param('vl_e_coeff_maj','1'));
$vl_e_tarif_cleunik=intval(fa_recup_param('vl_e_tarif_cleunik','0'));
$vl_b_transaction_ok=true;
$vl_e_i=-1;
$sql_condition="";
foreach($vl_t_tarif as $vl_raf) {
  $vl_e_i++;
  $vl_tar_cleunik=$vl_t_tarif[$vl_e_i];
  if ($vl_e_i==0) {$sql_condition.= "$vl_tar_cleunik";} else {$sql_condition.= ",$vl_tar_cleunik";};
}
switch (TRUE){
  case $vf_c_action=="kilometres_supprimer";
    $sql_req = "DELETE FROM _art_tarifs WHERE tar_cleunik in($sql_condition);";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00018.$vl_c_mess_err;} else {echo $vl_c_mess_00019;}
    break;
   case $vf_c_action=="kilometres_activer";
    $sql_req = "UPDATE _art_tarifs SET actif=1 WHERE tar_cleunik in($sql_condition);";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00020.$vl_c_mess_err;} else {echo $vl_c_mess_00021;}
    break;
  case $vf_c_action=="kilometres_desactiver";
    $sql_req = "UPDATE _art_tarifs SET actif=2 WHERE tar_cleunik in($sql_condition);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00022.$vl_c_mess_err;} else {echo $vl_c_mess_00023;}
    break;
  case $vf_c_action=="kilometres_datevalidite";
    $sql_req = "UPDATE _art_tarifs SET dateheure_validite='$vl_c_datevalidite' WHERE tar_cleunik in($sql_condition);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00024.$vl_c_mess_err;} else {echo $vl_c_mess_00025;}
    break;
  case $vf_c_action=="kilometres_majtarif";
    $sql_req = "UPDATE _art_tarifs SET ";
    if (substr($vl_c_datevalidite,0,2)!="00") {$sql_req.="_art_tarifs.dateheure_validite='$vl_c_datevalidite',";}
    if (substr($vl_c_datedermaj,0,2)!="00") {$sql_req.="_art_tarifs.dateheure_dermaj='$vl_c_datedermaj',";}
    $sql_req.="_art_tarifs.pu_reference=round(_art_tarifs.pu_reference*$vl_e_coeff_maj,_art_tarifs.nb_dec) WHERE tar_cleunik in($sql_condition);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00026.$vl_c_mess_err;} else {echo $vl_c_mess_00027;}
    break;
  case $vf_c_action=="kilometres_duplicationtarif";
    $i1=500;
    $o_tarif=new _graal_import();
    $o_tarif->req="INSERT INTO _art_tarifs (tar_cleunik,art_cleunik,tarif_cleunik,act_cleunik,pu_reference,actif,dateheure_dermaj,dateheure_validite,blocnotebrut,blocnotertf,type,quantite_basse,quantite_haute,unite_quantite,nb_dec) VALUES ";
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    if (substr($vl_c_datevalidite,0,2)=="00") {$vl_c_datevalidite='NULL';} else {$vl_c_datevalidite="'".$vl_c_datevalidite."'";} 
    if (substr($vl_c_datedermaj,0,2)=="00") {$vl_c_datedermaj='NULL';}  else {$vl_c_datedermaj="'".$vl_c_datedermaj."'";}
    $vl_tar_cleunik_new=_graal_requete_max("tar_cleunik","_art_tarifs");
    foreach($vl_t_tarif as $vl_raf) {
      $vl_e_i++;
      $vl_tar_cleunik=$vl_t_tarif[$vl_e_i];
      $sql_req=" SELECT * from _art_tarifs,_article where _art_tarifs.tar_cleunik=$vl_tar_cleunik and _article.art_cleunik=_art_tarifs.art_cleunik;";
      $result = _graal_requete_bd($sql_req);
      $row = mysql_fetch_assoc($result);
      if ($row['blocnotebrut']==NULL || trim($row['blocnotebrut'])=='') {$blocnotebrut='NULL';} else {$blocnotebrut="'".addslashes($row['blocnotebrut'])."'";}
      if ($row['blocnotertf']==NULL || trim($row['blocnotertf'])=='') {$blocnotertf='NULL';} else {$blocnotertf="'".addslashes($row['blocnotertf'])."'";}
      if ($row['quantite_basse']==NULL) {$quantite_basse='NULL';} else {$quantite_haute=$row['quantite_basse'];}
      if ($row['quantite_haute']==NULL) {$quantite_haute='NULL';} else {$quantite_haute=$row['quantite_haute'];}
      if ($row['unite_quantite']==NULL) {$unite_quantite='NULL';} else {$unite_quantite=$row['unite_quantite'];}
      $o_tarif->dat.="($vl_tar_cleunik_new,".
        $row['art_cleunik'].",".
        $row['tarif_cleunik'].",".
        $row['act_cleunik'].",".
        "round(".($row['pu_reference']*$vl_e_coeff_maj).",".$row['nbdec']."),".
        $row['actif'].",$vl_c_datedermaj,$vl_c_datevalidite,$blocnotebrut,$blocnotertf,".
        $row['type'].",$quantite_basse,$quantite_haute,$unite_quantite,".$row['nb_dec']."),";
      _graal_libere_requete_bd($result);
      $vl_tar_cleunik_new++;
      if ($vl_e_i % $i1==0){$o_tarif->execute();}
    }
    $o_tarif->execute();
    echo ("$vl_e_i+1 tarifs ajoutés.");
    break;
  case $vf_c_action="kilometres_remplacement_acteurs";
    $sql_req = "UPDATE _act_compta SET tarif_cleunik=$vl_e_tarif_cleunik WHERE act_cleunik in($sql_condition);";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo $vl_c_mess_00028.$vl_c_mess_err;} else {echo $vl_c_mess_00029;}
    break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
?>
