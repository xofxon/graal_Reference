<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','tiers');
$vl_e_relation_gauche=intval(fa_recup_param('vl_e_relation_gauche','-6'));
$vl_e_relation_droite=intval(fa_recup_param('vl_e_relation_droite','-11'));
$gau_cod=array();$gau_cle=array();
$sql_req="SELECT act_cleunik,codealphanum15 FROM $vl_c_base_destination._acteurs where typeacteur=110001;"; //  On recherche les prospects
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($gau_cod, $row['codealphanum15']);
  array_push ($gau_cle, $row['act_cleunik']);
}
_graal_libere_requete_bd($result);
$dro_cod=array();$dro_cle=array();
$sql_req="SELECT act_cleunik,codealphanum15 FROM $vl_c_base_destination._acteurs where typeacteur=110005;"; //  On recherche les représentants
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($dro_cod, $row['codealphanum15']);
  array_push ($dro_cle, $row['act_cleunik']);
}
_graal_libere_requete_bd($result);
include("_import_class_data_km.php");
$o_rel=new _graal_import();
$o_rel->req="INSERT INTO $vl_c_base_destination._acteurs_relations (act_cleunik_gauche,act_cleunik_droite,choix_cleunik_gauche,choix_cleunik_droite) VALUES ";
$sql_req = "SELECT Code as `Code`,REP as REP FROM $vl_c_base_origine.$vl_c_fic_tiers order by Code";
$result = _graal_requete_bd($sql_req);
$i=0;$i1=500;
while ($row = mysql_fetch_assoc($result)){
  $vl_e_trouve_gau=array_search($row['Code'], $gau_cod);if ($vl_e_trouve_gau===false) {$act_cleunik_gauche=0;} else {$act_cleunik_gauche=$gau_cle[$vl_e_trouve_gau];}
  $vl_e_trouve_dro=array_search($row['REP'],  $dro_cod);if ($vl_e_trouve_dro===false) {$act_cleunik_droite=0;} else {$act_cleunik_droite=$dro_cle[$vl_e_trouve_dro];}
  if ($act_cleunik_gauche!=0){
    if ($act_cleunik_droite!=0){
      $i++;
      $o_rel->dat.="($act_cleunik_gauche,$act_cleunik_droite,$vl_e_relation_gauche,$vl_e_relation_droite),";
    }
  }
  if ($i % $i1==0){
    $o_rel->execute();
  }
}
$o_rel->execute();
_graal_libere_requete_bd($result);
echo ("Ajouté $i relations prospects clients / Représentants");
?>
