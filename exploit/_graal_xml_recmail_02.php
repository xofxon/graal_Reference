<?php
require("_graal_fonctions_diverses.php");
require("_graal_fonctions_mysql.php");
require("_graal_fonctions_url_absolue.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
define('EOL', "\r\n");
$id_inc_courriel="Div_00472";
_graal_requete_charge_varlib($id_inc_courriel,$vl_e_uti_cleunik);
$vl_c_bof_001=fa_recup_dico("bof_001");
$vl_c_bof_002=fa_recup_dico("bof_002");
$vl_c_bof_005=fa_recup_dico("bof_005");
$vl_c_bof_006=fa_recup_dico("bof_006");
$vl_c_bof_010=fa_recup_dico("bof_010");
$vl_c_bof_011=fa_recup_dico("bof_011");
$vl_c_bof_017=fa_recup_dico("bof_017");
$vl_c_bof_020=fa_recup_dico("bof_020");
$vl_c_bof_021=fa_recup_dico("bof_021");
$vl_c_bof_022=fa_recup_dico("bof_022");
$vl_c_bof_023=fa_recup_dico("bof_023");
$vl_c_bof_024=fa_recup_dico("bof_024");
$vl_c_bof_025=fa_recup_dico("bof_025");
$vl_c_bof_026=fa_recup_dico("bof_026");
$vl_t_id=array();
$vl_t_init=array();
$sess_id=session_id();
$vl_e_action_cleunik=intval(fa_recup_param("action_cleunik","-1"));
$vl_e_recvoc_cleunik=intval(fa_recup_param("recvoc_cleunik","-1"));
$vl_sortie=fa_recup_param("sortie","");
$vl_affiche_images_externes=intval(fa_recup_param("vl_affiche_images_externes","1"));
$sql_req="SELECT _courriel_re.courriel_re_mes_cleunik,sujet,type,datas_vrac,message_html,message_text,header FROM _courriel_re,_courriel_re_mes where action_cleunik=$vl_e_action_cleunik and _courriel_re_mes.courriel_re_mes_cleunik=_courriel_re.courriel_re_mes_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_xml=simplexml_load_string($row['datas_vrac']);
$vl_nb_images=$vl_c_xml->nom_images_integrees_nombre[0]->attributes();
$vl_c_sujet=fa_remplace_quotes(fa_ent_xml($row['sujet']));
$vl_c_message_html=$row['message_html'];
$vl_c_message_text=$row['message_text'];
$vl_c_header=$row['header'];
$vl_e_type=$row['type'];
$vl_courriel_re_mes_cleunik=$row['courriel_re_mes_cleunik'];
_graal_libere_requete_bd($result);
if ($vl_nb_images!=0) {
  $vl_e_i=0;
  for($vl_e_j=0;$vl_e_j<$vl_nb_images;$vl_e_j++){
    $vl_c_id=$vl_c_xml->nom_images_integrees[$vl_e_j]->attributes();
    $sql_req="SELECT image,mime FROM _courriel_images where hash='$vl_c_id';";
    $result=_graal_requete_bd($sql_req);
    if($ligne=mysql_fetch_row($result)) {
      $vl_e_i++;
      $vl_t_id[$vl_e_i]=$vl_c_id;
      $vl_t_init[$vl_e_i]=$genre.'data:'.$ligne[1].';base64,'.$ligne[0];
    } else {
      $vl_e_i++;
      $vl_t_id[$vl_e_i]="Pas trouvé $vl_c_id";
      $vl_t_init[$vl_e_i]="Pas trouvé $vl_c_id";
    }
		_graal_libere_requete_bd($result);
  }
  //  Il faut décoder le message, remplacer les id puis ré-encoder le message
  $posgenre=strpos($vl_c_message_html,'base64,')+7;
  $genre=substr($vl_c_message_html,0,$posgenre);
  $vl_c_adecoder=substr($vl_c_message_html,$posgenre,strlen($vl_c_message_html)-$posgenre);
  $vl_c_message_html=base64_decode($vl_c_adecoder);
  $vl_c_message_html=str_replace($vl_t_id,$vl_t_init,$vl_c_message_html);
  $vl_c_message_html_b64=$genre.base64_encode($vl_c_message_html);
} else {
	if ($vl_affiche_images_externes==0){
  		$vl_c_message_html_b64=$vl_c_message_html;
	} else {
		$vl_c_message_html_b64_avec_images=$vl_c_message_html;
	$posgenre=strpos($vl_c_message_html,'base64,')+7;
	  $genre=substr($vl_c_message_html,0,$posgenre);
	  $vl_c_adecoder=substr($vl_c_message_html,$posgenre,strlen($vl_c_message_html)-$posgenre);
	  $vl_c_message_html=base64_decode($vl_c_adecoder);
	  $vl_c_message_html=str_replace($vl_t_id,$vl_t_init,$vl_c_message_html);
	  $html_no_img = preg_replace('#<img (.+?)>#i', '', $vl_c_message_html);
	  $vl_c_message_html_b64=$genre.base64_encode($html_no_img);
	}
}

$sql_req="SELECT count(*) as nombre,courriel,courriel_brut_cleunik FROM _courriel_recus_brut where action_cleunik=$vl_e_action_cleunik group by courriel,courriel_brut_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_e_nombre_brut=$row['nombre'];
$courriel_brut_cleunik=$row['courriel_brut_cleunik'];
$lengths = mysql_fetch_lengths($result);
$taille_courriel=$lengths[1];
_graal_libere_requete_bd($result);
if ($vl_e_nombre_brut!=0) {
	$vl_c_cache_tab_mail_sour="false";
} else {
	$vl_c_cache_tab_mail_sour="true";
}

$titi=$sql_req;
$toto="";
switch ($vl_sortie) {
  case "xul":
switch ($vl_e_type) {
  case 1:
    $vl_c_tab_01="<tab id='tab_mail_text' linkedpanel='tabpanel_mail_text' label='$vl_c_bof_005' selected='true'/>";
    $vl_c_tab_02="<tab id='tab_mail_html' linkedpanel='tabpanel_mail_html' collapsed='true' label='$vl_c_bof_001'/>";
    $vl_c_tabpanel_01="<tabpanel id='tabpanel_mail_text' flex='1'><toolbarbutton id='bt_emimail_imprimer_text' class='aa05' tooltiptext='$vl_c_bof_017' oncommand='pf_imprime_text();'/><html:iframe flex='10' id='mail_text' src='$vl_c_message_text' /></tabpanel>";
    $vl_c_tabpanel_02="<tabpanel id='tabpanel_mail_html' flex='1'>";
    $vl_c_tabpanel_02.="<toolbarbutton id='bt_emimail_imprimer_html' class='aa05' tooltiptext='$vl_c_bof_017' oncommand='pf_imprime_html();'/>";
    $vl_c_tabpanel_02.="<vbox>";
    $vl_c_tabpanel_02.="<toolbarbutton id='bt_afficher_images_externes' class='al19' label='Afficher les images externes' tooltiptext='Afficher les images externes' oncommand='document.getElementById(\"mail_html\").setAttribute(\"src\",\"$vl_c_message_html_b64_avec_images\");'/>";
    $vl_c_tabpanel_02.="<html:iframe onload='event.stopPropagation();' flex='10' id='mail_html' src='$vl_c_message_html_b64' />";
    $vl_c_tabpanel_02.="</vbox></tabpanel>";
    break;
  case 2:
    $vl_c_tab_01="<tab id='tab_mail_html' linkedpanel='tabpanel_mail_html' selected='true' label='$vl_c_bof_001'/>";
    $vl_c_tab_02="<tab id='tab_mail_text' linkedpanel='tabpanel_mail_text' label='$vl_c_bof_005'/>";
    $vl_c_tabpanel_01="<tabpanel id='tabpanel_mail_html' flex='1'>";
    $vl_c_tabpanel_01.="<toolbarbutton id='bt_emimail_imprimer_html' class='aa05' tooltiptext='$vl_c_bof_017' oncommand='pf_imprime_html();'/>";
    $vl_c_tabpanel_01.="<vbox flex='1'>";
    $vl_c_tabpanel_01.="<toolbarbutton id='bt_afficher_images_externes' class='al19' label='Afficher les images externes' tooltiptext='Afficher les images externes' oncommand='document.getElementById(\"mail_html\").setAttribute(\"src\",\"$vl_c_message_html_b64_avec_images\");'/>";
    $vl_c_tabpanel_01.="<html:iframe onload='event.stopPropagation();' flex='10' id='mail_html' src='$vl_c_message_html_b64' />";
    $vl_c_tabpanel_01.="</vbox></tabpanel>";
    //$vl_c_tabpanel_01="<tabpanel id='tabpanel_mail_html' flex='1'><toolbarbutton id='bt_emimail_imprimer_html' class='aa05' tooltiptext='$vl_c_bof_017' oncommand='pf_imprime_html();'/><html:iframe onload='event.stopPropagation();' flex='10' id='mail_html' src='$vl_c_message_html_b64' /></tabpanel>";
    $vl_c_tabpanel_02="<tabpanel id='tabpanel_mail_text' flex='1'><toolbarbutton id='bt_emimail_imprimer_text' class='aa05' tooltiptext='$vl_c_bof_017' oncommand='pf_imprime_text();'/><html:iframe flex='10' id='mail_text' src='$vl_c_message_text' /></tabpanel>";
    break;
}
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_tb_droits_onglet_admin=_graal_requete_droits_fenetre('Trait_00305',$vl_e_uti_cleunik); //  Autorisation de télécharger ou de voir le source d'un courriel
if ($vl_tb_droits_onglet_admin[0]==false || $taille_courriel==0) {
	$bloc_01="";
} else {
	$bloc_01=<<<EOT
	<button label="$vl_c_bof_021 ($taille_courriel $vl_c_bof_023)" oncommand="window.parent.pf07_courriel_voir_source(window,$courriel_brut_cleunik);"/>
	<button label="$vl_c_bof_022 ($taille_courriel $vl_c_bof_023)" oncommand="window.parent.pf07_courriel_telecharge($courriel_brut_cleunik);"/>
EOT;
}
if ($taille_courriel==0){
	$bloc_tab_source_00="";
	$bloc_tab_source_01="";
} else {
	$bloc_tab_source_00=<<<EOT
	<tab id="tab_mail_sour" linkedpanel="tabpanel_mail_sour" collapsed="$vl_c_cache_tab_mail_sour" label="$vl_c_bof_020"/>
EOT;
	$bloc_tab_source_01=<<<EOT
	<tabpanel id="tabpanel_mail_sour" flex="1" orient="vertical">
        <hbox>
					$bloc_01
					<button label="$vl_c_bof_024" oncommand="pf_courriel_texte_voir();"/>
					<button label="$vl_c_bof_025" oncommand="pf_courriel_texte_remplacer();"/>
				</hbox>
				<textbox flex="10" id="tb_source" multiline="true"/>
      </tabpanel>
EOT;
}
header('Content-type: application/vnd.mozilla.xul+xml');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
include("_graal_header_winxul.inc.php");
echo <<<END
<window class="transparent" $c_xmlns>
<script type="application/x-javascript"><![CDATA[
const c_texte_source_courriel="_graal_xul_courriel_01.php?vl_courriel_brut_cleunik=$courriel_brut_cleunik&";
function pf_imprime_html() {
  document.getElementById("mail_html").contentWindow.window.print();
}
function pf_imprime_text() {
  document.getElementById("mail_text").contentWindow.window.print();
}
function pf_courriel_texte_voir(){
	pf_xmlhttprequest_txt(c_texte_source_courriel+"vl_genre=voir_corps_texte_action&raf="+Math.random(),"",pf_courriel_texte_voir_suite);
}
function pf_courriel_texte_voir_suite(data) {
	window.open(data);
}
function pf_courriel_texte_remplacer() {
	pf_xmlhttprequest_txt(c_texte_source_courriel+"vl_genre=maj_corps_texte_action&vl_courriel_re_mes_cleunik=$vl_courriel_re_mes_cleunik&raf="+Math.random(),"",pf_courriel_texte_remplacer_suite);
}
function pf_courriel_texte_remplacer_suite(data){
	alert(data);
}
function pf_voir_source_suite(data) {
//	alert("Source visible")
	document.getElementById("tb_source").value=data;
}
function pf_xmlhttprequest_txt(url,request,callback,target){
  var http = new XMLHttpRequest();
  var mode;
  if(!request){mode="GET";} else {mode="POST";}
  http.open(mode,url,true);
  if(mode=="POST"){http.setRequestHeader('Content-Type','application/x-www-form-urlencoded');}
  http.onreadystatechange=function(){if(http.readyState==4){if(callback!=""){callback(http.responseText,target,http.responseText.length);}}};
  http.send(request);
}
]]></script>
<vbox flex='1'>
      <hbox>
        <label value="$vl_c_bof_010"/>
        <textbox flex="1" id="recmail_tb_sujet" readonly="true" tabindex="3" value="$vl_c_sujet"/>

      </hbox>
  <tabbox id="tabbox_01" flex="1" orient="vertical" class="overflow_01">
    <tabs>
       $vl_c_tab_01
       $vl_c_tab_02
       <tab id="tab_mail_ente" linkedpanel="tabpanel_mail_ente" label="$vl_c_bof_011"/>
       $bloc_tab_source_00
    </tabs>
    <tabpanels flex="1">
      $vl_c_tabpanel_01
      $vl_c_tabpanel_02
  		<tabpanel id="tabpanel_mail_ente" flex="1">
        <iframe onload="event.stopPropagation();" _graal_cleunik="" id="tb_header" flex="10" src="$vl_c_header" />
      </tabpanel>
      $bloc_tab_source_01
    </tabpanels>
  </tabbox>
</vbox>
</window>
END;
    break;
	case "xul_recvoc":
		$vl_c_mail_texte="<html:iframe flex='10' id='mail_text' src='$vl_c_message_text' />";
		$sql_req = "SELECT document AS pj, hash,emplacement FROM _documents WHERE doc_cleunik=$vl_e_recvoc_cleunik;";

		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$nom_fichier_message=$row['emplacement'];
		$path="mail/".$sess_id."_".$row['hash']."_".$nom_fichier_message;
	  $handle_file=fopen($path, 'wb');
		if ($handle_file===false){
			$path="";
		} else {
		  $ecritureok=fwrite($handle_file, $row['pj']);
		  fclose($handle_file);
		}
		_graal_libere_requete_bd($result);
		$extension_message=strtolower(pathinfo($nom_fichier_message, PATHINFO_EXTENSION));
		switch ($extension_message){
			case "wav":
				$url_absolue=fa_url_absolue("non");
				$path=$url_absolue.$path;
				//$path=$url_absolue.$nom_fichier_message;
$vl_c_frame_voc=<<<EOT
			<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_08.php?vl_c_fichier=$path' />
EOT;
				break;
			default:
		$url_absolue=fa_url_absolue();
		$path=$url_absolue.$path;
		$lecteur=$url_absolue."dewplayer.swf?son=$path";

$vl_c_recvoc=<<<EOT
		<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Message téléphonique</title>
	</head>
	<body>
	<p align="justify">
	Ecouter
<object type="application/x-shockwave-flash"
data="$lecteur"
width="200" height="20"> <param name="movie" value="$lecteur" pluginspage='http://www.macromedia.com/go/getflashplayer'/>
</object>
</p>
	</body>
</html>
EOT;
$genre="data:text/html;charset=utf-8;base64,";
$vl_c_recvoc=$genre.base64_encode($vl_c_recvoc);
$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='$vl_c_recvoc' />";
				break;
		}
header('Content-type: application/vnd.mozilla.xul+xml');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
include("_graal_header_winxul.inc.php");
echo <<<END
<window class="transparent" $c_xmlns>
<vbox flex='1'>
      <hbox>
        <label value="$vl_c_bof_010"/>
        <textbox flex="1" id="recmail_tb_sujet" readonly="true" tabindex="3" value="$vl_c_sujet"/>

      </hbox>
			<hbox flex="2">
			$vl_c_mail_texte
			</hbox>
			<hbox >
			$vl_c_frame_voc
			</hbox>
</vbox>
</window>
END;
    break;



case "xul_recfax":
		$sql_req = "SELECT emplacement as nom FROM _documents WHERE doc_cleunik=$vl_e_recvoc_cleunik;";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$nom=$row['nom'];
		$vl_e_trouve=preg_match("/.tif/i", $nom);
		if ($vl_e_trouve==true){
$vl_c_rotation=<<<EOT
			<splitter/>
			<hbox >
			<spacer flex="1"/>
			<button label="Retourner à 90°" class="" tooltiptext="Retourner à 90°" oncommand="document.getElementById('ifram_recvoc').setAttribute('src','_graal_tel_doc_04.php?vl_e_doc_cleunik=$vl_e_recvoc_cleunik&#38;vl_e_angle_rotation=90&#38;');"/>
			<button label="Retourner à 180°" class="" tooltiptext="Retourner à 180°" oncommand="document.getElementById('ifram_recvoc').setAttribute('src','_graal_tel_doc_04.php?vl_e_doc_cleunik=$vl_e_recvoc_cleunik&#38;vl_e_angle_rotation=180&#38;');"/>
			<button label="Retourner à -90°" class="" tooltiptext="Retourner à -90°" oncommand="document.getElementById('ifram_recvoc').setAttribute('src','_graal_tel_doc_04.php?vl_e_doc_cleunik=$vl_e_recvoc_cleunik&#38;vl_e_angle_rotation=-90&#38;');"/>
			<button label="Remettre à l'initiale" class="" tooltiptext="Remettre à l'initiale" oncommand="document.getElementById('ifram_recvoc').setAttribute('src','_graal_tel_doc_04.php?vl_e_doc_cleunik=$vl_e_recvoc_cleunik&#38;vl_e_angle_rotation=0&#38;');"/>
			<button label="Imprimer" class="" tooltiptext="Imprimer" oncommand="document.getElementById('ifram_recvoc').contentWindow.window.print();"/>
			<spacer flex="1"/>
			</hbox>
EOT;
		}
		_graal_libere_requete_bd($result);
		$vl_c_mail_texte="<html:iframe flex='10' id='mail_text' src='$vl_c_message_text' />";
		$vl_c_frame_voc="<html:iframe flex='10' id='ifram_recvoc' src='_graal_tel_doc_04.php?vl_e_doc_cleunik=$vl_e_recvoc_cleunik' />";
		$vl_c_ouvre_doc="doc_cleunik=$vl_e_recvoc_cleunik&portee_cleunik=$vl_e_action_cleunik&quelsdocs=undoc_action&genre=action&";
header('Content-type: application/vnd.mozilla.xul+xml');
header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
include("_graal_header_winxul.inc.php");
echo <<<END
<window class="transparent" $c_xmlns>
<script type="application/x-javascript"><![CDATA[
function pf_ouvre_doc() {
  window.parent.pf07_ouvre_doc("$vl_c_ouvre_doc");
}
]]></script>
<vbox flex='1'>
      <hbox>
        <label value="$vl_c_bof_010"/>
				<toolbarbutton class="ai03" tooltiptext="$vl_c_bof_026" oncommand="pf_ouvre_doc();"/>
       <textbox flex="1" id="recmail_tb_sujet" readonly="true" tabindex="3" value="$vl_c_sujet"/>

      </hbox>
			<hbox flex="1">
			$vl_c_mail_texte
			</hbox>
			$vl_c_rotation
			<hbox flex="10">
			$vl_c_frame_voc
			</hbox>
</vbox>
</window>
END;
    break;
  case "src":
    //header('Content-type: text/plain; charset=utf-8');
    header('Content-type: text/html; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    $posgenre=strpos($vl_c_message_html,'base64,')+7;
    $genre=substr($vl_c_message_html,0,$posgenre);
    $vl_c_adecoder=substr($vl_c_message_html,$posgenre,strlen($vl_c_message_html)-$posgenre);
    $vl_c_message_html=base64_decode($vl_c_adecoder);
    echo($vl_c_message_html);
    break;
}
?>
