<?php
include("_graal_header_xml.inc.php");
require("_graal_fonctions_mail.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
$vl_e_integre=fa_recup_param('vl_e_integre','2');
$vl_e_quel_statut=intval(fa_recup_param('vl_e_quel_statut','2'));
$uticptbal_cleunik=intval(fa_recup_param('uticptbal_cleunik',0));
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_type_date=intval(fa_recup_param('type_date','1'));
$vl_e_marque=intval(fa_recup_param('vl_e_marque','1'));
$vl_e_courriel_brut_cleunik=intval(fa_recup_param('vl_e_courriel_brut_cleunik','0'));
$vl_e_sequence=intval(fa_recup_param('vl_e_sequence',''));
$vl_tb_reg_00002=_graal_requete_regle("Reg_00002"); //  Règle qui détermine si on doit Inclure les acteurs / interlocuteurs inactifs en réception de courriel
$vl_b_integre_inactifs=$vl_tb_reg_00002[0];
$sess_id=session_id();
set_time_limit(6000);
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
session_write_close();
error_reporting(E_ALL ^ E_WARNING ^ E_NOTICE); //  On désactive temporairement les warnings parce que parfois le iconv_mime_decode renvoie une erreur
define('EOL', "\r\n");
$liste_ref=array();$liste_gen=array();
$sql_req="SELECT refweb,genre from _courriel_re_listes;"; //  On recherche la liste
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($liste_ref, $row['refweb']);
  array_push ($liste_gen, $row['genre']);
}
_graal_libere_requete_bd($result);
// execution de la requète SQL
switch ($vl_e_integre) {
  case '0'      : $limit=" limit 1"  ;break; //  La dernière récupération
  case '-3'     : $limit=" limit 3"  ;break; //  Les 3 dernières récupération
  case '-5'     : $limit=" limit 5"  ;break; //  Les 5 dernières récupération
  case '-10'    : $limit=" limit 10" ;break; //  Les 10 dernières récupération
  case 'toutes' : $limit=""   ;break; //  Pas de limites
  case 'dates'  : $limit=""   ;break; //  Pas de limites
  case 'cle'    : $limit=""   ;break; //  Pas de limites
  case 'seq'		: $limit=""   ;break; //  Pas de limites
}
switch ($vl_e_quel_statut) {
  case 0  : $vl_c_integre="1,2,3,4" ;break;
  case 1  : $vl_c_integre="1"       ;break;
  case 2  : $vl_c_integre="2"       ;break;
  case 3  : $vl_c_integre="3"       ;break;
  case 4  : $vl_c_integre="4"       ;break;
}
switch ($vl_e_marque) {
  case 1 : $vl_c_marque =" and marquage =1 ";break;      // courriels marqués
  case 2 : $vl_c_marque =" and marquage is NULL ";break;   // courriels pas marqués
  case 3 : $vl_c_marque ="";break;                      // Tous les courriels

}
$sql_req="select courriel_brut_cleunik,courriel,hash,integre,idpop,sequence,marquage,dateheurereception,"._graalsql_date('dateheurereception')." as date_recep,"._graalsql_time('dateheurereception')." as heur_recep from _courriel_recus_brut";
switch ($vl_e_integre) {
  case '0'  : case '-3' : case '-5' : case '-10' :
    $sql_req_00="select sequence from _courriel_recus_brut where uticptbal_cleunik =$uticptbal_cleunik and integre in($vl_c_integre) group by sequence order by sequence desc $limit;"; //  On recherche la liste
    $result = _graal_requete_bd($sql_req_00);
    $sequence="-1,";
    while ($row = mysql_fetch_assoc($result)) {
      $sequence.=$row['sequence'].",";
    }
    _graal_libere_requete_bd($result);
    if (strlen($sequence)!=0) {$sequence=substr($sequence,0,-1);}
    $sql_con=" where sequence in($sequence) and integre in($vl_c_integre) and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by courriel_brut_cleunik asc;";
    break;
  case 'toutes' :
    $sql_con=" where integre in($vl_c_integre) and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by courriel_brut_cleunik asc;";
    break;
  case 'cle' :
    $sql_con=" where courriel_brut_cleunik=$vl_e_courriel_brut_cleunik;";
    break;
  case '1': case '2': case '3': case '4': case '1,2,3,4':
    $sql_con=" where integre in($vl_c_integre) and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by courriel_brut_cleunik desc;";
    break;
  case 'dates':
    switch ($vl_e_type_date) {
      case 1: //  Date de réception
        $sql_con=" where integre in($vl_c_integre) and (dateheurereception between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by dateheurereception desc,courriel_brut_cleunik asc;";
        break;
      case 2: //  Date d'émission du message
        $sql_con=" where integre in($vl_c_integre) and (dateheuremessage between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') and uticptbal_cleunik=$uticptbal_cleunik $vl_c_marque order by dateheuremessage desc;";
        break;
    }
    break;
	case 'seq':
		$sql_con=" where sequence in($vl_e_sequence) order by courriel_brut_cleunik desc;";
		break;
}
$result = _graal_requete_bd($sql_req.$sql_con);
$num_rows = mysql_num_rows($result);
//echo $sql_req_00;
//echo $sql_req.$sql_con;
//exit;
$vl_prop_r="ak17";
$vl_prop_v="ak16";
$vl_prop_o="ak18";
$vl_prop_reponse="ah11";
$vl_prop_retour_pasbon="ad19";
$vl_prop_retour_lu="ag06";
$vl_prop_demande_confirmation="al12";
$vl_prop_demande_confirmation="af06";
$vl_prop_adresse_inconnue="ab19";
$vl_prop_tropdacteurs="ah02";
$vl_prop_attention="cb07";
$vl_prop_vocal="xx06";
$vl_prop_fax="al03";
$vl_prop_fax_ar_emis="al07";
$prop_obsolete="css_0001";
echo('<?xml version="1.0" encoding="UTF-8"?><donnees>');
//echo("<sql data='<![CDATA[$sql_req$sql_con]]>' /sql>");
$numerolecture=10;
while ($row = mysql_fetch_assoc($result)) {
  $numerolecture++;
  $mime=NULL;
  $mime=new mime_parser_class;
  $mime->mbox = 0;
  $mime->decode_bodies = 1;
	$mime->decode_headers=1;
  $mime->ignore_syntax_errors = 1;
  //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
  $path="mail/".$sess_id."_".$row['hash'];
  $handle_file=fopen($path, 'wb');
	if ($handle_file===false){
		echo('<quoi ');
    echo(' z02="Impossible d\'accéder au répertoire de décodage!!! "');   //  Sujet
    echo('/>'.EOL);
		break;
	}
  $ecritureok=fwrite($handle_file, $row['courriel']);
  fclose($handle_file);
	if ($ecritureok===0){
		echo('<quoi ');
    echo(' z02="Impossible de décoder les courriels (fichier vide !!!)"');   //  Sujet
    echo('/>'.EOL);
		break;
	}
  $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$row['hash'],'sess_id'=>$sess_id,);
//  $parameters=array('Data'=>$row['courriel'],'SaveBody'=>'mail','Hash'=>$row['hash'],);
  $vl_c_z00="";
  $vl_c_z00=$num_rows;
  $vl_c_z01=$row['courriel_brut_cleunik'];
  $vl_c_z02="";
  $vl_c_z03="";
  $vl_c_z04="";
  $vl_c_z05="";
  $vl_c_z06="";
  $vl_c_z07="";
  $vl_c_z08="";
  $vl_c_z09="";
  $vl_c_z10="";
  $vl_c_z11="";
  $vl_c_z12="";
  $vl_c_z13="";
  $vl_c_z14="";
  $vl_c_z15=$row['integre'];
  $vl_c_z16=$row['sequence'];
  $vl_c_z17=0;
  $vl_c_z18="";
  $vl_c_z19="";
  $vl_c_z20=0;
  switch ($row['integre']) {
    case 1:$vl_c_z21="af08";break;// Traité : basculé dans les actions
    case 2:$vl_c_z21="ac02";break;// en attente de traitement
    case 3:$vl_c_z21="ac03";break;// supprimé (mais encore complètement dans les courriels reçus)
    case 4:$vl_c_z21="ag12";break;// en anomalie
    case 5:$vl_c_z21="ac03";break;// supprimé (courriel mis à null) ne dravrait jamais être affiché ici
  }
  $vl_c_z22=0;
  $vl_c_z23=0;
  $vl_c_z24=0;
  $vl_c_z25="";
  $vl_c_z26="";
  $vl_c_z27=0;
  $vl_c_z28=0;
  $vl_c_z29=0;
  $vl_c_z30=0;
  $vl_c_z31="";
  $vl_c_z32="";
  $vl_c_z33="";
  if ($row['marquage']==1) {$vl_c_z34="true";} else {$vl_c_z34="false";}
  $vl_c_z35=$row['date_recep']." ".$row['heur_recep'];
  $vl_c_z36="";
  $vl_c_z37=$row['dateheurereception'];
  $vl_c_z38="";
  unset($decoded[0]);
  $retour=$mime->Decode($parameters, $decoded);
  if(!$retour) {
		$vl_c_z00='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position;
    $vl_c_z02='MIME message decoding error: '.$mime->error.' at position '.$mime->error_position;
		$vl_c_z14="ag12";
		$vl_c_z21="ag12";
//      Ne pas faire cette mise à jour car ensuite c'est le binz pour récupérer !!!
//		$sql_req_maj = "update _courriel_recus_brut set integre= 4 WHERE courriel_brut_cleunik=".$row['courriel_brut_cleunik'].";";
//    _graal_exec_requete($sql_req_maj);
	 } else {
	 	$mime->Analyze($decoded[0], $resultats_analyse);
    $vl_type_content=explode(';',$decoded[0]['Headers']['content-type:']);
		$vl_c_z02=fa_sujet($decoded);	//tentative de standardisation de décodage du sujet le 4/4/2009
		//$vl_c_z02=$resultats_analyse['Subject'];	// exploitation fonction Analyze le 14/042009 (ne fonctionne pas)

    $vl_c_z03=$decoded[0]["Headers"]["return-path:"];
    $vl_b_z03=is_array($vl_c_z03);
    if ($vl_b_z03) {
      $vl_c_z03_temp="";
      for($vl_part = 0; $vl_part < count($vl_c_z03); $vl_part++) {
        $vl_c_z03_temp.=$vl_c_z03[$vl_part].";";
      }
      $vl_c_z03=$vl_c_z03_temp;
    }
    $vl_c_z04=$decoded[0]["Headers"]["date:"];
		$vl_c_z05=iconv_mime_decode($decoded[0]["Headers"]["from:"],0, "UTF-8");
    $vl_c_z06=iconv_mime_decode($decoded[0]["Headers"]["to:"],0, "UTF-8");
		$vl_c_z06=preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_z06); //  Suppression des caractères non imprimables (http://www.phpinfo.net/page/archives/regex/)
		//$vl_c_z06 = preg_replace('/^\W+|\W+$/', '', $vl_c_z06);	//	plantage du 7/12/2008 : solution ici : http://fr.php.net/preg_replace
		$vl_c_z07=$decoded[0]["Headers"]["message-id:"];
		$vl_c_z07=fa_ent_xml_cabal_01($vl_c_z07);
		$vl_c_z08=$decoded[0]["Headers"]["in-reply-to:"];
		if ($vl_c_z08!="") {$vl_c_z36=$vl_prop_reponse;}
		if ($decoded[0]["Headers"]["reply-to:"]!=null) {$vl_c_z26=$decoded[0]["Headers"]["reply-to:"];} else {$vl_c_z26="";}
    if (($timestamp = strtotime($vl_c_z04)) === false) {
      if (strtolower(substr($vl_c_z04,-2))=="ut") {
        $vl_c_z04=substr($vl_c_z04,0,strlen($vl_c_z04)-2)."UTC";
        if (($timestamp = strtotime($vl_c_z04)) === false) {
          $vl_c_z09="19610123060000";
        } else {
          $vl_c_z09=date('YmdHis', $timestamp);
          $vl_c_z04=date('d-m-Y H:i:s', $timestamp);
        }
      }  else {
        $vl_c_z09="19700101000001";
        $vl_c_z04=date('d-m-Y H:i:s', 1);
      }
    } else {
      $vl_c_z09=date('YmdHis', $timestamp);
      $vl_c_z04=date('d-m-Y H:i:s', $timestamp);
    }
    preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z05 , $regs);
	if ($vl_c_z26!="") {preg_match('/[\\w\\.\\-+=*_]*@[\\w\\.\\-+=*_]*/', $vl_c_z26 , $regs);}
    $vl_c_z26 = $regs[0]; //  Adresse de réponse
    if ($vl_c_z26==$vl_c_z10) {$vl_c_z26="";}
		/*
		 * On recherche si on est en présence d'un message vocal, d'un fax
		 * au 7 mars 2009, gestion des messages vocaux en provenance d'OVH
		 * au 8 mars 2009, gestion des fax en provenance d'OVH
		 * au 15 août 2009, gestion des fax en provenance de la machine fax RICOH Baronnat
		 */
/*
    var_dump ($decoded);
    var_dump($decoded[0]);
    die("fin");
*/
		$vl_c_special="";
		//Recherche message vocal OVH
		if ($decoded[0]["Headers"]["x-ovh-from:"]!=null) {
			$vl_c_z10=$decoded[0]["Headers"]["x-ovh-from:"];
			$vl_c_special="1";
			$vl_c_z26="";
		}
	 //	Recherche message vocal keyyo
  		if ($decoded[0]["Headers"]["return-path:"]=="<voicemail@keyyo.fr>") {
			$vl_c_special="3";
			$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
			$vl_chaine_sujet_fax = preg_match_all( '`<(.*)>`Us' , $vl_chaine_sujet_fax, $mots);
			foreach($mots[1] as $val) {
    			$vl_c_z10="0".substr($val,3);
			}
			$vl_c_z26="";
		}
		// Recherche Fax OVH
		if ($decoded[0]["Headers"]["x-ovh-fax-from:"]!=null) {
			$vl_c_z10=$decoded[0]["Headers"]["x-ovh-fax-from:"];
			$vl_c_special="2";
			$vl_c_z26="";
		}
		//	Recherche fax recu keyyo
	 	if ($decoded[0]["Headers"]["return-path:"]=="<fax2mail@keyyo.fr>") {
			$vl_c_special="2";
			$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
			$position_prem = strlen('Fax en provenance de ');
			$position_dern = strpos($vl_chaine_sujet_fax, ' reçu sur le');
			$longueur=$position_dern-$position_prem;
			$vl_c_z10=trim(substr($vl_chaine_sujet_fax,$position_prem,$longueur));
			$vl_c_z26="";
		}
		//	Recherche accusé de réception emission de fax via keyyo
	 	if ($decoded[0]["Headers"]["return-path:"]=="<keyyofax@keyyo.fr>") {
			$vl_c_special="4";
			$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
			$position_prem = strlen('Fax à destination du ');
			$position_dern = strpos($vl_chaine_sujet_fax, ' correctement envoyé');
			$longueur=$position_dern-$position_prem;
			$vl_c_z10=trim(substr($vl_chaine_sujet_fax,$position_prem,$longueur));
			$vl_c_z26="";
		}
		// Recherche Fax en provenance de la machine fax RICOH Baronnat (plus opérationnel depuis le 1° septembre 2010)
		$vl_chaine_sujet_fax=$decoded[0]["Headers"]["subject:"];
		$vl_e_trouve_fax=preg_match("/Fax Message NO./i", $vl_chaine_sujet_fax);
		if ($vl_e_trouve_fax==true){
			$vl_c_special="2";
			$vl_e_trouve_exp=preg_match("/From \"/i", $vl_chaine_sujet_fax);
			if ($vl_e_trouve_exp==true){
				$trouve_moi  = '"';
				$pos=0;
				$position_prem = strpos($vl_chaine_sujet_fax, $trouve_moi,$pos);
				$position_dern = strpos($vl_chaine_sujet_fax, $trouve_moi,$position_prem+1);
				$longueur=$position_dern-$position_prem-1;
				$vl_c_z10=trim(substr($vl_chaine_sujet_fax,$position_prem+1,$longueur));
				$vl_c_z26="";
			}
		}
		//Recherche Fax en provenance du télécopieur Baronnat depuis le 1° septembre 2010
		if ($decoded[0]["Headers"]["x-mailer:"]=="Network Scanner System") {
			$vl_c_z10="";
			$vl_c_special="2";
			$vl_c_z26="";
		}

		$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
		$b[0]='';
    switch ($vl_c_special) {
    	case "":
	    	$vl_c_z10 = $regs[0]; //  Expéditeur
				$sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intweb_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_mail f1,_acteurs f2,_act_interlo f3,_choix f4 where refweb='$vl_c_z10' and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
				break;
			case "1":		//	Message téléphonique répondeur
			case "3":		//	Message téléphonique keyyo
					$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_z10);
		 			$sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intel_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_tel f1,_acteurs f2,_act_interlo f3,_choix f4 where intel_06=$vl_c_chaine_nette and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
					break;
			case "2":		//	Fax ovh, ricoh
			case "4":		// accusé de réception fax émis keyyo
					$vl_c_chaine_nette=preg_replace($a, $b, $vl_c_z10);
		 			$sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intel_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_fax f1,_acteurs f2,_act_interlo f3,_choix f4 where intel_06=$vl_c_chaine_nette and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
					break;
    }
    $result_01=_graal_requete_bd($sql_req_01);
    $vl_c_z11="";$vl_nb_trouve=0;$vl_b_actif=0;
    while ($row_01 = mysql_fetch_assoc($result_01)) {
      $vl_nb_trouve++;
      if ($row_01['actif_acteur']==1) {
        if ($row_01['actif_interlo']==1) {
          $vl_b_actif++;
          $vl_c_z11.=$row_01['qui']."(".$row_01['raisonsoc']."[".$row_01['choix_valeur_texte_01']."])"."++";
          $vl_c_z20=$row_01['web_cleunik'];
          $vl_c_z22=$row_01['typeacteur'];
          $vl_c_z23=$row_01['act_cleunik'];
          $vl_c_z24=$row_01['int_cleunik'];
          switch ($vl_c_special) {
			    	case "":	//	Courriel
							switch ($row_01['typeacteur']) {
		            case 110000 : $vl_c_z12="be06";break;
		            case 110003 : $vl_c_z12="bd09";break;
		            case 110001 : $vl_c_z12="be01";break;
		            case 110004 : $vl_c_z12="be02";break;
		            case 110002 : $vl_c_z12="be03";break;
		            case 110005 : $vl_c_z12="be04";break;
		            case 110006 : $vl_c_z12="be05";break;
		          }
							break;
						case "1":		//	Message téléphonique répondeur OVH
						case "3":		//	Message téléphonique répondeur keyyo
							switch ($row_01['typeacteur']) {
		            case 110000 : $vl_c_z12="bc09";break;
		            case 110003 : $vl_c_z12="bc03";break;
		            case 110001 : $vl_c_z12="bc04";break;
		            case 110004 : $vl_c_z12="bc05";break;
		            case 110002 : $vl_c_z12="bc06";break;
		            case 110005 : $vl_c_z12="bc07";break;
		            case 110006 : $vl_c_z12="bc08";break;
		          }
							break;
						case "2":		//	Réception Fax OVH ou Fax RICOH Baronnat ou keyyo
						case "4":		//	Réception accusé de réception de fax amis keyyo
							switch ($row_01['typeacteur']) {
		            case 110000 : $vl_c_z12="bf04";break;
		            case 110003 : $vl_c_z12="be07";break;
		            case 110001 : $vl_c_z12="be08";break;
		            case 110004 : $vl_c_z12="be09";break;
		            case 110002 : $vl_c_z12="bf01";break;
		            case 110005 : $vl_c_z12="bf02";break;
		            case 110006 : $vl_c_z12="bf03";break;
		          }
							break;
			    }
        }
      }
    }
    _graal_libere_requete_bd($result_01);
    if ($vl_nb_trouve!=0) {
      if ($vl_b_actif!=0) {
        if ($vl_b_actif!=1) {
          $vl_c_z12=$vl_prop_tropdacteurs;
        }
      } else {
      	//	On refait la requête, mais sans tester sur les actifs
				$result_01=_graal_requete_bd($sql_req_01);
		    $vl_c_z11="";$vl_nb_trouve=0;$vl_b_actif=0;
		    while ($row_01 = mysql_fetch_assoc($result_01)) {
		      $vl_nb_trouve++;
          $vl_c_z11.=$row_01['qui']."(".$row_01['raisonsoc']."[".$row_01['choix_valeur_texte_01']."])"."++";
          $vl_c_z20=$row_01['web_cleunik'];
          $vl_c_z22=$row_01['typeacteur'];
          $vl_c_z23=$row_01['act_cleunik'];
          $vl_c_z24=$row_01['int_cleunik'];
          switch ($vl_c_special) {
			    	case "":	//	Courriel
							switch ($row_01['typeacteur']) {
		            case 110000 : $vl_c_z12="be06 $prop_obsolete";break;
		            case 110003 : $vl_c_z12="bd09 $prop_obsolete";break;
		            case 110001 : $vl_c_z12="be01 $prop_obsolete";break;
		            case 110004 : $vl_c_z12="be02 $prop_obsolete";break;
		            case 110002 : $vl_c_z12="be03 $prop_obsolete";break;
		            case 110005 : $vl_c_z12="be04 $prop_obsolete";break;
		            case 110006 : $vl_c_z12="be05 $prop_obsolete";break;
		          }
							break;
						case "1":		//	Message téléphonique répondeur OVH
						case "3":		//	Message téléphonique répondeur keyyo
							switch ($row_01['typeacteur']) {
		            case 110000 : $vl_c_z12="bc09 $prop_obsolete";break;
		            case 110003 : $vl_c_z12="bc03 $prop_obsolete";break;
		            case 110001 : $vl_c_z12="bc04 $prop_obsolete";break;
		            case 110004 : $vl_c_z12="bc05 $prop_obsolete";break;
		            case 110002 : $vl_c_z12="bc06 $prop_obsolete";break;
		            case 110005 : $vl_c_z12="bc07 $prop_obsolete";break;
		            case 110006 : $vl_c_z12="bc08 $prop_obsolete";break;
		          }
							break;
						case "2":		//	Fax OVH ou Fax RICOH Baronnat ou fax keyyo
						case "4":		//	Accusé de réception émission de fax
							switch ($row_01['typeacteur']) {
		            case 110000 : $vl_c_z12="bf04 $prop_obsolete";break;
		            case 110003 : $vl_c_z12="be07 $prop_obsolete";break;
		            case 110001 : $vl_c_z12="be08 $prop_obsolete";break;
		            case 110004 : $vl_c_z12="be09 $prop_obsolete";break;
		            case 110002 : $vl_c_z12="bf01 $prop_obsolete";break;
		            case 110005 : $vl_c_z12="bf02 $prop_obsolete";break;
		            case 110006 : $vl_c_z12="bf03 $prop_obsolete";break;
		          }
							break;
			    }
		    }
		    _graal_libere_requete_bd($result_01);
      }
    } else {
      $vl_c_z12=$vl_prop_adresse_inconnue;
    }
    if ($vl_c_z26!="") {
      $sql_req_01="SELECT f1.int_cleunik as int_cleunik,f1.intweb_cleunik as web_cleunik,f1.act_cleunik as act_cleunik,f2.typeacteur,f2.raisonsoc,concat_ws(' ', f3.prenom,f3.patronyme) as qui,f4.choix_valeur_texte_01,f2.actif as actif_acteur,f3.actif as actif_interlo,f2.typeacteur FROM _act_interlo_mail f1,_acteurs f2,_act_interlo f3,_choix f4 where refweb='$vl_c_z26' and f1.act_cleunik=f2.act_cleunik and f3.int_cleunik=f1.int_cleunik and f4.choix_cleunik=f2.typeacteur;";
      $result_01=_graal_requete_bd($sql_req_01);
      $vl_c_z31="";$vl_nb_trouve=0;$vl_b_actif=0;
      while ($row_01 = mysql_fetch_assoc($result_01)) {
        $vl_nb_trouve++;
        if ($row_01['actif_acteur']==1) {
          if ($row_01['actif_interlo']==1) {
            $vl_b_actif++;
            $vl_c_z31.=$row_01['qui']."(".$row_01['raisonsoc']."[".$row_01['choix_valeur_texte_01']."])".EOL;
            $vl_c_z27=$row_01['web_cleunik'];
            $vl_c_z28=$row_01['typeacteur'];
            $vl_c_z29=$row_01['act_cleunik'];
            $vl_c_z30=$row_01['int_cleunik'];
            switch ($row_01['typeacteur']) {
              case 110000 : $vl_c_z32="be06";break;
              case 110003 : $vl_c_z32="bd09";break;
              case 110001 : $vl_c_z32="be01";break;
              case 110004 : $vl_c_z32="be02";break;
              case 110002 : $vl_c_z32="be03";break;
              case 110005 : $vl_c_z32="be04";break;
              case 110006 : $vl_c_z32="be05";break;
            }
          }
        }
      }
      _graal_libere_requete_bd($result_01);
      if ($vl_nb_trouve!=0) {
        if ($vl_b_actif!=0) {
          if ($vl_b_actif!=1) {
            $vl_c_z32=$vl_prop_adresse_inconnue;
          }
        } else {
          $vl_c_z32=$vl_prop_adresse_inconnue." ai15";
        }
      } else {
        $vl_c_z32=$vl_prop_adresse_inconnue;
      }
    }
    preg_match("^(.+)@(.+)\.(.+)$", $vl_c_z10, $regs);
    $vl_c_z13=$regs[2].".".$regs[3];
    preg_match("^(.+)@(.+)\.(.+)$", $vl_c_z26, $regs);
    $vl_c_z33=$regs[2].".".$regs[3];

    $vl_c_z14="";
    //  Recherche adresse
    $vl_e_trouve_adresse=array_search($vl_c_z10,$liste_ref);
    if ($vl_e_trouve_adresse===false) {} else {
      switch ($liste_gen[$vl_e_trouve_adresse]) {
        case 1 : $vl_c_z14=$vl_prop_v;break;
        case 2 : $vl_c_z14=$vl_prop_o;break;
        case 3 : $vl_c_z14=$vl_prop_r;break;
      }
    }
    if ($vl_c_z14=="") {
      //  Recherche domaine
      $vl_e_trouve_domaine=array_search($vl_c_z13,$liste_ref);
      if ($vl_e_trouve_domaine===false) {} else {
        switch ($liste_gen[$vl_e_trouve_domaine]) {
          case 1 : $vl_c_z14=$vl_prop_v;break;
          case 2 : $vl_c_z14=$vl_prop_o;break;
          case 3 : $vl_c_z14=$vl_prop_r;break;
        }
      }
    }
    $vl_c_15=$decoded[0]["Headers"]["disposition-notification-to:"];  //  Expéditeur veut être prévenu
    if ($vl_c_15!="") {$vl_c_z25=$vl_prop_demande_confirmation;}
    $nb_parties=count($decoded[0]['Parts']);
    switch ($nb_parties) {
      case 0:
        $vl_c_z17="";
        $vl_c_z18="";
        $vl_type_content=explode(';',$decoded[0]['Headers']['content-type:']);
        switch ($vl_type_content[0]) {
          case "text/plain":
            break;
          case "text/html":
            $vl_c_z19="am05";
            break;
        }
        break;
      default :
        $vl_e_nb_pieces_jointes=0;
        $vl_e_nb_pieces_integrees=0;
        $vl_e_taille_pj=0;
        unset($tableau_parties);
				$index=0;
        $tableau_parties=fa_arrayFromEmailParts($decoded[0]['Parts'],$index);
        $nb_parties=count($tableau_parties);
        $vl_b_attention=false;
        $attention_a_quoi="";
        for($vl_part = 0; $vl_part < $nb_parties; $vl_part++) {
          $vl_coid=$tableau_parties[$vl_part]['coid'];
          $vl_special=$tableau_parties[$vl_part]['special'];
          if ($tableau_parties[$vl_part]['attention']!=null) {
            $vl_b_attention=true;
            $attention_a_quoi.=$tableau_parties[$vl_part]['attention'];
          }
          if ($tableau_parties[$vl_part]['content']!=null) {
            switch ($tableau_parties[$vl_part]['type']) {
              case "text/plain":
                break;
              case "text/html":
                $vl_c_z19="am05";
                break;
              default:
                break;
            }
          } else {
            //  On teste d'abord si c'est un fichier incorporé.
            if ($vl_coid != null) {
              $vl_e_nb_pieces_integrees++;
            } else {
              if ($vl_special!=null) {
                switch ($vl_special) {
                  case "message/disposition-notification":if ($vl_c_z25!=$vl_prop_retour_pasbon) {$vl_c_z25=$vl_prop_retour_lu;}break;
                  case "message/delivery-status":$vl_c_z25=$vl_prop_retour_pasbon;break;
                  case "message/rfc822":$vl_c_z25=$vl_prop_retour_pasbon;break;
                  case "text/rfc822-headers":if ($vl_c_z25!=$vl_prop_retour_pasbon) {$vl_c_z25=$vl_prop_retour_lu;}break;
                }
             } else {
              $vl_e_nb_pieces_jointes++;
              $vl_e_taille_pj+=$tableau_parties[$vl_part]['taille'];
             }

            }
          }
        }
        if ($vl_e_nb_pieces_jointes!=0) {
          $vl_c_z17=$vl_e_nb_pieces_jointes." (".int2taille($vl_e_taille_pj).")";
          $vl_c_z18="al14";
          if ($vl_e_taille_pj==0) { //  On a des pièces jointes et une taille 0 !!! ca a du être supprimé par un antivirus !!
            $vl_c_z18=$vl_prop_attention;
            $vl_c_z17="!! Virus-Virus-Virus !!";
            $vl_c_z38="1";
            }
        } else {
          $vl_c_z17="";$vl_c_z18="";
        }
        if ($vl_b_attention==true) {
          $vl_c_z18=$vl_prop_attention;
          $vl_c_z17="??? Virus-Virus-Virus ??? $attention_a_quoi";
          $vl_c_z38="1";
        }
        break;
    }
  }
	switch ($vl_c_special) {
		case "":
			break;
		case "1":
		case "3":
			$vl_c_z18=$vl_prop_vocal;
			break;
		case "2":
			$vl_c_z18=$vl_prop_fax;
			break;
		case "4":
			$vl_c_z18=$vl_prop_fax_ar_emis;
			break;
	}
	$vl_c_z39=$vl_c_special;
  //  On teste le chemin de retour, preuve dans google que c'est bien un courriel reçu et pas un courriel envoyé
	//$vl_c_z03="ok";
  if ($vl_c_z03!="") {
    if (($vl_c_z25==$vl_prop_retour_lu) or ($vl_c_z25==$vl_prop_retour_pasbon)) {$vl_c_z36="";}
    echo('<quoi ');
    echo(' z00="'.fa_ent_xml($vl_c_z00).'"');
    echo(' z01="'.fa_ent_xml($vl_c_z01).'"');
    echo(' z02="'.fa_ent_xml($vl_c_z02).'"');   //  Sujet
    echo(' z03="'.fa_ent_xml($vl_c_z03).'"');   //  Chemin de retour
    echo(' z04="'.fa_ent_xml($vl_c_z04).'"');
    echo(' z05="'.fa_ent_xml($vl_c_z05).'"');
    echo(' z06="'.fa_ent_xml($vl_c_z06).'"');
    echo(' z07="'.fa_ent_xml($vl_c_z07).'"');
    echo(' z08="'.fa_ent_xml($vl_c_z08).'"'); //  en réponse à
    echo(' z09="'.fa_ent_xml($vl_c_z09).'"'); //  Date en clair
    echo(' z10="'.fa_ent_xml($vl_c_z10).'"'); //  adresse courriel de l'expéditeur
    echo(' z11="'.fa_ent_xml($vl_c_z11).'"'); //  Qui en clair
    echo(' z12="'.$vl_c_z12.'"');
    echo(' z13="'.fa_ent_xml($vl_c_z13).'"'); //  Domaine
    echo(' z14="'.$vl_c_z14.'"'); //  Avertissement d'après listes
    echo(' z15="'.$vl_c_z15.'"'); //  Integré
    echo(' z16="'.$vl_c_z16.'"'); //  Séquence
    echo(' z17="'.$vl_c_z17.'"');  //  Nombre de pièces jointes
    echo(' z18="'.$vl_c_z18.'"');  //  Propertie -> trombonne symbolisant les pièces-jointes ou attention pièces jointes mais taille 0 -> probabilité virus
    echo(' z19="'.$vl_c_z19.'"');  //  Propertie -> Présence partie HTML
    echo(' z20="'.$vl_c_z20.'"');  //  web_cleunik de l'expéditeur
    echo(' z21="'.$vl_c_z21.'"');  //  Propertie -> état du courriel : supprimé, à traiter, purgé ...
    echo(' z22="'.$vl_c_z22.'"'); //  Type acteur de l'expéditeur
    echo(' z23="'.$vl_c_z23.'"'); //  act_cleunik de l'expéditeur
    echo(' z24="'.$vl_c_z24.'"'); //  int_cleunik de l'expéditeur
    echo(' z25="'.$vl_c_z25.'"'); //  Propertie pour signaler un type de courriel particulier : notification de lecture, erreur dans la délivrance du courriel
    echo(' z26="'.fa_ent_xml($vl_c_z26).'"'); //  Adresse de réponse
    echo(' z27="'.$vl_c_z27.'"');  //  web_cleunik de l'adresse de réponse
    echo(' z28="'.$vl_c_z28.'"'); //  Type acteur de l'adresse de réponse
    echo(' z29="'.$vl_c_z29.'"'); //  act_cleunik de l'adresse de réponse
    echo(' z30="'.$vl_c_z30.'"'); //  int_cleunik de l'adresse de réponse
    echo(' z31="'.fa_ent_xml($vl_c_z31).'"'); //  Qui adresse de réponse en clair
    echo(' z32="'.$vl_c_z32.'"'); //  Propriété type acteur adresse de réponse
    echo(' z33="'.fa_ent_xml($vl_c_z33).'"'); //  Domaine de réponse
    echo(' z34="'.$vl_c_z34.'"'); //  MArquage
    echo(' z35="'.$vl_c_z35.'"'); //  Date et heure de réception du courriel en clair
    echo(' z36="'.$vl_c_z36.'"'); //  Propriété de réponse
    echo(' z37="'.$vl_c_z37.'"'); //  Date et heure de réception du courriel pour tri
    echo(' z38="'.$vl_c_z38.'"'); //  Pas vide si suscpect cad si pj <> 0 et taille pj = 0
    echo(' z39="'.$vl_c_z39.'"'); //  1 : message vocal, 2 : fax OVH,Fax Ricoh Baronnat, 3 Message vocal keyyo
    //echo(' z40="'.$vl_chaine_sujet_fax.'"'); //  1 : message vocal, 2 : fax OVH, 3 : Fax Ricoh Baronnat
    echo(' z41="'.$vl_chaine_cherche_keyyo.'"'); //  tests pour récupération informations keyyo
    echo('/>'.EOL);
  } else {
    //  a priori, ce sont des courriels envoyés
    //  On change leur état
		$sql_req_maj = "update _courriel_recus_brut set integre= 6 WHERE courriel_brut_cleunik=".$row['courriel_brut_cleunik'].";";
    _graal_exec_requete($sql_req_maj);
  }
}
echo('</donnees>');
// fermeture du curseur et de la connexion
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
