<?php
include("_graal_header_xml.inc.php");
$vf_c_quelspaniers=fa_recup_param('vl_c_quelspaniers','');
$vl_e_uti_cleunik=fa_recup_session('vs_uti_cleunik','0');
$vl_e_portee=intval(fa_recup_param('vl_e_portee','0'));
$vl_e_maportee=intval(fa_recup_param('vl_e_maportee','-1'));
$vl_e_type=intval(fa_recup_param('vl_e_type','-1'));
$vl_c_actif=fa_recup_param('vl_c_actif','1,2');
define('EOL', "\r\n");
if ($vl_e_maportee!=-1) {
  $vl_e_portee=$vl_e_maportee;
  $vf_c_quelspaniers="melistes";
}
$sql_req = "SELECT _panier.panier_cleunik AS panier_cleunik,_panier.panier_titre AS panier_titre,"._graalsql_datetime('_panier.dateheurecreation')." AS dateheurecreation,_panier.uti_cleunik AS uti_cleunik,_utilisateur.prenom AS prenom,_utilisateur.patronyme AS patronyme,panier_type as panier_type,panier_portee as panier_portee FROM _utilisateur, _panier WHERE _utilisateur.uti_cleunik = _panier.uti_cleunik"; 
if ($vl_e_type!=-1) {$sql_req.=" AND panier_type=$vl_e_type";} 
if ($vl_e_portee>0) {$sql_req.=" AND panier_portee & $vl_e_portee";}
switch ($vf_c_quelspaniers) {
  case "medoc"    : $sql_req .= " AND _panier.panier_cleunik>0 AND _panier.uti_cleunik=$vl_e_uti_cleunik";break;
  case "melistes" : $sql_req .= " AND ((_panier.panier_cleunik>0 AND _panier.uti_cleunik IN ($vl_e_uti_cleunik,0)) OR (_panier.panier_cleunik<0))";break;
  //case "melistes" : $sql_req .= " AND _panier.panier_cleunik>0 AND _panier.uti_cleunik IN ($vl_e_uti_cleunik,0)";break;
  case "nosdocs"  : $sql_req .= " AND _panier.panier_cleunik>0 ";break;
  case "leurdocs" : $sql_req .= " AND _panier.panier_cleunik>0 AND _panier.uti_cleunik<>$vl_e_uti_cleunik";break;
  case "standard" : $sql_req .= " AND _panier.panier_cleunik<0";break;
  default         : $sql_req .= " AND _panier.panier_cleunik>0 AND _panier.uti_cleunik=-9999";break;
}
$sql_req .= " AND _panier.actif IN($vl_c_actif);";
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());
/*
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo("<row:req>$sql_req</row:req>");
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
*/
while ($row = mysql_fetch_assoc($result)) {
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:panier_cleunik NC:parseType="Integer">'.fa_ent_xml($row['panier_cleunik']).'</row:panier_cleunik>');
  echo('<row:uti_cleunik NC:parseType="Integer">'.fa_ent_xml($row['uti_cleunik']).'</row:uti_cleunik>');
  echo('<row:panier_titre>'.fa_ent_xml($row['panier_titre']).'</row:panier_titre>');
  echo('<row:prenom>'.fa_ent_xml($row['prenom']).'</row:prenom>');
  echo('<row:patronyme>'.fa_ent_xml($row['patronyme']).'</row:patronyme>');
  echo('<row:dateheurecreation >'.fa_ent_xml($row['dateheurecreation']).'</row:dateheurecreation>');
  echo('<row:dateheurecreation >'.fa_ent_xml($row['dateheurecreation']).'</row:dateheurecreation>');
  switch ($row['panier_type']) {
    case 1: //  Paniers
      switch ($row['panier_portee']) {
        case 8192 :$prop="bg02";break;  //  Tous les acteurs
        case 8194 :$prop="bg04";break;  //  prospects clients 
        case 8196 :$prop="bg03";break;  //  clients
        case 8200 :$prop="bg06";break;  //  Prospects fournisseurs
        case 8208 :$prop="bg05";break;  //  Fournisseurs
        case 8224 :$prop="bg07";break;  //  Autres acteurs
        case 8256 :$prop="bg08";break;  //  Acteurs indéterminés
        case 1024 :$prop="bj04";break;  //  articles
      } 
      break;
    case 2: //  Requêtes personnelles 
      switch ($row['panier_portee']) {
        case 8192 :$prop="bg09";break;  //  Tous les acteurs
        case 8194 :$prop="bh02";break;  //  prospects clients 
        case 8196 :$prop="bh01";break;  //  clients
        case 8200 :$prop="bh04";break;  //  Prospects fournisseurs
        case 8208 :$prop="bh03";break;  //  Fournisseurs
        case 8224 :$prop="bh05";break;  //  Autres acteurs
        case 8256 :$prop="bh06";break;  //  Acteurs indéterminés
        case 1024 :$prop="bj03";break;  //  articles
      }
      break;
  }
  echo('<row:prop>'.$prop.'</row:prop>');
  echo('<row:panier_type>'.fa_ent_xml($row['panier_type']).'</row:panier_type>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
