<?php
require_once("_graal_fonctions_diverses.php");
include("_graal_fonctions_stats.php");
require_once("_graal_fonctions_mysql.php");
require_once ('calc/classes/OpenOfficeSpreadsheet.class.php');
require_once "sources_excel/class.writeexcel_workbook.inc.php";
require_once "sources_excel/class.writeexcel_worksheet.inc.php";
define('EOL', "\r\n");
$date_deb=fa_recup_param('date_deb','20610123');
$date_fin=fa_recup_param('date_fin','19610123');
$ml_art_01=intval(fa_recup_param('ml_art_01',1));
$ml_art_02=intval(fa_recup_param('ml_art_02',2));
$ml_art_03=intval(fa_recup_param('ml_art_03',4));
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$nombre=intval(fa_recup_param('nombre',0));
$genre=fa_recup_param('genre','');
$vl_e_panier=intval(fa_recup_param('panier',-1));
$vl_c_sortie=fa_recup_param('sortie','das');
stats_rectif_dates($ml_art_03);
switch ($genre) {
  case "client_tous":$typeacteur="110003";break;
  case "procli_tous":$typeacteur="110001";break;
  case "fourni_tous":$typeacteur="110004";break;
  case "profou_tous":$typeacteur="110002";break;
}

switch ($ml_art_02) {
  case 1:
  case 2:
  case 3:

		switch ($ml_art_03) {
		  case  1: $fic_cial="offcli";$coeff="1";break;
		  case  2: $fic_cial="cdecli";$coeff="1";break;
		  case  3: $fic_cial="livcli";$coeff="1";break;
		  case  4: $fic_cial="faccli";$coeff="1";break;
		  case  5: $fic_cial="demfou";$coeff="1";break;
		  case  6: $fic_cial="cdefou";$coeff="1";break;
		  case  7: $fic_cial="recfou";$coeff="1";break;
		  case  8: $fic_cial="facfou";$coeff="1";break;
		  case  9: $fic_cial="faccli";$coeff="1";break;
		  case 10: $fic_cial="avocli";$coeff="-1";break;
		  case 11: $fic_cial="retcli";$coeff="1";break;
		  case 12: $fic_cial="retfou";$coeff="1";break;
		}
		$uuid=_graal_requete_uuid();
		switch ($ml_art_03) {
		  case  1:
		  case  2:
		  case  3:
		  case  5:
		  case  6:
		  case  7:
		  case  8:
		  case  9:
		  case 10:
		  case 11:
		  case 12:
				switch ($ml_art_02) {
				  case 1: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
				  case 2: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
				  case 3: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
				}
				$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,f3.act_cleunik";
				break;
			case 4:
				switch ($ml_art_02) {
				  case 1: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
				  case 2: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
				  case 3: $sql_req="insert into _temp_stat_01 select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
				}
				$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,f3.act_cleunik";
				$sql_req.=" union all ";

				$fic_cial="avocli";$coeff="-1";

				switch ($ml_art_02) {
				  case 1: $sql_req.=" select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*($coeff)) as z01,NULL";break;
				  case 2: $sql_req.=" select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,sum(f5.qte*f1.pu*($coeff)) as z01,NULL";break;
				  case 3: $sql_req.=" select f3.act_cleunik,'$uuid',f5.dateheure_confirm as z03,count(*) as z01,NULL";break;
				}
				$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_".$fic_cial."_lignes_qte f5 where f1.commercial_cleunik=f3.commercial_cleunik and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,f3.act_cleunik";
		}
		break;
  case 4:
		switch ($ml_art_03) {
		  case  1: $fic_cial_01="_offcli_entetes";$fic_cial_02="_vue_offcli_ht_01";$fic_cial_03="_vue_offcli_ht_00_inter";break;
		  case  2: $fic_cial_01="_cdecli_entetes";$fic_cial_02="_vue_cdecli_ht_01";$fic_cial_03="_vue_cdecli_ht_00_inter";break;
		  case  3: $fic_cial_01="_livcli_entetes";$fic_cial_02="_vue_livcli_ht_01";$fic_cial_03="_vue_livcli_ht_00_inter";break;
		  case  4: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_01";$fic_cial_03="_vue_faccli_ht_00_inter";break; //  Factures et avoirs (-110116,-110117) regroupés
		  case  5: $fic_cial_01="_demfou_entetes";$fic_cial_02="_vue_demfou_ht_01";$fic_cial_03="_vue_demfou_ht_00_inter";break;
		  case  6: $fic_cial_01="_cdefou_entetes";$fic_cial_02="_vue_cdefou_ht_01";$fic_cial_03="_vue_cdefou_ht_00_inter";break;
		  case  7: $fic_cial_01="_recfou_entetes";$fic_cial_02="_vue_recfou_ht_01";$fic_cial_03="_vue_recfou_ht_00_inter";break;
		  case  8: $fic_cial_01="_facfou_entetes";$fic_cial_02="_vue_facfou_ht_01";$fic_cial_03="_vue_facfou_ht_00_inter";break;
		  case  9: $fic_cial_01="_faccli_entetes";$fic_cial_02="_vue_faccli_ht_01";$fic_cial_03="_vue_faccli_ht_00_inter";break;
		  case 10: $fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_01";$fic_cial_03="_vue_avocli_ht_00_inter";break;
		  case 11: $fic_cial_01="_retcli_entetes";$fic_cial_02="_vue_retcli_ht_01";$fic_cial_03="_vue_retcli_ht_00_inter";break; //  Factures et avoirs (-110116,-110117) regroupés
		  case 12: $fic_cial_01="_retfou_entetes";$fic_cial_02="_vue_retfou_ht_01";$fic_cial_03="_vue_retfou_ht_00_inter";break;
		}
		switch ($ml_art_03) {
		  case  1:
		  case  2:
		  case  3:
		  case  5:
		  case  6:
		  case  7:
		  case  8:
		  case  9:
		  case 10:
		  case 10:
		  case 11:
				$uuid=_graal_requete_uuid();
				$sql_req="insert into _temp_stat_01 select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=2 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,a3.act_cleunik";
				$sql_req.=" union all ";
				$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,a3.act_cleunik";
				break;
		}
		switch ($ml_art_03) {
		  case  4:
				$uuid=_graal_requete_uuid();
				$sql_req="insert into _temp_stat_01 select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) AS z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=2 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,a3.act_cleunik";
				$sql_req.=" union all ";
				$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2) as z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,a3.act_cleunik";
				$sql_req.=" union all ";

				$fic_cial_01="_avocli_entetes";$fic_cial_02="_vue_avocli_ht_01";$fic_cial_03="_vue_avocli_ht_00_inter";$coeff="1";

				$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else round(sum(a1.htbrutremise*a3.remise_taux/100),2) end) else round(sum(round(a1.htbrutremise*100/a2.total_doc,2)*a3.remise_taux/100),2) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) AS z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=2 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,a3.act_cleunik";
				$sql_req.=" union all ";
				$sql_req.=" select a3.act_cleunik,'$uuid',a1.dateheure_confirm as z03,(round(sum(a1.htbrutremise)+((case a3.remise_type when 1 then (case a3.remise_taux when 0 then 0 else sum(a1.htbrutremise*a3.remise_taux/100) end) else sum(a3.remise_taux*a1.nombredelignes) end) * (case a3.remise_natu when 1 then -(1) else 1 end)),2)*-1) as z01,NULL";
				$sql_req.=" from $fic_cial_02 a1 left join $fic_cial_03 a2 using(commercial_cleunik) left join $fic_cial_01 a3 using(commercial_cleunik) ";
				$sql_req.=" where a3.remise_genr=1 and (a1.dateheure_confirm between '$date_deb' and '$date_fin')";
				$sql_req.=" group by z03,a3.act_cleunik";
				break;

		}
		break;
}
$vf_c_echo=_graal_exec_requete($sql_req);
switch ($vl_c_sortie){
	case "sql":
		//die($sql_req);
		echo $sql_req.EOL;
		break;
}
//case 1: $sql_req="Select @rang:=@rang+1 AS z00,sum(f5.qte*($coeff)) as z01,f2.act_cleunik as z02,f2.codealphanum15 as z03,f2.raisonsoc as z04,f2.typeacteur as z05";break;
$sql_req="Select @rang:=@rang+1 AS z00,sum(a1.montant) AS z01";
switch ($ml_art_04) {
  case 1: $sql_req.=",DATE_FORMAT(a1.dateheure,GET_FORMAT(DATE,'EUR')) as z06,a1.dateheure as z07";break;
  case 2: $sql_req.=",concat(WEEK(a1.dateheure),'-',Year(a1.dateheure)) as z06,concat(year(a1.dateheure),'-',week(a1.dateheure)) as z07";break;
  case 3: $sql_req.=",DATE_FORMAT(a1.dateheure,'%m-%Y') as z06,DATE_FORMAT(a1.dateheure,'%Y-%m') as z07";break;
  case 4: $sql_req.=",concat(quarter(a1.dateheure),'-',Year(a1.dateheure)) as z06,concat(year(a1.dateheure),'-',quarter(a1.dateheure)) as z07";break;
  case 5: $sql_req.=",Year(a1.dateheure) as z06,Year(a1.dateheure) as z07";break;
}
$sql_req.=",f2.act_cleunik as z02,f2.codealphanum15 as z03,f2.raisonsoc as z04,f2.typeacteur as z05";
$sql_req.=" from _temp_stat_01 a1 left join _acteurs f2 on a1.cleunik_reference=f2.act_cleunik";
if ($genre=="accorest"){
	$sql_req.=" where a1.c_uuid='$uuid' and f2.act_cleunik in (select distinct(_act_choix_fixes.act_cleunik) from _act_choix_fixes where choix_cleunik in(10001557) and f2.typeacteur=110003) AND f2.actif in(1,2)";
} else {
	$sql_req.=" where a1.c_uuid='$uuid' and f2.typeacteur=$typeacteur";
}
switch ($ml_art_01) {
  case 1: $sql_req.=" group by f2.act_cleunik order by z01 desc";break;
  case 2: $sql_req.=" group by f2.act_cleunik order by z01 asc";break;
	case 3:  // Sélection d'acteurs dans panier
    include("_graal_req_panier_acteurs.php");
    $sql_req.=" and f2.act_cleunik in($vl_act_cleunik)";
    $sql_req.=" group by f2.act_cleunik order by z01 desc";
		break;
}
if ($nombre!=0) {$sql_req.=" limit $nombre;";}
switch ($vl_c_sortie){
	case "sql":
		echo($sql_req);
		break;
	case "das":
		header('Content-type: text/xml; charset=utf-8');
		header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
		header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
		_graal_requete_bd("SET @rang=0;");
		$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		$vl_e_nombre_types=mysql_num_rows($result);
		if ($vl_e_nombre_types!=0) {
			while ($row = mysql_fetch_assoc($result)) {
				echo('<quoi ');
		    echo(' z00="'.fa_ent_xml($row['z00']).'"');
				$z01_trie=fa_ent_xml($row['z01'])*1000;
				printf(' z01_tri="%011u"',$z01_trie);
		    echo(' z01="'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'"');
		    echo(' z02="'.fa_ent_xml($row['z02']).'"');
		    echo(' z03="'.fa_ent_xml($row['z03']).'"');
		    echo(' z04="'.fa_ent_xml($row['z04']).'"');
		    echo(' z05="'.fa_ent_xml($row['z05']).'"');
		    echo('/>');
		  }
		} else {
		    echo('<quoi ');
		    echo(' z00="0"');
		    echo(' z01="0"');
				$z01_trie=0;
				printf(' z01_tri="%011u"',$z01_trie);
		    echo(' z02="pas de données"');
		    echo(' z03="pas de données"');
		    echo(' z04="pas de données"');
		    echo(' z05="pas de données"');
		     echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		break;
	case "ods":
		$calc = new OpenOfficeSpreadsheet('stat_04.ods');
		$sheet = $calc->addSheet('Exportation XsOFt-Graal');
		$result = _graal_requete_bd($sql_req);
		$nfields = mysql_num_fields($result);
		$vl_e_noligne=1;
		//  Lecture des colonnes
		for ($i=0; $i<$nfields; $i++){
		  $fieldname = mysql_field_name($result, $i);
		  $cell = $sheet->getCell( $i,$vl_e_noligne);
		  $cell->setContent($fieldname);
		}
		//  Lecture des résultats de la requête
		while ($line = mysql_fetch_array($result, MYSQL_ASSOC)){
		  $j = 1;
		  $vl_e_noligne++;
		  foreach ($line as $field) {
		    $cell = $sheet->getCell( $j,$vl_e_noligne);
		    $cell->setContent($field);
		    $j++;
		  }
		}
		_graal_libere_requete_bd($result);
		header('Content-Type: application/vnd.oasis.opendocument.spreadsheet');
		$calc->output();
		break;

	case "xls":
		$vl_c_nom_fichier_xls="stat_04.xls";
		$fname = tempnam("mail", "$vl_c_nom_fichier_xls");
		$workbook =new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet('Exportation XsOFt-Graal');
		$result = _graal_requete_bd($sql_req);
		$nfields = mysql_num_fields($result);
		$vl_e_noligne=1;
		for ($i=0; $i<$nfields; $i++)
		{
		    $fieldname = mysql_field_name($result, $i);
		    $worksheet->write($vl_e_noligne, $i, "$fieldname");
		}
		//  Lecture des résultats de la requête

		while ($line = mysql_fetch_array($result, MYSQL_ASSOC))
		{
		  $j = 0;
		  $vl_e_noligne++;
		  foreach ($line as $field)
		  {
		      $worksheet->write($vl_e_noligne, $j, "$field");
		      $j++;
		  }
		}
		_graal_libere_requete_bd($result);
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		break;

	case "accorest":
/*
		SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_acteurs.raisonsoc as portee,_acteurs.nomcommercial as nomcommercial,
		_acteurs.typeacteur as typeacteur,codealphanum15 as code,mnemotechnique as mnemotechnique,actif as actif,f2.accorest as accorest FROM `_acteurs` left join _z_baronnat_acteurs_clients f2 using(act_cleunik) WHERE _acteurs.typeacteur IN (110003)  and _acteurs.raisonsoc like '%%' and _acteurs.act_cleunik in (select distinct(_act_choix_fixes.act_cleunik)
		from _act_choix_fixes where choix_cleunik in(10001557) and typeacteur=110003) AND _acteurs.actif in(1,2) ORDER BY `raisonsoc` ASC
		*/
		$sql_req="Select '231' as col01,quarter(a1.dateheure) as trimestre,Year(a1.dateheure) as 'an',f3.accorest as 'Code Accorest',f2.raisonsoc as nom,'21004' as col02,";
		$sql_req.="sum(a1.montant) AS CA,'EUR' as col03,'ACO.' as famille,f2.codealphanum15 as code";
		$sql_req.=" from _temp_stat_01 a1 left join _acteurs f2 on a1.cleunik_reference=f2.act_cleunik left join _z_baronnat_acteurs_clients f3 using(act_cleunik)";
		$sql_req.=" where a1.c_uuid='$uuid' and f2.act_cleunik in (select distinct(_act_choix_fixes.act_cleunik) from _act_choix_fixes where choix_cleunik in(10001557) and f2.typeacteur=110003) AND f2.actif in(1,2)";
		$sql_req.=" group by f2.act_cleunik";
		if ($nombre!=0) {$sql_req.=" limit $nombre;";}
		//die($sql_req);
		$vl_c_nom_fichier_xls="accorest_stat_04.xls";
		$fname = tempnam("mail", "$vl_c_nom_fichier_xls");
		$workbook =new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet('Exportation XsOFt-Graal');

		$result = _graal_requete_bd($sql_req);
		$nfields = mysql_num_fields($result);
		$vl_e_noligne=1;
		for ($i=0; $i<$nfields; $i++)
		{
		    $fieldname = mysql_field_name($result, $i);
		    $worksheet->write($vl_e_noligne, $i, "$fieldname");
		}
		//  Lecture des résultats de la requête

		while ($line = mysql_fetch_array($result, MYSQL_ASSOC))
		{
		  $j = 0;
		  $vl_e_noligne++;
		  foreach ($line as $field)
		  {
		      $worksheet->write($vl_e_noligne, $j, "$field");
		      $j++;
		  }
		}
		_graal_libere_requete_bd($result);
		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		break;

}
$sql_req="delete from _temp_stat_01 where c_uuid='$uuid';";
$vf_c_echo=_graal_exec_requete($sql_req);
_graal_ferme_connexion();
?>
