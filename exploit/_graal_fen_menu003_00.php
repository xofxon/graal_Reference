<?php
include("_graal_header_xul.inc.php");
$toto=fa_ent_xml("<".$_SERVER["HTTP_REFERER"].">");
$vl_c_id_fenetre="Fen_00067"; //Menu Principal
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vs_nomcommercial_entreprise=fa_recup_session('vs_nomcommercial_entreprise','');
$vs_envaa=fa_recup_session('vs_envaa','0');	//	Nombre d'utilisateurs
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_aad_101=fa_recup_dico("aad_101");
$vl_c_aad_102=fa_recup_dico("aad_102");
$vl_c_aad_103=fa_recup_dico("aad_103");
$vl_c_aad_104=fa_recup_dico("aad_104");
$vl_c_aad_105=fa_recup_dico("aad_105");
$vl_c_aad_106=fa_recup_dico("aad_106");
$vl_c_aad_107=fa_recup_dico("aad_107");
$vl_c_aad_108=fa_recup_dico("aad_108");
$vl_c_aad_109=fa_recup_dico("aad_109");
$vl_c_aad_110=fa_recup_dico("aad_110");
$vl_c_aad_112=fa_recup_dico("aad_112");
$vl_c_aad_113=fa_recup_dico("aad_113");
$vl_c_aad_114=fa_recup_dico("aad_114");
$vl_c_aad_115=fa_recup_dico("aad_115");
$vl_c_aad_116=fa_recup_dico("aad_116");
$vl_c_aad_117=fa_recup_dico("aad_117");
$vl_c_aad_118=fa_recup_dico("aad_118");
$vl_c_aad_119=fa_recup_dico("aad_119");
$vl_c_aad_120=fa_recup_dico("aad_120");$vl_c_aad_120="Fermer";
$vl_tb_droits_concept=_graal_requete_droits_fenetre('Fen_00058',$vl_e_uti_cleunik); //  Dossier conceptuel
$vl_tb_droits_admin=_graal_requete_droits_fenetre('Fen_00057',$vl_e_uti_cleunik); //  Dossier administration
if ($vs_envaa==1){
	$vl_tb_droits_admin[0]=1;
}
$vl_e_typedoc=14;
//  On recherche tous les modèles pour l'utilisateur
$vl_modeles="<hbox>";
$doc_cleunik=0;
$menu_defau_selected=" selected='true'";
$sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.descriptif_sommaire AS descriptif_sommaire FROM _droits_doc, _documents WHERE _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc=$vl_e_typedoc and descriptif_sommaire <> '-z' order by descriptif_sommaire";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
$vl_modeles=<<<EOT
  <menuitem id="bt_choix_menu_destination" label="$vl_c_aad_119" oncommand="fa_vide_arbre('treeitems');"/>
EOT;
}
else {
$vl_modeles=<<<EOT
  <menuitem id="bt_choix_menu_destination" label="$vl_c_aad_119" tooltiptext="$vl_c_aad_119" oncommand="fa_vide_arbre('treeitems');"/>
  <menuseparator/>
EOT;
  while ($row = mysql_fetch_assoc($sql_result)){
    if ($doc_cleunik==0) {
      if ($row['descriptif_sommaire']=="y"){
		  $doc_cleunik=$row['doc_cleunik'];
	      $menu_perso_selected=" selected='true' ";
	      $menu_defau_selected=" ";
	  } else {
	  	$menu_perso_selected=" ";
	  }
    } else {
      $menu_perso_selected=" ";
    }
    $vl_modeles_menu_dest.="<menuitem crop='center' oncommand='aad_pf_charge_menu_dest(".$row['doc_cleunik'].",\"".fa_remplace_quotes(fa_ent_xml($row['titre']))."\",\"".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire']))."\");' tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' $menu_perso_selected/>";
  }
  $vl_modeles.=$vl_modeles_menu_dest;
}
_graal_libere_requete_bd($sql_result);
if ($vl_tb_droits_admin[0]==1) {
  $item_admin=('<menuitem id="bt_menu_admin" label="Administration" tooltiptext="Administration" oncommand="aad_pf_charge_administration();" />');
}
if ($vs_envaa==1) {
	$item_reconnexion="";
} else {
	$item_reconnexion='<menuitem id="bt_menu_exploit_09" label="Se reconnecter (avec un autre profil)" tooltiptext="Se reconnecter (avec un autre profil)" oncommand="aad_pf_reconnecte();" />';
}
if ($vl_e_uti_cleunik==1){
	$item_gestion=('<menuitem id="bt_menu_gestion" label="Gestion de l`application" tooltiptext="Gestion de l`application" oncommand="aad_pf_charge_gestion();" />');
} else {
	$item_gestion='';
}

//  On recherche tous les modèles pages pour l'utilisateur
$vl_modeles_pages="<hbox>";
$sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.descriptif_sommaire AS descriptif_sommaire FROM _droits_doc, _documents WHERE _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc=15 order by descriptif_sommaire";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
$vl_modeles_pages=<<<EOT
  <menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' id="ml_choix_destination" hidden="true">
    <menupopup>
    </menupopup>
  </menulist>
EOT;
}
else {
$vl_modeles_pages=<<<EOT
  <menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' id="ml_choix_destination" value="1" >
    <menupopup onpopupshown="aad_pf_change_deck(1);">
EOT;
$i=0;
$vl_modeles_menu_dest="";
  while ($row = mysql_fetch_assoc($sql_result)){
  	$i++;
    $vl_modeles_menu_dest.="<menuitem value='".$i."' oncommand='aad_pf_charge_menu_dest_page(".$row['doc_cleunik'].",\"".fa_remplace_quotes(fa_ent_xml($row['titre']))."\",\"".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire']))."\");' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' tooltiptext='".fa_remplace_quotes(fa_ent_xml($row['titre']))."'/>";
  }
  $vl_modeles_pages.=$vl_modeles_menu_dest;
$vl_modeles_pages.=<<<XOF
  <menuseparator />
  $item_reconnexion
  <menuitem tooltiptext="$vl_c_aad_120" label="$vl_c_aad_120" oncommand="aad_pf_ferme();" />
  <menuitem id="bt_menu_exploit_08" tooltiptext="$vl_c_aad_114" label="$vl_c_aad_114" oncommand="fa_ferme();" />
XOF;
  $vl_modeles_pages.="</menupopup></menulist>";
}
_graal_libere_requete_bd($sql_result);


$vl_c_xml=simplexml_load_string(fa_recup_session("vs_param_environ",""));
if (isset($vl_c_xml->page_accueil)){$page_accueil=$vl_c_xml->page_accueil->attributes();}else{$page_accueil='0';}
switch ($page_accueil){
	case "0":
		$src_page_accueuil="_graal_page_intro_02.php";
		break;
	case "post_it":
		$src_page_accueuil="_graal_fen_actions_01.php?genreaction=post_it&#38;visu=oui&#38;lesquels=destinataire&#38;";
		break;
	default:
		$src_page_accueuil="_graal_bdope_note_03.php?doc_cleunik=$page_accueil&raf_random='+Math.random()+'&'";
		break;
}
$src_vide="_graal_page_blanche_01.php";
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_aad_101-$vs_nomcommercial_entreprise" onload="fa_aa(this);aad_pf_aa_init();" id="graal_fen_menu003" old_onbeforeunload="aad_pf_onbeforeunload();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include("js/_graal_menu003_00.js.php");
include_once("js/_graal_xml_dossiers_01.js.php");
include_once("js/_graal_01.js.php");
echo <<<END
<keyset>
  <key id="key_masque" modifiers="control alt" key="M" oncommand="aad_pf_cache();"/>
</keyset>
<hbox flex="1">
<vbox id="hbox_panneaudegauche" >
$vl_modeles_pages
  <menulist sizetopopup="none" onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' id="aad_menu_arbre">  
    <menupopup onpopupshown="aad_pf_change_deck(0);">
      <menuitem id="bt_deplier" tooltiptext="$vl_c_aad_103" label="$vl_c_aad_103" oncommand="fa_expand_tree('treedata');" hidden="true"/>
      <menuitem id="bt_replier" tooltiptext="$vl_c_aad_104" label="$vl_c_aad_104" oncommand="fa_collapse_tree('treedata');" hidden="true"/>
      <menuitem id="bt_gesaff" label="Masquer le dossier" oncommand="aad_pf_cache();" key="key_masque" hidden="true"/>
      <menuitem label="1 $toto" oncommand="fa_ouvre('2008_07_01_test03.php');" tooltiptext="Page d'origine $toto" hidden="true"/>
      <menuitem label="2 $toto" oncommand="aad_test();" tooltiptext="Page d'origine $toto" hidden="true"/>
      <menuitem id="bt_exploitation_defaut_01" tooltiptext="$vl_c_aad_117" label="$vl_c_aad_117" crop="center" oncommand="aad_pf_charge_exploitation_defaut_ouvert();"/>
      <menuitem id="bt_exploitation_defaut_02" tooltiptext="$vl_c_aad_118" label="$vl_c_aad_118" crop="center" oncommand="aad_pf_charge_exploitation_defaut_ferme();" $menu_defau_selected/>
      $vl_modeles
      <menuseparator />
      <menuitem id="bt_menu_exploit_04" tooltiptext="$vl_c_aad_110" label="$vl_c_aad_110" oncommand="aad_pf_charge_criteres();" />
      <menuseparator />
      $item_admin
			$item_gestion
      <menuseparator />
      $item_reconnexion
      <menuitem label="$vl_c_aad_120" tooltiptext="$vl_c_aad_120" oncommand="aad_pf_ferme();" />
			<menuitem id="bt_menu_exploit_08" tooltiptext="$vl_c_aad_114" label="$vl_c_aad_114" oncommand="fa_ferme();" />
    </menupopup>
  </menulist>
  <deck id="deck_menus" selectedindex="0" flex="1">
  <vbox>
	  <button label="close" oncommand="alert('toto');self.close;" hidden="true" />
	  <tree id="treedata" flex="1" hidecolumnpicker="true" onselect="aae_pf_selectnode('graal_iframe_menu');" collapsed="true" seltype="single">
	    <treecols>
	        <treecol id="colname"  ignoreincolumnpicker="true" class="colname"  flex="2" primary="true" hideheader="true"/>
	        <treecol hidden="true" id="colvalue" label="$vl_c_aad_108" />
	    </treecols>
	    <treechildren id="treeitems">
	    </treechildren>
	  </tree>
  </vbox>
  <vbox>
  	<iframe onload="event.stopPropagation();" id="graal_iframe_menu_pages" flex="2" src=""/>
  </vbox>
  </deck>
</vbox>
  <splitter ondblclick="aad_pf_cache();"> </splitter>
  
  <vbox flex="10">
      <iframe onload="fa_aa(window.graal_iframe_menu);event.stopPropagation();" id="graal_iframe_menu" flex="1" src="$src_page_accueuil"/>
      
  </vbox>
</hbox>
</window>
END;
?>
