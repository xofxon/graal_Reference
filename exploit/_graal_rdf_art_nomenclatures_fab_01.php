<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_e_art_cleunik=intval(fa_recup_param('vl_art_cleunik','10000337'));
$xml='';
$vf_e_niveau=0;
$xml .=fa_xcree_entete_xml().EOL;
$ret=_graal_requete_article($vl_e_art_cleunik);
$vl_c_code=$ret[0];
$vl_c_mnemotechnique=$ret[1];
$vl_c_description=$ret[2]; 
$vl_c_chaine='1 '.$ret[2].' ('.$ret[0].')';
$xml .='<dossier label="'.$vl_c_chaine.'" properties="cb" id="root">'.EOL;
pf_descente_nomenc($vl_e_art_cleunik);
$xml .='</dossier>'.EOL;
echo $xml;
_graal_ferme_connexion();
function pf_descente_nomenc($vv_art_cleunik_pere){
global $xml;
global $vf_e_niveau;
$sql_req = "SELECT art_cleunik_pere,art_cleunik_fils,noligne,quantite,unite_quantite,nb_decimales_qte,description,code,actif,(select count(*) from _nomenclatures_fab n1 where n1.art_cleunik_pere=n2.art_cleunik_fils ) as nombre_fils FROM _nomenclatures_fab n2,_article a1 where art_cleunik_pere=$vv_art_cleunik_pere and a1.art_cleunik=n2.art_cleunik_fils order by noligne asc";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $vl_c_chaine=fa_ent_xml($row['description']);
  $vl_c_qte=fa_reel(fa_ent_xml($row['quantite']),$row['nb_decimales_qte']);
  if ($row['actif']==1) {$vl_c_prop="";} else {$vl_c_prop="css_001";}
  $xml .='<item _graal_cleunik_pere="'.$row['art_cleunik_pere'].'" _graal_cleunik_fils="'.$row['art_cleunik_fils'].'" _graal_cleunik_noligne="'.$row['noligne'].'" label="'.$vl_c_chaine.'" modifiable="'.$vf_e_niveau.'" quantite="'.$vl_c_qte.'" code="'.$row['code'].'" _graal_prop="'.$vl_c_prop.'">';
  if ($row['nombre_fils']!=0) {
    $vf_e_niveau++;
    pf_descente_nomenc($row['art_cleunik_fils']);
    $vf_e_niveau--;
    $xml .='</item>'.EOL;
  } else {
    $xml .='</item>'.EOL;
  }
}
_graal_libere_requete_bd($result);
}

?>
