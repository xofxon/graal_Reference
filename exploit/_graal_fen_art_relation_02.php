<?php
include("_graal_header_xul.inc.php");
$vl_e_uti_cleunik =intval(fa_recup_session("vs_uti_cleunik","0"));
$vl_e_art_cleunik_droite=intval(fa_recup_param("vl_e_art_cleunik_droite","-1"));
$vl_e_art_cleunik_gauche=intval(fa_recup_param("vl_e_art_cleunik_gauche","-1"));
$vl_e_choix_cleunik_droite=intval(fa_recup_param("vl_e_choix_cleunik_droite","-1"));
$vl_e_choix_cleunik_gauche=intval(fa_recup_param("vl_e_choix_cleunik_gauche","-1"));
$vl_c_id_fenetre="Fen_00233";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
$vl_tb_droits[1]=0;   //  Pas d'ajout
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_bbt_100=fa_recup_dico("bbt_100");
$vl_c_bbt_101=fa_recup_dico("bbt_101");
$vl_c_bbt_102=fa_recup_dico("bbt_102");
$vl_c_dico_00010=fa_recup_dico('dico_00010');
//  On recherche les informations sur l'l'article de gauche 
$sql_req="SELECT concat_ws(' ',description,'(',code,')') as qui_gauche FROM _article where art_cleunik=$vl_e_art_cleunik_gauche;"; 
$result=_graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_qui_gauche=fa_ent_xml($row['qui_gauche']);
_graal_libere_requete_bd($result);
//  On recherche les informations sur l'article de droite 
$sql_req="SELECT concat_ws(' ',description,'(',code,')') as qui_droite FROM _article where art_cleunik=$vl_e_art_cleunik_droite;"; 
$result=_graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_qui_droite=fa_ent_xml($row['qui_droite']);
_graal_libere_requete_bd($result);

//  On recherche Tous les intitulés de relations (uniquement les utilisées !!)        
$sql_req_genre_rel = "SELECT _choix.choix_cleunik AS choix_cleunik,_choix.choix_valeur_texte_01 AS 'valeur' FROM _choix WHERE _choix.critere_cleunik IN (118) and ( choix_actif=1 or _choix.choix_cleunik =$vl_e_choix_cleunik_droite or _choix.choix_cleunik =$vl_e_choix_cleunik_gauche);";
$sql_result_genre_rel = _graal_requete_bd($sql_req_genre_rel);
$vl_e_nombre_valeurs_genres=mysql_num_rows($sql_result_genre_rel);
if ($vl_e_nombre_valeurs_genres==0){$vl_tb_droits[1]=0;$vl_tb_droits[2]=0;$vl_tb_droits[3]=0;}
$vl_b_ajout=$vl_tb_droits[1];$vl_b_modif=$vl_tb_droits[2];$vl_b_suppr=$vl_tb_droits[3];$vl_b_impri=$vl_tb_droits[4];$vl_b_detai=$vl_tb_droits[5];
include("_graal_header_winxul.inc.php"); 
echo <<<END
<window context="graal_cp00" _graal_art_cleunik_gauche="$vl_e_art_cleunik_gauche" _graal_art_cleunik_droite="$vl_e_art_cleunik_droite" _graal_choix_cleunik_droite="$vl_e_choix_cleunik_droite" _graal_choix_cleunik_gauche="$vl_e_choix_cleunik_gauche" title="$vl_c_bbt_100" id="_win_fen_art_relation" onload="fa_aa(this);pf_aa_init();" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_art_relation_02.js.php");
echo <<<END
  <groupbox >
  <textbox id="tb_qui_gauche_01" value="$vl_c_qui_gauche" disabled="true" />
  <hbox>
  <label control="la_prefixe_choix_cleunik" value="$vl_c_bbt_101"/>
  <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex="1" id="ml_rel_gauche" _graal_nombre="$vl_e_nombre_valeurs_genres" >
  <menupopup>
END;
if ($vl_e_nombre_valeurs_genres == 0) 
{
echo("<menuitem value='0' id='0' _graal_cleunik='0' label='$vl_c_dico_00010' selected='true'/>");
}
else
{
while ($row = mysql_fetch_assoc($sql_result_genre_rel))
  {
  echo("<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' selected='true'/>");
  }
}
echo <<<END
      </menupopup>
    </menulist>
  </hbox>
  <textbox id="tb_qui_droite" value="$vl_c_qui_droite" disabled="true" />
  <hbox>
  <label control="la_prefixe_choix_cleunik" value="$vl_c_bbt_101"/>
  <menulist sizetopopup="none" onfocus="setTimeout(fa_focus_gere_menulist, 0, this);" flex="1" id="ml_rel_droite" _graal_nombre="$vl_e_nombre_valeurs_genres">
  <menupopup>
END;
$sql_result_genre_rel = _graal_requete_bd($sql_req_genre_rel);
if ($vl_e_nombre_valeurs_genres == 0) 
{
echo("<menuitem value='0' id='0' _graal_cleunik='0' label='$vl_c_dico_00010' selected='true'/>");
}
else
{
while ($row = mysql_fetch_assoc($sql_result_genre_rel))
  {
  echo("<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['valeur'])). "' id='".$row['choix_cleunik'] ."' _graal_cleunik='".$row['choix_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['valeur']))."' selected='true'/>");
  }
}
echo <<<END
      </menupopup>
    </menulist>
    </hbox>
  
  
  <textbox id="tb_qui_gauche_01" value="$vl_c_qui_gauche" disabled="true" />
  <hbox>
        <label control="la_blocnotebrut" value="$vl_c_bbt_102"/>
        <textbox flex="1" id="tb_blocnotebrut"   multiline="true"/>
  </hbox>
  </groupbox>
      <hbox flex="1" id="boutons_standards" >
END;
include("_graal_inc_boutons_01.php");
echo <<<END
</hbox>
</window>
END;
?>
