<?php
include("_graal_header_xml.inc.php");
include("_graal_htbrutremise_inc.php");// contient la variable $sql_htbrutremise
define('EOL', "\r\n");
$vl_e_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','10281'));
$vl_c_genreaction=fa_recup_param('genreaction','cdecli');
switch ($vl_c_genreaction){
  case "offcli":
  case "cdecli":
  case "livcli":
  case "faccli":
  case "demfou":
  case "cdefou":
  case "recfou":
  case "facfou":
    $fichier_01="_".$vl_c_genreaction."_lignes";
    $fichier_02="_".$vl_c_genreaction."_lignes_qte";
    break;
  case "avocli":
	case "avofin":
    $fichier_01="_avocli_lignes";
    $fichier_02="_avocli_lignes_qte";
    break;
  default:
    $fichier_01="foireux";
    $fichier_02="foireux";
    break;  //  Toutes les actions génériques
}
// execution de la requète SQL
$sql_req="SELECT f1.commercial_ligne_cleunik as z01,f1.commercial_cleunik as z02,f1.ligne_cleunik as z03,f1.art_cleunik as z04,f1.code_interne as z05,f1.mnemotechnique_interne as z06,f1.description_interne as z07,f4.qte as z08,f4.qte_nbdec as z09,f4.qte_unite as z10,f1.pu as z11,f1.pu_type as z12,f1.nbdec_pu as z13,f1.remise_taux,f2.choix_valeur_texte_01 as z17,f3.choix_valeur_texte_01 as z18,f1.typeligne as z19,f1.coef_facture as coef_facture,f1.remise_genr,f1.remise_natu,f1.remise_type,$sql_htbrutremise,f4.statut from $fichier_01 f1,_choix f2,_choix f3,$fichier_02 f4 WHERE commercial_cleunik=$vl_e_commercial_cleunik and f1.commercial_ligne_cleunik=f4.commercial_ligne_cleunik and f2.choix_cleunik = qte_unite and f3.choix_cleunik=statut order by f1.ligne_cleunik;";
$result = _graal_requete_bd($sql_req);
echo(fa_xcree_entete_rdf());  
/* 
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:z00>'.fa_ent_xml($sql_req).'</row:z00>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);

  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  echo('<row:z00>'.fa_ent_xml($vl_c_genreaction).'</row:z00>');
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
*/

while ($row = mysql_fetch_assoc($result)) {
  $nb_dec_qte=fa_ent_xml($row['z09']);
  $nb_dec_pu=fa_ent_xml($row['z13']);
  echo('<RDF:li>'.EOL);
  echo('<RDF:Description>');
  //echo('<row:z00>'.fa_ent_xml($sql_req).'</row:z00>');
  echo('<row:z01 NC:parseType="Integer">'.fa_ent_xml($row['z01']).'</row:z01>');
  echo('<row:z02 NC:parseType="Integer">'.fa_ent_xml($row['z02']).'</row:z02>');
  echo('<row:z03 NC:parseType="Integer">'.fa_ent_xml($row['z03']).'</row:z03>');
  echo('<row:z04 NC:parseType="Integer">'.fa_ent_xml($row['z04']).'</row:z04>');
  echo('<row:z05>'.fa_ent_xml($row['z05']).'</row:z05>');
  echo('<row:z06>'.fa_ent_xml($row['z06']).'</row:z06>');
  echo('<row:z07>'.fa_ent_xml($row['z07']).'</row:z07>');
  if ($row['z08']==0) {$z08="";} else {$z08=fa_reel(fa_ent_xml($row['z08']),$nb_dec_qte);}
  echo('<row:z08>'.$z08.'</row:z08>');
  if ($row['z11']==0) {$z11="";} else {$z11=fa_reel(fa_ent_xml($row['z11']),$nb_dec_pu);}
  echo('<row:z11>'.$z11.'</row:z11>');
  if ($row['remise_taux']==0) {
    $z14="";
    $remise_type="";
    $remise_genre="";
  } else {
    $z14=fa_reel(fa_ent_xml($row['remise_taux']),$nb_dec_pu);
    switch ($row['remise_type']) {
      case 1:$remise_type="%";break;
      case 2:$remise_type="€";break;
    }
    switch ($row['remise_natu']) {
      case 1:$remise_genre="- ";break;
      case 2:$remise_genre="+ ";break;
    }
  }
  echo('<row:z14>'.$remise_genre.$z14.'</row:z14>');
  if (fa_ent_xml($row['z19'])=='T') {$unite="";$statut="";} else {$unite=fa_ent_xml($row['z17']);$statut=fa_ent_xml($row['z18']);}
  echo('<row:z17>'.$unite.'</row:z17>');
  $htligne=$row['z08']*$row['z11'];
  if ($htligne==0) {$htligne="";} else {$htligne=fa_reel(fa_ent_xml($htligne),$nb_dec_pu);}
  $htbrutremise=fa_reel(fa_ent_xml($row['htbrutremise']),$nb_dec_pu);
  if ($htbrutremise==$htligne) {$htbrutremise="";}
  echo('<row:htligne>'.$htligne.'</row:htligne>');
  echo('<row:z18>'.$statut.'</row:z18>');
  $coef_facture=$row['coef_facture'];
  if($coef_facture==0) {$coef_facture_clair="Non facturable";$prop_coef_facture="ag15";} else {$coef_facture_clair="";$prop_coef_facture="";}
  echo('<row:coef_facture_clair>'.$coef_facture_clair.'</row:coef_facture_clair>');
  echo('<row:prop_coef_facture>'.$prop_coef_facture.'</row:prop_coef_facture>');
  echo('<row:htbrutremise>'.$htbrutremise.'</row:htbrutremise>');
  echo('<row:remise_type>'.$remise_type.'</row:remise_type>');
  if ($row['statut']==-39) {
    echo('<row:prop_statut>ac05</row:prop_statut>');
  } else {
    echo('<row:prop_statut></row:prop_statut>');
  }
  echo('</RDF:Description>'.EOL);
  echo('</RDF:li>'.EOL);
}
// fin du fichier RDF
echo('</RDF:Bag>'.EOL);
echo('</RDF:RDF>'.EOL);
// fermeture du curseur et de la connexion
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
