<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */ 
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','ines_epac');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_epac');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','clients');


$vf_e_typeacteur=110006;


$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_fax_defaut=intval(fa_recup_param('vl_e_fax_defaut','-10'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_fax_defaut=intval(fa_recup_param('vl_e_indicatif_fax_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vl_e_genre_acteur_defaut=intval(fa_recup_param('vl_e_genre_acteur_defaut','-5'));
$vl_e_critere_cleunik_famille=intval(fa_recup_param('vl_e_critere_cleunik_famille','0'));
$vl_e_critere_cleunik_site=intval(fa_recup_param('vl_e_critere_cleunik_site','-12'));
$vl_b_silencieux=intval(fa_recup_param('vl_b_silencieux','1'));
$vl_b_compta=intval(fa_recup_param('$vl_b_compta','1'));
$vl_c_embraye=fa_recup_param("vl_c_embraye","");
$vl_e_critere_cleunik_tarcli=101;
include("_import_ines_sp_array_pays.php");
include("_import_ines_sp_array_devises.php");
include("_import_ines_sp_array_tiers.php");
/*
 * Tableau des types d'acteurs criteres 10013 chez EPAC
 */
$t01_cod=array();$t01_cle=array();$t01_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=10013";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t01_cod, $row['code']);
  array_push ($t01_cle, $row['cleunik']);
  array_push ($t01_tex, $row['text']);
}
_graal_libere_requete_bd($result);
//var_dump($t01_tex);
/*
 * Tableau des adresses 3 criteres 10014 chez EPAC
 */
$t02_cod=array();$t02_cle=array();$t02_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=10014";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t02_cod, $row['code']);
  array_push ($t02_cle, $row['cleunik']);
  array_push ($t02_tex, $row['text']);
}
_graal_libere_requete_bd($result);
/*
 * Tableau des ORIGINE_DEF criteres 10015 chez EPAC
 */
$t03_cod=array();$t03_cle=array();$t03_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=10015";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t03_cod, $row['code']);
  array_push ($t03_cle, $row['cleunik']);
  array_push ($t03_tex, $row['text']);
}
_graal_libere_requete_bd($result);
/*
 * Tableau des CL_RESP_DOSSIER criteres 10016 chez EPAC
 */
$t04_cod=array();$t04_cle=array();$t04_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=10016";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t04_cod, $row['code']);
  array_push ($t04_cle, $row['cleunik']);
  array_push ($t04_tex, $row['text']);
}
_graal_libere_requete_bd($result);
/*
 * Tableau des CL_COMMERCIAL criteres 10017 chez EPAC
 */
$t05_cod=array();$t05_cle=array();$t05_tex=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code,choix_valeur_texte_01 as text  from _choix where critere_cleunik=10017";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($t05_cod, $row['code']);
  array_push ($t05_cle, $row['cleunik']);
  array_push ($t05_tex, $row['text']);
}
_graal_libere_requete_bd($result);





            




include("_import_apisoft_sp_array_compta.php");
include("_import_apisoft_sp_array_tarifs_cli.php");
include("_import_apisoft_sp_array_geo.php");
include("_import_apisoft_sp_array_fam.php");
include("_import_apisoft_sp_array_representants.php");
include("_import_apisoft_sp_array_transporteurs.php");


include("_import_class_data_km.php");
$sql_req = "";
$sql_req.= " SELECT a1.`Numéro` as `Numéro`,a1.`CL_REF` as `CL_REF`,a1.`CL_COMPTA` as `CL_COMPTA`,a1.`CL_NOM` as `CL_NOM`,a1.`CL_AD3` as `CL_AD3`,a1.`CL_AD1` as `CL_AD1`,";
$sql_req.= " a1.`CL_AD2` as `CL_AD2`,a1.`CL_ZIP` as `CL_ZIP`,a1.`CL_VILLE` as `CL_VILLE`,a1.`CL_STATE` as `CL_STATE`,a1.`CL_PAYS` as `CL_PAYS`,a1.`ORIGINE_DEF` as `ORIGINE_DEF`,";
$sql_req.= " a1.`TYPE_CLI` as `TYPE_CLI`,a1.`CL_TEL` as `CL_TEL`,a1.`CL_FAX` as `CL_FAX`,a1.`CL_URL` as `CL_URL`,a1.`CL_RESP_DOSSIER` as `CL_RESP_DOSSIER`,";
$sql_req.= " a1.`CL_COMMERCIAL` as `CL_COMMERCIAL`,a1.`CL_SIREN` as `CL_SIREN`,a1.`CL_MAISON_MERE` as `CL_MAISON_MERE`,a1.`CL_DATE` as `CL_DATE`,a1.`CL_REM` as `CL_REM`";
$sql_req.= " FROM $vl_c_base_origine.$vl_c_fic_tiers a1";


if (isset($_SESSION['vl_c_condition_client'])){
	$sql_condition=$_SESSION['vl_c_condition_client'];
	$sql_req.=" where Code in($sql_condition) ";
}
$sql_req.= " order by 1";
//$sql_req.=" Limit 60";
echo $sql_req;
//die("$sql_req");
$result = _graal_requete_bd($sql_req);



$o_acteur=new _graal_import();
$o_compta=new _graal_import();
$o_choix=new _graal_import();
$o_adresses=new _graal_import();
$o_rib=new _graal_import();
$o_interlo=new _graal_import();
$o_fax=new _graal_import();
$o_tel=new _graal_import();
$o_rep=new _graal_import();
$o_relation=new _graal_import();
$o_fonction=new _graal_import();
$o_sit=new _graal_import();
$o_acteur->req="INSERT INTO $vl_c_base_destination._acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,blocnotebrut,blocnotertf,dateheuremodif,dateheurecreation,typeacteur,c_uuid,mnemotechnique,devise) VALUES ";
//  Attention, mode de règlement traité plus bas
$o_compta->req="INSERT INTO $vl_c_base_destination._act_compta (act_cleunik,compte,tvaintracommunautaire,catcompta_cleunik,encours_autorise,tarif_cleunik,remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu,assujetti_tpf,montant_port,seuil_franco) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_adresses (adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_rib->req="INSERT INTO $vl_c_base_destination._act_rib (rib_cleunik,Domiciliation,Etablissement,Guichet,Compte,Cle,act_cleunik,Principal) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik) VALUES ";
$o_fax->req="INSERT INTO $vl_c_base_destination._act_interlo_fax (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik,portable,sms) VALUES ";
$o_rep->req="INSERT INTO $vl_c_base_destination._acteurs_representants (act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_relation->req="INSERT INTO $vl_c_base_destination._acteurs_relations(act_cleunik_gauche,choix_cleunik_gauche,choix_cleunik_droite,act_cleunik_droite) VALUES ";
$o_fonction->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$o_sit->req="INSERT INTO $vl_c_base_destination._act_sites(site_cleunik,refweb,act_cleunik,choix_cleunik) VALUES ";
//$vf_e_act_cleunik=_graal_requete_max("act_cleunik","$vl_c_base_destination._acteurs");
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_adresses");
$vf_e_rib_cleunik=_graal_requete_max("rib_cleunik","$vl_c_base_destination._act_rib");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_fax_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_fax");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$vf_e_sit_cleunik=_graal_requete_max("site_cleunik","$vl_c_base_destination._act_sites");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;
session_write_close();
//if (1==2){
while ($row = mysql_fetch_assoc($result)) {
	$code_acteur=sprintf("%d",$row['CL_REF']);
	$vl_e_trouve_acteur=array_search($code_acteur, $acteur_cod);
	echo "cherche $code_acteur -> $vl_e_trouve_acteur".EOL;
	//die ("Trouvé ".$row['Code']);
	if ($vl_e_trouve_acteur==true) {
		//die ("pas trouvé ".$row['Code']);
	//  Ajout dans la table des acteurs
	  //$vl_e_trouve_devise=array_search($row['Devise'], $devise_cod);if ($vl_e_trouve_devise===false) {$devise=122047;} else {$devise=$devise_cle[$vl_e_trouve_devise];}
	  $vl_e_trouve_devise=array_search("?????", $devise_cod);if ($vl_e_trouve_devise===false) {$devise=122047;} else {$devise=$devise_cle[$vl_e_trouve_devise];}
	  $i++;
	  $vf_e_act_cleunik=$acteur_cle[$vl_e_trouve_acteur];
	  $codealphanum15=$code_acteur;
	  $raisonsoc=fa_nt($row['CL_NOM']);
	  //$nomcommercial=addslashes($row['CL_NOM']);
	  $nomcommercial=fa_nt("");
	  $blocnotebrut=fa_nt($row['CL_REM']);
	  //$blocnotertf=addslashes($row['Memo']);
	  $blocnotertf=fa_nt("");
	  $dateheuremodif=fa_nt($row['CL_DATE']);
	  $dateheurecreation=fa_nt($row['CL_DATE']);
	  $typeacteur=$vf_e_typeacteur;
	  $uuid=_graal_requete_uuid();
	  $mnemotechnique=$code_acteur;
	  $o_acteur->dat.="($vf_e_act_cleunik,'$codealphanum15',$raisonsoc,$nomcommercial,$blocnotebrut,$blocnotertf,$dateheuremodif,$dateheurecreation,$typeacteur,'$uuid','$mnemotechnique',$devise),";
		$vl_e_choix_cleunik=0;
		$val_test=fa_nn_blanc($row['TYPE_CLI']);
		//echo $val_test.EOL;
	    if (trim($val_test!="")){
		    $vl_e_trouve=array_search($val_test, $t01_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t01_cle[$vl_e_trouve];}
		    if ($vl_e_choix_cleunik!=0) {
		      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,10013,$vf_e_typeacteur),";
		    } else {
		    	//echo "pas trouvé";
		    }
	    }
	    //echo $o_choix->dat.EOL;
	    $vl_e_choix_cleunik=0;
	    $val_test=fa_nn_blanc($row['CL_AD3']);
	    if (trim($val_test!="")){
		    $vl_e_trouve=array_search($val_test, $t02_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t02_cle[$vl_e_trouve];}
		    if ($vl_e_choix_cleunik!=0) {
		      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,10014,$vf_e_typeacteur),";
		    }
	    }
		$vl_e_choix_cleunik=0;
	    $val_test=fa_nn_blanc($row['ORIGINE_DEF']);
	    if (trim($val_test!="")){
		    $vl_e_trouve=array_search($val_test, $t03_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t03_cle[$vl_e_trouve];}
		    if ($vl_e_choix_cleunik!=0) {
		      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,10015,$vf_e_typeacteur),";
		    }
	    }
		$vl_e_choix_cleunik=0;
	    $val_test=fa_nn_blanc($row['CL_RESP_DOSSIER']);
	    if (trim($val_test!="")){
		    $vl_e_trouve=array_search($val_test, $t04_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t04_cle[$vl_e_trouve];}
		    if ($vl_e_choix_cleunik!=0) {
		      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,10016,$vf_e_typeacteur),";
		    }
	    }
		$vl_e_choix_cleunik=0;
	    $val_test=fa_nn_blanc($row['CL_COMMERCIAL']);
	    if (trim($val_test!="")){
		    $vl_e_trouve=array_search($val_test, $t05_tex);if ($vl_e_trouve===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$t05_cle[$vl_e_trouve];}
		    if ($vl_e_choix_cleunik!=0) {
		      $o_choix->dat.="($vf_e_act_cleunik,$vl_e_choix_cleunik,10017,$vf_e_typeacteur),";
		    }
	    }
		//  Ajout dans la table des _act_adresses (adresses au format français) des adresses de facturation     
	    /*
	     * a1.`CL_AD3` as `CL_AD3`,a1.`CL_STATE` as `CL_STATE` pas significatifs chez EPAC
	     * ,a1.`CL_AD1` as `CL_AD1`, a1.`CL_AD2` as `CL_AD2`,a1.`CL_ZIP` as `CL_ZIP`,a1.`CL_VILLE` as `CL_VILLE`,a1.`CL_PAYS` as `CL_PAYS`
	     */
	  $vl_c_chainefac=trim(fa_nn_blanc($row['CL_AD1']).fa_nn_blanc($row['CL_AD2']).fa_nn_blanc($row['CL_PAYS']).fa_nn_blanc($row['CL_ZIP']).fa_nn_blanc($row['CL_VILLE']));
	  $vl_c_chaineliv=trim(fa_nn_blanc($row['CL_AD1']).fa_nn_blanc($row['CL_AD2']).fa_nn_blanc($row['CL_PAYS']).fa_nn_blanc($row['CL_ZIP']).fa_nn_blanc($row['CL_VILLE']));
	  //  On ajoute uniquement si l'adresse est un minimum renseignée
	  //echo "Adresse fac -> $vl_c_chainefac".EOL;
	  if ($vl_c_chainefac!="") {
	    $vl_e_trouve=array_search($row['CL_PAYS'], $pays_cod);if ($vl_e_trouve===false) {$vl_e_cleunik_pays=60000;} else {$vl_e_cleunik_pays=$pays_cle[$vl_e_trouve];}
	    $vf_e_adr_cleunik++;
	    $adr_complementnom=fa_nt("");
	    $adr_ligne1=fa_nt($row['CL_AD1']);
	    $adr_ligne2=fa_nt($row['CL_AD2']);
	    $adr_cp=fa_nt($row['CL_ZIP']);
	    $adr_ville=fa_nt($row['CL_VILLE']);
	    if ($vl_c_chainefac==$vl_c_chaineliv){
	    	$adr_typecoordonnees=3;
	    	$vl_c_chaineliv="";
	    } else {
	    	$adr_typecoordonnees=1;
	    }
	    $o_adresses->dat.="($vf_e_adr_cleunik,'Fac01',$vf_e_act_cleunik,$adr_complementnom,$adr_ligne1,$adr_ligne2,$adr_cp,$adr_ville,$vl_e_cleunik_pays,$adr_typecoordonnees),";
	    //echo ($o_adresses->req.$o_adresses->dat);
	    //exit();
	  }
	//  Ajout dans la table des _act_adresses (adresses au format français) des adresses de livraison          
	  //  On ajoute uniquement si l'adresse est un minimum renseignée
	  if ($vl_c_chaineliv!=""){
	    $vl_e_trouve=array_search($row['CL_PAYS'], $pays_cod);if ($vl_e_trouve===false) {$vl_e_cleunik_pays=60000;} else {$vl_e_cleunik_pays=$pays_cle[$vl_e_trouve];}
	    $vf_e_adr_cleunik++;
	    $adr_complementnom=fa_nt("");
	    $adr_ligne1=fa_nt($row['CL_AD1']);
	    $adr_ligne2=fa_nt($row['CL_AD2']);
	    $adr_cp=fa_nt($row['CL_ZIP']);
	    $adr_ville=fa_nt($row['CL_VILLE']);
	    $o_adresses->dat.="($vf_e_adr_cleunik,'Liv01',$vf_e_act_cleunik,$adr_complementnom,$adr_ligne1,$adr_ligne2,$adr_cp,$adr_ville,$vl_e_cleunik_pays,2),";
	  }
		$vl_c_chaine=trim(fa_nn_blanc($row['CL_URL']));
	    //  On ajoute uniquement si le site de livraison est renseigné
	    if ($vl_c_chaine!=""){
	      $vf_e_sit_cleunik++;
	      $refweb=fa_nt($row['CL_URL']);
	      $o_sit->dat.="($vf_e_sit_cleunik,$refweb,$vf_e_act_cleunik,$vl_e_critere_cleunik_site),";
	    } 
	    
	//  Ajout dans la table des _act_interlo (Interlocuteurs des acteurs) (Standard)
	  $vl_c_chaine=trim(fa_nn_blanc($row['CL_TEL']).fa_nn_blanc($row['CL_FAX']));
	  $vl_c_liv=$vl_c_chaine;
	  //  On ajoute uniquement si l'interlocuteur de livraison est un minimum renseigné
	  if ($vl_c_chaine!=""){
	    $vf_e_int_cleunik++;
	    $patronyme="Standard";
	    $o_interlo->dat.="($vf_e_int_cleunik,'Sta01',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
	    $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,-7,92,$vf_e_typeacteur,0),";
	    $vl_c_chaine=trim(fa_nn_blanc($row['CL_FAX']));
	    $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine); 
	    //  On ajoute uniquement si le fax est renseigné
	    if ($vl_c_chaine_nette!=""){
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_fax_cleunik++;
	      $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
	    }
	    $vl_c_chaine=trim(fa_nn_blanc($row['CL_TEL']));
	    $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
	    //  On ajoute uniquement si le téléphone est renseigné
	    if ($vl_c_chaine_nette!=""){
	      $vl_c_chaine_brute=addslashes($vl_c_chaine);
	      $vf_e_tel_cleunik++;
	      $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut,1,1),";
	    }
	  }
	  if ($i % $i1==0){
	  	echo $o_adresses->req.$o_adresses->dat;
	    $o_adresses->execute();
	  }
	}
}
echo $o_adresses->req.$o_adresses->dat;
$o_adresses->execute();

_graal_ferme_connexion();
if ($vl_b_silencieux==1){
	echo("$i adresses importées.");
}
if ($vl_c_embraye!=""){
	header("$vl_c_embraye");
}
?>
