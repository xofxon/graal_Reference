<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$actif=fa_recup_param('actif','-1');
$portee=fa_recup_param('portee','-1');
$zone=fa_recup_param('zone','boumbadaboom');
$limit=intval(fa_recup_param('limit','50'));
$type_recherche=intval(fa_recup_param('type_recherche','0'));
switch ($zone) {
  case '2':
    $valeur_retour="concat(code,'(',description,')')";
    $zone_clair="code";
    break;
  case '3':
    $valeur_retour="concat(mnemotechnique,'(',description,')')";
    $zone_clair="mnemotechnique";
    break;
  case '1':
    $valeur_retour="concat(description,'(',mnemotechnique,')')";
    $zone_clair="description";
    break;
}
switch ($type_recherche) {
  case "0":
    $sql_req="SELECT art_cleunik,'??' as 'valeur_retour' FROM _article where 1=2;";
    break;
  case "1":
    $recherche=fa_recup_param('recherche','');
    $condactif="";$condportee="";
    if ($actif!="-1") {$condactif="and actif=$actif";}
    if ($portee!="-1") {$condportee="and types_gestion & $portee";}
    $sql_req="SELECT art_cleunik,$valeur_retour as 'valeur_retour' FROM _article where $zone_clair like '$recherche%' $condactif $condportee limit $limit;";
    break;
  case "2":
    $recherche=fa_recup_param('recherche','');
    $condactif="";$condportee="";
    if ($actif!="-1") {$condactif="and actif=$actif";}
    if ($portee!="-1") {$condportee="and types_gestion & $portee";}
    $sql_req="SELECT art_cleunik,$valeur_retour as 'valeur_retour' FROM _article where $zone_clair like '$recherche%' $condactif $condportee and (SELECT count(*) as nombre from _art_choix_fixes where _art_choix_fixes.choix_cleunik=-95 and _art_choix_fixes.art_cleunik=_article.art_cleunik) >0 limit $limit;";
    break;
}
$result = _graal_requete_bd($sql_req);
//echo $sql_req;
echo <<<END
<?xml version="1.0" encoding="UTF-8"?>
<RDF:RDF xmlns:RDF="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:NC="http://home.netscape.com/NC-rdf#" xmlns:KEY="urn:suggest:rdf#">
<RDF:Seq RDF:about="urn:suggest:values">
END;
$vl_e_nombre_enr=mysql_num_rows($result);
if ($vl_e_nombre_enr!=0) { 
  while ($row = mysql_fetch_assoc($result)){
    echo('<RDF:li><RDF:Description KEY:label="'.fa_ent_xml($row['valeur_retour']).'" KEY:issuggest="'.fa_ent_xml($row['art_cleunik']).'" KEY:prop=""/></RDF:li>'.EOL);
  }    
echo <<<END
  </RDF:Seq>
  <RDF:Seq RDF:about="urn:suggest:nb">
    <RDF:li><RDF:Description RDF:number="$vl_e_nombre_enr"/></RDF:li>
  </RDF:Seq>
END;
} else {
echo <<<END
  </RDF:Seq>
  <RDF:Seq RDF:about="urn:suggest:nb">
    <RDF:li><RDF:Description RDF:number="$vl_e_nombre_enr"/></RDF:li>
  </RDF:Seq>
END;
}

echo('</RDF:RDF>'.EOL);
_graal_libere_requete_bd($result);
?>
