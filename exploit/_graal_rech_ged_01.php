<?php
require("_graal_fonctions_diverses.php");
include("_graal_var_portee.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_t_listecles=fa_recup_param('vl_t_listecles','');

$vl_e_portee_cleunik=intval(fa_recup_param('vl_e_portee_cleunik','0'));
$vl_c_sortie=fa_recup_param('sortie','rdf');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_c_qui=fa_recup_param('vl_c_qui','888888');
$vl_c_actifs=fa_recup_param('vl_c_actifs','0');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','0'));
$vl_c_quelleplage=fa_recup_param('vl_c_quelleplage','debut');
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','19610123');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','20610123');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_tout=intval(fa_recup_param('vl_e_tout','0'));
$vl_c_selection=fa_recup_param('selection','non');
$vl_c_sauf=fa_recup_param('vl_c_sauf','aucune');
$genre_droits=fa_recup_param('genre_droits','raf');
$uti_cleunik_droits=intval(fa_recup_param('uti_cleunik_droits','-1'));
$gestion_droits=fa_recup_param('gestion_droits','raf');
switch ($vl_c_qui) {
	case 'dossieract'   :$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'dossierclient':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110003)";break;
  case 'dossierprocli':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110001)";break;
  case 'dossierfourni':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110004)";break;
  case 'dossierprofou':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110002)";break;
  case 'dossierautact':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110005)";break;
  case 'dossieractind':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110006)";break;
  case 'dossierentrep':$vl_e_portee=$vl_e_entrep;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110000)";break;


	case 'pseudodocact'   :$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'pseudodocclient':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110003)";break;
  case 'pseudodocprocli':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110001)";break;
  case 'pseudodocfourni':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110004)";break;
  case 'pseudodocprofou':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110002)";break;
  case 'pseudodocautact':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110005)";break;
  case 'pseudodocactind':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110006)";break;
  case 'pseudodocentrep':$vl_e_portee=$vl_e_entrep;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110000)";break;

  case 'notact'   :$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'notclient':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110003)";break;
  case 'notprocli':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110001)";break;
  case 'notfourni':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110004)";break;
  case 'notprofou':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110002)";break;
  case 'notautact':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110005)";break;
  case 'notactind':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110006)";break;
  case 'notentrep':$vl_e_portee=$vl_e_entrep;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110000)";break;

  case 'docact'   :$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'docclient':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110003)";break;
  case 'docprocli':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110001)";break;
  case 'docfourni':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110004)";break;
  case 'docprofou':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110002)";break;
  case 'docautact':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110005)";break;
  case 'docactind':$vl_e_portee=$vl_e_acteur;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110006)";break;
  case 'docentrep':$vl_e_portee=$vl_e_entrep;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110000)";break;



  case 'notinterl'    :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'notintclient' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110003)";break;
  case 'notintprocli' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110001)";break;
  case 'notintfourni' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110004)";break;
  case 'notintprofou' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110002)";break;
  case 'notintautact' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110005)";break;
  case 'notintactind' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=2;$vl_e_typeacteur=" in(110006)";break;

  case 'docinterl'    :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'docintclient' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110003)";break;
  case 'docintprocli' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110001)";break;
  case 'docintfourni' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110004)";break;
  case 'docintprofou' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110002)";break;
  case 'docintautact' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110005)";break;
  case 'docintactind' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc="3,13";$vl_e_typeacteur=" in(110006)";break;

	case 'pseudodocinterl'    :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'pseudodocintclient' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110003)";break;
  case 'pseudodocintprocli' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110001)";break;
  case 'pseudodocintfourni' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110004)";break;
  case 'pseudodocintprofou' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110002)";break;
  case 'pseudodocintautact' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110005)";break;
  case 'pseudodocintactind' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=1;$vl_e_typeacteur=" in(110006)";break;

	case 'pseudodocaction':$vl_e_portee=$vl_e_action;$vl_e_typedoc=1;break;
  case 'pseudodocarticl':$vl_e_portee=$vl_e_articl;$vl_e_typedoc=1;break;

  case 'dossierinterl'    :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110000,110001,110002,110003,110004,110005,110006)";break;
  case 'dossierintclient' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110003)";break;
  case 'dossierintprocli' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110001)";break;
  case 'dossierintfourni' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110004)";break;
  case 'dossierintprofou' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110002)";break;
  case 'dossierintautact' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110005)";break;
  case 'dossierintactind' :$vl_e_portee=$vl_e_interl;$vl_e_typedoc=4;$vl_e_typeacteur=" in(110006)";break;

	case 'dossieraction':$vl_e_portee=$vl_e_action;$vl_e_typedoc=4;break;
  case 'dossierarticl':$vl_e_portee=$vl_e_articl;$vl_e_typedoc=4;break;

  case 'notaction':$vl_e_portee=$vl_e_action;$vl_e_typedoc=2;break;
  case 'notarticl':$vl_e_portee=$vl_e_articl;$vl_e_typedoc=2;break;

  case 'docaction':$vl_e_portee=$vl_e_action;$vl_e_typedoc="3,13";break;
  case 'docarticl':$vl_e_portee=$vl_e_articl;$vl_e_typedoc="3,13";break;


	case 'pseudodocfav':$vl_e_typedoc=1;break;
  case 'pseudodocmoi':$vl_e_typedoc=1;break;
  case 'pseudodocnos':$vl_e_typedoc=1;break;
  case 'pseudodoceux':$vl_e_typedoc=1;break;

case 'dossierfav':$vl_e_typedoc=4;break;
  case 'dossiermoi':$vl_e_typedoc=4;break;
  case 'dossiernos':$vl_e_typedoc=4;break;
  case 'dossiereux':$vl_e_typedoc=4;break;
  case 'notfav':$vl_e_typedoc=2;break;
  case 'notmoi':$vl_e_typedoc=2;break;
  case 'notnos':$vl_e_typedoc=2;break;
  case 'noteux':$vl_e_typedoc=2;break;

  case 'docfav':$vl_e_typedoc="3,13";break;
  case 'docmoi':$vl_e_typedoc="3,13";break;
  case 'docnos':$vl_e_typedoc="3,13";break;
  case 'doceux':$vl_e_typedoc="3,13";break;
  case 'docs'  :$vl_e_typedoc="3,13";break;
  case 'cgv'	:$vl_e_portee=$vl_e_entrep;$vl_e_typedoc=900;break;
  case 'palett'	:$vl_e_portee=$vl_e_entrep;$vl_e_typedoc=153;break;
  case 'filigrane'	:$vl_e_portee=$vl_e_entrep;$vl_e_typedoc=154;break;

}
//die($vl_c_actifs);
switch ($vl_c_actifs) {
  case '3': // Panier ou requête
  	require_once("_graal_fonctions_mysql.php");
    $sql_req = "SELECT panier_requete_selection as req,panier_resultat,panier_type FROM `_panier` WHERE panier_cleunik=$vl_e_panier";
    $result = _graal_requete_bd($sql_req);
    $row = mysql_fetch_assoc($result);
    if ($row['panier_type']==1) {
      $vl_e_panier=$row['panier_resultat'];
      _graal_libere_requete_bd($result);
    } else {
      $sql_req = $row['req'];
      _graal_libere_requete_bd($result);
      $result = _graal_requete_bd($sql_req);
      $vl_e_panier="";
      while ($row = mysql_fetch_assoc($result)) {
        $vl_e_panier.=$row['doc_cleunik'].',';
      }
    }
    if(trim($vl_e_panier)!=""){
    	$vl_e_panier=substr($vl_e_panier,0,-1);
    }
    $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,";
    $sql_req.= " _documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,";
    $sql_req.= " _documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,";
    $sql_req.= " _documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement ";
    $sql_req.= " FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik ";
    $sql_req.= " AND _documents.doc_cleunik in($vl_e_panier)";
    $vl_e_limit=0;
    //die($sql_req);
    break;
  case '1':
  case '2':
  case '0':
    switch ($vl_c_type) {
      case '0': //  Liste de clés
      /*
        $vl_t_listecles=unserialize(stripslashes($vl_t_listecles));
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_act_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_act_cleunik!="") {
          $vl_act_cleunik=substr($vl_act_cleunik, 0, -1);
        }
        $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_choix.choix_valeur_texte_01 as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur,codealphanum15 as code,mnemotechnique as mnemotechnique,actif as actif FROM `_acteurs`,`_choix` WHERE _choix.choix_cleunik=_acteurs.typeacteur and act_cleunik IN($vl_act_cleunik)";
      */
        break;
      case '1': //  recherche orthographique
        switch ($vl_c_qui) {
          case 'liaisons':  //  Toutes les liaisons d'un document
            $sql_req="SELECT f1.actif,unix_timestamp(f1.dateheurecreation) as ut_dateheurecreation,unix_timestamp(f1.dateheuremodif) as ut_dateheuremodif,f1.doc_cleunik as doc_cleunik,f1.dateheurecreation as dateheurecreation,f1.dateheuremodif as dateheuremodif,f1.emplacement as emplacement,f1.titre as titre,f1.typedoc as typedoc,f1.descriptif_sommaire as descriptif_sommaire,f1.origine as origine,f2.portee as portee,f2.rat_cleunik as rattachement,case f2.portee when 1 then (select nomcommercial from _acteurs where act_cleunik=rat_cleunik) when 1024 then (select description from _article where art_cleunik=rat_cleunik) when 2048 then (select concat_ws(' ',a1.sujet,'(',a2.choix_valeur_texte_01,')') from _actions a1 left join _choix a2 using (choix_cleunik) where action_cleunik=rat_cleunik) when 4096 then (select concat_ws(' ',a1.prenom,a1.patronyme) from _act_interlo a1 where int_cleunik=rat_cleunik) when 8192 then (select concat_ws(' ',a1.raisonsoc,a1.nomcommercial,'(',a2.choix_valeur_texte_01,')') from _acteurs a1 left join _choix a2 on (a1.typeacteur=a2.choix_cleunik) where act_cleunik=rat_cleunik) when 32768 then (select concat_ws(' ',prenom,patronyme) from _utilisateur where uti_cleunik=rat_cleunik) when 65536 then (select concat_ws(' ',a1.sujet,'(',a2.choix_valeur_texte_01,')[Pièce jointe]') from _actions a1 left join _choix a2 using (choix_cleunik) where action_cleunik=rat_cleunik) when 32768 then (select concat_ws(' ',prenom,patronyme) from _utilisateur where uti_cleunik=rat_cleunik) when 262144 then (select concat_ws(' ',a1.sujet,'(',a2.choix_valeur_texte_01,')') from _actions a1 left join _choix a2 using (choix_cleunik) where action_cleunik=rat_cleunik) END as 'qui_quoi' FROM _documents f1 left join _documents_rattachement f2 using (doc_cleunik) WHERE f1.doc_cleunik=$vl_e_portee_cleunik";
            break;
          case '555555': //toutes les actions
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_action and _documents_rattachement.rat_cleunik=$vl_e_portee_cleunik";
            break;
          case '666666': //tous les interlocuteurs
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_interl and  _documents_rattachement.rat_cleunik=$vl_e_portee_cleunik";
			$sql_tou = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents.doc_cleunik in(SELECT f2.doc_cleunik FROM _documents f3 left join _documents_rattachement f2 using (doc_cleunik) left join _actions f1 on f1.action_cleunik=f2.rat_cleunik left join _graal f4 using (action_cleunik) where f4.int_cleunik=$vl_e_portee_cleunik and f2.portee & 2048+65536 ";
            break;
          case '777777': //GED de tous les articles sauf les images (géré dans _graal_rech_ged_02.php)
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_articl and  _documents_rattachement.rat_cleunik=$vl_e_portee_cleunik and typedoc<>9";
            break;
          case '999999': //tous les acteurs
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_acteur and  _documents_rattachement.rat_cleunik=$vl_e_portee_cleunik";
			$sql_tou = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents.doc_cleunik in(SELECT f2.doc_cleunik FROM _documents f3 left join _documents_rattachement f2 using (doc_cleunik) left join _actions f1 on f1.action_cleunik=f2.rat_cleunik left join _graal f4 using (action_cleunik) where f4.act_cleunik=$vl_e_portee_cleunik and f2.portee & 2048+65536 ";
            break;
          case '999998': //Entreprise
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_entrep and  _documents_rattachement.rat_cleunik=0 and typedoc in(1,2,3,4,13)";
            break;
          case '888888':  //  Favoris
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents.doc_cleunik IN (SELECT _documents_favoris.doc_cleunik from _documents_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";
            break;
          case 'notfav':  //  Mes notes favorites
          case 'docfav':  //  Mes documents favori
          case 'pseudodocfav':  //  Mes pseudo-documents favoris
          case 'dossierfav':  //  Mes pseudo-documents favoris
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and typedoc in($vl_e_typedoc) and _documents.doc_cleunik IN (SELECT _documents_favoris.doc_cleunik from _documents_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";
            break;
          case 'notmoi':
          case 'docmoi':
		  case 'pseudodocmoi':
		  case 'dossiermoi':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents.doc_cleunik in(SELECT distinct(_documents.doc_cleunik) AS doc_cleunik FROM _droits_doc, _documents	WHERE _documents.doc_cleunik = _droits_doc.doc_cleunik AND _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.typedoc in ($vl_e_typedoc)) ";
            break;
          case 'notnos':
          case 'docnos':
		  case 'pseudodocnos':
		  case 'dossiernos':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement`,_droits_doc,_utilisateur WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _utilisateur.uti_cleunik = _droits_doc.uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc in($vl_e_typedoc) and (select count(*) from _droits_doc where _documents.doc_cleunik = _droits_doc.doc_cleunik and _droits_doc.uti_cleunik=$vl_e_uti_cleunik) > 0 ";
            break;
          case 'noteux':
          case 'doceux':
		  case 'pseudodoceux':
		  case 'dossiereux':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement`,_droits_doc,_utilisateur WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _utilisateur.uti_cleunik = _droits_doc.uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc in($vl_e_typedoc) AND _droits_doc.uti_cleunik<>$vl_e_uti_cleunik and (select count(*) from _droits_doc where _documents.doc_cleunik = _droits_doc.doc_cleunik and _droits_doc.uti_cleunik=$vl_e_uti_cleunik) > 0";
            break;
          case 'notaction':
          case 'docaction':
		  case 'pseudodocaction':
		  case 'dossieraction':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_actions.sujet,_actions.description,_actions.choix_cleunik,_choix.choix_valeur_texte_01 FROM `_documents`,`_documents_rattachement`,`_actions`,`_choix` WHERE _documents.typedoc in($vl_e_typedoc) and _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_portee and _documents_rattachement.rat_cleunik=_actions.action_cleunik and _choix.choix_cleunik=_actions.choix_cleunik";
            break;
          case 'notarticl':
          case 'docarticl':
		  case 'pseudodocarticl':
		  case 'dossierarticl':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_article.mnemotechnique,_article.description FROM `_documents`,`_documents_rattachement`,`_article` WHERE _documents.typedoc in($vl_e_typedoc) and _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_portee and _documents_rattachement.rat_cleunik=_article.art_cleunik";
            break;
          case 'notact':
          case 'notclient':
          case 'notprocli':
          case 'notfourni':
          case 'notprofou':
          case 'notautact':
          case 'notactind':
          case 'notentrep':
          case 'docact':
          case 'docclient':
          case 'docprocli':
          case 'docfourni':
          case 'docprofou':
          case 'docautact':
          case 'docactind':
          case 'docentrep':
		  case 'pseudodocact':
          case 'pseudodocclient':
          case 'pseudodocprocli':
          case 'pseudodocfourni':
          case 'pseudodocprofou':
          case 'pseudodocautact':
          case 'pseudodocactind':
          case 'pseudodocentrep':
          case 'dossieract':
          case 'dossierclient':
          case 'dossierprocli':
          case 'dossierfourni':
          case 'dossierprofou':
          case 'dossierautact':
          case 'dossieractind':
          case 'dossierentrep':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_acteurs.raisonsoc,_acteurs.nomcommercial,_acteurs.typeacteur,_choix.choix_valeur_texte_01 FROM `_documents`,`_documents_rattachement`,`_acteurs`,`_choix` WHERE _documents.typedoc in($vl_e_typedoc) and _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_portee and _documents_rattachement.rat_cleunik=_acteurs.act_cleunik and _choix.choix_cleunik=_acteurs.typeacteur and _choix.choix_cleunik$vl_e_typeacteur";
            break;
          case 'notinterl':
          case 'notintclient':
          case 'notintprocli':
          case 'notintfourni':
          case 'notintprofou':
          case 'notintautact':
          case 'notintactind':
          case 'docinterl':
          case 'docintclient':
          case 'docintprocli':
          case 'docintfourni':
          case 'docintprofou':
          case 'docintautact':
          case 'docintactind':
          case 'pseudodocinterl':
          case 'pseudodocintclient':
          case 'pseudodocintprocli':
          case 'pseudodocintfourni':
          case 'pseudodocintprofou':
          case 'pseudodocintautact':
          case 'pseudodocintactind':
          case 'dossierinterl':
          case 'dossierintclient':
          case 'dossierintprocli':
          case 'dossierintfourni':
          case 'dossierintprofou':
          case 'dossierintautact':
          case 'dossierintactind':
            $sql_req.="SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_acteurs.raisonsoc,_acteurs.nomcommercial,_acteurs.typeacteur,_choix.choix_valeur_texte_01,_act_interlo.prenom,_act_interlo.patronyme FROM `_documents`,`_documents_rattachement`,`_acteurs`,`_choix`,`_act_interlo` WHERE _documents.typedoc in($vl_e_typedoc) and _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.portee = $vl_e_portee and _documents_rattachement.rat_cleunik=_act_interlo.int_cleunik and _choix.choix_cleunik=_acteurs.typeacteur and _acteurs.act_cleunik=_act_interlo.act_cleunik and _choix.choix_cleunik$vl_e_typeacteur";
            break;
          case "docpj":
            $sql_req.="SELECT _documents.actif,unix_timestamp(_actions.dateheuredebut) as ut_dateheurecreation,unix_timestamp(_actions.dateheurefin) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_actions.dateheurecreation as dateheurecreation,_actions.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement,_actions.sujet,_actions.description,_actions.choix_cleunik,_choix.choix_valeur_texte_01 FROM `_documents`,`_documents_rattachement`,`_actions`,`_choix` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents_rattachement.rat_cleunik=_actions.action_cleunik and _choix.choix_cleunik=_actions.choix_cleunik and emplacement like '%' and _documents.doc_cleunik in (select distinct _documents_rattachement.doc_cleunik from _documents_rattachement,_actions,_documents where _documents.doc_cleunik=_documents_rattachement.doc_cleunik and _documents_rattachement.rat_cleunik=_actions.action_cleunik and _actions.choix_cleunik in(-110102,-110103,-110104) and portee &$vl_e_piejoi)";
            break;
          case 'docs':  //  Documents, ou qu'ils soient
          case 'cgv':	// Conditions générales de vente
          case 'palett':	// Fiches palettes
          case 'filigrane':	// Fichiers filigranes
            $sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik and _documents.doc_cleunik and _documents.typedoc in($vl_e_typedoc)";
            break;
          case "tousss":
			$sql_req = "SELECT _documents.actif,unix_timestamp(_documents.dateheurecreation) as ut_dateheurecreation,unix_timestamp(_documents.dateheuremodif) as ut_dateheuremodif,_documents.doc_cleunik as doc_cleunik,_documents.dateheurecreation as dateheurecreation,_documents.dateheuremodif as dateheuremodif,_documents.emplacement as emplacement,_documents.titre as titre,_documents.typedoc as typedoc,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine,_documents_rattachement.portee as portee,_documents_rattachement.rat_cleunik as rattachement FROM `_documents`,`_documents_rattachement` WHERE _documents.doc_cleunik= _documents_rattachement.doc_cleunik ";
          /*
          case '110001':
          case '110002':
          case '110003':
          case '110004':
          case '110005':
          case '110006':
            $sql_req = "SELECT _acteurs.act_cleunik as act_cleunik,_acteurs.raisonsoc as raisonsoc,_acteurs.raisonsoc as portee,_acteurs.nomcommercial as nomcommercial,_acteurs.typeacteur as typeacteur,codealphanum15 as code,mnemotechnique as mnemotechnique,actif as actif FROM `_acteurs` WHERE _acteurs.typeacteur IN ($vl_c_qui)";
            break;
           */
        }
        switch ($vl_c_zone) {
          case '1': //  titre
          	if ($vl_c_recherche=="%") {
	            $sql_req.=" and ((titre like '$vl_c_recherche%') or (titre is null)) ";
				$sql_tou.=" and ((f3.titre like '$vl_c_recherche%') or (f3.titre is null)) ";
	            $sql_con.=" and ((titre like '$vl_c_recherche%') or (titre is null)) ";
						} else {
	            $sql_req.=" and ((titre like '$vl_c_recherche%')) ";
				$sql_tou.=" and ((f3.titre like '$vl_c_recherche%')) ";
	            $sql_con.=" and ((titre like '$vl_c_recherche%')) ";
						}
            break;
          case '2': //  Descriptif sommaire
           	if ($vl_c_recherche=="%") {
	            $sql_req.=" and ((descriptif_sommaire like '$vl_c_recherche%') or (descriptif_sommaire is null)) ";
				$sql_tou.=" and ((f3.descriptif_sommaire like '$vl_c_recherche%') or (f3.descriptif_sommaire is null)) ";
	            $sql_con.=" and ((descriptif_sommaire like '$vl_c_recherche%') or (descriptif_sommaire is null)) ";
						} else {
				$sql_req.=" and ((descriptif_sommaire like '$vl_c_recherche%')) ";
				$sql_tou.=" and ((f3.descriptif_sommaire like '$vl_c_recherche%')) ";
            	$sql_con.=" and ((descriptif_sommaire like '$vl_c_recherche%')) ";
						}
            break;
          case '3': //  emplacement
           	if ($vl_c_recherche=="%") {
	            $sql_req.="  and ((emplacement like '$vl_c_recherche%') or (emplacement is null)) ";
	            $sql_tou.="  and ((f3.emplacement like '$vl_c_recherche%') or (f3.emplacement is null)) ";
				$sql_con.="  and ((emplacement like '$vl_c_recherche%') or (emplacement is null)) ";
						} else {
	            $sql_req.="  and ((emplacement like '$vl_c_recherche%')) ";
	            $sql_tou.="  and ((f3.emplacement like '$vl_c_recherche%')) ";
				$sql_con.="  and ((emplacement like '$vl_c_recherche%')) ";
						}
            break;
          case '4': //  origine
           	if ($vl_c_recherche=="%") {
	            $sql_req.=" and ((origine like '$vl_c_recherche%') or (origine is null)) ";
	            $sql_tou.=" and ((f3.origine like '$vl_c_recherche%') or (f3.origine is null)) ";
	            $sql_con.=" and ((origine like '$vl_c_recherche%') or (origine is null)) ";
						} else {
	            $sql_req.=" and ((origine like '$vl_c_recherche%')) ";
	            $sql_tou.=" and ((f3.origine like '$vl_c_recherche%')) ";
	            $sql_con.=" and ((origine like '$vl_c_recherche%')) ";
						}
            break;
          }

        switch ($vl_c_actifs) {
          case '1': $sql_req.=" and _documents.actif=1";break; //  actifs
          case '2': $sql_req.=" and _documents.actif=2";break;//  inactifs
          case '0': break;//  tous
        }
        switch ($vl_c_sauf){
        	case 'aucune':
			case '';
				break;
			default:
				$sql_req.=" and _documents.doc_cleunik not in ($vl_c_sauf)";
				break;
        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            break;
          default:
            switch ($vl_e_choix_cleunik) {
              case 0: //  on recherche sur le critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _documents.doc_cleunik in (select distinct(_documents_choix_fixes.doc_cleunik) from _documents_choix_fixes where critere_cleunik=$vl_e_critere_cleunik))";break;
                  case "notin": $sql_req.=" and _documents.doc_cleunik not in (select distinct(_documents_choix_fixes.doc_cleunik) from _documents_choix_fixes where critere_cleunik=$vl_e_critere_cleunik))";break;
                }
              default:
                //  on recherche sur le choix du critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _documents.doc_cleunik in (select distinct(_documents_choix_fixes.doc_cleunik) from _documents_choix_fixes where choix_cleunik in($vl_e_choix_cleunik))";break;
                  case "notin": $sql_req.=" and _documents.doc_cleunik in (select distinct(_documents_choix_fixes.doc_cleunik) from _documents_choix_fixes where choix_cleunik not in($vl_e_choix_cleunik) and critere_cleunik=$vl_e_critere_cleunik))";break;
                  }
            }
        }
        switch ($vl_c_qui) {
          case "888888":
          case "liaisons":
            break;
          case "docpj":
          $sql_req.= " AND ((_actions.dateheuredebut between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'))";
            break;
          default:
/*
 * le 01-05-2009 : suppression test sur date null
          $sql_req.= " AND ((_documents.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_documents.dateheuremodif between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_documents.dateheurecreation is null) or (_documents.dateheuremodif is null))";
          $sql_tou.= " AND ((f3.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (f3.dateheuremodif between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (f3.dateheurecreation is null) or (f3.dateheuremodif is null))";
          $sql_con.= " AND ((_documents.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_documents.dateheuremodif between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_documents.dateheurecreation is null) or (_documents.dateheuremodif is null))";
*/
          $sql_req.= " AND ((_documents.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_documents.dateheuremodif between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'))";
          $sql_tou.= " AND ((f3.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (f3.dateheuremodif between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'))";
          $sql_con.= " AND ((_documents.dateheurecreation between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_documents.dateheuremodif between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin'))";

        }
				switch ($gestion_droits){
					case "1":	//	absents de la gestion des droits
						switch ($genre_droits) {
						  case "droits":
								$sql_req.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _droits_doc where uti_cleunik=$uti_cleunik_droits))";
								$sql_tou.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _droits_doc where uti_cleunik=$uti_cleunik_droits))";
								$sql_con.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _droits_doc where uti_cleunik=$uti_cleunik_droits))";
								break;
						  case "blancs":
								$sql_req.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _doc_blanc where uti_cleunik=$uti_cleunik_droits))";
								$sql_tou.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _doc_blanc where uti_cleunik=$uti_cleunik_droits))";
								$sql_con.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _doc_blanc where uti_cleunik=$uti_cleunik_droits))";
								break;
						  case "noires":
								$sql_req.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _doc_noire where uti_cleunik=$uti_cleunik_droits))";
								$sql_tou.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _doc_noire where uti_cleunik=$uti_cleunik_droits))";
								$sql_con.= " AND (_documents.doc_cleunik not in (select doc_cleunik from _doc_noire where uti_cleunik=$uti_cleunik_droits))";
								break;
							case "raf":
								break;
						}
						break;
					case "2":	//	présents dans la gestion des droits
						switch ($genre_droits) {
						  case "droits":
								$sql_req.= " AND (_documents.doc_cleunik in (select doc_cleunik from _droits_doc where uti_cleunik=$uti_cleunik_droits))";
								$sql_tou.= " AND (_documents.doc_cleunik in (select doc_cleunik from _droits_doc where uti_cleunik=$uti_cleunik_droits))";
								$sql_con.= " AND (_documents.doc_cleunik in (select doc_cleunik from _droits_doc where uti_cleunik=$uti_cleunik_droits))";
								break;
						  case "blancs":
								$sql_req.= " AND (_documents.doc_cleunik in (select doc_cleunik from _doc_blanc where uti_cleunik=$uti_cleunik_droits))";
								$sql_tou.= " AND (_documents.doc_cleunik in (select doc_cleunik from _doc_blanc where uti_cleunik=$uti_cleunik_droits))";
								$sql_con.= " AND (_documents.doc_cleunik in (select doc_cleunik from _doc_blanc where uti_cleunik=$uti_cleunik_droits))";
								break;
						  case "noires":
								$sql_req.= " AND (_documents.doc_cleunik in (select doc_cleunik from _doc_noire where uti_cleunik=$uti_cleunik_droits))";
								$sql_tou.= " AND (_documents.doc_cleunik in (select doc_cleunik from _doc_noire where uti_cleunik=$uti_cleunik_droits))";
								$sql_con.= " AND (_documents.doc_cleunik in (select doc_cleunik from _doc_noire where uti_cleunik=$uti_cleunik_droits))";
								break;
							case "raf":
								break;
						}
						break;

					case "raf":
						break;
				}
        switch ($vl_c_qui) {
          case "liaisons":
            break;
          default:
          $sql_req.=" GROUP BY doc_cleunik "; //  A quoi ça sert (question que je me pose le 14 avril 2008) (je suppose pour "mes" documents etc ??)
          $sql_tou_gro=" GROUP BY doc_cleunik "; //  Nécessaire lors de la demande de tous les documents que l'on peut retrouver à plusieurs endroits
        }
        if ($vl_c_qui!="888888") {
          switch ($vl_c_zone) {
            case '1': $sql_ord.=" ORDER BY `titre` ASC";break;//  titre
            case '2': $sql_ord.=" ORDER BY `descriptif_sommaire` ASC";break;//  descriptif sommaire
            case '3': $sql_ord.=" ORDER BY `emplacement` ASC";break;//  Emplacement
            case '4': $sql_ord.=" ORDER BY `origine` ASC";break;//  origine
          }
        } else {
          switch ($vl_c_zone) {
            case '1': $sql_ord.=" ORDER BY typedoc ASC,`titre` ASC";break;//  titre
            case '2': $sql_ord.=" ORDER BY typedoc ASC,`descriptif_sommaire` ASC";break;//  descriptif sommaire
            case '3': $sql_ord.=" ORDER BY typedoc ASC,`emplacement` ASC";break;//  Emplacement
            case '4': $sql_ord.=" ORDER BY typedoc ASC,`origine` ASC";break;//  origine
            default:
              $sql_ord.=" ORDER BY typedoc ASC";
              break;
          }
        }

        break;
      case '2' :  //  recherche phonétique
        break;
    }
   break;
}
switch ($vl_e_limit) {
  case '0': //  Favoris, ou liste, pas de limit
    break;
  default:
    $sql_req_lim= " LIMIT $vl_e_limit";
		$sql_tou_lim= " LIMIT $vl_e_limit";
    break;
}
/*
 * le 4 mai 2009 : je ne sais plus à quoi cela sert, ce paramètre sélection
 * on conserve le code au cas où mais on normalement, si on met 0 dans la limite, on doit tout rapatrier
 */
/*
if ($vl_c_selection=="oui"){
	$sql_req_lim="";
	$sql_tou_lim="";
}
*/
if ($vl_e_tout==1) {
	$sql_req.=$sql_req_lim." union ".$sql_tou.")".$sql_con.$sql_tou_lim.$sql_tou_gro.$sql_ord;
} else {
	$sql_req.=$sql_ord.$sql_req_lim;
}
//echo $sql_req;
switch ($vl_c_sortie) {
  case "das":
    include("_graal_das_ged_01.php");
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
