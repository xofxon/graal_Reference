<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$vl_c_fic_tiers=fa_recup_param('vl_c_fic_tiers','transporteur');
$vl_e_civilite_defaut=intval(fa_recup_param('vl_e_civilite_defaut','-6'));
$vl_e_mail_defaut=intval(fa_recup_param('vl_e_mail_defaut','-11'));
$vl_e_fax_defaut=intval(fa_recup_param('vl_e_fax_defaut','-10'));
$vl_e_tel_defaut=intval(fa_recup_param('vl_e_tel_defaut','-9'));
$vl_e_portable_defaut=intval(fa_recup_param('vl_e_portable_defaut','-9'));
$vl_e_genre_acteur_defaut=intval(fa_recup_param('vl_e_genre_acteur_defaut','-5'));
$vl_e_indicatif_tel_defaut=intval(fa_recup_param('vl_e_indicatif_tel_defaut','121111'));
$vl_e_indicatif_fax_defaut=intval(fa_recup_param('vl_e_indicatif_fax_defaut','121111'));
$vl_e_indicatif_por_defaut=intval(fa_recup_param('vl_e_indicatif_por_defaut','121111'));
$vf_e_typeacteur=110004;
$vl_e_pays_defaut=intval(fa_recup_param('vl_e_pays_defaut','60000'));

include("_import_class_data_km.php");
$o_acteur=new _graal_import();
$o_choix=new _graal_import();
$o_adresses=new _graal_import();
$o_interlo=new _graal_import();
$o_web=new _graal_import();
$o_fax=new _graal_import();
$o_tel=new _graal_import();
$o_fonction=new _graal_import();
$o_acteur->req="INSERT INTO $vl_c_base_destination._acteurs (act_cleunik,codealphanum15,raisonsoc,nomcommercial,blocnotebrut,blocnotertf,dateheuremodif,dateheurecreation,typeacteur,c_uuid,mnemotechnique) VALUES ";
$o_choix->req="INSERT INTO $vl_c_base_destination._act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
$o_adresses->req="INSERT INTO $vl_c_base_destination._act_adresses (adr_cleunik,adr_cod,act_cleunik,adr_complementnom,adr_ligne1,adr_ligne2,adr_cp,adr_ville,choix_cleunik,adr_typecoordonnees) VALUES ";
$o_interlo->req="INSERT INTO $vl_c_base_destination._act_interlo (int_cleunik,codealphanum15,act_cleunik,patronyme,infodefaut,choix_cleunik) VALUES ";
$o_web->req="INSERT INTO $vl_c_base_destination._act_interlo_mail (intweb_cleunik,int_cleunik,refweb,veuxpasdemail,infofavori,utilisable,act_cleunik,choix_cleunik,valide,c_uuid) VALUES ";
$o_fax->req="INSERT INTO $vl_c_base_destination._act_interlo_fax (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_tel->req="INSERT INTO $vl_c_base_destination._act_interlo_tel (intel_cleunik,int_cleunik,telformate,intel_05,intel_06,infofavori,act_cleunik,choix_cleunik,prefixe_choix_cleunik) VALUES ";
$o_fonction->req="INSERT INTO $vl_c_base_destination._act_interlo_choix_fixes (act_cleunik,int_cleunik,choix_cleunik,critere_cleunik,typeacteur,uti_cleunik) VALUES ";
$vf_e_act_cleunik=_graal_requete_max("act_cleunik","$vl_c_base_destination._acteurs");
$vf_e_adr_cleunik=_graal_requete_max("adr_cleunik","$vl_c_base_destination._act_adresses");
$vf_e_int_cleunik=_graal_requete_max("int_cleunik","$vl_c_base_destination._act_interlo");
$vf_e_intweb_cleunik=_graal_requete_max("intweb_cleunik","$vl_c_base_destination._act_interlo_mail");
$vf_e_fax_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_fax");
$vf_e_tel_cleunik=_graal_requete_max("intel_cleunik","$vl_c_base_destination._act_interlo_tel");
$a[0]='/[^0-9]/i'; // Tout ce qui n'est pas compris entre 0 et 9 sans distinction de minuscule ou majuscule
$b[0]='';
$i=0;$i1=500;



$sql_req = "SELECT Code as 'Code',Nom as 'Nom',Adresse as 'Adresse',Adresse1 as 'Adresse1',CodePostal as 'CodePostal',Ville as 'Ville',Telephone as 'Telephone',Fax as 'Fax',Portable as 'Portable',EMail as 'EMail',CodeGrille as 'CodeGrille',Note as 'Note',DateCreation as 'DateCreation',DateModification as 'DateModification' FROM $vl_c_base_origine.$vl_c_fic_tiers order by Code";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  //  Ajout dans la table des acteurs
  $vf_e_act_cleunik++;
  $i++;
  $codealphanum15=$row['Code'];
  $raisonsoc=addslashes($row['Nom']);
  $nomcommercial=addslashes($row['Nom']);
  $blocnotebrut=addslashes($row['Note']);
  $blocnotertf=addslashes($row['Note']);
  $dateheuremodif=$row['DateModification'];
  $dateheurecreation=$row['DateCreation'];
  $typeacteur=$vf_e_typeacteur;
  $uuid=_graal_requete_uuid();
  $mnemotechnique=addslashes($row['Nom']);
  $o_acteur->dat.="($vf_e_act_cleunik,'$codealphanum15','$raisonsoc','$nomcommercial','$blocnotebrut','$blocnotertf','$dateheuremodif','$dateheurecreation',$typeacteur,'$uuid','$mnemotechnique'),";
  //  Ajout dans la table des _act_interlo (Interlocuteurs des acteurs) des correspondants
  $vf_e_int_cleunik++;
  $patronyme=addslashes($row['Nom']);
  $code=addslashes($row['Code']);
  $o_interlo->dat.="($vf_e_int_cleunik,'$code',$vf_e_act_cleunik,'$patronyme',2,$vl_e_civilite_defaut),";
  $o_fonction->dat.="($vf_e_act_cleunik,$vf_e_int_cleunik,-7,92,$vf_e_typeacteur,0),";
  //  Alimentation Genre d'acteur
  $o_choix->dat.="($vf_e_act_cleunik,$vl_e_genre_acteur_defaut,80,$vf_e_typeacteur),";
  //  Alimentation Transporteur
  $o_choix->dat.="($vf_e_act_cleunik,-25,126,$vf_e_typeacteur),";
  //  Ajout dans la table des _act_adresses (adresses au format français) des adresses          
   $vl_c_chaine=trim($row['Adresse'].$row['Adresse1'].$row['CodePostal'].$row['Ville']);
  //  On ajoute uniquement si l'adresse est un minimum renseignée
  if ($vl_c_chaine!=""){
    $vl_e_cleunik_pays=60000;
    $vf_e_adr_cleunik++;
    $adr_complementnom=addslashes($row['Nom']);
    $adr_ligne1=addslashes($row['Adresse']);
    $adr_ligne2=addslashes($row['Adresse1']);
    $adr_cp=addslashes($row['CodePostal']);
    $adr_ville=addslashes($row['Ville']);
    $o_adresses->dat.="($vf_e_adr_cleunik,'Adr01',$vf_e_act_cleunik,'$adr_complementnom','$adr_ligne1','$adr_ligne2','$adr_cp','$adr_ville',$vl_e_cleunik_pays,1),";
  }
  $vl_c_chaine=trim($row['EMail']);
  if ($vl_c_chaine!=""){
    $vf_e_intweb_cleunik++;
    $refweb=addslashes($row['EMail']);
    $uuid=_graal_requete_uuid();
    $o_web->dat.="($vf_e_intweb_cleunik,$vf_e_int_cleunik,'$refweb',2,1,1,$vf_e_act_cleunik,$vl_e_mail_defaut,1,'$uuid'),";
  }

  $vl_c_chaine=trim($row['Fax']);
  //  On ajoute uniquement si le fax est renseigné
  if ($vl_c_chaine!=""){
    $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine); 
    $vl_c_chaine_brute=addslashes($vl_c_chaine);
    $vf_e_fax_cleunik++;
    $o_fax->dat.="($vf_e_fax_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_fax_defaut,$vl_e_indicatif_fax_defaut),";
  }
  $vl_c_chaine=trim($row['Telephone']);
  //  On ajoute uniquement si le téléphone est renseigné
  if ($vl_c_chaine!=""){
    $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
    $vl_c_chaine_brute=addslashes($vl_c_chaine);
    $vf_e_tel_cleunik++;
    $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_tel_defaut,$vl_e_indicatif_tel_defaut),";
  }
  $vl_c_chaine=trim($row['Portable']);
  //  On ajoute uniquement si le téléphone portable est renseigné
  if ($vl_c_chaine!=""){
    $vl_c_chaine_nette=preg_replace($a, $b, $vl_c_chaine);
    $vl_c_chaine_brute=addslashes($vl_c_chaine);
    $vf_e_tel_cleunik++;
    $o_tel->dat.="($vf_e_tel_cleunik,$vf_e_int_cleunik,'$vl_c_chaine_brute','$vl_c_chaine_nette',$vl_c_chaine_nette,1,$vf_e_act_cleunik,$vl_e_portable_defaut,$vl_e_indicatif_por_defaut),";
  }
  if ($i % $i1==0){
    $o_acteur->execute();
    $o_choix->execute();
    $o_adresses->execute();
    $o_interlo->execute();
    $o_web->execute();
    $o_fax->execute();
    $o_tel->execute();
    $o_fonction->execute();
  }
}
$o_acteur->execute();
$o_choix->execute();
$o_adresses->execute();
$o_interlo->execute();
$o_web->execute();
$o_fax->execute();
$o_tel->execute();
$o_fonction->execute();
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
echo("$i transporteurs importés dans les fournisseurs.");
?>
