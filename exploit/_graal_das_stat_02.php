<?php
include("_graal_header_xml.inc.php");
include("_graal_fonctions_stats.php");
define('EOL', "\r\n");
$date_deb=fa_recup_param('date_deb','20610123');
$date_fin=fa_recup_param('date_fin','19610123');
$ml_art_01=intval(fa_recup_param('ml_art_01',1));
$ml_art_02=intval(fa_recup_param('ml_art_02',2));
$ml_art_03=intval(fa_recup_param('ml_art_03',4));
$ml_art_04=intval(fa_recup_param('ml_art_04',4));
$vl_e_art_cleunik=intval(fa_recup_param('vl_e_art_cleunik',-1));
$nombre=intval(fa_recup_param('nombre',0));
stats_rectif_dates($ml_art_03);
switch ($ml_art_03) {
  case  1: $fic_cial="offcli";$coeff="1";break;
  case  2: $fic_cial="cdecli";$coeff="1";break;
  case  3: $fic_cial="livcli";$coeff="1";break;
  case  4: $fic_cial="faccli";$coeff="case f4.choix_cleunik WHEN -110112 THEN 1 ELSE -1 END";break; //  Factures et avoirs (-110116,-110117) regroupÃ©s
  case  5: $fic_cial="demfou";$coeff="1";break;
  case  6: $fic_cial="cdefou";$coeff="1";break;
  case  7: $fic_cial="recfou";$coeff="1";break;
  case  8: $fic_cial="facfou";$coeff="1";break;
  case  9: $fic_cial="faccli";$coeff="1";break;
  case 10: $fic_cial="faccli";$coeff="1";break;
}
switch ($ml_art_02) {
  case 1: $sql_req="Select @rang:=@rang+1 AS z00,sum(f5.qte*($coeff)) as z01";break;
  case 2: $sql_req="Select @rang:=@rang+1 AS z00,sum(f5.qte*f1.pu*($coeff)) as z01";break;
  case 3: $sql_req="Select @rang:=@rang+1 AS z00,count(*) as z01";break;
  case 4: $sql_req="Select @rang:=@rang+1 AS z00,sum((f5.qte*f1.pu*($coeff))*(1-(f1.remise_taux/100))) as z01";break;
}
switch ($ml_art_04) {
  case 1: $sql_req.=",DATE_FORMAT(f5.dateheure_confirm,GET_FORMAT(DATE,'EUR')) as z02,f5.dateheure_confirm as z03";break;
  case 2: $sql_req.=",concat(WEEK(f5.dateheure_confirm),'-',Year(f5.dateheure_confirm)) as z02,concat(year(f5.dateheure_confirm),'-',week(f5.dateheure_confirm)) as z03";break;
  case 3: $sql_req.=",DATE_FORMAT(f5.dateheure_confirm,'%m-%Y') as z02,DATE_FORMAT(f5.dateheure_confirm,'%Y-%m') as z03";break;
  case 4: $sql_req.=",concat(quarter(f5.dateheure_confirm),'-',Year(f5.dateheure_confirm)) as z02,concat(year(f5.dateheure_confirm),'-',quarter(f5.dateheure_confirm)) as z03";break;
  case 5: $sql_req.=",Year(f5.dateheure_confirm) as z02,Year(f5.dateheure_confirm) as z03";break;
}
$sql_req.=" from _".$fic_cial."_lignes f1,_".$fic_cial."_entetes f3,_actions f4, _".$fic_cial."_lignes_qte f5 "; 
$sql_req.=" where f4.action_cleunik=f3.action_cleunik and f1.commercial_cleunik=f3.commercial_cleunik and f1.commercial_ligne_cleunik=f5.commercial_ligne_cleunik and (f5.dateheure_confirm between '$date_deb' and '$date_fin')";
if ($vl_e_art_cleunik!=-1) {$sql_req.=" and f1.art_cleunik=$vl_e_art_cleunik";}
switch ($ml_art_03) {
  case  1: break;
  case  2: break;
  case  3: break;
  case  4: $sql_req.=" and f4.choix_cleunik in(-110112,-110116,-110117)";break; 
  case  5: break;
  case  6: break;
  case  7: break;
  case  8: break;
  case  9: $sql_req.=" and f4.choix_cleunik in(-110112)";break;
  case 10: $sql_req.=" and f4.choix_cleunik in(-110116,-110117)";break;
}
$sql_req.=" group by z02";
switch ($ml_art_01) {
  case 1: $sql_req.=" order by z01 desc";break;
  case 2: $sql_req.=" order by z01 asc";break;
}
if ($nombre!=0) {$sql_req.=" limit $nombre;";}
_graal_requete_bd("SET @rang=0;");
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
$vl_e_nombre_types=mysql_num_rows($result);
if ($vl_e_nombre_types!=0) { 
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
    echo(' z00="'.fa_ent_xml($row['z00']).'"');
    echo(' z01_tri="'.fa_ent_xml($row['z01']).'"');
    echo(' z01="'.fa_ent_xml(number_format(round($row['z01'],2), 2, ',', ' ')).'"');
    echo(' periode="'.fa_ent_xml($row['z02']).'"');
    echo(' z03="'.fa_ent_xml($row['z03']).'"');
    echo('/>');
  }
} else {
    echo('<quoi ');
    echo(' z00="0"');
    echo(' z01="0"');
    echo(' z01_tri="0"');
    echo(' periode="y\'a pas!!!"');
    echo(' z03="y\'a pas!!!"');
     echo('/>');
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
