<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_numerotation.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_remise_banque_01";
fa_acces_script();
$vf_c_action=fa_recup_param('vf_c_action','??????');
$vl_devise=intval(fa_recup_param('vl_devise','122047'));	//	Euros
$vl_mode_paiement=intval(fa_recup_param('vl_mode_paiement','122047'));	//	Euros
$vl_option_remise=intval(fa_recup_param('vl_option_remise','0'));	//	Euros
$vl_journal_cleunik=intval(fa_recup_param('vl_journal_cleunik','0'));	//	Euros
$vl_te_reglement_cleunik=fa_recup_param('vl_te_reglement_cleunik','');
$vl_te_reglement_cleunik=unserialize(stripslashes($vl_te_reglement_cleunik));
$vl_date_remise_banque=fa_recup_param("vl_date_remise_banque","");
$vl_date_remise_banque.=" 00:00:00";
$vl_tb_reg_00010=_graal_requete_regle("Reg_00010"); //  Relier automatiquement l'utilisateur créateur de l'action 
$vl_c_type="cli";
$vl_reglement_cleunik="";
$vl_e_i=-1;
foreach($vl_te_reglement_cleunik as $vl_raf) {
	$vl_e_i++;
	$vl_reglement_cleunik.=$vl_te_reglement_cleunik[$vl_e_i].',';
}
if ($vl_reglement_cleunik!="") {
	$vl_reglement_cleunik=substr($vl_reglement_cleunik, 0, -1);
} else {
	$vl_reglement_cleunik="-99999999";
}
$sql_condition=" where a1.coef=1 and a1.reglement_cleunik in($vl_reglement_cleunik)";
$vf_c_echo="";
switch ($vl_c_type){
	case 'cli':	//Echéancier client
		$fichier_01="_treso_reglement_cli";
		$fichier_02="_treso_reglement_cli_detail";
		$fichier_03="_treso_reglement_cli_remise";
		$sql_req_montant="select sum((a7.montant_paye*a7.coef)) as montant from `_treso_reglement_cli_detail` a7 where a7.reglement_cleunik in ($vl_reglement_cleunik)";
		break;
	case 'fou':	//Echéancier fournisseur
		$fichier_01="_treso_reglement_fou";
		$fichier_02="_treso_reglement_fou_detail";
		$fichier_03="_treso_reglement_fou_remise";
		$sql_req_montant="select sum((a7.montant_paye*a7.coef)) as montant from `_treso_reglement_fou_detail` a7 where a7.reglement_cleunik in ($vl_reglement_cleunik)";
		break;
}

$result = _graal_requete_bd($sql_req_montant);
$row = mysql_fetch_assoc($result);
$vl_montant=fa_nn_zero($row['montant']);
_graal_libere_requete_bd($result);
$vf_c_retour="";
switch (TRUE) {
	case $vf_c_action=="ajouter":	//	ajouter une remise
		$vf_c_retour="";
		$vl_remise_cleunik=_graal_requete_max("remise_cleunik","_treso_remise");
		$vl_action_cleunik=_graal_requete_max("action_cleunik","_actions");
		$deb_trans=_graal_requete_bd("START TRANSACTION;");
		$code=_graal_numerote(14);//  Numérotation automatique
		$vl_reference="Remise en banque n° $code";
    	$sql_req = "INSERT INTO _actions set action_cleunik=$vl_action_cleunik,choix_cleunik=-110127,dateheurecreation=now(),dateheuredebut='$vl_date_remise_banque',dateheurefin='$vl_date_remise_banque',c_uuid=(select uuid()),sujet='$vl_reference',reference='$vl_reference'";
	    $vf_c_echo=_graal_exec_requete($sql_req);
	    if($vf_c_echo=='ok') {
	    	$vf_c_echo=$vl_action_cleunik;
			pf_ajoute_auteur();
			$sql_req = "INSERT INTO _treso_remise set remise_cleunik='$vl_remise_cleunik',action_cleunik='$vl_action_cleunik',dateheure='$vl_date_remise_banque',montant='$vl_montant',devise='$vl_devise',journal_cleunik='$vl_journal_cleunik',mode_paiement='$vl_mode_paiement',option_remise='$vl_option_remise'";
	    	$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.="-2|$sql_req";}
	    	$sql_req = "UPDATE $fichier_01 set journal_cleunik='$vl_journal_cleunik' WHERE reglement_cleunik in($vl_reglement_cleunik);";
			$vf_c_echo=_graal_exec_requete($sql_req);
			if($vf_c_echo!='ok') {$vf_c_retour.="-3|$sql_req";}
	    	$vl_e_i=-1;
			foreach($vl_te_reglement_cleunik as $vl_raf) {
				$vl_e_i++;
				$vl_reglement_cleunik.=$vl_te_reglement_cleunik[$vl_e_i].',';
				$sql_req = "INSERT INTO $fichier_03 set reglement_cleunik=$vl_te_reglement_cleunik[$vl_e_i],remise_cleunik='$vl_remise_cleunik';";
	    		$vf_c_echo=_graal_exec_requete($sql_req);
				if($vf_c_echo!='ok') {$vf_c_retour.="-4|$sql_req";}
			}
	    } else {
			$vf_c_retour.="-1|$vf_c_echo|";
			$vf_c_echo=-1;
		}
		if (trim($vf_c_retour)=="") {
        	$vf_c_echo="ok";
        	_graal_requete_bd("COMMIT;");
      	} else {
       		$vf_c_echo=-1;
			$vf_c_echo=$vf_c_retour;
        	_graal_requete_bd("ROLLBACK;");
        	$sql_req="DELETE f1 FROM _actions_texte where f1.action_cleunik = $vl_action_cleunik;";
			_graal_exec_requete($sql_req);
      	}	
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
function pf_ajoute_auteur(){
	global $vl_tb_reg_00010;
	global $vl_e_interl;
	global $vl_action_cleunik;
	if ($vl_tb_reg_00010[0]==1) {
		//	On ajoute l'utilisateur comme auteur de l'action (soumis à règle reg_00010)
      $vl_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));
	  $vl_act_cleunik=intval(fa_recup_session('vs_act_cleunik','0'));
      $sql_req = "INSERT INTO _graal set action_cleunik=$vl_action_cleunik,int_cleunik=$vl_int_cleunik,act_cleunik=$vl_act_cleunik,choix_cleunik=-110435,portee=$vl_e_interl,principal=1;";
      _graal_exec_requete($sql_req);
	}
}
?>
