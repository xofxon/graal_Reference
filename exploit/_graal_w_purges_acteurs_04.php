<?php
include("_graal_header_txt.inc.php");
define('EOL', "\r\n");
set_time_limit(6000);
$vl_c_genreacteur=fa_recup_param('genreacteur','');
$sql_req="";
//DELETE FROM 
switch ($vl_c_genreacteur){
  case "tousss"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0";break;  //  Tous les acteurs
  case "110001"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur";break;  //  prospects clients
  case "110002"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur";break;  //  prospects fournisseurs
  case "110003"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur";break;  //  clients
  case "110004"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur";break;  //  fournisseurs
  case "110005"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur";break;  //  autres acteurs
  case "110006"                       : $sql_con.=" FROM _acteurs where act_cleunik <>0 and typeacteur=$vl_c_genreacteur";break;  //  acteurs indéterminés
/*  
  case "toutesactions"                : $sql_req.=" DELETE FROM _actions where action_cleunik<>0;";break;  //  Toutes les actions
  case "tousarticles"                 : $sql_req.=" DELETE FROM _article where art_cleunik<>0;";break;  //  Tous les articles
  case "tousutilisateurs"             : $sql_req.=" DELETE FROM _utilisateur where uti_cleunik<>0;";break;  //  Tous les utilisateurs
  case "toutesconnexions"             : $sql_req.=" TRUNCATE _uti_connexions;";break;  //  Connexions
  case "toutesactions_commerciales"   : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110108,-110109,-110110,-110111,-110112,-110113,-110114,-110115,-110116,-110117) and action_cleunik<>0;";break;  //  Toutes les actions commerciales
  case "toutesactions_offcli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110114) and action_cleunik<>0;";break;  //  Offres
  case "toutesactions_demfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110115) and action_cleunik<>0;";break;  //  Demandes
  case "toutesactions_cdecli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110108) and action_cleunik<>0;";break;  //  Commandes clients
  case "toutesactions_cdefou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110109) and action_cleunik<>0;";break;  //  Commandes fournisseur
  case "toutesactions_livcli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110110) and action_cleunik<>0;";break;  //  Bons de livraison client
  case "toutesactions_recfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110111) and action_cleunik<>0;";break;  //  bons de réception fournisseur
  case "toutesactions_faccli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110112) and action_cleunik<>0;";break;  //  Factures clients
  case "toutesactions_avocli"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110116,-110117) and action_cleunik<>0;";break;  //  Avoirs clients+ avoirs financiers clients
  case "toutesactions_facfou"         : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110113) and action_cleunik<>0;";break;  //  Factures fournisseur
  case "toutesactions_fab"            : $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110119) and action_cleunik<>0;";break;  //  Fabrications
  case "tousmousto"                   : $sql_req.=" TRUNCATE _mouvements_stock;";break;  //  Mouvements de stock
  case "courrielsrecusenregistres"    : $sql_req.=" UPDATE _courriel_recus_brut set integre= 5,courriel=NULL WHERE integre=1;";break;  //  courriels enregistrés
  case "courrielsrecussupprimes"      : $sql_req.=" UPDATE _courriel_recus_brut set integre= 5,courriel=NULL WHERE integre=3;";break;  //  courriels supprimés
  case "toutesactions_remban"					: $sql_req.=" DELETE FROM _actions where choix_cleunik in (-110127) and action_cleunik<>0;";break;  //  Remises en banque
  case "reglements_clients"			: $sql_req.=" TRUNCATE _treso_reglement_cli;";break;  //  Réglements clients
  case "reglements_fournisseurs"	: $sql_req.=" TRUNCATE _treso_reglement_fou;";break;  //  Réglements fournisseurs
*/
}
/*
 * Nécessaire pour éviter le blocage du au trop long traitements voir conversation ici http://www.developpez.net/forums/showthread.php?p=3024462#post3024462   
 * Il ne faut plus rien avoir à récupérer, dans ce script, dans les variables de session ou dans les paramètres passés
 */
 /*
  * Il va falloir vérifier les rattachements des documents ... et purger les documents orphelins
  */
 
session_write_close();

$sql_con.=" AND date(dateheurecreation) between '2009-09-24' and '2009-09-30'"; 


$sql_req="SELECT count(*) as nombre".$sql_con;
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  $val_nombre=$row['nombre'];
}
echo "Il y a $val_nombre enregistrements à supprimer.".EOL;
_graal_libere_requete_bd($result);
if($val_nombre!=0){
	$val_nombre_deja=0;
	$passage=1;
	echo  "Cela peut prendre un certain temps ...".EOL;
	echo  "Par exemple, 90 secondes pour 500 enregistrements principaux et connexes.".EOL;
	while ($val_nombre>=0){
		echo "Passage $passage à ".date("d-m-Y")." ".date("H:i:s").EOL;
		$sql_req="DELETE ".$sql_con." LIMIT 500";
		echo $sql_req.EOL;
		$nombre=_graal_requete_nombre_affecte($sql_req);
		$val_nombre=$val_nombre - 500;
		$val_nombre_deja=$val_nombre_deja+$nombre;
		echo ("Il y a déjà $val_nombre_deja enregistrements supprimés ").EOL;
		$passage++;
	}
}
echo "Fin de la suppression ...".EOL;
?>
