<?php
include("_graal_header_xml.inc.php");
$nb_dec=2;
$vl_c_type=fa_recup_param('type','1');
$vl_e_echeance_cleunik=fa_recup_param('echeance_cleunik','-1');
$fichier_echeance=fa_recup_param('fichier_echeance','_faccli_echeancier');
switch ($fichier_echeance) {
	case "_cdecli_echeancier";
		$fichier_entete="_cdecli_entetes";
		break;
	case "_faccli_echeancier";
		$fichier_entete="_faccli_entetes";
		break;
	case "_avocli_echeancier";
		$fichier_entete="_avocli_entetes";
		break;
	case "_facfou_echeancier";
		$fichier_entete="_facfou_entetes";
		break;
	case "_avofou_echeancier";
		$fichier_entete="_avofou_entetes";
		break;
}
define('EOL', "\r\n");
// execution de la requÃ¨te SQL
switch ($fichier_echeance) {
	case "_cdecli_echeancier";
		$sql_req="select a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,a1.date_paiement,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
		$sql_req.="a1.date_echeance,date(a1.date_echeance) as `date_echeance_clair`,a1.libelle,a1.montant_du,a1.montant_paye,";
		$sql_req.="a1.devise_du,a1.devise_paye,a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat, ";
		$sql_req.="a5.code as code_document,";
		//$sql_req.="a5.compta_etat,";
		$sql_req.="a6.nomcommercial as nomcommercial,a6.act_cleunik,a1.action_cleunik";
		$sql_req.=" from _echeancier a1";
		$sql_req.=" left join $fichier_entete a5 on a5.action_cleunik=a1.action_cleunik";
		$sql_req.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";
		$sql_req.=" where echeance_cleunik=$vl_e_echeance_cleunik;";
		break;
	case "_faccli_echeancier";
	case "_avocli_echeancier";
	case "_facfou_echeancier";
	case "_avofou_echeancier";
		$sql_req="select a1.echeance_cleunik,a1.commercial_cleunik,a1.pc_cleunik,a1.noligne,a1.date_paiement,"._graalsql_date('a1.date_paiement')." as `date_paiement_clair`,";
		$sql_req.="a1.date_echeance,date(a1.date_echeance) as `date_echeance_clair`,a1.libelle,a1.montant_du,a1.montant_paye,";
		$sql_req.="a1.devise_du,a1.devise_paye,a1.taux_de_change,a1.mode_paiement,a1.blocnotebrut,a1.dateheurecreation,a1.dateheuremodif,a1.etat, ";
		$sql_req.="a5.code as code_document,a5.compta_etat,";
		$sql_req.="a6.nomcommercial as nomcommercial,a6.act_cleunik,a1.action_cleunik";
		$sql_req.=" from _echeancier a1";
		$sql_req.=" left join $fichier_entete a5 on a5.action_cleunik=a1.action_cleunik";
		$sql_req.=" left join _acteurs a6 on a5.act_cleunik=a6.act_cleunik";
		$sql_req.=" where echeance_cleunik=$vl_e_echeance_cleunik;";
	break;
}




$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
//echo $sql_req;
$row = mysql_fetch_assoc($result);
echo('<Description>');
$montant_restant=$row['montant_du']-$row['montant_paye'];
$act_cleunik=$row['act_cleunik'];
echo('<echeance_cleunik data="'.fa_ent_xml($row['echeance_cleunik']).'"/>');
echo('<commercial_cleunik data="'.fa_ent_xml($row['commercial_cleunik']).'"/>');
echo('<pc_cleunik data="'.fa_ent_xml($row['pc_cleunik']).'"/>');
echo('<noligne data="'.fa_ent_xml($row['noligne']).'"/>');
echo('<date_paiement data="'.fa_ent_xml($row['date_paiement_clair']).'"/>');
echo('<date_echeance data="'.fa_ent_xml($row['date_echeance_clair']).'"/>');
echo('<libelle data="'.fa_ent_xml($row['libelle']).'"/>');
echo('<montant_du data="'.fa_ent_xml($row['montant_du']).'"/>');
echo('<montant_paye data="'.fa_ent_xml($row['montant_paye']).'"/>');
echo('<devise_du data="'.fa_ent_xml($row['devise_du']).'"/>');
echo('<devise_paye data="'.fa_ent_xml($row['devise_paye']).'"/>');
echo('<taux_de_change data="'.fa_ent_xml($row['taux_de_change']).'"/>');
echo('<mode_paiement data="'.fa_ent_xml($row['mode_paiement']).'"/>');
echo('<blocnotebrut data="'.fa_ent_xml($row['blocnotebrut']).'"/>');
echo('<dateheurecreation data="'.fa_ent_xml($row['dateheurecreation']).'"/>');
echo('<dateheuremodif data="'.fa_ent_xml($row['dateheuremodif']).'"/>');
echo('<etat data="'.fa_ent_xml($row['etat']).'"/>');
echo('<code_document data="'.fa_ent_xml($row['code_document']).'"/>');
echo('<nomcommercial data="'.fa_ent_xml($row['nomcommercial']).'"/>');
echo('<montant_restant data="'.$montant_restant.'"/>');
echo('<act_cleunik data="'.fa_ent_xml($row['act_cleunik']).'"/>');
echo('<compta_etat data="'.fa_ent_xml($row['compta_etat']).'"/>');
echo('<action_cleunik data="'.fa_ent_xml($row['action_cleunik']).'"/>');
_graal_libere_requete_bd($result);
$sql_req="select a1.domiciliation,count(*) as nombre_rib from _act_rib a1 where a1.act_cleunik=$act_cleunik and a1.principal=1 group by a1.domiciliation;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
if (fa_nn($row['nombre_rib'])=="null") {
	$nombre=0;
} else {
	$nombre=$row['nombre_rib'];
}
echo('<nombre_rib data="'.$nombre.'"/>');
echo('<domiciliation data="'.fa_ent_xml($row['domiciliation']).'"/>');


echo('</Description>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
