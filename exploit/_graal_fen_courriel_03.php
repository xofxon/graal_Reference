<?php
include("_graal_header_xul.inc.php");
include("_graal_fonctions_cryptage.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_action_cleunik=intval(fa_recup_param('action_cleunik','-1'));
$vl_c_id_fenetre="Fen_00588";$vl_e_typedoc="12";
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);if ($vl_tb_droits[0]==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);$vl_c_graal_cp00=fa_cree_graal_cp00($vl_c_id_fenetre);
$vl_c_boj_100=fa_recup_dico("boj_100");
$vl_c_boj_101=fa_recup_dico("boj_101");
$vl_c_boj_102=fa_recup_dico("boj_102");
$vl_c_boj_103=fa_recup_dico("boj_103");
$vl_c_boj_104=fa_recup_dico("boj_104");
$vl_c_boj_105=fa_recup_dico("boj_105");
$vl_c_boj_106=fa_recup_dico("boj_106");
$vl_c_boj_107=fa_recup_dico("boj_107");
$vl_c_boj_108=fa_recup_dico("boj_108");
$vl_c_boj_109=fa_recup_dico("boj_109");
$vl_c_dico_00007=fa_recup_dico("dico_00007");
//  On recherche l'action d'origine
if ($vl_e_action_cleunik!=-1){
  $sql_req="SELECT _courriel_re.mel_id,_courriel_re.datas_vrac,_courriel_re.sujet FROM _courriel_re,_actions where _courriel_re.action_cleunik=_actions.action_cleunik and _actions.action_cleunik=$vl_e_action_cleunik;"; 
  $result=_graal_requete_bd($sql_req);
  $row = mysql_fetch_assoc($result);
  $vl_mel_id=$row['mel_id'];
  $vl_sujet=fa_ent_xml($row['sujet']);
  $vl_c_xml=simplexml_load_string($row['datas_vrac']);
  $vl_c_destinataires_le=$vl_c_xml->nom_cou_destinataires_le[0]->attributes();
  _graal_libere_requete_bd($result);
}
//  On recherche tous les comptes possibles pour l'utilisateur        
$vl_compte="<hbox>";
$sql_req = "SELECT _uti_cpt_bal.uticptbal_cleunik as cleunik,_uti_cpt_bal.titre as titre,_uti_cpt_bal.compte AS compte FROM _uti_cpt_bal,_droits_cpt_bal where _droits_cpt_bal.uti_cleunik=$vl_e_uti_cleunik and _droits_cpt_bal.uticptbal_cleunik=_uti_cpt_bal.uticptbal_cleunik and _uti_cpt_bal.genre = 1 order by titre;";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_compte.="<label value='$vl_c_boj_105' />";
}
else {
  $vl_b_envoi=false;
  $vl_compte.="<label value='$vl_c_boj_106'/><menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_emetteur'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)) {
  	$vl_c_comptexml_chiffre=fa_mcrypte("info_compte_courriel",$row['compte'],"déchiffrer");
		$vl_c_xml=simplexml_load_string($vl_c_comptexml_chiffre);
    $vl_c_smtp=$vl_c_xml->smtp[0]->attributes();
    if ($vl_c_smtp!="") {
      $vl_b_envoi=true;
      $vl_compte.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre'])). "' _graal_cleunik='".$row['cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))."' selected='true'/>";
    }
  }
  $vl_compte.="</menupopup></menulist>";
  if ($vl_b_envoi==true) {
    $vl_bouton_envoi="<button width='40' flex='1' id='bt_enregistrer' label='$vl_c_boj_101' crop='end' dir='normal' oncommand='pf_validation(\"enregistrer\")' tabindex='5'/>";
  }
}
$vl_compte.="</hbox>";
_graal_libere_requete_bd($sql_result);
//  On recherche tous les modèles
$vl_modeles="<hbox>";
$sql_req = "SELECT _documents.doc_cleunik AS doc_cleunik,_documents.titre AS titre,_documents.descriptif_sommaire AS descriptif_sommaire FROM _droits_doc, _documents WHERE _droits_doc.uti_cleunik=$vl_e_uti_cleunik AND _documents.doc_cleunik = _droits_doc.doc_cleunik AND _documents.typedoc=$vl_e_typedoc";
$sql_result = _graal_requete_bd($sql_req);
if (mysql_num_rows($sql_result) == 0){
  $vl_modeles.="<label value='$vl_c_boj_104' />";
}
else {
  $vl_modeles.="<label value='$vl_c_boj_103' /><menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_modeles' oncommand='pf_top_model(fa_mlget(\"ml_modeles\"));'><menupopup>";
  while ($row = mysql_fetch_assoc($sql_result)){
    $vl_modeles.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")". "' _graal_cleunik='".$row['doc_cleunik']."' label='".fa_remplace_quotes(fa_ent_xml($row['titre']))." (".fa_remplace_quotes(fa_ent_xml($row['descriptif_sommaire'])).")"."'/>";
  }
  $vl_modeles.="</menupopup></menulist>";
}
$vl_modeles.="</hbox>";
_graal_libere_requete_bd($sql_result);
$vl_envoi="<hbox>";
$vl_envoi.="<label value='$vl_c_boj_102' />";
$vl_envoi.="<menulist sizetopopup='none' onfocus='setTimeout(fa_focus_gere_menulist, 0, this);' flex='1' id='ml_envoi'><menupopup>";
$vl_envoi.="<menuitem value='" .fa_remplace_quotes(fa_ent_xml($vl_c_destinataires_le))."' _graal_cleunik='' label='".fa_remplace_quotes(fa_ent_xml($vl_c_destinataires_le))."'/>";
$vl_envoi.="</menupopup></menulist>";
$vl_envoi.="</hbox>";
include("_graal_header_winxul.inc.php");
echo <<<END
<window context="graal_cp00" title="$vl_c_boj_100" id="_graal_courriel_01" onload="fa_aa(this);pf_etat_fen('ini')" $c_xmlns>
$vl_c_graal_cp00
END;
include("_graal_visites.inc.php");
include_once("js/_graal_01.js.php");
include("js/_graal_03.js.php");
include_once("js/_graal_05_dates.js.php");
include("js/_graal_courriel_03.js.php");
echo <<<END
<hbox flex="1"> 
  <vbox flex="1">
    <deck id="dk_01" selectedIndex="0" flex="1">
      <vbox value="Deck n° 1 du message">
        <vbox id="messagepanel" flex="1">
          <vbox>
            $vl_compte
            $vl_envoi
          </vbox>
          <vbox>
            <hbox flex="1">
              <label value="$vl_c_boj_107"/>
              <textbox flex="1" id="tb_sujet"   value="$vl_c_boj_108$vl_sujet"/>
            </hbox>
          </vbox>
          $vl_modeles
          <textbox id="tb_message" multiline="true" wrap="off" flex="1" value=""   tabindex="4"/>
        </vbox>
      </vbox>
      <vbox value="Deck n° 2 pour erreur">
        <vbox flex="1">
          <textbox id="tb_cr" multiline="true" wrap="on" flex="1" value=""  />
          <button label="$vl_c_boj_109"  oncommand="fa_gid('dk_01').selectedIndex=0;" />
        </vbox>
      </vbox>
    </deck>
    <vbox>
      <hbox>
        $vl_bouton_envoi
        <button width="40" flex="1" id="bt_sortir" label="$vl_c_dico_00007" crop="end" dir="normal" oncommand="pf_etat_fen('sortir')" />
      </hbox>
    </vbox>
  </vbox>
</hbox>
</window>
END;
?>
