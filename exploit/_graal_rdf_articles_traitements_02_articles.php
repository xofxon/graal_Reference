<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
require("_graal_fonctions_soundex.php");
$vl_c_qui=fa_recup_param('vl_c_qui','favoris');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_inactif=intval(fa_recup_param('vl_e_inactif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));

$vl_c_type_recherche_cleunik=fa_recup_param('vl_c_t01','');
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_c_type=fa_recup_param('vl_c_type','1');
$vl_e_panier=intval(fa_recup_param('vl_e_panier','0'));
$vl_c_sortie=fa_recup_param('sortie','rdf');

$vl_e_type_tarif=intval(fa_recup_param('vl_e_type_tarif','0'));
$vl_e_tarif_cleunik=intval(fa_recup_param('vl_e_tarif_cleunik','0'));
$vl_e_coeff_maj=fa_floatval(fa_recup_param('vl_e_coeff_maj','1'));
$vl_e_tarif_actif=intval(fa_recup_param('vl_e_tarif_actif','0'));
$sql_req = "SELECT IFNULL(dateheure_validite ,0) AS dateheure_validite,IFNULL(dateheure_dermaj ,0) AS dateheure_dermaj,tar_cleunik,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference,"._graalsql_date('dateheure_validite')." as datevalidite,"._graalsql_date('dateheure_dermaj')." as datemaj,_art_tarifs.actif as tarifactif,_article.mnemotechnique as mnemotechnique,_article.code as codearticle,_article.description as description,_article.art_cleunik as art_cleunik,_article.actif as articleactif,_art_tarifs.type as typetarif,_art_tarifs.act_cleunik,case _art_tarifs.act_cleunik WHEN 0 THEN 'Tarif général' ELSE 'Tarif particulier' END as typetarifclair,case _art_tarifs.act_cleunik WHEN 0 THEN '' ELSE _acteurs.raisonsoc END as 'raisonsoc',_acteurs.actif as acteuractif,_art_tarifs.pu_reference*1000 as puref_1000,_acteurs.typeacteur as typeacteur,_acteurs.actif as acteuractif,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference*$vl_e_coeff_maj,_art_tarifs.nb_dec) END as nouveau_tarif,_art_tarifs.pu_reference*$vl_e_coeff_maj*1000 as nouveau_tarif_1000 FROM _article,_art_tarifs left join _acteurs using (act_cleunik) where _art_tarifs.tarif_cleunik=$vl_e_tarif_cleunik and _art_tarifs.type=$vl_e_type_tarif and _article.art_cleunik=_art_tarifs.art_cleunik ";
  
switch ($vl_e_actif) {
  case '4': //  Liste de tarifs
    $sql_req = "SELECT IFNULL(dateheure_validite ,0) AS dateheure_validite,IFNULL(dateheure_dermaj ,0) AS dateheure_dermaj,tar_cleunik,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference,_art_tarifs.nb_dec) END as pu_reference,"._graalsql_date('dateheure_validite')." as datevalidite,"._graalsql_date('dateheure_dermaj')." as datemaj,_art_tarifs.actif as tarifactif,_article.mnemotechnique as mnemotechnique,_article.code as codearticle,_article.description as description,_article.art_cleunik as art_cleunik,_article.actif as articleactif,_art_tarifs.type as typetarif,_art_tarifs.act_cleunik,case _art_tarifs.act_cleunik WHEN 0 THEN 'Tarif général' ELSE 'Tarif particulier' END as typetarifclair,case _art_tarifs.act_cleunik WHEN 0 THEN '' ELSE _acteurs.raisonsoc END as 'raisonsoc',_acteurs.actif as acteuractif,_art_tarifs.pu_reference*1000 as puref_1000,_acteurs.typeacteur as typeacteur,_acteurs.actif as acteuractif,case _art_tarifs.pu_reference WHEN 0 THEN '' ELSE round(_art_tarifs.pu_reference*$vl_e_coeff_maj,_art_tarifs.nb_dec) END as nouveau_tarif,_art_tarifs.pu_reference*$vl_e_coeff_maj*1000 as nouveau_tarif_1000 FROM _article,_art_tarifs left join _acteurs using (act_cleunik) where _article.art_cleunik=_art_tarifs.art_cleunik ";
    $vl_c_var=fa_recup_param('var','vs_tempo_panier_article_tarifs');
    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
    unset($_SESSION["$vl_c_var"]);
    $vl_e_i=-1;
    foreach($vl_t_listecles as $vl_raf) {
      $vl_e_i++;
      $vl_tar_cleunik.=$vl_t_listecles[$vl_e_i].',';
    }
    if ($vl_tar_cleunik!="") {
      $vl_tar_cleunik=substr($vl_tar_cleunik, 0, -1);
    } else {
      $vl_tar_cleunik="-99999999";
    } 
    $sql_req.=" and _art_tarifs.tar_cleunik IN($vl_tar_cleunik)";
    break;
  case '3': // Panier ou requête
    include("_graal_req_panier_articles.php");
    $sql_req.=" and _article.art_cleunik IN($vl_art_cleunik)";
    break;
  case '1': 
  case '2': 
  case '0':
    switch ($vl_c_type) {
      case '0': //  Liste de clés
/*
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_article_tarifs');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        unset($_SESSION["$vl_c_var"]);
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_art_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_art_cleunik!="") {
          $vl_art_cleunik=substr($vl_art_cleunik, 0, -1);
        } else {
          $vl_art_cleunik="-99999999";
        } 
        $sql_req.=" and _article.art_cleunik IN($vl_art_cleunik)";
*/
        $vl_c_var=fa_recup_param('var','vs_tempo_panier_article_tarifs');
        $vl_t_listecles=fa_recup_session("$vl_c_var",'');
        unset($_SESSION["$vl_c_var"]);
        $vl_e_i=-1;
        foreach($vl_t_listecles as $vl_raf) {
          $vl_e_i++;
          $vl_tar_cleunik.=$vl_t_listecles[$vl_e_i].',';
        }
        if ($vl_tar_cleunik!="") {
          $vl_tar_cleunik=substr($vl_tar_cleunik, 0, -1);
        } else {
          $vl_tar_cleunik="-99999999";
        } 
        $sql_req.=" and _art_tarifs.tar_cleunik IN($vl_tar_cleunik)";
        break;
      case '1': //  recherche orthographique 
        switch ($vl_c_qui) {
          case 'tous': break;//tous
          case 'favoris': $sql_req.= " AND _article.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
          case 'achats' : $sql_req.= " AND _article.types_gestion & 1";break;
          case 'ventes' : $sql_req.= " AND _article.types_gestion & 2";break;
          case 'stocks' : $sql_req.= " AND _article.types_gestion & 4";break;        
          case 'fabrication': $sql_req.= " AND _article.types_gestion & 8";break;        
        }
        switch ($vl_c_validite) {
          case '': break;
          default: $sql_req.=" and (_article.dateheurevalidite >= '$vl_c_validite' or _article.dateheurevalidite is null)";break;  
          }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" and _article.description like '$vl_c_recherche%'";break;//  Description courte
          case '2': $sql_req.=" and _article.code like '$vl_c_recherche%'";break;//  Code
          case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%'";break;//  Mnémotechnique
        }
        switch ($vl_e_tarif_actif) {
          case 1: $sql_req.= " AND _art_tarifs.actif=1";break;// Actifs
          case 2: $sql_req.= " AND _art_tarifs.actif=2";break;// Inactifs
          case 0: break;// Tous
        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            switch ($vl_e_actif) {
              case 1: $sql_req.= " AND _article.actif=1";break;// Actifs
              case 2: $sql_req.= " AND _article.actif=2";break;// Inactifs
              case 0: break;// Tous
            }
            break;
          default:
            switch ($vl_e_choix_cleunik) {
              case '0': //  on recherche sur le critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _article.art_cleunik in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where critere_cleunik=$vl_e_critere_cleunik)";break;
                  case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where critere_cleunik=$vl_e_critere_cleunik)";break;
                }
                break;
              default:
                //  on recherche sur le choix du critère
                switch ($vl_c_type_recherche_cleunik) {
                  case "in": $sql_req.=" and _article.art_cleunik in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik in($vl_e_choix_cleunik))";break;
                  case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik in ($vl_e_choix_cleunik) and critere_cleunik=$vl_e_critere_cleunik)";break;
                  //case "notin": $sql_req.=" and _article.art_cleunik not in (select distinct(_art_choix_fixes.art_cleunik) from _art_choix_fixes where choix_cleunik not in($vl_e_choix_cleunik))";break;
                }
              break;
            }
            $sql_req.= " AND _article.actif in($vl_e_actif,$vl_e_inactif)";
        }
        switch ($vl_c_zone) {
          case '1': $sql_req.=" ORDER BY `description` ASC";break;//  Description courte
          case '2': $sql_req.=" ORDER BY `code` ASC";break;//  Code
          case '3': $sql_req.=" ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
        }
        switch ($vl_e_critere_cleunik) {
          case 0: //  pas de gestion du critère
            $sql_req.= " LIMIT 0, $vl_e_limit";
            break;
          default:
        }
    }
}
switch ($vl_c_sortie) {
  case "rdf":
    //echo 'requete -> '.$sql_req.EOL;
    $result = _graal_requete_bd($sql_req);
    echo(fa_xcree_entete_rdf());
    while ($row = mysql_fetch_assoc($result)) {
      echo('<RDF:li>'.EOL);
      echo('<RDF:Description>');
      echo('<row:art_cleunik NC:parseType="Integer">'.fa_ent_xml($row['art_cleunik']).'</row:art_cleunik>');
      echo('<row:tar_cleunik NC:parseType="Integer">'.fa_ent_xml($row['tar_cleunik']).'</row:tar_cleunik>');
      echo('<row:articleactif NC:parseType="Integer">'.fa_ent_xml($row['articleactif']).'</row:articleactif>');
      echo('<row:typetarif NC:parseType="Integer">'.fa_ent_xml($row['typetarif']).'</row:typetarif>');
      echo('<row:act_cleunik NC:parseType="Integer">'.fa_ent_xml($row['act_cleunik']).'</row:act_cleunik>');
      echo('<row:tarif_actif NC:parseType="Integer">'.fa_ent_xml($row['tarifactif']).'</row:tarif_actif>');
      echo('<row:pu_reference >'.fa_ent_xml($row['pu_reference']).'</row:pu_reference>');
      echo('<row:datevalidite >'.fa_ent_xml($row['datevalidite']).'</row:datevalidite>');
      echo('<row:datemaj >'.fa_ent_xml($row['datemaj']).'</row:datemaj>');
      echo('<row:codearticle >'.fa_ent_xml($row['codearticle']).'</row:codearticle>');
      echo('<row:description >'.fa_ent_xml($row['description']).'</row:description>');
      echo('<row:typetarifclair >'.fa_ent_xml($row['typetarifclair']).'</row:typetarifclair>');
      echo('<row:raisonsoc >'.fa_ent_xml($row['raisonsoc']).'</row:raisonsoc>');
      echo('<row:puref_1000 NC:parseType="Integer">'.fa_ent_xml($row['puref_1000']).'</row:puref_1000>');
      echo('<row:typeacteur NC:parseType="Integer">'.fa_ent_xml($row['typeacteur']).'</row:typeacteur>');
      echo('<row:nouveau_tarif >'.fa_ent_xml($row['nouveau_tarif']).'</row:nouveau_tarif>');
      echo('<row:nouveau_tarif_1000 NC:parseType="Integer">'.fa_ent_xml($row['nouveau_tarif_1000']).'</row:nouveau_tarif_1000>');
      echo('<row:dateheure_validite>'.fa_ent_xml($row['dateheure_validite']).'</row:dateheure_validite>');
      echo('<row:dateheure_dermaj>'.fa_ent_xml($row['dateheure_dermaj']).'</row:dateheure_dermaj>');

      if ($row['articleactif']==1) {echo('<row:properties_art></row:properties_art>');} else {echo('<row:properties_art>css_0001</row:properties_art>');}
      if ($row['tarifactif']==1) {echo('<row:properties_tar></row:properties_tar>');} else {echo('<row:properties_tar>css_0001</row:properties_tar>');}
      if ($row['acteuractif']==1) {echo('<row:properties_act></row:properties_act>');} else {echo('<row:properties_act>css_0001</row:properties_act>');}
      echo('</RDF:Description>'.EOL);
      echo('</RDF:li>'.EOL);
    }
    echo('</RDF:Bag>'.EOL);
    echo('</RDF:RDF>'.EOL);
    _graal_libere_requete_bd($result);
    _graal_ferme_connexion();
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
?>
