<?php
include("_graal_header_txt.inc.php");
require_once('_graal_rfc822_addresses_01.php');
require_once('_graal_mime_parser_01.php');
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
$vl_e_graal_cleunik=intval(fa_recup_param('vl_e_graal_cleunik','0'));
$vl_e_sequence_envoi=intval(fa_recup_param('vl_e_sequence_envoi','0'));
$sep_ret='|';
set_time_limit(6000);
$name=$_FILES['filename']['name'];
$size=$_FILES['filename']['size'];
$tmp=$_FILES['filename']['tmp_name'];
$type=$_FILES['filename']['type'];  //  Pas fiable : regarde, a priori, l'extension !!
$type=addslashes(fa_mime_type_buffer(file_get_contents($tmp)));
$error=$_FILES['filename']['error'];
$hash=hash_file('sha1', $tmp);
$vl_c_data = file_get_contents($tmp);
$sql_req = "select courriel_brut_cleunik as cleunik FROM _courriel_recus_brut WHERE hash = '$hash'";
if ($res = _graal_requete_bd($sql_req)) {
  $ligne = mysql_fetch_row($res);
  $vl_courriel_brut_cleunik=$ligne[0];
  _graal_libere_requete_bd($res);
}
if ($vl_courriel_brut_cleunik==0) {
  $vl_courriel_brut_cleunik=_graal_requete_max("courriel_brut_cleunik","_courriel_recus_brut");
	if ($vl_e_sequence_envoi==0){
		$vl_sequence=_graal_requete_max_particuliere("sequence","_courriel_recus_brut");
	} else {
		$vl_sequence=$vl_e_sequence_envoi;
	}
  $mime=new mime_parser_class;
  $mime->mbox=0;
  $mime->decode_bodies=1;
  $mime->ignore_syntax_errors=1;
  // remplacement des CR "orphelins" par CRFL
  $definition_00=str_replace("\r\n", "\r",$vl_c_data);
  $definition_01=str_replace("\r", "\r\n", $definition_00);
  $definition_00="";
  $mail_traficote=$definition_01;
  $definition_01="";
    //  le 2 juillet 2008 on remplace la gestion par data par la gestion par fichier beaucoup beaucoup plus rapide
  $path="mail/".$sess_id."_".$hash;
  $handle_file=fopen($path, 'wb');
  fwrite($handle_file, $mail_traficote);
  fclose($handle_file);
  $parameters=array('File'=>$path,'SaveBody'=>'mail','Hash'=>$hash,'sess_id'=>$sess_id,);
  $vl_c_erreur="";
  if(!$mime->Decode($parameters, $decoded)) {
		$vl_integre=4;
	 } else {
    $vl_integre=2;
    $vl_c_z04=$decoded[0]["Headers"]["date:"];
    if (($timestamp = strtotime($vl_c_z04)) === false) {
      if (strtolower(substr($vl_c_z04,-2))=="ut") {
        $vl_c_z04=substr($vl_c_z04,0,strlen($vl_c_z04)-2)."UTC";
        if (($timestamp = strtotime($vl_c_z04)) === false) { 
          $vl_c_z09="19610123060000";
        } else {
          $vl_c_z04=date('Y-m-d H:i:s', $timestamp);
        }
      } else {
        $vl_c_z09="19700101000001";
        $vl_c_z04=date('d-m-Y H:i:s', 1);
      }
    } else {
      $vl_c_z04=date('Y-m-d H:i:s', $timestamp);
    }
  }
  $vf_c_echo=_graal_exec_requete("INSERT INTO _courriel_recus_brut set courriel_brut_cleunik=$vl_courriel_brut_cleunik,courriel='".addslashes($mail_traficote)."',hash='$hash',sequence=$vl_sequence,idpop='$hash',integre=$vl_integre,uticptbal_cleunik=$vl_e_graal_cleunik,dateheurereception=now(),dateheuremessage='$vl_c_z04';");
  $mime=NULL;
	unlink($handle_file);
}
unlink($tmp);
echo $vl_courriel_brut_cleunik.$sep_ret.$vl_sequence.$sep_ret;
?>
