<?php
include("_graal_header_xml.inc.php");
$vl_c_dico_00086=fa_recup_dico("dico_00086");
$vl_c_dico_00087=fa_recup_dico("dico_00087");
$vl_c_dico_00088=fa_recup_dico("dico_00088");
define('EOL', "\r\n");
$vl_e_art_cleunik=intval(fa_recup_param("vl_art_cleunik","10000113"));
$vl_actif=intval(fa_recup_param("actif",3));
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_c_type_dates=intval(fa_recup_param("selection_date","0"));
$vl_c_sortie=fa_recup_param("sortie","das");
//session_write_close();
switch ($vl_c_type_dates){
	case 0:$sel_date="";break;
	case 1:$sel_date="and ( f1.dateheuremvt between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";break;
	case 2:$sel_date="and ( f1.dateheuresaisie between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";break;
}
$sql_req = "SELECT f1.mvt_cleunik,f1.art_cleunik,f1.uti_cleunik,f1.int_cleunik,f1.blocnotebrut,f1.dateheuremvt,f1.dateheuresaisie,f1.choix_depot,";
$sql_req.= " f1.choix_empla,f1.qte_mvt,f1.qte_pos,f1.unite_mvt,f1.genre_mvt,f1.type_mvt,f1.pu_mvt,f2.choix_valeur_texte_01 as 'depot',";
$sql_req.= " f3.choix_valeur_texte_01 as 'empla',f4.choix_valeur_texte_01 as 'genre' from _mouvements_stock f1,_choix f2,_choix f3,";
$sql_req.= " _choix f4  where f2.choix_cleunik=f1.choix_depot and f3.choix_cleunik=f1.choix_empla and f4.choix_cleunik=f1.genre_mvt ";
$sql_req.= " and f1.art_cleunik=$vl_e_art_cleunik $sel_date";
$sql_req.= " order by dateheuremvt desc, mvt_cleunik desc;";
switch ($vl_c_sortie) {
  	case "das":
		$result = _graal_requete_bd($sql_req);
		echo('<donnees>');
		while ($row = mysql_fetch_assoc($result)) {
			echo('<quoi ');
		    echo(' mvt_cleunik="'.fa_ent_xml($row['mvt_cleunik']).'"');
		    echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
		    echo(' uti_cleunik="'.fa_ent_xml($row['uti_cleunik']).'"');
		    echo(' int_cleunik="'.fa_ent_xml($row['int_cleunik']).'"');
		    echo(' dateheuremvt="'.fa_ent_xml($row['dateheuremvt']).'"');
		    echo(' dateheuresaisie="'.fa_ent_xml($row['dateheuresaisie']).'"');
		    echo(' choix_depot="'.fa_ent_xml($row['choix_depot']).'"');
		    echo(' choix_empla="'.fa_ent_xml($row['choix_empla']).'"');
		    echo(' qte_mvt="'.fa_ent_xml($row['qte_mvt']).'"');
		    if ($row['qte_pos']==0) {$vl_c_qte_pos="";} else {$vl_c_qte_pos=fa_ent_xml($row['qte_pos']);}
		    echo(' qte_pos="'.$vl_c_qte_pos.'"');
		    echo(' unite_mvt="'.fa_ent_xml($row['unite_mvt']).'"');
		    echo(' genre_mvt="'.fa_ent_xml($row['genre_mvt']).'"');
		    switch ($row['type_mvt']) {
		      case 1 : $vl_c_type_mvt=$vl_c_dico_00086;break;
		      case 2 : $vl_c_type_mvt=$vl_c_dico_00087;break;
		      case 3 : $vl_c_type_mvt=$vl_c_dico_00088;break;
		    }
		    echo(' type_mvt="'.$vl_c_type_mvt.'"');
		    echo(' pu_mvt="'.fa_ent_xml($row['pu_mvt']).'"');
		    $mt_mvt=$row['pu_mvt']*$row['qte_mvt'];
		    echo(' mt_mvt="'.fa_ent_xml($mt_mvt).'"');
		    echo(' depot="'.fa_ent_xml($row['depot']).'"');
		    echo(' empla="'.fa_ent_xml($row['empla']).'"');
		    echo(' genre="'.fa_ent_xml($row['genre']).'"');
		    echo(' blocnotebrut="'.fa_ent_xml($row['blocnotebrut']).'"');
		   echo('/>');
		}
		echo('</donnees>');
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
		break;
  	case "sql":
  		header('Content-type: text/plain; charset=utf-8');
	    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
	    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
	    echo $sql_req;
  		break;
}
?>
