<?php
switch ($_SESSION["vsid_uuid"]) {
	case "f375c9f3-c7db-4def-888d-4d8dfc8b0113":
		$vl_c_bvj_140=fa_recup_dico_telquel("bvj_140");$vl_c_bvj_140="Services";
		break;
	default:
		$vl_c_bvj_140=fa_recup_dico_telquel("bvj_140");
		break;
}

$vl_c_bvj_141=fa_recup_dico_telquel("bvj_141");
$vl_c_bvj_142=fa_recup_dico_telquel("bvj_142");
$vl_c_bvj_143=fa_recup_dico_telquel("bvj_143");
  //  Calcul du nombre de lignes de montants dans le pied
  $base_ht=0;
  $total_ht=0;
  $total_taxe=0;
  $total_ttc=0;
  $nbligne_montant_pied=0;
	$remise_pied=0;
  $totaux=array();
	$totaux_remise=array();
  //  Bases marchandises
  $result_marchandises = _graal_requete_bd($sql_req_ht_marchandise);
  while ($row = mysql_fetch_assoc($result_marchandises)) {
    if ($row['montant_avec_remise_pied']!=0){
			$remise_pied+=$row['montantremise_pied'];
      $total_ht+=$row['montant_avec_remise_pied'];
      $total_taxe+=$row['montant_taxe'];
      $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
      ++$nbligne_montant_pied;
      array_push($totaux,$vl_c_bvj_140,$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
	  array_push($totaux_remise,$vl_c_bvj_140,$row['htbrutremise'],$row['montantremise_pied'],$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
    }
  } 
  _graal_libere_requete_bd($result_marchandises);
  //  Port
  $sql_req_port=str_replace("*base_ht*",$base_ht,$sql_req_port);
  $result_port = _graal_requete_bd($sql_req_port);
  while ($row = mysql_fetch_assoc($result_port)) {
    if ($row['montant_avec_remise_pied']!=0){
      $total_ht+=$row['montant_avec_remise_pied'];
      $total_taxe+=$row['montant_taxe'];
      $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
      ++$nbligne_montant_pied;
      array_push($totaux,$vl_c_bvj_141,$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
	  array_push($totaux_remise,$vl_c_bvj_141,$row['htbrutremise'],$row['montantremise_pied'],$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
    }
  } 
  _graal_libere_requete_bd($result_port);
  //  Frais
  $sql_req_frais=str_replace("*base_ht*",$base_ht,$sql_req_frais);
  $result_frais = _graal_requete_bd($sql_req_frais);
  while ($row = mysql_fetch_assoc($result_frais)) {
    if ($row['montant_avec_remise_pied']!=0){
      $total_ht+=$row['montant_avec_remise_pied'];
      $total_taxe+=$row['montant_taxe'];
      $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
      ++$nbligne_montant_pied;
      array_push($totaux,$vl_c_bvj_142,$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
	array_push($totaux_remise,$vl_c_bvj_142,$row['htbrutremise'],$row['montantremise_pied'],$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
    }
  } 
  _graal_libere_requete_bd($result_frais);
//if ($total_taxe!=0.0){
	/*
 * recherche du nombre total d'articles concernÃ©s par la DEEE
 */
$sql_req_nb_deee="select sum(f2.qte) as nb_deee from $vl_c_fic_ligne f1 left join $vl_c_fic_qte f2 on f2.commercial_ligne_cleunik=f1.commercial_ligne_cleunik and f1.commercial_cleunik=$vl_commercial_cleunik where f1.tpf_cleunik<>-1 or f1.tpf_cleunik_01<>-1";
$result_nb_deee = _graal_requete_bd($sql_req_nb_deee);
$row = mysql_fetch_assoc($result_nb_deee);
$nb_deee=$row['nb_deee'];
$nb_deee=round($nb_deee,0);
_graal_libere_requete_bd($sql_req_nb_deee);
	
//	Taxe parafiscale
$result_parafiscale = _graal_requete_bd($sql_req_parafiscale);
//echo $sql_req_parafiscale;
while ($row = mysql_fetch_assoc($result_parafiscale)) {
  if ($row['montant_avec_remise_pied']!=0){
    //$total_base_brute+=$row['montant_avec_remise_pied'];
  	$total_ht+=$row['montant_avec_remise_pied'];
    $total_taxe+=$row['montant_taxe'];
    $total_ttc+=$row['montant_taxe']+$row['montant_avec_remise_pied'];
    ++$nbligne_montant_pied;
    if ($nb_deee!=0){
    	$intitule=$vl_c_bvj_143." (".$nb_deee.")";
    } else {
    	$intitule=$vl_c_bvj_143;
    }
      array_push($totaux,$intitule,$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
	array_push($totaux_remise,$intitule,$row['htbrutremise'],$row['montantremise_pied'],$row['montant_avec_remise_pied'],$row['taux_taxe'],$row['montant_taxe'],$row['montant_taxe']+$row['montant_avec_remise_pied']);
  }
} 
_graal_libere_requete_bd($result_parafiscale);
//}
?>
