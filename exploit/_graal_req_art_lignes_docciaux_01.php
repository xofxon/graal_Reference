<?php
include("_graal_header_xml.inc.php");
$vl_e_art_cleunik=intval(fa_recup_param('vl_art_cleunik','-2'));
$vl_c_datedebut=fa_recup_param('vl_c_dateheuredebut','');
$vl_c_datefin=fa_recup_param('vl_c_dateheurefin','');
$vl_c_heuredebut=fa_recup_param('vl_c_heuredebut','000000');
$vl_c_heurefin=fa_recup_param('vl_c_heurefin','235959');
$vl_e_statut=intval(fa_recup_param('statut','-1'));
$vl_e_limit=intval(fa_recup_param('limit','1'));
$vl_e_act_cleunik=intval(fa_recup_param('vl_act_cleunik','-2'));
$vl_e_commercial_cleunik=intval(fa_recup_param('vl_commercial_cleunik','-2'));
$vl_operat_statut=intval(fa_recup_param('vl_operat_statut','1'));
$vl_type_recherche=intval(fa_recup_param('vl_type_recherche','0'));
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_particulier=fa_recup_param('vl_c_particulier','-1');
$vl_c_sortie=fa_recup_param('sortie','das');
$sql_req="";
if ($vl_e_art_cleunik==-2) {
  $condart=" f1.art_cleunik=f1.art_cleunik and f1.art_cleunik<>0 and ";
} else {
  $condart=" f1.art_cleunik=$vl_e_art_cleunik and f1.art_cleunik<>0 and ";
}
if ($vl_e_act_cleunik==-2) {
  $condact="";
} else {
  $condact=" f2.act_cleunik=$vl_e_act_cleunik and ";
}
if ($vl_e_commercial_cleunik==-2) {
  $condcial="";
} else {
  $condcial=" f1.commercial_cleunik<>$vl_e_commercial_cleunik and ";
}
$sql_req="SELECT f1.commercial_ligne_cleunik as z01,f1.commercial_cleunik as z02,f1.ligne_cleunik as z03,f1.art_cleunik as z04,f2.code as z05,f3.nomcommercial as z07,";
$sql_req.=" f7.qte as z08,f7.qte_nbdec as z09,f7.qte_unite as z10,f1.pu as z11,f1.pu_type as z12,f1.nbdec_pu as z13,f1.remise_taux as z14,f1.remise_type as z15,";
$sql_req.=" f1.remise_genr as z24,f4.choix_valeur_texte_01 as z16,f7.dateheure_confirm as z17,"._graalsql_date('f7.dateheure_confirm')." as z18,";
$sql_req.=" "._graalsql_time('f7.dateheure_confirm')." as z19,f5.choix_valeur_texte_01 as z20,f2.action_cleunik as z21,f6.code as z22,f6.description as z23,";
$sql_req.=" f1.coef_facture as coef_facture,(case f1.remise_genr when 1 then (case f1.remise_taux when 0 then ((f7.qte * f1.pu) * f1.coef_facture) else (((f7.qte * f1.pu) * ";
$sql_req.=" f1.coef_facture) - (((f7.qte * f1.pu) * f1.coef_facture) * (f1.remise_taux / 100))) end) else (((f7.qte * f1.pu) * f1.coef_facture) - f1.remise_taux) end) AS htbrutremise,";
$sql_req.=" f7.statut as statut,f7.ligne_qte_cleunik as ligne_qte_cleunik,f7.qte_deja as qte_deja,f2.dateheurelivraison,"._graalsql_date('f2.dateheurelivraison')." as date_livraison_claire,";
$sql_req.=" f1.code_acteur,f1.mnemotechnique_acteur,f1.description_acteur,f8.statut as statut_124,f9.choix_valeur_texte_01 as statut_action";
$sql_req.=" from $fic_lignes f1,$fic_entete f2,_acteurs f3,_choix f4,_choix f5,";
$sql_req.=" _article f6,$fic_qte f7,_actions f8,_choix f9 WHERE $condart $condact $condcial f2.commercial_cleunik=f1.commercial_cleunik and f3.act_cleunik=f2.act_cleunik and ";
$sql_req.=" f4.choix_cleunik=f7.qte_unite and f5.choix_cleunik=f7.statut and f6.art_cleunik=f1.art_cleunik and f1.commercial_ligne_cleunik=f7.commercial_ligne_cleunik";
$sql_req.=" and f8.action_cleunik=f2.action_cleunik and f9.choix_cleunik=f8.statut";
switch ($vl_c_particulier){
	case "-1":	//	pas de cas particulier
		$sql_req.= " AND (f7.dateheure_confirm between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin')";
		break;
	case "1":	//	Heure de confirmation à zéro
		$sql_req.= " AND (f7.dateheure_confirm='00000000000000')";
		break;
	case "2":	//	Heure de demande à zéro
		$sql_req.= " AND (f7.dateheure_demande='00000000000000')";
		break;
	case "3":	//	Reste à livrer sur commandes clients
		break;
	case "4":	//	Reste à recevoir sur commandes fournisseurs
		break;
	case "5":	//	Liste de lignes
		$vl_c_var=fa_recup_param('var','vs_tempo_panier_action_lignes_doc');
	    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
	    $vl_commercial_ligne_cleunik="";
	    unset($_SESSION["$vl_c_var"]);
	    $vl_e_i=-1;
	    foreach($vl_t_listecles as $vl_raf) {
	      $vl_e_i++;
	      $vl_commercial_ligne_cleunik.=$vl_t_listecles[$vl_e_i].',';
	    }
	    if ($vl_commercial_ligne_cleunik!="") {$vl_commercial_ligne_cleunik=substr($vl_commercial_ligne_cleunik, 0, -1);}
	    $sql_req.= " AND f1.commercial_ligne_cleunik IN ($vl_commercial_ligne_cleunik)";
		break;
}
if ($vl_e_statut!=-1) {
	switch ($vl_operat_statut){
		case 1:$sql_req.= " AND f7.statut=$vl_e_statut";break;
		case 2:$sql_req.= " AND f7.statut<>$vl_e_statut";break;
	}
}
switch ($vl_type_recherche){
	case 0:break;
	case 1:$sql_req.=" and f6.code like '$vl_c_recherche%'";break;	//code article
	case 2:$sql_req.=" and f6.description like '$vl_c_recherche%'";break;	//désignation article
	case 3:$sql_req.=" and f6.mnemotechnique like '$vl_c_recherche%'";break;	//id mnémotechnique article
	case 4:$sql_req.=" and f3.nomcommercial like '$vl_c_recherche%'";break;	//Nom commercial
}
$sql_req.= " order by f7.dateheure_confirm DESC,f1.ligne_cleunik ASC ";
if ($vl_e_limit!=-1){
	$sql_req.= " LIMIT 0,$vl_e_limit;";
}
switch ($vl_c_sortie) {
  case "das":
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
	exit();
    break;
  case "xls":
  	require_once "sources_excel/class.writeexcel_workbook.inc.php";
	require_once "sources_excel/class.writeexcel_worksheet.inc.php";
	$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','titi.xls');
	$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
	$workbook =new writeexcel_workbook($fname);
	$worksheet =& $workbook->addworksheet( utf8_decode('Export Requête XsOFtware'));
  	$result = _graal_requete_bd($sql_req);
	$nfields = mysql_num_fields($result);
	$vl_e_noligne=0;
	//  Lecture des colonnes
	for ($i=0; $i<$nfields; $i++)
	{
	    $fieldname = mysql_field_name($result, $i);
	    $worksheet->write($vl_e_noligne, $i, "$fieldname");
	}
	//  Lecture des résultats de la requête

	while ($line = mysql_fetch_array($result, MYSQL_ASSOC))
	{
	  $j = 0;
	  $vl_e_noligne++;
	  foreach ($line as $field)
	  {
	      $worksheet->write($vl_e_noligne, $j, utf8_decode($field));
	      $j++;
	  }
	}
	mysql_free_result($result);
	mysql_close($connection);
	$workbook->close();

	header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
	header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
	$fh=fopen($fname, "rb");
	fpassthru($fh);
	unlink($fname);
  	exit();
  	break;
}
$result = _graal_requete_bd($sql_req);
echo('<donnees>');
while ($row = mysql_fetch_assoc($result)) {
	switch ($vl_c_particulier){
		case "3":	//	Reste à livrer sur commandes clients
		case "4":	//	Reste à recevoir sur commandes fournisseurs
			$val_qte_ral=fa_ent_xml($row['z08']-$row['qte_deja'])*1000;
			if ($val_qte_ral<>0){
				$vl_b_insere="ok";
			} else {
				$vl_b_insere="pasok";
			}
			break;
		default:
			$vl_b_insere="ok";
			break;
	}
	if ($vl_b_insere=="ok"){
		echo('<quoi ');
	  $nb_dec_qte=fa_ent_xml($row['z09']);
	  $nb_dec_pu=fa_ent_xml($row['z13']);
	  echo(' code_acteur="'.fa_ent_xml($row['code_acteur']).'"');
	  echo(' mnemotechnique_acteur="'.fa_ent_xml($row['mnemotechnique_acteur']).'"');
	  echo(' description_acteur="'.fa_ent_xml($row['description_acteur']).'"');
	  echo(' dateheure_livraison="'.fa_ent_xml($row['dateheure_livraison']).'"');
	  echo(' date_livraison_claire="'.fa_ent_xml($row['date_livraison_claire']).'"');
	  echo(' z01="'.fa_ent_xml($row['z01']).'"');
	  echo(' z02="'.fa_ent_xml($row['z02']).'"');
	  echo(' z03="'.fa_ent_xml($row['z03']).'"');
	  echo(' z04="'.fa_ent_xml($row['z04']).'"');
	  echo(' z05="'.fa_ent_xml($row['z05']).'"');
	  echo(' z06="'.fa_ent_xml($row['z06']).'"');
	  echo(' z07="'.fa_ent_xml($row['z07']).'"');
	  if ($row['z08']==0) {$z08="";} else {$z08=fa_reel(fa_ent_xml($row['z08']),$nb_dec_qte);}
	  echo(' z08="'.$z08.'"');
	  $val_qte=fa_ent_xml($row['z08'])*1000;
	  printf(' val_qte="%011u"',$val_qte);
	  if ($row['z11']==0) {$z11="";} else {$z11=fa_reel(fa_ent_xml($row['z11']),$nb_dec_pu);}
	  echo(' z11="'.$z11.'"');
	  $val_pu=fa_ent_xml($row['z11'])*1000;
	  printf(' val_pu="%011u"',$val_pu);
	  if ($row['z14']==0) {$z14="";} else {$z14=fa_reel(fa_ent_xml($row['z14']),$nb_dec_pu);}
	  echo(' z14="'.$z14.'"');
	  echo(' z16="'.fa_ent_xml($row['z16']).'"');
	  $htligne=$row['z08']*$row['z11'];
	  $htbrutremise=fa_reel(fa_ent_xml($row['htbrutremise']),$nb_dec_pu);
	  if ($htbrutremise==$htligne) {$htbrutremise="";}
	  if ($htligne==0) {$htligne="";} else {$htligne=fa_reel(fa_ent_xml($htligne),$nb_dec_pu);}
	  echo(' htligne="'.$htligne.'"');
	  $val_htligne=$row['z08']*$row['z11']*1000;
	  printf(' val_htligne="%011u"',$val_htligne);
	  echo(' z17="'.fa_ent_xml($row['z17']).'"');
	  echo(' z18="'.fa_ent_xml($row['z18']).'"');
	  $dd=$row['z18'];if ($dd=='00.00.0000') {$dd='';}
	  $hd=$row['z19'];if ($hd=='00:00:00') {$hd='';}
	  echo(' dateheure="'.$dd.' '.$hd.'"');
	  echo(' z20="'.fa_ent_xml($row['z20']).'"');
	  echo(' z21="'.fa_ent_xml($row['z21']).'"');
	  echo(' z22="'.fa_ent_xml($row['z22']).'"');
	  echo(' z23="'.fa_ent_xml($row['z23']).'"');
	  echo(' z24="'.fa_ent_xml($row['z24']).'"');
	  $coef_facture=$row['coef_facture'];
	  if($coef_facture==0) {$coef_facture_clair="Non facturable";$prop_coef_facture="ag15";} else {$coef_facture_clair="";$prop_coef_facture="";}
	  echo(' coef_facture_clair="'.$coef_facture_clair.'"');
	  echo(' prop_coef_facture="'.$prop_coef_facture.'"');
	  echo(' htbrutremise="'.$htbrutremise.'"');
	  echo(' prop_129="prop_129_'.$row['statut'].'"');
	  echo(' prop_124="prop_124_'.$row['statut_124'].'"');
	  echo(' prop_122="prop_122_'.$row['confi_122'].'"');
	  if ($row['statut']==-39) {
	    echo(' prop_statut="ac04"');
	  } else {
	    echo(' prop_statut=""');
	  }
		echo(' ligne_qte_cleunik="'.fa_ent_xml($row['ligne_qte_cleunik']).'"');
		if ($row['qte_deja']==0) {$qte_deja="";} else {$qte_deja=fa_reel(fa_ent_xml($row['qte_deja']),$nb_dec_qte);}
	  echo(' qte_deja="'.$qte_deja.'"');
	  $val_qte_deja=fa_ent_xml($row['qte_deja'])*1000;
	  printf(' val_qte_deja="%011u"',$val_qte_deja);
		$ral=fa_reel(fa_ent_xml($row['z08']-$row['qte_deja']),$nb_dec_qte);
	  	if ($ral==0){$ral="";}
	  	echo(' ral="'.$ral.'"');
	  	$val_qte_ral=fa_ent_xml($row['z08']-$row['qte_deja'])*1000;
	    printf(' val_qte_ral="%011u"',$val_qte_ral);
	    $ligne = sprintf("%04d", $row['z03']);
	   echo(' cde_ligne="'.fa_ent_xml($row['z05'])."-".$ligne.'"');
	   echo(' statut_action="'.fa_ent_xml($row['statut_action']).'"');
	   echo('/>');
	}
}
echo('</donnees>');
_graal_libere_requete_bd($result);
_graal_ferme_connexion();
?>
