<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_numerotation.php");
set_time_limit(6000);
define('EOL', "\r\n");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_acteurs_admin_01";
fa_acces_script();
$vl_c_type=fa_recup_param('type','');
$nombre=0;
session_write_close();
switch ($vl_c_type) {
  case '1': //  MAJ niveau 4 ancienne NAF à partir niveau 5 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=25 and a2.cleunikcriterefils=25 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '2': //  MAJ niveau 3 ancienne NAF à partir niveau 4 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=24 and a2.cleunikcriterefils=24 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '3': //  MAJ niveau 2 ancienne NAF à partir niveau 3 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=23 and a2.cleunikcriterefils=23 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '4': //  MAJ niveau 1 ancienne NAF à partir niveau 2 ancienne NAF
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.cleunikchoixpere,a2.cleunikcriterepere,a1.typeacteur,a1.uti_cleunik from _act_choix_fixes a1,_critere_pere_fils a2 where a1.critere_cleunik=22 and a2.cleunikcriterefils=22 and a2.cleunikchoixfils=a1.choix_cleunik;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '5': //  MAJ de la commune INSEE en fonction de la ville récupérée sur adresse
	echo ("Le traitement peut être assez long ... patience ...");
    $sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.choix_cleunik,a2.critere_cleunik,a3.typeacteur,0 from _act_adresses a1 left join _choix a2 on a1.adr_ville=a2.choix_valeur_texte_02 left join _acteurs a3 on a1.act_cleunik=a3.act_cleunik where a2.critere_cleunik=65 and a1.choix_cleunik=60000;";
    $nombre=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '6': //  MAJ du département INSEE en fonction du code postal récupéré sur adresse
	echo ("Le traitement peut être assez long ... patience ...");
	$nombre=0;
	$sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.choix_cleunik,a2.critere_cleunik,a3.typeacteur,0 from _act_adresses a1,_choix a2,_acteurs a3 where a2.critere_cleunik=62 and a1.choix_cleunik=60000 and substring(a1.adr_cp,1,2)<>'97' and SUBSTRING(a2.choix_code,4,3)= concat('0',substring(a1.adr_cp,1,2)) and a1.act_cleunik=a3.act_cleunik;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
	$sql_maj="insert ignore into _act_choix_fixes select a1.act_cleunik,a2.choix_cleunik,a2.critere_cleunik,a3.typeacteur,0 from _act_adresses a1,_choix a2,_acteurs a3 where a2.critere_cleunik=62 and a1.choix_cleunik=60000 and substring(a1.adr_cp,1,2)='97' and SUBSTRING(a2.choix_code,4,3)= substring(a1.adr_cp,1,3) and a1.act_cleunik=a3.act_cleunik;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case '7':// MAJ Région INSEE en fonction du critère département
	echo ("Le traitement peut être assez long ... patience ...");
	$nombre=0;
	$sql_maj="insert ignore into _act_choix_fixes select f1.act_cleunik,f3.choix_cleunik,61,f1.typeacteur,0 from _act_choix_fixes f1 join _choix f2 on f1.choix_cleunik=f2.choix_cleunik join _choix f3 on f3.choix_code=substring(f2.choix_code,1,2) where f1.critere_cleunik=62 and f3.critere_cleunik=61;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;    
  case "8":
  	$sql_req ="SELECT _acteurs.raisonsoc as raisonsoc,_acteurs.nomcommercial as nomcommercial,_acteurs.siret as siret,_acteurs.blocnotebrut as blocnotebrut,";
	$sql_req.=" _acteurs.blocnotertf as blocnotertf,_acteurs.c_uuid as uuid,_act_compta.tvaintracommunautaire, ";
	$sql_req.=" _act_compta.encours_autorise as encours_autorise,_act_compta.catcompta_cleunik,_act_compta.tarif_cleunik as tarif_cleunik,";
	$sql_req.= " _act_compta.remise_taux as remise_taux,_act_compta.remise_type as remise_type,_act_compta.remise_genr as remise_genr,escompte_taux as escompte_taux,escompte_type as escompte_type,";
	$sql_req.= " _act_compta.remise_natu as remise_natu,_act_compta.reg_cleunik as reg_cleunik,_act_compta.assujetti_tpf as assujetti_tpf,pc_cleunik as pc_cleunik,_acteurs.actif as actif,_acteurs.devise as devise,_acteurs.langue as langue,";
	$sql_req.= " _act_compta.montant_port as montant_port,_act_compta.seuil_franco as seuil_franco,_act_compta.commande_mini as commande_mini";
	$sql_req.=" FROM _acteurs left join _act_compta using(act_cleunik) where _acteurs.act_cleunik=0";
	pf_crea_enr_compta_clients();
	$sql_req ="SELECT catcompta_cleunik FROM _act_compta where act_cleunik=0;";
	$result=_graal_requete_bd($sql_req);
	$row= mysql_fetch_assoc($result);
	$catcompta_cleunik=$row['catcompta_cleunik'];
	_graal_libere_requete_bd($result);
	$nombre=0;
	$sql_maj ="UPDATE _act_compta f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.catcompta_cleunik= $catcompta_cleunik where f2.typeacteur=110003 ;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
    break;
  case "9":
	pf_crea_enr_compta_clients();
	$sql_req ="SELECT assujetti_tpf FROM _act_compta where act_cleunik=0;";
	$result=_graal_requete_bd($sql_req);
	$row= mysql_fetch_assoc($result);
	$assujetti_tpf=$row['assujetti_tpf'];
	_graal_libere_requete_bd($result);
	$nombre=0;
	$sql_maj ="UPDATE _act_compta f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.assujetti_tpf= $assujetti_tpf where f2.typeacteur=110003 ;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
  	break;
  case "10":
	pf_crea_enr_compta_clients();
	$sql_req ="SELECT reg_cleunik FROM _act_compta where act_cleunik=0;";
	$result=_graal_requete_bd($sql_req);
	$row= mysql_fetch_assoc($result);
	$reg_cleunik=$row['reg_cleunik'];
	_graal_libere_requete_bd($result);
	$nombre=0;
	$sql_maj ="UPDATE _act_compta f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.reg_cleunik= $reg_cleunik where f2.typeacteur=110003 ;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
  	break;
  case "11":
	pf_crea_enr_compta_clients();
	$sql_req ="SELECT tarif_cleunik FROM _act_compta where act_cleunik=0;";
	$result=_graal_requete_bd($sql_req);
	$row= mysql_fetch_assoc($result);
	$tarif_cleunik=$row['tarif_cleunik'];
	_graal_libere_requete_bd($result);
	$nombre=0;
	$sql_maj ="UPDATE _act_compta f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set f1.tarif_cleunik= $tarif_cleunik where f2.typeacteur=110003 ;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
  	break;
  case "12":
	pf_crea_enr_compta_clients();
	$sql_req ="SELECT remise_taux,remise_type,remise_genr,escompte_taux,escompte_type,remise_natu FROM _act_compta where act_cleunik=0;";
	$result=_graal_requete_bd($sql_req);
	$row= mysql_fetch_assoc($result);
	$remise_taux=$row['remise_taux'];
	$remise_type=$row['remise_type'];
	$remise_genr=$row['remise_genr'];
	$escompte_taux=$row['escompte_taux'];
	$escompte_type=$row['escompte_type'];
	$remise_natu=$row['remise_natu'];
	_graal_libere_requete_bd($result);
	$nombre=0;
	$sql_maj ="UPDATE _act_compta f1 left join _acteurs f2 on f1.act_cleunik=f2.act_cleunik set ";
	$sql_maj.="f1.remise_taux= $remise_taux,";
	$sql_maj.="f1.remise_type= $remise_type,";
	$sql_maj.="f1.remise_genr= $remise_genr,";
	$sql_maj.="f1.escompte_taux= $escompte_taux,";
	$sql_maj.="f1.escompte_type= $escompte_type,";
	$sql_maj.="f1.remise_natu= $remise_natu";
	$sql_maj.=" where f2.typeacteur=110003 ;";
	$nombre+=_graal_requete_nombre_affecte($sql_maj);
    $vf_c_echo="$nombre mises à jour.".EOL;
  	break;
  case "13":
  	_graal_numerotation_compta_orphelins_bis();
  
}
echo $vf_c_echo;
function pf_crea_enr_compta_clients(){
	$sql_req = "insert into _act_compta SELECT  f1.act_cleunik,f3.compte,'',f3.catcompta_cleunik,f3.encours_autorise,f3.tarif_cleunik,f3.remise_taux,";
    $sql_req.= " f3.remise_type,f3.remise_genr,f3.escompte_taux,f3.escompte_type,f3.remise_natu,f3.reg_cleunik,f3.pc_cleunik,f3.assujetti_tpf,f3.montant_port,f3.seuil_franco,f3.commande_mini";
	$sql_req.= " FROM _act_compta f3,_acteurs f1 left join _act_compta f2 on f1.act_cleunik=f2.act_cleunik  ";
	$sql_req.= " where f3.act_cleunik=0 and f1.typeacteur=110003 and f2.act_cleunik is null;";    
    $vf_c_echo=_graal_exec_requete($sql_req);
}
?>
