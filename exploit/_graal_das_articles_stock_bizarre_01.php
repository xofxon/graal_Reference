<?php
include("_graal_header_xml.inc.php");
$vl_c_qui=fa_recup_param('vl_c_qui','tous');
$vl_c_zone=fa_recup_param('vl_c_zone','1');
$vl_c_recherche=fa_recup_param('vl_c_recherche','%');
$vl_c_validite=fa_recup_param('vl_c_validite','');$vl_c_validite='';
$vl_e_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_e_actif=intval(fa_recup_param('vl_e_actif','0'));
$vl_e_limit=intval(fa_recup_param('vl_e_limit','100'));
$vl_e_qte_nulle=intval(fa_recup_param("vl_e_qte_nulle",'3'));
$vl_c_sortie=fa_recup_param('sortie','das');
$vl_c_nom_fichier_xls=fa_recup_param('vl_c_nom_fichier_xls','inventaire.xls');
session_write_close();
$sql_req="create temporary table temp_bizarr_$vl_e_uti_cleunik as select _article.code,_article.mnemotechnique,_article.description,a1.art_cleunik,a1.qte_stock,_article.actif,";
$sql_req.= " (select a2.qte_pos from _mouvements_stock a2 where a2.art_cleunik=a1.art_cleunik order by dateheuremvt desc,mvt_cleunik desc limit 1) as qte_stock_mvt ";
$sql_req.= " from _art_stock a1 left join _article using(art_cleunik) where 1=1 ";
//create temporary table temp_bizarr_1 as select _article.code,_article.mnemotechnique,_article.description,_article_description,a1.art_cleunik,a1.qte_stock, (select a2.qte_pos from _mouvements_stock a2 where a2.art_cleunik=a1.art_cleunik order by dateheuremvt desc limit 1) as qte_stock_mvt  from _art_stock a1 left join _article using(art_cleunik) where 1=1
switch ($vl_c_qui) {
  case 'tous': break;//tous
  case 'favoris': $sql_req.= " AND _article.art_cleunik IN (SELECT _art_favoris.art_cleunik from _art_favoris where uti_cleunik=$vl_e_uti_cleunik and genre=1)";break;//  Favoris
  case 'achats' : $sql_req.= " AND _article.types_gestion & 1";break;
  case 'ventes' : $sql_req.= " AND _article.types_gestion & 2";break;
  case 'stocks' : $sql_req.= " AND _article.types_gestion & 4";break;
  case 'fabrication': $sql_req.= " AND _article.types_gestion & 8";break;
}
switch ($vl_e_actif) {
  case 1: $sql_req.= " AND _article.actif=1";break;// Actifs
  case 2: $sql_req.= " AND _article.actif=2";break;// Inactifs
  case 0: break;// Tous
}
switch ($vl_c_validite) {
  case '': break;
  default: $sql_req.=" and (_article.dateheurevalidite >= '$vl_c_validite' or _article.dateheurevalidite is null)";break;
}
switch ($vl_e_qte_nulle) {
  case 1: $sql_req.= " AND qte_stock=0";break;// Nulle
  case 2: $sql_req.= " AND qte_stock<>0";break;// Non nulle
  case 3: break;// Tous
  case 4: $sql_req.= " AND qte_stock<0";break;// Négatives
}
/*
switch ($vl_c_zone) {
  case '1': $sql_req.=" and _article.description like '$vl_c_recherche%' ORDER BY `description` ASC";break;//  Description courte
  case '2': $sql_req.=" and _article.code like '$vl_c_recherche%' ORDER BY `code` ASC";break;//  Code
  case '3': $sql_req.=" and _article.mnemotechnique like '$vl_c_recherche%' ORDER BY `mnemotechnique` ASC";break;//  Mnémotechnique
}
*/
$vf_c_retour=_graal_exec_requete($sql_req);
//echo $vf_c_retour;
//if ($result!="ok")>
$sql_req="SELECT * from temp_bizarr_$vl_e_uti_cleunik where qte_stock<> qte_stock_mvt";
$sql_req.= " LIMIT 0, $vl_e_limit";
$nb_dec=2;
switch ($vl_c_sortie) {
  case "das":
    $result = _graal_requete_bd($sql_req);
	echo('<donnees>');
	while ($row = mysql_fetch_assoc($result)) {
		echo('<quoi ');
	  if ($row['qte_stock']==0) {
	    $qte_stock=""; } else
	  {
	    $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
	  }
	  $val_qte_stock=$row['qte_stock']*1000;
	  if ($row['qte_stock_mvt']==0) {
	    $qte_stock_mvt=""; } else
	  {
	    $qte_stock_mvt=fa_reel(fa_ent_xml($row['qte_stock_mvt']),$nb_dec);
	  }
	  $val_qte_stock_mvt=$row['qte_stock_mvt']*1000;
	  echo(' art_cleunik="'.fa_ent_xml($row['art_cleunik']).'"');
	  echo(' code="'.fa_ent_xml($row['code']).'"');
	  echo(' mnemotechnique="'.fa_ent_xml($row['mnemotechnique']).'"');
	  echo(' description="'.fa_ent_xml($row['description']).'"');
	  echo(' qte_stock="'.$qte_stock.'"');
	  printf(' val_qte_stock="%011u"',$val_qte_stock);
	  echo(' qte_stock_mvt="'.$qte_stock_mvt.'"');
	  //printf(' val_qte_stock_mvt="%011u"',$val_qte_stock_mvt);
	  echo(' val_qte_stock_mvt="'.$val_qte_stock_mvt.'"');
	  if ($row['actif']==1) {
	    echo(' properties=""');
	  } else {
	    echo(' properties="css_0001"');
	  }
	  echo('/>');
	}
	echo('</donnees>');
	_graal_libere_requete_bd($result);

    break;
    case "excel_01":	//	inventaire "simple" fen_inventaire_03
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib("Fen_01115",$vl_e_uti_cleunik);
		$vl_c_bvh_100=fa_recup_dico("bvh_100");
		$vl_c_bvh_101=fa_recup_dico("bvh_101");
		$vl_c_bvh_102=fa_recup_dico("bvh_102");
		$vl_c_bvh_103=fa_recup_dico("bvh_103");
		$vl_c_bvh_104=fa_recup_dico("bvh_104");
		$vl_c_bvh_105=fa_recup_dico("bvh_105");
		$vl_c_bvh_106=fa_recup_dico("bvh_106");
		$vl_c_bvh_107=fa_recup_dico("bvh_107");
		$vl_c_bvh_108=fa_recup_dico("bvh_108");
		$vl_c_bvh_109=fa_recup_dico("bvh_109");
		$vl_c_bvh_110=fa_recup_dico("bvh_110");
		$vl_c_bvh_111=fa_recup_dico("bvh_111");
		$vl_c_bvh_112=fa_recup_dico("bvh_112");
		$vl_c_bvh_113=fa_recup_dico("bvh_113");
		$vl_c_bvh_114=fa_recup_dico("bvh_114");
		$vl_c_bvh_115=fa_recup_dico("bvh_115");
		$vl_c_bvh_116=fa_recup_dico("bvh_116");
		$vl_c_bvh_117=fa_recup_dico("bvh_117");
		$vl_c_bvh_121=fa_recup_dico("bvh_121");
		$vl_c_bvh_122=fa_recup_dico("bvh_122");
		$vl_c_bvh_123=fa_recup_dico("bvh_123");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Inventaires"));
		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("$vl_c_bvh_101"));
		$worksheet->write(0, 1, utf8_decode("$vl_c_bvh_102"));
		$worksheet->write(0, 2, utf8_decode("art_cleunik"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bvh_103"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bvh_104"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_bvh_106"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_bvh_105"));
		$worksheet->write(0, 7, utf8_decode("dateheure_dermvt_tri"));
		$worksheet->write(0, 8, utf8_decode("val_qte_stock"));
		$worksheet->write(0, 9, utf8_decode("$vl_c_bvh_113"));
		$worksheet->write(0,10, utf8_decode("dateheure_invent_tri"));
		$worksheet->write(0,11, utf8_decode("$vl_c_bvh_116"));
		$vl_e_noligne=1;

		while ($row = mysql_fetch_assoc($result)) {
			$nb_dec=fa_ent_xml($row['nb_decimales_qte']);
			  if ($row['qte_stock']==0) {
			    $qte_stock=""; } else
			  {
			    $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
			  }
			  $val_qte_stock=$row['qte_stock']*1000;
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['mnemotechnique']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['art_cleunik']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($qte_stock));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['unite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_dermvt']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_dermvt_tri']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($val_qte_stock));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_invent']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_invent_tri']));$j++;
		    $worksheet->write($vl_e_noligne, $j, -1);$j++;

		    $vl_e_noligne++;
		}

		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    	break;
	case "excel_02_inventaire_04":	//	inventaire avec dépots et emplacements fen_inventaire_04
		require_once "sources_excel/class.writeexcel_workbook.inc.php";
		require_once "sources_excel/class.writeexcel_worksheet.inc.php";

		_graal_requete_charge_varlib("Fen_01117",$vl_e_uti_cleunik);
		$vl_c_bvh_100=fa_recup_dico("bvh_100");
		$vl_c_bvh_101=fa_recup_dico("bvh_101");
		$vl_c_bvh_102=fa_recup_dico("bvh_102");
		$vl_c_bvh_103=fa_recup_dico("bvh_103");
		$vl_c_bvh_104=fa_recup_dico("bvh_104");
		$vl_c_bvh_105=fa_recup_dico("bvh_105");
		$vl_c_bvh_106=fa_recup_dico("bvh_106");
		$vl_c_bvh_107=fa_recup_dico("bvh_107");
		$vl_c_bvh_108=fa_recup_dico("bvh_108");
		$vl_c_bvh_109=fa_recup_dico("bvh_109");
		$vl_c_bvh_110=fa_recup_dico("bvh_110");
		$vl_c_bvh_111=fa_recup_dico("bvh_111");
		$vl_c_bvh_112=fa_recup_dico("bvh_112");
		$vl_c_bvh_113=fa_recup_dico("bvh_113");
		$vl_c_bvh_114=fa_recup_dico("bvh_114");
		$vl_c_bvh_115=fa_recup_dico("bvh_115");
		$vl_c_bvh_116=fa_recup_dico("bvh_116");
		$vl_c_bvh_117=fa_recup_dico("bvh_117");
		$vl_c_bvh_121=fa_recup_dico("bvh_121");
		$vl_c_bvh_122=fa_recup_dico("bvh_122");
		$vl_c_bvh_123=fa_recup_dico("bvh_123");
		$vl_c_bvh_126=fa_recup_dico("bvh_126");
		$vl_c_bvh_127=fa_recup_dico("bvh_127");

		$fname = tempnam("/tmp", "$vl_c_nom_fichier_xls");
		$workbook = new writeexcel_workbook($fname);
		$worksheet =& $workbook->addworksheet( utf8_decode("Inventaires"));
		$result = _graal_requete_bd($sql_req);
		$worksheet->write(0, 0, utf8_decode("$vl_c_bvh_101"));
		$worksheet->write(0, 1, utf8_decode("$vl_c_bvh_102"));
		$worksheet->write(0, 2, utf8_decode("art_cleunik"));
		$worksheet->write(0, 3, utf8_decode("$vl_c_bvh_103"));
		$worksheet->write(0, 4, utf8_decode("$vl_c_bvh_104"));
		$worksheet->write(0, 5, utf8_decode("$vl_c_bvh_106"));
		$worksheet->write(0, 6, utf8_decode("$vl_c_bvh_105"));
		$worksheet->write(0, 7, utf8_decode("dateheure_dermvt_tri"));
		$worksheet->write(0, 8, utf8_decode("val_qte_stock"));
		$worksheet->write(0, 9, utf8_decode("$vl_c_bvh_113"));
		$worksheet->write(0,10, utf8_decode("dateheure_invent_tri"));
		$worksheet->write(0,11, utf8_decode("$vl_c_bvh_116"));
		$worksheet->write(0,12, utf8_decode("$vl_c_bvh_126"));
		$worksheet->write(0,13, utf8_decode("$vl_c_bvh_127"));
		$vl_e_noligne=1;

		while ($row = mysql_fetch_assoc($result)) {
			$nb_dec=fa_ent_xml($row['nb_decimales_qte']);
			  if ($row['qte_stock']==0) {
			    $qte_stock=""; } else
			  {
			    $qte_stock=fa_reel(fa_ent_xml($row['qte_stock']),$nb_dec);
			  }
			  $val_qte_stock=$row['qte_stock']*1000;
			$j=0;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['code']));$j++;
			$worksheet->write($vl_e_noligne, $j, utf8_decode($row['mnemotechnique']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['art_cleunik']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['description']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($qte_stock));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['unite']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_dermvt']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_dermvt_tri']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($val_qte_stock));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_invent']));$j++;
		    $worksheet->write($vl_e_noligne, $j, utf8_decode($row['dateheure_invent_tri']));$j++;
		    $worksheet->write($vl_e_noligne, $j, -1);$j++;	//	Quantite inventoriée
		    $worksheet->write($vl_e_noligne, $j, "");$j++;	//	Depot
		    $worksheet->write($vl_e_noligne, $j, "");$j++;	//	Emplacement

		    $vl_e_noligne++;
		}

		$workbook->close();
		header("Content-Type: application/x-msexcel; name=\"$vl_c_nom_fichier_xls\"");
		header("Content-Disposition: inline; filename=\"$vl_c_nom_fichier_xls\"");
		$fh=fopen($fname, "rb");
		fpassthru($fh);
		_graal_libere_requete_bd($result);
		_graal_ferme_connexion();
    	break;

  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
    break;
  }
_graal_ferme_connexion();
?>
