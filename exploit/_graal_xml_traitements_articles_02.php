<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
// execution de la requète SQL
$nombre_emploi_documents=0;
$vl_e_tarif_cleunik=intval(fa_recup_param("vl_e_tarif_cleunik","-1"));
$vl_e_type=intval(fa_recup_param("vl_e_type","-1"));
//$sql_req="SELECT count(*) as nombre FROM _art_tarifs,_article where tarif_cleunik=$vl_e_tarif_cleunik and act_cleunik=0 and type=1 and _article.art_cleunik=_art_tarifs.art_cleunik;";
$sql_req="SELECT count(*) as nombre FROM _art_tarifs,_article where tarif_cleunik=$vl_e_tarif_cleunik and act_cleunik=0 and type=$vl_e_type and _article.art_cleunik=_art_tarifs.art_cleunik;";
//$aa=$sql_req;
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_articles=fa_ent_xml($row['nombre']);
_graal_libere_requete_bd($result);
$sql_req="SELECT count(*) as nombre FROM _acteurs left join _act_compta using(act_cleunik) where _act_compta.tarif_cleunik=$vl_e_tarif_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_acteurs=fa_ent_xml($row['nombre']);
_graal_libere_requete_bd($result);
$sql_req="SELECT count(*) as nombre FROM _article a1 left join _nomenclatures_fab on a1.art_cleunik=_nomenclatures_fab.art_cleunik_fils left join _art_tarifs on _art_tarifs.tar_cleunik=_nomenclatures_fab.base_valorisation where _art_tarifs.tarif_cleunik=$vl_e_tarif_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_nomenclatures=fa_ent_xml($row['nombre']);
_graal_libere_requete_bd($result);
if ($vl_e_type==1) {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _offcli_lignes using(art_cleunik) where _offcli_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
} else {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _demfou_lignes using(art_cleunik) where _demfou_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
}
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_offcli=fa_ent_xml($row['nombre']);
$nombre_emploi_documents+=$nombre_emploi_offcli;
_graal_libere_requete_bd($result);
if ($vl_e_type==1) {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _cdecli_lignes using(art_cleunik) where _cdecli_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
} else {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _cdefou_lignes using(art_cleunik) where _cdefou_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
}
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_cdecli=fa_ent_xml($row['nombre']);
$nombre_emploi_documents+=$nombre_emploi_cdecli;
_graal_libere_requete_bd($result);
if ($vl_e_type==1) {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _livcli_lignes using(art_cleunik) where _livcli_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
} else {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _recfou_lignes using(art_cleunik) where _recfou_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
}
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_livcli=fa_ent_xml($row['nombre']);
$nombre_emploi_documents+=$nombre_emploi_livcli;
_graal_libere_requete_bd($result);
if ($vl_e_type==1) {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _faccli_lignes using(art_cleunik) where _faccli_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
} else {
  $sql_req="SELECT count(*) as nombre FROM _article a1 left join _facfou_lignes using(art_cleunik) where _facfou_lignes.tarif_cleunik=$vl_e_tarif_cleunik;";
}
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$nombre_emploi_faccli=fa_ent_xml($row['nombre']);
$nombre_emploi_documents+=$nombre_emploi_faccli;
_graal_libere_requete_bd($result);
echo fa_xcree_entete_xml();
echo('<Description>');
// parseType = indication pour le type des données, utile pour le tri sur la colonne
echo('<nombre_emploi_articles data="'.$nombre_emploi_articles.'"/>');
echo('<nombre_emploi_acteurs data="'.$nombre_emploi_acteurs.'"/>');
echo('<nombre_emploi_nomenclatures data="'.$nombre_emploi_nomenclatures.'"/>');
echo('<nombre_emploi_offcli data="'.$nombre_emploi_offcli.'"/>');
echo('<nombre_emploi_cdecli data="'.$nombre_emploi_cdecli.'"/>');
echo('<nombre_emploi_livcli data="'.$nombre_emploi_livcli.'"/>');
echo('<nombre_emploi_faccli data="'.$nombre_emploi_faccli.'"/>');
echo('<nombre_emploi_documents data="'.$nombre_emploi_documents.'"/>');
//echo('<aa data="'.$aa.'"/>');
echo('</Description>');

_graal_ferme_connexion();
?>
