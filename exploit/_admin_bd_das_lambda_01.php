<?php
include("_graal_header_xml.inc.php");
define('EOL', "\r\n");
$vl_panier_cleunik=intval(fa_recup_param('vl_e_panier_cleunik','-999999999999999999999'));
$sql_req="SELECT panier_requete_selection,panier_resultat,panier_type FROM _panier where panier_cleunik=$vl_panier_cleunik";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$vl_c_requete_claire=$row['panier_requete_selection'];
switch ($row['panier_type']){
	case 1:	//	panier
		$vl_c_requete_claire=str_replace('#panier#' ,$row['panier_resultat'],$vl_c_requete_claire);
		break;
	case 2:	//	requÃªte
		break;
}
_graal_libere_requete_bd($result);
$query=$vl_c_requete_claire;
session_write_close();
if ($query=='') pf_renvoyer_erreur("Error: SQL command must be provided ");
$command = strtolower(substr($query,0,strpos($query,' ')));
if (strpos('select,show,describe',$command)===false) pf_renvoyer_erreur("Error: Only SELECT/SHOW/DESCRIBE is allowed");
$connection = mysql_connect($sql_serveur,$sql_user,$sql_passwd) or pf_renvoyer_erreur('Error: Could not connect to server' . mysql_error());
$result = mysql_query("SET CHARACTER SET 'utf8';",$connection) or pf_renvoyer_erreur('Error: Query failed - ' . mysql_error());
$result = mysql_query("SET collation_connection = 'utf8_general_ci';",$connection) or pf_renvoyer_erreur('Error: Query failed - ' . mysql_error());
$result = mysql_query($query,$connection) or pf_renvoyer_erreur('Error*******: Query failed - ' . mysql_error());
switch ($command) {
  case 'select' or 'show' or 'describe':
    $nfields = mysql_num_fields($result);
		echo('<donnees>');
    while ($line = mysql_fetch_array($result, MYSQL_ASSOC)){
			echo('<quoi ');
      $j = 0;
      foreach ($line as $field){
        $fieldname = mysql_field_name($result, $j);
        $quote="/'/";
        $toto=preg_replace($quote,'_',$fieldname);
        $fieldname=fa_ent_xml_cabal($toto);
				echo(' '.$fieldname.'="'.fa_ent_xml($field).'"');
        //echo('<row:'.fa_ent_xml_cabal($fieldname).'>');
        //if(is_null($field)) {echo "null";} else {echo fa_ent_xml($field);}

        $j++;
      }
			echo('/>');
    }
    mysql_free_result($result);
		echo('</donnees>');
    break;

  default:
  	pf_renvoyer_erreur("Error: SQL command not understood");
      break;
}

mysql_close($connection);
function pf_renvoyer_erreur($vv_erreur){
echo('<donnees>');
	echo(' erreur="'.fa_ent_xml($vv_erreur).'"');
echo('</donnees>');
mysql_close($connection);
die();
}
?>
