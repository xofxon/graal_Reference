<?php
include("_graal_header_txt.inc.php");
include("_graal_fonctions_mousto.php");
define('EOL', "\r\n");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_inventaire_04";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_t_qte=fa_recup_param("vl_t_qte","");
$vl_t_art_cleunik=fa_recup_param("vl_t_art_cleunik","");
$vl_t_depot=fa_recup_param("vl_t_depot","");
$vl_t_empla=fa_recup_param("vl_t_empla","");
$vl_t_qte=unserialize(stripslashes($vl_t_qte));
$vl_t_art_cleunik=unserialize(stripslashes($vl_t_art_cleunik));
$vl_t_depot=unserialize(stripslashes($vl_t_depot));
$vl_t_empla=unserialize(stripslashes($vl_t_empla));
$vl_dateheureinventaire=fa_recup_param("vl_dateheureinventaire","");
$vl_tarif_reference=intval(fa_recup_param("vl_tarif_reference",""));


$vl_mousto_uti_cleunik=intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_mousto_int_cleunik=intval(fa_recup_session('vs_int_cleunik','0'));


$dep_cod=array();$dep_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=116"; //  On recherche les dépots
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($dep_cod, $row['code']);
  array_push ($dep_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$emp_cod=array();$emp_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=117"; //  On recherche les emplacements
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($emp_cod, $row['code']);
  array_push ($emp_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);  
/*
 * On vérifie l'existence des dépôts et emplacements
 */
$liste_depot_absent="";
$liste_empla_absent="";
$vl_e_i=-1;
foreach($vl_t_depot as $vl_raf) {
	$vl_e_i++;
	$vl_depot=$vl_t_depot[$vl_e_i];
	$vl_empla=$vl_t_empla[$vl_e_i];
	if (trim($vl_depot!="")){
		$vl_e_trouve=array_search($vl_depot, $dep_cod);
		if ($vl_e_trouve===false) {
			$liste_depot_absent.=$vl_depot.EOL;
		}
	}
	if (trim($vl_empla!="")){
		$vl_e_trouve=array_search($vl_empla, $emp_cod);
		if ($vl_e_trouve===false) {
			$liste_empla_absent.=$vl_empla.EOL;
		}
	}
}
if ((trim($liste_depot_absent)!="")||(trim($liste_empla_absent)!="")){
	$liste_depot_absent="Liste des dépots absents : ".$liste_depot_absent;
	$liste_empla_absent="Liste des emplacements absents : ".$liste_empla_absent;
	die("$liste_depot_absent $liste_empla_absent");
}


//	Recherche des informations articles
$sql_req =" SELECT n1.pr_generique,n1.nbdec_prix,n1.actif as actif,n1.art_cleunik as art_cleunik,n3.pr as pr,n3.nbdec_pr as nbdec_pr,";
$sql_req.=" n4.der_pa as derpa,n4.pamp as pamp,n1.art_cleunik as art_cleunik,n8.nb_decimales_qte";
$sql_req.=" FROM _article n1 left join _art_fabs n3 using(art_cleunik) left join _art_achats n4 using(art_cleunik) ";
$sql_req.=" left join _art_stock n8 using(art_cleunik)";
$sql_req.=" where n1.types_gestion & 4";
$art_pr_generique=array();$article_cle=array();$art_pr=array();$art_pamp=array();$art_derpa=array();
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($article_cle, $row['art_cleunik']);
  array_push ($art_pr_generique, $row['pr_generique']);
  array_push ($art_pr, $row['pr']);
  array_push ($art_pamp, $row['pamp']);
  array_push ($art_derpa, $row['derpa']);
}
_graal_libere_requete_bd($result);

$vl_b_transaction_ok=true;
$vl_e_i=-1;
switch (TRUE){
  	case $vf_c_action=="kilometres_inventaire_depot_empla";
		foreach($vl_t_art_cleunik as $vl_raf) {
			$vl_e_i++;
			$vl_mousto_qte_mvt=fa_floatval($vl_t_qte[$vl_e_i]);
			$vl_mousto_art_cleunik=$vl_t_art_cleunik[$vl_e_i];
			$vl_mousto_blocnotebrut="";
			$vl_mousto_date_mvt=$vl_dateheureinventaire;
			$vl_mousto_type_mvt=3;
			$vl_e_trouve=array_search($vl_mousto_art_cleunik, $article_cle);
			if ($vl_e_trouve===false) {
				$art_cleunik=0;
			} else {
				$vl_depot=$vl_t_depot[$vl_e_i];
				$vl_empla=$vl_t_empla[$vl_e_i];
				if (trim($vl_depot!="")){
					$vl_e_trouve=array_search($vl_depot, $dep_cod);
					if ($vl_e_trouve===false) {
						$vl_mousto_choix_depot=-15;
					} else {
						$vl_mousto_choix_depot=$dep_cle[$vl_e_trouve];
					}
				} else {
					$vl_mousto_choix_depot=-15;
				}
				if (trim($vl_empla!="")){
					$vl_e_trouve=array_search($vl_empla, $emp_cod);
					if ($vl_e_trouve===false) {
						$vl_mousto_choix_empla=-16;
					} else {
						$vl_mousto_choix_empla=$emp_cle[$vl_e_trouve];
					}
				} else {
					$vl_mousto_choix_empla=-16;
				}
				switch ($vl_tarif_reference) {
				    case "-4":  //  Rien
				      $vl_mousto_pu_mvt=0;
				      break;
				    case "-1":  //  Dernier prix d'achat
				      $vl_mousto_pu_mvt=$art_derpa[$vl_e_trouve];
				      break;
				    case "-3":  //  PAMP
				      $vl_mousto_pu_mvt=$art_pamp[$vl_e_trouve];
				      break;
				    case "-2":  //  Prix de revient
				      $vl_mousto_pu_mvt=$art_pr[$vl_e_trouve];
				      break;
				    case "-5":  //  Prix de revient générique
				      $vl_mousto_pu_mvt=$art_pr_generique[$vl_e_trouve];
				      break;
				}
				$vl_mousto_genre_mvt=-41;
				$deb_trans=_graal_requete_bd("START TRANSACTION;");
				$vl_mousto_mvt_cleunik=fa_mousto_ajout();
				if ($vl_mousto_mvt_cleunik==-1) {
				  _graal_requete_bd("ROLLBACK;");
				  die('La transaction de stock a échoué.');
				} else {
				  _graal_requete_bd("COMMIT;");
				  //echo 'La transaction de stock a été correctement enregistrée.';
				}
			}
		}
		echo "Inventaire terminé";
		break;
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
?>
