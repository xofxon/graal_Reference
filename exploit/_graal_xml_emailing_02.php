<?php
include("_graal_header_html.inc.php");
error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);  //  Pour éviter les warnings éventuels générés par simplexml_load_string
define('EOL', "\r\n");
// execution de la requète SQL
$vl_t_id=array();
$vl_t_init=array();
$vl_e_action_cleunik=intval(fa_recup_param("action_cleunik","-1"));
//$sql_req="SELECT _courriel_en.courriel_en_mes_cleunik,sujet,type,datas_vrac,message FROM _courriel_en,_courriel_en_mes where action_cleunik=$vl_e_action_cleunik and _courriel_en_mes.courriel_en_mes_cleunik=_courriel_en.courriel_en_mes_cleunik";
$sql_req="SELECT _courriel_en.courriel_en_mes_cleunik,sujet,type,datas_vrac,message FROM _courriel_en left join _courriel_en_mes using(courriel_en_mes_cleunik) where action_cleunik=$vl_e_action_cleunik;";
$result = _graal_requete_bd($sql_req);
echo fa_xcree_entete_xml();
$row = mysql_fetch_assoc($result);
$vl_c_xml=simplexml_load_string($row['datas_vrac']);
$vl_nb_images=$vl_c_xml->nom_images_integrees_nombre[0]->attributes();
$vl_c_sujet=$row['sujet'];
$vl_e_i=0;
//echo $vl_nb_images.EOL;
for($vl_e_j=0;$vl_e_j<$vl_nb_images;$vl_e_j++){
  $vl_c_id=$vl_c_xml->nom_images_integrees[$vl_e_j]->attributes();
  $posgenre=strpos($vl_c_id,'=',1);
  $genre=substr($vl_c_id,0,$posgenre);
  $fin_01=strpos($vl_c_id,':',1);
  $hash=substr($vl_c_id,$fin_01+1);
  $hash=substr($hash,0,-1);
  $sql_req="SELECT image,mime FROM _courriel_images where hash='$hash';";
  //echo $vl_c_id.EOL;
  //echo $sql_req.EOL;
  $result=_graal_requete_bd($sql_req);
  if($ligne=mysql_fetch_row($result)) {
    $vl_e_i++;
    $vl_t_id[$vl_e_i]=$vl_c_id;
    $vl_t_init[$vl_e_i]=$genre.'="data:'.$ligne[1].';base64,'.$ligne[0].'"';
    //echo $vl_t_id[$vl_e_i].EOL;
    //echo $vl_t_init[$vl_e_i].EOL;
  } 
}
$vl_c_message=$row['message'];
//echo $vl_c_message;
$vl_c_message=str_replace($vl_t_id,$vl_t_init,$vl_c_message);
?>
<html>
<?php 
echo $vl_c_message;
?>
</html>