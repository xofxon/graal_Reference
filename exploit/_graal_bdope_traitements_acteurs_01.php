<?php
include("_graal_header_txt.inc.php");
include("_import_class_data_km.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_traitements_acteurs_01";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_t_acteur=fa_recup_param("vl_t_acteur","");
$vl_e_choix_cleunik=intval(fa_recup_param('vl_e_choix_cleunik','0'));
$vl_e_critere_cleunik=intval(fa_recup_param('vl_e_critere_cleunik','0'));
$vl_e_genreacteur=intval(fa_recup_param('genreacteur','0'));
$vl_e_uti_cleunik=intval(fa_recup_param('vl_e_uti_cleunik','0'));
session_write_close();
switch (TRUE){
	case $vf_c_action=="ajouter_liste_blanc_tousss";
		$i1=500;
	    $o_choix=new _graal_import();
	    $o_choix->req="INSERT INTO _acteurs_blanc (act_cleunik,uti_cleunik) VALUES ";
	    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
	    $vl_b_transaction_ok=true;
	    $vl_e_i=-1;
	    foreach($vl_t_acteur as $vl_raf) {
	      $vl_e_i++;
	      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
	      $o_choix->dat.="($vl_act_cleunik,$vl_e_uti_cleunik),";
	      if ($vl_e_i % $i1==0){$o_choix->execute();}
	    }
	    $o_choix->execute();
		$vl_e_i++;
		echo ("$vl_e_i acteurs ajoutés dans la liste blanche.");
	break;
	case $vf_c_action=="ajouter_liste_noire_tousss";
		$i1=500;
	    $o_choix=new _graal_import();
	    $o_choix->req="INSERT INTO _acteurs_noire (act_cleunik,uti_cleunik) VALUES ";
	    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
	    $vl_b_transaction_ok=true;
	    $vl_e_i=-1;
	    foreach($vl_t_acteur as $vl_raf) {
	      $vl_e_i++;
	      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
	      $o_choix->dat.="($vl_act_cleunik,$vl_e_uti_cleunik),";
	      if ($vl_e_i % $i1==0){$o_choix->execute();}
	    }
	    $o_choix->execute();
		$vl_e_i++;
		echo ("$vl_e_i acteurs ajoutés dans la liste noire.");
	break;
	case $vf_c_action=="supprimer_liste_blanc_tousss";
	    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
	    $vl_b_transaction_ok=true;
	    $vl_e_i=-1;
	    $sql_condition="";
	    foreach($vl_t_acteur as $vl_raf) {
	      $vl_e_i++;
	      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
	      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
	    }
	    $sql_req = "DELETE FROM _acteurs_blanc WHERE act_cleunik in($sql_condition) and uti_cleunik=$vl_e_uti_cleunik;";
    	$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    	if ($vl_b_transaction_ok==false) {echo 'La suppression des acteurs dans la liste a échoué.'.$vl_c_mess_err;} else {echo 'La supression des acteurs dans la liste a été correctement effectuée.';}
    break;
    case $vf_c_action=="supprimer_liste_noire_tousss";
	    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
	    $vl_b_transaction_ok=true;
	    $vl_e_i=-1;
	    $sql_condition="";
	    foreach($vl_t_acteur as $vl_raf) {
	      $vl_e_i++;
	      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
	      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
	    }
	    $sql_req = "DELETE FROM _acteurs_noire WHERE act_cleunik in($sql_condition) and uti_cleunik=$vl_e_uti_cleunik;";
    	$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    	if ($vl_b_transaction_ok==false) {echo 'La suppression des acteurs dans la liste a échoué.'.$vl_c_mess_err;} else {echo 'La supression des acteurs dans la liste a été correctement effectuée.';}
    break;
  case $vf_c_action=="kilometres_activer";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "UPDATE _acteurs SET actif=1 WHERE act_cleunik in($sql_condition);";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'L\'activation des acteurs a échoué.'.$vl_c_mess_err;} else {echo 'L\'activation des acteurs a été correctement effectuée.';}
    break;
  case $vf_c_action=="kilometres_compta_defaut";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "delete from _act_compta where act_cleunik in($sql_condition);";
	$vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression préalable ".$sql_req.EOL;}
    
    $sql_req = "insert into _act_compta SELECT  f1.act_cleunik,f3.compte,f3.tvaintracommunautaire,f3.catcompta_cleunik,f3.encours_autorise,f3.tarif_cleunik,f3.remise_taux,";
    $sql_req.= " f3.remise_type,f3.remise_genr,f3.escompte_taux,f3.escompte_type,f3.remise_natu,f3.reg_cleunik,f3.pc_cleunik,f3.assujetti_tpf,f3.montant_port,f3.seuil_franco,f3.commande_mini";
	$sql_req.= " FROM _act_compta f3,_acteurs f1 left join _act_compta f2 on f1.act_cleunik=f2.act_cleunik  ";
	$sql_req.= " where f3.act_cleunik=0 and f1.typeacteur=110003 and f2.act_cleunik is null and f1.act_cleunik in($sql_condition);";    
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'MAJ des comptes comptables clients pas ok.'.$vl_c_mess_err;} else {echo 'MAJ des comptes comptables clients ok.';}
    break;
  case $vf_c_action=="kilometres_desactiver";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "UPDATE _acteurs SET actif=2 WHERE act_cleunik in($sql_condition);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La désactivation des acteurs a échoué.'.$vl_c_mess_err;} else {echo 'La désactivation des acteurs a été correctement effectuée.';}
    $vl_tb_reg_00001=_graal_requete_regle("Reg_00001"); //  Règle qui détermine si on doit désactiver les interlocuteurs lorsque l'on désactive les acteurs
    $vl_b_desactive_interlo=$vl_tb_reg_00001[0];
    if ($vl_b_desactive_interlo==true) {
      $sql_req = "UPDATE _act_interlo SET actif=2 WHERE act_cleunik in($sql_condition);";
      $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
      if ($vl_b_transaction_ok==false) {echo 'La désactivation des interlocuteurs des acteurs a échoué.'.$vl_c_mess_err;} else {echo 'La désactivation des interlocuteurs des acteurs a été correctement effectuée.';}
    }
    break;
    
    case $vf_c_action=="kilometres_supprimer";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "delete f1 from _acteurs f1 left join _graal f2 using(act_cleunik) where f2.act_cleunik is null and f1.act_cleunik in($sql_condition);";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur update ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des acteurs a échoué.'.$vl_c_mess_err;} else {echo 'La supperssion des acteurs a été correctement effectuée.';}
    break;
    
  case $vf_c_action=="choix_ajo";
    $i1=500;
    $o_choix=new _graal_import();
    $o_choix->req="INSERT INTO _act_choix_fixes (act_cleunik,choix_cleunik,critere_cleunik,typeacteur) VALUES ";
	$toto=$o_choix->req;
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      $o_choix->dat.="($vl_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik,$vl_e_genreacteur),";
	  $toto.="($vl_act_cleunik,$vl_e_choix_cleunik,$vl_e_critere_cleunik,$vl_e_genreacteur),";
      if ($vl_e_i % $i1==0){$o_choix->execute();}
    }
    $o_choix->execute();
	$vl_e_i++;
    //echo ("$vl_e_i Choix ajoutés $toto");
	echo ("$vl_e_i Choix ajoutés.");
    break;
  case $vf_c_action=="choix_sup";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "DELETE FROM _act_choix_fixes WHERE act_cleunik in($sql_condition) and choix_cleunik=$vl_e_choix_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des choix a échoué.'.$vl_c_mess_err;} else {echo 'La supression des choix a été correctement effectuée.';}
    break;
  case $vf_c_action=="critere_sup";
    $vl_t_acteur=unserialize(stripslashes($vl_t_acteur));
    $vl_b_transaction_ok=true;
    $vl_e_i=-1;
    $sql_condition="";
    foreach($vl_t_acteur as $vl_raf) {
      $vl_e_i++;
      $vl_act_cleunik=$vl_t_acteur[$vl_e_i];
      if ($vl_e_i==0) {$sql_condition.= "$vl_act_cleunik";} else {$sql_condition.= ",$vl_act_cleunik";};
    }
    $sql_req = "DELETE FROM _act_choix_fixes WHERE act_cleunik in($sql_condition) and critere_cleunik=$vl_e_critere_cleunik;";
    $vf_c_echo=_graal_exec_requete($sql_req);if($vf_c_echo!='ok') {$vl_b_transaction_ok=false;$vl_c_mess_err.="Erreur suppression ".$sql_req.EOL;}
    if ($vl_b_transaction_ok==false) {echo 'La suppression des critères a échoué.'.$vl_c_mess_err;} else {echo 'La supression des critères a été correctement effectuée.';}
    break;

  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
//echo $vf_c_echo;
//echo $sql_req;
?>
