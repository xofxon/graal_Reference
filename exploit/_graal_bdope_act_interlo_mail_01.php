<?php
include("_graal_header_txt.inc.php");
$t_origines_ok=array();
$t_origines_ok[0]="_graal_fen_act_interlo_mail_01";
$t_origines_ok[1]="_graal_fen_actions_03";
$t_origines_ok[2]="_graal_fen_act_interlo_simple_01";
$t_origines_ok[3]="_graal_fen_act_interlo_simple_02";
$t_origines_ok[4]="_graal_fen_acteurs_simple_03";
$t_origines_ok[5]="_graal_fen_acteurs_simple_02";
$t_origines_ok[6]="_graal_fen_act_interlo_simple_03";
$t_origines_ok[7]="_graal_import_adresses_courriel_04";
fa_acces_script();
$vf_c_echo="";
$vf_c_action=fa_recup_param("vf_c_action","??????");
$vl_intweb_cleunik=fa_recup_param("vl_intweb_cleunik","");
$vl_int_cleunik=intval(fa_recup_param("vl_int_cleunik",""));
$vl_refweb=fa_recup_param("vl_refweb","");
$vl_blocnotebrut=fa_recup_param("vl_blocnotebrut","");
$vl_veuxpasdemail=intval(fa_recup_param("vl_veuxpasdemail",""));
$vl_infofavori=intval(fa_recup_param("vl_infofavori",""));
$vl_utilisable=intval(fa_recup_param("vl_utilisable","1"));
$vl_act_cleunik=intval(fa_recup_param("vl_act_cleunik",""));
$vl_choix_cleunik=intval(fa_recup_param("vl_choix_cleunik",""));
$vl_valide=intval(fa_recup_param("vl_valide",""));
$vl_cr_verification=fa_recup_param("vl_cr_verification","");
$vl_dateheureverification=fa_recup_param("vl_dateheureverification","");
switch (TRUE){
  case $vf_c_action=="supprimer":
    $sql_req = "DELETE FROM _act_interlo_mail WHERE _act_interlo_mail.intweb_cleunik = $vl_intweb_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_intweb_cleunik;}  else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="ajouter":
    $vl_e_fen_cleunik=_graal_requete_max("intweb_cleunik","_act_interlo_mail");
    $sql_req = "INSERT INTO _act_interlo_mail set intweb_cleunik=$vl_e_fen_cleunik,int_cleunik=$vl_int_cleunik,refweb='$vl_refweb',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut',veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,act_cleunik=$vl_act_cleunik,choix_cleunik=$vl_choix_cleunik,valide=$vl_valide,c_uuid=(select uuid()),cr_verification='$vl_cr_verification',dateheureverification='$vl_dateheureverification';";
    $vf_c_echo=_graal_exec_requete_debug($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_e_fen_cleunik;}  else {$vf_c_echo=-1;}
    break;
  case $vf_c_action=="modifier":
    $sql_req = "UPDATE _act_interlo_mail set refweb='$vl_refweb',dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut',veuxpasdemail=$vl_veuxpasdemail,infofavori=$vl_infofavori,utilisable=$vl_utilisable,choix_cleunik=$vl_choix_cleunik,valide=$vl_valide,cr_verification='$vl_cr_verification',dateheureverification='$vl_dateheureverification' WHERE _act_interlo_mail.intweb_cleunik=$vl_intweb_cleunik";
    $vf_c_echo=_graal_exec_requete($sql_req);
    if($vf_c_echo=='ok') {$vf_c_echo=$vl_intweb_cleunik;}  else {$vf_c_echo=-1;}
    break;
	case $vf_c_action=="existe":
    $sql_req = "select count(*) as nombre from _act_interlo_mail WHERE refweb='$vl_refweb'";
		$result = _graal_requete_bd($sql_req);
		$row = mysql_fetch_assoc($result);
		$vf_c_echo=fa_ent_xml($row['nombre']);
    break;
	case $vf_c_action=="changer_actif_message":
		if (trim($vl_blocnotebrut)=="") {
			$sql_req = "UPDATE _act_interlo_mail set valide=$vl_valide,dateheuremodif=now() WHERE refweb='$vl_refweb'";			
		} else {
			$sql_req = "UPDATE _act_interlo_mail set valide=$vl_valide,dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut' WHERE refweb='$vl_refweb'";
		}
    	$vf_c_echo=_graal_exec_requete($sql_req);
    	if($vf_c_echo=='ok') {$vf_c_echo="Modification courriel $vl_refweb ok";}  else {$vf_c_echo="Modification de $vl_refweb a échoué !!";}
    	break;
	case $vf_c_action=="changer_actif_message_kilometre":
		$vl_c_var=fa_recup_param('var','vs_tempo_panier_action');
	    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
	    unset($_SESSION["$vl_c_var"]);
	    $vl_e_i=-1;
	    foreach($vl_t_listecles as $vl_raf) {
	      $vl_e_i++;
	      $vl_c_refweb.="'".$vl_t_listecles[$vl_e_i]."'".',';
	    }
	    if ($vl_c_refweb!="") {$vl_c_refweb=substr($vl_c_refweb, 0, -1);}
	    $sql_cond=" refweb IN ($vl_c_refweb)";
		if (trim($vl_blocnotebrut)=="") {
			$sql_req = "UPDATE _act_interlo_mail set valide=$vl_valide,dateheuremodif=now() WHERE $sql_cond";			
		} else {
			$sql_req = "UPDATE _act_interlo_mail set valide=$vl_valide,dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut' WHERE $sql_cond";
		}
	    $vf_c_echo=_graal_exec_requete($sql_req);
	    if($vf_c_echo=='ok') {$vf_c_echo="Modification des courriels trouvés ok";}  else {$vf_c_echo="La modification des courriels a échoué !! $sql_req";}
    	break;
	case $vf_c_action=="changer_veuxpasdemail_message_kilometre":
		$vl_c_var=fa_recup_param('var','vs_tempo_panier_refweb');
	    $vl_t_listecles=fa_recup_session("$vl_c_var",'');
	    unset($_SESSION["$vl_c_var"]);
	    $vl_e_i=-1;
	    foreach($vl_t_listecles as $vl_raf) {
	      $vl_e_i++;
	      $vl_c_refweb.="'".rawurldecode(base64_decode($vl_t_listecles[$vl_e_i]))."'".',';
	    }
	    if ($vl_c_refweb!="") {$vl_c_refweb=substr($vl_c_refweb, 0, -1);}
	    $sql_cond=" refweb IN ($vl_c_refweb)";
		if (trim($vl_blocnotebrut)=="") {
			$sql_req = "UPDATE _act_interlo_mail set veuxpasdemail=$vl_veuxpasdemail,dateheuremodif=now() WHERE $sql_cond";			
		} else {
			$sql_req = "UPDATE _act_interlo_mail set veuxpasdemail=$vl_veuxpasdemail,dateheuremodif=now(),blocnotebrut='$vl_blocnotebrut' WHERE $sql_cond";
		}
	    $vf_c_echo=_graal_exec_requete($sql_req);
	    if($vf_c_echo=='ok') {$vf_c_echo="Modification des courriels trouvés ok";}  else {$vf_c_echo="La modification des courriels a échoué !! $sql_req";}
    	break;
		
  case $vf_c_action=="??????":
    exit;
    break;
}
_graal_ferme_connexion();
echo $vf_c_echo;
?>
