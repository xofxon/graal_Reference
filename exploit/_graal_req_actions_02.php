<?php
$vl_c_xml_uti=simplexml_load_string($_SESSION["vs_param_environ"]);
if (isset($vl_c_xml_uti->gesacteurs_ml_zone)){$vs_gesacteurs_ml_zone=$vl_c_xml_uti->gesacteurs_ml_zone->attributes();}else{$vs_gesacteurs_ml_zone='1';}
switch ($vl_e_action_choix){
	case 1:	//	avec le choix
		if ($vl_e_action_choix_cleunik!=0){
			$join_01=" left join _actions_choix_fixes a3 on a3.action_cleunik=_actions.action_cleunik ";
			$condition_01=" and a3.choix_cleunik in($vl_e_action_choix_cleunik) ";
		} else {
			$join_01=" left join _actions_choix_fixes a3 on a3.action_cleunik=_actions.action_cleunik ";
			$condition_01=" and a3.critere_cleunik in($vl_e_action_critere_cleunik) ";
		}
		break;
	case 2:	//	sans le choix
		$join_01="";
		$condition_01="";
		break;
	case 3:
	default:
		$join_01="";
		$condition_01="";
		break;
}
switch ($vl_c_concerne_qui) {
	case -1:	//	Concerne tout le monde -> pas de condition particulière
		$cond_concerne="";
		$join_02=" left join _graal a2 on a2.action_cleunik=_actions.action_cleunik ";
		break;
	case -2:	//	Ne me concerne pas 
		$cond_concerne=" and a2.int_cleunik not in($vs_int_cleunik) ";
		$join_02=" left join _graal a2 on a2.action_cleunik=_actions.action_cleunik ";
		switch ($vs_gesacteurs_ml_zone){
			case '1':	//	Accès libre
				break;
			case '3':	//	Accès sur liste noire
				break;
			case '4':	//	Accès sur liste blanche
				$cond_concerne_blanche_acteurs_suite=" having (select count(distinct(act_cleunik)) as nombre_acteurs from _graal f0 where f0.action_cleunik=f1.action_cleunik and f0.act_cleunik <> 0 group by action_cleunik)=
				(select count(distinct(f3.act_cleunik)) as nombre_blancs from _graal f0 left join _acteurs_blanc f3 on f0.act_cleunik=f3.act_cleunik where f0.action_cleunik=f1.action_cleunik 
				and f0.act_cleunik <> 0 and f3.uti_cleunik=$vl_e_uti_cleunik)";
				
				break;
		}
		break;
	default:	//	Qui concerne un interlocuteur déterminé (moi ou d'autres actifs) 
		$cond_concerne=" and a2.int_cleunik in($vl_c_concerne_qui) ";
		$join_02=" left join _graal a2 on a2.action_cleunik=_actions.action_cleunik ";
		switch ($vs_gesacteurs_ml_zone){
			case '1':	//	Accès libre
				break;
			case '3':	//	Accès sur liste noire
				break;
			case '4':	//	Accès sur liste blanche
				$cond_concerne="";
				$cond_concerne_blanche_acteurs=" and a2.int_cleunik in($vl_c_concerne_qui) ";//	modifié le 3 avril pour n'avoir que les actions qui ME concernent
				$cond_concerne_blanche_acteurs_suite=" having (select count(distinct(act_cleunik)) as nombre_acteurs from _graal f0 where f0.action_cleunik=_actions.action_cleunik and f0.act_cleunik <> 0 group by action_cleunik)=
				(select count(distinct(f3.act_cleunik)) as nombre_blancs from _graal f0 left join _acteurs_blanc f3 on f0.act_cleunik=f3.act_cleunik where f0.action_cleunik=_actions.action_cleunik 
				and f0.act_cleunik <> 0 and f3.uti_cleunik=$vl_e_uti_cleunik)";
				break;
		}
		break;
}
switch ($vl_c_lesquelles) {
  case 'acteurs': //acteurs
    $join_02=" left join _graal a2 on a2.action_cleunik=_actions.action_cleunik ";
    break; 
  case 'interlo': //interlocuteurs acteurs
    $join_02=" left join _graal a2 on a2.action_cleunik=_actions.action_cleunik ";
    break; 
}
switch ($vl_e_type_recherche) {
      case 1: //  Orthographe
      case 2: //  Poids des mots // en fait on ne gère pas le poids des mots dans ce cas
        if ($vl_c_recherche=='%') {
          $sql_con_base =$cond_concerne;
        } else {
        	switch ($vl_e_zone) {
        		case 1: //description
        			$sql_con_base ="and (_actions.description like '$vl_c_recherche%') $cond_concerne";
        			break;
        		case 2: //sujet
        			$sql_con_base ="and (_actions.sujet like '$vl_c_recherche%') $cond_concerne";
        			break;
        		case 4: //référence
        			$sql_con_base ="and (_actions.reference like '$vl_c_recherche%') $cond_concerne";
        			break;
        		case 5: //Raison sociale acteur concerné
        			$sql_con_base =" and (_actions.action_cleunik in(SELECT a4.action_cleunik FROM _graal a4 left join _acteurs a5 on a4.act_cleunik=a5.act_cleunik"; 
        			$sql_con_base.=" where ((a5.raisonsoc like '$vl_c_recherche%' or a5.nomcommercial like '$vl_c_recherche%') and a4.principal=2) and ";
        			$sql_con_base.=" (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=a4.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 )) $cond_concerne";
        			break;
        		case 7: //nom ou prénom interlocuteur concerné
        			$sql_con_base =" and (_actions.action_cleunik in(SELECT a4.action_cleunik FROM _graal a4 left join _act_interlo a5 on a4.int_cleunik=a5.int_cleunik"; 
        			$sql_con_base.=" where ((a5.prenom like '$vl_c_recherche%' or a5.patronyme like '$vl_c_recherche%') and a4.principal=2) and ";
        			$sql_con_base.=" (select count(*) from _acteurs_noire where _acteurs_noire.act_cleunik=a4.act_cleunik and _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 )) $cond_concerne";
        			break;
        	}
          
        }     
        break;
    }
    $sql_con_base.= " AND ((_actions.dateheuredebut between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or (_actions.dateheurefin between '$vl_c_datedebut$vl_c_heuredebut' and '$vl_c_datefin$vl_c_heurefin') or ( _actions.dateheuredebut < '$vl_c_datedebut$vl_c_heuredebut' and _actions.dateheurefin > '$vl_c_datefin$vl_c_heurefin'))";
    if ($vl_e_statut!=-1) {
      switch ($vl_e_operat) {
        case 1 : $sql_con_base.=" AND _actions.statut IN ($vl_e_statut)";break;
        case 2 : $sql_con_base.=" AND _actions.statut NOT IN ($vl_e_statut)";break;
      }
    }
    if ($vl_e_priorite!=-1) {
      switch ($vl_e_operat_priorite) {
        case 1 : $sql_con_base.=" AND _actions.priorite IN ($vl_e_priorite)";break;
        case 2 : $sql_con_base.=" AND _actions.priorite NOT IN ($vl_e_priorite)";break;
      }
    }
    if ($vl_e_confiden!=-1) {
      switch ($vl_operat_confiden) {
        case 1 : $sql_con_base.=" AND _actions.confidentialite IN ($vl_e_confiden)";break;
        case 2 : $sql_con_base.=" AND _actions.confidentialite NOT IN ($vl_e_confiden)";break;
      }
    }

/*
 * Gestion de la liste noire des acteurs
 * Gestion de la liste blanche des acteurs
 */

$req_liste_noire="";
$req_liste_blanc="";
switch ($vs_gesacteurs_ml_zone){
	case '1':	//	Accès libre
		$req_liste_noire="";
		$req_liste_blanc="";
		break;
	case '3':	//	Accès sur liste noire
		$req_liste_noire.= " and _actions.action_cleunik not in(select l1.action_cleunik from _graal l1 left join _acteurs_noire using(act_cleunik) where _acteurs_noire.uti_cleunik=$vl_e_uti_cleunik) ";
		$req_liste_blanc="";
		break;
	case '4':	//	Accès sur liste blanche
		//$req_liste_blanc=" and (select count(*) from _acteurs_blanc where _acteurs_blanc.act_cleunik=_acteurs.act_cleunik and _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) <> 0 ";
		$req_liste_blanc.= " and (_actions.action_cleunik in(select l1.action_cleunik from _graal l1 left join _acteurs_blanc using(act_cleunik) where _acteurs_blanc.uti_cleunik=$vl_e_uti_cleunik) ";
		$req_liste_blanc.= " $cond_concerne_blanche_acteurs )";
		$req_liste_noire="";
		break;
}
$sql_con_base.= " and (select count(*) from _actions_noire where _actions_noire.action_cleunik=_actions.action_cleunik and _actions_noire.uti_cleunik=$vl_e_uti_cleunik) = 0 ";
$sql_con_base.= $req_liste_blanc . $req_liste_noire;

switch ($vl_c_lesquelles) {
  case 'acteurs': //acteurs
    $sql_con_base.= " AND a2.act_cleunik=$vl_e_act_cleunik";// il faut intégrer l'entreprise
    break; 
  case 'interlo': //interlocuteurs acteurs
    $sql_con_base.= " AND a2.int_cleunik=$vl_e_int_cleunik";break;
    break; 
}
/*
    $sql_req.= " group by _actions.action_cleunik";
    */
$sql_con_base.=$cond_concerne_blanche_acteurs_suite;

switch ($vl_c_quelleplage) { 
  case "debut":$sql_con_finale=" order by 10 DESC,11 DESC";break;
  case "fin":$sql_con_finale=" order by 11 DESC";break;
} 


$sql_req_base="";
$sql_req_base.=" select -115 as choix_cleunik_gauche_commande,f3.choix_valeur_texte_01 as choix_gauche_commande,f1.action_cleunik as action_cleunik_commande,";
$sql_req_base.=" null as choix_cleunik_droite_livraison,null as choix_droite_livraison,null as action_cleunik_livraison,";
$sql_req_base.=" null as choix_cleunik_droite_facture,null as choix_droite_facture,null as action_cleunik_facture,";
$sql_req_base.=" _actions.dateheuredebut ,_actions.dateheurefin,_actions.description,_actions.dateheurecreation,_actions.dateheuremodif,_actions.reference, ";
$sql_req_base.=" _actions.sujet as sujet_cde,null as sujet_liv,null as sujet_fac,";
$sql_req_base.=" _actions.statut as statut_124,t1.choix_valeur_texte_01 as statut,_actions.priorite as priorite_123, t2.choix_valeur_texte_01 as priorite,";
$sql_req_base.=" "._graalsql_date('_actions.dateheuredebut')." as `datedebut`,"._graalsql_time('_actions.dateheuredebut')." as `heuredebut`,";
$sql_req_base.=" "._graalsql_date('_actions.dateheurefin')." as `datefin`,"._graalsql_time('_actions.dateheurefin')." as `heurefin`,_actions.dateheurecreation";
$sql_req_base.=" from _cdecli_entetes f1 left join _choix f3 on f3.choix_cleunik=-115 left join _graal_act f4 on f4.action_cleunik_gauche is null ";
$sql_req_base.=" left join _actions on _actions.action_cleunik=f1.action_cleunik ";
$sql_req_base.=" left join _choix t1 on _actions.statut=t1.choix_cleunik ";
$sql_req_base.=" left join _choix t2 on _actions.priorite=t2.choix_cleunik ";
$sql_req_base.=$join_02.$join01;
$sql_req_base.=" where 1=1 ";
$sql_req_base.=" $sql_con_base";
$sql_req_base.=" and (select count(*) from _graal_act where _graal_act.action_cleunik_gauche=_actions.action_cleunik) = 0  group by 3 ";
$sql_req_base.=" union all";
$sql_req_base.=" select f1.choix_cleunik_gauche as choix_cleunik_gauche_commande,f3.choix_valeur_texte_01 as choix_gauche_commande,f1.action_cleunik_gauche as action_cleunik_commande,";
$sql_req_base.=" f1.choix_cleunik_droite as choix_cleunik_droite_livraison,f2.choix_valeur_texte_01 as choix_droite_livraison,f1.action_cleunik_droite as action_cleunik_livraison,";
$sql_req_base.=" f4.choix_cleunik_droite as choix_cleunik_droite_facture,f5.choix_valeur_texte_01 as choix_droite_facture,f4.action_cleunik_droite as action_cleunik_facture, ";
$sql_req_base.=" _actions.dateheuredebut ,_actions.dateheurefin,_actions.description,_actions.dateheurecreation,_actions.dateheuremodif,_actions.reference, ";
$sql_req_base.=" _actions.sujet as sujet_cde,f7.sujet as sujet_liv,f6.sujet as sujet_fac,";
$sql_req_base.=" _actions.statut as statut_124,t1.choix_valeur_texte_01 as statut,_actions.priorite as priorite_123, t2.choix_valeur_texte_01 as priorite,";
$sql_req_base.=" "._graalsql_date('_actions.dateheuredebut')." as `datedebut`,"._graalsql_time('_actions.dateheuredebut')." as `heuredebut`,";
$sql_req_base.=" "._graalsql_date('_actions.dateheurefin')." as `datefin`,"._graalsql_time('_actions.dateheurefin')." as `heurefin`,_actions.dateheurecreation";
$sql_req_base.=" from _graal_act f1 left join _choix f2 on f1.choix_cleunik_droite = f2.choix_cleunik left join _choix f3 on f1.choix_cleunik_gauche=f3.choix_cleunik ";
$sql_req_base.=" left join _graal_act f4 on f4.action_cleunik_gauche = f1.action_cleunik_droite left join _choix f5 on f4.choix_cleunik_droite=f5.choix_cleunik"; 
$sql_req_base.=" left join _actions on _actions.action_cleunik=f1.action_cleunik_gauche left join _actions f7 on f7.action_cleunik=f1.action_cleunik_droite ";
$sql_req_base.=" left join _actions f6 on f6.action_cleunik=f4.action_cleunik_droite ";
$sql_req_base.=" left join _choix t1 on _actions.statut=t1.choix_cleunik ";
$sql_req_base.=" left join _choix t2 on _actions.priorite=t2.choix_cleunik ";
$sql_req_base.=$join_02.$join01;
$sql_req_base.=" where f1.choix_cleunik_gauche=-115 and (f1.choix_cleunik_droite=-118 or f1.choix_cleunik_droite=-120) and (f4.choix_cleunik_droite=-120 or f4.choix_cleunik_droite is null)";
$sql_req_base.=" $sql_con_base";
$sql_req_base.=" group by 3 ";
$sql_req_base.=" $sql_con_finale";




//$vl_c_sortie="sql";
$sql_req=$sql_req_base;

//echo $sql_req.EOL;
//echo $sql_req.EOL;
/*

echo $sql_req.EOL;
$vl_c_recherche="Likely reason";
echo $vl_c_recherche.EOL;
*/

switch ($vl_c_lesquelles) {
  case 'favorites': //  Favoris, pas de limit
  case 'avecpj':  //  Avec pièces jointes, no limit
  case 'selection'://  Sélection de clé uniques d'actions, no limit
  //case 'dernieres_sauf_emailing':	//	dernières actions, no limit
    break;
  default:
	if ($vl_e_limit!=0) {
    	if ($vl_e_zone!=3){
			$sql_req_limit= " LIMIT 0,$vl_e_limit";
		}
	}
	
	break;
}
$sql_req.=$sql_req_limit;
//echo $sql_req;


switch ($vl_c_sortie) {
  case "das":
  case "excel_01":
    break;
  case "sql":
    header('Content-type: text/plain; charset=utf-8');
    header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
    header("Expires: Mon, 26 Jul 1997 05:00:00 GMT"); // Date in the past
    echo $sql_req;
	exit();
    break;
  }
$result = _graal_requete_bd($sql_req);
$sql_req_init=$sql_req;
$vl_c_in="";
while ($row = mysql_fetch_assoc($result)){
  $vl_c_in.=$row['action_cleunik_commande'].",";
}

if (strlen($vl_c_in)!=0) {
	$vl_c_in=substr($vl_c_in,0,-1);
	  $sql_req="select `f1`.`action_cleunik` AS `action_cleunik`,concat_ws(_utf8' ',`f7`.`prenom`,`f7`.`patronyme`,_utf8'(',(case `f6`.`raisonsoc` when _utf8'' then ";
	  $sql_req.=" `f6`.`nomcommercial` else `f6`.`raisonsoc` end),_utf8')') AS `qui_interlo`,`f7`.`actif` AS `interlo_actif` from ((`_graal` `f1` left join `_acteurs` `f6` ";
	  $sql_req.=" using(`act_cleunik`)) left join `_act_interlo` `f7` using(`int_cleunik`)) where ((`f1`.`principal` = 2) and (`f1`.`portee` = 4096)) and f1.action_cleunik ";
	  $sql_req.=" in ($vl_c_in)";
	  $sql_req.=" union select `f1`.`action_cleunik` AS `action_cleunik`,(case `f6`.`raisonsoc` when _utf8'' then `f6`.`nomcommercial` else `f6`.`raisonsoc` end) AS `qui_interlo`,";
	  $sql_req.=" `f6`.`actif` AS `interlo_actif` from (`_graal` `f1` left join `_acteurs` `f6` on((`f1`.`act_cleunik` = `f6`.`act_cleunik`))) where ((`f1`.`principal` = 2) and ";
	  $sql_req.=" (`f1`.`portee` = 8192)) and f1.action_cleunik in ($vl_c_in)";
	  $result_01 = _graal_requete_bd($sql_req);
	  while ($row = mysql_fetch_assoc($result_01)) {
	    array_push ($qui_dat, fa_ent_xml($row['qui_interlo']));
	    array_push ($qui_cle, $row['action_cleunik']);
	    array_push ($qui_actif, $row['interlo_actif']);
	  }
	  _graal_libere_requete_bd($result_01);
	}

mysql_data_seek($result, 0);//	On se repositionne sur le premier enregistrement
echo('<?xml version="1.0" encoding="UTF-8"?><donnees>');
	while ($row = mysql_fetch_assoc($result)){
		$vl_b_insere="ok";
		if ($vl_b_insere=="ok"){	
			echo('<quoi ');
		    echo(' action_cleunik="'.fa_ent_xml($row['action_cleunik_commande']).'"');
		    echo(' description="'.fa_ent_xml($row['description']).'"');
		    echo(' choix_cleunik="'.fa_ent_xml($row['choix_cleunik_gauche_commande']).'"');
			echo(' dateheurecreation="'.fa_ent_xml($row['dateheurecreation']).'"');
		    echo(' dateheuredebut="'.fa_ent_xml($row['dateheuredebut']).'"');
		    echo(' dateheurefin="'.fa_ent_xml($row['dateheurefin']).'"');
		    $dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
		    $df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
		    $hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
		    $hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
		    echo(' datedebut="'.$dd.'"');
		    echo(' datefin="'.$df.'"');
		    echo(' heuredebut="'.$hd.'"');
		    echo(' heurefin="'.$hf.'"');
		    echo(' datemodif="'.fa_ent_xml($row['datemodif']).'"');
		    echo(' dateheuremodif="'.fa_ent_xml($row['dateheuremodif']).'"');
		    echo(' genre="'.fa_ent_xml($row['genre']).'"');
		    echo(' priorite="'.fa_ent_xml($row['priorite']).'"');
		    echo(' statut="'.fa_ent_xml($row['statut']).'"');
		    echo(' prop_124="prop_124_'.$row['statut_124'].'"');
		    echo(' prop_123="prop_123_'.$row['priorite_123'].'"');
		    echo(' prop_094="prop_094_'.$row['genre_094'].'"');
		    echo(' prop_122="prop_122_'.$row['confi_122'].'"');
		       
			$vl_c_sujet=fa_ent_xml($row['sujet_cde']);
			$vl_c_sujet = preg_replace("/\\x0|[\x01-\x1f]/U","",$vl_c_sujet);
		    echo(' sujet="'.$vl_c_sujet.'"');
		    echo(' reference="'.fa_ent_xml($row['reference']).'"');
		    $vl_e_trouve=array_search($row['action_cleunik_commande'], $qui_cle);
			if ($vl_e_trouve===false) {
				$vl_c_qui="";
				$vl_c_properties_qui="";
			} else {
				$vl_c_qui=$qui_dat[$vl_e_trouve];
				if ($qui_actif[$vl_e_trouve]==1){
					$vl_c_properties_qui="";
				} else {
					$vl_c_properties_qui="$prop_obsolete";
				}
			}
		    echo(' qui="'.$vl_c_qui.'"');
			echo(' properties_qui="'.$vl_c_properties_qui.'"');
			if($row['nombre_graal_act']!=0) {
				$vl_c_prop_nombre_graal_act="af08";
			} else {
				$vl_c_prop_nombre_graal_act="";
			}
				
			echo(' sujet_liv="'.fa_ent_xml($row['sujet_liv']).'"');
			echo(' sujet_fac="'.fa_ent_xml($row['sujet_fac']).'"');
			
			
			  
		    echo('/>');
		    flush();
		}
	}
	echo('</donnees>');
_graal_libere_requete_bd($result);
exit();
?>
