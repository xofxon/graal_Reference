<?php
include("_graal_header_txt.inc.php");
/* Valable pour descriptifs APISoft Version ??????????? */
define('EOL', "\r\n");
set_time_limit(600);
$vl_c_base_origine=fa_recup_param('vl_c_base_origine','apisoft_bar_gc');
$vl_c_base_destination=fa_recup_param('vl_c_base_destination','graal_bar_02');
$sql_req = "SELECT distinct(ModeP) as mode_paiement FROM $vl_c_base_origine.modereglementl where ModeP not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=137);";
$result = _graal_requete_bd($sql_req);
$vf_c_echo="ok";
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_ins = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_ins .=" critere_cleunik=137";
  $sql_req_ins .=",choix_cleunik=$vf_e_choix_cleunik";
  $sql_req_ins .=",choix_code='".addslashes($row['mode_paiement'])."'";
  $sql_req_ins .=",choix_valeur_texte_01='".addslashes($row['mode_paiement'])."'";
  $sql_req_ins .=",choix_actif=1";
  $result_ins = _graal_requete_bd($sql_req_ins);
}
_graal_libere_requete_bd($result);
$sql_req = "SELECT distinct(Typep) as type_paiement FROM $vl_c_base_origine.modereglementl where Typep not in (select choix_code from $vl_c_base_destination._choix where critere_cleunik=138);";
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)){
  $vf_e_choix_cleunik=_graal_requete_max("choix_cleunik","$vl_c_base_destination._choix");
  $sql_req_ins = "INSERT INTO $vl_c_base_destination._choix set";
  $sql_req_ins .=" critere_cleunik=138";
  $sql_req_ins .=",choix_cleunik=$vf_e_choix_cleunik";
  $sql_req_ins .=",choix_code='".addslashes($row['type_paiement'])."'";
  $sql_req_ins .=",choix_valeur_texte_01='".addslashes($row['type_paiement'])."'";
  $sql_req_ins .=",choix_actif=1";
  $result_ins = _graal_requete_bd($sql_req_ins);
}
_graal_libere_requete_bd($result);

$mod_cod=array();$mod_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=137"; //  On recherche les critères modes de paiement
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($mod_cod, $row['code']);
  array_push ($mod_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);
$typ_cod=array();$typ_cle=array();
$sql_req="select choix_cleunik as cleunik,choix_code as code from _choix where critere_cleunik=138"; //  On recherche les critères types de paiement
$result = _graal_requete_bd($sql_req);
while ($row = mysql_fetch_assoc($result)) {
  array_push ($typ_cod, $row['code']);
  array_push ($typ_cle, $row['cleunik']);
}
_graal_libere_requete_bd($result);

$sql_req_00 = "select `Code` as code,`Nom` as nom,`Note` as note,`DateCreation` as datecreation,`DateModification` as datemodification from $vl_c_base_origine.modereglement where Code not in (select codealphanum15 from  $vl_c_base_destination._modereg);"; 
$result_00 = _graal_requete_bd($sql_req_00);
while ($row_00 = mysql_fetch_assoc($result_00)) {
  $vf_e_reg_cleunik=_graal_requete_max("reg_cleunik","$vl_c_base_destination._modereg");
  $codealphanum15=addslashes($row_00['code']);
  $description=addslashes($row_00['nom']);
  $blocnotebrut=addslashes($row_00['note']);
  $dateheurecreation=$row_00['datecreation'];
  $dateheuremodif=$row_00['datemodification'];
  $sql_ins_01="INSERT INTO $vl_c_base_destination._modereg set ";
  $sql_ins_01.=" reg_cleunik=$vf_e_reg_cleunik";
  $sql_ins_01.=",codealphanum15='$codealphanum15'";
  $sql_ins_01.=",description='$description'";
  $sql_ins_01.=",blocnotebrut='$blocnotebrut'";
  $sql_ins_01.=",dateheurecreation='$dateheurecreation'";
  $sql_ins_01.=",dateheuremodif='$dateheuremodif'";
  $sql_ins_01.=",actif=1;";
  $result_ins_01=_graal_requete_bd($sql_ins_01);
  $sql_req_02 = "select `Code`,`Lig`,`Pour`,`Jour`,`NJ`,`ModeP`,`Typep`,`MoisEntier` from $vl_c_base_origine.modereglementl where Code='$codealphanum15';";
  $result_02 = _graal_requete_bd($sql_req_02);
  while ($row_02 = mysql_fetch_assoc($result_02)) {
    $noligne=$row_02['Lig'];
    $pourcentage=$row_02['Pour'];
    $jour=$row_02['Jour'];
    $nbjour=$row_02['NJ'];
    $moisentier=$row_02['MoisEntier'];
    $sql_ins_02="INSERT INTO $vl_c_base_destination._modereg_det set ";
    $sql_ins_02.=" reg_cleunik=$vf_e_reg_cleunik";
    $sql_ins_02.=",noligne=$noligne";
    $sql_ins_02.=",pourcentage=$pourcentage";
    $sql_ins_02.=",jour=$jour";
    $sql_ins_02.=",nbjour=$nbjour";
    $vl_e_trouve_mod=array_search($row_02['ModeP'], $mod_cod);if ($vl_e_trouve_mod===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$mod_cle[$vl_e_trouve_mod];$sql_ins_02.=",mode_paiement=$vl_e_choix_cleunik";}
    $vl_e_trouve_typ=array_search($row_02['Typep'], $typ_cod);if ($vl_e_trouve_typ===false) {$vl_e_choix_cleunik=0;} else {$vl_e_choix_cleunik=$typ_cle[$vl_e_trouve_typ];$sql_ins_02.=",type_paiement=$vl_e_choix_cleunik";}
    $sql_ins_02.=",moisentier=$moisentier";
    $sql_ins_02.=",base=1;";
    $result_ins_02=_graal_requete_bd($sql_ins_02);
  }
  _graal_libere_requete_bd($result_02);
}
_graal_libere_requete_bd($result_00);
_graal_ferme_connexion();
echo($vf_c_echo);
?>
