<?php
include("_graal_header_pdf.inc.php");
include("_graal_var_portee.php");
$vl_e_uti_cleunik =intval(fa_recup_session('vs_uti_cleunik','0'));
$vl_action_cleunik=intval(fa_recup_param(vl_e_action_cleunik,'-1'));
$vl_e_nomcomplet=fa_recup_session('vs_nomcomplet','tesquiconnard?');
$vl_c_genreaction=fa_recup_param('genreaction','generique');
switch ($vl_c_genreaction){
    case "generique": $vl_c_id_fenetre="Fen_00425";$id_inc_actions_criteres_entreprise="Div_00373";$vl_c_id_fen_criteres_entreprise="Fen_00426";$id_inc_actions_criteres_moi="Div_00394";$vl_c_id_fen_criteres_moi="Fen_00427";$id_inc_actions_criteres_autres="Div_00395";$id_inc_actions_criteres_tous="Div_00396";$id_inc_ged="Div_00397";$id_inc_actions_graal="Div_00403";$vl_c_id_fen_graal="Fen_00437";$vl_c_id_inc_actions_relations="Div_00423";break;  //  Toutes les actions génériques
}
$vl_tb_droits=_graal_requete_droits_fenetre($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_tb_droits[4]=1;
$vl_b_impri=$vl_tb_droits[4];if ($vl_b_impri==false) {fa_redirige("acces_interdit");}
_graal_requete_charge_varlib($vl_c_id_fenetre,$vl_e_uti_cleunik);
$vl_c_ben_102=fa_recup_dico("ben_102");
$vl_c_ben_103=fa_recup_dico("ben_103");
$vl_c_ben_104=fa_recup_dico("ben_104");
$vl_c_ben_105=fa_recup_dico("ben_105");
$vl_c_ben_106=fa_recup_dico("ben_106");
$vl_c_ben_107=fa_recup_dico("ben_107");
$vl_c_ben_108=fa_recup_dico("ben_108");
$vl_c_ben_109=fa_recup_dico("ben_109");
$vl_c_ben_110=fa_recup_dico("ben_110");
$vl_c_ben_111=fa_recup_dico("ben_111");
$vl_c_ben_112=fa_recup_dico("ben_112");
$vl_c_ben_113=fa_recup_dico("ben_113");
$vl_c_ben_114=fa_recup_dico("ben_114");
$vl_c_ben_115=fa_recup_dico("ben_115");
$vl_c_ben_116=fa_recup_dico("ben_116");
$vl_c_ben_117=fa_recup_dico("ben_117");
$vl_c_ben_118=fa_recup_dico("ben_118");
$vl_c_ben_119=fa_recup_dico("ben_119");
$vl_c_ben_120=fa_recup_dico("ben_120");
$vl_c_ben_121=fa_recup_dico("ben_121");
$vl_c_ben_122=fa_recup_dico("ben_122");
$vl_c_ben_123=fa_recup_dico("ben_123");
$vl_c_ben_124=fa_recup_dico("ben_124");
$vl_c_ben_125=fa_recup_dico("ben_125");
$vl_c_ben_126=fa_recup_dico("ben_126");
$vl_c_ben_127=fa_recup_dico("ben_127");

$vl_c_dico_00058=fa_recup_dico("dico_00058");
$vl_c_dico_00059=fa_recup_dico("dico_00059");
$vl_c_dico_00073=fa_recup_dico("dico_00073");

$sql_req="SELECT action_cleunik as `action_cleunik`,f5.choix_valeur_texte_01 as `genre`,"._graalsql_date('dateheuredebut')." as `datedebut`,"._graalsql_time('dateheuredebut')." as `heuredebut`,dateheurefin,"._graalsql_date('dateheurefin')." as `datefin`,"._graalsql_time('dateheurefin')." as `heurefin`,dateheurecreation as `dateheurecreation`,dateheuremodif as `dateheuremodif`,blocnote_brut as `blocnote_brut`,blocnote_riche as `blocnote_riche`,position as `position`,description as `description`,c_uuid as `c_uuid`,action_type as `action_type`,lieu as `lieu`,f2.choix_valeur_texte_01 as `confidentialite`,f3.choix_valeur_texte_01 as `priorite`,f4.choix_valeur_texte_01 as `statut`,dateheureprevue as `dateheureprevue`,realisation as `realisation`,sujet as `sujet`,reference as `reference` FROM _actions,_choix f2,_choix f3,_choix f4,_choix f5 where action_cleunik=$vl_action_cleunik and f2.choix_cleunik=_actions.confidentialite and f3.choix_cleunik=_actions.priorite and f4.choix_cleunik=_actions.statut and f5.choix_cleunik=_actions.choix_cleunik;";
$result = _graal_requete_bd($sql_req);
$row = mysql_fetch_assoc($result);
$dd=$row['datedebut'];if ($dd=='00.00.0000') {$dd='';}
$df=$row['datefin'];if ($df=='00.00.0000') {$df='';}
$hd=$row['heuredebut'];if ($hd=='00:00:00') {$hd='';}
$hf=$row['heurefin'];if ($hf=='00:00:00') {$hf='';}
_graal_libere_requete_bd($result);

//$doc_title = "test title";
//$pdf->SetTitle($doc_title);
//$doc_keywords = "test keywords";
//$pdf->SetKeywords($doc_keywords);

//create new PDF document (document units are set by default to millimeters)
$pdf = new _graal_TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true); 
// set document information
$pdf->SetCreator(PDF_CREATOR);
$pdf->SetAuthor($vl_e_nomcomplet);
$pdf->SetSubject($row['sujet']);
//$pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

//Voici les deux tableaux des jours et des mois traduits en français
$nom_jour_fr = array("dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi");
$mois_fr = Array("", "janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", 
		"septembre", "octobre", "novembre", "décembre");
// on extrait la date du jour
list($nom_jour, $jour, $mois, $annee) = explode('/', date("w/d/n/Y"));

$data_entete="Edité le ".$nom_jour_fr[$nom_jour].' '.$jour.' '.$mois_fr[$mois].' '.$annee. " à " . date ("H") . " h " . $minute = date("i") . " par ".$vl_e_nomcomplet;

$pdf->SetHeaderData("", 0,"Edition des actions", $data_entete);
$pdf->setPrintHeader(false);
//set margins
$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);

$pdf->SetMargins(5,15, 5);
//set auto page breaks
$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
$pdf->SetAutoPageBreak(TRUE, 10);
$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
//$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
$pdf->SetFooterMargin(5);
$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO); //set image scale factor
$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
$pdf->setLanguageArray($l); //set language items
$pdf->SetFont("FreeSerif", "", 12);
$_hl=4;// Hauteur ligne
$pdf->_gf();  //  Fond des cellule avec des bords grisé
$pdf->SetLineWidth(0.01);  //  Cadre invisible
//initialize document
$pdf->AliasNbPages();
$pdf->setPrintHeader(true);
$pdf->setPrintFooter(true);
$pdf->AddPage();

$pdf->SetFont("FreeSerif", "BIU", 14);
$pdf->Cell(0,$_hl+$_hl,$row['genre'],'LTBR',0,"C",1);
$pdf->Ln($_hl);$pdf->Ln($_hl);$pdf->Ln($_hl);

$pdf->SetFont("FreeSerif", "", 12);

$pdf->Cell(25,$_hl,$vl_c_ben_126." :",'LTBR',0,"R",1);
//$pdf->Write($_hl,$row['sujet']);
$pdf->CellFitScale(0,$_hl,$row['sujet'],0,0,"R",0);
$pdf->Ln($_hl);$pdf->Ln($_hl);

$pdf->Cell(25,$_hl,$vl_c_ben_127." :",'LTBR',0,"R",1);
//$pdf->Write($_hl,$row['reference']);
$pdf->CellFitScale(0,$_hl,$row['reference'],0,0,"R",0);
$pdf->Ln($_hl);$pdf->Ln($_hl);

$pdf->Cell(25,$_hl,$vl_c_ben_109." :",'LTBR',0,"R",1);
$pdf->Write($_hl,$row['description']);
$pdf->Ln($_hl);$pdf->Ln($_hl);

if ($row['lieu']!='') {
  $pdf->Cell(25,$_hl,$vl_c_ben_117." :",'LTBR',0,"R",1);
  $pdf->Write($_hl,$row['lieu']);
  $pdf->Ln($_hl);$pdf->Ln($_hl);
}
if ($dd!='') {$pdf->Cell($pdf->GetStringWidth($vl_c_ben_110.' :')+2,$_hl,$vl_c_ben_110." :",1,0,"R",1);$pdf->Write($_hl,$dd);$pdf->Cell(3);}
if ($hd!='') {$pdf->Cell($pdf->GetStringWidth($vl_c_ben_111.' :')+2,$_hl,$vl_c_ben_111." :",1,0,"R",1);$pdf->Write($_hl,$hd);$pdf->Cell(3);}
if ($df!='') {$pdf->Cell($pdf->GetStringWidth($vl_c_ben_112.' :')+2,$_hl,$vl_c_ben_112." :",1,0,"R",1);$pdf->Write($_hl,$df);$pdf->Cell(3);}
if ($hf!='') {$pdf->Cell($pdf->GetStringWidth($vl_c_ben_113.' :')+2,$_hl,$vl_c_ben_113." :",1,0,"R",1);$pdf->Write($_hl,$hf);$pdf->Cell(3);}

$pdf->Ln($_hl);$pdf->Ln($_hl);
$pdf->Cell($pdf->GetStringWidth($vl_c_ben_114.' :')+2,$_hl,$vl_c_ben_114." :",1,0,"R",1);$pdf->Write($_hl,$row[statut]);$pdf->Cell(8);
$pdf->Cell($pdf->GetStringWidth($vl_c_ben_115.' :')+2,$_hl,$vl_c_ben_115." :",1,0,"R",1);$pdf->Write($_hl,$row[confidentialite]);$pdf->Cell(8);
$pdf->Cell($pdf->GetStringWidth($vl_c_ben_116.' :')+2,$_hl,$vl_c_ben_116." :",1,0,"R",1);$pdf->Write($_hl,$row[priorite]);$pdf->Cell(8);
$pdf->Ln($_hl);$pdf->Ln($_hl);
$sql_req="SELECT _actions_commentaires.blocnote_brut as `commentaire`,"._graalsql_date('_actions_commentaires.dateheuremodif')." as `datemodif`,"._graalsql_time('_actions_commentaires.dateheuremodif')." as `heuremodif`,concat_ws(' ',prenom,patronyme) as qui,_actions_commentaires.act_cleunik,_actions_commentaires.int_cleunik FROM _actions_commentaires,_act_interlo where action_cleunik=$vl_action_cleunik and _actions_commentaires.int_cleunik=_act_interlo.int_cleunik order by _actions_commentaires.dateheuremodif";
$result=_graal_requete_bd($sql_req);
while ($row_01 = mysql_fetch_assoc($result)){
  $data=fa_ent_xml($row_01['qui']).' le '.fa_ent_xml($row_01['datemodif']).' à '.fa_ent_xml($row_01['heuremodif']);
  
  $pdf->SetFont("FreeSerif", "BIU", 14);
  $pdf->Cell(0,$_hl+$_hl,$data,'LTBR',0,"C",1);
  $pdf->Ln($_hl);$pdf->Ln($_hl);$pdf->Ln($_hl);
  $pdf->SetFont("FreeSerif", "", 12);
  
  $pdf->Write($_hl,$row_01['commentaire']);
  $pdf->Ln($_hl);$pdf->Ln($_hl);

}
_graal_libere_requete_bd($result);
$_b_page=false;
$sql_req="SELECT count(*) as nombre from _graal where action_cleunik=$vl_action_cleunik;"; 
$result=_graal_requete_bd($sql_req);
$row_01=mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
if ($row_01['nombre'] !=0) { 
  _graal_requete_charge_varlib($id_inc_actions_graal,$vl_e_uti_cleunik);
  $vl_c_bfc_001=fa_recup_dico("bfc_001");
  $vl_c_bfc_002=fa_recup_dico("bfc_002");
  $vl_c_bfc_003=fa_recup_dico("bfc_003");
  $vl_c_bfc_010=fa_recup_dico("bfc_010");
  if ($_b_page!=true) {$pdf->AddPage("L");$_b_page=true;}
  $sql_req = "SELECT f02.choix_valeur_texte_01 as `choix_valeur_texte_01`,f03.raisonsoc as `raisonsoc`,'' as `interlocuteur`,f07.choix_valeur_texte_01 as type_acteur_en_clair,f01.principal as principal FROM _graal f01,_choix f02,_acteurs f03,_choix f07 where action_cleunik=$vl_action_cleunik and f01.portee = $vl_e_acteur and f02.choix_cleunik=f01.choix_cleunik and f01.act_cleunik=f03.act_cleunik and f07.choix_cleunik=f03.typeacteur"; 
  $sql_req.=" union all "; 
  $sql_req.="SELECT f02.choix_valeur_texte_01 as `choix_valeur_texte_01`,f03.raisonsoc as `raisonsoc`,concat_ws(' ',f05.choix_valeur_texte_01,f04.prenom,f04.patronyme) as `interlocuteur`,f07.choix_valeur_texte_01 as type_acteur_en_clair,f01.principal as principal FROM _graal f01,_choix f02,_acteurs f03,_act_interlo f04,_choix f05,_choix f07 where action_cleunik=$vl_action_cleunik and f02.choix_cleunik=f01.choix_cleunik and f01.act_cleunik=f03.act_cleunik and f04.int_cleunik =f01.int_cleunik and f05.choix_cleunik = f04.choix_cleunik and f01.portee = $vl_e_interl and f07.choix_cleunik=f03.typeacteur;"; 
  $pdf->SetFont("FreeSerif", "BIU", 14);
  $pdf->Cell(0,$_hl+$_hl,$vl_c_ben_103,'LTBR',0,"C",1);
  $pdf->Ln($_hl);$pdf->Ln($_hl);$pdf->Ln($_hl);
  $pdf->SetFont("FreeSerif", "", 12);

  $pdf->AddCol('choix_valeur_texte_01','20%',$vl_c_bfc_001,'L');
  $pdf->AddCol('raisonsoc','25%',$vl_c_bfc_002,'L');
  $pdf->AddCol('interlocuteur','35%',$vl_c_bfc_003,'L');
  $pdf->AddCol('type_acteur_en_clair','20%',$vl_c_bfc_010,'L');
  $prop=array('HeaderColor'=>array(255,150,100),
              'color1'=>array(255,224,224), //  rose
              'color2'=>array(255,255,192), //  Jaune
              'padding'=>2);
  $pdf->Table($sql_req,$prop);
  $pdf->_gf();  //  Fond des cellule avec des bords grisé
  $pdf->Ln($_hl);$pdf->Ln($_hl);
}

$sql_req="SELECT count(*) as nombre from _actions_choix_fixes where _actions_choix_fixes.action_cleunik=$vl_action_cleunik;"; 
$result=_graal_requete_bd($sql_req);
$row_01=mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
if ($row_01['nombre'] !=0) {
  _graal_requete_charge_varlib($id_inc_actions_criteres_tous,$vl_e_uti_cleunik);
  $vl_c_bew_004=fa_recup_dico("bew_004");
  $vl_c_bew_005=fa_recup_dico("bew_005");
  $vl_c_bew_006=fa_recup_dico("bew_006");
  $vl_c_bew_008=fa_recup_dico("bew_008");
  if ($_b_page!=true) {$pdf->AddPage("L");$_b_page=true;}
$sql_req = "SELECT _actions_choix_fixes.action_cleunik AS action_cleunik,_actions_choix_fixes.choix_cleunik AS choix_cleunik,_choix.critere_cleunik AS critere_cleunik,case _criteres.critere_codechoixpertinent WHEN 1 THEN _choix.choix_code ELSE '' END AS choix_code,_choix.choix_valeur_texte_01 AS choix_valeur_texte_01,_criteres.critere_denomination AS critere_denomination,concat(_utilisateur.prenom,' ',_utilisateur.patronyme) AS prenom_nom FROM _choix, _actions_choix_fixes, _criteres,_utilisateur  WHERE _choix.choix_cleunik = _actions_choix_fixes.choix_cleunik  AND _criteres.critere_cleunik = _actions_choix_fixes.critere_cleunik AND _actions_choix_fixes.action_cleunik IN ($vl_action_cleunik) and _utilisateur.uti_cleunik=_actions_choix_fixes.uti_cleunik";
  $pdf->SetFont("FreeSerif", "BIU", 14);
  $pdf->Cell(0,$_hl+$_hl,$vl_c_ben_102,'LTBR',0,"C",1);
  $pdf->Ln($_hl);$pdf->Ln($_hl);$pdf->Ln($_hl);
  $pdf->SetFont("FreeSerif", "", 12);

  $pdf->AddCol('critere_denomination','20%',$vl_c_bew_004,'L');
  $pdf->AddCol('choix_code','10%',$vl_c_bew_005,'L');
  $pdf->AddCol('choix_valeur_texte_01','35%',$vl_c_bew_006,'L');
  $pdf->AddCol('prenom_nom','35%',$vl_c_bew_007,'L');
  $prop=array('HeaderColor'=>array(255,150,100),
              'color1'=>array(255,224,224), //  rose
              'color2'=>array(255,255,192), //  Jaune
              'padding'=>2);
  $pdf->Table($sql_req,$prop);
  $pdf->_gf();  //  Fond des cellule avec des bords grisé
  $pdf->Ln($_hl);$pdf->Ln($_hl);

}
$sql_req="SELECT count(*) as nombre FROM `_documents` WHERE _documents.action_cleunik =$vl_action_cleunik"; 
$result=_graal_requete_bd($sql_req);
$row_01=mysql_fetch_assoc($result);
_graal_libere_requete_bd($result);
if ($row_01['nombre'] !=0) {
  _graal_requete_charge_varlib($id_inc_ged,$vl_e_uti_cleunik);
  $vl_c_bej_001=fa_recup_dico("bej_001");
  $vl_c_bej_002=fa_recup_dico("bej_002");
  $vl_c_bej_003=fa_recup_dico("bej_003");
  $vl_c_bej_004=fa_recup_dico("bej_004");
  if ($_b_page!=true) {$pdf->AddPage("L");$_b_page=true;}
$sql_req = "SELECT _documents.emplacement as emplacement,_documents.titre as titre,_documents.descriptif_sommaire as descriptif_sommaire,_documents.origine as origine FROM `_documents` WHERE _documents.action_cleunik =$vl_action_cleunik";
  $pdf->SetFont("FreeSerif", "BIU", 14);
  $pdf->Cell(0,$_hl+$_hl,$vl_c_ben_104,'LTBR',0,"C",1);
  $pdf->Ln($_hl);$pdf->Ln($_hl);$pdf->Ln($_hl);
  $pdf->SetFont("FreeSerif", "", 12);

  $pdf->AddCol('emplacement','20%',$vl_c_bej_001,'L');
  $pdf->AddCol('titre','20%',$vl_c_bej_002,'L');
  $pdf->AddCol('descriptif_sommaire','45%',$vl_c_bej_003,'L');
  $pdf->AddCol('origine','15%',$vl_c_bej_004,'L');
  $prop=array('HeaderColor'=>array(255,150,100),
              'color1'=>array(255,224,224), //  rose
              'color2'=>array(255,255,192), //  Jaune
              'padding'=>2);
  $pdf->Table($sql_req,$prop);
  $pdf->_gf();  //  Fond des cellule avec des bords grisé
  $pdf->Ln($_hl);$pdf->Ln($_hl);
}
$pdf->Output();
?>
